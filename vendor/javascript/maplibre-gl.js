var rt=typeof globalThis!=="undefined"?globalThis:typeof self!=="undefined"?self:global;var at={};
/**
 * MapLibre GL JS
 * @license 3-Clause BSD. Full text of license: https://github.com/maplibre/maplibre-gl-js/blob/v5.4.0/LICENSE.txt
 */(function(rt,Tt){at=Tt()})(0,(function(){var at={};var Tt={};function define(rt,$t,qt){Tt[rt]=qt;if(rt==="index"){var Kt="var sharedModule = {}; ("+Tt.shared+")(sharedModule); ("+Tt.worker+")(sharedModule);";var ge={};Tt.shared(ge);Tt.index(at,ge);typeof window!=="undefined"&&at.setWorkerUrl(window.URL.createObjectURL(new Blob([Kt],{type:"text/javascript"})));return at}}define("shared",["exports"],(function(at){function e(rt,at,Tt,$t){return new(Tt||(Tt=Promise))((function(qt,Kt){function a(rt){try{l($t.next(rt))}catch(rt){Kt(rt)}}function o(rt){try{l($t.throw(rt))}catch(rt){Kt(rt)}}function l(rt){var at;rt.done?qt(rt.value):(at=rt.value,at instanceof Tt?at:new Tt((function(rt){rt(at)}))).then(a,o)}l(($t=$t.apply(rt,at||[])).next())}))}function r(rt){return rt&&rt.__esModule&&Object.prototype.hasOwnProperty.call(rt,"default")?rt.default:rt}var Tt,$t;function s(){if($t)return Tt;function t(at,Tt){(this||rt).x=at,(this||rt).y=Tt}return $t=1,Tt=t,t.prototype={clone:function(){return new t((this||rt).x,(this||rt).y)},add:function(rt){return this.clone()._add(rt)},sub:function(rt){return this.clone()._sub(rt)},multByPoint:function(rt){return this.clone()._multByPoint(rt)},divByPoint:function(rt){return this.clone()._divByPoint(rt)},mult:function(rt){return this.clone()._mult(rt)},div:function(rt){return this.clone()._div(rt)},rotate:function(rt){return this.clone()._rotate(rt)},rotateAround:function(rt,at){return this.clone()._rotateAround(rt,at)},matMult:function(rt){return this.clone()._matMult(rt)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt((this||rt).x*(this||rt).x+(this||rt).y*(this||rt).y)},equals:function(at){return(this||rt).x===at.x&&(this||rt).y===at.y},dist:function(rt){return Math.sqrt(this.distSqr(rt))},distSqr:function(at){var Tt=at.x-(this||rt).x,$t=at.y-(this||rt).y;return Tt*Tt+$t*$t},angle:function(){return Math.atan2((this||rt).y,(this||rt).x)},angleTo:function(at){return Math.atan2((this||rt).y-at.y,(this||rt).x-at.x)},angleWith:function(rt){return this.angleWithSep(rt.x,rt.y)},angleWithSep:function(at,Tt){return Math.atan2((this||rt).x*Tt-(this||rt).y*at,(this||rt).x*at+(this||rt).y*Tt)},_matMult:function(at){var Tt=at[2]*(this||rt).x+at[3]*(this||rt).y;return(this||rt).x=at[0]*(this||rt).x+at[1]*(this||rt).y,(this||rt).y=Tt,this||rt},_add:function(at){return(this||rt).x+=at.x,(this||rt).y+=at.y,this||rt},_sub:function(at){return(this||rt).x-=at.x,(this||rt).y-=at.y,this||rt},_mult:function(at){return(this||rt).x*=at,(this||rt).y*=at,this||rt},_div:function(at){return(this||rt).x/=at,(this||rt).y/=at,this||rt},_multByPoint:function(at){return(this||rt).x*=at.x,(this||rt).y*=at.y,this||rt},_divByPoint:function(at){return(this||rt).x/=at.x,(this||rt).y/=at.y,this||rt},_unit:function(){return this._div(this.mag()),this||rt},_perp:function(){var at=(this||rt).y;return(this||rt).y=(this||rt).x,(this||rt).x=-at,this||rt},_rotate:function(at){var Tt=Math.cos(at),$t=Math.sin(at),qt=$t*(this||rt).x+Tt*(this||rt).y;return(this||rt).x=Tt*(this||rt).x-$t*(this||rt).y,(this||rt).y=qt,this||rt},_rotateAround:function(at,Tt){var $t=Math.cos(at),qt=Math.sin(at),Kt=Tt.y+qt*((this||rt).x-Tt.x)+$t*((this||rt).y-Tt.y);return(this||rt).x=Tt.x+$t*((this||rt).x-Tt.x)-qt*((this||rt).y-Tt.y),(this||rt).y=Kt,this||rt},_round:function(){return(this||rt).x=Math.round((this||rt).x),(this||rt).y=Math.round((this||rt).y),this||rt}},t.convert=function(rt){return rt instanceof t?rt:Array.isArray(rt)?new t(rt[0],rt[1]):rt},Tt}"function"==typeof SuppressedError&&SuppressedError;var qt,Kt,ge=r(s()),Hr=function(){if(Kt)return qt;function t(at,Tt,$t,qt){(this||rt).cx=3*at,(this||rt).bx=3*($t-at)-(this||rt).cx,(this||rt).ax=1-(this||rt).cx-(this||rt).bx,(this||rt).cy=3*Tt,(this||rt).by=3*(qt-Tt)-(this||rt).cy,(this||rt).ay=1-(this||rt).cy-(this||rt).by,(this||rt).p1x=at,(this||rt).p1y=Tt,(this||rt).p2x=$t,(this||rt).p2y=qt}return Kt=1,qt=t,t.prototype={sampleCurveX:function(at){return(((this||rt).ax*at+(this||rt).bx)*at+(this||rt).cx)*at},sampleCurveY:function(at){return(((this||rt).ay*at+(this||rt).by)*at+(this||rt).cy)*at},sampleCurveDerivativeX:function(at){return(3*(this||rt).ax*at+2*(this||rt).bx)*at+(this||rt).cx},solveCurveX:function(rt,at){if(void 0===at&&(at=1e-6),rt<0)return 0;if(rt>1)return 1;for(var Tt=rt,$t=0;$t<8;$t++){var qt=this.sampleCurveX(Tt)-rt;if(Math.abs(qt)<at)return Tt;var Kt=this.sampleCurveDerivativeX(Tt);if(Math.abs(Kt)<1e-6)break;Tt-=qt/Kt}var ge=0,Hr=1;for(Tt=rt,$t=0;$t<20&&(qt=this.sampleCurveX(Tt),!(Math.abs(qt-rt)<at));$t++)rt>qt?ge=Tt:Hr=Tt,Tt=.5*(Hr-ge)+ge;return Tt},solve:function(rt,at){return this.sampleCurveY(this.solveCurveX(rt,at))}},qt}(),wn=r(Hr);let es,ss;function f(){return null==es&&(es="undefined"!=typeof OffscreenCanvas&&new OffscreenCanvas(1,1).getContext("2d")&&"function"==typeof createImageBitmap),es}function d(){if(null==ss&&(ss=!1,f())){const rt=5,at=new OffscreenCanvas(rt,rt).getContext("2d",{willReadFrequently:!0});if(at){for(let Tt=0;Tt<rt*rt;Tt++){const $t=4*Tt;at.fillStyle=`rgb(${$t},${$t+1},${$t+2})`,at.fillRect(Tt%rt,Math.floor(Tt/rt),1,1)}const Tt=at.getImageData(0,0,rt,rt).data;for(let at=0;at<rt*rt*4;at++)if(at%4!=3&&Tt[at]!==at){ss=!0;break}}}return ss||!1}var os=1e-6,cs="undefined"!=typeof Float32Array?Float32Array:Array;function g(){var rt=new cs(9);return cs!=Float32Array&&(rt[1]=0,rt[2]=0,rt[3]=0,rt[5]=0,rt[6]=0,rt[7]=0),rt[0]=1,rt[4]=1,rt[8]=1,rt}function x(rt){return rt[0]=1,rt[1]=0,rt[2]=0,rt[3]=0,rt[4]=0,rt[5]=1,rt[6]=0,rt[7]=0,rt[8]=0,rt[9]=0,rt[10]=1,rt[11]=0,rt[12]=0,rt[13]=0,rt[14]=0,rt[15]=1,rt}function v(){var rt=new cs(3);return cs!=Float32Array&&(rt[0]=0,rt[1]=0,rt[2]=0),rt}function b(rt){return Math.hypot(rt[0],rt[1],rt[2])}function w(rt,at,Tt){var $t=new cs(3);return $t[0]=rt,$t[1]=at,$t[2]=Tt,$t}Math.hypot||(Math.hypot=function(){for(var rt=0,at=arguments.length;at--;)rt+=arguments[at]*arguments[at];return Math.sqrt(rt)});var ds,Cs=b;function A(rt,at,Tt){var $t=at[0],qt=at[1],Kt=at[2],ge=at[3];return rt[0]=Tt[0]*$t+Tt[4]*qt+Tt[8]*Kt+Tt[12]*ge,rt[1]=Tt[1]*$t+Tt[5]*qt+Tt[9]*Kt+Tt[13]*ge,rt[2]=Tt[2]*$t+Tt[6]*qt+Tt[10]*Kt+Tt[14]*ge,rt[3]=Tt[3]*$t+Tt[7]*qt+Tt[11]*Kt+Tt[15]*ge,rt}function k(){var rt=new cs(4);return cs!=Float32Array&&(rt[0]=0,rt[1]=0,rt[2]=0),rt[3]=1,rt}function M(){var rt=new cs(2);return cs!=Float32Array&&(rt[0]=0,rt[1]=0),rt}function I(rt,at){var Tt=new cs(2);return Tt[0]=rt,Tt[1]=at,Tt}v(),ds=new cs(4),cs!=Float32Array&&(ds[0]=0,ds[1]=0,ds[2]=0,ds[3]=0),v(),w(1,0,0),w(0,1,0),k(),k(),g(),M();const Vs=8192;function P(rt,at,Tt){return at*(Vs/(rt.tileSize*Math.pow(2,Tt-rt.tileID.overscaledZ)))}function C(rt,at){return(rt%at+at)%at}function B(rt,at,Tt){return rt*(1-Tt)+at*Tt}function V(rt){if(rt<=0)return 0;if(rt>=1)return 1;const at=rt*rt,Tt=at*rt;return 4*(rt<.5?Tt:3*(rt-at)+Tt-.75)}function E(rt,at,Tt,$t){const qt=new wn(rt,at,Tt,$t);return rt=>qt.solve(rt)}const Eo=E(.25,.1,.25,1);function F(rt,at,Tt){return Math.min(Tt,Math.max(at,rt))}function $(rt,at,Tt){const $t=Tt-at,qt=((rt-at)%$t+$t)%$t+at;return qt===at?Tt:qt}function L(rt,...at){for(const Tt of at)for(const at in Tt)rt[at]=Tt[at];return rt}let Do=1;function D(at,Tt,$t){const qt={};for(const $t in at)qt[$t]=Tt.call(this||rt,at[$t],$t,at);return qt}function R(at,Tt,$t){const qt={};for(const $t in at)Tt.call(this||rt,at[$t],$t,at)&&(qt[$t]=at[$t]);return qt}function j(rt){return Array.isArray(rt)?rt.map(j):"object"==typeof rt&&rt?D(rt,j):rt}const Ho={};function U(rt){Ho[rt]||("undefined"!=typeof console&&console.warn(rt),Ho[rt]=!0)}function q(rt,at,Tt){return(Tt.y-rt.y)*(at.x-rt.x)>(at.y-rt.y)*(Tt.x-rt.x)}function G(rt){return"undefined"!=typeof WorkerGlobalScope&&void 0!==rt&&rt instanceof WorkerGlobalScope}let Ea=null;function K(rt){return"undefined"!=typeof ImageBitmap&&rt instanceof ImageBitmap}const La="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";function H(at,Tt,$t,qt,Kt){return e(this||rt,void 0,void 0,(function*(){if("undefined"==typeof VideoFrame)throw new Error("VideoFrame not supported");const rt=new VideoFrame(at,{timestamp:0});try{const ge=null==rt?void 0:rt.format;if(!ge||!ge.startsWith("BGR")&&!ge.startsWith("RGB"))throw new Error(`Unrecognized format ${ge}`);const Hr=ge.startsWith("BGR"),wn=new Uint8ClampedArray(qt*Kt*4);if(yield rt.copyTo(wn,function(rt,at,Tt,$t,qt){const Kt=4*Math.max(1,0),ge=(Math.max(0,Tt)-Tt)*$t*4+Kt,Hr=4*$t,wn=Math.max(0,at),es=Math.max(0,Tt);return{rect:{x:wn,y:es,width:Math.min(rt.width,at+$t)-wn,height:Math.min(rt.height,Tt+qt)-es},layout:[{offset:ge,stride:Hr}]}}(at,Tt,$t,qt,Kt)),Hr)for(let rt=0;rt<wn.length;rt+=4){const at=wn[rt];wn[rt]=wn[rt+2],wn[rt+2]=at}return wn}finally{rt.close()}}))}let ja,Va;function W(rt,at,Tt,$t){return rt.addEventListener(at,Tt,$t),{unsubscribe:()=>{rt.removeEventListener(at,Tt,$t)}}}function Q(rt){return rt/Math.PI*180}const Na={touchstart:!0,touchmove:!0,touchmoveWindow:!0,touchend:!0,touchcancel:!0},qa={dblclick:!0,click:!0,mouseover:!0,mouseout:!0,mousedown:!0,mousemove:!0,mousemoveWindow:!0,mouseup:!0,mouseupWindow:!0,contextmenu:!0,wheel:!0},Qa="AbortError";function nt(){return new Error(Qa)}const Pl={MAX_PARALLEL_IMAGE_REQUESTS:16,MAX_PARALLEL_IMAGE_REQUESTS_PER_FRAME:8,MAX_TILE_CACHE_ZOOM_LEVELS:5,REGISTERED_PROTOCOLS:{},WORKER_URL:""};function st(rt){return Pl.REGISTERED_PROTOCOLS[rt.substring(0,rt.indexOf("://"))]}const zl="global-dispatcher";class ot extends Error{constructor(rt,at,Tt,$t){super(`AJAXError: ${at} (${rt}): ${Tt}`),this.status=rt,this.statusText=at,this.url=Tt,this.body=$t}}const lt=()=>G(self)?self.worker&&self.worker.referrer:("blob:"===window.location.protocol?window.parent:window).location.href,ut=function(at,Tt){if(/:\/\//.test(at.url)&&!/^https?:|^file:/.test(at.url)){const rt=st(at.url);if(rt)return rt(at,Tt);if(G(self)&&self.worker&&self.worker.actor)return self.worker.actor.sendAsync({type:"GR",data:at,targetMapId:zl},Tt)}if(!(/^file:/.test($t=at.url)||/^file:/.test(lt())&&!/^\w+:/.test($t))){if(fetch&&Request&&AbortController&&Object.prototype.hasOwnProperty.call(Request.prototype,"signal"))return function(at,Tt){return e(this||rt,void 0,void 0,(function*(){const rt=new Request(at.url,{method:at.method||"GET",body:at.body,credentials:at.credentials,headers:at.headers,cache:at.cache,referrer:lt(),signal:Tt.signal});let $t,qt;"json"!==at.type||rt.headers.has("Accept")||rt.headers.set("Accept","application/json");try{$t=yield fetch(rt)}catch(rt){throw new ot(0,rt.message,at.url,new Blob)}if(!$t.ok){const rt=yield $t.blob();throw new ot($t.status,$t.statusText,at.url,rt)}qt="arrayBuffer"===at.type||"image"===at.type?$t.arrayBuffer():"json"===at.type?$t.json():$t.text();const Kt=yield qt;if(Tt.signal.aborted)throw nt();return{data:Kt,cacheControl:$t.headers.get("Cache-Control"),expires:$t.headers.get("Expires")}}))}(at,Tt);if(G(self)&&self.worker&&self.worker.actor)return self.worker.actor.sendAsync({type:"GR",data:at,mustQueue:!0,targetMapId:zl},Tt)}var $t;return function(rt,at){return new Promise(((Tt,$t)=>{var qt;const Kt=new XMLHttpRequest;Kt.open(rt.method||"GET",rt.url,!0),"arrayBuffer"!==rt.type&&"image"!==rt.type||(Kt.responseType="arraybuffer");for(const at in rt.headers)Kt.setRequestHeader(at,rt.headers[at]);"json"===rt.type&&(Kt.responseType="text",(null===(qt=rt.headers)||void 0===qt?void 0:qt.Accept)||Kt.setRequestHeader("Accept","application/json")),Kt.withCredentials="include"===rt.credentials,Kt.onerror=()=>{$t(new Error(Kt.statusText))},Kt.onload=()=>{if(!at.signal.aborted)if((Kt.status>=200&&Kt.status<300||0===Kt.status)&&null!==Kt.response){let at=Kt.response;if("json"===rt.type)try{at=JSON.parse(Kt.response)}catch(rt){return void $t(rt)}Tt({data:at,cacheControl:Kt.getResponseHeader("Cache-Control"),expires:Kt.getResponseHeader("Expires")})}else{const at=new Blob([Kt.response],{type:Kt.getResponseHeader("Content-Type")});$t(new ot(Kt.status,Kt.statusText,rt.url,at))}},at.signal.addEventListener("abort",(()=>{Kt.abort(),$t(nt())})),Kt.send(rt.body)}))}(at,Tt)};function ct(rt){if(!rt||rt.indexOf("://")<=0||0===rt.indexOf("data:image/")||0===rt.indexOf("blob:"))return!0;const at=new URL(rt),Tt=window.location;return at.protocol===Tt.protocol&&at.host===Tt.host}function ht(rt,at,Tt){Tt[rt]&&-1!==Tt[rt].indexOf(at)||(Tt[rt]=Tt[rt]||[],Tt[rt].push(at))}function pt(rt,at,Tt){if(Tt&&Tt[rt]){const $t=Tt[rt].indexOf(at);-1!==$t&&Tt[rt].splice($t,1)}}class ft{constructor(rt,at={}){L(this,at),this.type=rt}}class dt extends ft{constructor(rt,at={}){super("error",L({error:rt},at))}}class yt{on(rt,at){return this._listeners=this._listeners||{},ht(rt,at,this._listeners),{unsubscribe:()=>{this.off(rt,at)}}}off(rt,at){return pt(rt,at,this._listeners),pt(rt,at,this._oneTimeListeners),this}once(rt,at){return at?(this._oneTimeListeners=this._oneTimeListeners||{},ht(rt,at,this._oneTimeListeners),this):new Promise((at=>this.once(rt,at)))}fire(rt,at){"string"==typeof rt&&(rt=new ft(rt,at||{}));const Tt=rt.type;if(this.listens(Tt)){rt.target=this;const at=this._listeners&&this._listeners[Tt]?this._listeners[Tt].slice():[];for(const Tt of at)Tt.call(this,rt);const $t=this._oneTimeListeners&&this._oneTimeListeners[Tt]?this._oneTimeListeners[Tt].slice():[];for(const at of $t)pt(Tt,at,this._oneTimeListeners),at.call(this,rt);const qt=this._eventedParent;qt&&(L(rt,"function"==typeof this._eventedParentData?this._eventedParentData():this._eventedParentData),qt.fire(rt))}else rt instanceof dt&&console.error(rt.error);return this}listens(rt){return this._listeners&&this._listeners[rt]&&this._listeners[rt].length>0||this._oneTimeListeners&&this._oneTimeListeners[rt]&&this._oneTimeListeners[rt].length>0||this._eventedParent&&this._eventedParent.listens(rt)}setEventedParent(rt,at){return this._eventedParent=rt,this._eventedParentData=at,this}}var Dl={$version:8,$root:{version:{required:!0,type:"enum",values:[8]},name:{type:"string"},metadata:{type:"*"},center:{type:"array",value:"number"},centerAltitude:{type:"number"},zoom:{type:"number"},bearing:{type:"number",default:0,period:360,units:"degrees"},pitch:{type:"number",default:0,units:"degrees"},roll:{type:"number",default:0,units:"degrees"},light:{type:"light"},sky:{type:"sky"},projection:{type:"projection"},terrain:{type:"terrain"},sources:{required:!0,type:"sources"},sprite:{type:"sprite"},glyphs:{type:"string"},transition:{type:"transition"},layers:{required:!0,type:"array",value:"layer"}},sources:{"*":{type:"source"}},source:["source_vector","source_raster","source_raster_dem","source_geojson","source_video","source_image"],source_vector:{type:{required:!0,type:"enum",values:{vector:{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},scheme:{type:"enum",values:{xyz:{},tms:{}},default:"xyz"},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},attribution:{type:"string"},promoteId:{type:"promoteId"},volatile:{type:"boolean",default:!1},"*":{type:"*"}},source_raster:{type:{required:!0,type:"enum",values:{raster:{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},tileSize:{type:"number",default:512,units:"pixels"},scheme:{type:"enum",values:{xyz:{},tms:{}},default:"xyz"},attribution:{type:"string"},volatile:{type:"boolean",default:!1},"*":{type:"*"}},source_raster_dem:{type:{required:!0,type:"enum",values:{"raster-dem":{}}},url:{type:"string"},tiles:{type:"array",value:"string"},bounds:{type:"array",value:"number",length:4,default:[-180,-85.051129,180,85.051129]},minzoom:{type:"number",default:0},maxzoom:{type:"number",default:22},tileSize:{type:"number",default:512,units:"pixels"},attribution:{type:"string"},encoding:{type:"enum",values:{terrarium:{},mapbox:{},custom:{}},default:"mapbox"},redFactor:{type:"number",default:1},blueFactor:{type:"number",default:1},greenFactor:{type:"number",default:1},baseShift:{type:"number",default:0},volatile:{type:"boolean",default:!1},"*":{type:"*"}},source_geojson:{type:{required:!0,type:"enum",values:{geojson:{}}},data:{required:!0,type:"*"},maxzoom:{type:"number",default:18},attribution:{type:"string"},buffer:{type:"number",default:128,maximum:512,minimum:0},filter:{type:"*"},tolerance:{type:"number",default:.375},cluster:{type:"boolean",default:!1},clusterRadius:{type:"number",default:50,minimum:0},clusterMaxZoom:{type:"number"},clusterMinPoints:{type:"number"},clusterProperties:{type:"*"},lineMetrics:{type:"boolean",default:!1},generateId:{type:"boolean",default:!1},promoteId:{type:"promoteId"}},source_video:{type:{required:!0,type:"enum",values:{video:{}}},urls:{required:!0,type:"array",value:"string"},coordinates:{required:!0,type:"array",length:4,value:{type:"array",length:2,value:"number"}}},source_image:{type:{required:!0,type:"enum",values:{image:{}}},url:{required:!0,type:"string"},coordinates:{required:!0,type:"array",length:4,value:{type:"array",length:2,value:"number"}}},layer:{id:{type:"string",required:!0},type:{type:"enum",values:{fill:{},line:{},symbol:{},circle:{},heatmap:{},"fill-extrusion":{},raster:{},hillshade:{},background:{}},required:!0},metadata:{type:"*"},source:{type:"string"},"source-layer":{type:"string"},minzoom:{type:"number",minimum:0,maximum:24},maxzoom:{type:"number",minimum:0,maximum:24},filter:{type:"filter"},layout:{type:"layout"},paint:{type:"paint"}},layout:["layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_symbol","layout_raster","layout_hillshade","layout_background"],layout_background:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_fill:{"fill-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_circle:{"circle-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_heatmap:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},"layout_fill-extrusion":{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_line:{"line-cap":{type:"enum",values:{butt:{},round:{},square:{}},default:"butt",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"line-join":{type:"enum",values:{bevel:{},round:{},miter:{}},default:"miter",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{type:"number",default:2,requires:[{"line-join":"miter"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-round-limit":{type:"number",default:1.05,requires:[{"line-join":"round"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_symbol:{"symbol-placement":{type:"enum",values:{point:{},line:{},"line-center":{}},default:"point",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"symbol-spacing":{type:"number",default:250,minimum:1,units:"pixels",requires:[{"symbol-placement":"line"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{type:"boolean",default:!1,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"symbol-sort-key":{type:"number",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{type:"enum",values:{auto:{},"viewport-y":{},source:{}},default:"auto",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-allow-overlap":{type:"boolean",default:!1,requires:["icon-image",{"!":"icon-overlap"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-overlap":{type:"enum",values:{never:{},always:{},cooperative:{}},requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-ignore-placement":{type:"boolean",default:!1,requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-optional":{type:"boolean",default:!1,requires:["icon-image","text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-rotation-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-size":{type:"number",default:1,minimum:0,units:"factor of the original icon size",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit":{type:"enum",values:{none:{},width:{},height:{},both:{}},default:"none",requires:["icon-image","text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-text-fit-padding":{type:"array",value:"number",length:4,default:[0,0,0,0],units:"pixels",requires:["icon-image","text-field",{"icon-text-fit":["both","width","height"]}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"icon-image":{type:"resolvedImage",tokens:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{type:"number",default:0,period:360,units:"degrees",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{type:"padding",default:[2],units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-keep-upright":{type:"boolean",default:!1,requires:["icon-image",{"icon-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"icon-offset":{type:"array",value:"number",length:2,default:[0,0],requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{type:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},default:"center",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-pitch-alignment":{type:"enum",values:{map:{},viewport:{},auto:{}},default:"auto",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-rotation-alignment":{type:"enum",values:{map:{},viewport:{},"viewport-glyph":{},auto:{}},default:"auto",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-field":{type:"formatted",default:"",tokens:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-font":{type:"array",value:"string",default:["Open Sans Regular","Arial Unicode MS Regular"],requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-size":{type:"number",default:16,minimum:0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-max-width":{type:"number",default:10,minimum:0,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{type:"number",default:1.2,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-letter-spacing":{type:"number",default:0,units:"ems",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-justify":{type:"enum",values:{auto:{},left:{},center:{},right:{}},default:"center",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{type:"number",units:"ems",default:0,requires:["text-field"],"property-type":"data-driven",expression:{interpolated:!0,parameters:["zoom","feature"]}},"text-variable-anchor":{type:"array",value:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-variable-anchor-offset":{type:"variableAnchorOffsetCollection",requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-anchor":{type:"enum",values:{center:{},left:{},right:{},top:{},bottom:{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},default:"center",requires:["text-field",{"!":"text-variable-anchor"}],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{type:"number",default:45,units:"degrees",requires:["text-field",{"symbol-placement":["line","line-center"]}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-writing-mode":{type:"array",value:"enum",values:{horizontal:{},vertical:{}},requires:["text-field",{"symbol-placement":["point"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-rotate":{type:"number",default:0,period:360,units:"degrees",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-padding":{type:"number",default:2,minimum:0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-keep-upright":{type:"boolean",default:!0,requires:["text-field",{"text-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-transform":{type:"enum",values:{none:{},uppercase:{},lowercase:{}},default:"none",requires:["text-field"],expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-offset":{type:"array",value:"number",units:"ems",length:2,default:[0,0],requires:["text-field",{"!":"text-radial-offset"}],expression:{interpolated:!0,parameters:["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{type:"boolean",default:!1,requires:["text-field",{"!":"text-overlap"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-overlap":{type:"enum",values:{never:{},always:{},cooperative:{}},requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-ignore-placement":{type:"boolean",default:!1,requires:["text-field"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-optional":{type:"boolean",default:!1,requires:["text-field","icon-image"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_raster:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},layout_hillshade:{visibility:{type:"enum",values:{visible:{},none:{}},default:"visible","property-type":"constant"}},filter:{type:"array",value:"*"},filter_operator:{type:"enum",values:{"==":{},"!=":{},">":{},">=":{},"<":{},"<=":{},in:{},"!in":{},all:{},any:{},none:{},has:{},"!has":{}}},geometry_type:{type:"enum",values:{Point:{},LineString:{},Polygon:{}}},function:{expression:{type:"expression"},stops:{type:"array",value:"function_stop"},base:{type:"number",default:1,minimum:0},property:{type:"string",default:"$zoom"},type:{type:"enum",values:{identity:{},exponential:{},interval:{},categorical:{}},default:"exponential"},colorSpace:{type:"enum",values:{rgb:{},lab:{},hcl:{}},default:"rgb"},default:{type:"*",required:!1}},function_stop:{type:"array",minimum:0,maximum:24,value:["number","color"],length:2},expression:{type:"array",value:"*",minimum:1},light:{anchor:{type:"enum",default:"viewport",values:{map:{},viewport:{}},"property-type":"data-constant",transition:!1,expression:{interpolated:!1,parameters:["zoom"]}},position:{type:"array",default:[1.15,210,30],length:3,value:"number","property-type":"data-constant",transition:!0,expression:{interpolated:!0,parameters:["zoom"]}},color:{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},intensity:{type:"number","property-type":"data-constant",default:.5,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0}},sky:{"sky-color":{type:"color","property-type":"data-constant",default:"#88C6FC",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"horizon-color":{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"fog-color":{type:"color","property-type":"data-constant",default:"#ffffff",expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"fog-ground-blend":{type:"number","property-type":"data-constant",default:.5,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"horizon-fog-blend":{type:"number","property-type":"data-constant",default:.8,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"sky-horizon-blend":{type:"number","property-type":"data-constant",default:.8,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0},"atmosphere-blend":{type:"number","property-type":"data-constant",default:.8,minimum:0,maximum:1,expression:{interpolated:!0,parameters:["zoom"]},transition:!0}},terrain:{source:{type:"string",required:!0},exaggeration:{type:"number",minimum:0,default:1}},projection:{type:{type:"projectionDefinition",default:"mercator","property-type":"data-constant",transition:!1,expression:{interpolated:!0,parameters:["zoom"]}}},paint:["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_symbol","paint_raster","paint_hillshade","paint_background"],paint_fill:{"fill-antialias":{type:"boolean",default:!0,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"fill-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-outline-color":{type:"color",transition:!0,requires:[{"!":"fill-pattern"},{"fill-antialias":!0}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["fill-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"fill-extrusion-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["fill-extrusion-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"fill-extrusion-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"},"fill-extrusion-height":{type:"number",default:0,minimum:0,units:"meters",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{type:"number",default:0,minimum:0,units:"meters",transition:!0,requires:["fill-extrusion-height"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-vertical-gradient":{type:"boolean",default:!0,transition:!1,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"}},paint_line:{"line-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"line-pattern"}],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"line-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["line-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"line-width":{type:"number",default:1,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-gap-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-offset":{type:"number",default:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-dasharray":{type:"array",value:"number",minimum:0,transition:!0,units:"line widths",requires:[{"!":"line-pattern"}],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"cross-faded"},"line-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"cross-faded-data-driven"},"line-gradient":{type:"color",transition:!1,requires:[{"!":"line-dasharray"},{"!":"line-pattern"},{source:"geojson",has:{lineMetrics:!0}}],expression:{interpolated:!0,parameters:["line-progress"]},"property-type":"color-ramp"}},paint_circle:{"circle-radius":{type:"number",default:5,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-blur":{type:"number",default:0,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"circle-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["circle-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-pitch-scale":{type:"enum",values:{map:{},viewport:{}},default:"map",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-pitch-alignment":{type:"enum",values:{map:{},viewport:{}},default:"viewport",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"circle-stroke-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"}},paint_heatmap:{"heatmap-radius":{type:"number",default:30,minimum:1,transition:!0,units:"pixels",expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-weight":{type:"number",default:1,minimum:0,transition:!1,expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-intensity":{type:"number",default:1,minimum:0,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"heatmap-color":{type:"color",default:["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",.1,"royalblue",.3,"cyan",.5,"lime",.7,"yellow",1,"red"],transition:!1,expression:{interpolated:!0,parameters:["heatmap-density"]},"property-type":"color-ramp"},"heatmap-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_symbol:{"icon-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-color":{type:"color",default:"#000000",transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-color":{type:"color",default:"rgba(0, 0, 0, 0)",transition:!0,requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",requires:["icon-image"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"icon-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["icon-image","icon-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"text-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-color":{type:"color",default:"#000000",transition:!0,overridable:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-color":{type:"color",default:"rgba(0, 0, 0, 0)",transition:!0,requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-width":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-blur":{type:"number",default:0,minimum:0,transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-translate":{type:"array",value:"number",length:2,default:[0,0],transition:!0,units:"pixels",requires:["text-field"],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"text-translate-anchor":{type:"enum",values:{map:{},viewport:{}},default:"map",requires:["text-field","text-translate"],expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"}},paint_raster:{"raster-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-hue-rotate":{type:"number",default:0,period:360,transition:!0,units:"degrees",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-brightness-min":{type:"number",default:0,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-brightness-max":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-saturation":{type:"number",default:0,minimum:-1,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-contrast":{type:"number",default:0,minimum:-1,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"raster-resampling":{type:"enum",values:{linear:{},nearest:{}},default:"linear",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"raster-fade-duration":{type:"number",default:300,minimum:0,transition:!1,units:"milliseconds",expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_hillshade:{"hillshade-illumination-direction":{type:"number",default:335,minimum:0,maximum:359,transition:!1,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-illumination-anchor":{type:"enum",values:{map:{},viewport:{}},default:"viewport",expression:{interpolated:!1,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-exaggeration":{type:"number",default:.5,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-shadow-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-highlight-color":{type:"color",default:"#FFFFFF",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"hillshade-accent-color":{type:"color",default:"#000000",transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},paint_background:{"background-color":{type:"color",default:"#000000",transition:!0,requires:[{"!":"background-pattern"}],expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"},"background-pattern":{type:"resolvedImage",transition:!0,expression:{interpolated:!1,parameters:["zoom"]},"property-type":"cross-faded"},"background-opacity":{type:"number",default:1,minimum:0,maximum:1,transition:!0,expression:{interpolated:!0,parameters:["zoom"]},"property-type":"data-constant"}},transition:{duration:{type:"number",default:300,minimum:0,units:"milliseconds"},delay:{type:"number",default:0,minimum:0,units:"milliseconds"}},"property-type":{"data-driven":{type:"property-type"},"cross-faded":{type:"property-type"},"cross-faded-data-driven":{type:"property-type"},"color-ramp":{type:"property-type"},"data-constant":{type:"property-type"},constant:{type:"property-type"}},promoteId:{"*":{type:"string"}}};const Ll=["type","source","source-layer","minzoom","maxzoom","filter","layout"];function xt(rt,at){const Tt={};for(const at in rt)"ref"!==at&&(Tt[at]=rt[at]);return Ll.forEach((rt=>{rt in at&&(Tt[rt]=at[rt])})),Tt}function vt(rt,at){if(Array.isArray(rt)){if(!Array.isArray(at)||rt.length!==at.length)return!1;for(let Tt=0;Tt<rt.length;Tt++)if(!vt(rt[Tt],at[Tt]))return!1;return!0}if("object"==typeof rt&&null!==rt&&null!==at){if("object"!=typeof at)return!1;if(Object.keys(rt).length!==Object.keys(at).length)return!1;for(const Tt in rt)if(!vt(rt[Tt],at[Tt]))return!1;return!0}return rt===at}function bt(rt,at){rt.push(at)}function wt(rt,at,Tt){bt(Tt,{command:"addSource",args:[rt,at[rt]]})}function _t(rt,at,Tt){bt(at,{command:"removeSource",args:[rt]}),Tt[rt]=!0}function St(rt,at,Tt,$t){_t(rt,Tt,$t),wt(rt,at,Tt)}function At(rt,at,Tt){let $t;for($t in rt[Tt])if(Object.prototype.hasOwnProperty.call(rt[Tt],$t)&&"data"!==$t&&!vt(rt[Tt][$t],at[Tt][$t]))return!1;for($t in at[Tt])if(Object.prototype.hasOwnProperty.call(at[Tt],$t)&&"data"!==$t&&!vt(rt[Tt][$t],at[Tt][$t]))return!1;return!0}function kt(rt,at,Tt,$t,qt,Kt){rt=rt||{},at=at||{};for(const ge in rt)Object.prototype.hasOwnProperty.call(rt,ge)&&(vt(rt[ge],at[ge])||Tt.push({command:Kt,args:[$t,ge,at[ge],qt]}));for(const ge in at)Object.prototype.hasOwnProperty.call(at,ge)&&!Object.prototype.hasOwnProperty.call(rt,ge)&&(vt(rt[ge],at[ge])||Tt.push({command:Kt,args:[$t,ge,at[ge],qt]}))}function Mt(rt){return rt.id}function It(rt,at){return rt[at.id]=at,rt}class zt{constructor(rt,at,Tt,$t){this.message=(rt?`${rt}: `:"")+Tt,$t&&(this.identifier=$t),null!=at&&at.__line__&&(this.line=at.__line__)}}function Pt(rt,...at){for(const Tt of at)for(const at in Tt)rt[at]=Tt[at];return rt}class Ct extends Error{constructor(rt,at){super(at),this.message=at,this.key=rt}}class Bt{constructor(rt,at=[]){this.parent=rt,this.bindings={};for(const[rt,Tt]of at)this.bindings[rt]=Tt}concat(rt){return new Bt(this,rt)}get(rt){if(this.bindings[rt])return this.bindings[rt];if(this.parent)return this.parent.get(rt);throw new Error(`${rt} not found in scope.`)}has(rt){return!!this.bindings[rt]||!!this.parent&&this.parent.has(rt)}}const Ol={kind:"null"},jl={kind:"number"},Nl={kind:"string"},Zl={kind:"boolean"},Ul={kind:"color"},Gl={kind:"projectionDefinition"},ql={kind:"object"},Hl={kind:"value"},Xl={kind:"collator"},Kl={kind:"formatted"},Yl={kind:"padding"},Jl={kind:"resolvedImage"},tc={kind:"variableAnchorOffsetCollection"};function Gt(rt,at){return{kind:"array",itemType:rt,N:at}}function Zt(rt){if("array"===rt.kind){const at=Zt(rt.itemType);return"number"==typeof rt.N?`array<${at}, ${rt.N}>`:"value"===rt.itemType.kind?"array":`array<${at}>`}return rt.kind}const ic=[Ol,jl,Nl,Zl,Ul,Gl,Kl,ql,Gt(Hl),Yl,Jl,tc];function Xt(rt,at){if("error"===at.kind)return null;if("array"===rt.kind){if("array"===at.kind&&(0===at.N&&"value"===at.itemType.kind||!Xt(rt.itemType,at.itemType))&&("number"!=typeof rt.N||rt.N===at.N))return null}else{if(rt.kind===at.kind)return null;if("value"===rt.kind)for(const rt of ic)if(!Xt(rt,at))return null}return`Expected ${Zt(rt)} but found ${Zt(at)} instead.`}function Ht(rt,at){return at.some((at=>at.kind===rt.kind))}function Yt(rt,at){return at.some((at=>"null"===at?null===rt:"array"===at?Array.isArray(rt):"object"===at?rt&&!Array.isArray(rt)&&"object"==typeof rt:at===typeof rt))}function Jt(rt,at){return"array"===rt.kind&&"array"===at.kind?rt.itemType.kind===at.itemType.kind&&"number"==typeof rt.N:rt.kind===at.kind}const sc=.96422,ac=.82521,Pc=4/29,Sc=6/29,Ac=3*Sc*Sc,zc=Sc*Sc*Sc,kc=Math.PI/180,Lc=180/Math.PI;function ae(rt){return(rt%=360)<0&&(rt+=360),rt}function oe([rt,at,Tt,$t]){let qt,Kt;const ge=ue((.2225045*(rt=le(rt))+.7168786*(at=le(at))+.0606169*(Tt=le(Tt)))/1);rt===at&&at===Tt?qt=Kt=ge:(qt=ue((.4360747*rt+.3850649*at+.1430804*Tt)/sc),Kt=ue((.0139322*rt+.0971045*at+.7141733*Tt)/ac));const Hr=116*ge-16;return[Hr<0?0:Hr,500*(qt-ge),200*(ge-Kt),$t]}function le(rt){return rt<=.04045?rt/12.92:Math.pow((rt+.055)/1.055,2.4)}function ue(rt){return rt>zc?Math.pow(rt,1/3):rt/Ac+Pc}function ce([rt,at,Tt,$t]){let qt=(rt+16)/116,Kt=isNaN(at)?qt:qt+at/500,ge=isNaN(Tt)?qt:qt-Tt/200;return qt=1*pe(qt),Kt=sc*pe(Kt),ge=ac*pe(ge),[he(3.1338561*Kt-1.6168667*qt-.4906146*ge),he(-.9787684*Kt+1.9161415*qt+.033454*ge),he(.0719453*Kt-.2289914*qt+1.4052427*ge),$t]}function he(rt){return(rt=rt<=.00304?12.92*rt:1.055*Math.pow(rt,1/2.4)-.055)<0?0:rt>1?1:rt}function pe(rt){return rt>Sc?rt*rt*rt:Ac*(rt-Pc)}function fe(rt){return parseInt(rt.padEnd(2,rt),16)/255}function de(rt,at){return ye(at?rt/100:rt,0,1)}function ye(rt,at,Tt){return Math.min(Math.max(at,rt),Tt)}function me(rt){return!rt.some(Number.isNaN)}const Oc={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]};function xe(rt,at,Tt){return rt+Tt*(at-rt)}function ve(rt,at,Tt){return rt.map(((rt,$t)=>xe(rt,at[$t],Tt)))}class be{constructor(rt,at,Tt,$t=1,qt=!0){this.r=rt,this.g=at,this.b=Tt,this.a=$t,qt||(this.r*=$t,this.g*=$t,this.b*=$t,$t||this.overwriteGetter("rgb",[rt,at,Tt,$t]))}static parse(rt){if(rt instanceof be)return rt;if("string"!=typeof rt)return;const at=function(rt){if("transparent"===(rt=rt.toLowerCase().trim()))return[0,0,0,0];const at=Oc[rt];if(at){const[rt,Tt,$t]=at;return[rt/255,Tt/255,$t/255,1]}if(rt.startsWith("#")&&/^#(?:[0-9a-f]{3,4}|[0-9a-f]{6}|[0-9a-f]{8})$/.test(rt)){const at=rt.length<6?1:2;let Tt=1;return[fe(rt.slice(Tt,Tt+=at)),fe(rt.slice(Tt,Tt+=at)),fe(rt.slice(Tt,Tt+=at)),fe(rt.slice(Tt,Tt+at)||"ff")]}if(rt.startsWith("rgb")){const at=rt.match(/^rgba?\(\s*([\de.+-]+)(%)?(?:\s+|\s*(,)\s*)([\de.+-]+)(%)?(?:\s+|\s*(,)\s*)([\de.+-]+)(%)?(?:\s*([,\/])\s*([\de.+-]+)(%)?)?\s*\)$/);if(at){const[rt,Tt,$t,qt,Kt,ge,Hr,wn,es,ss,os,cs]=at,ds=[qt||" ",Hr||" ",ss].join("");if("  "===ds||"  /"===ds||",,"===ds||",,,"===ds){const rt=[$t,ge,es].join(""),at="%%%"===rt?100:""===rt?255:0;if(at){const rt=[ye(+Tt/at,0,1),ye(+Kt/at,0,1),ye(+wn/at,0,1),os?de(+os,cs):1];if(me(rt))return rt}}return}}const Tt=rt.match(/^hsla?\(\s*([\de.+-]+)(?:deg)?(?:\s+|\s*(,)\s*)([\de.+-]+)%(?:\s+|\s*(,)\s*)([\de.+-]+)%(?:\s*([,\/])\s*([\de.+-]+)(%)?)?\s*\)$/);if(Tt){const[rt,at,$t,qt,Kt,ge,Hr,wn,es]=Tt,ss=[$t||" ",Kt||" ",Hr].join("");if("  "===ss||"  /"===ss||",,"===ss||",,,"===ss){const rt=[+at,ye(+qt,0,100),ye(+ge,0,100),wn?de(+wn,es):1];if(me(rt))return function([rt,at,Tt,$t]){function i($t){const qt=($t+rt/30)%12,Kt=at*Math.min(Tt,1-Tt);return Tt-Kt*Math.max(-1,Math.min(qt-3,9-qt,1))}return rt=ae(rt),at/=100,Tt/=100,[i(0),i(8),i(4),$t]}(rt)}}}(rt);return at?new be(...at,!1):void 0}get rgb(){const{r:rt,g:at,b:Tt,a:$t}=this,qt=$t||1/0;return this.overwriteGetter("rgb",[rt/qt,at/qt,Tt/qt,$t])}get hcl(){return this.overwriteGetter("hcl",function(rt){const[at,Tt,$t,qt]=oe(rt),Kt=Math.sqrt(Tt*Tt+$t*$t);return[Math.round(1e4*Kt)?ae(Math.atan2($t,Tt)*Lc):NaN,Kt,at,qt]}(this.rgb))}get lab(){return this.overwriteGetter("lab",oe(this.rgb))}overwriteGetter(rt,at){return Object.defineProperty(this,rt,{value:at}),at}toString(){const[rt,at,Tt,$t]=this.rgb;return`rgba(${[rt,at,Tt].map((rt=>Math.round(255*rt))).join(",")},${$t})`}static interpolate(rt,at,Tt,$t="rgb"){switch($t){case"rgb":{const[$t,qt,Kt,ge]=ve(rt.rgb,at.rgb,Tt);return new be($t,qt,Kt,ge,!1)}case"hcl":{const[$t,qt,Kt,ge]=rt.hcl,[Hr,wn,es,ss]=at.hcl;let os,cs;if(isNaN($t)||isNaN(Hr))isNaN($t)?isNaN(Hr)?os=NaN:(os=Hr,1!==Kt&&0!==Kt||(cs=wn)):(os=$t,1!==es&&0!==es||(cs=qt));else{let rt=Hr-$t;Hr>$t&&rt>180?rt-=360:Hr<$t&&$t-Hr>180&&(rt+=360),os=$t+Tt*rt}const[ds,Cs,Vs,Eo]=function([rt,at,Tt,$t]){return rt=isNaN(rt)?0:rt*kc,ce([Tt,Math.cos(rt)*at,Math.sin(rt)*at,$t])}([os,null!=cs?cs:xe(qt,wn,Tt),xe(Kt,es,Tt),xe(ge,ss,Tt)]);return new be(ds,Cs,Vs,Eo,!1)}case"lab":{const[$t,qt,Kt,ge]=ce(ve(rt.lab,at.lab,Tt));return new be($t,qt,Kt,ge,!1)}}}}be.black=new be(0,0,0,1),be.white=new be(1,1,1,1),be.transparent=new be(0,0,0,0),be.red=new be(1,0,0,1);class we{constructor(rt,at,Tt){this.sensitivity=rt?at?"variant":"case":at?"accent":"base",this.locale=Tt,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(rt,at){return this.collator.compare(rt,at)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}const jc=["bottom","center","top"];class Se{constructor(rt,at,Tt,$t,qt,Kt){this.text=rt,this.image=at,this.scale=Tt,this.fontStack=$t,this.textColor=qt,this.verticalAlign=Kt}}class Ae{constructor(rt){this.sections=rt}static fromString(rt){return new Ae([new Se(rt,null,null,null,null,null)])}isEmpty(){return 0===this.sections.length||!this.sections.some((rt=>0!==rt.text.length||rt.image&&0!==rt.image.name.length))}static factory(rt){return rt instanceof Ae?rt:Ae.fromString(rt)}toString(){return 0===this.sections.length?"":this.sections.map((rt=>rt.text)).join("")}}class ke{constructor(rt){this.values=rt.slice()}static parse(rt){if(rt instanceof ke)return rt;if("number"==typeof rt)return new ke([rt,rt,rt,rt]);if(Array.isArray(rt)&&!(rt.length<1||rt.length>4)){for(const at of rt)if("number"!=typeof at)return;switch(rt.length){case 1:rt=[rt[0],rt[0],rt[0],rt[0]];break;case 2:rt=[rt[0],rt[1],rt[0],rt[1]];break;case 3:rt=[rt[0],rt[1],rt[2],rt[1]]}return new ke(rt)}}toString(){return JSON.stringify(this.values)}static interpolate(rt,at,Tt){return new ke(ve(rt.values,at.values,Tt))}}class Me{constructor(rt){this.name="ExpressionEvaluationError",this.message=rt}toJSON(){return this.message}}const Nc=new Set(["center","left","right","top","bottom","top-left","top-right","bottom-left","bottom-right"]);class ze{constructor(rt){this.values=rt.slice()}static parse(rt){if(rt instanceof ze)return rt;if(Array.isArray(rt)&&!(rt.length<1)&&rt.length%2==0){for(let at=0;at<rt.length;at+=2){const Tt=rt[at],$t=rt[at+1];if("string"!=typeof Tt||!Nc.has(Tt))return;if(!Array.isArray($t)||2!==$t.length||"number"!=typeof $t[0]||"number"!=typeof $t[1])return}return new ze(rt)}}toString(){return JSON.stringify(this.values)}static interpolate(rt,at,Tt){const $t=rt.values,qt=at.values;if($t.length!==qt.length)throw new Me(`Cannot interpolate values of different length. from: ${rt.toString()}, to: ${at.toString()}`);const Kt=[];for(let rt=0;rt<$t.length;rt+=2){if($t[rt]!==qt[rt])throw new Me(`Cannot interpolate values containing mismatched anchors. from[${rt}]: ${$t[rt]}, to[${rt}]: ${qt[rt]}`);Kt.push($t[rt]);const[at,ge]=$t[rt+1],[Hr,wn]=qt[rt+1];Kt.push([xe(at,Hr,Tt),xe(ge,wn,Tt)])}return new ze(Kt)}}class Pe{constructor(rt){this.name=rt.name,this.available=rt.available}toString(){return this.name}static fromString(rt){return rt?new Pe({name:rt,available:!1}):null}}class Ce{constructor(rt,at,Tt){this.from=rt,this.to=at,this.transition=Tt}static interpolate(rt,at,Tt){return new Ce(rt,at,Tt)}static parse(rt){return rt instanceof Ce?rt:Array.isArray(rt)&&3===rt.length&&"string"==typeof rt[0]&&"string"==typeof rt[1]&&"number"==typeof rt[2]?new Ce(rt[0],rt[1],rt[2]):"object"==typeof rt&&"string"==typeof rt.from&&"string"==typeof rt.to&&"number"==typeof rt.transition?new Ce(rt.from,rt.to,rt.transition):"string"==typeof rt?new Ce(rt,rt,1):void 0}}function Be(rt,at,Tt,$t){return"number"==typeof rt&&rt>=0&&rt<=255&&"number"==typeof at&&at>=0&&at<=255&&"number"==typeof Tt&&Tt>=0&&Tt<=255?void 0===$t||"number"==typeof $t&&$t>=0&&$t<=1?null:`Invalid rgba value [${[rt,at,Tt,$t].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${("number"==typeof $t?[rt,at,Tt,$t]:[rt,at,Tt]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function Ve(rt){if(null===rt||"string"==typeof rt||"boolean"==typeof rt||"number"==typeof rt||rt instanceof Ce||rt instanceof be||rt instanceof we||rt instanceof Ae||rt instanceof ke||rt instanceof ze||rt instanceof Pe)return!0;if(Array.isArray(rt)){for(const at of rt)if(!Ve(at))return!1;return!0}if("object"==typeof rt){for(const at in rt)if(!Ve(rt[at]))return!1;return!0}return!1}function Ee(rt){if(null===rt)return Ol;if("string"==typeof rt)return Nl;if("boolean"==typeof rt)return Zl;if("number"==typeof rt)return jl;if(rt instanceof be)return Ul;if(rt instanceof Ce)return Gl;if(rt instanceof we)return Xl;if(rt instanceof Ae)return Kl;if(rt instanceof ke)return Yl;if(rt instanceof ze)return tc;if(rt instanceof Pe)return Jl;if(Array.isArray(rt)){const at=rt.length;let Tt;for(const at of rt){const rt=Ee(at);if(Tt){if(Tt===rt)continue;Tt=Hl;break}Tt=rt}return Gt(Tt||Hl,at)}return ql}function Te(rt){const at=typeof rt;return null===rt?"":"string"===at||"number"===at||"boolean"===at?String(rt):rt instanceof be||rt instanceof Ce||rt instanceof Ae||rt instanceof ke||rt instanceof ze||rt instanceof Pe?rt.toString():JSON.stringify(rt)}class Fe{constructor(rt,at){this.type=rt,this.value=at}static parse(rt,at){if(2!==rt.length)return at.error(`'literal' expression requires exactly one argument, but found ${rt.length-1} instead.`);if(!Ve(rt[1]))return at.error("invalid value");const Tt=rt[1];let $t=Ee(Tt);const qt=at.expectedType;return"array"!==$t.kind||0!==$t.N||!qt||"array"!==qt.kind||"number"==typeof qt.N&&0!==qt.N||($t=qt),new Fe($t,Tt)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}}const $c={string:Nl,number:jl,boolean:Zl,object:ql};class Le{constructor(rt,at){this.type=rt,this.args=at}static parse(rt,at){if(rt.length<2)return at.error("Expected at least one argument.");let Tt,$t=1;const qt=rt[0];if("array"===qt){let qt,Kt;if(rt.length>2){const Tt=rt[1];if("string"!=typeof Tt||!(Tt in $c)||"object"===Tt)return at.error('The item type argument of "array" must be one of string, number, boolean',1);qt=$c[Tt],$t++}else qt=Hl;if(rt.length>3){if(null!==rt[2]&&("number"!=typeof rt[2]||rt[2]<0||rt[2]!==Math.floor(rt[2])))return at.error('The length argument to "array" must be a positive integer literal',2);Kt=rt[2],$t++}Tt=Gt(qt,Kt)}else{if(!$c[qt])throw new Error(`Types doesn't contain name = ${qt}`);Tt=$c[qt]}const Kt=[];for(;$t<rt.length;$t++){const Tt=at.parse(rt[$t],$t,Hl);if(!Tt)return null;Kt.push(Tt)}return new Le(Tt,Kt)}evaluate(rt){for(let at=0;at<this.args.length;at++){const Tt=this.args[at].evaluate(rt);if(!Xt(this.type,Ee(Tt)))return Tt;if(at===this.args.length-1)throw new Me(`Expected value to be of type ${Zt(this.type)}, but found ${Zt(Ee(Tt))} instead.`)}throw new Error}eachChild(rt){this.args.forEach(rt)}outputDefined(){return this.args.every((rt=>rt.outputDefined()))}}const Gc={"to-boolean":Zl,"to-color":Ul,"to-number":jl,"to-string":Nl};class De{constructor(rt,at){this.type=rt,this.args=at}static parse(rt,at){if(rt.length<2)return at.error("Expected at least one argument.");const Tt=rt[0];if(!Gc[Tt])throw new Error(`Can't parse ${Tt} as it is not part of the known types`);if(("to-boolean"===Tt||"to-string"===Tt)&&2!==rt.length)return at.error("Expected one argument.");const $t=Gc[Tt],qt=[];for(let Tt=1;Tt<rt.length;Tt++){const $t=at.parse(rt[Tt],Tt,Hl);if(!$t)return null;qt.push($t)}return new De($t,qt)}evaluate(rt){switch(this.type.kind){case"boolean":return Boolean(this.args[0].evaluate(rt));case"color":{let at,Tt;for(const $t of this.args){if(at=$t.evaluate(rt),Tt=null,at instanceof be)return at;if("string"==typeof at){const Tt=rt.parseColor(at);if(Tt)return Tt}else if(Array.isArray(at)&&(Tt=at.length<3||at.length>4?`Invalid rgba value ${JSON.stringify(at)}: expected an array containing either three or four numeric values.`:Be(at[0],at[1],at[2],at[3]),!Tt))return new be(at[0]/255,at[1]/255,at[2]/255,at[3])}throw new Me(Tt||`Could not parse color from value '${"string"==typeof at?at:JSON.stringify(at)}'`)}case"padding":{let at;for(const Tt of this.args){at=Tt.evaluate(rt);const $t=ke.parse(at);if($t)return $t}throw new Me(`Could not parse padding from value '${"string"==typeof at?at:JSON.stringify(at)}'`)}case"variableAnchorOffsetCollection":{let at;for(const Tt of this.args){at=Tt.evaluate(rt);const $t=ze.parse(at);if($t)return $t}throw new Me(`Could not parse variableAnchorOffsetCollection from value '${"string"==typeof at?at:JSON.stringify(at)}'`)}case"number":{let at=null;for(const Tt of this.args){if(at=Tt.evaluate(rt),null===at)return 0;const $t=Number(at);if(!isNaN($t))return $t}throw new Me(`Could not convert ${JSON.stringify(at)} to number.`)}case"formatted":return Ae.fromString(Te(this.args[0].evaluate(rt)));case"resolvedImage":return Pe.fromString(Te(this.args[0].evaluate(rt)));case"projectionDefinition":return this.args[0].evaluate(rt);default:return Te(this.args[0].evaluate(rt))}}eachChild(rt){this.args.forEach(rt)}outputDefined(){return this.args.every((rt=>rt.outputDefined()))}}const qc=["Unknown","Point","LineString","Polygon"];class je{constructor(){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null}id(){return this.feature&&"id"in this.feature?this.feature.id:null}geometryType(){return this.feature?"number"==typeof this.feature.type?qc[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}parseColor(rt){let at=this._parseColorCache[rt];return at||(at=this._parseColorCache[rt]=be.parse(rt)),at}}class Ne{constructor(rt,at,Tt=[],$t,qt=new Bt,Kt=[]){this.registry=rt,this.path=Tt,this.key=Tt.map((rt=>`[${rt}]`)).join(""),this.scope=qt,this.errors=Kt,this.expectedType=$t,this._isConstant=at}parse(rt,at,Tt,$t,qt={}){return at?this.concat(at,Tt,$t)._parse(rt,qt):this._parse(rt,qt)}_parse(rt,at){function r(rt,at,Tt){return"assert"===Tt?new Le(at,[rt]):"coerce"===Tt?new De(at,[rt]):rt}if(null!==rt&&"string"!=typeof rt&&"boolean"!=typeof rt&&"number"!=typeof rt||(rt=["literal",rt]),Array.isArray(rt)){if(0===rt.length)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const Tt=rt[0];if("string"!=typeof Tt)return this.error(`Expression name must be a string, but found ${typeof Tt} instead. If you wanted a literal array, use ["literal", [...]].`,0),null;const $t=this.registry[Tt];if($t){let Tt=$t.parse(rt,this);if(!Tt)return null;if(this.expectedType){const rt=this.expectedType,$t=Tt.type;if("string"!==rt.kind&&"number"!==rt.kind&&"boolean"!==rt.kind&&"object"!==rt.kind&&"array"!==rt.kind||"value"!==$t.kind)if("projectionDefinition"!==rt.kind||"string"!==$t.kind&&"array"!==$t.kind)if("color"!==rt.kind&&"formatted"!==rt.kind&&"resolvedImage"!==rt.kind||"value"!==$t.kind&&"string"!==$t.kind)if("padding"!==rt.kind||"value"!==$t.kind&&"number"!==$t.kind&&"array"!==$t.kind)if("variableAnchorOffsetCollection"!==rt.kind||"value"!==$t.kind&&"array"!==$t.kind){if(this.checkSubtype(rt,$t))return null}else Tt=r(Tt,rt,at.typeAnnotation||"coerce");else Tt=r(Tt,rt,at.typeAnnotation||"coerce");else Tt=r(Tt,rt,at.typeAnnotation||"coerce");else Tt=r(Tt,rt,at.typeAnnotation||"coerce");else Tt=r(Tt,rt,at.typeAnnotation||"assert")}if(!(Tt instanceof Fe)&&"resolvedImage"!==Tt.type.kind&&this._isConstant(Tt)){const at=new je;try{Tt=new Fe(Tt.type,Tt.evaluate(at))}catch(rt){return this.error(rt.message),null}}return Tt}return this.error(`Unknown expression "${Tt}". If you wanted a literal array, use ["literal", [...]].`,0)}return this.error(void 0===rt?"'undefined' value invalid. Use null instead.":"object"==typeof rt?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof rt} instead.`)}concat(rt,at,Tt){const $t="number"==typeof rt?this.path.concat(rt):this.path,qt=Tt?this.scope.concat(Tt):this.scope;return new Ne(this.registry,this._isConstant,$t,at||null,qt,this.errors)}error(rt,...at){const Tt=`${this.key}${at.map((rt=>`[${rt}]`)).join("")}`;this.errors.push(new Ct(Tt,rt))}checkSubtype(rt,at){const Tt=Xt(rt,at);return Tt&&this.error(Tt),Tt}}class Ue{constructor(rt,at){this.type=at.type,this.bindings=[].concat(rt),this.result=at}evaluate(rt){return this.result.evaluate(rt)}eachChild(rt){for(const at of this.bindings)rt(at[1]);rt(this.result)}static parse(rt,at){if(rt.length<4)return at.error(`Expected at least 3 arguments, but found ${rt.length-1} instead.`);const Tt=[];for(let $t=1;$t<rt.length-1;$t+=2){const qt=rt[$t];if("string"!=typeof qt)return at.error(`Expected string, but found ${typeof qt} instead.`,$t);if(/[^a-zA-Z0-9_]/.test(qt))return at.error("Variable names must contain only alphanumeric characters or '_'.",$t);const Kt=at.parse(rt[$t+1],$t+1);if(!Kt)return null;Tt.push([qt,Kt])}const $t=at.parse(rt[rt.length-1],rt.length-1,at.expectedType,Tt);return $t?new Ue(Tt,$t):null}outputDefined(){return this.result.outputDefined()}}class qe{constructor(rt,at){this.type=at.type,this.name=rt,this.boundExpression=at}static parse(rt,at){if(2!==rt.length||"string"!=typeof rt[1])return at.error("'var' expression requires exactly one string literal argument.");const Tt=rt[1];return at.scope.has(Tt)?new qe(Tt,at.scope.get(Tt)):at.error(`Unknown variable "${Tt}". Make sure "${Tt}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(rt){return this.boundExpression.evaluate(rt)}eachChild(){}outputDefined(){return!1}}class Ge{constructor(rt,at,Tt){this.type=rt,this.index=at,this.input=Tt}static parse(rt,at){if(3!==rt.length)return at.error(`Expected 2 arguments, but found ${rt.length-1} instead.`);const Tt=at.parse(rt[1],1,jl),$t=at.parse(rt[2],2,Gt(at.expectedType||Hl));return Tt&&$t?new Ge($t.type.itemType,Tt,$t):null}evaluate(rt){const at=this.index.evaluate(rt),Tt=this.input.evaluate(rt);if(at<0)throw new Me(`Array index out of bounds: ${at} < 0.`);if(at>=Tt.length)throw new Me(`Array index out of bounds: ${at} > ${Tt.length-1}.`);if(at!==Math.floor(at))throw new Me(`Array index must be an integer, but found ${at} instead.`);return Tt[at]}eachChild(rt){rt(this.index),rt(this.input)}outputDefined(){return!1}}class Ze{constructor(rt,at){this.type=Zl,this.needle=rt,this.haystack=at}static parse(rt,at){if(3!==rt.length)return at.error(`Expected 2 arguments, but found ${rt.length-1} instead.`);const Tt=at.parse(rt[1],1,Hl),$t=at.parse(rt[2],2,Hl);return Tt&&$t?Ht(Tt.type,[Zl,Nl,jl,Ol,Hl])?new Ze(Tt,$t):at.error(`Expected first argument to be of type boolean, string, number or null, but found ${Zt(Tt.type)} instead`):null}evaluate(rt){const at=this.needle.evaluate(rt),Tt=this.haystack.evaluate(rt);if(!Tt)return!1;if(!Yt(at,["boolean","string","number","null"]))throw new Me(`Expected first argument to be of type boolean, string, number or null, but found ${Zt(Ee(at))} instead.`);if(!Yt(Tt,["string","array"]))throw new Me(`Expected second argument to be of type array or string, but found ${Zt(Ee(Tt))} instead.`);return Tt.indexOf(at)>=0}eachChild(rt){rt(this.needle),rt(this.haystack)}outputDefined(){return!0}}class Ke{constructor(rt,at,Tt){this.type=jl,this.needle=rt,this.haystack=at,this.fromIndex=Tt}static parse(rt,at){if(rt.length<=2||rt.length>=5)return at.error(`Expected 3 or 4 arguments, but found ${rt.length-1} instead.`);const Tt=at.parse(rt[1],1,Hl),$t=at.parse(rt[2],2,Hl);if(!Tt||!$t)return null;if(!Ht(Tt.type,[Zl,Nl,jl,Ol,Hl]))return at.error(`Expected first argument to be of type boolean, string, number or null, but found ${Zt(Tt.type)} instead`);if(4===rt.length){const qt=at.parse(rt[3],3,jl);return qt?new Ke(Tt,$t,qt):null}return new Ke(Tt,$t)}evaluate(rt){const at=this.needle.evaluate(rt),Tt=this.haystack.evaluate(rt);if(!Yt(at,["boolean","string","number","null"]))throw new Me(`Expected first argument to be of type boolean, string, number or null, but found ${Zt(Ee(at))} instead.`);let $t;if(this.fromIndex&&($t=this.fromIndex.evaluate(rt)),Yt(Tt,["string"])){const rt=Tt.indexOf(at,$t);return-1===rt?-1:[...Tt.slice(0,rt)].length}if(Yt(Tt,["array"]))return Tt.indexOf(at,$t);throw new Me(`Expected second argument to be of type array or string, but found ${Zt(Ee(Tt))} instead.`)}eachChild(rt){rt(this.needle),rt(this.haystack),this.fromIndex&&rt(this.fromIndex)}outputDefined(){return!1}}class Xe{constructor(rt,at,Tt,$t,qt,Kt){this.inputType=rt,this.type=at,this.input=Tt,this.cases=$t,this.outputs=qt,this.otherwise=Kt}static parse(rt,at){if(rt.length<5)return at.error(`Expected at least 4 arguments, but found only ${rt.length-1}.`);if(rt.length%2!=1)return at.error("Expected an even number of arguments.");let Tt,$t;at.expectedType&&"value"!==at.expectedType.kind&&($t=at.expectedType);const qt={},Kt=[];for(let ge=2;ge<rt.length-1;ge+=2){let Hr=rt[ge];const wn=rt[ge+1];Array.isArray(Hr)||(Hr=[Hr]);const es=at.concat(ge);if(0===Hr.length)return es.error("Expected at least one branch label.");for(const rt of Hr){if("number"!=typeof rt&&"string"!=typeof rt)return es.error("Branch labels must be numbers or strings.");if("number"==typeof rt&&Math.abs(rt)>Number.MAX_SAFE_INTEGER)return es.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if("number"==typeof rt&&Math.floor(rt)!==rt)return es.error("Numeric branch labels must be integer values.");if(Tt){if(es.checkSubtype(Tt,Ee(rt)))return null}else Tt=Ee(rt);if(void 0!==qt[String(rt)])return es.error("Branch labels must be unique.");qt[String(rt)]=Kt.length}const ss=at.parse(wn,ge,$t);if(!ss)return null;$t=$t||ss.type,Kt.push(ss)}const ge=at.parse(rt[1],1,Hl);if(!ge)return null;const Hr=at.parse(rt[rt.length-1],rt.length-1,$t);return Hr?"value"!==ge.type.kind&&at.concat(1).checkSubtype(Tt,ge.type)?null:new Xe(Tt,$t,ge,qt,Kt,Hr):null}evaluate(rt){const at=this.input.evaluate(rt);return(Ee(at)===this.inputType&&this.outputs[this.cases[at]]||this.otherwise).evaluate(rt)}eachChild(rt){rt(this.input),this.outputs.forEach(rt),rt(this.otherwise)}outputDefined(){return this.outputs.every((rt=>rt.outputDefined()))&&this.otherwise.outputDefined()}}class He{constructor(rt,at,Tt){this.type=rt,this.branches=at,this.otherwise=Tt}static parse(rt,at){if(rt.length<4)return at.error(`Expected at least 3 arguments, but found only ${rt.length-1}.`);if(rt.length%2!=0)return at.error("Expected an odd number of arguments.");let Tt;at.expectedType&&"value"!==at.expectedType.kind&&(Tt=at.expectedType);const $t=[];for(let qt=1;qt<rt.length-1;qt+=2){const Kt=at.parse(rt[qt],qt,Zl);if(!Kt)return null;const ge=at.parse(rt[qt+1],qt+1,Tt);if(!ge)return null;$t.push([Kt,ge]),Tt=Tt||ge.type}const qt=at.parse(rt[rt.length-1],rt.length-1,Tt);if(!qt)return null;if(!Tt)throw new Error("Can't infer output type");return new He(Tt,$t,qt)}evaluate(rt){for(const[at,Tt]of this.branches)if(at.evaluate(rt))return Tt.evaluate(rt);return this.otherwise.evaluate(rt)}eachChild(rt){for(const[at,Tt]of this.branches)rt(at),rt(Tt);rt(this.otherwise)}outputDefined(){return this.branches.every((([rt,at])=>at.outputDefined()))&&this.otherwise.outputDefined()}}class Ye{constructor(rt,at,Tt,$t){this.type=rt,this.input=at,this.beginIndex=Tt,this.endIndex=$t}static parse(rt,at){if(rt.length<=2||rt.length>=5)return at.error(`Expected 3 or 4 arguments, but found ${rt.length-1} instead.`);const Tt=at.parse(rt[1],1,Hl),$t=at.parse(rt[2],2,jl);if(!Tt||!$t)return null;if(!Ht(Tt.type,[Gt(Hl),Nl,Hl]))return at.error(`Expected first argument to be of type array or string, but found ${Zt(Tt.type)} instead`);if(4===rt.length){const qt=at.parse(rt[3],3,jl);return qt?new Ye(Tt.type,Tt,$t,qt):null}return new Ye(Tt.type,Tt,$t)}evaluate(rt){const at=this.input.evaluate(rt),Tt=this.beginIndex.evaluate(rt);let $t;if(this.endIndex&&($t=this.endIndex.evaluate(rt)),Yt(at,["string"]))return[...at].slice(Tt,$t).join("");if(Yt(at,["array"]))return at.slice(Tt,$t);throw new Me(`Expected first argument to be of type array or string, but found ${Zt(Ee(at))} instead.`)}eachChild(rt){rt(this.input),rt(this.beginIndex),this.endIndex&&rt(this.endIndex)}outputDefined(){return!1}}function Je(rt,at){const Tt=rt.length-1;let $t,qt,Kt=0,ge=Tt,Hr=0;for(;Kt<=ge;)if(Hr=Math.floor((Kt+ge)/2),$t=rt[Hr],qt=rt[Hr+1],$t<=at){if(Hr===Tt||at<qt)return Hr;Kt=Hr+1}else{if(!($t>at))throw new Me("Input is not a number.");ge=Hr-1}return 0}class We{constructor(rt,at,Tt){this.type=rt,this.input=at,this.labels=[],this.outputs=[];for(const[rt,at]of Tt)this.labels.push(rt),this.outputs.push(at)}static parse(rt,at){if(rt.length-1<4)return at.error(`Expected at least 4 arguments, but found only ${rt.length-1}.`);if((rt.length-1)%2!=0)return at.error("Expected an even number of arguments.");const Tt=at.parse(rt[1],1,jl);if(!Tt)return null;const $t=[];let qt=null;at.expectedType&&"value"!==at.expectedType.kind&&(qt=at.expectedType);for(let Tt=1;Tt<rt.length;Tt+=2){const Kt=1===Tt?-1/0:rt[Tt],ge=rt[Tt+1],Hr=Tt,wn=Tt+1;if("number"!=typeof Kt)return at.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',Hr);if($t.length&&$t[$t.length-1][0]>=Kt)return at.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',Hr);const es=at.parse(ge,wn,qt);if(!es)return null;qt=qt||es.type,$t.push([Kt,es])}return new We(qt,Tt,$t)}evaluate(rt){const at=this.labels,Tt=this.outputs;if(1===at.length)return Tt[0].evaluate(rt);const $t=this.input.evaluate(rt);if($t<=at[0])return Tt[0].evaluate(rt);const qt=at.length;return $t>=at[qt-1]?Tt[qt-1].evaluate(rt):Tt[Je(at,$t)].evaluate(rt)}eachChild(rt){rt(this.input);for(const at of this.outputs)rt(at)}outputDefined(){return this.outputs.every((rt=>rt.outputDefined()))}}function Qe(rt){return rt&&rt.__esModule&&Object.prototype.hasOwnProperty.call(rt,"default")?rt.default:rt}var Wc,Hc,Yc=function(){if(Hc)return Wc;function t(at,Tt,$t,qt){(this||rt).cx=3*at,(this||rt).bx=3*($t-at)-(this||rt).cx,(this||rt).ax=1-(this||rt).cx-(this||rt).bx,(this||rt).cy=3*Tt,(this||rt).by=3*(qt-Tt)-(this||rt).cy,(this||rt).ay=1-(this||rt).cy-(this||rt).by,(this||rt).p1x=at,(this||rt).p1y=Tt,(this||rt).p2x=$t,(this||rt).p2y=qt}return Hc=1,Wc=t,t.prototype={sampleCurveX:function(at){return(((this||rt).ax*at+(this||rt).bx)*at+(this||rt).cx)*at},sampleCurveY:function(at){return(((this||rt).ay*at+(this||rt).by)*at+(this||rt).cy)*at},sampleCurveDerivativeX:function(at){return(3*(this||rt).ax*at+2*(this||rt).bx)*at+(this||rt).cx},solveCurveX:function(rt,at){if(void 0===at&&(at=1e-6),rt<0)return 0;if(rt>1)return 1;for(var Tt=rt,$t=0;$t<8;$t++){var qt=this.sampleCurveX(Tt)-rt;if(Math.abs(qt)<at)return Tt;var Kt=this.sampleCurveDerivativeX(Tt);if(Math.abs(Kt)<1e-6)break;Tt-=qt/Kt}var ge=0,Hr=1;for(Tt=rt,$t=0;$t<20&&(qt=this.sampleCurveX(Tt),!(Math.abs(qt-rt)<at));$t++)rt>qt?ge=Tt:Hr=Tt,Tt=.5*(Hr-ge)+ge;return Tt},solve:function(rt,at){return this.sampleCurveY(this.solveCurveX(rt,at))}},Wc}(),Ih=Qe(Yc);class ir{constructor(rt,at,Tt,$t,qt){this.type=rt,this.operator=at,this.interpolation=Tt,this.input=$t,this.labels=[],this.outputs=[];for(const[rt,at]of qt)this.labels.push(rt),this.outputs.push(at)}static interpolationFactor(rt,at,Tt,$t){let qt=0;if("exponential"===rt.name)qt=sr(at,rt.base,Tt,$t);else if("linear"===rt.name)qt=sr(at,1,Tt,$t);else if("cubic-bezier"===rt.name){const Kt=rt.controlPoints;qt=new Ih(Kt[0],Kt[1],Kt[2],Kt[3]).solve(sr(at,1,Tt,$t))}return qt}static parse(rt,at){let[Tt,$t,qt,...Kt]=rt;if(!Array.isArray($t)||0===$t.length)return at.error("Expected an interpolation type expression.",1);if("linear"===$t[0])$t={name:"linear"};else if("exponential"===$t[0]){const rt=$t[1];if("number"!=typeof rt)return at.error("Exponential interpolation requires a numeric base.",1,1);$t={name:"exponential",base:rt}}else{if("cubic-bezier"!==$t[0])return at.error(`Unknown interpolation type ${String($t[0])}`,1,0);{const rt=$t.slice(1);if(4!==rt.length||rt.some((rt=>"number"!=typeof rt||rt<0||rt>1)))return at.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);$t={name:"cubic-bezier",controlPoints:rt}}}if(rt.length-1<4)return at.error(`Expected at least 4 arguments, but found only ${rt.length-1}.`);if((rt.length-1)%2!=0)return at.error("Expected an even number of arguments.");if(qt=at.parse(qt,2,jl),!qt)return null;const ge=[];let Hr=null;"interpolate-hcl"===Tt||"interpolate-lab"===Tt?Hr=Ul:at.expectedType&&"value"!==at.expectedType.kind&&(Hr=at.expectedType);for(let rt=0;rt<Kt.length;rt+=2){const Tt=Kt[rt],$t=Kt[rt+1],qt=rt+3,wn=rt+4;if("number"!=typeof Tt)return at.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',qt);if(ge.length&&ge[ge.length-1][0]>=Tt)return at.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',qt);const es=at.parse($t,wn,Hr);if(!es)return null;Hr=Hr||es.type,ge.push([Tt,es])}return Jt(Hr,jl)||Jt(Hr,Gl)||Jt(Hr,Ul)||Jt(Hr,Yl)||Jt(Hr,tc)||Jt(Hr,Gt(jl))?new ir(Hr,Tt,$t,qt,ge):at.error(`Type ${Zt(Hr)} is not interpolatable.`)}evaluate(rt){const at=this.labels,Tt=this.outputs;if(1===at.length)return Tt[0].evaluate(rt);const $t=this.input.evaluate(rt);if($t<=at[0])return Tt[0].evaluate(rt);const qt=at.length;if($t>=at[qt-1])return Tt[qt-1].evaluate(rt);const Kt=Je(at,$t),ge=ir.interpolationFactor(this.interpolation,$t,at[Kt],at[Kt+1]),Hr=Tt[Kt].evaluate(rt),wn=Tt[Kt+1].evaluate(rt);switch(this.operator){case"interpolate":switch(this.type.kind){case"number":return xe(Hr,wn,ge);case"color":return be.interpolate(Hr,wn,ge);case"padding":return ke.interpolate(Hr,wn,ge);case"variableAnchorOffsetCollection":return ze.interpolate(Hr,wn,ge);case"array":return ve(Hr,wn,ge);case"projectionDefinition":return Ce.interpolate(Hr,wn,ge)}case"interpolate-hcl":return be.interpolate(Hr,wn,ge,"hcl");case"interpolate-lab":return be.interpolate(Hr,wn,ge,"lab")}}eachChild(rt){rt(this.input);for(const at of this.outputs)rt(at)}outputDefined(){return this.outputs.every((rt=>rt.outputDefined()))}}function sr(rt,at,Tt,$t){const qt=$t-Tt,Kt=rt-Tt;return 0===qt?0:1===at?Kt/qt:(Math.pow(at,Kt)-1)/(Math.pow(at,qt)-1)}const Dh={color:be.interpolate,number:xe,padding:ke.interpolate,variableAnchorOffsetCollection:ze.interpolate,array:ve};class or{constructor(rt,at){this.type=rt,this.args=at}static parse(rt,at){if(rt.length<2)return at.error("Expected at least one argument.");let Tt=null;const $t=at.expectedType;$t&&"value"!==$t.kind&&(Tt=$t);const qt=[];for(const $t of rt.slice(1)){const rt=at.parse($t,1+qt.length,Tt,void 0,{typeAnnotation:"omit"});if(!rt)return null;Tt=Tt||rt.type,qt.push(rt)}if(!Tt)throw new Error("No output type");const Kt=$t&&qt.some((rt=>Xt($t,rt.type)));return new or(Kt?Hl:Tt,qt)}evaluate(rt){let at,Tt=null,$t=0;for(const qt of this.args)if($t++,Tt=qt.evaluate(rt),Tt&&Tt instanceof Pe&&!Tt.available&&(at||(at=Tt.name),Tt=null,$t===this.args.length&&(Tt=at)),null!==Tt)break;return Tt}eachChild(rt){this.args.forEach(rt)}outputDefined(){return this.args.every((rt=>rt.outputDefined()))}}function lr(rt,at){return"=="===rt||"!="===rt?"boolean"===at.kind||"string"===at.kind||"number"===at.kind||"null"===at.kind||"value"===at.kind:"string"===at.kind||"number"===at.kind||"value"===at.kind}function ur(rt,at,Tt,$t){return 0===$t.compare(at,Tt)}function cr(rt,at,Tt){const $t="=="!==rt&&"!="!==rt;return class i{constructor(rt,at,Tt){this.type=Zl,this.lhs=rt,this.rhs=at,this.collator=Tt,this.hasUntypedArgument="value"===rt.type.kind||"value"===at.type.kind}static parse(rt,at){if(3!==rt.length&&4!==rt.length)return at.error("Expected two or three arguments.");const Tt=rt[0];let qt=at.parse(rt[1],1,Hl);if(!qt)return null;if(!lr(Tt,qt.type))return at.concat(1).error(`"${Tt}" comparisons are not supported for type '${Zt(qt.type)}'.`);let Kt=at.parse(rt[2],2,Hl);if(!Kt)return null;if(!lr(Tt,Kt.type))return at.concat(2).error(`"${Tt}" comparisons are not supported for type '${Zt(Kt.type)}'.`);if(qt.type.kind!==Kt.type.kind&&"value"!==qt.type.kind&&"value"!==Kt.type.kind)return at.error(`Cannot compare types '${Zt(qt.type)}' and '${Zt(Kt.type)}'.`);$t&&("value"===qt.type.kind&&"value"!==Kt.type.kind?qt=new Le(Kt.type,[qt]):"value"!==qt.type.kind&&"value"===Kt.type.kind&&(Kt=new Le(qt.type,[Kt])));let ge=null;if(4===rt.length){if("string"!==qt.type.kind&&"string"!==Kt.type.kind&&"value"!==qt.type.kind&&"value"!==Kt.type.kind)return at.error("Cannot use collator to compare non-string types.");if(ge=at.parse(rt[3],3,Xl),!ge)return null}return new i(qt,Kt,ge)}evaluate(qt){const Kt=this.lhs.evaluate(qt),ge=this.rhs.evaluate(qt);if($t&&this.hasUntypedArgument){const at=Ee(Kt),Tt=Ee(ge);if(at.kind!==Tt.kind||"string"!==at.kind&&"number"!==at.kind)throw new Me(`Expected arguments for "${rt}" to be (string, string) or (number, number), but found (${at.kind}, ${Tt.kind}) instead.`)}if(this.collator&&!$t&&this.hasUntypedArgument){const rt=Ee(Kt),Tt=Ee(ge);if("string"!==rt.kind||"string"!==Tt.kind)return at(qt,Kt,ge)}return this.collator?Tt(qt,Kt,ge,this.collator.evaluate(qt)):at(qt,Kt,ge)}eachChild(rt){rt(this.lhs),rt(this.rhs),this.collator&&rt(this.collator)}outputDefined(){return!0}}}const Rh=cr("==",(function(rt,at,Tt){return at===Tt}),ur),Oh=cr("!=",(function(rt,at,Tt){return at!==Tt}),(function(rt,at,Tt,$t){return!ur(0,at,Tt,$t)})),Xh=cr("<",(function(rt,at,Tt){return at<Tt}),(function(rt,at,Tt,$t){return $t.compare(at,Tt)<0})),eu=cr(">",(function(rt,at,Tt){return at>Tt}),(function(rt,at,Tt,$t){return $t.compare(at,Tt)>0})),ru=cr("<=",(function(rt,at,Tt){return at<=Tt}),(function(rt,at,Tt,$t){return $t.compare(at,Tt)<=0})),nu=cr(">=",(function(rt,at,Tt){return at>=Tt}),(function(rt,at,Tt,$t){return $t.compare(at,Tt)>=0}));class gr{constructor(rt,at,Tt){this.type=Xl,this.locale=Tt,this.caseSensitive=rt,this.diacriticSensitive=at}static parse(rt,at){if(2!==rt.length)return at.error("Expected one argument.");const Tt=rt[1];if("object"!=typeof Tt||Array.isArray(Tt))return at.error("Collator options argument must be an object.");const $t=at.parse(void 0!==Tt["case-sensitive"]&&Tt["case-sensitive"],1,Zl);if(!$t)return null;const qt=at.parse(void 0!==Tt["diacritic-sensitive"]&&Tt["diacritic-sensitive"],1,Zl);if(!qt)return null;let Kt=null;return Tt.locale&&(Kt=at.parse(Tt.locale,1,Nl),!Kt)?null:new gr($t,qt,Kt)}evaluate(rt){return new we(this.caseSensitive.evaluate(rt),this.diacriticSensitive.evaluate(rt),this.locale?this.locale.evaluate(rt):null)}eachChild(rt){rt(this.caseSensitive),rt(this.diacriticSensitive),this.locale&&rt(this.locale)}outputDefined(){return!1}}class xr{constructor(rt,at,Tt,$t,qt){this.type=Nl,this.number=rt,this.locale=at,this.currency=Tt,this.minFractionDigits=$t,this.maxFractionDigits=qt}static parse(rt,at){if(3!==rt.length)return at.error("Expected two arguments.");const Tt=at.parse(rt[1],1,jl);if(!Tt)return null;const $t=rt[2];if("object"!=typeof $t||Array.isArray($t))return at.error("NumberFormat options argument must be an object.");let qt=null;if($t.locale&&(qt=at.parse($t.locale,1,Nl),!qt))return null;let Kt=null;if($t.currency&&(Kt=at.parse($t.currency,1,Nl),!Kt))return null;let ge=null;if($t["min-fraction-digits"]&&(ge=at.parse($t["min-fraction-digits"],1,jl),!ge))return null;let Hr=null;return $t["max-fraction-digits"]&&(Hr=at.parse($t["max-fraction-digits"],1,jl),!Hr)?null:new xr(Tt,qt,Kt,ge,Hr)}evaluate(rt){return new Intl.NumberFormat(this.locale?this.locale.evaluate(rt):[],{style:this.currency?"currency":"decimal",currency:this.currency?this.currency.evaluate(rt):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(rt):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(rt):void 0}).format(this.number.evaluate(rt))}eachChild(rt){rt(this.number),this.locale&&rt(this.locale),this.currency&&rt(this.currency),this.minFractionDigits&&rt(this.minFractionDigits),this.maxFractionDigits&&rt(this.maxFractionDigits)}outputDefined(){return!1}}class vr{constructor(rt){this.type=Kl,this.sections=rt}static parse(rt,at){if(rt.length<2)return at.error("Expected at least one argument.");const Tt=rt[1];if(!Array.isArray(Tt)&&"object"==typeof Tt)return at.error("First argument must be an image or text section.");const $t=[];let qt=!1;for(let Tt=1;Tt<=rt.length-1;++Tt){const Kt=rt[Tt];if(qt&&"object"==typeof Kt&&!Array.isArray(Kt)){qt=!1;let rt=null;if(Kt["font-scale"]&&(rt=at.parse(Kt["font-scale"],1,jl),!rt))return null;let Tt=null;if(Kt["text-font"]&&(Tt=at.parse(Kt["text-font"],1,Gt(Nl)),!Tt))return null;let ge=null;if(Kt["text-color"]&&(ge=at.parse(Kt["text-color"],1,Ul),!ge))return null;let Hr=null;if(Kt["vertical-align"]){if("string"==typeof Kt["vertical-align"]&&!jc.includes(Kt["vertical-align"]))return at.error(`'vertical-align' must be one of: 'bottom', 'center', 'top' but found '${Kt["vertical-align"]}' instead.`);if(Hr=at.parse(Kt["vertical-align"],1,Nl),!Hr)return null}const wn=$t[$t.length-1];wn.scale=rt,wn.font=Tt,wn.textColor=ge,wn.verticalAlign=Hr}else{const Kt=at.parse(rt[Tt],1,Hl);if(!Kt)return null;const ge=Kt.type.kind;if("string"!==ge&&"value"!==ge&&"null"!==ge&&"resolvedImage"!==ge)return at.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");qt=!0,$t.push({content:Kt,scale:null,font:null,textColor:null,verticalAlign:null})}}return new vr($t)}evaluate(rt){return new Ae(this.sections.map((at=>{const Tt=at.content.evaluate(rt);return Ee(Tt)===Jl?new Se("",Tt,null,null,null,at.verticalAlign?at.verticalAlign.evaluate(rt):null):new Se(Te(Tt),null,at.scale?at.scale.evaluate(rt):null,at.font?at.font.evaluate(rt).join(","):null,at.textColor?at.textColor.evaluate(rt):null,at.verticalAlign?at.verticalAlign.evaluate(rt):null)})))}eachChild(rt){for(const at of this.sections)rt(at.content),at.scale&&rt(at.scale),at.font&&rt(at.font),at.textColor&&rt(at.textColor),at.verticalAlign&&rt(at.verticalAlign)}outputDefined(){return!1}}class br{constructor(rt){this.type=Jl,this.input=rt}static parse(rt,at){if(2!==rt.length)return at.error("Expected two arguments.");const Tt=at.parse(rt[1],1,Nl);return Tt?new br(Tt):at.error("No image name provided.")}evaluate(rt){const at=this.input.evaluate(rt),Tt=Pe.fromString(at);return Tt&&rt.availableImages&&(Tt.available=rt.availableImages.indexOf(at)>-1),Tt}eachChild(rt){rt(this.input)}outputDefined(){return!1}}class wr{constructor(rt){this.type=jl,this.input=rt}static parse(rt,at){if(2!==rt.length)return at.error(`Expected 1 argument, but found ${rt.length-1} instead.`);const Tt=at.parse(rt[1],1);return Tt?"array"!==Tt.type.kind&&"string"!==Tt.type.kind&&"value"!==Tt.type.kind?at.error(`Expected argument of type string or array, but found ${Zt(Tt.type)} instead.`):new wr(Tt):null}evaluate(rt){const at=this.input.evaluate(rt);if("string"==typeof at)return[...at].length;if(Array.isArray(at))return at.length;throw new Me(`Expected value to be of type string or array, but found ${Zt(Ee(at))} instead.`)}eachChild(rt){rt(this.input)}outputDefined(){return!1}}const cu=8192;function Sr(rt,at){const Tt=(180+rt[0])/360,$t=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+rt[1]*Math.PI/360)))/360,qt=Math.pow(2,at.z);return[Math.round(Tt*qt*cu),Math.round($t*qt*cu)]}function Ar(rt,at){const Tt=Math.pow(2,at.z);return[(qt=(rt[0]/cu+at.x)/Tt,360*qt-180),($t=(rt[1]/cu+at.y)/Tt,360/Math.PI*Math.atan(Math.exp((180-360*$t)*Math.PI/180))-90)];var $t,qt}function kr(rt,at){rt[0]=Math.min(rt[0],at[0]),rt[1]=Math.min(rt[1],at[1]),rt[2]=Math.max(rt[2],at[0]),rt[3]=Math.max(rt[3],at[1])}function Mr(rt,at){return!(rt[0]<=at[0]||rt[2]>=at[2]||rt[1]<=at[1]||rt[3]>=at[3])}function Ir(rt,at,Tt){const $t=rt[0]-at[0],qt=rt[1]-at[1],Kt=rt[0]-Tt[0],ge=rt[1]-Tt[1];return $t*ge-Kt*qt==0&&$t*Kt<=0&&qt*ge<=0}function zr(rt,at,Tt,$t){return 0!=(qt=[$t[0]-Tt[0],$t[1]-Tt[1]])[0]*(Kt=[at[0]-rt[0],at[1]-rt[1]])[1]-qt[1]*Kt[0]&&!(!Tr(rt,at,Tt,$t)||!Tr(Tt,$t,rt,at));var qt,Kt}function Pr(rt,at,Tt){for(const $t of Tt)for(let Tt=0;Tt<$t.length-1;++Tt)if(zr(rt,at,$t[Tt],$t[Tt+1]))return!0;return!1}function Cr(rt,at,Tt=!1){let $t=!1;for(const Hr of at)for(let at=0;at<Hr.length-1;at++){if(Ir(rt,Hr[at],Hr[at+1]))return Tt;(Kt=Hr[at])[1]>(qt=rt)[1]!=(ge=Hr[at+1])[1]>qt[1]&&qt[0]<(ge[0]-Kt[0])*(qt[1]-Kt[1])/(ge[1]-Kt[1])+Kt[0]&&($t=!$t)}var qt,Kt,ge;return $t}function Br(rt,at){for(const Tt of at)if(Cr(rt,Tt))return!0;return!1}function Vr(rt,at){for(const Tt of rt)if(!Cr(Tt,at))return!1;for(let Tt=0;Tt<rt.length-1;++Tt)if(Pr(rt[Tt],rt[Tt+1],at))return!1;return!0}function Er(rt,at){for(const Tt of at)if(Vr(rt,Tt))return!0;return!1}function Tr(rt,at,Tt,$t){const qt=$t[0]-Tt[0],Kt=$t[1]-Tt[1],ge=(rt[0]-Tt[0])*Kt-qt*(rt[1]-Tt[1]),Hr=(at[0]-Tt[0])*Kt-qt*(at[1]-Tt[1]);return ge>0&&Hr<0||ge<0&&Hr>0}function Fr(rt,at,Tt){const $t=[];for(let qt=0;qt<rt.length;qt++){const Kt=[];for(let $t=0;$t<rt[qt].length;$t++){const ge=Sr(rt[qt][$t],Tt);kr(at,ge),Kt.push(ge)}$t.push(Kt)}return $t}function $r(rt,at,Tt){const $t=[];for(let qt=0;qt<rt.length;qt++){const Kt=Fr(rt[qt],at,Tt);$t.push(Kt)}return $t}function Lr(rt,at,Tt,$t){if(rt[0]<Tt[0]||rt[0]>Tt[2]){const at=.5*$t;let qt=rt[0]-Tt[0]>at?-$t:Tt[0]-rt[0]>at?$t:0;0===qt&&(qt=rt[0]-Tt[2]>at?-$t:Tt[2]-rt[0]>at?$t:0),rt[0]+=qt}kr(at,rt)}function Or(rt,at,Tt,$t){const qt=Math.pow(2,$t.z)*cu,Kt=[$t.x*cu,$t.y*cu],ge=[];for(const $t of rt)for(const rt of $t){const $t=[rt.x+Kt[0],rt.y+Kt[1]];Lr($t,at,Tt,qt),ge.push($t)}return ge}function Dr(rt,at,Tt,$t){const qt=Math.pow(2,$t.z)*cu,Kt=[$t.x*cu,$t.y*cu],ge=[];for(const Tt of rt){const rt=[];for(const $t of Tt){const Tt=[$t.x+Kt[0],$t.y+Kt[1]];kr(at,Tt),rt.push(Tt)}ge.push(rt)}if(at[2]-at[0]<=qt/2){(Hr=at)[0]=Hr[1]=1/0,Hr[2]=Hr[3]=-1/0;for(const rt of ge)for(const $t of rt)Lr($t,at,Tt,qt)}var Hr;return ge}class Rr{constructor(rt,at){this.type=Zl,this.geojson=rt,this.geometries=at}static parse(rt,at){if(2!==rt.length)return at.error(`'within' expression requires exactly one argument, but found ${rt.length-1} instead.`);if(Ve(rt[1])){const at=rt[1];if("FeatureCollection"===at.type){const rt=[];for(const Tt of at.features){const{type:at,coordinates:$t}=Tt.geometry;"Polygon"===at&&rt.push($t),"MultiPolygon"===at&&rt.push(...$t)}if(rt.length)return new Rr(at,{type:"MultiPolygon",coordinates:rt})}else if("Feature"===at.type){const rt=at.geometry.type;if("Polygon"===rt||"MultiPolygon"===rt)return new Rr(at,at.geometry)}else if("Polygon"===at.type||"MultiPolygon"===at.type)return new Rr(at,at)}return at.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(rt){if(null!=rt.geometry()&&null!=rt.canonicalID()){if("Point"===rt.geometryType())return function(rt,at){const Tt=[1/0,1/0,-1/0,-1/0],$t=[1/0,1/0,-1/0,-1/0],qt=rt.canonicalID();if("Polygon"===at.type){const Kt=Fr(at.coordinates,$t,qt),ge=Or(rt.geometry(),Tt,$t,qt);if(!Mr(Tt,$t))return!1;for(const rt of ge)if(!Cr(rt,Kt))return!1}if("MultiPolygon"===at.type){const Kt=$r(at.coordinates,$t,qt),ge=Or(rt.geometry(),Tt,$t,qt);if(!Mr(Tt,$t))return!1;for(const rt of ge)if(!Br(rt,Kt))return!1}return!0}(rt,this.geometries);if("LineString"===rt.geometryType())return function(rt,at){const Tt=[1/0,1/0,-1/0,-1/0],$t=[1/0,1/0,-1/0,-1/0],qt=rt.canonicalID();if("Polygon"===at.type){const Kt=Fr(at.coordinates,$t,qt),ge=Dr(rt.geometry(),Tt,$t,qt);if(!Mr(Tt,$t))return!1;for(const rt of ge)if(!Vr(rt,Kt))return!1}if("MultiPolygon"===at.type){const Kt=$r(at.coordinates,$t,qt),ge=Dr(rt.geometry(),Tt,$t,qt);if(!Mr(Tt,$t))return!1;for(const rt of ge)if(!Er(rt,Kt))return!1}return!0}(rt,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}}let uu=class{constructor(rt=[],at=(rt,at)=>rt<at?-1:rt>at?1:0){if(this.data=rt,this.length=this.data.length,this.compare=at,this.length>0)for(let rt=(this.length>>1)-1;rt>=0;rt--)this._down(rt)}push(rt){this.data.push(rt),this._up(this.length++)}pop(){if(0===this.length)return;const rt=this.data[0],at=this.data.pop();return--this.length>0&&(this.data[0]=at,this._down(0)),rt}peek(){return this.data[0]}_up(rt){const{data:at,compare:Tt}=this,$t=at[rt];for(;rt>0;){const qt=rt-1>>1,Kt=at[qt];if(Tt($t,Kt)>=0)break;at[rt]=Kt,rt=qt}at[rt]=$t}_down(rt){const{data:at,compare:Tt}=this,$t=this.length>>1,qt=at[rt];for(;rt<$t;){let $t=1+(rt<<1);const Kt=$t+1;if(Kt<this.length&&Tt(at[Kt],at[$t])<0&&($t=Kt),Tt(at[$t],qt)>=0)break;at[rt]=at[$t],rt=$t}at[rt]=qt}};function Nr(rt,at,Tt=0,$t=rt.length-1,qt=qr){for(;$t>Tt;){if($t-Tt>600){const Kt=$t-Tt+1,ge=at-Tt+1,Hr=Math.log(Kt),wn=.5*Math.exp(2*Hr/3),es=.5*Math.sqrt(Hr*wn*(Kt-wn)/Kt)*(ge-Kt/2<0?-1:1);Nr(rt,at,Math.max(Tt,Math.floor(at-ge*wn/Kt+es)),Math.min($t,Math.floor(at+(Kt-ge)*wn/Kt+es)),qt)}const Kt=rt[at];let ge=Tt,Hr=$t;for(Ur(rt,Tt,at),qt(rt[$t],Kt)>0&&Ur(rt,Tt,$t);ge<Hr;){for(Ur(rt,ge,Hr),ge++,Hr--;qt(rt[ge],Kt)<0;)ge++;for(;qt(rt[Hr],Kt)>0;)Hr--}0===qt(rt[Tt],Kt)?Ur(rt,Tt,Hr):(Hr++,Ur(rt,Hr,$t)),Hr<=at&&(Tt=Hr+1),at<=Hr&&($t=Hr-1)}}function Ur(rt,at,Tt){const $t=rt[at];rt[at]=rt[Tt],rt[Tt]=$t}function qr(rt,at){return rt<at?-1:rt>at?1:0}function Gr(rt,at){if(rt.length<=1)return[rt];const Tt=[];let $t,qt;for(const at of rt){const rt=Kr(at);0!==rt&&(at.area=Math.abs(rt),void 0===qt&&(qt=rt<0),qt===rt<0?($t&&Tt.push($t),$t=[at]):$t.push(at))}if($t&&Tt.push($t),at>1)for(let rt=0;rt<Tt.length;rt++)Tt[rt].length<=at||(Nr(Tt[rt],at,1,Tt[rt].length-1,Zr),Tt[rt]=Tt[rt].slice(0,at));return Tt}function Zr(rt,at){return at.area-rt.area}function Kr(rt){let at=0;for(let Tt,$t,qt=0,Kt=rt.length,ge=Kt-1;qt<Kt;ge=qt++)Tt=rt[qt],$t=rt[ge],at+=($t.x-Tt.x)*(Tt.y+$t.y);return at}const du=1/298.257223563,mu=du*(2-du),_u=Math.PI/180;class Jr{constructor(rt){const at=6378.137*_u*1e3,Tt=Math.cos(rt*_u),$t=1/(1-mu*(1-Tt*Tt)),qt=Math.sqrt($t);this.kx=at*qt*Tt,this.ky=at*qt*$t*(1-mu)}distance(rt,at){const Tt=this.wrap(rt[0]-at[0])*this.kx,$t=(rt[1]-at[1])*this.ky;return Math.sqrt(Tt*Tt+$t*$t)}pointOnLine(rt,at){let Tt,$t,qt,Kt,ge=1/0;for(let Hr=0;Hr<rt.length-1;Hr++){let wn=rt[Hr][0],es=rt[Hr][1],ss=this.wrap(rt[Hr+1][0]-wn)*this.kx,os=(rt[Hr+1][1]-es)*this.ky,cs=0;0===ss&&0===os||(cs=(this.wrap(at[0]-wn)*this.kx*ss+(at[1]-es)*this.ky*os)/(ss*ss+os*os),cs>1?(wn=rt[Hr+1][0],es=rt[Hr+1][1]):cs>0&&(wn+=ss/this.kx*cs,es+=os/this.ky*cs)),ss=this.wrap(at[0]-wn)*this.kx,os=(at[1]-es)*this.ky;const ds=ss*ss+os*os;ds<ge&&(ge=ds,Tt=wn,$t=es,qt=Hr,Kt=cs)}return{point:[Tt,$t],index:qt,t:Math.max(0,Math.min(1,Kt))}}wrap(rt){for(;rt<-180;)rt+=360;for(;rt>180;)rt-=360;return rt}}function Wr(rt,at){return at[0]-rt[0]}function Qr(rt){return rt[1]-rt[0]+1}function tn(rt,at){return rt[1]>=rt[0]&&rt[1]<at}function en(rt,at){if(rt[0]>rt[1])return[null,null];const Tt=Qr(rt);if(at){if(2===Tt)return[rt,null];const at=Math.floor(Tt/2);return[[rt[0],rt[0]+at],[rt[0]+at,rt[1]]]}if(1===Tt)return[rt,null];const $t=Math.floor(Tt/2)-1;return[[rt[0],rt[0]+$t],[rt[0]+$t+1,rt[1]]]}function rn(rt,at){if(!tn(at,rt.length))return[1/0,1/0,-1/0,-1/0];const Tt=[1/0,1/0,-1/0,-1/0];for(let $t=at[0];$t<=at[1];++$t)kr(Tt,rt[$t]);return Tt}function nn(rt){const at=[1/0,1/0,-1/0,-1/0];for(const Tt of rt)for(const rt of Tt)kr(at,rt);return at}function sn(rt){return rt[0]!==-1/0&&rt[1]!==-1/0&&rt[2]!==1/0&&rt[3]!==1/0}function an(rt,at,Tt){if(!sn(rt)||!sn(at))return NaN;let $t=0,qt=0;return rt[2]<at[0]&&($t=at[0]-rt[2]),rt[0]>at[2]&&($t=rt[0]-at[2]),rt[1]>at[3]&&(qt=rt[1]-at[3]),rt[3]<at[1]&&(qt=at[1]-rt[3]),Tt.distance([0,0],[$t,qt])}function on(rt,at,Tt){const $t=Tt.pointOnLine(at,rt);return Tt.distance(rt,$t.point)}function ln(rt,at,Tt,$t,qt){const Kt=Math.min(on(rt,[Tt,$t],qt),on(at,[Tt,$t],qt)),ge=Math.min(on(Tt,[rt,at],qt),on($t,[rt,at],qt));return Math.min(Kt,ge)}function un(rt,at,Tt,$t,qt){if(!tn(at,rt.length)||!tn($t,Tt.length))return 1/0;let Kt=1/0;for(let ge=at[0];ge<at[1];++ge){const at=rt[ge],Hr=rt[ge+1];for(let rt=$t[0];rt<$t[1];++rt){const $t=Tt[rt],ge=Tt[rt+1];if(zr(at,Hr,$t,ge))return 0;Kt=Math.min(Kt,ln(at,Hr,$t,ge,qt))}}return Kt}function cn(rt,at,Tt,$t,qt){if(!tn(at,rt.length)||!tn($t,Tt.length))return NaN;let Kt=1/0;for(let ge=at[0];ge<=at[1];++ge)for(let at=$t[0];at<=$t[1];++at)if(Kt=Math.min(Kt,qt.distance(rt[ge],Tt[at])),0===Kt)return Kt;return Kt}function hn(rt,at,Tt){if(Cr(rt,at,!0))return 0;let $t=1/0;for(const qt of at){const at=qt[0],Kt=qt[qt.length-1];if(at!==Kt&&($t=Math.min($t,on(rt,[Kt,at],Tt)),0===$t))return $t;const ge=Tt.pointOnLine(qt,rt);if($t=Math.min($t,Tt.distance(rt,ge.point)),0===$t)return $t}return $t}function pn(rt,at,Tt,$t){if(!tn(at,rt.length))return NaN;for(let $t=at[0];$t<=at[1];++$t)if(Cr(rt[$t],Tt,!0))return 0;let qt=1/0;for(let Kt=at[0];Kt<at[1];++Kt){const at=rt[Kt],ge=rt[Kt+1];for(const rt of Tt)for(let Tt=0,Kt=rt.length,Hr=Kt-1;Tt<Kt;Hr=Tt++){const Kt=rt[Hr],wn=rt[Tt];if(zr(at,ge,Kt,wn))return 0;qt=Math.min(qt,ln(at,ge,Kt,wn,$t))}}return qt}function fn(rt,at){for(const Tt of rt)for(const rt of Tt)if(Cr(rt,at,!0))return!0;return!1}function dn(rt,at,Tt,$t=1/0){const qt=nn(rt),Kt=nn(at);if($t!==1/0&&an(qt,Kt,Tt)>=$t)return $t;if(Mr(qt,Kt)){if(fn(rt,at))return 0}else if(fn(at,rt))return 0;let ge=1/0;for(const $t of rt)for(let rt=0,qt=$t.length,Kt=qt-1;rt<qt;Kt=rt++){const qt=$t[Kt],Hr=$t[rt];for(const rt of at)for(let at=0,$t=rt.length,Kt=$t-1;at<$t;Kt=at++){const $t=rt[Kt],wn=rt[at];if(zr(qt,Hr,$t,wn))return 0;ge=Math.min(ge,ln(qt,Hr,$t,wn,Tt))}}return ge}function yn(rt,at,Tt,$t,qt,Kt){if(!Kt)return;const ge=an(rn($t,Kt),qt,Tt);ge<at&&rt.push([ge,Kt,[0,0]])}function mn(rt,at,Tt,$t,qt,Kt,ge){if(!Kt||!ge)return;const Hr=an(rn($t,Kt),rn(qt,ge),Tt);Hr<at&&rt.push([Hr,Kt,ge])}function gn(rt,at,Tt,$t,qt=1/0){let Kt=Math.min($t.distance(rt[0],Tt[0][0]),qt);if(0===Kt)return Kt;const ge=new uu([[0,[0,rt.length-1],[0,0]]],Wr),Hr=nn(Tt);for(;ge.length>0;){const qt=ge.pop();if(qt[0]>=Kt)continue;const wn=qt[1],es=at?50:100;if(Qr(wn)<=es){if(!tn(wn,rt.length))return NaN;if(at){const at=pn(rt,wn,Tt,$t);if(isNaN(at)||0===at)return at;Kt=Math.min(Kt,at)}else for(let at=wn[0];at<=wn[1];++at){const qt=hn(rt[at],Tt,$t);if(Kt=Math.min(Kt,qt),0===Kt)return 0}}else{const Tt=en(wn,at);yn(ge,Kt,$t,rt,Hr,Tt[0]),yn(ge,Kt,$t,rt,Hr,Tt[1])}}return Kt}function xn(rt,at,Tt,$t,qt,Kt=1/0){let ge=Math.min(Kt,qt.distance(rt[0],Tt[0]));if(0===ge)return ge;const Hr=new uu([[0,[0,rt.length-1],[0,Tt.length-1]]],Wr);for(;Hr.length>0;){const Kt=Hr.pop();if(Kt[0]>=ge)continue;const wn=Kt[1],es=Kt[2],ss=at?50:100,os=$t?50:100;if(Qr(wn)<=ss&&Qr(es)<=os){if(!tn(wn,rt.length)&&tn(es,Tt.length))return NaN;let Kt;if(at&&$t)Kt=un(rt,wn,Tt,es,qt),ge=Math.min(ge,Kt);else if(at&&!$t){const at=rt.slice(wn[0],wn[1]+1);for(let rt=es[0];rt<=es[1];++rt)if(Kt=on(Tt[rt],at,qt),ge=Math.min(ge,Kt),0===ge)return ge}else if(!at&&$t){const at=Tt.slice(es[0],es[1]+1);for(let Tt=wn[0];Tt<=wn[1];++Tt)if(Kt=on(rt[Tt],at,qt),ge=Math.min(ge,Kt),0===ge)return ge}else Kt=cn(rt,wn,Tt,es,qt),ge=Math.min(ge,Kt)}else{const Kt=en(wn,at),ss=en(es,$t);mn(Hr,ge,qt,rt,Tt,Kt[0],ss[0]),mn(Hr,ge,qt,rt,Tt,Kt[0],ss[1]),mn(Hr,ge,qt,rt,Tt,Kt[1],ss[0]),mn(Hr,ge,qt,rt,Tt,Kt[1],ss[1])}}return ge}function vn(rt){return"MultiPolygon"===rt.type?rt.coordinates.map((rt=>({type:"Polygon",coordinates:rt}))):"MultiLineString"===rt.type?rt.coordinates.map((rt=>({type:"LineString",coordinates:rt}))):"MultiPoint"===rt.type?rt.coordinates.map((rt=>({type:"Point",coordinates:rt}))):[rt]}class bn{constructor(rt,at){this.type=jl,this.geojson=rt,this.geometries=at}static parse(rt,at){if(2!==rt.length)return at.error(`'distance' expression requires exactly one argument, but found ${rt.length-1} instead.`);if(Ve(rt[1])){const at=rt[1];if("FeatureCollection"===at.type)return new bn(at,at.features.map((rt=>vn(rt.geometry))).flat());if("Feature"===at.type)return new bn(at,vn(at.geometry));if("type"in at&&"coordinates"in at)return new bn(at,vn(at))}return at.error("'distance' expression requires valid geojson object that contains polygon geometry type.")}evaluate(rt){if(null!=rt.geometry()&&null!=rt.canonicalID()){if("Point"===rt.geometryType())return function(rt,at){const Tt=rt.geometry(),$t=Tt.flat().map((at=>Ar([at.x,at.y],rt.canonical)));if(0===Tt.length)return NaN;const qt=new Jr($t[0][1]);let Kt=1/0;for(const rt of at){switch(rt.type){case"Point":Kt=Math.min(Kt,xn($t,!1,[rt.coordinates],!1,qt,Kt));break;case"LineString":Kt=Math.min(Kt,xn($t,!1,rt.coordinates,!0,qt,Kt));break;case"Polygon":Kt=Math.min(Kt,gn($t,!1,rt.coordinates,qt,Kt))}if(0===Kt)return Kt}return Kt}(rt,this.geometries);if("LineString"===rt.geometryType())return function(rt,at){const Tt=rt.geometry(),$t=Tt.flat().map((at=>Ar([at.x,at.y],rt.canonical)));if(0===Tt.length)return NaN;const qt=new Jr($t[0][1]);let Kt=1/0;for(const rt of at){switch(rt.type){case"Point":Kt=Math.min(Kt,xn($t,!0,[rt.coordinates],!1,qt,Kt));break;case"LineString":Kt=Math.min(Kt,xn($t,!0,rt.coordinates,!0,qt,Kt));break;case"Polygon":Kt=Math.min(Kt,gn($t,!0,rt.coordinates,qt,Kt))}if(0===Kt)return Kt}return Kt}(rt,this.geometries);if("Polygon"===rt.geometryType())return function(rt,at){const Tt=rt.geometry();if(0===Tt.length||0===Tt[0].length)return NaN;const $t=Gr(Tt,0).map((at=>at.map((at=>at.map((at=>Ar([at.x,at.y],rt.canonical))))))),qt=new Jr($t[0][0][0][1]);let Kt=1/0;for(const rt of at)for(const at of $t){switch(rt.type){case"Point":Kt=Math.min(Kt,gn([rt.coordinates],!1,at,qt,Kt));break;case"LineString":Kt=Math.min(Kt,gn(rt.coordinates,!0,at,qt,Kt));break;case"Polygon":Kt=Math.min(Kt,dn(at,rt.coordinates,qt,Kt))}if(0===Kt)return Kt}return Kt}(rt,this.geometries)}return NaN}eachChild(){}outputDefined(){return!0}}const gu={"==":Rh,"!=":Oh,">":eu,"<":Xh,">=":nu,"<=":ru,array:Le,at:Ge,boolean:Le,case:He,coalesce:or,collator:gr,format:vr,image:br,in:Ze,"index-of":Ke,interpolate:ir,"interpolate-hcl":ir,"interpolate-lab":ir,length:wr,let:Ue,literal:Fe,match:Xe,number:Le,"number-format":xr,object:Le,slice:Ye,step:We,string:Le,"to-boolean":De,"to-color":De,"to-number":De,"to-string":De,var:qe,within:Rr,distance:bn};class _n{constructor(rt,at,Tt,$t){this.name=rt,this.type=at,this._evaluate=Tt,this.args=$t}evaluate(rt){return this._evaluate(rt,this.args)}eachChild(rt){this.args.forEach(rt)}outputDefined(){return!1}static parse(rt,at){const Tt=rt[0],$t=_n.definitions[Tt];if(!$t)return at.error(`Unknown expression "${Tt}". If you wanted a literal array, use ["literal", [...]].`,0);const qt=Array.isArray($t)?$t[0]:$t.type,Kt=Array.isArray($t)?[[$t[1],$t[2]]]:$t.overloads,ge=Kt.filter((([at])=>!Array.isArray(at)||at.length===rt.length-1));let Hr=null;for(const[$t,Kt]of ge){Hr=new Ne(at.registry,In,at.path,null,at.scope);const ge=[];let wn=!1;for(let at=1;at<rt.length;at++){const Tt=rt[at],qt=Array.isArray($t)?$t[at-1]:$t.type,Kt=Hr.parse(Tt,1+ge.length,qt);if(!Kt){wn=!0;break}ge.push(Kt)}if(!wn)if(Array.isArray($t)&&$t.length!==ge.length)Hr.error(`Expected ${$t.length} arguments, but found ${ge.length} instead.`);else{for(let rt=0;rt<ge.length;rt++){const at=Array.isArray($t)?$t[rt]:$t.type,Tt=ge[rt];Hr.concat(rt+1).checkSubtype(at,Tt.type)}if(0===Hr.errors.length)return new _n(Tt,qt,Kt,ge)}}if(1===ge.length)at.errors.push(...Hr.errors);else{const Tt=(ge.length?ge:Kt).map((([rt])=>{return at=rt,Array.isArray(at)?`(${at.map(Zt).join(", ")})`:`(${Zt(at.type)}...)`;var at})).join(" | "),$t=[];for(let Tt=1;Tt<rt.length;Tt++){const qt=at.parse(rt[Tt],1+$t.length);if(!qt)return null;$t.push(Zt(qt.type))}at.error(`Expected arguments of type ${Tt}, but found (${$t.join(", ")}) instead.`)}return null}static register(rt,at){_n.definitions=at;for(const Tt in at)rt[Tt]=_n}}function Sn(rt,[at,Tt,$t,qt]){at=at.evaluate(rt),Tt=Tt.evaluate(rt),$t=$t.evaluate(rt);const Kt=qt?qt.evaluate(rt):1,ge=Be(at,Tt,$t,Kt);if(ge)throw new Me(ge);return new be(at/255,Tt/255,$t/255,Kt,!1)}function An(rt,at){return rt in at}function kn(rt,at){const Tt=at[rt];return void 0===Tt?null:Tt}function Mn(rt){return{type:rt}}function In(rt){if(rt instanceof qe)return In(rt.boundExpression);if(rt instanceof _n&&"error"===rt.name)return!1;if(rt instanceof gr)return!1;if(rt instanceof Rr)return!1;if(rt instanceof bn)return!1;const at=rt instanceof De||rt instanceof Le;let Tt=!0;return rt.eachChild((rt=>{Tt=at?Tt&&In(rt):Tt&&rt instanceof Fe})),!!Tt&&zn(rt)&&Cn(rt,["zoom","heatmap-density","line-progress","accumulated","is-supported-script"])}function zn(rt){if(rt instanceof _n){if("get"===rt.name&&1===rt.args.length)return!1;if("feature-state"===rt.name)return!1;if("has"===rt.name&&1===rt.args.length)return!1;if("properties"===rt.name||"geometry-type"===rt.name||"id"===rt.name)return!1;if(/^filter-/.test(rt.name))return!1}if(rt instanceof Rr)return!1;if(rt instanceof bn)return!1;let at=!0;return rt.eachChild((rt=>{at&&!zn(rt)&&(at=!1)})),at}function Pn(rt){if(rt instanceof _n&&"feature-state"===rt.name)return!1;let at=!0;return rt.eachChild((rt=>{at&&!Pn(rt)&&(at=!1)})),at}function Cn(rt,at){if(rt instanceof _n&&at.indexOf(rt.name)>=0)return!1;let Tt=!0;return rt.eachChild((rt=>{Tt&&!Cn(rt,at)&&(Tt=!1)})),Tt}function Bn(rt){return{result:"success",value:rt}}function Vn(rt){return{result:"error",value:rt}}function En(rt){return"data-driven"===rt["property-type"]||"cross-faded-data-driven"===rt["property-type"]}function Tn(rt){return!!rt.expression&&rt.expression.parameters.indexOf("zoom")>-1}function Fn(rt){return!!rt.expression&&rt.expression.interpolated}function $n(rt){return rt instanceof Number?"number":rt instanceof String?"string":rt instanceof Boolean?"boolean":Array.isArray(rt)?"array":null===rt?"null":typeof rt}function Ln(rt){return"object"==typeof rt&&null!==rt&&!Array.isArray(rt)}function On(rt){return rt}function Dn(rt,at){const Tt="color"===at.type,$t=rt.stops&&"object"==typeof rt.stops[0][0],qt=$t||!($t||void 0!==rt.property),Kt=rt.type||(Fn(at)?"exponential":"interval");if(Tt||"padding"===at.type){const $t=Tt?be.parse:ke.parse;(rt=Pt({},rt)).stops&&(rt.stops=rt.stops.map((rt=>[rt[0],$t(rt[1])]))),rt.default=$t(rt.default?rt.default:at.default)}if(rt.colorSpace&&"rgb"!==(ge=rt.colorSpace)&&"hcl"!==ge&&"lab"!==ge)throw new Error(`Unknown color space: "${rt.colorSpace}"`);var ge;let Hr,wn,es;if("exponential"===Kt)Hr=Un;else if("interval"===Kt)Hr=Nn;else if("categorical"===Kt){Hr=jn,wn=Object.create(null);for(const at of rt.stops)wn[at[0]]=at[1];es=typeof rt.stops[0][0]}else{if("identity"!==Kt)throw new Error(`Unknown function type "${Kt}"`);Hr=qn}if($t){const Tt={},$t=[];for(let at=0;at<rt.stops.length;at++){const qt=rt.stops[at],Kt=qt[0].zoom;void 0===Tt[Kt]&&(Tt[Kt]={zoom:Kt,type:rt.type,property:rt.property,default:rt.default,stops:[]},$t.push(Kt)),Tt[Kt].stops.push([qt[0].value,qt[1]])}const qt=[];for(const rt of $t)qt.push([Tt[rt].zoom,Dn(Tt[rt],at)]);const Kt={name:"linear"};return{kind:"composite",interpolationType:Kt,interpolationFactor:ir.interpolationFactor.bind(void 0,Kt),zoomStops:qt.map((rt=>rt[0])),evaluate:({zoom:Tt},$t)=>Un({stops:qt,base:rt.base},at,Tt).evaluate(Tt,$t)}}if(qt){const Tt="exponential"===Kt?{name:"exponential",base:void 0!==rt.base?rt.base:1}:null;return{kind:"camera",interpolationType:Tt,interpolationFactor:ir.interpolationFactor.bind(void 0,Tt),zoomStops:rt.stops.map((rt=>rt[0])),evaluate:({zoom:Tt})=>Hr(rt,at,Tt,wn,es)}}return{kind:"source",evaluate(Tt,$t){const qt=$t&&$t.properties?$t.properties[rt.property]:void 0;return void 0===qt?Rn(rt.default,at.default):Hr(rt,at,qt,wn,es)}}}function Rn(rt,at,Tt){return void 0!==rt?rt:void 0!==at?at:void 0!==Tt?Tt:void 0}function jn(rt,at,Tt,$t,qt){return Rn(typeof Tt===qt?$t[Tt]:void 0,rt.default,at.default)}function Nn(rt,at,Tt){if("number"!==$n(Tt))return Rn(rt.default,at.default);const $t=rt.stops.length;if(1===$t)return rt.stops[0][1];if(Tt<=rt.stops[0][0])return rt.stops[0][1];if(Tt>=rt.stops[$t-1][0])return rt.stops[$t-1][1];const qt=Je(rt.stops.map((rt=>rt[0])),Tt);return rt.stops[qt][1]}function Un(rt,at,Tt){const $t=void 0!==rt.base?rt.base:1;if("number"!==$n(Tt))return Rn(rt.default,at.default);const qt=rt.stops.length;if(1===qt)return rt.stops[0][1];if(Tt<=rt.stops[0][0])return rt.stops[0][1];if(Tt>=rt.stops[qt-1][0])return rt.stops[qt-1][1];const Kt=Je(rt.stops.map((rt=>rt[0])),Tt),ge=function(rt,at,Tt,$t){const qt=$t-Tt,Kt=rt-Tt;return 0===qt?0:1===at?Kt/qt:(Math.pow(at,Kt)-1)/(Math.pow(at,qt)-1)}(Tt,$t,rt.stops[Kt][0],rt.stops[Kt+1][0]),Hr=rt.stops[Kt][1],wn=rt.stops[Kt+1][1],es=Dh[at.type]||On;return"function"==typeof Hr.evaluate?{evaluate(...at){const Tt=Hr.evaluate.apply(void 0,at),$t=wn.evaluate.apply(void 0,at);if(void 0!==Tt&&void 0!==$t)return es(Tt,$t,ge,rt.colorSpace)}}:es(Hr,wn,ge,rt.colorSpace)}function qn(rt,at,Tt){switch(at.type){case"color":Tt=be.parse(Tt);break;case"formatted":Tt=Ae.fromString(Tt.toString());break;case"resolvedImage":Tt=Pe.fromString(Tt.toString());break;case"padding":Tt=ke.parse(Tt);break;default:$n(Tt)===at.type||"enum"===at.type&&at.values[Tt]||(Tt=void 0)}return Rn(Tt,rt.default,at.default)}_n.register(gu,{error:[{kind:"error"},[Nl],(rt,[at])=>{throw new Me(at.evaluate(rt))}],typeof:[Nl,[Hl],(rt,[at])=>Zt(Ee(at.evaluate(rt)))],"to-rgba":[Gt(jl,4),[Ul],(rt,[at])=>{const[Tt,$t,qt,Kt]=at.evaluate(rt).rgb;return[255*Tt,255*$t,255*qt,Kt]}],rgb:[Ul,[jl,jl,jl],Sn],rgba:[Ul,[jl,jl,jl,jl],Sn],has:{type:Zl,overloads:[[[Nl],(rt,[at])=>An(at.evaluate(rt),rt.properties())],[[Nl,ql],(rt,[at,Tt])=>An(at.evaluate(rt),Tt.evaluate(rt))]]},get:{type:Hl,overloads:[[[Nl],(rt,[at])=>kn(at.evaluate(rt),rt.properties())],[[Nl,ql],(rt,[at,Tt])=>kn(at.evaluate(rt),Tt.evaluate(rt))]]},"feature-state":[Hl,[Nl],(rt,[at])=>kn(at.evaluate(rt),rt.featureState||{})],properties:[ql,[],rt=>rt.properties()],"geometry-type":[Nl,[],rt=>rt.geometryType()],id:[Hl,[],rt=>rt.id()],zoom:[jl,[],rt=>rt.globals.zoom],"heatmap-density":[jl,[],rt=>rt.globals.heatmapDensity||0],"line-progress":[jl,[],rt=>rt.globals.lineProgress||0],accumulated:[Hl,[],rt=>void 0===rt.globals.accumulated?null:rt.globals.accumulated],"+":[jl,Mn(jl),(rt,at)=>{let Tt=0;for(const $t of at)Tt+=$t.evaluate(rt);return Tt}],"*":[jl,Mn(jl),(rt,at)=>{let Tt=1;for(const $t of at)Tt*=$t.evaluate(rt);return Tt}],"-":{type:jl,overloads:[[[jl,jl],(rt,[at,Tt])=>at.evaluate(rt)-Tt.evaluate(rt)],[[jl],(rt,[at])=>-at.evaluate(rt)]]},"/":[jl,[jl,jl],(rt,[at,Tt])=>at.evaluate(rt)/Tt.evaluate(rt)],"%":[jl,[jl,jl],(rt,[at,Tt])=>at.evaluate(rt)%Tt.evaluate(rt)],ln2:[jl,[],()=>Math.LN2],pi:[jl,[],()=>Math.PI],e:[jl,[],()=>Math.E],"^":[jl,[jl,jl],(rt,[at,Tt])=>Math.pow(at.evaluate(rt),Tt.evaluate(rt))],sqrt:[jl,[jl],(rt,[at])=>Math.sqrt(at.evaluate(rt))],log10:[jl,[jl],(rt,[at])=>Math.log(at.evaluate(rt))/Math.LN10],ln:[jl,[jl],(rt,[at])=>Math.log(at.evaluate(rt))],log2:[jl,[jl],(rt,[at])=>Math.log(at.evaluate(rt))/Math.LN2],sin:[jl,[jl],(rt,[at])=>Math.sin(at.evaluate(rt))],cos:[jl,[jl],(rt,[at])=>Math.cos(at.evaluate(rt))],tan:[jl,[jl],(rt,[at])=>Math.tan(at.evaluate(rt))],asin:[jl,[jl],(rt,[at])=>Math.asin(at.evaluate(rt))],acos:[jl,[jl],(rt,[at])=>Math.acos(at.evaluate(rt))],atan:[jl,[jl],(rt,[at])=>Math.atan(at.evaluate(rt))],min:[jl,Mn(jl),(rt,at)=>Math.min(...at.map((at=>at.evaluate(rt))))],max:[jl,Mn(jl),(rt,at)=>Math.max(...at.map((at=>at.evaluate(rt))))],abs:[jl,[jl],(rt,[at])=>Math.abs(at.evaluate(rt))],round:[jl,[jl],(rt,[at])=>{const Tt=at.evaluate(rt);return Tt<0?-Math.round(-Tt):Math.round(Tt)}],floor:[jl,[jl],(rt,[at])=>Math.floor(at.evaluate(rt))],ceil:[jl,[jl],(rt,[at])=>Math.ceil(at.evaluate(rt))],"filter-==":[Zl,[Nl,Hl],(rt,[at,Tt])=>rt.properties()[at.value]===Tt.value],"filter-id-==":[Zl,[Hl],(rt,[at])=>rt.id()===at.value],"filter-type-==":[Zl,[Nl],(rt,[at])=>rt.geometryType()===at.value],"filter-<":[Zl,[Nl,Hl],(rt,[at,Tt])=>{const $t=rt.properties()[at.value],qt=Tt.value;return typeof $t==typeof qt&&$t<qt}],"filter-id-<":[Zl,[Hl],(rt,[at])=>{const Tt=rt.id(),$t=at.value;return typeof Tt==typeof $t&&Tt<$t}],"filter->":[Zl,[Nl,Hl],(rt,[at,Tt])=>{const $t=rt.properties()[at.value],qt=Tt.value;return typeof $t==typeof qt&&$t>qt}],"filter-id->":[Zl,[Hl],(rt,[at])=>{const Tt=rt.id(),$t=at.value;return typeof Tt==typeof $t&&Tt>$t}],"filter-<=":[Zl,[Nl,Hl],(rt,[at,Tt])=>{const $t=rt.properties()[at.value],qt=Tt.value;return typeof $t==typeof qt&&$t<=qt}],"filter-id-<=":[Zl,[Hl],(rt,[at])=>{const Tt=rt.id(),$t=at.value;return typeof Tt==typeof $t&&Tt<=$t}],"filter->=":[Zl,[Nl,Hl],(rt,[at,Tt])=>{const $t=rt.properties()[at.value],qt=Tt.value;return typeof $t==typeof qt&&$t>=qt}],"filter-id->=":[Zl,[Hl],(rt,[at])=>{const Tt=rt.id(),$t=at.value;return typeof Tt==typeof $t&&Tt>=$t}],"filter-has":[Zl,[Hl],(rt,[at])=>at.value in rt.properties()],"filter-has-id":[Zl,[],rt=>null!==rt.id()&&void 0!==rt.id()],"filter-type-in":[Zl,[Gt(Nl)],(rt,[at])=>at.value.indexOf(rt.geometryType())>=0],"filter-id-in":[Zl,[Gt(Hl)],(rt,[at])=>at.value.indexOf(rt.id())>=0],"filter-in-small":[Zl,[Nl,Gt(Hl)],(rt,[at,Tt])=>Tt.value.indexOf(rt.properties()[at.value])>=0],"filter-in-large":[Zl,[Nl,Gt(Hl)],(rt,[at,Tt])=>function(rt,at,Tt,$t){for(;Tt<=$t;){const qt=Tt+$t>>1;if(at[qt]===rt)return!0;at[qt]>rt?$t=qt-1:Tt=qt+1}return!1}(rt.properties()[at.value],Tt.value,0,Tt.value.length-1)],all:{type:Zl,overloads:[[[Zl,Zl],(rt,[at,Tt])=>at.evaluate(rt)&&Tt.evaluate(rt)],[Mn(Zl),(rt,at)=>{for(const Tt of at)if(!Tt.evaluate(rt))return!1;return!0}]]},any:{type:Zl,overloads:[[[Zl,Zl],(rt,[at,Tt])=>at.evaluate(rt)||Tt.evaluate(rt)],[Mn(Zl),(rt,at)=>{for(const Tt of at)if(Tt.evaluate(rt))return!0;return!1}]]},"!":[Zl,[Zl],(rt,[at])=>!at.evaluate(rt)],"is-supported-script":[Zl,[Nl],(rt,[at])=>{const Tt=rt.globals&&rt.globals.isSupportedScript;return!Tt||Tt(at.evaluate(rt))}],upcase:[Nl,[Nl],(rt,[at])=>at.evaluate(rt).toUpperCase()],downcase:[Nl,[Nl],(rt,[at])=>at.evaluate(rt).toLowerCase()],concat:[Nl,Mn(Hl),(rt,at)=>at.map((at=>Te(at.evaluate(rt)))).join("")],"resolved-locale":[Nl,[Xl],(rt,[at])=>at.evaluate(rt).resolvedLocale()]});class Gn{constructor(rt,at){var Tt;this.expression=rt,this._warningHistory={},this._evaluator=new je,this._defaultValue=at?"color"===(Tt=at).type&&Ln(Tt.default)?new be(0,0,0,0):"color"===Tt.type?be.parse(Tt.default)||null:"padding"===Tt.type?ke.parse(Tt.default)||null:"variableAnchorOffsetCollection"===Tt.type?ze.parse(Tt.default)||null:"projectionDefinition"===Tt.type?Ce.parse(Tt.default)||null:void 0===Tt.default?null:Tt.default:null,this._enumValues=at&&"enum"===at.type?at.values:null}evaluateWithoutErrorHandling(rt,at,Tt,$t,qt,Kt){return this._evaluator.globals=rt,this._evaluator.feature=at,this._evaluator.featureState=Tt,this._evaluator.canonical=$t,this._evaluator.availableImages=qt||null,this._evaluator.formattedSection=Kt,this.expression.evaluate(this._evaluator)}evaluate(rt,at,Tt,$t,qt,Kt){this._evaluator.globals=rt,this._evaluator.feature=at||null,this._evaluator.featureState=Tt||null,this._evaluator.canonical=$t,this._evaluator.availableImages=qt||null,this._evaluator.formattedSection=Kt||null;try{const rt=this.expression.evaluate(this._evaluator);if(null==rt||"number"==typeof rt&&rt!=rt)return this._defaultValue;if(this._enumValues&&!(rt in this._enumValues))throw new Me(`Expected value to be one of ${Object.keys(this._enumValues).map((rt=>JSON.stringify(rt))).join(", ")}, but found ${JSON.stringify(rt)} instead.`);return rt}catch(rt){return this._warningHistory[rt.message]||(this._warningHistory[rt.message]=!0,"undefined"!=typeof console&&console.warn(rt.message)),this._defaultValue}}}function Zn(rt){return Array.isArray(rt)&&rt.length>0&&"string"==typeof rt[0]&&rt[0]in gu}function Kn(rt,at){const Tt=new Ne(gu,In,[],at?function(rt){const at={color:Ul,string:Nl,number:jl,enum:Nl,boolean:Zl,formatted:Kl,padding:Yl,projectionDefinition:Gl,resolvedImage:Jl,variableAnchorOffsetCollection:tc};return"array"===rt.type?Gt(at[rt.value]||Hl,rt.length):at[rt.type]}(at):void 0),$t=Tt.parse(rt,void 0,void 0,void 0,at&&"string"===at.type?{typeAnnotation:"coerce"}:void 0);return $t?Bn(new Gn($t,at)):Vn(Tt.errors)}class Xn{constructor(rt,at){this.kind=rt,this._styleExpression=at,this.isStateDependent="constant"!==rt&&!Pn(at.expression)}evaluateWithoutErrorHandling(rt,at,Tt,$t,qt,Kt){return this._styleExpression.evaluateWithoutErrorHandling(rt,at,Tt,$t,qt,Kt)}evaluate(rt,at,Tt,$t,qt,Kt){return this._styleExpression.evaluate(rt,at,Tt,$t,qt,Kt)}}class Hn{constructor(rt,at,Tt,$t){this.kind=rt,this.zoomStops=Tt,this._styleExpression=at,this.isStateDependent="camera"!==rt&&!Pn(at.expression),this.interpolationType=$t}evaluateWithoutErrorHandling(rt,at,Tt,$t,qt,Kt){return this._styleExpression.evaluateWithoutErrorHandling(rt,at,Tt,$t,qt,Kt)}evaluate(rt,at,Tt,$t,qt,Kt){return this._styleExpression.evaluate(rt,at,Tt,$t,qt,Kt)}interpolationFactor(rt,at,Tt){return this.interpolationType?ir.interpolationFactor(this.interpolationType,rt,at,Tt):0}}function Yn(rt,at){const Tt=Kn(rt,at);if("error"===Tt.result)return Tt;const $t=Tt.value.expression,qt=zn($t);if(!qt&&!En(at))return Vn([new Ct("","data expressions not supported")]);const Kt=Cn($t,["zoom"]);if(!Kt&&!Tn(at))return Vn([new Ct("","zoom expressions not supported")]);const ge=Wn($t);return ge||Kt?ge instanceof Ct?Vn([ge]):ge instanceof ir&&!Fn(at)?Vn([new Ct("",'"interpolate" expressions cannot be used with this property')]):Bn(ge?new Hn(qt?"camera":"composite",Tt.value,ge.labels,ge instanceof ir?ge.interpolation:void 0):new Xn(qt?"constant":"source",Tt.value)):Vn([new Ct("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.')])}class Jn{constructor(rt,at){this._parameters=rt,this._specification=at,Pt(this,Dn(this._parameters,this._specification))}static deserialize(rt){return new Jn(rt._parameters,rt._specification)}static serialize(rt){return{_parameters:rt._parameters,_specification:rt._specification}}}function Wn(rt){let at=null;if(rt instanceof Ue)at=Wn(rt.result);else if(rt instanceof or){for(const Tt of rt.args)if(at=Wn(Tt),at)break}else(rt instanceof We||rt instanceof ir)&&rt.input instanceof _n&&"zoom"===rt.input.name&&(at=rt);return at instanceof Ct||rt.eachChild((rt=>{const Tt=Wn(rt);Tt instanceof Ct?at=Tt:!at&&Tt?at=new Ct("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.'):at&&Tt&&at!==Tt&&(at=new Ct("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))})),at}function Qn(rt){if(!0===rt||!1===rt)return!0;if(!Array.isArray(rt)||0===rt.length)return!1;switch(rt[0]){case"has":return rt.length>=2&&"$id"!==rt[1]&&"$type"!==rt[1];case"in":return rt.length>=3&&("string"!=typeof rt[1]||Array.isArray(rt[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return 3!==rt.length||Array.isArray(rt[1])||Array.isArray(rt[2]);case"any":case"all":for(const at of rt.slice(1))if(!Qn(at)&&"boolean"!=typeof at)return!1;return!0;default:return!0}}const yu={type:"boolean",default:!1,transition:!1,"property-type":"data-driven",expression:{interpolated:!1,parameters:["zoom","feature"]}};function ei(rt){if(null==rt)return{filter:()=>!0,needGeometry:!1};Qn(rt)||(rt=ii(rt));const at=Kn(rt,yu);if("error"===at.result)throw new Error(at.value.map((rt=>`${rt.key}: ${rt.message}`)).join(", "));return{filter:(rt,Tt,$t)=>at.value.evaluate(rt,Tt,{},$t),needGeometry:ni(rt)}}function ri(rt,at){return rt<at?-1:rt>at?1:0}function ni(rt){if(!Array.isArray(rt))return!1;if("within"===rt[0]||"distance"===rt[0])return!0;for(let at=1;at<rt.length;at++)if(ni(rt[at]))return!0;return!1}function ii(rt){if(!rt)return!0;const at=rt[0];return rt.length<=1?"any"!==at:"=="===at?si(rt[1],rt[2],"=="):"!="===at?li(si(rt[1],rt[2],"==")):"<"===at||">"===at||"<="===at||">="===at?si(rt[1],rt[2],at):"any"===at?(Tt=rt.slice(1),["any"].concat(Tt.map(ii))):"all"===at?["all"].concat(rt.slice(1).map(ii)):"none"===at?["all"].concat(rt.slice(1).map(ii).map(li)):"in"===at?ai(rt[1],rt.slice(2)):"!in"===at?li(ai(rt[1],rt.slice(2))):"has"===at?oi(rt[1]):"!has"!==at||li(oi(rt[1]));var Tt}function si(rt,at,Tt){switch(rt){case"$type":return[`filter-type-${Tt}`,at];case"$id":return[`filter-id-${Tt}`,at];default:return[`filter-${Tt}`,rt,at]}}function ai(rt,at){if(0===at.length)return!1;switch(rt){case"$type":return["filter-type-in",["literal",at]];case"$id":return["filter-id-in",["literal",at]];default:return at.length>200&&!at.some((rt=>typeof rt!=typeof at[0]))?["filter-in-large",rt,["literal",at.sort(ri)]]:["filter-in-small",rt,["literal",at]]}}function oi(rt){switch(rt){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",rt]}}function li(rt){return["!",rt]}function ui(rt){const at=typeof rt;if("number"===at||"boolean"===at||"string"===at||null==rt)return JSON.stringify(rt);if(Array.isArray(rt)){let at="[";for(const Tt of rt)at+=`${ui(Tt)},`;return`${at}]`}const Tt=Object.keys(rt).sort();let $t="{";for(let at=0;at<Tt.length;at++)$t+=`${JSON.stringify(Tt[at])}:${ui(rt[Tt[at]])},`;return`${$t}}`}function ci(rt){let at="";for(const Tt of Ll)at+=`/${ui(rt[Tt])}`;return at}function hi(rt){const at=rt.value;return at?[new zt(rt.key,at,"constants have been deprecated as of v8")]:[]}function pi(rt){return rt instanceof Number||rt instanceof String||rt instanceof Boolean?rt.valueOf():rt}function fi(rt){if(Array.isArray(rt))return rt.map(fi);if(rt instanceof Object&&!(rt instanceof Number||rt instanceof String||rt instanceof Boolean)){const at={};for(const Tt in rt)at[Tt]=fi(rt[Tt]);return at}return pi(rt)}function di(rt){const at=rt.key,Tt=rt.value,$t=rt.valueSpec||{},qt=rt.objectElementValidators||{},Kt=rt.style,ge=rt.styleSpec,Hr=rt.validateSpec;let wn=[];const es=$n(Tt);if("object"!==es)return[new zt(at,Tt,`object expected, ${es} found`)];for(const rt in Tt){const es=rt.split(".")[0],ss=$t[es]||$t["*"];let os;if(qt[es])os=qt[es];else if($t[es])os=Hr;else if(qt["*"])os=qt["*"];else{if(!$t["*"]){wn.push(new zt(at,Tt[rt],`unknown property "${rt}"`));continue}os=Hr}wn=wn.concat(os({key:(at?`${at}.`:at)+rt,value:Tt[rt],valueSpec:ss,style:Kt,styleSpec:ge,object:Tt,objectKey:rt,validateSpec:Hr},Tt))}for(const rt in $t)qt[rt]||$t[rt].required&&void 0===$t[rt].default&&void 0===Tt[rt]&&wn.push(new zt(at,Tt,`missing required property "${rt}"`));return wn}function yi(rt){const at=rt.value,Tt=rt.valueSpec,$t=rt.style,qt=rt.styleSpec,Kt=rt.key,ge=rt.arrayElementValidator||rt.validateSpec;if("array"!==$n(at))return[new zt(Kt,at,`array expected, ${$n(at)} found`)];if(Tt.length&&at.length!==Tt.length)return[new zt(Kt,at,`array length ${Tt.length} expected, length ${at.length} found`)];if(Tt["min-length"]&&at.length<Tt["min-length"])return[new zt(Kt,at,`array length at least ${Tt["min-length"]} expected, length ${at.length} found`)];let Hr={type:Tt.value,values:Tt.values};qt.$version<7&&(Hr.function=Tt.function),"object"===$n(Tt.value)&&(Hr=Tt.value);let wn=[];for(let Tt=0;Tt<at.length;Tt++)wn=wn.concat(ge({array:at,arrayIndex:Tt,value:at[Tt],valueSpec:Hr,validateSpec:rt.validateSpec,style:$t,styleSpec:qt,key:`${Kt}[${Tt}]`}));return wn}function mi(rt){const at=rt.key,Tt=rt.value,$t=rt.valueSpec;let qt=$n(Tt);return"number"===qt&&Tt!=Tt&&(qt="NaN"),"number"!==qt?[new zt(at,Tt,`number expected, ${qt} found`)]:"minimum"in $t&&Tt<$t.minimum?[new zt(at,Tt,`${Tt} is less than the minimum value ${$t.minimum}`)]:"maximum"in $t&&Tt>$t.maximum?[new zt(at,Tt,`${Tt} is greater than the maximum value ${$t.maximum}`)]:[]}function gi(rt){const at=rt.valueSpec,Tt=pi(rt.value.type);let $t,qt,Kt,ge={};const Hr="categorical"!==Tt&&void 0===rt.value.property,wn=!Hr,es="array"===$n(rt.value.stops)&&"array"===$n(rt.value.stops[0])&&"object"===$n(rt.value.stops[0][0]),ss=di({key:rt.key,value:rt.value,valueSpec:rt.styleSpec.function,validateSpec:rt.validateSpec,style:rt.style,styleSpec:rt.styleSpec,objectElementValidators:{stops:function(rt){if("identity"===Tt)return[new zt(rt.key,rt.value,'identity function may not have a "stops" property')];let at=[];const $t=rt.value;return at=at.concat(yi({key:rt.key,value:$t,valueSpec:rt.valueSpec,validateSpec:rt.validateSpec,style:rt.style,styleSpec:rt.styleSpec,arrayElementValidator:h})),"array"===$n($t)&&0===$t.length&&at.push(new zt(rt.key,$t,"array must have at least one stop")),at},default:function(rt){return rt.validateSpec({key:rt.key,value:rt.value,valueSpec:at,validateSpec:rt.validateSpec,style:rt.style,styleSpec:rt.styleSpec})}}});return"identity"===Tt&&Hr&&ss.push(new zt(rt.key,rt.value,'missing required property "property"')),"identity"===Tt||rt.value.stops||ss.push(new zt(rt.key,rt.value,'missing required property "stops"')),"exponential"===Tt&&rt.valueSpec.expression&&!Fn(rt.valueSpec)&&ss.push(new zt(rt.key,rt.value,"exponential functions not supported")),rt.styleSpec.$version>=8&&(wn&&!En(rt.valueSpec)?ss.push(new zt(rt.key,rt.value,"property functions not supported")):Hr&&!Tn(rt.valueSpec)&&ss.push(new zt(rt.key,rt.value,"zoom functions not supported"))),"categorical"!==Tt&&!es||void 0!==rt.value.property||ss.push(new zt(rt.key,rt.value,'"property" property is required')),ss;function h(rt){let Tt=[];const $t=rt.value,Hr=rt.key;if("array"!==$n($t))return[new zt(Hr,$t,`array expected, ${$n($t)} found`)];if(2!==$t.length)return[new zt(Hr,$t,`array length 2 expected, length ${$t.length} found`)];if(es){if("object"!==$n($t[0]))return[new zt(Hr,$t,`object expected, ${$n($t[0])} found`)];if(void 0===$t[0].zoom)return[new zt(Hr,$t,"object stop key must have zoom")];if(void 0===$t[0].value)return[new zt(Hr,$t,"object stop key must have value")];if(Kt&&Kt>pi($t[0].zoom))return[new zt(Hr,$t[0].zoom,"stop zoom values must appear in ascending order")];pi($t[0].zoom)!==Kt&&(Kt=pi($t[0].zoom),qt=void 0,ge={}),Tt=Tt.concat(di({key:`${Hr}[0]`,value:$t[0],valueSpec:{zoom:{}},validateSpec:rt.validateSpec,style:rt.style,styleSpec:rt.styleSpec,objectElementValidators:{zoom:mi,value:p}}))}else Tt=Tt.concat(p({key:`${Hr}[0]`,value:$t[0],validateSpec:rt.validateSpec,style:rt.style,styleSpec:rt.styleSpec},$t));return Zn(fi($t[1]))?Tt.concat([new zt(`${Hr}[1]`,$t[1],"expressions are not allowed in function stops.")]):Tt.concat(rt.validateSpec({key:`${Hr}[1]`,value:$t[1],valueSpec:at,validateSpec:rt.validateSpec,style:rt.style,styleSpec:rt.styleSpec}))}function p(rt,Kt){const Hr=$n(rt.value),wn=pi(rt.value),es=null!==rt.value?rt.value:Kt;if($t){if(Hr!==$t)return[new zt(rt.key,es,`${Hr} stop domain type must match previous stop domain type ${$t}`)]}else $t=Hr;if("number"!==Hr&&"string"!==Hr&&"boolean"!==Hr)return[new zt(rt.key,es,"stop domain value must be a number, string, or boolean")];if("number"!==Hr&&"categorical"!==Tt){let $t=`number expected, ${Hr} found`;return En(at)&&void 0===Tt&&($t+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new zt(rt.key,es,$t)]}return"categorical"!==Tt||"number"!==Hr||isFinite(wn)&&Math.floor(wn)===wn?"categorical"!==Tt&&"number"===Hr&&void 0!==qt&&wn<qt?[new zt(rt.key,es,"stop domain values must appear in ascending order")]:(qt=wn,"categorical"===Tt&&wn in ge?[new zt(rt.key,es,"stop domain values must be unique")]:(ge[wn]=!0,[])):[new zt(rt.key,es,`integer expected, found ${wn}`)]}}function xi(rt){const at=("property"===rt.expressionContext?Yn:Kn)(fi(rt.value),rt.valueSpec);if("error"===at.result)return at.value.map((at=>new zt(`${rt.key}${at.key}`,rt.value,at.message)));const Tt=at.value.expression||at.value._styleExpression.expression;if("property"===rt.expressionContext&&"text-font"===rt.propertyKey&&!Tt.outputDefined())return[new zt(rt.key,rt.value,`Invalid data expression for "${rt.propertyKey}". Output values must be contained as literals within the expression.`)];if("property"===rt.expressionContext&&"layout"===rt.propertyType&&!Pn(Tt))return[new zt(rt.key,rt.value,'"feature-state" data expressions are not supported with layout properties.')];if("filter"===rt.expressionContext&&!Pn(Tt))return[new zt(rt.key,rt.value,'"feature-state" data expressions are not supported with filters.')];if(rt.expressionContext&&0===rt.expressionContext.indexOf("cluster")){if(!Cn(Tt,["zoom","feature-state"]))return[new zt(rt.key,rt.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if("cluster-initial"===rt.expressionContext&&!zn(Tt))return[new zt(rt.key,rt.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function vi(rt){const at=rt.key,Tt=rt.value,$t=rt.valueSpec,qt=[];return Array.isArray($t.values)?-1===$t.values.indexOf(pi(Tt))&&qt.push(new zt(at,Tt,`expected one of [${$t.values.join(", ")}], ${JSON.stringify(Tt)} found`)):-1===Object.keys($t.values).indexOf(pi(Tt))&&qt.push(new zt(at,Tt,`expected one of [${Object.keys($t.values).join(", ")}], ${JSON.stringify(Tt)} found`)),qt}function bi(rt){return Qn(fi(rt.value))?xi(Pt({},rt,{expressionContext:"filter",valueSpec:{value:"boolean"}})):wi(rt)}function wi(rt){const at=rt.value,Tt=rt.key;if("array"!==$n(at))return[new zt(Tt,at,`array expected, ${$n(at)} found`)];const $t=rt.styleSpec;let qt,Kt=[];if(at.length<1)return[new zt(Tt,at,"filter array must have at least 1 element")];switch(Kt=Kt.concat(vi({key:`${Tt}[0]`,value:at[0],valueSpec:$t.filter_operator,style:rt.style,styleSpec:rt.styleSpec})),pi(at[0])){case"<":case"<=":case">":case">=":at.length>=2&&"$type"===pi(at[1])&&Kt.push(new zt(Tt,at,`"$type" cannot be use with operator "${at[0]}"`));case"==":case"!=":3!==at.length&&Kt.push(new zt(Tt,at,`filter array for operator "${at[0]}" must have 3 elements`));case"in":case"!in":at.length>=2&&(qt=$n(at[1]),"string"!==qt&&Kt.push(new zt(`${Tt}[1]`,at[1],`string expected, ${qt} found`)));for(let ge=2;ge<at.length;ge++)qt=$n(at[ge]),"$type"===pi(at[1])?Kt=Kt.concat(vi({key:`${Tt}[${ge}]`,value:at[ge],valueSpec:$t.geometry_type,style:rt.style,styleSpec:rt.styleSpec})):"string"!==qt&&"number"!==qt&&"boolean"!==qt&&Kt.push(new zt(`${Tt}[${ge}]`,at[ge],`string, number, or boolean expected, ${qt} found`));break;case"any":case"all":case"none":for(let $t=1;$t<at.length;$t++)Kt=Kt.concat(wi({key:`${Tt}[${$t}]`,value:at[$t],style:rt.style,styleSpec:rt.styleSpec}));break;case"has":case"!has":qt=$n(at[1]),2!==at.length?Kt.push(new zt(Tt,at,`filter array for "${at[0]}" operator must have 2 elements`)):"string"!==qt&&Kt.push(new zt(`${Tt}[1]`,at[1],`string expected, ${qt} found`))}return Kt}function _i(rt,at){const Tt=rt.key,$t=rt.validateSpec,qt=rt.style,Kt=rt.styleSpec,ge=rt.value,Hr=rt.objectKey,wn=Kt[`${at}_${rt.layerType}`];if(!wn)return[];const es=Hr.match(/^(.*)-transition$/);if("paint"===at&&es&&wn[es[1]]&&wn[es[1]].transition)return $t({key:Tt,value:ge,valueSpec:Kt.transition,style:qt,styleSpec:Kt});const ss=rt.valueSpec||wn[Hr];if(!ss)return[new zt(Tt,ge,`unknown property "${Hr}"`)];let os;if("string"===$n(ge)&&En(ss)&&!ss.tokens&&(os=/^{([^}]+)}$/.exec(ge)))return[new zt(Tt,ge,`"${Hr}" does not support interpolation syntax\nUse an identity property function instead: \`{ "type": "identity", "property": ${JSON.stringify(os[1])} }\`.`)];const cs=[];return"symbol"===rt.layerType&&("text-field"===Hr&&qt&&!qt.glyphs&&cs.push(new zt(Tt,ge,'use of "text-field" requires a style "glyphs" property')),"text-font"===Hr&&Ln(fi(ge))&&"identity"===pi(ge.type)&&cs.push(new zt(Tt,ge,'"text-font" does not support identity functions'))),cs.concat($t({key:rt.key,value:ge,valueSpec:ss,style:qt,styleSpec:Kt,expressionContext:"property",propertyType:at,propertyKey:Hr}))}function Si(rt){return _i(rt,"paint")}function Ai(rt){return _i(rt,"layout")}function ki(rt){let at=[];const Tt=rt.value,$t=rt.key,qt=rt.style,Kt=rt.styleSpec;Tt.type||Tt.ref||at.push(new zt($t,Tt,'either "type" or "ref" is required'));let ge=pi(Tt.type);const Hr=pi(Tt.ref);if(Tt.id){const Kt=pi(Tt.id);for(let ge=0;ge<rt.arrayIndex;ge++){const rt=qt.layers[ge];pi(rt.id)===Kt&&at.push(new zt($t,Tt.id,`duplicate layer id "${Tt.id}", previously used at line ${rt.id.__line__}`))}}if("ref"in Tt){let rt;["type","source","source-layer","filter","layout"].forEach((rt=>{rt in Tt&&at.push(new zt($t,Tt[rt],`"${rt}" is prohibited for ref layers`))})),qt.layers.forEach((at=>{pi(at.id)===Hr&&(rt=at)})),rt?rt.ref?at.push(new zt($t,Tt.ref,"ref cannot reference another ref layer")):ge=pi(rt.type):at.push(new zt($t,Tt.ref,`ref layer "${Hr}" not found`))}else if("background"!==ge)if(Tt.source){const rt=qt.sources&&qt.sources[Tt.source],Kt=rt&&pi(rt.type);rt?"vector"===Kt&&"raster"===ge?at.push(new zt($t,Tt.source,`layer "${Tt.id}" requires a raster source`)):"raster-dem"!==Kt&&"hillshade"===ge?at.push(new zt($t,Tt.source,`layer "${Tt.id}" requires a raster-dem source`)):"raster"===Kt&&"raster"!==ge?at.push(new zt($t,Tt.source,`layer "${Tt.id}" requires a vector source`)):"vector"!==Kt||Tt["source-layer"]?"raster-dem"===Kt&&"hillshade"!==ge?at.push(new zt($t,Tt.source,"raster-dem source can only be used with layer type 'hillshade'.")):"line"!==ge||!Tt.paint||!Tt.paint["line-gradient"]||"geojson"===Kt&&rt.lineMetrics||at.push(new zt($t,Tt,`layer "${Tt.id}" specifies a line-gradient, which requires a GeoJSON source with \`lineMetrics\` enabled.`)):at.push(new zt($t,Tt,`layer "${Tt.id}" must specify a "source-layer"`)):at.push(new zt($t,Tt.source,`source "${Tt.source}" not found`))}else at.push(new zt($t,Tt,'missing required property "source"'));return at=at.concat(di({key:$t,value:Tt,valueSpec:Kt.layer,style:rt.style,styleSpec:rt.styleSpec,validateSpec:rt.validateSpec,objectElementValidators:{"*":()=>[],type:()=>rt.validateSpec({key:`${$t}.type`,value:Tt.type,valueSpec:Kt.layer.type,style:rt.style,styleSpec:rt.styleSpec,validateSpec:rt.validateSpec,object:Tt,objectKey:"type"}),filter:bi,layout:rt=>di({layer:Tt,key:rt.key,value:rt.value,style:rt.style,styleSpec:rt.styleSpec,validateSpec:rt.validateSpec,objectElementValidators:{"*":rt=>Ai(Pt({layerType:ge},rt))}}),paint:rt=>di({layer:Tt,key:rt.key,value:rt.value,style:rt.style,styleSpec:rt.styleSpec,validateSpec:rt.validateSpec,objectElementValidators:{"*":rt=>Si(Pt({layerType:ge},rt))}})}})),at}function Mi(rt){const at=rt.value,Tt=rt.key,$t=$n(at);return"string"!==$t?[new zt(Tt,at,`string expected, ${$t} found`)]:[]}const xu={promoteId:function({key:rt,value:at}){if("string"===$n(at))return Mi({key:rt,value:at});{const Tt=[];for(const $t in at)Tt.push(...Mi({key:`${rt}.${$t}`,value:at[$t]}));return Tt}}};function zi(rt){const at=rt.value,Tt=rt.key,$t=rt.styleSpec,qt=rt.style,Kt=rt.validateSpec;if(!at.type)return[new zt(Tt,at,'"type" is required')];const ge=pi(at.type);let Hr;switch(ge){case"vector":case"raster":return Hr=di({key:Tt,value:at,valueSpec:$t[`source_${ge.replace("-","_")}`],style:rt.style,styleSpec:$t,objectElementValidators:xu,validateSpec:Kt}),Hr;case"raster-dem":return Hr=function(rt){var at;const Tt=null!==(at=rt.sourceName)&&void 0!==at?at:"",$t=rt.value,qt=rt.styleSpec,Kt=qt.source_raster_dem,ge=rt.style;let Hr=[];const wn=$n($t);if(void 0===$t)return Hr;if("object"!==wn)return Hr.push(new zt("source_raster_dem",$t,`object expected, ${wn} found`)),Hr;const es="custom"===pi($t.encoding),ss=["redFactor","greenFactor","blueFactor","baseShift"],os=rt.value.encoding?`"${rt.value.encoding}"`:"Default";for(const at in $t)!es&&ss.includes(at)?Hr.push(new zt(at,$t[at],`In "${Tt}": "${at}" is only valid when "encoding" is set to "custom". ${os} encoding found`)):Kt[at]?Hr=Hr.concat(rt.validateSpec({key:at,value:$t[at],valueSpec:Kt[at],validateSpec:rt.validateSpec,style:ge,styleSpec:qt})):Hr.push(new zt(at,$t[at],`unknown property "${at}"`));return Hr}({sourceName:Tt,value:at,style:rt.style,styleSpec:$t,validateSpec:Kt}),Hr;case"geojson":if(Hr=di({key:Tt,value:at,valueSpec:$t.source_geojson,style:qt,styleSpec:$t,validateSpec:Kt,objectElementValidators:xu}),at.cluster)for(const rt in at.clusterProperties){const[$t,qt]=at.clusterProperties[rt],Kt="string"==typeof $t?[$t,["accumulated"],["get",rt]]:$t;Hr.push(...xi({key:`${Tt}.${rt}.map`,value:qt,expressionContext:"cluster-map"})),Hr.push(...xi({key:`${Tt}.${rt}.reduce`,value:Kt,expressionContext:"cluster-reduce"}))}return Hr;case"video":return di({key:Tt,value:at,valueSpec:$t.source_video,style:qt,validateSpec:Kt,styleSpec:$t});case"image":return di({key:Tt,value:at,valueSpec:$t.source_image,style:qt,validateSpec:Kt,styleSpec:$t});case"canvas":return[new zt(Tt,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return vi({key:`${Tt}.type`,value:at.type,valueSpec:{values:["vector","raster","raster-dem","geojson","video","image"]}})}}function Pi(rt){const at=rt.value,Tt=rt.styleSpec,$t=Tt.light,qt=rt.style;let Kt=[];const ge=$n(at);if(void 0===at)return Kt;if("object"!==ge)return Kt=Kt.concat([new zt("light",at,`object expected, ${ge} found`)]),Kt;for(const ge in at){const Hr=ge.match(/^(.*)-transition$/);Kt=Kt.concat(Hr&&$t[Hr[1]]&&$t[Hr[1]].transition?rt.validateSpec({key:ge,value:at[ge],valueSpec:Tt.transition,validateSpec:rt.validateSpec,style:qt,styleSpec:Tt}):$t[ge]?rt.validateSpec({key:ge,value:at[ge],valueSpec:$t[ge],validateSpec:rt.validateSpec,style:qt,styleSpec:Tt}):[new zt(ge,at[ge],`unknown property "${ge}"`)])}return Kt}function Ci(rt){const at=rt.value,Tt=rt.styleSpec,$t=Tt.sky,qt=rt.style,Kt=$n(at);if(void 0===at)return[];if("object"!==Kt)return[new zt("sky",at,`object expected, ${Kt} found`)];let ge=[];for(const Kt in at)ge=ge.concat($t[Kt]?rt.validateSpec({key:Kt,value:at[Kt],valueSpec:$t[Kt],style:qt,styleSpec:Tt}):[new zt(Kt,at[Kt],`unknown property "${Kt}"`)]);return ge}function Bi(rt){const at=rt.value,Tt=rt.styleSpec,$t=Tt.terrain,qt=rt.style;let Kt=[];const ge=$n(at);if(void 0===at)return Kt;if("object"!==ge)return Kt=Kt.concat([new zt("terrain",at,`object expected, ${ge} found`)]),Kt;for(const ge in at)Kt=Kt.concat($t[ge]?rt.validateSpec({key:ge,value:at[ge],valueSpec:$t[ge],validateSpec:rt.validateSpec,style:qt,styleSpec:Tt}):[new zt(ge,at[ge],`unknown property "${ge}"`)]);return Kt}function Vi(rt){let at=[];const Tt=rt.value,$t=rt.key;if(Array.isArray(Tt)){const qt=[],Kt=[];for(const ge in Tt)Tt[ge].id&&qt.includes(Tt[ge].id)&&at.push(new zt($t,Tt,`all the sprites' ids must be unique, but ${Tt[ge].id} is duplicated`)),qt.push(Tt[ge].id),Tt[ge].url&&Kt.includes(Tt[ge].url)&&at.push(new zt($t,Tt,`all the sprites' URLs must be unique, but ${Tt[ge].url} is duplicated`)),Kt.push(Tt[ge].url),at=at.concat(di({key:`${$t}[${ge}]`,value:Tt[ge],valueSpec:{id:{type:"string",required:!0},url:{type:"string",required:!0}},validateSpec:rt.validateSpec}));return at}return Mi({key:$t,value:Tt})}const vu={"*":()=>[],array:yi,boolean:function(rt){const at=rt.value,Tt=rt.key,$t=$n(at);return"boolean"!==$t?[new zt(Tt,at,`boolean expected, ${$t} found`)]:[]},number:mi,color:function(rt){const at=rt.key,Tt=rt.value,$t=$n(Tt);return"string"!==$t?[new zt(at,Tt,`color expected, ${$t} found`)]:be.parse(String(Tt))?[]:[new zt(at,Tt,`color expected, "${Tt}" found`)]},constants:hi,enum:vi,filter:bi,function:gi,layer:ki,object:di,source:zi,light:Pi,sky:Ci,terrain:Bi,projection:function(rt){const at=rt.value,Tt=rt.styleSpec,$t=Tt.projection,qt=rt.style,Kt=$n(at);if(void 0===at)return[];if("object"!==Kt)return[new zt("projection",at,`object expected, ${Kt} found`)];let ge=[];for(const Kt in at)ge=ge.concat($t[Kt]?rt.validateSpec({key:Kt,value:at[Kt],valueSpec:$t[Kt],style:qt,styleSpec:Tt}):[new zt(Kt,at[Kt],`unknown property "${Kt}"`)]);return ge},projectionDefinition:function(rt){const at=rt.key;let Tt=rt.value;Tt=Tt instanceof String?Tt.valueOf():Tt;const $t=$n(Tt);return"array"!==$t||function(rt){return Array.isArray(rt)&&3===rt.length&&"string"==typeof rt[0]&&"string"==typeof rt[1]&&"number"==typeof rt[2]}(Tt)||function(rt){return!!["interpolate","step","literal"].includes(rt[0])}(Tt)?["array","string"].includes($t)?[]:[new zt(at,Tt,`projection expected, invalid type "${$t}" found`)]:[new zt(at,Tt,`projection expected, invalid array ${JSON.stringify(Tt)} found`)]},string:Mi,formatted:function(rt){return 0===Mi(rt).length?[]:xi(rt)},resolvedImage:function(rt){return 0===Mi(rt).length?[]:xi(rt)},padding:function(rt){const at=rt.key,Tt=rt.value;if("array"===$n(Tt)){if(Tt.length<1||Tt.length>4)return[new zt(at,Tt,`padding requires 1 to 4 values; ${Tt.length} values found`)];const $t={type:"number"};let qt=[];for(let Kt=0;Kt<Tt.length;Kt++)qt=qt.concat(rt.validateSpec({key:`${at}[${Kt}]`,value:Tt[Kt],validateSpec:rt.validateSpec,valueSpec:$t}));return qt}return mi({key:at,value:Tt,valueSpec:{}})},variableAnchorOffsetCollection:function(rt){const at=rt.key,Tt=rt.value,$t=$n(Tt),qt=rt.styleSpec;if("array"!==$t||Tt.length<1||Tt.length%2!=0)return[new zt(at,Tt,"variableAnchorOffsetCollection requires a non-empty array of even length")];let Kt=[];for(let $t=0;$t<Tt.length;$t+=2)Kt=Kt.concat(vi({key:`${at}[${$t}]`,value:Tt[$t],valueSpec:qt.layout_symbol["text-anchor"]})),Kt=Kt.concat(yi({key:`${at}[${$t+1}]`,value:Tt[$t+1],valueSpec:{length:2,value:"number"},validateSpec:rt.validateSpec,style:rt.style,styleSpec:qt}));return Kt},sprite:Vi};function Ti(rt){const at=rt.value,Tt=rt.valueSpec,$t=rt.styleSpec;return rt.validateSpec=Ti,Tt.expression&&Ln(pi(at))?gi(rt):Tt.expression&&Zn(fi(at))?xi(rt):Tt.type&&vu[Tt.type]?vu[Tt.type](rt):di(Pt({},rt,{valueSpec:Tt.type?$t[Tt.type]:Tt}))}function Fi(rt){const at=rt.value,Tt=rt.key,$t=Mi(rt);return $t.length||(-1===at.indexOf("{fontstack}")&&$t.push(new zt(Tt,at,'"glyphs" url must include a "{fontstack}" token')),-1===at.indexOf("{range}")&&$t.push(new zt(Tt,at,'"glyphs" url must include a "{range}" token'))),$t}function $i(rt,at=Dl){let Tt=[];return Tt=Tt.concat(Ti({key:"",value:rt,valueSpec:at.$root,styleSpec:at,style:rt,validateSpec:Ti,objectElementValidators:{glyphs:Fi,"*":()=>[]}})),rt.constants&&(Tt=Tt.concat(hi({key:"constants",value:rt.constants}))),Oi(Tt)}function Li(rt){return function(at){return rt({...at,validateSpec:Ti})}}function Oi(rt){return[].concat(rt).sort(((rt,at)=>rt.line-at.line))}function Di(at){return function(...Tt){return Oi(at.apply(this||rt,Tt))}}$i.source=Di(Li(zi)),$i.sprite=Di(Li(Vi)),$i.glyphs=Di(Li(Fi)),$i.light=Di(Li(Pi)),$i.sky=Di(Li(Ci)),$i.terrain=Di(Li(Bi)),$i.layer=Di(Li(ki)),$i.filter=Di(Li(bi)),$i.paintProperty=Di(Li(Si)),$i.layoutProperty=Di(Li(Ai));const bu=$i,Pu=bu.light,Mu=bu.sky,Su=bu.paintProperty,Cu=bu.layoutProperty;function Gi(rt,at){let Tt=!1;if(at&&at.length)for(const $t of at)rt.fire(new dt(new Error($t.message))),Tt=!0;return Tt}class Zi{constructor(rt,at,Tt){const $t=this.cells=[];if(rt instanceof ArrayBuffer){this.arrayBuffer=rt;const qt=new Int32Array(this.arrayBuffer);rt=qt[0],this.d=(at=qt[1])+2*(Tt=qt[2]);for(let rt=0;rt<this.d*this.d;rt++){const at=qt[3+rt],Tt=qt[3+rt+1];$t.push(at===Tt?null:qt.subarray(at,Tt))}const Kt=qt[3+$t.length+1];this.keys=qt.subarray(qt[3+$t.length],Kt),this.bboxes=qt.subarray(Kt),this.insert=this._insertReadonly}else{this.d=at+2*Tt;for(let rt=0;rt<this.d*this.d;rt++)$t.push([]);this.keys=[],this.bboxes=[]}this.n=at,this.extent=rt,this.padding=Tt,this.scale=at/rt,this.uid=0;const qt=Tt/at*rt;this.min=-qt,this.max=rt+qt}insert(rt,at,Tt,$t,qt){this._forEachCell(at,Tt,$t,qt,this._insertCell,this.uid++,void 0,void 0),this.keys.push(rt),this.bboxes.push(at),this.bboxes.push(Tt),this.bboxes.push($t),this.bboxes.push(qt)}_insertReadonly(){throw new Error("Cannot insert into a GridIndex created from an ArrayBuffer.")}_insertCell(rt,at,Tt,$t,qt,Kt){this.cells[qt].push(Kt)}query(rt,at,Tt,$t,qt){const Kt=this.min,ge=this.max;if(rt<=Kt&&at<=Kt&&ge<=Tt&&ge<=$t&&!qt)return Array.prototype.slice.call(this.keys);{const Kt=[];return this._forEachCell(rt,at,Tt,$t,this._queryCell,Kt,{},qt),Kt}}_queryCell(rt,at,Tt,$t,qt,Kt,ge,Hr){const wn=this.cells[qt];if(null!==wn){const qt=this.keys,es=this.bboxes;for(let ss=0;ss<wn.length;ss++){const os=wn[ss];if(void 0===ge[os]){const wn=4*os;(Hr?Hr(es[wn+0],es[wn+1],es[wn+2],es[wn+3]):rt<=es[wn+2]&&at<=es[wn+3]&&Tt>=es[wn+0]&&$t>=es[wn+1])?(ge[os]=!0,Kt.push(qt[os])):ge[os]=!1}}}}_forEachCell(rt,at,Tt,$t,qt,Kt,ge,Hr){const wn=this._convertToCellCoord(rt),es=this._convertToCellCoord(at),ss=this._convertToCellCoord(Tt),os=this._convertToCellCoord($t);for(let cs=wn;cs<=ss;cs++)for(let wn=es;wn<=os;wn++){const es=this.d*wn+cs;if((!Hr||Hr(this._convertFromCellCoord(cs),this._convertFromCellCoord(wn),this._convertFromCellCoord(cs+1),this._convertFromCellCoord(wn+1)))&&qt.call(this,rt,at,Tt,$t,es,Kt,ge,Hr))return}}_convertFromCellCoord(rt){return(rt-this.padding)/this.scale}_convertToCellCoord(rt){return Math.max(0,Math.min(this.d-1,Math.floor(rt*this.scale)+this.padding))}toArrayBuffer(){if(this.arrayBuffer)return this.arrayBuffer;const rt=this.cells,at=3+this.cells.length+1+1;let Tt=0;for(let rt=0;rt<this.cells.length;rt++)Tt+=this.cells[rt].length;const $t=new Int32Array(at+Tt+this.keys.length+this.bboxes.length);$t[0]=this.extent,$t[1]=this.n,$t[2]=this.padding;let qt=at;for(let at=0;at<rt.length;at++){const Tt=rt[at];$t[3+at]=qt,$t.set(Tt,qt),qt+=Tt.length}return $t[3+rt.length]=qt,$t.set(this.keys,qt),qt+=this.keys.length,$t[3+rt.length+1]=qt,$t.set(this.bboxes,qt),qt+=this.bboxes.length,$t.buffer}static serialize(rt,at){const Tt=rt.toArrayBuffer();return at&&at.push(Tt),{buffer:Tt}}static deserialize(rt){return new Zi(rt.buffer)}}const Au={};function Xi(rt,at,Tt={}){if(Au[rt])throw new Error(`${rt} is already registered.`);Object.defineProperty(at,"_classRegistryKey",{value:rt,writeable:!1}),Au[rt]={klass:at,omit:Tt.omit||[],shallow:Tt.shallow||[]}}Xi("Object",Object),Xi("TransferableGridIndex",Zi),Xi("Color",be),Xi("Error",Error),Xi("AJAXError",ot),Xi("ResolvedImage",Pe),Xi("StylePropertyFunction",Jn),Xi("StyleExpression",Gn,{omit:["_evaluator"]}),Xi("ZoomDependentExpression",Hn),Xi("ZoomConstantExpression",Xn),Xi("CompoundExpression",_n,{omit:["_evaluate"]});for(const rt in gu)gu[rt]._classRegistryKey||Xi(`Expression_${rt}`,gu[rt]);function Hi(rt){return rt&&"undefined"!=typeof ArrayBuffer&&(rt instanceof ArrayBuffer||rt.constructor&&"ArrayBuffer"===rt.constructor.name)}function Yi(rt){return rt.$name||rt.constructor._classRegistryKey}function Ji(rt){return!function(rt){if(null===rt||"object"!=typeof rt)return!1;const at=Yi(rt);return!(!at||"Object"===at)}(rt)&&(null==rt||"boolean"==typeof rt||"number"==typeof rt||"string"==typeof rt||rt instanceof Boolean||rt instanceof Number||rt instanceof String||rt instanceof Date||rt instanceof RegExp||rt instanceof Blob||rt instanceof Error||Hi(rt)||K(rt)||ArrayBuffer.isView(rt)||rt instanceof ImageData)}function Wi(rt,at){if(Ji(rt))return(Hi(rt)||K(rt))&&at&&at.push(rt),ArrayBuffer.isView(rt)&&at&&at.push(rt.buffer),rt instanceof ImageData&&at&&at.push(rt.data.buffer),rt;if(Array.isArray(rt)){const Tt=[];for(const $t of rt)Tt.push(Wi($t,at));return Tt}if("object"!=typeof rt)throw new Error("can't serialize object of type "+typeof rt);const Tt=Yi(rt);if(!Tt)throw new Error(`can't serialize object of unregistered class ${rt.constructor.name}`);if(!Au[Tt])throw new Error(`${Tt} is not registered.`);const{klass:$t}=Au[Tt],qt=$t.serialize?$t.serialize(rt,at):{};if($t.serialize){if(at&&qt===at[at.length-1])throw new Error("statically serialized object won't survive transfer of $name property")}else{for(const $t in rt){if(!rt.hasOwnProperty($t))continue;if(Au[Tt].omit.indexOf($t)>=0)continue;const Kt=rt[$t];qt[$t]=Au[Tt].shallow.indexOf($t)>=0?Kt:Wi(Kt,at)}rt instanceof Error&&(qt.message=rt.message)}if(qt.$name)throw new Error("$name property is reserved for worker serialization logic.");return"Object"!==Tt&&(qt.$name=Tt),qt}function Qi(rt){if(Ji(rt))return rt;if(Array.isArray(rt))return rt.map(Qi);if("object"!=typeof rt)throw new Error("can't deserialize object of type "+typeof rt);const at=Yi(rt)||"Object";if(!Au[at])throw new Error(`can't deserialize unregistered class ${at}`);const{klass:Tt}=Au[at];if(!Tt)throw new Error(`can't deserialize unregistered class ${at}`);if(Tt.deserialize)return Tt.deserialize(rt);const $t=Object.create(Tt.prototype);for(const Tt of Object.keys(rt)){if("$name"===Tt)continue;const qt=rt[Tt];$t[Tt]=Au[at].shallow.indexOf(Tt)>=0?qt:Qi(qt)}return $t}class ts{constructor(){this.first=!0}update(rt,at){const Tt=Math.floor(rt);return this.first?(this.first=!1,this.lastIntegerZoom=Tt,this.lastIntegerZoomTime=0,this.lastZoom=rt,this.lastFloorZoom=Tt,!0):(this.lastFloorZoom>Tt?(this.lastIntegerZoom=Tt+1,this.lastIntegerZoomTime=at):this.lastFloorZoom<Tt&&(this.lastIntegerZoom=Tt,this.lastIntegerZoomTime=at),rt!==this.lastZoom&&(this.lastZoom=rt,this.lastFloorZoom=Tt,!0))}}const Eu={"Latin-1 Supplement":rt=>rt>=128&&rt<=255,"Hangul Jamo":rt=>rt>=4352&&rt<=4607,Khmer:rt=>rt>=6016&&rt<=6143,"General Punctuation":rt=>rt>=8192&&rt<=8303,"Letterlike Symbols":rt=>rt>=8448&&rt<=8527,"Number Forms":rt=>rt>=8528&&rt<=8591,"Miscellaneous Technical":rt=>rt>=8960&&rt<=9215,"Control Pictures":rt=>rt>=9216&&rt<=9279,"Optical Character Recognition":rt=>rt>=9280&&rt<=9311,"Enclosed Alphanumerics":rt=>rt>=9312&&rt<=9471,"Geometric Shapes":rt=>rt>=9632&&rt<=9727,"Miscellaneous Symbols":rt=>rt>=9728&&rt<=9983,"Miscellaneous Symbols and Arrows":rt=>rt>=11008&&rt<=11263,"Ideographic Description Characters":rt=>rt>=12272&&rt<=12287,"CJK Symbols and Punctuation":rt=>rt>=12288&&rt<=12351,Hiragana:rt=>rt>=12352&&rt<=12447,Katakana:rt=>rt>=12448&&rt<=12543,Kanbun:rt=>rt>=12688&&rt<=12703,"CJK Strokes":rt=>rt>=12736&&rt<=12783,"Enclosed CJK Letters and Months":rt=>rt>=12800&&rt<=13055,"CJK Compatibility":rt=>rt>=13056&&rt<=13311,"Yijing Hexagram Symbols":rt=>rt>=19904&&rt<=19967,"CJK Unified Ideographs":rt=>rt>=19968&&rt<=40959,"Hangul Syllables":rt=>rt>=44032&&rt<=55215,"Private Use Area":rt=>rt>=57344&&rt<=63743,"Vertical Forms":rt=>rt>=65040&&rt<=65055,"CJK Compatibility Forms":rt=>rt>=65072&&rt<=65103,"Small Form Variants":rt=>rt>=65104&&rt<=65135,"Halfwidth and Fullwidth Forms":rt=>rt>=65280&&rt<=65519};function rs(rt){for(const at of rt)if(ls(at.charCodeAt(0)))return!0;return!1}function ns(rt){for(const at of rt)if(!as(at.charCodeAt(0)))return!1;return!0}function is(rt){const at=rt.map((rt=>{try{return new RegExp(`\\p{sc=${rt}}`,"u").source}catch(rt){return null}})).filter((rt=>rt));return new RegExp(at.join("|"),"u")}const Du=is(["Arab","Dupl","Mong","Ougr","Syrc"]);function as(rt){return!Du.test(String.fromCodePoint(rt))}const Ru=is(["Bopo","Hani","Hira","Kana","Kits","Nshu","Tang","Yiii"]);function ls(rt){return!(746!==rt&&747!==rt&&(rt<4352||!(Eu["CJK Compatibility Forms"](rt)&&!(rt>=65097&&rt<=65103)||Eu["CJK Compatibility"](rt)||Eu["CJK Strokes"](rt)||!(!Eu["CJK Symbols and Punctuation"](rt)||rt>=12296&&rt<=12305||rt>=12308&&rt<=12319||12336===rt)||Eu["Enclosed CJK Letters and Months"](rt)||Eu["Ideographic Description Characters"](rt)||Eu.Kanbun(rt)||Eu.Katakana(rt)&&12540!==rt||!(!Eu["Halfwidth and Fullwidth Forms"](rt)||65288===rt||65289===rt||65293===rt||rt>=65306&&rt<=65310||65339===rt||65341===rt||65343===rt||rt>=65371&&rt<=65503||65507===rt||rt>=65512&&rt<=65519)||!(!Eu["Small Form Variants"](rt)||rt>=65112&&rt<=65118||rt>=65123&&rt<=65126)||Eu["Vertical Forms"](rt)||Eu["Yijing Hexagram Symbols"](rt)||/\p{sc=Cans}/u.test(String.fromCodePoint(rt))||/\p{sc=Hang}/u.test(String.fromCodePoint(rt))||Ru.test(String.fromCodePoint(rt)))))}function us(rt){return!(ls(rt)||function(rt){return!!(Eu["Latin-1 Supplement"](rt)&&(167===rt||169===rt||174===rt||177===rt||188===rt||189===rt||190===rt||215===rt||247===rt)||Eu["General Punctuation"](rt)&&(8214===rt||8224===rt||8225===rt||8240===rt||8241===rt||8251===rt||8252===rt||8258===rt||8263===rt||8264===rt||8265===rt||8273===rt)||Eu["Letterlike Symbols"](rt)||Eu["Number Forms"](rt)||Eu["Miscellaneous Technical"](rt)&&(rt>=8960&&rt<=8967||rt>=8972&&rt<=8991||rt>=8996&&rt<=9e3||9003===rt||rt>=9085&&rt<=9114||rt>=9150&&rt<=9165||9167===rt||rt>=9169&&rt<=9179||rt>=9186&&rt<=9215)||Eu["Control Pictures"](rt)&&9251!==rt||Eu["Optical Character Recognition"](rt)||Eu["Enclosed Alphanumerics"](rt)||Eu["Geometric Shapes"](rt)||Eu["Miscellaneous Symbols"](rt)&&!(rt>=9754&&rt<=9759)||Eu["Miscellaneous Symbols and Arrows"](rt)&&(rt>=11026&&rt<=11055||rt>=11088&&rt<=11097||rt>=11192&&rt<=11243)||Eu["CJK Symbols and Punctuation"](rt)||Eu.Katakana(rt)||Eu["Private Use Area"](rt)||Eu["CJK Compatibility Forms"](rt)||Eu["Small Form Variants"](rt)||Eu["Halfwidth and Fullwidth Forms"](rt)||8734===rt||8756===rt||8757===rt||rt>=9984&&rt<=10087||rt>=10102&&rt<=10131||65532===rt||65533===rt)}(rt))}const Lu=is(["Adlm","Arab","Armi","Avst","Chrs","Cprt","Egyp","Elym","Gara","Hatr","Hebr","Hung","Khar","Lydi","Mand","Mani","Mend","Merc","Mero","Narb","Nbat","Nkoo","Orkh","Palm","Phli","Phlp","Phnx","Prti","Rohg","Samr","Sarb","Sogo","Syrc","Thaa","Todr","Yezi"]);function hs(rt){return Lu.test(String.fromCodePoint(rt))}function ps(rt,at){return!(!at&&hs(rt)||rt>=2304&&rt<=3583||rt>=3840&&rt<=4255||Eu.Khmer(rt))}function fs(rt){for(const at of rt)if(hs(at.charCodeAt(0)))return!0;return!1}const Fu=new class{constructor(){this.TIMEOUT=5e3,this.applyArabicShaping=null,this.processBidirectionalText=null,this.processStyledBidirectionalText=null,this.pluginStatus="unavailable",this.pluginURL=null,this.loadScriptResolve=()=>{}}setState(rt){this.pluginStatus=rt.pluginStatus,this.pluginURL=rt.pluginURL}getState(){return{pluginStatus:this.pluginStatus,pluginURL:this.pluginURL}}setMethods(rt){if(Fu.isParsed())throw new Error("RTL text plugin already registered.");this.applyArabicShaping=rt.applyArabicShaping,this.processBidirectionalText=rt.processBidirectionalText,this.processStyledBidirectionalText=rt.processStyledBidirectionalText,this.loadScriptResolve()}isParsed(){return null!=this.applyArabicShaping&&null!=this.processBidirectionalText&&null!=this.processStyledBidirectionalText}getRTLTextPluginStatus(){return this.pluginStatus}syncState(rt,at){return e(this,void 0,void 0,(function*(){if(this.isParsed())return this.getState();if("loading"!==rt.pluginStatus)return this.setState(rt),rt;const Tt=rt.pluginURL,$t=new Promise((rt=>{this.loadScriptResolve=rt}));at(Tt);const qt=new Promise((rt=>setTimeout((()=>rt()),this.TIMEOUT)));if(yield Promise.race([$t,qt]),this.isParsed()){const rt={pluginStatus:"loaded",pluginURL:Tt};return this.setState(rt),rt}throw this.setState({pluginStatus:"error",pluginURL:""}),new Error(`RTL Text Plugin failed to import scripts from ${Tt}`)}))}};class ys{constructor(rt,at){this.zoom=rt,at?(this.now=at.now,this.fadeDuration=at.fadeDuration,this.zoomHistory=at.zoomHistory,this.transition=at.transition):(this.now=0,this.fadeDuration=0,this.zoomHistory=new ts,this.transition={})}isSupportedScript(rt){return function(rt,at){for(const Tt of rt)if(!ps(Tt.charCodeAt(0),at))return!1;return!0}(rt,"loaded"===Fu.getRTLTextPluginStatus())}crossFadingFactor(){return 0===this.fadeDuration?1:Math.min((this.now-this.zoomHistory.lastIntegerZoomTime)/this.fadeDuration,1)}getCrossfadeParameters(){const rt=this.zoom,at=rt-Math.floor(rt),Tt=this.crossFadingFactor();return rt>this.zoomHistory.lastIntegerZoom?{fromScale:2,toScale:1,t:at+(1-at)*Tt}:{fromScale:.5,toScale:1,t:1-(1-Tt)*at}}}class ms{constructor(rt,at){this.property=rt,this.value=at,this.expression=function(rt,at){if(Ln(rt))return new Jn(rt,at);if(Zn(rt)){const Tt=Yn(rt,at);if("error"===Tt.result)throw new Error(Tt.value.map((rt=>`${rt.key}: ${rt.message}`)).join(", "));return Tt.value}{let Tt=rt;return"color"===at.type&&"string"==typeof rt?Tt=be.parse(rt):"padding"!==at.type||"number"!=typeof rt&&!Array.isArray(rt)?"variableAnchorOffsetCollection"===at.type&&Array.isArray(rt)?Tt=ze.parse(rt):"projectionDefinition"===at.type&&"string"==typeof rt&&(Tt=Ce.parse(rt)):Tt=ke.parse(rt),{kind:"constant",evaluate:()=>Tt}}}(void 0===at?rt.specification.default:at,rt.specification)}isDataDriven(){return"source"===this.expression.kind||"composite"===this.expression.kind}possiblyEvaluate(rt,at,Tt){return this.property.possiblyEvaluate(this,rt,at,Tt)}}class gs{constructor(rt){this.property=rt,this.value=new ms(rt,void 0)}transitioned(rt,at){return new vs(this.property,this.value,at,L({},rt.transition,this.transition),rt.now)}untransitioned(){return new vs(this.property,this.value,null,{},0)}}class xs{constructor(rt){this._properties=rt,this._values=Object.create(rt.defaultTransitionablePropertyValues)}getValue(rt){return j(this._values[rt].value.value)}setValue(rt,at){Object.prototype.hasOwnProperty.call(this._values,rt)||(this._values[rt]=new gs(this._values[rt].property)),this._values[rt].value=new ms(this._values[rt].property,null===at?void 0:j(at))}getTransition(rt){return j(this._values[rt].transition)}setTransition(rt,at){Object.prototype.hasOwnProperty.call(this._values,rt)||(this._values[rt]=new gs(this._values[rt].property)),this._values[rt].transition=j(at)||void 0}serialize(){const rt={};for(const at of Object.keys(this._values)){const Tt=this.getValue(at);void 0!==Tt&&(rt[at]=Tt);const $t=this.getTransition(at);void 0!==$t&&(rt[`${at}-transition`]=$t)}return rt}transitioned(rt,at){const Tt=new bs(this._properties);for(const $t of Object.keys(this._values))Tt._values[$t]=this._values[$t].transitioned(rt,at._values[$t]);return Tt}untransitioned(){const rt=new bs(this._properties);for(const at of Object.keys(this._values))rt._values[at]=this._values[at].untransitioned();return rt}}class vs{constructor(rt,at,Tt,$t,qt){this.property=rt,this.value=at,this.begin=qt+$t.delay||0,this.end=this.begin+$t.duration||0,rt.specification.transition&&($t.delay||$t.duration)&&(this.prior=Tt)}possiblyEvaluate(rt,at,Tt){const $t=rt.now||0,qt=this.value.possiblyEvaluate(rt,at,Tt),Kt=this.prior;if(Kt){if($t>this.end)return this.prior=null,qt;if(this.value.isDataDriven())return this.prior=null,qt;if($t<this.begin)return Kt.possiblyEvaluate(rt,at,Tt);{const ge=($t-this.begin)/(this.end-this.begin);return this.property.interpolate(Kt.possiblyEvaluate(rt,at,Tt),qt,V(ge))}}return qt}}class bs{constructor(rt){this._properties=rt,this._values=Object.create(rt.defaultTransitioningPropertyValues)}possiblyEvaluate(rt,at,Tt){const $t=new Ss(this._properties);for(const qt of Object.keys(this._values))$t._values[qt]=this._values[qt].possiblyEvaluate(rt,at,Tt);return $t}hasTransition(){for(const rt of Object.keys(this._values))if(this._values[rt].prior)return!0;return!1}}class ws{constructor(rt){this._properties=rt,this._values=Object.create(rt.defaultPropertyValues)}hasValue(rt){return void 0!==this._values[rt].value}getValue(rt){return j(this._values[rt].value)}setValue(rt,at){this._values[rt]=new ms(this._values[rt].property,null===at?void 0:j(at))}serialize(){const rt={};for(const at of Object.keys(this._values)){const Tt=this.getValue(at);void 0!==Tt&&(rt[at]=Tt)}return rt}possiblyEvaluate(rt,at,Tt){const $t=new Ss(this._properties);for(const qt of Object.keys(this._values))$t._values[qt]=this._values[qt].possiblyEvaluate(rt,at,Tt);return $t}}class _s{constructor(rt,at,Tt){this.property=rt,this.value=at,this.parameters=Tt}isConstant(){return"constant"===this.value.kind}constantOr(rt){return"constant"===this.value.kind?this.value.value:rt}evaluate(rt,at,Tt,$t){return this.property.evaluate(this.value,this.parameters,rt,at,Tt,$t)}}class Ss{constructor(rt){this._properties=rt,this._values=Object.create(rt.defaultPossiblyEvaluatedValues)}get(rt){return this._values[rt]}}class As{constructor(rt){this.specification=rt}possiblyEvaluate(rt,at){if(rt.isDataDriven())throw new Error("Value should not be data driven");return rt.expression.evaluate(at)}interpolate(rt,at,Tt){const $t=Dh[this.specification.type];return $t?$t(rt,at,Tt):rt}}class ks{constructor(rt,at){this.specification=rt,this.overrides=at}possiblyEvaluate(rt,at,Tt,$t){return new _s(this,"constant"===rt.expression.kind||"camera"===rt.expression.kind?{kind:"constant",value:rt.expression.evaluate(at,null,{},Tt,$t)}:rt.expression,at)}interpolate(rt,at,Tt){if("constant"!==rt.value.kind||"constant"!==at.value.kind)return rt;if(void 0===rt.value.value||void 0===at.value.value)return new _s(this,{kind:"constant",value:void 0},rt.parameters);const $t=Dh[this.specification.type];if($t){const qt=$t(rt.value.value,at.value.value,Tt);return new _s(this,{kind:"constant",value:qt},rt.parameters)}return rt}evaluate(rt,at,Tt,$t,qt,Kt){return"constant"===rt.kind?rt.value:rt.evaluate(at,Tt,$t,qt,Kt)}}class Ms extends ks{possiblyEvaluate(rt,at,Tt,$t){if(void 0===rt.value)return new _s(this,{kind:"constant",value:void 0},at);if("constant"===rt.expression.kind){const qt=rt.expression.evaluate(at,null,{},Tt,$t),Kt="resolvedImage"===rt.property.specification.type&&"string"!=typeof qt?qt.name:qt,ge=this._calculate(Kt,Kt,Kt,at);return new _s(this,{kind:"constant",value:ge},at)}if("camera"===rt.expression.kind){const Tt=this._calculate(rt.expression.evaluate({zoom:at.zoom-1}),rt.expression.evaluate({zoom:at.zoom}),rt.expression.evaluate({zoom:at.zoom+1}),at);return new _s(this,{kind:"constant",value:Tt},at)}return new _s(this,rt.expression,at)}evaluate(rt,at,Tt,$t,qt,Kt){if("source"===rt.kind){const ge=rt.evaluate(at,Tt,$t,qt,Kt);return this._calculate(ge,ge,ge,at)}return"composite"===rt.kind?this._calculate(rt.evaluate({zoom:Math.floor(at.zoom)-1},Tt,$t),rt.evaluate({zoom:Math.floor(at.zoom)},Tt,$t),rt.evaluate({zoom:Math.floor(at.zoom)+1},Tt,$t),at):rt.value}_calculate(rt,at,Tt,$t){return $t.zoom>$t.zoomHistory.lastIntegerZoom?{from:rt,to:at}:{from:Tt,to:at}}interpolate(rt){return rt}}class Is{constructor(rt){this.specification=rt}possiblyEvaluate(rt,at,Tt,$t){if(void 0!==rt.value){if("constant"===rt.expression.kind){const qt=rt.expression.evaluate(at,null,{},Tt,$t);return this._calculate(qt,qt,qt,at)}return this._calculate(rt.expression.evaluate(new ys(Math.floor(at.zoom-1),at)),rt.expression.evaluate(new ys(Math.floor(at.zoom),at)),rt.expression.evaluate(new ys(Math.floor(at.zoom+1),at)),at)}}_calculate(rt,at,Tt,$t){return $t.zoom>$t.zoomHistory.lastIntegerZoom?{from:rt,to:at}:{from:Tt,to:at}}interpolate(rt){return rt}}class zs{constructor(rt){this.specification=rt}possiblyEvaluate(rt,at,Tt,$t){return!!rt.expression.evaluate(at,null,{},Tt,$t)}interpolate(){return!1}}class Ps{constructor(rt){this.properties=rt,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];for(const at in rt){const Tt=rt[at];Tt.specification.overridable&&this.overridableProperties.push(at);const $t=this.defaultPropertyValues[at]=new ms(Tt,void 0),qt=this.defaultTransitionablePropertyValues[at]=new gs(Tt);this.defaultTransitioningPropertyValues[at]=qt.untransitioned(),this.defaultPossiblyEvaluatedValues[at]=$t.possiblyEvaluate({})}}}Xi("DataDrivenProperty",ks),Xi("DataConstantProperty",As),Xi("CrossFadedDataDrivenProperty",Ms),Xi("CrossFadedProperty",Is),Xi("ColorRampProperty",zs);const Bu="-transition";class Bs extends yt{constructor(rt,at){if(super(),this.id=rt.id,this.type=rt.type,this._featureFilter={filter:()=>!0,needGeometry:!1},"custom"!==rt.type&&(this.metadata=rt.metadata,this.minzoom=rt.minzoom,this.maxzoom=rt.maxzoom,"background"!==rt.type&&(this.source=rt.source,this.sourceLayer=rt["source-layer"],this.filter=rt.filter),at.layout&&(this._unevaluatedLayout=new ws(at.layout)),at.paint)){this._transitionablePaint=new xs(at.paint);for(const at in rt.paint)this.setPaintProperty(at,rt.paint[at],{validate:!1});for(const at in rt.layout)this.setLayoutProperty(at,rt.layout[at],{validate:!1});this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new Ss(at.paint)}}getCrossfadeParameters(){return this._crossfadeParameters}getLayoutProperty(rt){return"visibility"===rt?this.visibility:this._unevaluatedLayout.getValue(rt)}setLayoutProperty(rt,at,Tt={}){null!=at&&this._validate(Cu,`layers.${this.id}.layout.${rt}`,rt,at,Tt)||("visibility"!==rt?this._unevaluatedLayout.setValue(rt,at):this.visibility=at)}getPaintProperty(rt){return rt.endsWith(Bu)?this._transitionablePaint.getTransition(rt.slice(0,-11)):this._transitionablePaint.getValue(rt)}setPaintProperty(rt,at,Tt={}){if(null!=at&&this._validate(Su,`layers.${this.id}.paint.${rt}`,rt,at,Tt))return!1;if(rt.endsWith(Bu))return this._transitionablePaint.setTransition(rt.slice(0,-11),at||void 0),!1;{const Tt=this._transitionablePaint._values[rt],$t="cross-faded-data-driven"===Tt.property.specification["property-type"],qt=Tt.value.isDataDriven(),Kt=Tt.value;this._transitionablePaint.setValue(rt,at),this._handleSpecialPaintPropertyUpdate(rt);const ge=this._transitionablePaint._values[rt].value;return ge.isDataDriven()||qt||$t||this._handleOverridablePaintPropertyUpdate(rt,Kt,ge)}}_handleSpecialPaintPropertyUpdate(rt){}_handleOverridablePaintPropertyUpdate(rt,at,Tt){return!1}isHidden(rt){return!!(this.minzoom&&rt<this.minzoom)||!!(this.maxzoom&&rt>=this.maxzoom)||"none"===this.visibility}updateTransitions(rt){this._transitioningPaint=this._transitionablePaint.transitioned(rt,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(rt,at){rt.getCrossfadeParameters&&(this._crossfadeParameters=rt.getCrossfadeParameters()),this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(rt,void 0,at)),this.paint=this._transitioningPaint.possiblyEvaluate(rt,void 0,at)}serialize(){const rt={id:this.id,type:this.type,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()};return this.visibility&&(rt.layout=rt.layout||{},rt.layout.visibility=this.visibility),R(rt,((rt,at)=>!(void 0===rt||"layout"===at&&!Object.keys(rt).length||"paint"===at&&!Object.keys(rt).length)))}_validate(rt,at,Tt,$t,qt={}){return(!qt||!1!==qt.validate)&&Gi(this,rt.call(bu,{key:at,layerType:this.type,objectKey:Tt,value:$t,styleSpec:Dl,style:{glyphs:!0,sprite:!0}}))}is3D(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}resize(){}isStateDependent(){for(const rt in this.paint._values){const at=this.paint.get(rt);if(at instanceof _s&&En(at.property.specification)&&("source"===at.value.kind||"composite"===at.value.kind)&&at.value.isStateDependent)return!0}return!1}}const Ou={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class Es{constructor(rt,at){this._structArray=rt,this._pos1=at*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class Ts{constructor(){this.isTransferred=!1,this.capacity=-1,this.resize(0)}static serialize(rt,at){return rt._trim(),at&&(rt.isTransferred=!0,at.push(rt.arrayBuffer)),{length:rt.length,arrayBuffer:rt.arrayBuffer}}static deserialize(rt){const at=Object.create(this.prototype);return at.arrayBuffer=rt.arrayBuffer,at.length=rt.length,at.capacity=rt.arrayBuffer.byteLength/at.bytesPerElement,at._refreshViews(),at}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(rt){this.reserve(rt),this.length=rt}reserve(rt){if(rt>this.capacity){this.capacity=Math.max(rt,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const at=this.uint8;this._refreshViews(),at&&this.uint8.set(at)}}_refreshViews(){throw new Error("_refreshViews() must be implemented by each concrete StructArray layout")}}function Fs(rt,at=1){let Tt=0,$t=0;return{members:rt.map((rt=>{const qt=Ou[rt.type].BYTES_PER_ELEMENT,Kt=Tt=$s(Tt,Math.max(at,qt)),ge=rt.components||1;return $t=Math.max($t,qt),Tt+=qt*ge,{name:rt.name,type:rt.type,components:ge,offset:Kt}})),size:$s(Tt,Math.max($t,at)),alignment:at}}function $s(rt,at){return Math.ceil(rt/at)*at}class Ls extends Ts{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(rt,at){const Tt=this.length;return this.resize(Tt+1),this.emplace(Tt,rt,at)}emplace(rt,at,Tt){const $t=2*rt;return this.int16[$t+0]=at,this.int16[$t+1]=Tt,rt}}Ls.prototype.bytesPerElement=4,Xi("StructArrayLayout2i4",Ls);class Os extends Ts{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(rt,at,Tt){const $t=this.length;return this.resize($t+1),this.emplace($t,rt,at,Tt)}emplace(rt,at,Tt,$t){const qt=3*rt;return this.int16[qt+0]=at,this.int16[qt+1]=Tt,this.int16[qt+2]=$t,rt}}Os.prototype.bytesPerElement=6,Xi("StructArrayLayout3i6",Os);class Ds extends Ts{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(rt,at,Tt,$t){const qt=this.length;return this.resize(qt+1),this.emplace(qt,rt,at,Tt,$t)}emplace(rt,at,Tt,$t,qt){const Kt=4*rt;return this.int16[Kt+0]=at,this.int16[Kt+1]=Tt,this.int16[Kt+2]=$t,this.int16[Kt+3]=qt,rt}}Ds.prototype.bytesPerElement=8,Xi("StructArrayLayout4i8",Ds);class Rs extends Ts{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(rt,at,Tt,$t,qt,Kt){const ge=this.length;return this.resize(ge+1),this.emplace(ge,rt,at,Tt,$t,qt,Kt)}emplace(rt,at,Tt,$t,qt,Kt,ge){const Hr=6*rt;return this.int16[Hr+0]=at,this.int16[Hr+1]=Tt,this.int16[Hr+2]=$t,this.int16[Hr+3]=qt,this.int16[Hr+4]=Kt,this.int16[Hr+5]=ge,rt}}Rs.prototype.bytesPerElement=12,Xi("StructArrayLayout2i4i12",Rs);class js extends Ts{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(rt,at,Tt,$t,qt,Kt){const ge=this.length;return this.resize(ge+1),this.emplace(ge,rt,at,Tt,$t,qt,Kt)}emplace(rt,at,Tt,$t,qt,Kt,ge){const Hr=4*rt,wn=8*rt;return this.int16[Hr+0]=at,this.int16[Hr+1]=Tt,this.uint8[wn+4]=$t,this.uint8[wn+5]=qt,this.uint8[wn+6]=Kt,this.uint8[wn+7]=ge,rt}}js.prototype.bytesPerElement=8,Xi("StructArrayLayout2i4ub8",js);class Ns extends Ts{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(rt,at){const Tt=this.length;return this.resize(Tt+1),this.emplace(Tt,rt,at)}emplace(rt,at,Tt){const $t=2*rt;return this.float32[$t+0]=at,this.float32[$t+1]=Tt,rt}}Ns.prototype.bytesPerElement=8,Xi("StructArrayLayout2f8",Ns);class Us extends Ts{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(rt,at,Tt,$t,qt,Kt,ge,Hr,wn,es){const ss=this.length;return this.resize(ss+1),this.emplace(ss,rt,at,Tt,$t,qt,Kt,ge,Hr,wn,es)}emplace(rt,at,Tt,$t,qt,Kt,ge,Hr,wn,es,ss){const os=10*rt;return this.uint16[os+0]=at,this.uint16[os+1]=Tt,this.uint16[os+2]=$t,this.uint16[os+3]=qt,this.uint16[os+4]=Kt,this.uint16[os+5]=ge,this.uint16[os+6]=Hr,this.uint16[os+7]=wn,this.uint16[os+8]=es,this.uint16[os+9]=ss,rt}}Us.prototype.bytesPerElement=20,Xi("StructArrayLayout10ui20",Us);class qs extends Ts{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(rt,at,Tt,$t,qt,Kt,ge,Hr,wn,es,ss,os){const cs=this.length;return this.resize(cs+1),this.emplace(cs,rt,at,Tt,$t,qt,Kt,ge,Hr,wn,es,ss,os)}emplace(rt,at,Tt,$t,qt,Kt,ge,Hr,wn,es,ss,os,cs){const ds=12*rt;return this.int16[ds+0]=at,this.int16[ds+1]=Tt,this.int16[ds+2]=$t,this.int16[ds+3]=qt,this.uint16[ds+4]=Kt,this.uint16[ds+5]=ge,this.uint16[ds+6]=Hr,this.uint16[ds+7]=wn,this.int16[ds+8]=es,this.int16[ds+9]=ss,this.int16[ds+10]=os,this.int16[ds+11]=cs,rt}}qs.prototype.bytesPerElement=24,Xi("StructArrayLayout4i4ui4i24",qs);class Gs extends Ts{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(rt,at,Tt){const $t=this.length;return this.resize($t+1),this.emplace($t,rt,at,Tt)}emplace(rt,at,Tt,$t){const qt=3*rt;return this.float32[qt+0]=at,this.float32[qt+1]=Tt,this.float32[qt+2]=$t,rt}}Gs.prototype.bytesPerElement=12,Xi("StructArrayLayout3f12",Gs);class Zs extends Ts{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(rt){const at=this.length;return this.resize(at+1),this.emplace(at,rt)}emplace(rt,at){return this.uint32[1*rt+0]=at,rt}}Zs.prototype.bytesPerElement=4,Xi("StructArrayLayout1ul4",Zs);class Ks extends Ts{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(rt,at,Tt,$t,qt,Kt,ge,Hr,wn){const es=this.length;return this.resize(es+1),this.emplace(es,rt,at,Tt,$t,qt,Kt,ge,Hr,wn)}emplace(rt,at,Tt,$t,qt,Kt,ge,Hr,wn,es){const ss=10*rt,os=5*rt;return this.int16[ss+0]=at,this.int16[ss+1]=Tt,this.int16[ss+2]=$t,this.int16[ss+3]=qt,this.int16[ss+4]=Kt,this.int16[ss+5]=ge,this.uint32[os+3]=Hr,this.uint16[ss+8]=wn,this.uint16[ss+9]=es,rt}}Ks.prototype.bytesPerElement=20,Xi("StructArrayLayout6i1ul2ui20",Ks);class Xs extends Ts{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(rt,at,Tt,$t,qt,Kt){const ge=this.length;return this.resize(ge+1),this.emplace(ge,rt,at,Tt,$t,qt,Kt)}emplace(rt,at,Tt,$t,qt,Kt,ge){const Hr=6*rt;return this.int16[Hr+0]=at,this.int16[Hr+1]=Tt,this.int16[Hr+2]=$t,this.int16[Hr+3]=qt,this.int16[Hr+4]=Kt,this.int16[Hr+5]=ge,rt}}Xs.prototype.bytesPerElement=12,Xi("StructArrayLayout2i2i2i12",Xs);class Hs extends Ts{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(rt,at,Tt,$t,qt){const Kt=this.length;return this.resize(Kt+1),this.emplace(Kt,rt,at,Tt,$t,qt)}emplace(rt,at,Tt,$t,qt,Kt){const ge=4*rt,Hr=8*rt;return this.float32[ge+0]=at,this.float32[ge+1]=Tt,this.float32[ge+2]=$t,this.int16[Hr+6]=qt,this.int16[Hr+7]=Kt,rt}}Hs.prototype.bytesPerElement=16,Xi("StructArrayLayout2f1f2i16",Hs);class Ys extends Ts{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(rt,at,Tt,$t,qt,Kt){const ge=this.length;return this.resize(ge+1),this.emplace(ge,rt,at,Tt,$t,qt,Kt)}emplace(rt,at,Tt,$t,qt,Kt,ge){const Hr=16*rt,wn=4*rt,es=8*rt;return this.uint8[Hr+0]=at,this.uint8[Hr+1]=Tt,this.float32[wn+1]=$t,this.float32[wn+2]=qt,this.int16[es+6]=Kt,this.int16[es+7]=ge,rt}}Ys.prototype.bytesPerElement=16,Xi("StructArrayLayout2ub2f2i16",Ys);class Js extends Ts{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(rt,at,Tt){const $t=this.length;return this.resize($t+1),this.emplace($t,rt,at,Tt)}emplace(rt,at,Tt,$t){const qt=3*rt;return this.uint16[qt+0]=at,this.uint16[qt+1]=Tt,this.uint16[qt+2]=$t,rt}}Js.prototype.bytesPerElement=6,Xi("StructArrayLayout3ui6",Js);class Ws extends Ts{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(rt,at,Tt,$t,qt,Kt,ge,Hr,wn,es,ss,os,cs,ds,Cs,Vs,Eo){const Do=this.length;return this.resize(Do+1),this.emplace(Do,rt,at,Tt,$t,qt,Kt,ge,Hr,wn,es,ss,os,cs,ds,Cs,Vs,Eo)}emplace(rt,at,Tt,$t,qt,Kt,ge,Hr,wn,es,ss,os,cs,ds,Cs,Vs,Eo,Do){const Ho=24*rt,Ea=12*rt,La=48*rt;return this.int16[Ho+0]=at,this.int16[Ho+1]=Tt,this.uint16[Ho+2]=$t,this.uint16[Ho+3]=qt,this.uint32[Ea+2]=Kt,this.uint32[Ea+3]=ge,this.uint32[Ea+4]=Hr,this.uint16[Ho+10]=wn,this.uint16[Ho+11]=es,this.uint16[Ho+12]=ss,this.float32[Ea+7]=os,this.float32[Ea+8]=cs,this.uint8[La+36]=ds,this.uint8[La+37]=Cs,this.uint8[La+38]=Vs,this.uint32[Ea+10]=Eo,this.int16[Ho+22]=Do,rt}}Ws.prototype.bytesPerElement=48,Xi("StructArrayLayout2i2ui3ul3ui2f3ub1ul1i48",Ws);class Qs extends Ts{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(rt,at,Tt,$t,qt,Kt,ge,Hr,wn,es,ss,os,cs,ds,Cs,Vs,Eo,Do,Ho,Ea,La,ja,Va,Na,qa,Qa,Pl,zl){const Dl=this.length;return this.resize(Dl+1),this.emplace(Dl,rt,at,Tt,$t,qt,Kt,ge,Hr,wn,es,ss,os,cs,ds,Cs,Vs,Eo,Do,Ho,Ea,La,ja,Va,Na,qa,Qa,Pl,zl)}emplace(rt,at,Tt,$t,qt,Kt,ge,Hr,wn,es,ss,os,cs,ds,Cs,Vs,Eo,Do,Ho,Ea,La,ja,Va,Na,qa,Qa,Pl,zl,Dl){const Ll=32*rt,Ol=16*rt;return this.int16[Ll+0]=at,this.int16[Ll+1]=Tt,this.int16[Ll+2]=$t,this.int16[Ll+3]=qt,this.int16[Ll+4]=Kt,this.int16[Ll+5]=ge,this.int16[Ll+6]=Hr,this.int16[Ll+7]=wn,this.uint16[Ll+8]=es,this.uint16[Ll+9]=ss,this.uint16[Ll+10]=os,this.uint16[Ll+11]=cs,this.uint16[Ll+12]=ds,this.uint16[Ll+13]=Cs,this.uint16[Ll+14]=Vs,this.uint16[Ll+15]=Eo,this.uint16[Ll+16]=Do,this.uint16[Ll+17]=Ho,this.uint16[Ll+18]=Ea,this.uint16[Ll+19]=La,this.uint16[Ll+20]=ja,this.uint16[Ll+21]=Va,this.uint16[Ll+22]=Na,this.uint32[Ol+12]=qa,this.float32[Ol+13]=Qa,this.float32[Ol+14]=Pl,this.uint16[Ll+30]=zl,this.uint16[Ll+31]=Dl,rt}}Qs.prototype.bytesPerElement=64,Xi("StructArrayLayout8i15ui1ul2f2ui64",Qs);class ta extends Ts{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(rt){const at=this.length;return this.resize(at+1),this.emplace(at,rt)}emplace(rt,at){return this.float32[1*rt+0]=at,rt}}ta.prototype.bytesPerElement=4,Xi("StructArrayLayout1f4",ta);class ea extends Ts{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(rt,at,Tt){const $t=this.length;return this.resize($t+1),this.emplace($t,rt,at,Tt)}emplace(rt,at,Tt,$t){const qt=3*rt;return this.uint16[6*rt+0]=at,this.float32[qt+1]=Tt,this.float32[qt+2]=$t,rt}}ea.prototype.bytesPerElement=12,Xi("StructArrayLayout1ui2f12",ea);class ra extends Ts{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(rt,at,Tt){const $t=this.length;return this.resize($t+1),this.emplace($t,rt,at,Tt)}emplace(rt,at,Tt,$t){const qt=4*rt;return this.uint32[2*rt+0]=at,this.uint16[qt+2]=Tt,this.uint16[qt+3]=$t,rt}}ra.prototype.bytesPerElement=8,Xi("StructArrayLayout1ul2ui8",ra);class na extends Ts{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(rt,at){const Tt=this.length;return this.resize(Tt+1),this.emplace(Tt,rt,at)}emplace(rt,at,Tt){const $t=2*rt;return this.uint16[$t+0]=at,this.uint16[$t+1]=Tt,rt}}na.prototype.bytesPerElement=4,Xi("StructArrayLayout2ui4",na);class ia extends Ts{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(rt){const at=this.length;return this.resize(at+1),this.emplace(at,rt)}emplace(rt,at){return this.uint16[1*rt+0]=at,rt}}ia.prototype.bytesPerElement=2,Xi("StructArrayLayout1ui2",ia);class sa extends Ts{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(rt,at,Tt,$t){const qt=this.length;return this.resize(qt+1),this.emplace(qt,rt,at,Tt,$t)}emplace(rt,at,Tt,$t,qt){const Kt=4*rt;return this.float32[Kt+0]=at,this.float32[Kt+1]=Tt,this.float32[Kt+2]=$t,this.float32[Kt+3]=qt,rt}}sa.prototype.bytesPerElement=16,Xi("StructArrayLayout4f16",sa);class aa extends Es{get anchorPointX(){return this._structArray.int16[this._pos2+0]}get anchorPointY(){return this._structArray.int16[this._pos2+1]}get x1(){return this._structArray.int16[this._pos2+2]}get y1(){return this._structArray.int16[this._pos2+3]}get x2(){return this._structArray.int16[this._pos2+4]}get y2(){return this._structArray.int16[this._pos2+5]}get featureIndex(){return this._structArray.uint32[this._pos4+3]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+8]}get bucketIndex(){return this._structArray.uint16[this._pos2+9]}get anchorPoint(){return new ge(this.anchorPointX,this.anchorPointY)}}aa.prototype.size=20;class oa extends Ks{get(rt){return new aa(this,rt)}}Xi("CollisionBoxArray",oa);class la extends Es{get anchorX(){return this._structArray.int16[this._pos2+0]}get anchorY(){return this._structArray.int16[this._pos2+1]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+2]}get numGlyphs(){return this._structArray.uint16[this._pos2+3]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+2]}get lineStartIndex(){return this._structArray.uint32[this._pos4+3]}get lineLength(){return this._structArray.uint32[this._pos4+4]}get segment(){return this._structArray.uint16[this._pos2+10]}get lowerSize(){return this._structArray.uint16[this._pos2+11]}get upperSize(){return this._structArray.uint16[this._pos2+12]}get lineOffsetX(){return this._structArray.float32[this._pos4+7]}get lineOffsetY(){return this._structArray.float32[this._pos4+8]}get writingMode(){return this._structArray.uint8[this._pos1+36]}get placedOrientation(){return this._structArray.uint8[this._pos1+37]}set placedOrientation(rt){this._structArray.uint8[this._pos1+37]=rt}get hidden(){return this._structArray.uint8[this._pos1+38]}set hidden(rt){this._structArray.uint8[this._pos1+38]=rt}get crossTileID(){return this._structArray.uint32[this._pos4+10]}set crossTileID(rt){this._structArray.uint32[this._pos4+10]=rt}get associatedIconIndex(){return this._structArray.int16[this._pos2+22]}}la.prototype.size=48;class ua extends Ws{get(rt){return new la(this,rt)}}Xi("PlacedSymbolArray",ua);class ca extends Es{get anchorX(){return this._structArray.int16[this._pos2+0]}get anchorY(){return this._structArray.int16[this._pos2+1]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+2]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+3]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+4]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+5]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+6]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+7]}get key(){return this._structArray.uint16[this._pos2+8]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+9]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+10]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+11]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+12]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+13]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+14]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+15]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+16]}get featureIndex(){return this._structArray.uint16[this._pos2+17]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+18]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+19]}get numIconVertices(){return this._structArray.uint16[this._pos2+20]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+21]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+22]}get crossTileID(){return this._structArray.uint32[this._pos4+12]}set crossTileID(rt){this._structArray.uint32[this._pos4+12]=rt}get textBoxScale(){return this._structArray.float32[this._pos4+13]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+14]}get textAnchorOffsetStartIndex(){return this._structArray.uint16[this._pos2+30]}get textAnchorOffsetEndIndex(){return this._structArray.uint16[this._pos2+31]}}ca.prototype.size=64;class ha extends Qs{get(rt){return new ca(this,rt)}}Xi("SymbolInstanceArray",ha);class pa extends ta{getoffsetX(rt){return this.float32[1*rt+0]}}Xi("GlyphOffsetArray",pa);class fa extends Os{getx(rt){return this.int16[3*rt+0]}gety(rt){return this.int16[3*rt+1]}gettileUnitDistanceFromAnchor(rt){return this.int16[3*rt+2]}}Xi("SymbolLineVertexArray",fa);class da extends Es{get textAnchor(){return this._structArray.uint16[this._pos2+0]}get textOffset0(){return this._structArray.float32[this._pos4+1]}get textOffset1(){return this._structArray.float32[this._pos4+2]}}da.prototype.size=12;class ya extends ea{get(rt){return new da(this,rt)}}Xi("TextAnchorOffsetArray",ya);class ma extends Es{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}}ma.prototype.size=8;class ga extends ra{get(rt){return new ma(this,rt)}}Xi("FeatureIndexArray",ga);class xa extends Ls{}class va extends Ls{}class ba extends Ls{}class wa extends Rs{}class _a extends js{}class Sa extends Ns{}class Aa extends Us{}class ka extends qs{}class Ma extends Gs{}class Ia extends Zs{}class za extends Xs{}class Pa extends Ys{}class Ca extends Js{}class Ba extends na{}const Vu=Fs([{name:"a_pos",components:2,type:"Int16"}],4),{members:Uu}=Vu;class Ta{constructor(rt=[]){this._forceNewSegmentOnNextPrepare=!1,this.segments=rt}prepareSegment(rt,at,Tt,$t){const qt=this.segments[this.segments.length-1];return rt>Ta.MAX_VERTEX_ARRAY_LENGTH&&U(`Max vertices per segment is ${Ta.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${rt}. Consider using the \`fillLargeMeshArrays\` function if you require meshes with more than ${Ta.MAX_VERTEX_ARRAY_LENGTH} vertices.`),this._forceNewSegmentOnNextPrepare||!qt||qt.vertexLength+rt>Ta.MAX_VERTEX_ARRAY_LENGTH||qt.sortKey!==$t?this.createNewSegment(at,Tt,$t):qt}createNewSegment(rt,at,Tt){const $t={vertexOffset:rt.length,primitiveOffset:at.length,vertexLength:0,primitiveLength:0,vaos:{}};return void 0!==Tt&&($t.sortKey=Tt),this._forceNewSegmentOnNextPrepare=!1,this.segments.push($t),$t}getOrCreateLatestSegment(rt,at,Tt){return this.prepareSegment(0,rt,at,Tt)}forceNewSegmentOnNextPrepare(){this._forceNewSegmentOnNextPrepare=!0}get(){return this.segments}destroy(){for(const rt of this.segments)for(const at in rt.vaos)rt.vaos[at].destroy()}static simpleSegment(rt,at,Tt,$t){return new Ta([{vertexOffset:rt,primitiveOffset:at,vertexLength:Tt,primitiveLength:$t,vaos:{},sortKey:0}])}}function Fa(rt,at){return 256*(rt=F(Math.floor(rt),0,255))+F(Math.floor(at),0,255)}Ta.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,Xi("SegmentVector",Ta);const $u=Fs([{name:"a_pattern_from",components:4,type:"Uint16"},{name:"a_pattern_to",components:4,type:"Uint16"},{name:"a_pixel_ratio_from",components:1,type:"Uint16"},{name:"a_pixel_ratio_to",components:1,type:"Uint16"}]);var qu,Xu,Yu,Qu={exports:{}},td={exports:{}},ed={exports:{}},id=function(){if(Yu)return Qu.exports;Yu=1;var rt=(qu||(qu=1,td.exports=function(rt,at){var Tt,$t,qt,Kt,ge,Hr,wn,es;for($t=rt.length-(Tt=3&rt.length),qt=at,ge=3432918353,Hr=461845907,es=0;es<$t;)wn=255&rt.charCodeAt(es)|(255&rt.charCodeAt(++es))<<8|(255&rt.charCodeAt(++es))<<16|(255&rt.charCodeAt(++es))<<24,++es,qt=27492+(65535&(Kt=5*(65535&(qt=(qt^=wn=(65535&(wn=(wn=(65535&wn)*ge+(((wn>>>16)*ge&65535)<<16)&4294967295)<<15|wn>>>17))*Hr+(((wn>>>16)*Hr&65535)<<16)&4294967295)<<13|qt>>>19))+((5*(qt>>>16)&65535)<<16)&4294967295))+((58964+(Kt>>>16)&65535)<<16);switch(wn=0,Tt){case 3:wn^=(255&rt.charCodeAt(es+2))<<16;case 2:wn^=(255&rt.charCodeAt(es+1))<<8;case 1:qt^=wn=(65535&(wn=(wn=(65535&(wn^=255&rt.charCodeAt(es)))*ge+(((wn>>>16)*ge&65535)<<16)&4294967295)<<15|wn>>>17))*Hr+(((wn>>>16)*Hr&65535)<<16)&4294967295}return qt^=rt.length,qt=2246822507*(65535&(qt^=qt>>>16))+((2246822507*(qt>>>16)&65535)<<16)&4294967295,qt=3266489909*(65535&(qt^=qt>>>13))+((3266489909*(qt>>>16)&65535)<<16)&4294967295,(qt^=qt>>>16)>>>0}),td.exports),at=(Xu||(Xu=1,ed.exports=function(rt,at){for(var Tt,$t=rt.length,qt=at^$t,Kt=0;$t>=4;)Tt=1540483477*(65535&(Tt=255&rt.charCodeAt(Kt)|(255&rt.charCodeAt(++Kt))<<8|(255&rt.charCodeAt(++Kt))<<16|(255&rt.charCodeAt(++Kt))<<24))+((1540483477*(Tt>>>16)&65535)<<16),qt=1540483477*(65535&qt)+((1540483477*(qt>>>16)&65535)<<16)^(Tt=1540483477*(65535&(Tt^=Tt>>>24))+((1540483477*(Tt>>>16)&65535)<<16)),$t-=4,++Kt;switch($t){case 3:qt^=(255&rt.charCodeAt(Kt+2))<<16;case 2:qt^=(255&rt.charCodeAt(Kt+1))<<8;case 1:qt=1540483477*(65535&(qt^=255&rt.charCodeAt(Kt)))+((1540483477*(qt>>>16)&65535)<<16)}return qt=1540483477*(65535&(qt^=qt>>>13))+((1540483477*(qt>>>16)&65535)<<16),(qt^=qt>>>15)>>>0}),ed.exports);return Qu.exports=rt,Qu.exports.murmur3=rt,Qu.exports.murmur2=at,Qu.exports}(),rd=r(id);class Ga{constructor(){this.ids=[],this.positions=[],this.indexed=!1}add(rt,at,Tt,$t){this.ids.push(Za(rt)),this.positions.push(at,Tt,$t)}getPositions(rt){if(!this.indexed)throw new Error("Trying to get index, but feature positions are not indexed");const at=Za(rt);let Tt=0,$t=this.ids.length-1;for(;Tt<$t;){const rt=Tt+$t>>1;this.ids[rt]>=at?$t=rt:Tt=rt+1}const qt=[];for(;this.ids[Tt]===at;)qt.push({index:this.positions[3*Tt],start:this.positions[3*Tt+1],end:this.positions[3*Tt+2]}),Tt++;return qt}static serialize(rt,at){const Tt=new Float64Array(rt.ids),$t=new Uint32Array(rt.positions);return Ka(Tt,$t,0,Tt.length-1),at&&at.push(Tt.buffer,$t.buffer),{ids:Tt,positions:$t}}static deserialize(rt){const at=new Ga;return at.ids=rt.ids,at.positions=rt.positions,at.indexed=!0,at}}function Za(rt){const at=+rt;return!isNaN(at)&&at<=Number.MAX_SAFE_INTEGER?at:rd(String(rt))}function Ka(rt,at,Tt,$t){for(;Tt<$t;){const qt=rt[Tt+$t>>1];let Kt=Tt-1,ge=$t+1;for(;;){do{Kt++}while(rt[Kt]<qt);do{ge--}while(rt[ge]>qt);if(Kt>=ge)break;Xa(rt,Kt,ge),Xa(at,3*Kt,3*ge),Xa(at,3*Kt+1,3*ge+1),Xa(at,3*Kt+2,3*ge+2)}ge-Tt<$t-ge?(Ka(rt,at,Tt,ge),Tt=ge+1):(Ka(rt,at,ge+1,$t),$t=ge)}}function Xa(rt,at,Tt){const $t=rt[at];rt[at]=rt[Tt],rt[Tt]=$t}Xi("FeaturePositionMap",Ga);class Ha{constructor(rt,at){this.gl=rt.gl,this.location=at}}class Ya extends Ha{constructor(rt,at){super(rt,at),this.current=0}set(rt){this.current!==rt&&(this.current=rt,this.gl.uniform1f(this.location,rt))}}class Ja extends Ha{constructor(rt,at){super(rt,at),this.current=[0,0,0,0]}set(rt){rt[0]===this.current[0]&&rt[1]===this.current[1]&&rt[2]===this.current[2]&&rt[3]===this.current[3]||(this.current=rt,this.gl.uniform4f(this.location,rt[0],rt[1],rt[2],rt[3]))}}class Wa extends Ha{constructor(rt,at){super(rt,at),this.current=be.transparent}set(rt){rt.r===this.current.r&&rt.g===this.current.g&&rt.b===this.current.b&&rt.a===this.current.a||(this.current=rt,this.gl.uniform4f(this.location,rt.r,rt.g,rt.b,rt.a))}}const nd=new Float32Array(16);function to(rt){return[Fa(255*rt.r,255*rt.g),Fa(255*rt.b,255*rt.a)]}class eo{constructor(rt,at,Tt){this.value=rt,this.uniformNames=at.map((rt=>`u_${rt}`)),this.type=Tt}setUniform(rt,at,Tt){rt.set(Tt.constantOr(this.value))}getBinding(rt,at,Tt){return"color"===this.type?new Wa(rt,at):new Ya(rt,at)}}class ro{constructor(rt,at){this.uniformNames=at.map((rt=>`u_${rt}`)),this.patternFrom=null,this.patternTo=null,this.pixelRatioFrom=1,this.pixelRatioTo=1}setConstantPatternPositions(rt,at){this.pixelRatioFrom=at.pixelRatio,this.pixelRatioTo=rt.pixelRatio,this.patternFrom=at.tlbr,this.patternTo=rt.tlbr}setUniform(rt,at,Tt,$t){const qt="u_pattern_to"===$t?this.patternTo:"u_pattern_from"===$t?this.patternFrom:"u_pixel_ratio_to"===$t?this.pixelRatioTo:"u_pixel_ratio_from"===$t?this.pixelRatioFrom:null;qt&&rt.set(qt)}getBinding(rt,at,Tt){return"u_pattern"===Tt.substr(0,9)?new Ja(rt,at):new Ya(rt,at)}}class no{constructor(rt,at,Tt,$t){this.expression=rt,this.type=Tt,this.maxValue=0,this.paintVertexAttributes=at.map((rt=>({name:`a_${rt}`,type:"Float32",components:"color"===Tt?2:1,offset:0}))),this.paintVertexArray=new $t}populatePaintArray(rt,at,Tt,$t,qt){const Kt=this.paintVertexArray.length,ge=this.expression.evaluate(new ys(0),at,{},$t,[],qt);this.paintVertexArray.resize(rt),this._setPaintValue(Kt,rt,ge)}updatePaintArray(rt,at,Tt,$t){const qt=this.expression.evaluate({zoom:0},Tt,$t);this._setPaintValue(rt,at,qt)}_setPaintValue(rt,at,Tt){if("color"===this.type){const $t=to(Tt);for(let Tt=rt;Tt<at;Tt++)this.paintVertexArray.emplace(Tt,$t[0],$t[1])}else{for(let $t=rt;$t<at;$t++)this.paintVertexArray.emplace($t,Tt);this.maxValue=Math.max(this.maxValue,Math.abs(Tt))}}upload(rt){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=rt.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class io{constructor(rt,at,Tt,$t,qt,Kt){this.expression=rt,this.uniformNames=at.map((rt=>`u_${rt}_t`)),this.type=Tt,this.useIntegerZoom=$t,this.zoom=qt,this.maxValue=0,this.paintVertexAttributes=at.map((rt=>({name:`a_${rt}`,type:"Float32",components:"color"===Tt?4:2,offset:0}))),this.paintVertexArray=new Kt}populatePaintArray(rt,at,Tt,$t,qt){const Kt=this.expression.evaluate(new ys(this.zoom),at,{},$t,[],qt),ge=this.expression.evaluate(new ys(this.zoom+1),at,{},$t,[],qt),Hr=this.paintVertexArray.length;this.paintVertexArray.resize(rt),this._setPaintValue(Hr,rt,Kt,ge)}updatePaintArray(rt,at,Tt,$t){const qt=this.expression.evaluate({zoom:this.zoom},Tt,$t),Kt=this.expression.evaluate({zoom:this.zoom+1},Tt,$t);this._setPaintValue(rt,at,qt,Kt)}_setPaintValue(rt,at,Tt,$t){if("color"===this.type){const qt=to(Tt),Kt=to($t);for(let Tt=rt;Tt<at;Tt++)this.paintVertexArray.emplace(Tt,qt[0],qt[1],Kt[0],Kt[1])}else{for(let qt=rt;qt<at;qt++)this.paintVertexArray.emplace(qt,Tt,$t);this.maxValue=Math.max(this.maxValue,Math.abs(Tt),Math.abs($t))}}upload(rt){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=rt.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(rt,at){const Tt=this.useIntegerZoom?Math.floor(at.zoom):at.zoom,$t=F(this.expression.interpolationFactor(Tt,this.zoom,this.zoom+1),0,1);rt.set($t)}getBinding(rt,at,Tt){return new Ya(rt,at)}}class so{constructor(rt,at,Tt,$t,qt,Kt){this.expression=rt,this.type=at,this.useIntegerZoom=Tt,this.zoom=$t,this.layerId=Kt,this.zoomInPaintVertexArray=new qt,this.zoomOutPaintVertexArray=new qt}populatePaintArray(rt,at,Tt){const $t=this.zoomInPaintVertexArray.length;this.zoomInPaintVertexArray.resize(rt),this.zoomOutPaintVertexArray.resize(rt),this._setPaintValues($t,rt,at.patterns&&at.patterns[this.layerId],Tt)}updatePaintArray(rt,at,Tt,$t,qt){this._setPaintValues(rt,at,Tt.patterns&&Tt.patterns[this.layerId],qt)}_setPaintValues(rt,at,Tt,$t){if(!$t||!Tt)return;const{min:qt,mid:Kt,max:ge}=Tt,Hr=$t[qt],wn=$t[Kt],es=$t[ge];if(Hr&&wn&&es)for(let Tt=rt;Tt<at;Tt++)this.zoomInPaintVertexArray.emplace(Tt,wn.tl[0],wn.tl[1],wn.br[0],wn.br[1],Hr.tl[0],Hr.tl[1],Hr.br[0],Hr.br[1],wn.pixelRatio,Hr.pixelRatio),this.zoomOutPaintVertexArray.emplace(Tt,wn.tl[0],wn.tl[1],wn.br[0],wn.br[1],es.tl[0],es.tl[1],es.br[0],es.br[1],wn.pixelRatio,es.pixelRatio)}upload(rt){this.zoomInPaintVertexArray&&this.zoomInPaintVertexArray.arrayBuffer&&this.zoomOutPaintVertexArray&&this.zoomOutPaintVertexArray.arrayBuffer&&(this.zoomInPaintVertexBuffer=rt.createVertexBuffer(this.zoomInPaintVertexArray,$u.members,this.expression.isStateDependent),this.zoomOutPaintVertexBuffer=rt.createVertexBuffer(this.zoomOutPaintVertexArray,$u.members,this.expression.isStateDependent))}destroy(){this.zoomOutPaintVertexBuffer&&this.zoomOutPaintVertexBuffer.destroy(),this.zoomInPaintVertexBuffer&&this.zoomInPaintVertexBuffer.destroy()}}class ao{constructor(rt,at,Tt){this.binders={},this._buffers=[];const $t=[];for(const qt in rt.paint._values){if(!Tt(qt))continue;const Kt=rt.paint.get(qt);if(!(Kt instanceof _s&&En(Kt.property.specification)))continue;const ge=lo(qt,rt.type),Hr=Kt.value,wn=Kt.property.specification.type,es=Kt.property.useIntegerZoom,ss=Kt.property.specification["property-type"],os="cross-faded"===ss||"cross-faded-data-driven"===ss;if("constant"===Hr.kind)this.binders[qt]=os?new ro(Hr.value,ge):new eo(Hr.value,ge,wn),$t.push(`/u_${qt}`);else if("source"===Hr.kind||os){const Tt=uo(qt,wn,"source");this.binders[qt]=os?new so(Hr,wn,es,at,Tt,rt.id):new no(Hr,ge,wn,Tt),$t.push(`/a_${qt}`)}else{const rt=uo(qt,wn,"composite");this.binders[qt]=new io(Hr,ge,wn,es,at,rt),$t.push(`/z_${qt}`)}}this.cacheKey=$t.sort().join("")}getMaxValue(rt){const at=this.binders[rt];return at instanceof no||at instanceof io?at.maxValue:0}populatePaintArrays(rt,at,Tt,$t,qt){for(const Kt in this.binders){const ge=this.binders[Kt];(ge instanceof no||ge instanceof io||ge instanceof so)&&ge.populatePaintArray(rt,at,Tt,$t,qt)}}setConstantPatternPositions(rt,at){for(const Tt in this.binders){const $t=this.binders[Tt];$t instanceof ro&&$t.setConstantPatternPositions(rt,at)}}updatePaintArrays(rt,at,Tt,$t,qt){let Kt=!1;for(const ge in rt){const Hr=at.getPositions(ge);for(const at of Hr){const Hr=Tt.feature(at.index);for(const Tt in this.binders){const wn=this.binders[Tt];if((wn instanceof no||wn instanceof io||wn instanceof so)&&!0===wn.expression.isStateDependent){const es=$t.paint.get(Tt);wn.expression=es.value,wn.updatePaintArray(at.start,at.end,Hr,rt[ge],qt),Kt=!0}}}}return Kt}defines(){const rt=[];for(const at in this.binders){const Tt=this.binders[at];(Tt instanceof eo||Tt instanceof ro)&&rt.push(...Tt.uniformNames.map((rt=>`#define HAS_UNIFORM_${rt}`)))}return rt}getBinderAttributes(){const rt=[];for(const at in this.binders){const Tt=this.binders[at];if(Tt instanceof no||Tt instanceof io)for(let at=0;at<Tt.paintVertexAttributes.length;at++)rt.push(Tt.paintVertexAttributes[at].name);else if(Tt instanceof so)for(let at=0;at<$u.members.length;at++)rt.push($u.members[at].name)}return rt}getBinderUniforms(){const rt=[];for(const at in this.binders){const Tt=this.binders[at];if(Tt instanceof eo||Tt instanceof ro||Tt instanceof io)for(const at of Tt.uniformNames)rt.push(at)}return rt}getPaintVertexBuffers(){return this._buffers}getUniforms(rt,at){const Tt=[];for(const $t in this.binders){const qt=this.binders[$t];if(qt instanceof eo||qt instanceof ro||qt instanceof io)for(const Kt of qt.uniformNames)if(at[Kt]){const ge=qt.getBinding(rt,at[Kt],Kt);Tt.push({name:Kt,property:$t,binding:ge})}}return Tt}setUniforms(rt,at,Tt,$t){for(const{name:rt,property:qt,binding:Kt}of at)this.binders[qt].setUniform(Kt,$t,Tt.get(qt),rt)}updatePaintBuffers(rt){this._buffers=[];for(const at in this.binders){const Tt=this.binders[at];if(rt&&Tt instanceof so){const at=2===rt.fromScale?Tt.zoomInPaintVertexBuffer:Tt.zoomOutPaintVertexBuffer;at&&this._buffers.push(at)}else(Tt instanceof no||Tt instanceof io)&&Tt.paintVertexBuffer&&this._buffers.push(Tt.paintVertexBuffer)}}upload(rt){for(const at in this.binders){const Tt=this.binders[at];(Tt instanceof no||Tt instanceof io||Tt instanceof so)&&Tt.upload(rt)}this.updatePaintBuffers()}destroy(){for(const rt in this.binders){const at=this.binders[rt];(at instanceof no||at instanceof io||at instanceof so)&&at.destroy()}}}class oo{constructor(rt,at,Tt=()=>!0){this.programConfigurations={};for(const $t of rt)this.programConfigurations[$t.id]=new ao($t,at,Tt);this.needsUpload=!1,this._featureMap=new Ga,this._bufferOffset=0}populatePaintArrays(rt,at,Tt,$t,qt,Kt){for(const Tt in this.programConfigurations)this.programConfigurations[Tt].populatePaintArrays(rt,at,$t,qt,Kt);void 0!==at.id&&this._featureMap.add(at.id,Tt,this._bufferOffset,rt),this._bufferOffset=rt,this.needsUpload=!0}updatePaintArrays(rt,at,Tt,$t){for(const qt of Tt)this.needsUpload=this.programConfigurations[qt.id].updatePaintArrays(rt,this._featureMap,at,qt,$t)||this.needsUpload}get(rt){return this.programConfigurations[rt]}upload(rt){if(this.needsUpload){for(const at in this.programConfigurations)this.programConfigurations[at].upload(rt);this.needsUpload=!1}}destroy(){for(const rt in this.programConfigurations)this.programConfigurations[rt].destroy()}}function lo(rt,at){return{"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"line-gap-width":["gapwidth"],"line-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"fill-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"fill-extrusion-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"]}[rt]||[rt.replace(`${at}-`,"").replace(/-/g,"_")]}function uo(rt,at,Tt){const $t={color:{source:Ns,composite:sa},number:{source:ta,composite:Ns}},qt=function(rt){return{"line-pattern":{source:Aa,composite:Aa},"fill-pattern":{source:Aa,composite:Aa},"fill-extrusion-pattern":{source:Aa,composite:Aa}}[rt]}(rt);return qt&&qt[Tt]||$t[at][Tt]}Xi("ConstantBinder",eo),Xi("CrossFadedConstantBinder",ro),Xi("SourceExpressionBinder",no),Xi("CrossFadedCompositeBinder",so),Xi("CompositeExpressionBinder",io),Xi("ProgramConfiguration",ao,{omit:["_buffers"]}),Xi("ProgramConfigurationSet",oo);const sd=Math.pow(2,14)-1,od=-sd-1;function po(rt){const at=Vs/rt.extent,Tt=rt.loadGeometry();for(let rt=0;rt<Tt.length;rt++){const $t=Tt[rt];for(let rt=0;rt<$t.length;rt++){const Tt=$t[rt],qt=Math.round(Tt.x*at),Kt=Math.round(Tt.y*at);Tt.x=F(qt,od,sd),Tt.y=F(Kt,od,sd),(qt<Tt.x||qt>Tt.x+1||Kt<Tt.y||Kt>Tt.y+1)&&U("Geometry exceeds allowed extent, reduce your vector tile buffer size")}}return Tt}function fo(rt,at){return{type:rt.type,id:rt.id,properties:rt.properties,geometry:at?po(rt):[]}}const ad=-32768;function mo(rt,at,Tt,$t,qt){rt.emplaceBack(ad+8*at+$t,ad+8*Tt+qt)}class go{constructor(rt){this.zoom=rt.zoom,this.overscaling=rt.overscaling,this.layers=rt.layers,this.layerIds=this.layers.map((rt=>rt.id)),this.index=rt.index,this.hasPattern=!1,this.layoutVertexArray=new va,this.indexArray=new Ca,this.segments=new Ta,this.programConfigurations=new oo(rt.layers,rt.zoom),this.stateDependentLayerIds=this.layers.filter((rt=>rt.isStateDependent())).map((rt=>rt.id))}populate(rt,at,Tt){const $t=this.layers[0],qt=[];let Kt=null,ge=!1,Hr="heatmap"===$t.type;if("circle"===$t.type){const rt=$t;Kt=rt.layout.get("circle-sort-key"),ge=!Kt.isConstant(),Hr=Hr||"map"===rt.paint.get("circle-pitch-alignment")}const wn=Hr?at.subdivisionGranularity.circle:1;for(const{feature:at,id:$t,index:Hr,sourceLayerIndex:wn}of rt){const rt=this.layers[0]._featureFilter.needGeometry,es=fo(at,rt);if(!this.layers[0]._featureFilter.filter(new ys(this.zoom),es,Tt))continue;const ss=ge?Kt.evaluate(es,{},Tt):void 0,os={id:$t,properties:at.properties,type:at.type,sourceLayerIndex:wn,index:Hr,geometry:rt?es.geometry:po(at),patterns:{},sortKey:ss};qt.push(os)}ge&&qt.sort(((rt,at)=>rt.sortKey-at.sortKey));for(const $t of qt){const{geometry:qt,index:Kt,sourceLayerIndex:ge}=$t,Hr=rt[Kt].feature;this.addFeature($t,qt,Kt,Tt,wn),at.featureIndex.insert(Hr,qt,Kt,ge,this.index)}}update(rt,at,Tt){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(rt,at,this.stateDependentLayers,Tt)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(rt){this.uploaded||(this.layoutVertexBuffer=rt.createVertexBuffer(this.layoutVertexArray,Uu),this.indexBuffer=rt.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(rt),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(rt,at,Tt,$t,qt=1){let Kt;switch(qt){case 1:Kt=[0,7];break;case 3:Kt=[0,2,5,7];break;case 5:Kt=[0,1,3,4,6,7];break;case 7:Kt=[0,1,2,3,4,5,6,7];break;default:throw new Error(`Invalid circle bucket granularity: ${qt}; valid values are 1, 3, 5, 7.`)}const ge=Kt.length;for(const Tt of at)for(const at of Tt){const Tt=at.x,$t=at.y;if(Tt<0||Tt>=Vs||$t<0||$t>=Vs)continue;const qt=this.segments.prepareSegment(ge*ge,this.layoutVertexArray,this.indexArray,rt.sortKey),Hr=qt.vertexLength;for(let rt=0;rt<ge;rt++)for(let at=0;at<ge;at++)mo(this.layoutVertexArray,Tt,$t,Kt[at],Kt[rt]);for(let rt=0;rt<ge-1;rt++)for(let at=0;at<ge-1;at++){const Tt=Hr+rt*ge+at,$t=Hr+(rt+1)*ge+at;this.indexArray.emplaceBack(Tt,$t+1,Tt+1),this.indexArray.emplaceBack(Tt,$t,$t+1)}qt.vertexLength+=ge*ge,qt.primitiveLength+=(ge-1)*(ge-1)*2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,rt,Tt,{},$t)}}function xo(rt,at){for(let Tt=0;Tt<rt.length;Tt++)if(Io(at,rt[Tt]))return!0;for(let Tt=0;Tt<at.length;Tt++)if(Io(rt,at[Tt]))return!0;return!!_o(rt,at)}function vo(rt,at,Tt){return!!Io(rt,at)||!!Ao(at,rt,Tt)}function bo(rt,at){if(1===rt.length)return Mo(at,rt[0]);for(let Tt=0;Tt<at.length;Tt++){const $t=at[Tt];for(let at=0;at<$t.length;at++)if(Io(rt,$t[at]))return!0}for(let Tt=0;Tt<rt.length;Tt++)if(Mo(at,rt[Tt]))return!0;for(let Tt=0;Tt<at.length;Tt++)if(_o(rt,at[Tt]))return!0;return!1}function wo(rt,at,Tt){if(rt.length>1){if(_o(rt,at))return!0;for(let $t=0;$t<at.length;$t++)if(Ao(at[$t],rt,Tt))return!0}for(let $t=0;$t<rt.length;$t++)if(Ao(rt[$t],at,Tt))return!0;return!1}function _o(rt,at){if(0===rt.length||0===at.length)return!1;for(let Tt=0;Tt<rt.length-1;Tt++){const $t=rt[Tt],qt=rt[Tt+1];for(let rt=0;rt<at.length-1;rt++)if(So($t,qt,at[rt],at[rt+1]))return!0}return!1}function So(rt,at,Tt,$t){return q(rt,Tt,$t)!==q(at,Tt,$t)&&q(rt,at,Tt)!==q(rt,at,$t)}function Ao(rt,at,Tt){const $t=Tt*Tt;if(1===at.length)return rt.distSqr(at[0])<$t;for(let Tt=1;Tt<at.length;Tt++)if(ko(rt,at[Tt-1],at[Tt])<$t)return!0;return!1}function ko(rt,at,Tt){const $t=at.distSqr(Tt);if(0===$t)return rt.distSqr(at);const qt=((rt.x-at.x)*(Tt.x-at.x)+(rt.y-at.y)*(Tt.y-at.y))/$t;return rt.distSqr(qt<0?at:qt>1?Tt:Tt.sub(at)._mult(qt)._add(at))}function Mo(rt,at){for(let Tt=0;Tt<rt.length;Tt++)if(Io(rt[Tt],at))return!0;return!1}function Io(rt,at){let Tt=!1;for(let $t=0,qt=rt.length-1;$t<rt.length;qt=$t++){const Kt=rt[$t],ge=rt[qt];Kt.y>at.y!=ge.y>at.y&&at.x<(ge.x-Kt.x)*(at.y-Kt.y)/(ge.y-Kt.y)+Kt.x&&(Tt=!Tt)}return Tt}function zo(rt,at,Tt){const $t=Tt[0],qt=Tt[2];if(rt.x<$t.x&&at.x<$t.x||rt.x>qt.x&&at.x>qt.x||rt.y<$t.y&&at.y<$t.y||rt.y>qt.y&&at.y>qt.y)return!1;const Kt=q(rt,at,Tt[0]);return Kt!==q(rt,at,Tt[1])||Kt!==q(rt,at,Tt[2])||Kt!==q(rt,at,Tt[3])}function Po(rt,at,Tt){const $t=at.paint.get(rt).value;return"constant"===$t.kind?$t.value:Tt.programConfigurations.get(at.id).getMaxValue(rt)}function Co(rt){return Math.sqrt(rt[0]*rt[0]+rt[1]*rt[1])}function Bo(rt,at,Tt,$t,qt){if(!at[0]&&!at[1])return rt;const Kt=ge.convert(at)._mult(qt);"viewport"===Tt&&Kt._rotate(-$t);const Hr=[];for(let at=0;at<rt.length;at++)Hr.push(rt[at].sub(Kt));return Hr}let ld,cd;Xi("CircleBucket",go,{omit:["layers"]});var hd={get paint(){return cd=cd||new Ps({"circle-radius":new ks(Dl.paint_circle["circle-radius"]),"circle-color":new ks(Dl.paint_circle["circle-color"]),"circle-blur":new ks(Dl.paint_circle["circle-blur"]),"circle-opacity":new ks(Dl.paint_circle["circle-opacity"]),"circle-translate":new As(Dl.paint_circle["circle-translate"]),"circle-translate-anchor":new As(Dl.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new As(Dl.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new As(Dl.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new ks(Dl.paint_circle["circle-stroke-width"]),"circle-stroke-color":new ks(Dl.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new ks(Dl.paint_circle["circle-stroke-opacity"])})},get layout(){return ld=ld||new Ps({"circle-sort-key":new ks(Dl.layout_circle["circle-sort-key"])})}};class Fo extends Bs{constructor(rt){super(rt,hd)}createBucket(rt){return new go(rt)}queryRadius(rt){const at=rt;return Po("circle-radius",this,at)+Po("circle-stroke-width",this,at)+Co(this.paint.get("circle-translate"))}queryIntersectsFeature({queryGeometry:rt,feature:at,featureState:Tt,geometry:$t,transform:qt,pixelsToTileUnits:Kt,unwrappedTileID:ge,getElevation:Hr}){const wn=Bo(rt,this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),-qt.bearingInRadians,Kt),es=this.paint.get("circle-radius").evaluate(at,Tt)+this.paint.get("circle-stroke-width").evaluate(at,Tt),ss="map"===this.paint.get("circle-pitch-alignment"),os=ss?wn:function(rt,at,Tt,$t){return rt.map((rt=>$o(rt,at,Tt,$t)))}(wn,qt,ge,Hr),cs=ss?es*Kt:es;for(const rt of $t)for(const at of rt){const rt=ss?at:$o(at,qt,ge,Hr);let Tt=cs;const $t=qt.projectTileCoordinates(at.x,at.y,ge,Hr).signedDistanceFromCamera;if("viewport"===this.paint.get("circle-pitch-scale")&&"map"===this.paint.get("circle-pitch-alignment")?Tt*=$t/qt.cameraToCenterDistance:"map"===this.paint.get("circle-pitch-scale")&&"viewport"===this.paint.get("circle-pitch-alignment")&&(Tt*=qt.cameraToCenterDistance/$t),vo(os,rt,Tt))return!0}return!1}}function $o(rt,at,Tt,$t){const qt=at.projectTileCoordinates(rt.x,rt.y,Tt,$t).point;return new ge((.5*qt.x+.5)*at.width,(.5*-qt.y+.5)*at.height)}class Lo extends go{}let ud;Xi("HeatmapBucket",Lo,{omit:["layers"]});var dd={get paint(){return ud=ud||new Ps({"heatmap-radius":new ks(Dl.paint_heatmap["heatmap-radius"]),"heatmap-weight":new ks(Dl.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new As(Dl.paint_heatmap["heatmap-intensity"]),"heatmap-color":new zs(Dl.paint_heatmap["heatmap-color"]),"heatmap-opacity":new As(Dl.paint_heatmap["heatmap-opacity"])})}};function Ro(rt,{width:at,height:Tt},$t,qt){if(qt){if(qt instanceof Uint8ClampedArray)qt=new Uint8Array(qt.buffer);else if(qt.length!==at*Tt*$t)throw new RangeError(`mismatched image size. expected: ${qt.length} but got: ${at*Tt*$t}`)}else qt=new Uint8Array(at*Tt*$t);return rt.width=at,rt.height=Tt,rt.data=qt,rt}function jo(rt,{width:at,height:Tt},$t){if(at===rt.width&&Tt===rt.height)return;const qt=Ro({},{width:at,height:Tt},$t);No(rt,qt,{x:0,y:0},{x:0,y:0},{width:Math.min(rt.width,at),height:Math.min(rt.height,Tt)},$t),rt.width=at,rt.height=Tt,rt.data=qt.data}function No(rt,at,Tt,$t,qt,Kt){if(0===qt.width||0===qt.height)return at;if(qt.width>rt.width||qt.height>rt.height||Tt.x>rt.width-qt.width||Tt.y>rt.height-qt.height)throw new RangeError("out of range source coordinates for image copy");if(qt.width>at.width||qt.height>at.height||$t.x>at.width-qt.width||$t.y>at.height-qt.height)throw new RangeError("out of range destination coordinates for image copy");const ge=rt.data,Hr=at.data;if(ge===Hr)throw new Error("srcData equals dstData, so image is already copied");for(let wn=0;wn<qt.height;wn++){const es=((Tt.y+wn)*rt.width+Tt.x)*Kt,ss=(($t.y+wn)*at.width+$t.x)*Kt;for(let rt=0;rt<qt.width*Kt;rt++)Hr[ss+rt]=ge[es+rt]}return at}class Uo{constructor(rt,at){Ro(this,rt,1,at)}resize(rt){jo(this,rt,1)}clone(){return new Uo({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(rt,at,Tt,$t,qt){No(rt,at,Tt,$t,qt,1)}}class qo{constructor(rt,at){Ro(this,rt,4,at)}resize(rt){jo(this,rt,4)}replace(rt,at){at?this.data.set(rt):this.data=rt instanceof Uint8ClampedArray?new Uint8Array(rt.buffer):rt}clone(){return new qo({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(rt,at,Tt,$t,qt){No(rt,at,Tt,$t,qt,4)}}function Go(rt){const at={},Tt=rt.resolution||256,$t=rt.clips?rt.clips.length:1,qt=rt.image||new qo({width:Tt,height:$t});if(Math.log(Tt)/Math.LN2%1!=0)throw new Error(`width is not a power of 2 - ${Tt}`);const s=(Tt,$t,Kt)=>{at[rt.evaluationKey]=Kt;const ge=rt.expression.evaluate(at);qt.data[Tt+$t+0]=Math.floor(255*ge.r/ge.a),qt.data[Tt+$t+1]=Math.floor(255*ge.g/ge.a),qt.data[Tt+$t+2]=Math.floor(255*ge.b/ge.a),qt.data[Tt+$t+3]=Math.floor(255*ge.a)};if(rt.clips)for(let at=0,qt=0;at<$t;++at,qt+=4*Tt)for(let $t=0,Kt=0;$t<Tt;$t++,Kt+=4){const ge=$t/(Tt-1),{start:Hr,end:wn}=rt.clips[at];s(qt,Kt,Hr*(1-ge)+wn*ge)}else for(let rt=0,at=0;rt<Tt;rt++,at+=4)s(0,at,rt/(Tt-1));return qt}Xi("AlphaImage",Uo),Xi("RGBAImage",qo);const pd="big-fb";class Ko extends Bs{createBucket(rt){return new Lo(rt)}constructor(rt){super(rt,dd),this.heatmapFbos=new Map,this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(rt){"heatmap-color"===rt&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=Go({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbos.has(pd)&&this.heatmapFbos.delete(pd)}queryRadius(){return 0}queryIntersectsFeature(){return!1}hasOffscreenPass(){return 0!==this.paint.get("heatmap-opacity")&&"none"!==this.visibility}}let fd;var md={get paint(){return fd=fd||new Ps({"hillshade-illumination-direction":new As(Dl.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new As(Dl.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new As(Dl.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new As(Dl.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new As(Dl.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new As(Dl.paint_hillshade["hillshade-accent-color"])})}};class Yo extends Bs{constructor(rt){super(rt,md)}hasOffscreenPass(){return 0!==this.paint.get("hillshade-exaggeration")&&"none"!==this.visibility}}const _d=Fs([{name:"a_pos",components:2,type:"Int16"}],4),{members:gd}=_d;function Qo(rt,at,Tt){const $t=Tt.patternDependencies;let qt=!1;for(const Tt of at){const at=Tt.paint.get(`${rt}-pattern`);at.isConstant()||(qt=!0);const Kt=at.constantOr(null);Kt&&(qt=!0,$t[Kt.to]=!0,$t[Kt.from]=!0)}return qt}function tl(rt,at,Tt,$t,qt){const Kt=qt.patternDependencies;for(const ge of at){const at=ge.paint.get(`${rt}-pattern`).value;if("constant"!==at.kind){let rt=at.evaluate({zoom:$t-1},Tt,{},qt.availableImages),Hr=at.evaluate({zoom:$t},Tt,{},qt.availableImages),wn=at.evaluate({zoom:$t+1},Tt,{},qt.availableImages);rt=rt&&rt.name?rt.name:rt,Hr=Hr&&Hr.name?Hr.name:Hr,wn=wn&&wn.name?wn.name:wn,Kt[rt]=!0,Kt[Hr]=!0,Kt[wn]=!0,Tt.patterns[ge.id]={min:rt,mid:Hr,max:wn}}}return Tt}function el(rt,at,Tt,$t,qt){let Kt;if(qt===function(rt,at,Tt,$t){let qt=0;for(let Kt=at,ge=Tt-$t;Kt<Tt;Kt+=$t)qt+=(rt[ge]-rt[Kt])*(rt[Kt+1]+rt[ge+1]),ge=Kt;return qt}(rt,at,Tt,$t)>0)for(let qt=at;qt<Tt;qt+=$t)Kt=Sl(qt/$t|0,rt[qt],rt[qt+1],Kt);else for(let qt=Tt-$t;qt>=at;qt-=$t)Kt=Sl(qt/$t|0,rt[qt],rt[qt+1],Kt);return Kt&&gl(Kt,Kt.next)&&(Al(Kt),Kt=Kt.next),Kt}function rl(rt,at){if(!rt)return rt;at||(at=rt);let Tt,$t=rt;do{if(Tt=!1,$t.steiner||!gl($t,$t.next)&&0!==ml($t.prev,$t,$t.next))$t=$t.next;else{if(Al($t),$t=at=$t.prev,$t===$t.next)break;Tt=!0}}while(Tt||$t!==at);return at}function nl(rt,at,Tt,$t,qt,Kt,ge){if(!rt)return;!ge&&Kt&&function(rt,at,Tt,$t){let qt=rt;do{0===qt.z&&(qt.z=hl(qt.x,qt.y,at,Tt,$t)),qt.prevZ=qt.prev,qt.nextZ=qt.next,qt=qt.next}while(qt!==rt);qt.prevZ.nextZ=null,qt.prevZ=null,function(rt){let at,Tt=1;do{let $t,qt=rt;rt=null;let Kt=null;for(at=0;qt;){at++;let ge=qt,Hr=0;for(let rt=0;rt<Tt&&(Hr++,ge=ge.nextZ,ge);rt++);let wn=Tt;for(;Hr>0||wn>0&&ge;)0!==Hr&&(0===wn||!ge||qt.z<=ge.z)?($t=qt,qt=qt.nextZ,Hr--):($t=ge,ge=ge.nextZ,wn--),Kt?Kt.nextZ=$t:rt=$t,$t.prevZ=Kt,Kt=$t;qt=ge}Kt.nextZ=null,Tt*=2}while(at>1)}(qt)}(rt,$t,qt,Kt);let Hr=rt;for(;rt.prev!==rt.next;){const wn=rt.prev,es=rt.next;if(Kt?sl(rt,$t,qt,Kt):il(rt))at.push(wn.i,rt.i,es.i),Al(rt),rt=es.next,Hr=es.next;else if((rt=es)===Hr){ge?1===ge?nl(rt=al(rl(rt),at),at,Tt,$t,qt,Kt,2):2===ge&&ol(rt,at,Tt,$t,qt,Kt):nl(rl(rt),at,Tt,$t,qt,Kt,1);break}}}function il(rt){const at=rt.prev,Tt=rt,$t=rt.next;if(ml(at,Tt,$t)>=0)return!1;const qt=at.x,Kt=Tt.x,ge=$t.x,Hr=at.y,wn=Tt.y,es=$t.y,ss=Math.min(qt,Kt,ge),os=Math.min(Hr,wn,es),cs=Math.max(qt,Kt,ge),ds=Math.max(Hr,wn,es);let Cs=$t.next;for(;Cs!==at;){if(Cs.x>=ss&&Cs.x<=cs&&Cs.y>=os&&Cs.y<=ds&&dl(qt,Hr,Kt,wn,ge,es,Cs.x,Cs.y)&&ml(Cs.prev,Cs,Cs.next)>=0)return!1;Cs=Cs.next}return!0}function sl(rt,at,Tt,$t){const qt=rt.prev,Kt=rt,ge=rt.next;if(ml(qt,Kt,ge)>=0)return!1;const Hr=qt.x,wn=Kt.x,es=ge.x,ss=qt.y,os=Kt.y,cs=ge.y,ds=Math.min(Hr,wn,es),Cs=Math.min(ss,os,cs),Vs=Math.max(Hr,wn,es),Eo=Math.max(ss,os,cs),Do=hl(ds,Cs,at,Tt,$t),Ho=hl(Vs,Eo,at,Tt,$t);let Ea=rt.prevZ,La=rt.nextZ;for(;Ea&&Ea.z>=Do&&La&&La.z<=Ho;){if(Ea.x>=ds&&Ea.x<=Vs&&Ea.y>=Cs&&Ea.y<=Eo&&Ea!==qt&&Ea!==ge&&dl(Hr,ss,wn,os,es,cs,Ea.x,Ea.y)&&ml(Ea.prev,Ea,Ea.next)>=0)return!1;if(Ea=Ea.prevZ,La.x>=ds&&La.x<=Vs&&La.y>=Cs&&La.y<=Eo&&La!==qt&&La!==ge&&dl(Hr,ss,wn,os,es,cs,La.x,La.y)&&ml(La.prev,La,La.next)>=0)return!1;La=La.nextZ}for(;Ea&&Ea.z>=Do;){if(Ea.x>=ds&&Ea.x<=Vs&&Ea.y>=Cs&&Ea.y<=Eo&&Ea!==qt&&Ea!==ge&&dl(Hr,ss,wn,os,es,cs,Ea.x,Ea.y)&&ml(Ea.prev,Ea,Ea.next)>=0)return!1;Ea=Ea.prevZ}for(;La&&La.z<=Ho;){if(La.x>=ds&&La.x<=Vs&&La.y>=Cs&&La.y<=Eo&&La!==qt&&La!==ge&&dl(Hr,ss,wn,os,es,cs,La.x,La.y)&&ml(La.prev,La,La.next)>=0)return!1;La=La.nextZ}return!0}function al(rt,at){let Tt=rt;do{const $t=Tt.prev,qt=Tt.next.next;!gl($t,qt)&&xl($t,Tt,Tt.next,qt)&&wl($t,qt)&&wl(qt,$t)&&(at.push($t.i,Tt.i,qt.i),Al(Tt),Al(Tt.next),Tt=rt=qt),Tt=Tt.next}while(Tt!==rt);return rl(Tt)}function ol(rt,at,Tt,$t,qt,Kt){let ge=rt;do{let rt=ge.next.next;for(;rt!==ge.prev;){if(ge.i!==rt.i&&yl(ge,rt)){let Hr=_l(ge,rt);return ge=rl(ge,ge.next),Hr=rl(Hr,Hr.next),nl(ge,at,Tt,$t,qt,Kt,0),void nl(Hr,at,Tt,$t,qt,Kt,0)}rt=rt.next}ge=ge.next}while(ge!==rt)}function ll(rt,at){let Tt=rt.x-at.x;return 0===Tt&&(Tt=rt.y-at.y,0===Tt)&&(Tt=(rt.next.y-rt.y)/(rt.next.x-rt.x)-(at.next.y-at.y)/(at.next.x-at.x)),Tt}function ul(rt,at){const Tt=function(rt,at){let Tt=at;const $t=rt.x,qt=rt.y;let Kt,ge=-1/0;if(gl(rt,Tt))return Tt;do{if(gl(rt,Tt.next))return Tt.next;if(qt<=Tt.y&&qt>=Tt.next.y&&Tt.next.y!==Tt.y){const rt=Tt.x+(qt-Tt.y)*(Tt.next.x-Tt.x)/(Tt.next.y-Tt.y);if(rt<=$t&&rt>ge&&(ge=rt,Kt=Tt.x<Tt.next.x?Tt:Tt.next,rt===$t))return Kt}Tt=Tt.next}while(Tt!==at);if(!Kt)return null;const Hr=Kt,wn=Kt.x,es=Kt.y;let ss=1/0;Tt=Kt;do{if($t>=Tt.x&&Tt.x>=wn&&$t!==Tt.x&&fl(qt<es?$t:ge,qt,wn,es,qt<es?ge:$t,qt,Tt.x,Tt.y)){const at=Math.abs(qt-Tt.y)/($t-Tt.x);wl(Tt,rt)&&(at<ss||at===ss&&(Tt.x>Kt.x||Tt.x===Kt.x&&cl(Kt,Tt)))&&(Kt=Tt,ss=at)}Tt=Tt.next}while(Tt!==Hr);return Kt}(rt,at);if(!Tt)return at;const $t=_l(Tt,rt);return rl($t,$t.next),rl(Tt,Tt.next)}function cl(rt,at){return ml(rt.prev,rt,at.prev)<0&&ml(at.next,rt,rt.next)<0}function hl(rt,at,Tt,$t,qt){return(rt=1431655765&((rt=858993459&((rt=252645135&((rt=16711935&((rt=(rt-Tt)*qt|0)|rt<<8))|rt<<4))|rt<<2))|rt<<1))|(at=1431655765&((at=858993459&((at=252645135&((at=16711935&((at=(at-$t)*qt|0)|at<<8))|at<<4))|at<<2))|at<<1))<<1}function pl(rt){let at=rt,Tt=rt;do{(at.x<Tt.x||at.x===Tt.x&&at.y<Tt.y)&&(Tt=at),at=at.next}while(at!==rt);return Tt}function fl(rt,at,Tt,$t,qt,Kt,ge,Hr){return(qt-ge)*(at-Hr)>=(rt-ge)*(Kt-Hr)&&(rt-ge)*($t-Hr)>=(Tt-ge)*(at-Hr)&&(Tt-ge)*(Kt-Hr)>=(qt-ge)*($t-Hr)}function dl(rt,at,Tt,$t,qt,Kt,ge,Hr){return!(rt===ge&&at===Hr)&&fl(rt,at,Tt,$t,qt,Kt,ge,Hr)}function yl(rt,at){return rt.next.i!==at.i&&rt.prev.i!==at.i&&!function(rt,at){let Tt=rt;do{if(Tt.i!==rt.i&&Tt.next.i!==rt.i&&Tt.i!==at.i&&Tt.next.i!==at.i&&xl(Tt,Tt.next,rt,at))return!0;Tt=Tt.next}while(Tt!==rt);return!1}(rt,at)&&(wl(rt,at)&&wl(at,rt)&&function(rt,at){let Tt=rt,$t=!1;const qt=(rt.x+at.x)/2,Kt=(rt.y+at.y)/2;do{Tt.y>Kt!=Tt.next.y>Kt&&Tt.next.y!==Tt.y&&qt<(Tt.next.x-Tt.x)*(Kt-Tt.y)/(Tt.next.y-Tt.y)+Tt.x&&($t=!$t),Tt=Tt.next}while(Tt!==rt);return $t}(rt,at)&&(ml(rt.prev,rt,at.prev)||ml(rt,at.prev,at))||gl(rt,at)&&ml(rt.prev,rt,rt.next)>0&&ml(at.prev,at,at.next)>0)}function ml(rt,at,Tt){return(at.y-rt.y)*(Tt.x-at.x)-(at.x-rt.x)*(Tt.y-at.y)}function gl(rt,at){return rt.x===at.x&&rt.y===at.y}function xl(rt,at,Tt,$t){const qt=bl(ml(rt,at,Tt)),Kt=bl(ml(rt,at,$t)),ge=bl(ml(Tt,$t,rt)),Hr=bl(ml(Tt,$t,at));return qt!==Kt&&ge!==Hr||!(0!==qt||!vl(rt,Tt,at))||!(0!==Kt||!vl(rt,$t,at))||!(0!==ge||!vl(Tt,rt,$t))||!(0!==Hr||!vl(Tt,at,$t))}function vl(rt,at,Tt){return at.x<=Math.max(rt.x,Tt.x)&&at.x>=Math.min(rt.x,Tt.x)&&at.y<=Math.max(rt.y,Tt.y)&&at.y>=Math.min(rt.y,Tt.y)}function bl(rt){return rt>0?1:rt<0?-1:0}function wl(rt,at){return ml(rt.prev,rt,rt.next)<0?ml(rt,at,rt.next)>=0&&ml(rt,rt.prev,at)>=0:ml(rt,at,rt.prev)<0||ml(rt,rt.next,at)<0}function _l(rt,at){const Tt=kl(rt.i,rt.x,rt.y),$t=kl(at.i,at.x,at.y),qt=rt.next,Kt=at.prev;return rt.next=at,at.prev=rt,Tt.next=qt,qt.prev=Tt,$t.next=Tt,Tt.prev=$t,Kt.next=$t,$t.prev=Kt,$t}function Sl(rt,at,Tt,$t){const qt=kl(rt,at,Tt);return $t?(qt.next=$t.next,qt.prev=$t,$t.next.prev=qt,$t.next=qt):(qt.prev=qt,qt.next=qt),qt}function Al(rt){rt.next.prev=rt.prev,rt.prev.next=rt.next,rt.prevZ&&(rt.prevZ.nextZ=rt.nextZ),rt.nextZ&&(rt.nextZ.prevZ=rt.prevZ)}function kl(rt,at,Tt){return{i:rt,x:at,y:Tt,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}class Ml{constructor(rt,at){if(at>rt)throw new Error("Min granularity must not be greater than base granularity.");this._baseZoomGranularity=rt,this._minGranularity=at}getGranularityForZoomLevel(rt){return Math.max(Math.floor(this._baseZoomGranularity/(1<<rt)),this._minGranularity,1)}}class Il{constructor(rt){this.fill=rt.fill,this.line=rt.line,this.tile=rt.tile,this.stencil=rt.stencil,this.circle=rt.circle}}Il.noSubdivision=new Il({fill:new Ml(0,0),line:new Ml(0,0),tile:new Ml(0,0),stencil:new Ml(0,0),circle:1}),Xi("SubdivisionGranularityExpression",Ml),Xi("SubdivisionGranularitySetting",Il);const yd=-32768,xd=32767;class Cl{constructor(rt,at){this._vertexBuffer=[],this._vertexDictionary=new Map,this._used=!1,this._granularity=rt,this._granularityCellSize=Vs/rt,this._canonical=at}_getKey(rt,at){return(rt+=32768)<<16|(at+=32768)}_vertexToIndex(rt,at){if(rt<-32768||at<-32768||rt>32767||at>32767)throw new Error("Vertex coordinates are out of signed 16 bit integer range.");const Tt=0|Math.round(rt),$t=0|Math.round(at),qt=this._getKey(Tt,$t);if(this._vertexDictionary.has(qt))return this._vertexDictionary.get(qt);const Kt=this._vertexBuffer.length/2;return this._vertexDictionary.set(qt,Kt),this._vertexBuffer.push(Tt,$t),Kt}_subdivideTrianglesScanline(rt){if(this._granularity<2)return function(rt,at){const Tt=[];for(let $t=0;$t<at.length;$t+=3){const qt=at[$t],Kt=at[$t+1],ge=at[$t+2],Hr=rt[2*qt],wn=rt[2*qt+1];(rt[2*Kt]-Hr)*(rt[2*ge+1]-wn)-(rt[2*Kt+1]-wn)*(rt[2*ge]-Hr)>0?(Tt.push(qt),Tt.push(ge),Tt.push(Kt)):(Tt.push(qt),Tt.push(Kt),Tt.push(ge))}return Tt}(this._vertexBuffer,rt);const at=[],Tt=rt.length;for(let $t=0;$t<Tt;$t+=3){const Tt=[rt[$t+0],rt[$t+1],rt[$t+2]],qt=[this._vertexBuffer[2*rt[$t+0]+0],this._vertexBuffer[2*rt[$t+0]+1],this._vertexBuffer[2*rt[$t+1]+0],this._vertexBuffer[2*rt[$t+1]+1],this._vertexBuffer[2*rt[$t+2]+0],this._vertexBuffer[2*rt[$t+2]+1]];let Kt=1/0,ge=1/0,Hr=-1/0,wn=-1/0;for(let rt=0;rt<3;rt++){const at=qt[2*rt],Tt=qt[2*rt+1];Kt=Math.min(Kt,at),Hr=Math.max(Hr,at),ge=Math.min(ge,Tt),wn=Math.max(wn,Tt)}if(Kt===Hr||ge===wn)continue;const es=Math.floor(Kt/this._granularityCellSize),ss=Math.ceil(Hr/this._granularityCellSize),os=Math.floor(ge/this._granularityCellSize),cs=Math.ceil(wn/this._granularityCellSize);if(es!==ss||os!==cs)for(let rt=os;rt<cs;rt++){const $t=this._scanlineGenerateVertexRingForCellRow(rt,qt,Tt);El(this._vertexBuffer,$t,at)}else at.push(...Tt)}return at}_scanlineGenerateVertexRingForCellRow(rt,at,Tt){const $t=rt*this._granularityCellSize,qt=$t+this._granularityCellSize,Kt=[];for(let rt=0;rt<3;rt++){const ge=at[2*rt],Hr=at[2*rt+1],wn=at[2*(rt+1)%6],es=at[(2*(rt+1)+1)%6],ss=at[2*(rt+2)%6],os=at[(2*(rt+2)+1)%6],cs=wn-ge,ds=es-Hr,Cs=0===cs,Vs=0===ds,Eo=($t-Hr)/ds,Do=(qt-Hr)/ds,Ho=Math.min(Eo,Do),Ea=Math.max(Eo,Do);if(!Vs&&(Ho>=1||Ea<=0)||Vs&&(Hr<$t||Hr>qt)){es>=$t&&es<=qt&&Kt.push(Tt[(rt+1)%3]);continue}!Vs&&Ho>0&&Kt.push(this._vertexToIndex(ge+cs*Ho,Hr+ds*Ho));const La=ge+cs*Math.max(Ho,0),ja=ge+cs*Math.min(Ea,1);Cs||this._generateIntraEdgeVertices(Kt,ge,Hr,wn,es,La,ja),!Vs&&Ea<1&&Kt.push(this._vertexToIndex(ge+cs*Ea,Hr+ds*Ea)),(Vs||es>=$t&&es<=qt)&&Kt.push(Tt[(rt+1)%3]),!Vs&&(es<=$t||es>=qt)&&this._generateInterEdgeVertices(Kt,ge,Hr,wn,es,ss,os,ja,$t,qt)}return Kt}_generateIntraEdgeVertices(rt,at,Tt,$t,qt,Kt,ge){const Hr=$t-at,wn=qt-Tt,es=0===wn,ss=es?Math.min(at,$t):Math.min(Kt,ge),os=es?Math.max(at,$t):Math.max(Kt,ge),cs=Math.floor(ss/this._granularityCellSize)+1,ds=Math.ceil(os/this._granularityCellSize)-1;if(es?at<$t:Kt<ge)for(let $t=cs;$t<=ds;$t++){const qt=$t*this._granularityCellSize;rt.push(this._vertexToIndex(qt,Tt+wn*(qt-at)/Hr))}else for(let $t=ds;$t>=cs;$t--){const qt=$t*this._granularityCellSize;rt.push(this._vertexToIndex(qt,Tt+wn*(qt-at)/Hr))}}_generateInterEdgeVertices(rt,at,Tt,$t,qt,Kt,ge,Hr,wn,es){const ss=qt-Tt,os=Kt-$t,cs=ge-qt,ds=(wn-qt)/cs,Cs=(es-qt)/cs,Vs=Math.min(ds,Cs),Eo=Math.max(ds,Cs),Do=$t+os*Vs;let Ho=Math.floor(Math.min(Do,Hr)/this._granularityCellSize)+1,Ea=Math.ceil(Math.max(Do,Hr)/this._granularityCellSize)-1,La=Hr<Do;const ja=0===cs;if(ja&&(ge===wn||ge===es))return;if(ja||Vs>=1||Eo<=0){const rt=Tt-ge,$t=Kt+(at-Kt)*Math.min((wn-ge)/rt,(es-ge)/rt);Ho=Math.floor(Math.min($t,Hr)/this._granularityCellSize)+1,Ea=Math.ceil(Math.max($t,Hr)/this._granularityCellSize)-1,La=Hr<$t}const Va=ss>0?es:wn;if(La)for(let at=Ho;at<=Ea;at++)rt.push(this._vertexToIndex(at*this._granularityCellSize,Va));else for(let at=Ea;at>=Ho;at--)rt.push(this._vertexToIndex(at*this._granularityCellSize,Va))}_generateOutline(rt){const at=[];for(const Tt of rt){const rt=Vl(Tt,this._granularity,!0),$t=this._pointArrayToIndices(rt),qt=[];for(let rt=1;rt<$t.length;rt++)qt.push($t[rt-1]),qt.push($t[rt]);at.push(qt)}return at}_handlePoles(rt){let at=!1,Tt=!1;this._canonical&&(0===this._canonical.y&&(at=!0),this._canonical.y===(1<<this._canonical.z)-1&&(Tt=!0)),(at||Tt)&&this._fillPoles(rt,at,Tt)}_ensureNoPoleVertices(){const rt=this._vertexBuffer;for(let at=0;at<rt.length;at+=2){const Tt=rt[at+1];Tt===yd&&(rt[at+1]=-32767),Tt===xd&&(rt[at+1]=32766)}}_generatePoleQuad(rt,at,Tt,$t,qt,Kt){$t>qt!=(Kt===yd)?(rt.push(at),rt.push(Tt),rt.push(this._vertexToIndex($t,Kt)),rt.push(Tt),rt.push(this._vertexToIndex(qt,Kt)),rt.push(this._vertexToIndex($t,Kt))):(rt.push(Tt),rt.push(at),rt.push(this._vertexToIndex($t,Kt)),rt.push(this._vertexToIndex(qt,Kt)),rt.push(Tt),rt.push(this._vertexToIndex($t,Kt)))}_fillPoles(rt,at,Tt){const $t=this._vertexBuffer,qt=Vs,Kt=rt.length;for(let ge=2;ge<Kt;ge+=3){const Kt=rt[ge-2],Hr=rt[ge-1],wn=rt[ge],es=$t[2*Kt],ss=$t[2*Kt+1],os=$t[2*Hr],cs=$t[2*Hr+1],ds=$t[2*wn],Cs=$t[2*wn+1];at&&(0===ss&&0===cs&&this._generatePoleQuad(rt,Kt,Hr,es,os,yd),0===cs&&0===Cs&&this._generatePoleQuad(rt,Hr,wn,os,ds,yd),0===Cs&&0===ss&&this._generatePoleQuad(rt,wn,Kt,ds,es,yd)),Tt&&(ss===qt&&cs===qt&&this._generatePoleQuad(rt,Kt,Hr,es,os,xd),cs===qt&&Cs===qt&&this._generatePoleQuad(rt,Hr,wn,os,ds,xd),Cs===qt&&ss===qt&&this._generatePoleQuad(rt,wn,Kt,ds,es,xd))}}_initializeVertices(rt){for(let at=0;at<rt.length;at+=2)this._vertexToIndex(rt[at],rt[at+1])}subdividePolygonInternal(rt,at){if(this._used)throw new Error("Subdivision: multiple use not allowed.");this._used=!0;const{flattened:Tt,holeIndices:$t}=function(rt){const at=[],Tt=[];for(const $t of rt)if(0!==$t.length){$t!==rt[0]&&at.push(Tt.length/2);for(let rt=0;rt<$t.length;rt++)Tt.push($t[rt].x),Tt.push($t[rt].y)}return{flattened:Tt,holeIndices:at}}(rt);let qt;this._initializeVertices(Tt);try{const rt=function(rt,at,Tt=2){const $t=at&&at.length,qt=$t?at[0]*Tt:rt.length;let Kt=el(rt,0,qt,Tt,!0);const ge=[];if(!Kt||Kt.next===Kt.prev)return ge;let Hr,wn,es;if($t&&(Kt=function(rt,at,Tt,$t){const qt=[];for(let Tt=0,Kt=at.length;Tt<Kt;Tt++){const ge=el(rt,at[Tt]*$t,Tt<Kt-1?at[Tt+1]*$t:rt.length,$t,!1);ge===ge.next&&(ge.steiner=!0),qt.push(pl(ge))}qt.sort(ll);for(let rt=0;rt<qt.length;rt++)Tt=ul(qt[rt],Tt);return Tt}(rt,at,Kt,Tt)),rt.length>80*Tt){Hr=1/0,wn=1/0;let at=-1/0,$t=-1/0;for(let Kt=Tt;Kt<qt;Kt+=Tt){const Tt=rt[Kt],qt=rt[Kt+1];Tt<Hr&&(Hr=Tt),qt<wn&&(wn=qt),Tt>at&&(at=Tt),qt>$t&&($t=qt)}es=Math.max(at-Hr,$t-wn),es=0!==es?32767/es:0}return nl(Kt,ge,Tt,Hr,wn,es,0),ge}(Tt,$t),at=this._convertIndices(Tt,rt);qt=this._subdivideTrianglesScanline(at)}catch(rt){console.error(rt)}let Kt=[];return at&&(Kt=this._generateOutline(rt)),this._ensureNoPoleVertices(),this._handlePoles(qt),{verticesFlattened:this._vertexBuffer,indicesTriangles:qt,indicesLineList:Kt}}_convertIndices(rt,at){const Tt=[];for(let $t=0;$t<at.length;$t++)Tt.push(this._vertexToIndex(rt[2*at[$t]],rt[2*at[$t]+1]));return Tt}_pointArrayToIndices(rt){const at=[];for(let Tt=0;Tt<rt.length;Tt++){const $t=rt[Tt];at.push(this._vertexToIndex($t.x,$t.y))}return at}}function Bl(rt,at,Tt,$t=!0){return new Cl(Tt,at).subdividePolygonInternal(rt,$t)}function Vl(rt,at,Tt=!1){if(!rt||rt.length<1)return[];if(rt.length<2)return[];const $t=rt[0],qt=rt[rt.length-1],Kt=Tt&&($t.x!==qt.x||$t.y!==qt.y);if(at<2)return Kt?[...rt,rt[0]]:[...rt];const Hr=Math.floor(Vs/at),wn=[];wn.push(new ge(rt[0].x,rt[0].y));const es=rt.length,ss=Kt?es:es-1;for(let at=0;at<ss;at++){const Tt=rt[at],$t=at<es-1?rt[at+1]:rt[0],qt=Tt.x,Kt=Tt.y,ss=$t.x,os=$t.y,cs=qt!==ss,ds=Kt!==os;if(!cs&&!ds)continue;const Cs=ss-qt,Vs=os-Kt,Eo=Math.abs(Cs),Do=Math.abs(Vs);let Ho=qt,Ea=Kt;for(;;){const rt=Cs>0?(Math.floor(Ho/Hr)+1)*Hr:(Math.ceil(Ho/Hr)-1)*Hr,at=Vs>0?(Math.floor(Ea/Hr)+1)*Hr:(Math.ceil(Ea/Hr)-1)*Hr,Tt=Math.abs(Ho-rt),$t=Math.abs(Ea-at),qt=Math.abs(Ho-ss),Kt=Math.abs(Ea-os),es=cs?Tt/Eo:Number.POSITIVE_INFINITY,La=ds?$t/Do:Number.POSITIVE_INFINITY;if((qt<=Tt||!cs)&&(Kt<=$t||!ds))break;if(es<La&&cs||!ds){Ho=rt,Ea+=Vs*es;const at=new ge(Ho,Math.round(Ea));wn[wn.length-1].x===at.x&&wn[wn.length-1].y===at.y||wn.push(at)}else{Ho+=Cs*La,Ea=at;const rt=new ge(Math.round(Ho),Ea);wn[wn.length-1].x===rt.x&&wn[wn.length-1].y===rt.y||wn.push(rt)}}const La=new ge(ss,os);wn[wn.length-1].x===La.x&&wn[wn.length-1].y===La.y||wn.push(La)}return wn}function El(rt,at,Tt){if(0===at.length)throw new Error("Subdivision vertex ring is empty.");let $t=0,qt=rt[2*at[0]];for(let Tt=1;Tt<at.length;Tt++){const Kt=rt[2*at[Tt]];Kt<qt&&(qt=Kt,$t=Tt)}const Kt=at.length;let ge=$t,Hr=(ge+1)%Kt;for(;;){const $t=ge-1>=0?ge-1:Kt-1,qt=(Hr+1)%Kt,wn=rt[2*at[$t]],es=rt[2*at[qt]],ss=rt[2*at[ge]],os=rt[2*at[ge]+1],cs=rt[2*at[Hr]+1];let ds=!1;if(wn<es)ds=!0;else if(wn>es)ds=!1;else{const Tt=cs-os,Kt=-(rt[2*at[Hr]]-ss),ge=os<cs?1:-1;((wn-ss)*Tt+(rt[2*at[$t]+1]-os)*Kt)*ge>((es-ss)*Tt+(rt[2*at[qt]+1]-os)*Kt)*ge&&(ds=!0)}if(ds){const rt=at[$t],qt=at[ge],wn=at[Hr];rt!==qt&&rt!==wn&&qt!==wn&&Tt.push(wn,qt,rt),ge--,ge<0&&(ge=Kt-1)}else{const rt=at[qt],$t=at[ge],wn=at[Hr];rt!==$t&&rt!==wn&&$t!==wn&&Tt.push(wn,$t,rt),Hr++,Hr>=Kt&&(Hr=0)}if($t===qt)break}}function Tl(rt,at,Tt,$t,qt,Kt,ge,Hr,wn){const es=qt.length/2,ss=ge&&Hr&&wn;if(es<Ta.MAX_VERTEX_ARRAY_LENGTH){const os=at.prepareSegment(es,Tt,$t),cs=os.vertexLength;for(let rt=0;rt<Kt.length;rt+=3)$t.emplaceBack(cs+Kt[rt],cs+Kt[rt+1],cs+Kt[rt+2]);let ds,Cs;os.vertexLength+=es,os.primitiveLength+=Kt.length/3,ss&&(Cs=ge.prepareSegment(es,Tt,Hr),ds=Cs.vertexLength,Cs.vertexLength+=es);for(let at=0;at<qt.length;at+=2)rt(qt[at],qt[at+1]);if(ss)for(let rt=0;rt<wn.length;rt++){const at=wn[rt];for(let rt=1;rt<at.length;rt+=2)Hr.emplaceBack(ds+at[rt-1],ds+at[rt]);Cs.primitiveLength+=at.length/2}}else!function(rt,at,Tt,$t,qt,Kt){const ge=[];for(let rt=0;rt<$t.length/2;rt++)ge.push(-1);const Hr={count:0};let wn=0,es=rt.getOrCreateLatestSegment(at,Tt),ss=es.vertexLength;for(let os=2;os<qt.length;os+=3){const cs=qt[os-2],ds=qt[os-1],Cs=qt[os];let Vs=ge[cs]<wn,Eo=ge[ds]<wn,Do=ge[Cs]<wn;es.vertexLength+((Vs?1:0)+(Eo?1:0)+(Do?1:0))>Ta.MAX_VERTEX_ARRAY_LENGTH&&(es=rt.createNewSegment(at,Tt),wn=Hr.count,Vs=!0,Eo=!0,Do=!0,ss=0);const Ho=Fl(ge,$t,Kt,Hr,cs,Vs,es),Ea=Fl(ge,$t,Kt,Hr,ds,Eo,es),La=Fl(ge,$t,Kt,Hr,Cs,Do,es);Tt.emplaceBack(ss+Ho-wn,ss+Ea-wn,ss+La-wn),es.primitiveLength++}}(at,Tt,$t,qt,Kt,rt),ss&&function(rt,at,Tt,$t,qt,Kt){const ge=[];for(let rt=0;rt<$t.length/2;rt++)ge.push(-1);const Hr={count:0};let wn=0,es=rt.getOrCreateLatestSegment(at,Tt),ss=es.vertexLength;for(let os=0;os<qt.length;os++){const cs=qt[os];for(let ds=1;ds<qt[os].length;ds+=2){const qt=cs[ds-1],os=cs[ds];let Cs=ge[qt]<wn,Vs=ge[os]<wn;es.vertexLength+((Cs?1:0)+(Vs?1:0))>Ta.MAX_VERTEX_ARRAY_LENGTH&&(es=rt.createNewSegment(at,Tt),wn=Hr.count,Cs=!0,Vs=!0,ss=0);const Eo=Fl(ge,$t,Kt,Hr,qt,Cs,es),Do=Fl(ge,$t,Kt,Hr,os,Vs,es);Tt.emplaceBack(ss+Eo-wn,ss+Do-wn),es.primitiveLength++}}}(ge,Tt,Hr,qt,wn,rt),at.forceNewSegmentOnNextPrepare(),null==ge||ge.forceNewSegmentOnNextPrepare()}function Fl(rt,at,Tt,$t,qt,Kt,ge){if(Kt){const Kt=$t.count;return Tt(at[2*qt],at[2*qt+1]),rt[qt]=$t.count,$t.count++,ge.vertexLength++,Kt}return rt[qt]}class $l{constructor(rt){this.zoom=rt.zoom,this.overscaling=rt.overscaling,this.layers=rt.layers,this.layerIds=this.layers.map((rt=>rt.id)),this.index=rt.index,this.hasPattern=!1,this.patternFeatures=[],this.layoutVertexArray=new ba,this.indexArray=new Ca,this.indexArray2=new Ba,this.programConfigurations=new oo(rt.layers,rt.zoom),this.segments=new Ta,this.segments2=new Ta,this.stateDependentLayerIds=this.layers.filter((rt=>rt.isStateDependent())).map((rt=>rt.id))}populate(rt,at,Tt){this.hasPattern=Qo("fill",this.layers,at);const $t=this.layers[0].layout.get("fill-sort-key"),qt=!$t.isConstant(),Kt=[];for(const{feature:ge,id:Hr,index:wn,sourceLayerIndex:es}of rt){const rt=this.layers[0]._featureFilter.needGeometry,ss=fo(ge,rt);if(!this.layers[0]._featureFilter.filter(new ys(this.zoom),ss,Tt))continue;const os=qt?$t.evaluate(ss,{},Tt,at.availableImages):void 0,cs={id:Hr,properties:ge.properties,type:ge.type,sourceLayerIndex:es,index:wn,geometry:rt?ss.geometry:po(ge),patterns:{},sortKey:os};Kt.push(cs)}qt&&Kt.sort(((rt,at)=>rt.sortKey-at.sortKey));for(const $t of Kt){const{geometry:qt,index:Kt,sourceLayerIndex:ge}=$t;if(this.hasPattern){const rt=tl("fill",this.layers,$t,this.zoom,at);this.patternFeatures.push(rt)}else this.addFeature($t,qt,Kt,Tt,{},at.subdivisionGranularity);at.featureIndex.insert(rt[Kt].feature,qt,Kt,ge,this.index)}}update(rt,at,Tt){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(rt,at,this.stateDependentLayers,Tt)}addFeatures(rt,at,Tt){for(const $t of this.patternFeatures)this.addFeature($t,$t.geometry,$t.index,at,Tt,rt.subdivisionGranularity)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(rt){this.uploaded||(this.layoutVertexBuffer=rt.createVertexBuffer(this.layoutVertexArray,gd),this.indexBuffer=rt.createIndexBuffer(this.indexArray),this.indexBuffer2=rt.createIndexBuffer(this.indexArray2)),this.programConfigurations.upload(rt),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.indexBuffer2.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.segments2.destroy())}addFeature(rt,at,Tt,$t,qt,Kt){for(const rt of Gr(at,500)){const at=Bl(rt,$t,Kt.fill.getGranularityForZoomLevel($t.z)),Tt=this.layoutVertexArray;Tl(((rt,at)=>{Tt.emplaceBack(rt,at)}),this.segments,this.layoutVertexArray,this.indexArray,at.verticesFlattened,at.indicesTriangles,this.segments2,this.indexArray2,at.indicesLineList)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,rt,Tt,qt,$t)}}let vd,bd;Xi("FillBucket",$l,{omit:["layers","patternFeatures"]});var wd={get paint(){return bd=bd||new Ps({"fill-antialias":new As(Dl.paint_fill["fill-antialias"]),"fill-opacity":new ks(Dl.paint_fill["fill-opacity"]),"fill-color":new ks(Dl.paint_fill["fill-color"]),"fill-outline-color":new ks(Dl.paint_fill["fill-outline-color"]),"fill-translate":new As(Dl.paint_fill["fill-translate"]),"fill-translate-anchor":new As(Dl.paint_fill["fill-translate-anchor"]),"fill-pattern":new Ms(Dl.paint_fill["fill-pattern"])})},get layout(){return vd=vd||new Ps({"fill-sort-key":new ks(Dl.layout_fill["fill-sort-key"])})}};class Rl extends Bs{constructor(rt){super(rt,wd)}recalculate(rt,at){super.recalculate(rt,at);const Tt=this.paint._values["fill-outline-color"];"constant"===Tt.value.kind&&void 0===Tt.value.value&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(rt){return new $l(rt)}queryRadius(){return Co(this.paint.get("fill-translate"))}queryIntersectsFeature({queryGeometry:rt,geometry:at,transform:Tt,pixelsToTileUnits:$t}){return bo(Bo(rt,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),-Tt.bearingInRadians,$t),at)}isTileClipped(){return!0}}const Td=Fs([{name:"a_pos",components:2,type:"Int16"},{name:"a_normal_ed",components:4,type:"Int16"}],4),Pd=Fs([{name:"a_centroid",components:2,type:"Int16"}],4),{members:Md}=Td;var Sd,Id,Cd,Ad,Ed,zd,kd,Dd={};function Wl(){if(Id)return Sd;Id=1;var at=s();function e(at,Tt,$t,qt,Kt){(this||rt).properties={},(this||rt).extent=$t,(this||rt).type=0,(this||rt)._pbf=at,(this||rt)._geometry=-1,(this||rt)._keys=qt,(this||rt)._values=Kt,at.readFields(r,this||rt,Tt)}function r(rt,at,Tt){1==rt?at.id=Tt.readVarint():2==rt?function(rt,at){for(var Tt=rt.readVarint()+rt.pos;rt.pos<Tt;){var $t=at._keys[rt.readVarint()],qt=at._values[rt.readVarint()];at.properties[$t]=qt}}(Tt,at):3==rt?at.type=Tt.readVarint():4==rt&&(at._geometry=Tt.pos)}function n(rt){for(var at,Tt,$t=0,qt=0,Kt=rt.length,ge=Kt-1;qt<Kt;ge=qt++)$t+=((Tt=rt[ge]).x-(at=rt[qt]).x)*(at.y+Tt.y);return $t}return Sd=e,e.types=["Unknown","Point","LineString","Polygon"],e.prototype.loadGeometry=function(){var Tt=(this||rt)._pbf;Tt.pos=(this||rt)._geometry;for(var $t,qt=Tt.readVarint()+Tt.pos,Kt=1,ge=0,Hr=0,wn=0,es=[];Tt.pos<qt;){if(ge<=0){var ss=Tt.readVarint();Kt=7&ss,ge=ss>>3}if(ge--,1===Kt||2===Kt)Hr+=Tt.readSVarint(),wn+=Tt.readSVarint(),1===Kt&&($t&&es.push($t),$t=[]),$t.push(new at(Hr,wn));else{if(7!==Kt)throw new Error("unknown command "+Kt);$t&&$t.push($t[0].clone())}}return $t&&es.push($t),es},e.prototype.bbox=function(){var at=(this||rt)._pbf;at.pos=(this||rt)._geometry;for(var Tt=at.readVarint()+at.pos,$t=1,qt=0,Kt=0,ge=0,Hr=1/0,wn=-1/0,es=1/0,ss=-1/0;at.pos<Tt;){if(qt<=0){var os=at.readVarint();$t=7&os,qt=os>>3}if(qt--,1===$t||2===$t)(Kt+=at.readSVarint())<Hr&&(Hr=Kt),Kt>wn&&(wn=Kt),(ge+=at.readSVarint())<es&&(es=ge),ge>ss&&(ss=ge);else if(7!==$t)throw new Error("unknown command "+$t)}return[Hr,es,wn,ss]},e.prototype.toGeoJSON=function(at,Tt,$t){var qt,Kt,ge=(this||rt).extent*Math.pow(2,$t),Hr=(this||rt).extent*at,wn=(this||rt).extent*Tt,es=this.loadGeometry(),ss=e.types[(this||rt).type];function p(rt){for(var at=0;at<rt.length;at++){var Tt=rt[at];rt[at]=[360*(Tt.x+Hr)/ge-180,360/Math.PI*Math.atan(Math.exp((180-360*(Tt.y+wn)/ge)*Math.PI/180))-90]}}switch((this||rt).type){case 1:var os=[];for(qt=0;qt<es.length;qt++)os[qt]=es[qt][0];p(es=os);break;case 2:for(qt=0;qt<es.length;qt++)p(es[qt]);break;case 3:for(es=function(rt){var at=rt.length;if(at<=1)return[rt];for(var Tt,$t,qt=[],Kt=0;Kt<at;Kt++){var ge=n(rt[Kt]);0!==ge&&(void 0===$t&&($t=ge<0),$t===ge<0?(Tt&&qt.push(Tt),Tt=[rt[Kt]]):Tt.push(rt[Kt]))}return Tt&&qt.push(Tt),qt}(es),qt=0;qt<es.length;qt++)for(Kt=0;Kt<es[qt].length;Kt++)p(es[qt][Kt])}1===es.length?es=es[0]:ss="Multi"+ss;var cs={type:"Feature",geometry:{type:ss,coordinates:es},properties:(this||rt).properties};return"id"in(this||rt)&&(cs.id=(this||rt).id),cs},Sd}function Ql(){if(Ad)return Cd;Ad=1;var at=Wl();function e(at,Tt){(this||rt).version=1,(this||rt).name=null,(this||rt).extent=4096,(this||rt).length=0,(this||rt)._pbf=at,(this||rt)._keys=[],(this||rt)._values=[],(this||rt)._features=[],at.readFields(r,this||rt,Tt),(this||rt).length=(this||rt)._features.length}function r(rt,at,Tt){15===rt?at.version=Tt.readVarint():1===rt?at.name=Tt.readString():5===rt?at.extent=Tt.readVarint():2===rt?at._features.push(Tt.pos):3===rt?at._keys.push(Tt.readString()):4===rt&&at._values.push(function(rt){for(var at=null,Tt=rt.readVarint()+rt.pos;rt.pos<Tt;){var $t=rt.readVarint()>>3;at=1===$t?rt.readString():2===$t?rt.readFloat():3===$t?rt.readDouble():4===$t?rt.readVarint64():5===$t?rt.readVarint():6===$t?rt.readSVarint():7===$t?rt.readBoolean():null}return at}(Tt))}return Cd=e,e.prototype.feature=function(Tt){if(Tt<0||Tt>=(this||rt)._features.length)throw new Error("feature index out of bounds");(this||rt)._pbf.pos=(this||rt)._features[Tt];var $t=(this||rt)._pbf.readVarint()+(this||rt)._pbf.pos;return new at((this||rt)._pbf,$t,(this||rt).extent,(this||rt)._keys,(this||rt)._values)},Cd}function tu(){return kd||(kd=1,Dd.VectorTile=function(){if(zd)return Ed;zd=1;var at=Ql();function e(rt,Tt,$t){if(3===rt){var qt=new at($t,$t.readVarint()+$t.pos);qt.length&&(Tt[qt.name]=qt)}}return Ed=function(at,Tt){(this||rt).layers=at.readFields(e,{},Tt)},Ed}(),Dd.VectorTileFeature=Wl(),Dd.VectorTileLayer=Ql()),Dd}var Rd=r(tu());const Ld=Rd.VectorTileFeature.types,Fd=Math.pow(2,13);function iu(rt,at,Tt,$t,qt,Kt,ge,Hr){rt.emplaceBack(at,Tt,2*Math.floor($t*Fd)+ge,qt*Fd*2,Kt*Fd*2,Math.round(Hr))}class su{constructor(rt){this.zoom=rt.zoom,this.overscaling=rt.overscaling,this.layers=rt.layers,this.layerIds=this.layers.map((rt=>rt.id)),this.index=rt.index,this.hasPattern=!1,this.layoutVertexArray=new wa,this.centroidVertexArray=new xa,this.indexArray=new Ca,this.programConfigurations=new oo(rt.layers,rt.zoom),this.segments=new Ta,this.stateDependentLayerIds=this.layers.filter((rt=>rt.isStateDependent())).map((rt=>rt.id))}populate(rt,at,Tt){this.features=[],this.hasPattern=Qo("fill-extrusion",this.layers,at);for(const{feature:$t,id:qt,index:Kt,sourceLayerIndex:ge}of rt){const rt=this.layers[0]._featureFilter.needGeometry,Hr=fo($t,rt);if(!this.layers[0]._featureFilter.filter(new ys(this.zoom),Hr,Tt))continue;const wn={id:qt,sourceLayerIndex:ge,index:Kt,geometry:rt?Hr.geometry:po($t),properties:$t.properties,type:$t.type,patterns:{}};this.hasPattern?this.features.push(tl("fill-extrusion",this.layers,wn,this.zoom,at)):this.addFeature(wn,wn.geometry,Kt,Tt,{},at.subdivisionGranularity),at.featureIndex.insert($t,wn.geometry,Kt,ge,this.index,!0)}}addFeatures(rt,at,Tt){for(const $t of this.features){const{geometry:qt}=$t;this.addFeature($t,qt,$t.index,at,Tt,rt.subdivisionGranularity)}}update(rt,at,Tt){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(rt,at,this.stateDependentLayers,Tt)}isEmpty(){return 0===this.layoutVertexArray.length&&0===this.centroidVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(rt){this.uploaded||(this.layoutVertexBuffer=rt.createVertexBuffer(this.layoutVertexArray,Md),this.centroidVertexBuffer=rt.createVertexBuffer(this.centroidVertexArray,Pd.members,!0),this.indexBuffer=rt.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(rt),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.centroidVertexBuffer.destroy())}addFeature(rt,at,Tt,$t,qt,Kt){for(const Tt of Gr(at,500)){const at={x:0,y:0,sampleCount:0},qt=this.layoutVertexArray.length;this.processPolygon(at,$t,rt,Tt,Kt);const ge=this.layoutVertexArray.length-qt,Hr=Math.floor(at.x/at.sampleCount),wn=Math.floor(at.y/at.sampleCount);for(let rt=0;rt<ge;rt++)this.centroidVertexArray.emplaceBack(Hr,wn)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,rt,Tt,qt,$t)}processPolygon(rt,at,Tt,$t,qt){if($t.length<1)return;if(lu($t[0]))return;for(const at of $t)0!==at.length&&au(rt,at);const Kt={segment:this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray)},ge=qt.fill.getGranularityForZoomLevel(at.z),Hr="Polygon"===Ld[Tt.type];for(const rt of $t){if(0===rt.length)continue;if(lu(rt))continue;const at=Vl(rt,ge,Hr);this._generateSideFaces(at,Kt)}if(!Hr)return;const wn=Bl($t,at,ge,!1),es=this.layoutVertexArray;Tl(((rt,at)=>{iu(es,rt,at,0,0,1,1,0)}),this.segments,this.layoutVertexArray,this.indexArray,wn.verticesFlattened,wn.indicesTriangles)}_generateSideFaces(rt,at){let Tt=0;for(let $t=1;$t<rt.length;$t++){const qt=rt[$t],Kt=rt[$t-1];if(ou(qt,Kt))continue;at.segment.vertexLength+4>Ta.MAX_VERTEX_ARRAY_LENGTH&&(at.segment=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray));const ge=qt.sub(Kt)._perp()._unit(),Hr=Kt.dist(qt);Tt+Hr>32768&&(Tt=0),iu(this.layoutVertexArray,qt.x,qt.y,ge.x,ge.y,0,0,Tt),iu(this.layoutVertexArray,qt.x,qt.y,ge.x,ge.y,0,1,Tt),Tt+=Hr,iu(this.layoutVertexArray,Kt.x,Kt.y,ge.x,ge.y,0,0,Tt),iu(this.layoutVertexArray,Kt.x,Kt.y,ge.x,ge.y,0,1,Tt);const wn=at.segment.vertexLength;this.indexArray.emplaceBack(wn,wn+2,wn+1),this.indexArray.emplaceBack(wn+1,wn+2,wn+3),at.segment.vertexLength+=4,at.segment.primitiveLength+=2}}}function au(rt,at){for(let Tt=0;Tt<at.length;Tt++){const $t=at[Tt];Tt===at.length-1&&at[0].x===$t.x&&at[0].y===$t.y||(rt.x+=$t.x,rt.y+=$t.y,rt.sampleCount++)}}function ou(rt,at){return rt.x===at.x&&(rt.x<0||rt.x>Vs)||rt.y===at.y&&(rt.y<0||rt.y>Vs)}function lu(rt){return rt.every((rt=>rt.x<0))||rt.every((rt=>rt.x>Vs))||rt.every((rt=>rt.y<0))||rt.every((rt=>rt.y>Vs))}let Bd;Xi("FillExtrusionBucket",su,{omit:["layers","features"]});var Od={get paint(){return Bd=Bd||new Ps({"fill-extrusion-opacity":new As(Dl["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new ks(Dl["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new As(Dl["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new As(Dl["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new Ms(Dl["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-height":new ks(Dl["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new ks(Dl["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-vertical-gradient":new As(Dl["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"])})}};class hu extends Bs{constructor(rt){super(rt,Od)}createBucket(rt){return new su(rt)}queryRadius(){return Co(this.paint.get("fill-extrusion-translate"))}is3D(){return!0}queryIntersectsFeature({queryGeometry:rt,feature:at,featureState:Tt,geometry:$t,transform:qt,pixelsToTileUnits:Kt,pixelPosMatrix:Hr}){const wn=Bo(rt,this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),-qt.bearingInRadians,Kt),es=this.paint.get("fill-extrusion-height").evaluate(at,Tt),ss=this.paint.get("fill-extrusion-base").evaluate(at,Tt),os=function(rt,at){const Tt=[];for(const $t of rt){const rt=[$t.x,$t.y,0,1];A(rt,rt,at),Tt.push(new ge(rt[0]/rt[3],rt[1]/rt[3]))}return Tt}(wn,Hr),cs=function(rt,at,Tt,$t){const qt=[],Kt=[],Hr=$t[8]*at,wn=$t[9]*at,es=$t[10]*at,ss=$t[11]*at,os=$t[8]*Tt,cs=$t[9]*Tt,ds=$t[10]*Tt,Cs=$t[11]*Tt;for(const at of rt){const rt=[],Tt=[];for(const qt of at){const at=qt.x,Kt=qt.y,Vs=$t[0]*at+$t[4]*Kt+$t[12],Eo=$t[1]*at+$t[5]*Kt+$t[13],Do=$t[2]*at+$t[6]*Kt+$t[14],Ho=$t[3]*at+$t[7]*Kt+$t[15],Ea=Do+es,La=Ho+ss,ja=Vs+os,Va=Eo+cs,Na=Do+ds,qa=Ho+Cs,Qa=new ge((Vs+Hr)/La,(Eo+wn)/La);Qa.z=Ea/La,rt.push(Qa);const Pl=new ge(ja/qa,Va/qa);Pl.z=Na/qa,Tt.push(Pl)}qt.push(rt),Kt.push(Tt)}return[qt,Kt]}($t,ss,es,Hr);return function(rt,at,Tt){let $t=1/0;bo(Tt,at)&&($t=fu(Tt,at[0]));for(let qt=0;qt<at.length;qt++){const Kt=at[qt],ge=rt[qt];for(let rt=0;rt<Kt.length-1;rt++){const at=Kt[rt],qt=[at,Kt[rt+1],ge[rt+1],ge[rt],at];xo(Tt,qt)&&($t=Math.min($t,fu(Tt,qt)))}}return $t!==1/0&&$t}(cs[0],cs[1],os)}}function pu(rt,at){return rt.x*at.x+rt.y*at.y}function fu(rt,at){if(1===rt.length){let Tt=0;const $t=at[Tt++];let qt;for(;!qt||$t.equals(qt);)if(qt=at[Tt++],!qt)return 1/0;for(;Tt<at.length;Tt++){const Kt=at[Tt],ge=rt[0],Hr=qt.sub($t),wn=Kt.sub($t),es=ge.sub($t),ss=pu(Hr,Hr),os=pu(Hr,wn),cs=pu(wn,wn),ds=pu(es,Hr),Cs=pu(es,wn),Vs=ss*cs-os*os,Eo=(cs*ds-os*Cs)/Vs,Do=(ss*Cs-os*ds)/Vs,Ho=$t.z*(1-Eo-Do)+qt.z*Eo+Kt.z*Do;if(isFinite(Ho))return Ho}return 1/0}{let rt=1/0;for(const Tt of at)rt=Math.min(rt,Tt.z);return rt}}const jd=Fs([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"}],4),{members:Vd}=jd,Nd=Fs([{name:"a_uv_x",components:1,type:"Float32"},{name:"a_split_index",components:1,type:"Float32"}]),{members:Zd}=Nd,Ud=Rd.VectorTileFeature.types,$d=Math.cos(Math.PI/180*37.5),Gd=Math.pow(2,14)/.5;class wu{constructor(rt){this.zoom=rt.zoom,this.overscaling=rt.overscaling,this.layers=rt.layers,this.layerIds=this.layers.map((rt=>rt.id)),this.index=rt.index,this.hasPattern=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach((rt=>{this.gradients[rt.id]={}})),this.layoutVertexArray=new _a,this.layoutVertexArray2=new Sa,this.indexArray=new Ca,this.programConfigurations=new oo(rt.layers,rt.zoom),this.segments=new Ta,this.maxLineLength=0,this.stateDependentLayerIds=this.layers.filter((rt=>rt.isStateDependent())).map((rt=>rt.id))}populate(rt,at,Tt){this.hasPattern=Qo("line",this.layers,at);const $t=this.layers[0].layout.get("line-sort-key"),qt=!$t.isConstant(),Kt=[];for(const{feature:at,id:ge,index:Hr,sourceLayerIndex:wn}of rt){const rt=this.layers[0]._featureFilter.needGeometry,es=fo(at,rt);if(!this.layers[0]._featureFilter.filter(new ys(this.zoom),es,Tt))continue;const ss=qt?$t.evaluate(es,{},Tt):void 0,os={id:ge,properties:at.properties,type:at.type,sourceLayerIndex:wn,index:Hr,geometry:rt?es.geometry:po(at),patterns:{},sortKey:ss};Kt.push(os)}qt&&Kt.sort(((rt,at)=>rt.sortKey-at.sortKey));for(const $t of Kt){const{geometry:qt,index:Kt,sourceLayerIndex:ge}=$t;if(this.hasPattern){const rt=tl("line",this.layers,$t,this.zoom,at);this.patternFeatures.push(rt)}else this.addFeature($t,qt,Kt,Tt,{},at.subdivisionGranularity);at.featureIndex.insert(rt[Kt].feature,qt,Kt,ge,this.index)}}update(rt,at,Tt){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(rt,at,this.stateDependentLayers,Tt)}addFeatures(rt,at,Tt){for(const $t of this.patternFeatures)this.addFeature($t,$t.geometry,$t.index,at,Tt,rt.subdivisionGranularity)}isEmpty(){return 0===this.layoutVertexArray.length}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(rt){this.uploaded||(0!==this.layoutVertexArray2.length&&(this.layoutVertexBuffer2=rt.createVertexBuffer(this.layoutVertexArray2,Zd)),this.layoutVertexBuffer=rt.createVertexBuffer(this.layoutVertexArray,Vd),this.indexBuffer=rt.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(rt),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(rt){if(rt.properties&&Object.prototype.hasOwnProperty.call(rt.properties,"mapbox_clip_start")&&Object.prototype.hasOwnProperty.call(rt.properties,"mapbox_clip_end"))return{start:+rt.properties.mapbox_clip_start,end:+rt.properties.mapbox_clip_end}}addFeature(rt,at,Tt,$t,qt,Kt){const ge=this.layers[0].layout,Hr=ge.get("line-join").evaluate(rt,{}),wn=ge.get("line-cap"),es=ge.get("line-miter-limit"),ss=ge.get("line-round-limit");this.lineClips=this.lineFeatureClips(rt);for(const Tt of at)this.addLine(Tt,rt,Hr,wn,es,ss,$t,Kt);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,rt,Tt,qt,$t)}addLine(rt,at,Tt,$t,qt,Kt,ge,Hr){if(this.distance=0,this.scaledDistance=0,this.totalDistance=0,rt=Vl(rt,ge?Hr.line.getGranularityForZoomLevel(ge.z):1),this.lineClips){this.lineClipsArray.push(this.lineClips);for(let at=0;at<rt.length-1;at++)this.totalDistance+=rt[at].dist(rt[at+1]);this.updateScaledDistance(),this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}const wn="Polygon"===Ud[at.type];let es=rt.length;for(;es>=2&&rt[es-1].equals(rt[es-2]);)es--;let ss=0;for(;ss<es-1&&rt[ss].equals(rt[ss+1]);)ss++;if(es<(wn?3:2))return;"bevel"===Tt&&(qt=1.05);const os=this.overscaling<=16?15*Vs/(512*this.overscaling):0,cs=this.segments.prepareSegment(10*es,this.layoutVertexArray,this.indexArray);let ds,Cs,Eo,Do,Ho;this.e1=this.e2=-1,wn&&(ds=rt[es-2],Ho=rt[ss].sub(ds)._unit()._perp());for(let at=ss;at<es;at++){if(Eo=at===es-1?wn?rt[ss+1]:void 0:rt[at+1],Eo&&rt[at].equals(Eo))continue;Ho&&(Do=Ho),ds&&(Cs=ds),ds=rt[at],Ho=Eo?Eo.sub(ds)._unit()._perp():Do,Do=Do||Ho;let ge=Do.add(Ho);0===ge.x&&0===ge.y||ge._unit();const Hr=Do.x*Ho.x+Do.y*Ho.y,Vs=ge.x*Ho.x+ge.y*Ho.y,Ea=0!==Vs?1/Vs:1/0,La=2*Math.sqrt(2-2*Vs),ja=Vs<$d&&Cs&&Eo,Va=Do.x*Ho.y-Do.y*Ho.x>0;if(ja&&at>ss){const rt=ds.dist(Cs);if(rt>2*os){const at=ds.sub(ds.sub(Cs)._mult(os/rt)._round());this.updateDistance(Cs,at),this.addCurrentVertex(at,Do,0,0,cs),Cs=at}}const Na=Cs&&Eo;let qa=Na?Tt:wn?"butt":$t;if(Na&&"round"===qa&&(Ea<Kt?qa="miter":Ea<=2&&(qa="fakeround")),"miter"===qa&&Ea>qt&&(qa="bevel"),"bevel"===qa&&(Ea>2&&(qa="flipbevel"),Ea<qt&&(qa="miter")),Cs&&this.updateDistance(Cs,ds),"miter"===qa)ge._mult(Ea),this.addCurrentVertex(ds,ge,0,0,cs);else if("flipbevel"===qa){if(Ea>100)ge=Ho.mult(-1);else{const rt=Ea*Do.add(Ho).mag()/Do.sub(Ho).mag();ge._perp()._mult(rt*(Va?-1:1))}this.addCurrentVertex(ds,ge,0,0,cs),this.addCurrentVertex(ds,ge.mult(-1),0,0,cs)}else if("bevel"===qa||"fakeround"===qa){const rt=-Math.sqrt(Ea*Ea-1),at=Va?rt:0,Tt=Va?0:rt;if(Cs&&this.addCurrentVertex(ds,Do,at,Tt,cs),"fakeround"===qa){const rt=Math.round(180*La/Math.PI/20);for(let at=1;at<rt;at++){let Tt=at/rt;if(.5!==Tt){const rt=Tt-.5;Tt+=Tt*rt*(Tt-1)*((1.0904+Hr*(Hr*(3.55645-1.43519*Hr)-3.2452))*rt*rt+(.848013+Hr*(.215638*Hr-1.06021)))}const $t=Ho.sub(Do)._mult(Tt)._add(Do)._unit()._mult(Va?-1:1);this.addHalfVertex(ds,$t.x,$t.y,!1,Va,0,cs)}}Eo&&this.addCurrentVertex(ds,Ho,-at,-Tt,cs)}else if("butt"===qa)this.addCurrentVertex(ds,ge,0,0,cs);else if("square"===qa){const rt=Cs?1:-1;this.addCurrentVertex(ds,ge,rt,rt,cs)}else"round"===qa&&(Cs&&(this.addCurrentVertex(ds,Do,0,0,cs),this.addCurrentVertex(ds,Do,1,1,cs,!0)),Eo&&(this.addCurrentVertex(ds,Ho,-1,-1,cs,!0),this.addCurrentVertex(ds,Ho,0,0,cs)));if(ja&&at<es-1){const rt=ds.dist(Eo);if(rt>2*os){const at=ds.add(Eo.sub(ds)._mult(os/rt)._round());this.updateDistance(ds,at),this.addCurrentVertex(at,Ho,0,0,cs),ds=at}}}}addCurrentVertex(rt,at,Tt,$t,qt,Kt=!1){const ge=at.y*$t-at.x,Hr=-at.y-at.x*$t;this.addHalfVertex(rt,at.x+at.y*Tt,at.y-at.x*Tt,Kt,!1,Tt,qt),this.addHalfVertex(rt,ge,Hr,Kt,!0,-$t,qt),this.distance>Gd/2&&0===this.totalDistance&&(this.distance=0,this.updateScaledDistance(),this.addCurrentVertex(rt,at,Tt,$t,qt,Kt))}addHalfVertex({x:rt,y:at},Tt,$t,qt,Kt,ge,Hr){const wn=.5*(this.lineClips?this.scaledDistance*(Gd-1):this.scaledDistance);this.layoutVertexArray.emplaceBack((rt<<1)+(qt?1:0),(at<<1)+(Kt?1:0),Math.round(63*Tt)+128,Math.round(63*$t)+128,1+(0===ge?0:ge<0?-1:1)|(63&wn)<<2,wn>>6),this.lineClips&&this.layoutVertexArray2.emplaceBack((this.scaledDistance-this.lineClips.start)/(this.lineClips.end-this.lineClips.start),this.lineClipsArray.length);const es=Hr.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,es,this.e2),Hr.primitiveLength++),Kt?this.e2=es:this.e1=es}updateScaledDistance(){this.scaledDistance=this.lineClips?this.lineClips.start+(this.lineClips.end-this.lineClips.start)*this.distance/this.totalDistance:this.distance}updateDistance(rt,at){this.distance+=rt.dist(at),this.updateScaledDistance()}}let qd,Wd;Xi("LineBucket",wu,{omit:["layers","patternFeatures"]});var Hd={get paint(){return Wd=Wd||new Ps({"line-opacity":new ks(Dl.paint_line["line-opacity"]),"line-color":new ks(Dl.paint_line["line-color"]),"line-translate":new As(Dl.paint_line["line-translate"]),"line-translate-anchor":new As(Dl.paint_line["line-translate-anchor"]),"line-width":new ks(Dl.paint_line["line-width"]),"line-gap-width":new ks(Dl.paint_line["line-gap-width"]),"line-offset":new ks(Dl.paint_line["line-offset"]),"line-blur":new ks(Dl.paint_line["line-blur"]),"line-dasharray":new Is(Dl.paint_line["line-dasharray"]),"line-pattern":new Ms(Dl.paint_line["line-pattern"]),"line-gradient":new zs(Dl.paint_line["line-gradient"])})},get layout(){return qd=qd||new Ps({"line-cap":new As(Dl.layout_line["line-cap"]),"line-join":new ks(Dl.layout_line["line-join"]),"line-miter-limit":new As(Dl.layout_line["line-miter-limit"]),"line-round-limit":new As(Dl.layout_line["line-round-limit"]),"line-sort-key":new ks(Dl.layout_line["line-sort-key"])})}};class ku extends ks{possiblyEvaluate(rt,at){return at=new ys(Math.floor(at.zoom),{now:at.now,fadeDuration:at.fadeDuration,zoomHistory:at.zoomHistory,transition:at.transition}),super.possiblyEvaluate(rt,at)}evaluate(rt,at,Tt,$t){return at=L({},at,{zoom:Math.floor(at.zoom)}),super.evaluate(rt,at,Tt,$t)}}let Xd;class Iu extends Bs{constructor(rt){super(rt,Hd),this.gradientVersion=0,Xd||(Xd=new ku(Hd.paint.properties["line-width"].specification),Xd.useIntegerZoom=!0)}_handleSpecialPaintPropertyUpdate(rt){if("line-gradient"===rt){const rt=this.gradientExpression();this.stepInterpolant=!!function(rt){return void 0!==rt._styleExpression}(rt)&&rt._styleExpression.expression instanceof We,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}recalculate(rt,at){super.recalculate(rt,at),this.paint._values["line-floorwidth"]=Xd.possiblyEvaluate(this._transitioningPaint._values["line-width"].value,rt)}createBucket(rt){return new wu(rt)}queryRadius(rt){const at=rt,Tt=zu(Po("line-width",this,at),Po("line-gap-width",this,at)),$t=Po("line-offset",this,at);return Tt/2+Math.abs($t)+Co(this.paint.get("line-translate"))}queryIntersectsFeature({queryGeometry:rt,feature:at,featureState:Tt,geometry:$t,transform:qt,pixelsToTileUnits:Kt}){const Hr=Bo(rt,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),-qt.bearingInRadians,Kt),wn=Kt/2*zu(this.paint.get("line-width").evaluate(at,Tt),this.paint.get("line-gap-width").evaluate(at,Tt)),es=this.paint.get("line-offset").evaluate(at,Tt);return es&&($t=function(rt,at){const Tt=[];for(let $t=0;$t<rt.length;$t++){const qt=rt[$t],Kt=[];for(let rt=0;rt<qt.length;rt++){const Tt=qt[rt-1],$t=qt[rt],Hr=qt[rt+1],wn=0===rt?new ge(0,0):$t.sub(Tt)._unit()._perp(),es=rt===qt.length-1?new ge(0,0):Hr.sub($t)._unit()._perp(),ss=wn._add(es)._unit(),os=ss.x*es.x+ss.y*es.y;0!==os&&ss._mult(1/os),Kt.push(ss._mult(at)._add($t))}Tt.push(Kt)}return Tt}($t,es*Kt)),function(rt,at,Tt){for(let $t=0;$t<at.length;$t++){const qt=at[$t];if(rt.length>=3)for(let at=0;at<qt.length;at++)if(Io(rt,qt[at]))return!0;if(wo(rt,qt,Tt))return!0}return!1}(Hr,$t,wn)}isTileClipped(){return!0}}function zu(rt,at){return at>0?at+2*rt:rt}const Kd=Fs([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_data",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),Yd=Fs([{name:"a_projected_pos",components:3,type:"Float32"}],4);Fs([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const Jd=Fs([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"},{name:"a_box_real",components:2,type:"Int16"}]);Fs([{type:"Int16",name:"anchorPointX"},{type:"Int16",name:"anchorPointY"},{type:"Int16",name:"x1"},{type:"Int16",name:"y1"},{type:"Int16",name:"x2"},{type:"Int16",name:"y2"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const Qd=Fs([{name:"a_pos",components:2,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),ep=Fs([{name:"a_pos",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);function Tu(rt,at,Tt){return rt.sections.forEach((rt=>{rt.text=function(rt,at,Tt){const $t=at.layout.get("text-transform").evaluate(Tt,{});return"uppercase"===$t?rt=rt.toLocaleUpperCase():"lowercase"===$t&&(rt=rt.toLocaleLowerCase()),Fu.applyArabicShaping&&(rt=Fu.applyArabicShaping(rt)),rt}(rt.text,at,Tt)})),rt}Fs([{name:"triangle",components:3,type:"Uint16"}]),Fs([{type:"Int16",name:"anchorX"},{type:"Int16",name:"anchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"}]),Fs([{type:"Int16",name:"anchorX"},{type:"Int16",name:"anchorY"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",name:"textBoxScale"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Uint16",name:"textAnchorOffsetStartIndex"},{type:"Uint16",name:"textAnchorOffsetEndIndex"}]),Fs([{type:"Float32",name:"offsetX"}]),Fs([{type:"Int16",name:"x"},{type:"Int16",name:"y"},{type:"Int16",name:"tileUnitDistanceFromAnchor"}]),Fs([{type:"Uint16",name:"textAnchor"},{type:"Float32",components:2,name:"textOffset"}]);const ip={"!":"","#":"",$:"","%":"","&":"","(":"",")":"","*":"","+":"",",":"","-":"",".":"","/":"",":":"",";":"","<":"","=":"",">":"","?":"","@":"","[":"","\\":"","]":"","^":"",_:"","`":"","{":"","|":"","}":"","~":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":""};var rp,np,sp,op=24,ap={};function ju(){return rp||(rp=1,ap.read=function(rt,at,Tt,$t,qt){var Kt,ge,Hr=8*qt-$t-1,wn=(1<<Hr)-1,es=wn>>1,ss=-7,os=Tt?qt-1:0,cs=Tt?-1:1,ds=rt[at+os];for(os+=cs,Kt=ds&(1<<-ss)-1,ds>>=-ss,ss+=Hr;ss>0;Kt=256*Kt+rt[at+os],os+=cs,ss-=8);for(ge=Kt&(1<<-ss)-1,Kt>>=-ss,ss+=$t;ss>0;ge=256*ge+rt[at+os],os+=cs,ss-=8);if(0===Kt)Kt=1-es;else{if(Kt===wn)return ge?NaN:1/0*(ds?-1:1);ge+=Math.pow(2,$t),Kt-=es}return(ds?-1:1)*ge*Math.pow(2,Kt-$t)},ap.write=function(rt,at,Tt,$t,qt,Kt){var ge,Hr,wn,es=8*Kt-qt-1,ss=(1<<es)-1,os=ss>>1,cs=23===qt?Math.pow(2,-24)-Math.pow(2,-77):0,ds=$t?0:Kt-1,Cs=$t?1:-1,Vs=at<0||0===at&&1/at<0?1:0;for(at=Math.abs(at),isNaN(at)||at===1/0?(Hr=isNaN(at)?1:0,ge=ss):(ge=Math.floor(Math.log(at)/Math.LN2),at*(wn=Math.pow(2,-ge))<1&&(ge--,wn*=2),(at+=ge+os>=1?cs/wn:cs*Math.pow(2,1-os))*wn>=2&&(ge++,wn/=2),ge+os>=ss?(Hr=0,ge=ss):ge+os>=1?(Hr=(at*wn-1)*Math.pow(2,qt),ge+=os):(Hr=at*Math.pow(2,os-1)*Math.pow(2,qt),ge=0));qt>=8;rt[Tt+ds]=255&Hr,ds+=Cs,Hr/=256,qt-=8);for(ge=ge<<qt|Hr,es+=qt;es>0;rt[Tt+ds]=255&ge,ds+=Cs,ge/=256,es-=8);rt[Tt+ds-Cs]|=128*Vs}),ap}function Nu(){if(sp)return np;sp=1,np=e;var at=ju();function e(at){(this||rt).buf=ArrayBuffer.isView&&ArrayBuffer.isView(at)?at:new Uint8Array(at||0),(this||rt).pos=0,(this||rt).type=0,(this||rt).length=(this||rt).buf.length}e.Varint=0,e.Fixed64=1,e.Bytes=2,e.Fixed32=5;var Tt=4294967296,$t=1/Tt,qt="undefined"==typeof TextDecoder?null:new TextDecoder("utf-8");function s(rt){return rt.type===e.Bytes?rt.readVarint()+rt.pos:rt.pos+1}function a(rt,at,Tt){return Tt?4294967296*at+(rt>>>0):4294967296*(at>>>0)+(rt>>>0)}function o(rt,at,Tt){var $t=at<=16383?1:at<=2097151?2:at<=268435455?3:Math.floor(Math.log(at)/(7*Math.LN2));Tt.realloc($t);for(var qt=Tt.pos-1;qt>=rt;qt--)Tt.buf[qt+$t]=Tt.buf[qt]}function l(rt,at){for(var Tt=0;Tt<rt.length;Tt++)at.writeVarint(rt[Tt])}function u(rt,at){for(var Tt=0;Tt<rt.length;Tt++)at.writeSVarint(rt[Tt])}function c(rt,at){for(var Tt=0;Tt<rt.length;Tt++)at.writeFloat(rt[Tt])}function h(rt,at){for(var Tt=0;Tt<rt.length;Tt++)at.writeDouble(rt[Tt])}function p(rt,at){for(var Tt=0;Tt<rt.length;Tt++)at.writeBoolean(rt[Tt])}function f(rt,at){for(var Tt=0;Tt<rt.length;Tt++)at.writeFixed32(rt[Tt])}function d(rt,at){for(var Tt=0;Tt<rt.length;Tt++)at.writeSFixed32(rt[Tt])}function y(rt,at){for(var Tt=0;Tt<rt.length;Tt++)at.writeFixed64(rt[Tt])}function m(rt,at){for(var Tt=0;Tt<rt.length;Tt++)at.writeSFixed64(rt[Tt])}function g(rt,at){return(rt[at]|rt[at+1]<<8|rt[at+2]<<16)+16777216*rt[at+3]}function x(rt,at,Tt){rt[Tt]=at,rt[Tt+1]=at>>>8,rt[Tt+2]=at>>>16,rt[Tt+3]=at>>>24}function v(rt,at){return(rt[at]|rt[at+1]<<8|rt[at+2]<<16)+(rt[at+3]<<24)}return e.prototype={destroy:function(){(this||rt).buf=null},readFields:function(at,Tt,$t){for($t=$t||(this||rt).length;(this||rt).pos<$t;){var qt=this.readVarint(),Kt=qt>>3,ge=(this||rt).pos;(this||rt).type=7&qt,at(Kt,Tt,this||rt),(this||rt).pos===ge&&this.skip(qt)}return Tt},readMessage:function(at,Tt){return this.readFields(at,Tt,this.readVarint()+(this||rt).pos)},readFixed32:function(){var at=g((this||rt).buf,(this||rt).pos);return(this||rt).pos+=4,at},readSFixed32:function(){var at=v((this||rt).buf,(this||rt).pos);return(this||rt).pos+=4,at},readFixed64:function(){var at=g((this||rt).buf,(this||rt).pos)+g((this||rt).buf,(this||rt).pos+4)*Tt;return(this||rt).pos+=8,at},readSFixed64:function(){var at=g((this||rt).buf,(this||rt).pos)+v((this||rt).buf,(this||rt).pos+4)*Tt;return(this||rt).pos+=8,at},readFloat:function(){var Tt=at.read((this||rt).buf,(this||rt).pos,!0,23,4);return(this||rt).pos+=4,Tt},readDouble:function(){var Tt=at.read((this||rt).buf,(this||rt).pos,!0,52,8);return(this||rt).pos+=8,Tt},readVarint:function(at){var Tt,$t,qt=(this||rt).buf;return Tt=127&($t=qt[(this||rt).pos++]),$t<128?Tt:(Tt|=(127&($t=qt[(this||rt).pos++]))<<7,$t<128?Tt:(Tt|=(127&($t=qt[(this||rt).pos++]))<<14,$t<128?Tt:(Tt|=(127&($t=qt[(this||rt).pos++]))<<21,$t<128?Tt:function(rt,at,Tt){var $t,qt,Kt=Tt.buf;if($t=(112&(qt=Kt[Tt.pos++]))>>4,qt<128)return a(rt,$t,at);if($t|=(127&(qt=Kt[Tt.pos++]))<<3,qt<128)return a(rt,$t,at);if($t|=(127&(qt=Kt[Tt.pos++]))<<10,qt<128)return a(rt,$t,at);if($t|=(127&(qt=Kt[Tt.pos++]))<<17,qt<128)return a(rt,$t,at);if($t|=(127&(qt=Kt[Tt.pos++]))<<24,qt<128)return a(rt,$t,at);if($t|=(1&(qt=Kt[Tt.pos++]))<<31,qt<128)return a(rt,$t,at);throw new Error("Expected varint not more than 10 bytes")}(Tt|=(15&($t=qt[(this||rt).pos]))<<28,at,this||rt))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var rt=this.readVarint();return rt%2==1?(rt+1)/-2:rt/2},readBoolean:function(){return Boolean(this.readVarint())},readString:function(){var at=this.readVarint()+(this||rt).pos,Tt=(this||rt).pos;return(this||rt).pos=at,at-Tt>=12&&qt?function(rt,at,Tt){return qt.decode(rt.subarray(at,Tt))}((this||rt).buf,Tt,at):function(rt,at,Tt){for(var $t="",qt=at;qt<Tt;){var Kt,ge,Hr,wn=rt[qt],es=null,ss=wn>239?4:wn>223?3:wn>191?2:1;if(qt+ss>Tt)break;1===ss?wn<128&&(es=wn):2===ss?128==(192&(Kt=rt[qt+1]))&&(es=(31&wn)<<6|63&Kt)<=127&&(es=null):3===ss?(ge=rt[qt+2],128==(192&(Kt=rt[qt+1]))&&128==(192&ge)&&((es=(15&wn)<<12|(63&Kt)<<6|63&ge)<=2047||es>=55296&&es<=57343)&&(es=null)):4===ss&&(ge=rt[qt+2],Hr=rt[qt+3],128==(192&(Kt=rt[qt+1]))&&128==(192&ge)&&128==(192&Hr)&&((es=(15&wn)<<18|(63&Kt)<<12|(63&ge)<<6|63&Hr)<=65535||es>=1114112)&&(es=null)),null===es?(es=65533,ss=1):es>65535&&(es-=65536,$t+=String.fromCharCode(es>>>10&1023|55296),es=56320|1023&es),$t+=String.fromCharCode(es),qt+=ss}return $t}((this||rt).buf,Tt,at)},readBytes:function(){var at=this.readVarint()+(this||rt).pos,Tt=(this||rt).buf.subarray((this||rt).pos,at);return(this||rt).pos=at,Tt},readPackedVarint:function(at,Tt){if((this||rt).type!==e.Bytes)return at.push(this.readVarint(Tt));var $t=s(this||rt);for(at=at||[];(this||rt).pos<$t;)at.push(this.readVarint(Tt));return at},readPackedSVarint:function(at){if((this||rt).type!==e.Bytes)return at.push(this.readSVarint());var Tt=s(this||rt);for(at=at||[];(this||rt).pos<Tt;)at.push(this.readSVarint());return at},readPackedBoolean:function(at){if((this||rt).type!==e.Bytes)return at.push(this.readBoolean());var Tt=s(this||rt);for(at=at||[];(this||rt).pos<Tt;)at.push(this.readBoolean());return at},readPackedFloat:function(at){if((this||rt).type!==e.Bytes)return at.push(this.readFloat());var Tt=s(this||rt);for(at=at||[];(this||rt).pos<Tt;)at.push(this.readFloat());return at},readPackedDouble:function(at){if((this||rt).type!==e.Bytes)return at.push(this.readDouble());var Tt=s(this||rt);for(at=at||[];(this||rt).pos<Tt;)at.push(this.readDouble());return at},readPackedFixed32:function(at){if((this||rt).type!==e.Bytes)return at.push(this.readFixed32());var Tt=s(this||rt);for(at=at||[];(this||rt).pos<Tt;)at.push(this.readFixed32());return at},readPackedSFixed32:function(at){if((this||rt).type!==e.Bytes)return at.push(this.readSFixed32());var Tt=s(this||rt);for(at=at||[];(this||rt).pos<Tt;)at.push(this.readSFixed32());return at},readPackedFixed64:function(at){if((this||rt).type!==e.Bytes)return at.push(this.readFixed64());var Tt=s(this||rt);for(at=at||[];(this||rt).pos<Tt;)at.push(this.readFixed64());return at},readPackedSFixed64:function(at){if((this||rt).type!==e.Bytes)return at.push(this.readSFixed64());var Tt=s(this||rt);for(at=at||[];(this||rt).pos<Tt;)at.push(this.readSFixed64());return at},skip:function(at){var Tt=7&at;if(Tt===e.Varint)for(;(this||rt).buf[(this||rt).pos++]>127;);else if(Tt===e.Bytes)(this||rt).pos=this.readVarint()+(this||rt).pos;else if(Tt===e.Fixed32)(this||rt).pos+=4;else{if(Tt!==e.Fixed64)throw new Error("Unimplemented type: "+Tt);(this||rt).pos+=8}},writeTag:function(rt,at){this.writeVarint(rt<<3|at)},realloc:function(at){for(var Tt=(this||rt).length||16;Tt<(this||rt).pos+at;)Tt*=2;if(Tt!==(this||rt).length){var $t=new Uint8Array(Tt);$t.set((this||rt).buf),(this||rt).buf=$t,(this||rt).length=Tt}},finish:function(){return(this||rt).length=(this||rt).pos,(this||rt).pos=0,(this||rt).buf.subarray(0,(this||rt).length)},writeFixed32:function(at){this.realloc(4),x((this||rt).buf,at,(this||rt).pos),(this||rt).pos+=4},writeSFixed32:function(at){this.realloc(4),x((this||rt).buf,at,(this||rt).pos),(this||rt).pos+=4},writeFixed64:function(at){this.realloc(8),x((this||rt).buf,-1&at,(this||rt).pos),x((this||rt).buf,Math.floor(at*$t),(this||rt).pos+4),(this||rt).pos+=8},writeSFixed64:function(at){this.realloc(8),x((this||rt).buf,-1&at,(this||rt).pos),x((this||rt).buf,Math.floor(at*$t),(this||rt).pos+4),(this||rt).pos+=8},writeVarint:function(at){(at=+at||0)>268435455||at<0?function(rt,at){var Tt,$t;if(rt>=0?(Tt=rt%4294967296|0,$t=rt/4294967296|0):($t=~(-rt/4294967296),4294967295^(Tt=~(-rt%4294967296))?Tt=Tt+1|0:(Tt=0,$t=$t+1|0)),rt>=0x10000000000000000||rt<-0x10000000000000000)throw new Error("Given varint doesn't fit into 10 bytes");at.realloc(10),function(rt,at,Tt){Tt.buf[Tt.pos++]=127&rt|128,rt>>>=7,Tt.buf[Tt.pos++]=127&rt|128,rt>>>=7,Tt.buf[Tt.pos++]=127&rt|128,rt>>>=7,Tt.buf[Tt.pos++]=127&rt|128,Tt.buf[Tt.pos]=127&(rt>>>=7)}(Tt,0,at),function(rt,at){var Tt=(7&rt)<<4;at.buf[at.pos++]|=Tt|((rt>>>=3)?128:0),rt&&(at.buf[at.pos++]=127&rt|((rt>>>=7)?128:0),rt&&(at.buf[at.pos++]=127&rt|((rt>>>=7)?128:0),rt&&(at.buf[at.pos++]=127&rt|((rt>>>=7)?128:0),rt&&(at.buf[at.pos++]=127&rt|((rt>>>=7)?128:0),rt&&(at.buf[at.pos++]=127&rt)))))}($t,at)}(at,this||rt):(this.realloc(4),(this||rt).buf[(this||rt).pos++]=127&at|(at>127?128:0),at<=127||((this||rt).buf[(this||rt).pos++]=127&(at>>>=7)|(at>127?128:0),at<=127||((this||rt).buf[(this||rt).pos++]=127&(at>>>=7)|(at>127?128:0),at<=127||((this||rt).buf[(this||rt).pos++]=at>>>7&127))))},writeSVarint:function(rt){this.writeVarint(rt<0?2*-rt-1:2*rt)},writeBoolean:function(rt){this.writeVarint(Boolean(rt))},writeString:function(at){at=String(at),this.realloc(4*at.length),(this||rt).pos++;var Tt=(this||rt).pos;(this||rt).pos=function(rt,at,Tt){for(var $t,qt,Kt=0;Kt<at.length;Kt++){if(($t=at.charCodeAt(Kt))>55295&&$t<57344){if(!qt){$t>56319||Kt+1===at.length?(rt[Tt++]=239,rt[Tt++]=191,rt[Tt++]=189):qt=$t;continue}if($t<56320){rt[Tt++]=239,rt[Tt++]=191,rt[Tt++]=189,qt=$t;continue}$t=qt-55296<<10|$t-56320|65536,qt=null}else qt&&(rt[Tt++]=239,rt[Tt++]=191,rt[Tt++]=189,qt=null);$t<128?rt[Tt++]=$t:($t<2048?rt[Tt++]=$t>>6|192:($t<65536?rt[Tt++]=$t>>12|224:(rt[Tt++]=$t>>18|240,rt[Tt++]=$t>>12&63|128),rt[Tt++]=$t>>6&63|128),rt[Tt++]=63&$t|128)}return Tt}((this||rt).buf,at,(this||rt).pos);var $t=(this||rt).pos-Tt;$t>=128&&o(Tt,$t,this||rt),(this||rt).pos=Tt-1,this.writeVarint($t),(this||rt).pos+=$t},writeFloat:function(Tt){this.realloc(4),at.write((this||rt).buf,Tt,(this||rt).pos,!0,23,4),(this||rt).pos+=4},writeDouble:function(Tt){this.realloc(8),at.write((this||rt).buf,Tt,(this||rt).pos,!0,52,8),(this||rt).pos+=8},writeBytes:function(at){var Tt=at.length;this.writeVarint(Tt),this.realloc(Tt);for(var $t=0;$t<Tt;$t++)(this||rt).buf[(this||rt).pos++]=at[$t]},writeRawMessage:function(at,Tt){(this||rt).pos++;var $t=(this||rt).pos;at(Tt,this||rt);var qt=(this||rt).pos-$t;qt>=128&&o($t,qt,this||rt),(this||rt).pos=$t-1,this.writeVarint(qt),(this||rt).pos+=qt},writeMessage:function(rt,at,Tt){this.writeTag(rt,e.Bytes),this.writeRawMessage(at,Tt)},writePackedVarint:function(rt,at){at.length&&this.writeMessage(rt,l,at)},writePackedSVarint:function(rt,at){at.length&&this.writeMessage(rt,u,at)},writePackedBoolean:function(rt,at){at.length&&this.writeMessage(rt,p,at)},writePackedFloat:function(rt,at){at.length&&this.writeMessage(rt,c,at)},writePackedDouble:function(rt,at){at.length&&this.writeMessage(rt,h,at)},writePackedFixed32:function(rt,at){at.length&&this.writeMessage(rt,f,at)},writePackedSFixed32:function(rt,at){at.length&&this.writeMessage(rt,d,at)},writePackedFixed64:function(rt,at){at.length&&this.writeMessage(rt,y,at)},writePackedSFixed64:function(rt,at){at.length&&this.writeMessage(rt,m,at)},writeBytesField:function(rt,at){this.writeTag(rt,e.Bytes),this.writeBytes(at)},writeFixed32Field:function(rt,at){this.writeTag(rt,e.Fixed32),this.writeFixed32(at)},writeSFixed32Field:function(rt,at){this.writeTag(rt,e.Fixed32),this.writeSFixed32(at)},writeFixed64Field:function(rt,at){this.writeTag(rt,e.Fixed64),this.writeFixed64(at)},writeSFixed64Field:function(rt,at){this.writeTag(rt,e.Fixed64),this.writeSFixed64(at)},writeVarintField:function(rt,at){this.writeTag(rt,e.Varint),this.writeVarint(at)},writeSVarintField:function(rt,at){this.writeTag(rt,e.Varint),this.writeSVarint(at)},writeStringField:function(rt,at){this.writeTag(rt,e.Bytes),this.writeString(at)},writeFloatField:function(rt,at){this.writeTag(rt,e.Fixed32),this.writeFloat(at)},writeDoubleField:function(rt,at){this.writeTag(rt,e.Fixed64),this.writeDouble(at)},writeBooleanField:function(rt,at){this.writeVarintField(rt,Boolean(at))}},np}var lp=r(Nu());const cp=3;function Gu(rt,at,Tt){1===rt&&Tt.readMessage(Zu,at)}function Zu(rt,at,Tt){if(3===rt){const{id:rt,bitmap:$t,width:qt,height:Kt,left:ge,top:Hr,advance:wn}=Tt.readMessage(Ku,{});at.push({id:rt,bitmap:new Uo({width:qt+2*cp,height:Kt+2*cp},$t),metrics:{width:qt,height:Kt,left:ge,top:Hr,advance:wn}})}}function Ku(rt,at,Tt){1===rt?at.id=Tt.readVarint():2===rt?at.bitmap=Tt.readBytes():3===rt?at.width=Tt.readVarint():4===rt?at.height=Tt.readVarint():5===rt?at.left=Tt.readSVarint():6===rt?at.top=Tt.readSVarint():7===rt&&(at.advance=Tt.readVarint())}const hp=cp;function Hu(rt){let at=0,Tt=0;for(const $t of rt)at+=$t.w*$t.h,Tt=Math.max(Tt,$t.w);rt.sort(((rt,at)=>at.h-rt.h));const $t=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(at/.95)),Tt),h:1/0}];let qt=0,Kt=0;for(const at of rt)for(let rt=$t.length-1;rt>=0;rt--){const Tt=$t[rt];if(!(at.w>Tt.w||at.h>Tt.h)){if(at.x=Tt.x,at.y=Tt.y,Kt=Math.max(Kt,at.y+at.h),qt=Math.max(qt,at.x+at.w),at.w===Tt.w&&at.h===Tt.h){const at=$t.pop();rt<$t.length&&($t[rt]=at)}else at.h===Tt.h?(Tt.x+=at.w,Tt.w-=at.w):at.w===Tt.w?(Tt.y+=at.h,Tt.h-=at.h):($t.push({x:Tt.x+at.w,y:Tt.y,w:Tt.w-at.w,h:at.h}),Tt.y+=at.h,Tt.h-=at.h);break}}return{w:qt,h:Kt,fill:at/(qt*Kt)||0}}const up=1;class Ju{constructor(rt,{pixelRatio:at,version:Tt,stretchX:$t,stretchY:qt,content:Kt,textFitWidth:ge,textFitHeight:Hr}){this.paddedRect=rt,this.pixelRatio=at,this.stretchX=$t,this.stretchY=qt,this.content=Kt,this.version=Tt,this.textFitWidth=ge,this.textFitHeight=Hr}get tl(){return[this.paddedRect.x+up,this.paddedRect.y+up]}get br(){return[this.paddedRect.x+this.paddedRect.w-up,this.paddedRect.y+this.paddedRect.h-up]}get tlbr(){return this.tl.concat(this.br)}get displaySize(){return[(this.paddedRect.w-2*up)/this.pixelRatio,(this.paddedRect.h-2*up)/this.pixelRatio]}}class Wu{constructor(rt,at){const Tt={},$t={};this.haveRenderCallbacks=[];const qt=[];this.addImages(rt,Tt,qt),this.addImages(at,$t,qt);const{w:Kt,h:ge}=Hu(qt),Hr=new qo({width:Kt||1,height:ge||1});for(const at in rt){const $t=rt[at],qt=Tt[at].paddedRect;qo.copy($t.data,Hr,{x:0,y:0},{x:qt.x+up,y:qt.y+up},$t.data)}for(const rt in at){const Tt=at[rt],qt=$t[rt].paddedRect,Kt=qt.x+up,ge=qt.y+up,wn=Tt.data.width,es=Tt.data.height;qo.copy(Tt.data,Hr,{x:0,y:0},{x:Kt,y:ge},Tt.data),qo.copy(Tt.data,Hr,{x:0,y:es-1},{x:Kt,y:ge-1},{width:wn,height:1}),qo.copy(Tt.data,Hr,{x:0,y:0},{x:Kt,y:ge+es},{width:wn,height:1}),qo.copy(Tt.data,Hr,{x:wn-1,y:0},{x:Kt-1,y:ge},{width:1,height:es}),qo.copy(Tt.data,Hr,{x:0,y:0},{x:Kt+wn,y:ge},{width:1,height:es})}this.image=Hr,this.iconPositions=Tt,this.patternPositions=$t}addImages(rt,at,Tt){for(const $t in rt){const qt=rt[$t],Kt={x:0,y:0,w:qt.data.width+2*up,h:qt.data.height+2*up};Tt.push(Kt),at[$t]=new Ju(Kt,qt),qt.hasRenderCallback&&this.haveRenderCallbacks.push($t)}}patchUpdatedImages(rt,at){rt.dispatchRenderCallbacks(this.haveRenderCallbacks);for(const Tt in rt.updatedImages)this.patchUpdatedImage(this.iconPositions[Tt],rt.getImage(Tt),at),this.patchUpdatedImage(this.patternPositions[Tt],rt.getImage(Tt),at)}patchUpdatedImage(rt,at,Tt){if(!rt||!at)return;if(rt.version===at.version)return;rt.version=at.version;const[$t,qt]=rt.tl;Tt.update(at.data,void 0,{x:$t,y:qt})}}var dp;Xi("ImagePosition",Ju),Xi("ImageAtlas",Wu),at.al=void 0,(dp=at.al||(at.al={}))[dp.none=0]="none",dp[dp.horizontal=1]="horizontal",dp[dp.vertical=2]="vertical",dp[dp.horizontalOnly=3]="horizontalOnly";const pp=-17;class ec{constructor(){this.scale=1,this.fontStack="",this.imageName=null,this.verticalAlign="bottom"}static forText(rt,at,Tt){const $t=new ec;return $t.scale=rt||1,$t.fontStack=at,$t.verticalAlign=Tt||"bottom",$t}static forImage(rt,at){const Tt=new ec;return Tt.imageName=rt,Tt.verticalAlign=at||"bottom",Tt}}class rc{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(rt,at){const Tt=new rc;for(let $t=0;$t<rt.sections.length;$t++){const qt=rt.sections[$t];qt.image?Tt.addImageSection(qt):Tt.addTextSection(qt,at)}return Tt}length(){return this.text.length}getSection(rt){return this.sections[this.sectionIndex[rt]]}getSectionIndex(rt){return this.sectionIndex[rt]}getCharCode(rt){return this.text.charCodeAt(rt)}verticalizePunctuation(){this.text=function(rt){let at="";for(let Tt=0;Tt<rt.length;Tt++){const $t=rt.charCodeAt(Tt+1)||null,qt=rt.charCodeAt(Tt-1)||null;at+=$t&&us($t)&&!ip[rt[Tt+1]]||qt&&us(qt)&&!ip[rt[Tt-1]]||!ip[rt[Tt]]?rt[Tt]:ip[rt[Tt]]}return at}(this.text)}trim(){let rt=0;for(let at=0;at<this.text.length&&fp[this.text.charCodeAt(at)];at++)rt++;let at=this.text.length;for(let Tt=this.text.length-1;Tt>=0&&Tt>=rt&&fp[this.text.charCodeAt(Tt)];Tt--)at--;this.text=this.text.substring(rt,at),this.sectionIndex=this.sectionIndex.slice(rt,at)}substring(rt,at){const Tt=new rc;return Tt.text=this.text.substring(rt,at),Tt.sectionIndex=this.sectionIndex.slice(rt,at),Tt.sections=this.sections,Tt}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce(((rt,at)=>Math.max(rt,this.sections[at].scale)),0)}getMaxImageSize(rt){let at=0,Tt=0;for(let $t=0;$t<this.length();$t++){const qt=this.getSection($t);if(qt.imageName){const $t=rt[qt.imageName];if(!$t)continue;const Kt=$t.displaySize;at=Math.max(at,Kt[0]),Tt=Math.max(Tt,Kt[1])}}return{maxImageWidth:at,maxImageHeight:Tt}}addTextSection(rt,at){this.text+=rt.text,this.sections.push(ec.forText(rt.scale,rt.fontStack||at,rt.verticalAlign));const Tt=this.sections.length-1;for(let at=0;at<rt.text.length;++at)this.sectionIndex.push(Tt)}addImageSection(rt){const at=rt.image?rt.image.name:"";if(0===at.length)return void U("Can't add FormattedSection with an empty image.");const Tt=this.getNextImageSectionCharCode();Tt?(this.text+=String.fromCharCode(Tt),this.sections.push(ec.forImage(at,rt.verticalAlign)),this.sectionIndex.push(this.sections.length-1)):U("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function nc(rt,Tt,$t,qt,Kt,ge,Hr,wn,es,ss,os,cs,ds,Cs,Vs){const Eo=rc.fromFeature(rt,Kt);let Do;cs===at.al.vertical&&Eo.verticalizePunctuation();const{processBidirectionalText:Ho,processStyledBidirectionalText:Ea}=Fu;if(Ho&&1===Eo.sections.length){Do=[];const rt=Ho(Eo.toString(),pc(Eo,ss,ge,Tt,qt,Cs));for(const at of rt){const rt=new rc;rt.text=at,rt.sections=Eo.sections;for(let Tt=0;Tt<at.length;Tt++)rt.sectionIndex.push(0);Do.push(rt)}}else if(Ea){Do=[];const rt=Ea(Eo.text,Eo.sectionIndex,pc(Eo,ss,ge,Tt,qt,Cs));for(const at of rt){const rt=new rc;rt.text=at[0],rt.sectionIndex=at[1],rt.sections=Eo.sections,Do.push(rt)}}else Do=function(rt,at){const Tt=[],$t=rt.text;let qt=0;for(const $t of at)Tt.push(rt.substring(qt,$t)),qt=$t;return qt<$t.length&&Tt.push(rt.substring(qt,$t.length)),Tt}(Eo,pc(Eo,ss,ge,Tt,qt,Cs));const La=[],ja={positionedLines:La,text:Eo.toString(),top:os[1],bottom:os[1],left:os[0],right:os[0],writingMode:cs,iconsInText:!1,verticalizable:!1};return function(rt,at,Tt,$t,qt,Kt,ge,Hr,wn,es,ss,os){let cs=0,ds=0,Cs=0,Vs=0;const Eo="right"===Hr?1:"left"===Hr?0:.5,Do=op/os;let Ho=0;for(const ge of qt){ge.trim();const qt=ge.getMaxScale(),Hr={positionedGlyphs:[],lineOffset:0};rt.positionedLines[Ho]=Hr;const os=Hr.positionedGlyphs;let Ea=0;if(!ge.length()){ds+=Kt,++Ho;continue}const La=dc($t,ge,Do);for(let Kt=0;Kt<ge.length();Kt++){const Hr=ge.getSection(Kt),Cs=ge.getSectionIndex(Kt),Vs=ge.getCharCode(Kt),Eo=mc(wn,ss,Vs);let Ho;if(Hr.imageName){if(rt.iconsInText=!0,Hr.scale=Hr.scale*Do,Ho=xc(Hr,Eo,qt,La,$t),!Ho)continue;Ea=Math.max(Ea,Ho.imageOffset)}else if(Ho=gc(Hr,Vs,Eo,La,at,Tt),!Ho)continue;const{rect:ja,metrics:Va,baselineOffset:Na}=Ho;os.push({glyph:Vs,imageName:Hr.imageName,x:cs,y:ds+Na+pp,vertical:Eo,scale:Hr.scale,fontStack:Hr.fontStack,sectionIndex:Cs,metrics:Va,rect:ja}),Eo?(rt.verticalizable=!0,cs+=(Hr.imageName?Va.advance:op)*Hr.scale+es):cs+=Va.advance*Hr.scale+es}0!==os.length&&(Cs=Math.max(cs-es,Cs),vc(os,0,os.length-1,Eo)),cs=0,Hr.lineOffset=Math.max(Ea,(qt-1)*op);const ja=Kt*qt+Ea;ds+=ja,Vs=Math.max(ja,Vs),++Ho}const{horizontalAlign:Ea,verticalAlign:La}=fc(ge);(function(rt,at,Tt,$t,qt,Kt,ge,Hr,wn){const es=(at-Tt)*qt;let ss=0;ss=Kt!==ge?-Hr*$t-pp:-$t*wn*ge+.5*ge;for(const at of rt)for(const rt of at.positionedGlyphs)rt.x+=es,rt.y+=ss})(rt.positionedLines,Eo,Ea,La,Cs,Vs,Kt,ds,qt.length),rt.top+=-La*ds,rt.bottom=rt.top+ds,rt.left+=-Ea*Cs,rt.right=rt.left+Cs}(ja,Tt,$t,qt,Do,Hr,wn,es,cs,ss,ds,Vs),!function(rt){for(const at of rt)if(0!==at.positionedGlyphs.length)return!1;return!0}(La)&&ja}const fp={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},mp={10:!0,32:!0,38:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0},_p={40:!0};function oc(rt,at,Tt,$t,qt,Kt){if(at.imageName){const rt=$t[at.imageName];return rt?rt.displaySize[0]*at.scale*op/Kt+qt:0}{const $t=Tt[at.fontStack],Kt=$t&&$t[rt];return Kt?Kt.metrics.advance*at.scale+qt:0}}function lc(rt,at,Tt,$t){const qt=Math.pow(rt-at,2);return $t?rt<at?qt/2:2*qt:qt+Math.abs(Tt)*Tt}function uc(rt,at,Tt){let $t=0;return 10===rt&&($t-=1e4),Tt&&($t+=150),40!==rt&&65288!==rt||($t+=50),41!==at&&65289!==at||($t+=50),$t}function cc(rt,at,Tt,$t,qt,Kt){let ge=null,Hr=lc(at,Tt,qt,Kt);for(const rt of $t){const $t=lc(at-rt.x,Tt,qt,Kt)+rt.badness;$t<=Hr&&(ge=rt,Hr=$t)}return{index:rt,x:at,priorBreak:ge,badness:Hr}}function hc(rt){return rt?hc(rt.priorBreak).concat(rt.index):[]}function pc(rt,at,Tt,$t,qt,Kt){if(!rt)return[];const ge=[],Hr=function(rt,at,Tt,$t,qt,Kt){let ge=0;for(let Tt=0;Tt<rt.length();Tt++){const Hr=rt.getSection(Tt);ge+=oc(rt.getCharCode(Tt),Hr,$t,qt,at,Kt)}return ge/Math.max(1,Math.ceil(ge/Tt))}(rt,at,Tt,$t,qt,Kt),wn=rt.text.indexOf("")>=0;let es=0;for(let Tt=0;Tt<rt.length();Tt++){const os=rt.getSection(Tt),cs=rt.getCharCode(Tt);if(fp[cs]||(es+=oc(cs,os,$t,qt,at,Kt)),Tt<rt.length()-1){const at=!((ss=cs)<11904)&&(!!Eu["CJK Compatibility Forms"](ss)||!!Eu["CJK Compatibility"](ss)||!!Eu["CJK Strokes"](ss)||!!Eu["CJK Symbols and Punctuation"](ss)||!!Eu["Enclosed CJK Letters and Months"](ss)||!!Eu["Halfwidth and Fullwidth Forms"](ss)||!!Eu["Ideographic Description Characters"](ss)||!!Eu["Vertical Forms"](ss)||Ru.test(String.fromCodePoint(ss)));(mp[cs]||at||os.imageName||Tt!==rt.length()-2&&_p[rt.getCharCode(Tt+1)])&&ge.push(cc(Tt+1,es,Hr,ge,uc(cs,rt.getCharCode(Tt+1),at&&wn),!1))}}var ss;return hc(cc(rt.length(),es,Hr,ge,0,!0))}function fc(rt){let at=.5,Tt=.5;switch(rt){case"right":case"top-right":case"bottom-right":at=1;break;case"left":case"top-left":case"bottom-left":at=0}switch(rt){case"bottom":case"bottom-right":case"bottom-left":Tt=1;break;case"top":case"top-right":case"top-left":Tt=0}return{horizontalAlign:at,verticalAlign:Tt}}function dc(rt,at,Tt){const $t=at.getMaxScale()*op,{maxImageWidth:qt,maxImageHeight:Kt}=at.getMaxImageSize(rt),ge=Math.max($t,Kt*Tt);return{verticalLineContentWidth:Math.max($t,qt*Tt),horizontalLineContentHeight:ge}}function yc(rt){switch(rt){case"top":return 0;case"center":return.5;default:return 1}}function mc(rt,Tt,$t){return!(rt===at.al.horizontal||!Tt&&!ls($t)||Tt&&(fp[$t]||(qt=$t,/\p{sc=Arab}/u.test(String.fromCodePoint(qt)))));var qt}function gc(rt,at,Tt,$t,qt,Kt){const ge=Kt[rt.fontStack],Hr=function(rt,at,Tt,$t){if(rt&&rt.rect)return rt;const qt=at[Tt.fontStack],Kt=qt&&qt[$t];return Kt?{rect:null,metrics:Kt.metrics}:null}(ge&&ge[at],qt,rt,at);if(null===Hr)return null;let wn;if(Tt)wn=$t.verticalLineContentWidth-rt.scale*op;else{const at=yc(rt.verticalAlign);wn=($t.horizontalLineContentHeight-rt.scale*op)*at}return{rect:Hr.rect,metrics:Hr.metrics,baselineOffset:wn}}function xc(rt,at,Tt,$t,qt){const Kt=qt[rt.imageName];if(!Kt)return null;const ge=Kt.paddedRect,Hr=Kt.displaySize,wn={width:Hr[0],height:Hr[1],left:up,top:-3,advance:at?Hr[1]:Hr[0]};let es;if(at)es=$t.verticalLineContentWidth-Hr[1]*rt.scale;else{const at=yc(rt.verticalAlign);es=($t.horizontalLineContentHeight-Hr[1]*rt.scale)*at}return{rect:ge,metrics:wn,baselineOffset:es,imageOffset:(at?Hr[0]:Hr[1])*rt.scale-op*Tt}}function vc(rt,at,Tt,$t){if(0===$t)return;const qt=rt[Tt],Kt=(rt[Tt].x+qt.metrics.advance*qt.scale)*$t;for(let $t=at;$t<=Tt;$t++)rt[$t].x-=Kt}function bc(rt,at,Tt){const{horizontalAlign:$t,verticalAlign:qt}=fc(Tt),Kt=at[0]-rt.displaySize[0]*$t,ge=at[1]-rt.displaySize[1]*qt;return{image:rt,top:ge,bottom:ge+rt.displaySize[1],left:Kt,right:Kt+rt.displaySize[0]}}function wc(rt){var at,Tt;let $t=rt.left,qt=rt.top,Kt=rt.right-$t,ge=rt.bottom-qt;const Hr=null!==(at=rt.image.textFitWidth)&&void 0!==at?at:"stretchOrShrink",wn=null!==(Tt=rt.image.textFitHeight)&&void 0!==Tt?Tt:"stretchOrShrink",es=(rt.image.content[2]-rt.image.content[0])/(rt.image.content[3]-rt.image.content[1]);if("proportional"===wn){if("stretchOnly"===Hr&&Kt/ge<es||"proportional"===Hr){const rt=Math.ceil(ge*es);$t*=rt/Kt,Kt=rt}}else if("proportional"===Hr&&"stretchOnly"===wn&&0!==es&&Kt/ge>es){const rt=Math.ceil(Kt/es);qt*=rt/ge,ge=rt}return{x1:$t,y1:qt,x2:$t+Kt,y2:qt+ge}}function _c(rt,at,Tt,$t,qt,Kt){const ge=rt.image;let Hr;if(ge.content){const rt=ge.content,at=ge.pixelRatio||1;Hr=[rt[0]/at,rt[1]/at,ge.displaySize[0]-rt[2]/at,ge.displaySize[1]-rt[3]/at]}const wn=at.left*Kt,es=at.right*Kt;let ss,os,cs,ds;"width"===Tt||"both"===Tt?(ds=qt[0]+wn-$t[3],os=qt[0]+es+$t[1]):(ds=qt[0]+(wn+es-ge.displaySize[0])/2,os=ds+ge.displaySize[0]);const Cs=at.top*Kt,Vs=at.bottom*Kt;return"height"===Tt||"both"===Tt?(ss=qt[1]+Cs-$t[0],cs=qt[1]+Vs+$t[2]):(ss=qt[1]+(Cs+Vs-ge.displaySize[1])/2,cs=ss+ge.displaySize[1]),{image:ge,top:ss,right:os,bottom:cs,left:ds,collisionPadding:Hr}}const gp=255,yp=128,xp=gp*yp;function Mc(rt,at){const{expression:Tt}=at;if("constant"===Tt.kind)return{kind:"constant",layoutSize:Tt.evaluate(new ys(rt+1))};if("source"===Tt.kind)return{kind:"source"};{const{zoomStops:at,interpolationType:$t}=Tt;let qt=0;for(;qt<at.length&&at[qt]<=rt;)qt++;qt=Math.max(0,qt-1);let Kt=qt;for(;Kt<at.length&&at[Kt]<rt+1;)Kt++;Kt=Math.min(at.length-1,Kt);const ge=at[qt],Hr=at[Kt];return"composite"===Tt.kind?{kind:"composite",minZoom:ge,maxZoom:Hr,interpolationType:$t}:{kind:"camera",minZoom:ge,maxZoom:Hr,minSize:Tt.evaluate(new ys(ge)),maxSize:Tt.evaluate(new ys(Hr)),interpolationType:$t}}}function Ic(rt,at,Tt){let $t="never";const qt=rt.get(at);return qt?$t=qt:rt.get(Tt)&&($t="always"),$t}const vp=Rd.VectorTileFeature.types,bp=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function Cc(rt,at,Tt,$t,qt,Kt,ge,Hr,wn,es,ss,os,cs){const ds=Hr?Math.min(xp,Math.round(Hr[0])):0,Cs=Hr?Math.min(xp,Math.round(Hr[1])):0;rt.emplaceBack(at,Tt,Math.round(32*$t),Math.round(32*qt),Kt,ge,(ds<<1)+(wn?1:0),Cs,16*es,16*ss,256*os,256*cs)}function Bc(rt,at,Tt){rt.emplaceBack(at.x,at.y,Tt),rt.emplaceBack(at.x,at.y,Tt),rt.emplaceBack(at.x,at.y,Tt),rt.emplaceBack(at.x,at.y,Tt)}function Vc(rt){for(const at of rt.sections)if(fs(at.text))return!0;return!1}class Ec{constructor(rt){this.layoutVertexArray=new ka,this.indexArray=new Ca,this.programConfigurations=rt,this.segments=new Ta,this.dynamicLayoutVertexArray=new Ma,this.opacityVertexArray=new Ia,this.hasVisibleVertices=!1,this.placedSymbolArray=new ua}isEmpty(){return 0===this.layoutVertexArray.length&&0===this.indexArray.length&&0===this.dynamicLayoutVertexArray.length&&0===this.opacityVertexArray.length}upload(rt,at,Tt,$t){this.isEmpty()||(Tt&&(this.layoutVertexBuffer=rt.createVertexBuffer(this.layoutVertexArray,Kd.members),this.indexBuffer=rt.createIndexBuffer(this.indexArray,at),this.dynamicLayoutVertexBuffer=rt.createVertexBuffer(this.dynamicLayoutVertexArray,Yd.members,!0),this.opacityVertexBuffer=rt.createVertexBuffer(this.opacityVertexArray,bp,!0),this.opacityVertexBuffer.itemSize=1),(Tt||$t)&&this.programConfigurations.upload(rt))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy())}}Xi("SymbolBuffers",Ec);class Tc{constructor(rt,at,Tt){this.layoutVertexArray=new rt,this.layoutAttributes=at,this.indexArray=new Tt,this.segments=new Ta,this.collisionVertexArray=new Pa}upload(rt){this.layoutVertexBuffer=rt.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=rt.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=rt.createVertexBuffer(this.collisionVertexArray,Jd.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy())}}Xi("CollisionBuffers",Tc);class Fc{constructor(rt){this.collisionBoxArray=rt.collisionBoxArray,this.zoom=rt.zoom,this.overscaling=rt.overscaling,this.layers=rt.layers,this.layerIds=this.layers.map((rt=>rt.id)),this.index=rt.index,this.pixelRatio=rt.pixelRatio,this.sourceLayerIndex=rt.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.sortKeyRanges=[],this.collisionCircleArray=[];const Tt=this.layers[0]._unevaluatedLayout._values;this.textSizeData=Mc(this.zoom,Tt["text-size"]),this.iconSizeData=Mc(this.zoom,Tt["icon-size"]);const $t=this.layers[0].layout,qt=$t.get("symbol-sort-key"),Kt=$t.get("symbol-z-order");this.canOverlap="never"!==Ic($t,"text-overlap","text-allow-overlap")||"never"!==Ic($t,"icon-overlap","icon-allow-overlap")||$t.get("text-ignore-placement")||$t.get("icon-ignore-placement"),this.sortFeaturesByKey="viewport-y"!==Kt&&!qt.isConstant(),this.sortFeaturesByY=("viewport-y"===Kt||"auto"===Kt&&!this.sortFeaturesByKey)&&this.canOverlap,"point"===$t.get("symbol-placement")&&(this.writingModes=$t.get("text-writing-mode").map((rt=>at.al[rt]))),this.stateDependentLayerIds=this.layers.filter((rt=>rt.isStateDependent())).map((rt=>rt.id)),this.sourceID=rt.sourceID}createArrays(){this.text=new Ec(new oo(this.layers,this.zoom,(rt=>/^text/.test(rt)))),this.icon=new Ec(new oo(this.layers,this.zoom,(rt=>/^icon/.test(rt)))),this.glyphOffsetArray=new pa,this.lineVertexArray=new fa,this.symbolInstances=new ha,this.textAnchorOffsets=new ya}calculateGlyphDependencies(rt,at,Tt,$t,qt){for(let Kt=0;Kt<rt.length;Kt++)if(at[rt.charCodeAt(Kt)]=!0,(Tt||$t)&&qt){const Tt=ip[rt.charAt(Kt)];Tt&&(at[Tt.charCodeAt(0)]=!0)}}populate(rt,Tt,$t){const qt=this.layers[0],Kt=qt.layout,ge=Kt.get("text-font"),Hr=Kt.get("text-field"),wn=Kt.get("icon-image"),es=("constant"!==Hr.value.kind||Hr.value.value instanceof Ae&&!Hr.value.value.isEmpty()||Hr.value.value.toString().length>0)&&("constant"!==ge.value.kind||ge.value.value.length>0),ss="constant"!==wn.value.kind||!!wn.value.value||Object.keys(wn.parameters).length>0,os=Kt.get("symbol-sort-key");if(this.features=[],!es&&!ss)return;const cs=Tt.iconDependencies,ds=Tt.glyphDependencies,Cs=Tt.availableImages,Vs=new ys(this.zoom);for(const{feature:Tt,id:Hr,index:wn,sourceLayerIndex:Eo}of rt){const rt=qt._featureFilter.needGeometry,Do=fo(Tt,rt);if(!qt._featureFilter.filter(Vs,Do,$t))continue;let Ho,Ea;if(rt||(Do.geometry=po(Tt)),es){const rt=qt.getValueAndResolveTokens("text-field",Do,$t,Cs),at=Ae.factory(rt),Tt=this.hasRTLText=this.hasRTLText||Vc(at);(!Tt||"unavailable"===Fu.getRTLTextPluginStatus()||Tt&&Fu.isParsed())&&(Ho=Tu(at,qt,Do))}if(ss){const rt=qt.getValueAndResolveTokens("icon-image",Do,$t,Cs);Ea=rt instanceof Pe?rt:Pe.fromString(rt)}if(!Ho&&!Ea)continue;const La=this.sortFeaturesByKey?os.evaluate(Do,{},$t):void 0;if(this.features.push({id:Hr,text:Ho,icon:Ea,index:wn,sourceLayerIndex:Eo,geometry:Do.geometry,properties:Tt.properties,type:vp[Tt.type],sortKey:La}),Ea&&(cs[Ea.name]=!0),Ho){const rt=ge.evaluate(Do,{},$t).join(","),Tt="viewport"!==Kt.get("text-rotation-alignment")&&"point"!==Kt.get("symbol-placement");this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(at.al.vertical)>=0;for(const at of Ho.sections)if(at.image)cs[at.image.name]=!0;else{const $t=rs(Ho.toString()),qt=at.fontStack||rt,Kt=ds[qt]=ds[qt]||{};this.calculateGlyphDependencies(at.text,Kt,Tt,this.allowVerticalPlacement,$t)}}}"line"===Kt.get("symbol-placement")&&(this.features=function(rt){const at={},Tt={},$t=[];let qt=0;function s(at){$t.push(rt[at]),qt++}function a(rt,at,qt){const Kt=Tt[rt];return delete Tt[rt],Tt[at]=Kt,$t[Kt].geometry[0].pop(),$t[Kt].geometry[0]=$t[Kt].geometry[0].concat(qt[0]),Kt}function o(rt,Tt,qt){const Kt=at[Tt];return delete at[Tt],at[rt]=Kt,$t[Kt].geometry[0].shift(),$t[Kt].geometry[0]=qt[0].concat($t[Kt].geometry[0]),Kt}function l(rt,at,Tt){const $t=Tt?at[0][at[0].length-1]:at[0][0];return`${rt}:${$t.x}:${$t.y}`}for(let Kt=0;Kt<rt.length;Kt++){const ge=rt[Kt],Hr=ge.geometry,wn=ge.text?ge.text.toString():null;if(!wn){s(Kt);continue}const es=l(wn,Hr),ss=l(wn,Hr,!0);if(es in Tt&&ss in at&&Tt[es]!==at[ss]){const rt=o(es,ss,Hr),qt=a(es,ss,$t[rt].geometry);delete at[es],delete Tt[ss],Tt[l(wn,$t[qt].geometry,!0)]=qt,$t[rt].geometry=null}else es in Tt?a(es,ss,Hr):ss in at?o(es,ss,Hr):(s(Kt),at[es]=qt-1,Tt[ss]=qt-1)}return $t.filter((rt=>rt.geometry))}(this.features)),this.sortFeaturesByKey&&this.features.sort(((rt,at)=>rt.sortKey-at.sortKey))}update(rt,at,Tt){this.stateDependentLayers.length&&(this.text.programConfigurations.updatePaintArrays(rt,at,this.layers,Tt),this.icon.programConfigurations.updatePaintArrays(rt,at,this.layers,Tt))}isEmpty(){return 0===this.symbolInstances.length&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(rt){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(rt),this.iconCollisionBox.upload(rt)),this.text.upload(rt,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload),this.icon.upload(rt,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(rt,at){const Tt=this.lineVertexArray.length;if(void 0!==rt.segment){let Tt=rt.dist(at[rt.segment+1]),$t=rt.dist(at[rt.segment]);const qt={};for(let $t=rt.segment+1;$t<at.length;$t++)qt[$t]={x:at[$t].x,y:at[$t].y,tileUnitDistanceFromAnchor:Tt},$t<at.length-1&&(Tt+=at[$t+1].dist(at[$t]));for(let Tt=rt.segment||0;Tt>=0;Tt--)qt[Tt]={x:at[Tt].x,y:at[Tt].y,tileUnitDistanceFromAnchor:$t},Tt>0&&($t+=at[Tt-1].dist(at[Tt]));for(let rt=0;rt<at.length;rt++){const at=qt[rt];this.lineVertexArray.emplaceBack(at.x,at.y,at.tileUnitDistanceFromAnchor)}}return{lineStartIndex:Tt,lineLength:this.lineVertexArray.length-Tt}}addSymbols(rt,Tt,$t,qt,Kt,ge,Hr,wn,es,ss,os,cs){const ds=rt.indexArray,Cs=rt.layoutVertexArray,Vs=rt.segments.prepareSegment(4*Tt.length,Cs,ds,this.canOverlap?ge.sortKey:void 0),Eo=this.glyphOffsetArray.length,Do=Vs.vertexLength,Ho=this.allowVerticalPlacement&&Hr===at.al.vertical?Math.PI/2:0,Ea=ge.text&&ge.text.sections;for(let at=0;at<Tt.length;at++){const{tl:qt,tr:Kt,bl:Hr,br:es,tex:ss,pixelOffsetTL:os,pixelOffsetBR:Eo,minFontScaleX:Do,minFontScaleY:La,glyphOffset:ja,isSDF:Va,sectionIndex:Na}=Tt[at],qa=Vs.vertexLength,Qa=ja[1];Cc(Cs,wn.x,wn.y,qt.x,Qa+qt.y,ss.x,ss.y,$t,Va,os.x,os.y,Do,La),Cc(Cs,wn.x,wn.y,Kt.x,Qa+Kt.y,ss.x+ss.w,ss.y,$t,Va,Eo.x,os.y,Do,La),Cc(Cs,wn.x,wn.y,Hr.x,Qa+Hr.y,ss.x,ss.y+ss.h,$t,Va,os.x,Eo.y,Do,La),Cc(Cs,wn.x,wn.y,es.x,Qa+es.y,ss.x+ss.w,ss.y+ss.h,$t,Va,Eo.x,Eo.y,Do,La),Bc(rt.dynamicLayoutVertexArray,wn,Ho),ds.emplaceBack(qa,qa+2,qa+1),ds.emplaceBack(qa+1,qa+2,qa+3),Vs.vertexLength+=4,Vs.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(ja[0]),at!==Tt.length-1&&Na===Tt[at+1].sectionIndex||rt.programConfigurations.populatePaintArrays(Cs.length,ge,ge.index,{},cs,Ea&&Ea[Na])}rt.placedSymbolArray.emplaceBack(wn.x,wn.y,Eo,this.glyphOffsetArray.length-Eo,Do,es,ss,wn.segment,$t?$t[0]:0,$t?$t[1]:0,qt[0],qt[1],Hr,0,!1,0,os)}_addCollisionDebugVertex(rt,at,Tt,$t,qt,Kt){return at.emplaceBack(0,0),rt.emplaceBack(Tt.x,Tt.y,$t,qt,Math.round(Kt.x),Math.round(Kt.y))}addCollisionDebugVertices(rt,at,Tt,$t,qt,Kt,Hr){const wn=qt.segments.prepareSegment(4,qt.layoutVertexArray,qt.indexArray),es=wn.vertexLength,ss=qt.layoutVertexArray,os=qt.collisionVertexArray,cs=Hr.anchorX,ds=Hr.anchorY;this._addCollisionDebugVertex(ss,os,Kt,cs,ds,new ge(rt,at)),this._addCollisionDebugVertex(ss,os,Kt,cs,ds,new ge(Tt,at)),this._addCollisionDebugVertex(ss,os,Kt,cs,ds,new ge(Tt,$t)),this._addCollisionDebugVertex(ss,os,Kt,cs,ds,new ge(rt,$t)),wn.vertexLength+=4;const Cs=qt.indexArray;Cs.emplaceBack(es,es+1),Cs.emplaceBack(es+1,es+2),Cs.emplaceBack(es+2,es+3),Cs.emplaceBack(es+3,es),wn.primitiveLength+=4}addDebugCollisionBoxes(rt,at,Tt,$t){for(let qt=rt;qt<at;qt++){const rt=this.collisionBoxArray.get(qt);this.addCollisionDebugVertices(rt.x1,rt.y1,rt.x2,rt.y2,$t?this.textCollisionBox:this.iconCollisionBox,rt.anchorPoint,Tt)}}generateCollisionDebugBuffers(){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new Tc(za,Qd.members,Ba),this.iconCollisionBox=new Tc(za,Qd.members,Ba);for(let rt=0;rt<this.symbolInstances.length;rt++){const at=this.symbolInstances.get(rt);this.addDebugCollisionBoxes(at.textBoxStartIndex,at.textBoxEndIndex,at,!0),this.addDebugCollisionBoxes(at.verticalTextBoxStartIndex,at.verticalTextBoxEndIndex,at,!0),this.addDebugCollisionBoxes(at.iconBoxStartIndex,at.iconBoxEndIndex,at,!1),this.addDebugCollisionBoxes(at.verticalIconBoxStartIndex,at.verticalIconBoxEndIndex,at,!1)}}_deserializeCollisionBoxesForSymbol(rt,at,Tt,$t,qt,Kt,ge,Hr,wn){const es={};for(let $t=at;$t<Tt;$t++){const at=rt.get($t);es.textBox={x1:at.x1,y1:at.y1,x2:at.x2,y2:at.y2,anchorPointX:at.anchorPointX,anchorPointY:at.anchorPointY},es.textFeatureIndex=at.featureIndex;break}for(let at=$t;at<qt;at++){const Tt=rt.get(at);es.verticalTextBox={x1:Tt.x1,y1:Tt.y1,x2:Tt.x2,y2:Tt.y2,anchorPointX:Tt.anchorPointX,anchorPointY:Tt.anchorPointY},es.verticalTextFeatureIndex=Tt.featureIndex;break}for(let at=Kt;at<ge;at++){const Tt=rt.get(at);es.iconBox={x1:Tt.x1,y1:Tt.y1,x2:Tt.x2,y2:Tt.y2,anchorPointX:Tt.anchorPointX,anchorPointY:Tt.anchorPointY},es.iconFeatureIndex=Tt.featureIndex;break}for(let at=Hr;at<wn;at++){const Tt=rt.get(at);es.verticalIconBox={x1:Tt.x1,y1:Tt.y1,x2:Tt.x2,y2:Tt.y2,anchorPointX:Tt.anchorPointX,anchorPointY:Tt.anchorPointY},es.verticalIconFeatureIndex=Tt.featureIndex;break}return es}deserializeCollisionBoxes(rt){this.collisionArrays=[];for(let at=0;at<this.symbolInstances.length;at++){const Tt=this.symbolInstances.get(at);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(rt,Tt.textBoxStartIndex,Tt.textBoxEndIndex,Tt.verticalTextBoxStartIndex,Tt.verticalTextBoxEndIndex,Tt.iconBoxStartIndex,Tt.iconBoxEndIndex,Tt.verticalIconBoxStartIndex,Tt.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}addIndicesForPlacedSymbol(rt,at){const Tt=rt.placedSymbolArray.get(at),$t=Tt.vertexStartIndex+4*Tt.numGlyphs;for(let at=Tt.vertexStartIndex;at<$t;at+=4)rt.indexArray.emplaceBack(at,at+2,at+1),rt.indexArray.emplaceBack(at+1,at+2,at+3)}getSortedSymbolIndexes(rt){if(this.sortedAngle===rt&&void 0!==this.symbolInstanceIndexes)return this.symbolInstanceIndexes;const at=Math.sin(rt),Tt=Math.cos(rt),$t=[],qt=[],Kt=[];for(let rt=0;rt<this.symbolInstances.length;++rt){Kt.push(rt);const ge=this.symbolInstances.get(rt);$t.push(0|Math.round(at*ge.anchorX+Tt*ge.anchorY)),qt.push(ge.featureIndex)}return Kt.sort(((rt,at)=>$t[rt]-$t[at]||qt[at]-qt[rt])),Kt}addToSortKeyRanges(rt,at){const Tt=this.sortKeyRanges[this.sortKeyRanges.length-1];Tt&&Tt.sortKey===at?Tt.symbolInstanceEnd=rt+1:this.sortKeyRanges.push({sortKey:at,symbolInstanceStart:rt,symbolInstanceEnd:rt+1})}sortFeatures(rt){if(this.sortFeaturesByY&&this.sortedAngle!==rt&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(rt),this.sortedAngle=rt,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const rt of this.symbolInstanceIndexes){const at=this.symbolInstances.get(rt);this.featureSortOrder.push(at.featureIndex),[at.rightJustifiedTextSymbolIndex,at.centerJustifiedTextSymbolIndex,at.leftJustifiedTextSymbolIndex].forEach(((rt,at,Tt)=>{rt>=0&&Tt.indexOf(rt)===at&&this.addIndicesForPlacedSymbol(this.text,rt)})),at.verticalPlacedTextSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.text,at.verticalPlacedTextSymbolIndex),at.placedIconSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.icon,at.placedIconSymbolIndex),at.verticalPlacedIconSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.icon,at.verticalPlacedIconSymbolIndex)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}let wp,Tp;Xi("SymbolBucket",Fc,{omit:["layers","collisionBoxArray","features","compareText"]}),Fc.MAX_GLYPHS=65535,Fc.addDynamicAttributes=Bc;var Pp={get paint(){return Tp=Tp||new Ps({"icon-opacity":new ks(Dl.paint_symbol["icon-opacity"]),"icon-color":new ks(Dl.paint_symbol["icon-color"]),"icon-halo-color":new ks(Dl.paint_symbol["icon-halo-color"]),"icon-halo-width":new ks(Dl.paint_symbol["icon-halo-width"]),"icon-halo-blur":new ks(Dl.paint_symbol["icon-halo-blur"]),"icon-translate":new As(Dl.paint_symbol["icon-translate"]),"icon-translate-anchor":new As(Dl.paint_symbol["icon-translate-anchor"]),"text-opacity":new ks(Dl.paint_symbol["text-opacity"]),"text-color":new ks(Dl.paint_symbol["text-color"],{runtimeType:Ul,getOverride:rt=>rt.textColor,hasOverride:rt=>!!rt.textColor}),"text-halo-color":new ks(Dl.paint_symbol["text-halo-color"]),"text-halo-width":new ks(Dl.paint_symbol["text-halo-width"]),"text-halo-blur":new ks(Dl.paint_symbol["text-halo-blur"]),"text-translate":new As(Dl.paint_symbol["text-translate"]),"text-translate-anchor":new As(Dl.paint_symbol["text-translate-anchor"])})},get layout(){return wp=wp||new Ps({"symbol-placement":new As(Dl.layout_symbol["symbol-placement"]),"symbol-spacing":new As(Dl.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new As(Dl.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new ks(Dl.layout_symbol["symbol-sort-key"]),"symbol-z-order":new As(Dl.layout_symbol["symbol-z-order"]),"icon-allow-overlap":new As(Dl.layout_symbol["icon-allow-overlap"]),"icon-overlap":new As(Dl.layout_symbol["icon-overlap"]),"icon-ignore-placement":new As(Dl.layout_symbol["icon-ignore-placement"]),"icon-optional":new As(Dl.layout_symbol["icon-optional"]),"icon-rotation-alignment":new As(Dl.layout_symbol["icon-rotation-alignment"]),"icon-size":new ks(Dl.layout_symbol["icon-size"]),"icon-text-fit":new As(Dl.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new As(Dl.layout_symbol["icon-text-fit-padding"]),"icon-image":new ks(Dl.layout_symbol["icon-image"]),"icon-rotate":new ks(Dl.layout_symbol["icon-rotate"]),"icon-padding":new ks(Dl.layout_symbol["icon-padding"]),"icon-keep-upright":new As(Dl.layout_symbol["icon-keep-upright"]),"icon-offset":new ks(Dl.layout_symbol["icon-offset"]),"icon-anchor":new ks(Dl.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new As(Dl.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new As(Dl.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new As(Dl.layout_symbol["text-rotation-alignment"]),"text-field":new ks(Dl.layout_symbol["text-field"]),"text-font":new ks(Dl.layout_symbol["text-font"]),"text-size":new ks(Dl.layout_symbol["text-size"]),"text-max-width":new ks(Dl.layout_symbol["text-max-width"]),"text-line-height":new As(Dl.layout_symbol["text-line-height"]),"text-letter-spacing":new ks(Dl.layout_symbol["text-letter-spacing"]),"text-justify":new ks(Dl.layout_symbol["text-justify"]),"text-radial-offset":new ks(Dl.layout_symbol["text-radial-offset"]),"text-variable-anchor":new As(Dl.layout_symbol["text-variable-anchor"]),"text-variable-anchor-offset":new ks(Dl.layout_symbol["text-variable-anchor-offset"]),"text-anchor":new ks(Dl.layout_symbol["text-anchor"]),"text-max-angle":new As(Dl.layout_symbol["text-max-angle"]),"text-writing-mode":new As(Dl.layout_symbol["text-writing-mode"]),"text-rotate":new ks(Dl.layout_symbol["text-rotate"]),"text-padding":new As(Dl.layout_symbol["text-padding"]),"text-keep-upright":new As(Dl.layout_symbol["text-keep-upright"]),"text-transform":new ks(Dl.layout_symbol["text-transform"]),"text-offset":new ks(Dl.layout_symbol["text-offset"]),"text-allow-overlap":new As(Dl.layout_symbol["text-allow-overlap"]),"text-overlap":new As(Dl.layout_symbol["text-overlap"]),"text-ignore-placement":new As(Dl.layout_symbol["text-ignore-placement"]),"text-optional":new As(Dl.layout_symbol["text-optional"])})}};class Dc{constructor(rt){if(void 0===rt.property.overrides)throw new Error("overrides must be provided to instantiate FormatSectionOverride class");this.type=rt.property.overrides?rt.property.overrides.runtimeType:Ol,this.defaultValue=rt}evaluate(rt){if(rt.formattedSection){const at=this.defaultValue.property.overrides;if(at&&at.hasOverride(rt.formattedSection))return at.getOverride(rt.formattedSection)}return rt.feature&&rt.featureState?this.defaultValue.evaluate(rt.feature,rt.featureState):this.defaultValue.property.specification.default}eachChild(rt){this.defaultValue.isConstant()||rt(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}Xi("FormatSectionOverride",Dc,{omit:["defaultValue"]});class Rc extends Bs{constructor(rt){super(rt,Pp)}recalculate(rt,at){if(super.recalculate(rt,at),"auto"===this.layout.get("icon-rotation-alignment")&&(this.layout._values["icon-rotation-alignment"]="point"!==this.layout.get("symbol-placement")?"map":"viewport"),"auto"===this.layout.get("text-rotation-alignment")&&(this.layout._values["text-rotation-alignment"]="point"!==this.layout.get("symbol-placement")?"map":"viewport"),"auto"===this.layout.get("text-pitch-alignment")&&(this.layout._values["text-pitch-alignment"]="map"===this.layout.get("text-rotation-alignment")?"map":"viewport"),"auto"===this.layout.get("icon-pitch-alignment")&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment")),"point"===this.layout.get("symbol-placement")){const rt=this.layout.get("text-writing-mode");if(rt){const at=[];for(const Tt of rt)at.indexOf(Tt)<0&&at.push(Tt);this.layout._values["text-writing-mode"]=at}else this.layout._values["text-writing-mode"]=["horizontal"]}this._setPaintOverrides()}getValueAndResolveTokens(rt,at,Tt,$t){const qt=this.layout.get(rt).evaluate(at,{},Tt,$t),Kt=this._unevaluatedLayout._values[rt];return Kt.isDataDriven()||Zn(Kt.value)||!qt?qt:function(rt,at){return at.replace(/{([^{}]+)}/g,((at,Tt)=>rt&&Tt in rt?String(rt[Tt]):""))}(at.properties,qt)}createBucket(rt){return new Fc(rt)}queryRadius(){return 0}queryIntersectsFeature(){throw new Error("Should take a different path in FeatureIndex")}_setPaintOverrides(){for(const rt of Pp.paint.overridableProperties){if(!Rc.hasPaintOverride(this.layout,rt))continue;const at=this.paint.get(rt),Tt=new Dc(at),$t=new Gn(Tt,at.property.specification);let qt=null;qt="constant"===at.value.kind||"source"===at.value.kind?new Xn("source",$t):new Hn("composite",$t,at.value.zoomStops),this.paint._values[rt]=new _s(at.property,qt,at.parameters)}}_handleOverridablePaintPropertyUpdate(rt,at,Tt){return!(!this.layout||at.isDataDriven()||Tt.isDataDriven())&&Rc.hasPaintOverride(this.layout,rt)}static hasPaintOverride(rt,at){const Tt=rt.get("text-field"),$t=Pp.paint.properties[at];let qt=!1;const s=rt=>{for(const at of rt)if($t.overrides&&$t.overrides.hasOverride(at))return void(qt=!0)};if("constant"===Tt.value.kind&&Tt.value.value instanceof Ae)s(Tt.value.value.sections);else if("source"===Tt.value.kind){const t=rt=>{qt||(rt instanceof Fe&&Ee(rt.value)===Kl?s(rt.value.sections):rt instanceof vr?s(rt.sections):rt.eachChild(t))},rt=Tt.value;rt._styleExpression&&t(rt._styleExpression.expression)}return qt}}let Mp;var Sp={get paint(){return Mp=Mp||new Ps({"background-color":new As(Dl.paint_background["background-color"]),"background-pattern":new Is(Dl.paint_background["background-pattern"]),"background-opacity":new As(Dl.paint_background["background-opacity"])})}};class Uc extends Bs{constructor(rt){super(rt,Sp)}}let Ip;var Cp={get paint(){return Ip=Ip||new Ps({"raster-opacity":new As(Dl.paint_raster["raster-opacity"]),"raster-hue-rotate":new As(Dl.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new As(Dl.paint_raster["raster-brightness-min"]),"raster-brightness-max":new As(Dl.paint_raster["raster-brightness-max"]),"raster-saturation":new As(Dl.paint_raster["raster-saturation"]),"raster-contrast":new As(Dl.paint_raster["raster-contrast"]),"raster-resampling":new As(Dl.paint_raster["raster-resampling"]),"raster-fade-duration":new As(Dl.paint_raster["raster-fade-duration"])})}};class Zc extends Bs{constructor(rt){super(rt,Cp)}}class Kc extends Bs{constructor(rt){super(rt,{}),this.onAdd=rt=>{this.implementation.onAdd&&this.implementation.onAdd(rt,rt.painter.context.gl)},this.onRemove=rt=>{this.implementation.onRemove&&this.implementation.onRemove(rt,rt.painter.context.gl)},this.implementation=rt}is3D(){return"3d"===this.implementation.renderingMode}hasOffscreenPass(){return void 0!==this.implementation.prerender}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){throw new Error("Custom layers cannot be serialized")}}class Xc{constructor(rt){this._methodToThrottle=rt,this._triggered=!1,"undefined"!=typeof MessageChannel&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._methodToThrottle()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout((()=>{this._triggered=!1,this._methodToThrottle()}),0))}remove(){delete this._channel,this._methodToThrottle=()=>{}}}const Ap={once:!0},Ep=6371008.8;class Jc{constructor(rt,at){if(isNaN(rt)||isNaN(at))throw new Error(`Invalid LngLat object: (${rt}, ${at})`);if(this.lng=+rt,this.lat=+at,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new Jc($(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(rt){const at=Math.PI/180,Tt=this.lat*at,$t=rt.lat*at,qt=Math.sin(Tt)*Math.sin($t)+Math.cos(Tt)*Math.cos($t)*Math.cos((rt.lng-this.lng)*at);return Ep*Math.acos(Math.min(qt,1))}static convert(rt){if(rt instanceof Jc)return rt;if(Array.isArray(rt)&&(2===rt.length||3===rt.length))return new Jc(Number(rt[0]),Number(rt[1]));if(!Array.isArray(rt)&&"object"==typeof rt&&null!==rt)return new Jc(Number("lng"in rt?rt.lng:rt.lon),Number(rt.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}const zp=2*Math.PI*Ep;function Qc(rt){return zp*Math.cos(rt*Math.PI/180)}function th(rt){return(180+rt)/360}function eh(rt){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+rt*Math.PI/360)))/360}function rh(rt,at){return rt/Qc(at)}function nh(rt){return 360/Math.PI*Math.atan(Math.exp((180-360*rt)*Math.PI/180))-90}function ih(rt,at){return rt*Qc(nh(at))}class sh{constructor(rt,at,Tt=0){this.x=+rt,this.y=+at,this.z=+Tt}static fromLngLat(rt,at=0){const Tt=Jc.convert(rt);return new sh(th(Tt.lng),eh(Tt.lat),rh(at,Tt.lat))}toLngLat(){return new Jc(360*this.x-180,nh(this.y))}toAltitude(){return ih(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/zp*(rt=nh(this.y),1/Math.cos(rt*Math.PI/180));var rt}}function ah(rt,at,Tt){var $t=2*Math.PI*6378137/256/Math.pow(2,Tt);return[rt*$t-2*Math.PI*6378137/2,at*$t-2*Math.PI*6378137/2]}class oh{constructor(rt,at,Tt){if(!function(rt,at,Tt){return!(rt<0||rt>25||Tt<0||Tt>=Math.pow(2,rt)||at<0||at>=Math.pow(2,rt))}(rt,at,Tt))throw new Error(`x=${at}, y=${Tt}, z=${rt} outside of bounds. 0<=x<${Math.pow(2,rt)}, 0<=y<${Math.pow(2,rt)} 0<=z<=25 `);this.z=rt,this.x=at,this.y=Tt,this.key=ch(0,rt,rt,at,Tt)}equals(rt){return this.z===rt.z&&this.x===rt.x&&this.y===rt.y}url(rt,at,Tt){const $t=(Kt=this.y,ge=this.z,Hr=ah(256*(qt=this.x),256*(Kt=Math.pow(2,ge)-Kt-1),ge),wn=ah(256*(qt+1),256*(Kt+1),ge),Hr[0]+","+Hr[1]+","+wn[0]+","+wn[1]);var qt,Kt,ge,Hr,wn;const es=function(rt,at,Tt){let $t,qt="";for(let Kt=rt;Kt>0;Kt--)$t=1<<Kt-1,qt+=(at&$t?1:0)+(Tt&$t?2:0);return qt}(this.z,this.x,this.y);return rt[(this.x+this.y)%rt.length].replace(/{prefix}/g,(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String("tms"===Tt?Math.pow(2,this.z)-this.y-1:this.y)).replace(/{ratio}/g,at>1?"@2x":"").replace(/{quadkey}/g,es).replace(/{bbox-epsg-3857}/g,$t)}isChildOf(rt){const at=this.z-rt.z;return at>0&&rt.x===this.x>>at&&rt.y===this.y>>at}getTilePoint(rt){const at=Math.pow(2,this.z);return new ge((rt.x*at-this.x)*Vs,(rt.y*at-this.y)*Vs)}toString(){return`${this.z}/${this.x}/${this.y}`}}class lh{constructor(rt,at){this.wrap=rt,this.canonical=at,this.key=ch(rt,at.z,at.z,at.x,at.y)}}class uh{constructor(rt,at,Tt,$t,qt){if(this.terrainRttPosMatrix32f=null,rt<Tt)throw new Error(`overscaledZ should be >= z; overscaledZ = ${rt}; z = ${Tt}`);this.overscaledZ=rt,this.wrap=at,this.canonical=new oh(Tt,+$t,+qt),this.key=ch(at,rt,Tt,$t,qt)}clone(){return new uh(this.overscaledZ,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)}equals(rt){return this.overscaledZ===rt.overscaledZ&&this.wrap===rt.wrap&&this.canonical.equals(rt.canonical)}scaledTo(rt){if(rt>this.overscaledZ)throw new Error(`targetZ > this.overscaledZ; targetZ = ${rt}; overscaledZ = ${this.overscaledZ}`);const at=this.canonical.z-rt;return rt>this.canonical.z?new uh(rt,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new uh(rt,this.wrap,rt,this.canonical.x>>at,this.canonical.y>>at)}calculateScaledKey(rt,at){if(rt>this.overscaledZ)throw new Error(`targetZ > this.overscaledZ; targetZ = ${rt}; overscaledZ = ${this.overscaledZ}`);const Tt=this.canonical.z-rt;return rt>this.canonical.z?ch(this.wrap*+at,rt,this.canonical.z,this.canonical.x,this.canonical.y):ch(this.wrap*+at,rt,rt,this.canonical.x>>Tt,this.canonical.y>>Tt)}isChildOf(rt){if(rt.wrap!==this.wrap)return!1;const at=this.canonical.z-rt.canonical.z;return 0===rt.overscaledZ||rt.overscaledZ<this.overscaledZ&&rt.canonical.x===this.canonical.x>>at&&rt.canonical.y===this.canonical.y>>at}children(rt){if(this.overscaledZ>=rt)return[new uh(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const at=this.canonical.z+1,Tt=2*this.canonical.x,$t=2*this.canonical.y;return[new uh(at,this.wrap,at,Tt,$t),new uh(at,this.wrap,at,Tt+1,$t),new uh(at,this.wrap,at,Tt,$t+1),new uh(at,this.wrap,at,Tt+1,$t+1)]}isLessThan(rt){return this.wrap<rt.wrap||!(this.wrap>rt.wrap)&&(this.overscaledZ<rt.overscaledZ||!(this.overscaledZ>rt.overscaledZ)&&(this.canonical.x<rt.canonical.x||!(this.canonical.x>rt.canonical.x)&&this.canonical.y<rt.canonical.y))}wrapped(){return new uh(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(rt){return new uh(this.overscaledZ,rt,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new lh(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}getTilePoint(rt){return this.canonical.getTilePoint(new sh(rt.x-this.wrap,rt.y))}}function ch(rt,at,Tt,$t,qt){(rt*=2)<0&&(rt=-1*rt-1);const Kt=1<<Tt;return(Kt*Kt*rt+Kt*qt+$t).toString(36)+Tt.toString(36)+at.toString(36)}Xi("CanonicalTileID",oh),Xi("OverscaledTileID",uh,{omit:["terrainRttPosMatrix32f"]});class hh{constructor(rt,at,Tt,$t=1,qt=1,Kt=1,ge=0){if(this.uid=rt,at.height!==at.width)throw new RangeError("DEM tiles must be square");if(Tt&&!["mapbox","terrarium","custom"].includes(Tt))return void U(`"${Tt}" is not a valid encoding type. Valid types include "mapbox", "terrarium" and "custom".`);this.stride=at.height;const Hr=this.dim=at.height-2;switch(this.data=new Uint32Array(at.data.buffer),Tt){case"terrarium":this.redFactor=256,this.greenFactor=1,this.blueFactor=1/256,this.baseShift=32768;break;case"custom":this.redFactor=$t,this.greenFactor=qt,this.blueFactor=Kt,this.baseShift=ge;break;default:this.redFactor=6553.6,this.greenFactor=25.6,this.blueFactor=.1,this.baseShift=1e4}for(let rt=0;rt<Hr;rt++)this.data[this._idx(-1,rt)]=this.data[this._idx(0,rt)],this.data[this._idx(Hr,rt)]=this.data[this._idx(Hr-1,rt)],this.data[this._idx(rt,-1)]=this.data[this._idx(rt,0)],this.data[this._idx(rt,Hr)]=this.data[this._idx(rt,Hr-1)];this.data[this._idx(-1,-1)]=this.data[this._idx(0,0)],this.data[this._idx(Hr,-1)]=this.data[this._idx(Hr-1,0)],this.data[this._idx(-1,Hr)]=this.data[this._idx(0,Hr-1)],this.data[this._idx(Hr,Hr)]=this.data[this._idx(Hr-1,Hr-1)],this.min=Number.MAX_SAFE_INTEGER,this.max=Number.MIN_SAFE_INTEGER;for(let rt=0;rt<Hr;rt++)for(let at=0;at<Hr;at++){const Tt=this.get(rt,at);Tt>this.max&&(this.max=Tt),Tt<this.min&&(this.min=Tt)}}get(rt,at){const Tt=new Uint8Array(this.data.buffer),$t=4*this._idx(rt,at);return this.unpack(Tt[$t],Tt[$t+1],Tt[$t+2])}getUnpackVector(){return[this.redFactor,this.greenFactor,this.blueFactor,this.baseShift]}_idx(rt,at){if(rt<-1||rt>=this.dim+1||at<-1||at>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(at+1)*this.stride+(rt+1)}unpack(rt,at,Tt){return rt*this.redFactor+at*this.greenFactor+Tt*this.blueFactor-this.baseShift}getPixels(){return new qo({width:this.stride,height:this.stride},new Uint8Array(this.data.buffer))}backfillBorder(rt,at,Tt){if(this.dim!==rt.dim)throw new Error("dem dimension mismatch");let $t=at*this.dim,qt=at*this.dim+this.dim,Kt=Tt*this.dim,ge=Tt*this.dim+this.dim;switch(at){case-1:$t=qt-1;break;case 1:qt=$t+1}switch(Tt){case-1:Kt=ge-1;break;case 1:ge=Kt+1}const Hr=-at*this.dim,wn=-Tt*this.dim;for(let at=Kt;at<ge;at++)for(let Tt=$t;Tt<qt;Tt++)this.data[this._idx(Tt,at)]=rt.data[this._idx(Tt+Hr,at+wn)]}}Xi("DEMData",hh);class ph{constructor(rt){this._stringToNumber={},this._numberToString=[];for(let at=0;at<rt.length;at++){const Tt=rt[at];this._stringToNumber[Tt]=at,this._numberToString[at]=Tt}}encode(rt){return this._stringToNumber[rt]}decode(rt){if(rt>=this._numberToString.length)throw new Error(`Out of bounds. Index requested n=${rt} can't be >= this._numberToString.length ${this._numberToString.length}`);return this._numberToString[rt]}}class fh{constructor(rt,at,Tt,$t,qt){this.type="Feature",this._vectorTileFeature=rt,rt._z=at,rt._x=Tt,rt._y=$t,this.properties=rt.properties,this.id=qt}get geometry(){return void 0===this._geometry&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._vectorTileFeature._x,this._vectorTileFeature._y,this._vectorTileFeature._z).geometry),this._geometry}set geometry(rt){this._geometry=rt}toJSON(){const rt={geometry:this.geometry};for(const at in this)"_geometry"!==at&&"_vectorTileFeature"!==at&&(rt[at]=this[at]);return rt}}class dh{constructor(rt,at){this.tileID=rt,this.x=rt.canonical.x,this.y=rt.canonical.y,this.z=rt.canonical.z,this.grid=new Zi(Vs,16,0),this.grid3D=new Zi(Vs,16,0),this.featureIndexArray=new ga,this.promoteId=at}insert(rt,at,Tt,$t,qt,Kt){const ge=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(Tt,$t,qt);const Hr=Kt?this.grid3D:this.grid;for(let rt=0;rt<at.length;rt++){const Tt=at[rt],$t=[1/0,1/0,-1/0,-1/0];for(let rt=0;rt<Tt.length;rt++){const at=Tt[rt];$t[0]=Math.min($t[0],at.x),$t[1]=Math.min($t[1],at.y),$t[2]=Math.max($t[2],at.x),$t[3]=Math.max($t[3],at.y)}$t[0]<Vs&&$t[1]<Vs&&$t[2]>=0&&$t[3]>=0&&Hr.insert(ge,$t[0],$t[1],$t[2],$t[3])}}loadVTLayers(){return this.vtLayers||(this.vtLayers=new Rd.VectorTile(new lp(this.rawTileData)).layers,this.sourceLayerCoder=new ph(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"])),this.vtLayers}query(rt,at,Tt,$t){this.loadVTLayers();const qt=rt.params,Kt=Vs/rt.tileSize/rt.scale,Hr=ei(qt.filter),wn=rt.queryGeometry,es=rt.queryPadding*Kt,ss=mh(wn),os=this.grid.query(ss.minX-es,ss.minY-es,ss.maxX+es,ss.maxY+es),cs=mh(rt.cameraQueryGeometry),ds=this.grid3D.query(cs.minX-es,cs.minY-es,cs.maxX+es,cs.maxY+es,((at,Tt,$t,qt)=>function(rt,at,Tt,$t,qt){for(const Kt of rt)if(at<=Kt.x&&Tt<=Kt.y&&$t>=Kt.x&&qt>=Kt.y)return!0;const Kt=[new ge(at,Tt),new ge(at,qt),new ge($t,qt),new ge($t,Tt)];if(rt.length>2)for(const at of Kt)if(Io(rt,at))return!0;for(let at=0;at<rt.length-1;at++)if(zo(rt[at],rt[at+1],Kt))return!0;return!1}(rt.cameraQueryGeometry,at-es,Tt-es,$t+es,qt+es)));for(const rt of ds)os.push(rt);os.sort(gh);const Cs={};let Eo;for(let ge=0;ge<os.length;ge++){const es=os[ge];if(es===Eo)continue;Eo=es;const ss=this.featureIndexArray.get(es);let cs=null;this.loadMatchingFeature(Cs,ss.bucketIndex,ss.sourceLayerIndex,ss.featureIndex,Hr,qt.layers,qt.availableImages,at,Tt,$t,((at,Tt,$t)=>(cs||(cs=po(at)),Tt.queryIntersectsFeature({queryGeometry:wn,feature:at,featureState:$t,geometry:cs,zoom:this.z,transform:rt.transform,pixelsToTileUnits:Kt,pixelPosMatrix:rt.pixelPosMatrix,unwrappedTileID:this.tileID.toUnwrapped(),getElevation:rt.getElevation}))))}return Cs}loadMatchingFeature(rt,at,Tt,$t,qt,Kt,ge,Hr,wn,es,ss){const os=this.bucketLayerIDs[at];if(Kt&&!os.some((rt=>Kt.has(rt))))return;const cs=this.sourceLayerCoder.decode(Tt),ds=this.vtLayers[cs].feature($t);if(qt.needGeometry){const rt=fo(ds,!0);if(!qt.filter(new ys(this.tileID.overscaledZ),rt,this.tileID.canonical))return}else if(!qt.filter(new ys(this.tileID.overscaledZ),ds))return;const Cs=this.getId(ds,cs);for(let at=0;at<os.length;at++){const Tt=os[at];if(Kt&&!Kt.has(Tt))continue;const qt=Hr[Tt];if(!qt)continue;let cs={};Cs&&es&&(cs=es.getState(qt.sourceLayer||"_geojsonTileLayer",Cs));const Vs=L({},wn[Tt]);Vs.paint=yh(Vs.paint,qt.paint,ds,cs,ge),Vs.layout=yh(Vs.layout,qt.layout,ds,cs,ge);const Eo=!ss||ss(ds,qt,cs);if(!Eo)continue;const Do=new fh(ds,this.z,this.x,this.y,Cs);Do.layer=Vs;let Ho=rt[Tt];void 0===Ho&&(Ho=rt[Tt]=[]),Ho.push({featureIndex:$t,feature:Do,intersectionZ:Eo})}}lookupSymbolFeatures(rt,at,Tt,$t,qt,Kt,ge,Hr){const wn={};this.loadVTLayers();const es=ei(qt);for(const qt of rt)this.loadMatchingFeature(wn,Tt,$t,qt,es,Kt,ge,Hr,at);return wn}hasLayer(rt){for(const at of this.bucketLayerIDs)for(const Tt of at)if(rt===Tt)return!0;return!1}getId(rt,at){var Tt;let $t=rt.id;return this.promoteId&&($t=rt.properties["string"==typeof this.promoteId?this.promoteId:this.promoteId[at]],"boolean"==typeof $t&&($t=Number($t)),void 0===$t&&(null===(Tt=rt.properties)||void 0===Tt?void 0:Tt.cluster)&&this.promoteId&&($t=Number(rt.properties.cluster_id))),$t}}function yh(rt,at,Tt,$t,qt){return D(rt,((rt,Kt)=>{const ge=at instanceof Ss?at.get(Kt):null;return ge&&ge.evaluate?ge.evaluate(Tt,$t,qt):ge}))}function mh(rt){let at=1/0,Tt=1/0,$t=-1/0,qt=-1/0;for(const Kt of rt)at=Math.min(at,Kt.x),Tt=Math.min(Tt,Kt.y),$t=Math.max($t,Kt.x),qt=Math.max(qt,Kt.y);return{minX:at,minY:Tt,maxX:$t,maxY:qt}}function gh(rt,at){return at-rt}function xh(rt,at,Tt,$t,qt){const Kt=[];for(let Hr=0;Hr<rt.length;Hr++){const wn=rt[Hr];let es;for(let rt=0;rt<wn.length-1;rt++){let Hr=wn[rt],ss=wn[rt+1];Hr.x<at&&ss.x<at||(Hr.x<at?Hr=new ge(at,Hr.y+(at-Hr.x)/(ss.x-Hr.x)*(ss.y-Hr.y))._round():ss.x<at&&(ss=new ge(at,Hr.y+(at-Hr.x)/(ss.x-Hr.x)*(ss.y-Hr.y))._round()),Hr.y<Tt&&ss.y<Tt||(Hr.y<Tt?Hr=new ge(Hr.x+(Tt-Hr.y)/(ss.y-Hr.y)*(ss.x-Hr.x),Tt)._round():ss.y<Tt&&(ss=new ge(Hr.x+(Tt-Hr.y)/(ss.y-Hr.y)*(ss.x-Hr.x),Tt)._round()),Hr.x>=$t&&ss.x>=$t||(Hr.x>=$t?Hr=new ge($t,Hr.y+($t-Hr.x)/(ss.x-Hr.x)*(ss.y-Hr.y))._round():ss.x>=$t&&(ss=new ge($t,Hr.y+($t-Hr.x)/(ss.x-Hr.x)*(ss.y-Hr.y))._round()),Hr.y>=qt&&ss.y>=qt||(Hr.y>=qt?Hr=new ge(Hr.x+(qt-Hr.y)/(ss.y-Hr.y)*(ss.x-Hr.x),qt)._round():ss.y>=qt&&(ss=new ge(Hr.x+(qt-Hr.y)/(ss.y-Hr.y)*(ss.x-Hr.x),qt)._round()),es&&Hr.equals(es[es.length-1])||(es=[Hr],Kt.push(es)),es.push(ss)))))}}return Kt}Xi("FeatureIndex",dh,{omit:["rawTileData","sourceLayerCoder"]});class vh extends ge{constructor(rt,at,Tt,$t){super(rt,at),this.angle=Tt,void 0!==$t&&(this.segment=$t)}clone(){return new vh(this.x,this.y,this.angle,this.segment)}}function bh(rt,at,Tt,$t,qt){if(void 0===at.segment||0===Tt)return!0;let Kt=at,ge=at.segment+1,Hr=0;for(;Hr>-Tt/2;){if(ge--,ge<0)return!1;Hr-=rt[ge].dist(Kt),Kt=rt[ge]}Hr+=rt[ge].dist(rt[ge+1]),ge++;const wn=[];let es=0;for(;Hr<Tt/2;){const at=rt[ge],Tt=rt[ge+1];if(!Tt)return!1;let Kt=rt[ge-1].angleTo(at)-at.angleTo(Tt);for(Kt=Math.abs((Kt+3*Math.PI)%(2*Math.PI)-Math.PI),wn.push({distance:Hr,angleDelta:Kt}),es+=Kt;Hr-wn[0].distance>$t;)es-=wn.shift().angleDelta;if(es>qt)return!1;ge++,Hr+=at.dist(Tt)}return!0}function wh(rt){let at=0;for(let Tt=0;Tt<rt.length-1;Tt++)at+=rt[Tt].dist(rt[Tt+1]);return at}function _h(rt,at,Tt){return rt?.6*at*Tt:0}function Sh(rt,at){return Math.max(rt?rt.right-rt.left:0,at?at.right-at.left:0)}function Ah(rt,at,Tt,$t,qt,Kt){const ge=_h(Tt,qt,Kt),Hr=Sh(Tt,$t)*Kt;let wn=0;const es=wh(rt)/2;for(let Tt=0;Tt<rt.length-1;Tt++){const $t=rt[Tt],qt=rt[Tt+1],Kt=$t.dist(qt);if(wn+Kt>es){const ss=(es-wn)/Kt,os=Dh.number($t.x,qt.x,ss),cs=Dh.number($t.y,qt.y,ss),ds=new vh(os,cs,qt.angleTo($t),Tt);return ds._round(),!ge||bh(rt,ds,Hr,ge,at)?ds:void 0}wn+=Kt}}function kh(rt,at,Tt,$t,qt,Kt,ge,Hr,wn){const es=_h($t,Kt,ge),ss=Sh($t,qt),os=ss*ge,cs=0===rt[0].x||rt[0].x===wn||0===rt[0].y||rt[0].y===wn;return at-os<at/4&&(at=os+at/4),Mh(rt,cs?at/2*Hr%at:(ss/2+2*Kt)*ge*Hr%at,at,es,Tt,os,cs,!1,wn)}function Mh(rt,at,Tt,$t,qt,Kt,ge,Hr,wn){const es=Kt/2,ss=wh(rt);let os=0,cs=at-Tt,ds=[];for(let at=0;at<rt.length-1;at++){const ge=rt[at],Hr=rt[at+1],Cs=ge.dist(Hr),Vs=Hr.angleTo(ge);for(;cs+Tt<os+Cs;){cs+=Tt;const Eo=(cs-os)/Cs,Do=Dh.number(ge.x,Hr.x,Eo),Ho=Dh.number(ge.y,Hr.y,Eo);if(Do>=0&&Do<wn&&Ho>=0&&Ho<wn&&cs-es>=0&&cs+es<=ss){const Tt=new vh(Do,Ho,Vs,at);Tt._round(),$t&&!bh(rt,Tt,Kt,$t,qt)||ds.push(Tt)}}os+=Cs}return Hr||ds.length||ge||(ds=Mh(rt,os/2,Tt,$t,qt,Kt,ge,!0,wn)),ds}Xi("Anchor",vh);const kp=up;function zh(rt,at,Tt,$t){const qt=[],Kt=rt.image,Hr=Kt.pixelRatio,wn=Kt.paddedRect.w-2*kp,es=Kt.paddedRect.h-2*kp;let ss={x1:rt.left,y1:rt.top,x2:rt.right,y2:rt.bottom};const os=Kt.stretchX||[[0,wn]],cs=Kt.stretchY||[[0,es]],f=(rt,at)=>rt+at[1]-at[0],ds=os.reduce(f,0),Cs=cs.reduce(f,0),Vs=wn-ds,Eo=es-Cs;let Do=0,Ho=ds,Ea=0,La=Cs,ja=0,Va=Vs,Na=0,qa=Eo;if(Kt.content&&$t){const at=Kt.content,Tt=at[2]-at[0],$t=at[3]-at[1];(Kt.textFitWidth||Kt.textFitHeight)&&(ss=wc(rt)),Do=Ph(os,0,at[0]),Ea=Ph(cs,0,at[1]),Ho=Ph(os,at[0],at[2]),La=Ph(cs,at[1],at[3]),ja=at[0]-Do,Na=at[1]-Ea,Va=Tt-Ho,qa=$t-La}const Qa=ss.x1,Pl=ss.y1,zl=ss.x2-Qa,Dl=ss.y2-Pl,C=(rt,$t,qt,wn)=>{const es=Bh(rt.stretch-Do,Ho,zl,Qa),ss=Vh(rt.fixed-ja,Va,rt.stretch,ds),os=Bh($t.stretch-Ea,La,Dl,Pl),cs=Vh($t.fixed-Na,qa,$t.stretch,Cs),Vs=Bh(qt.stretch-Do,Ho,zl,Qa),Eo=Vh(qt.fixed-ja,Va,qt.stretch,ds),Ll=Bh(wn.stretch-Ea,La,Dl,Pl),Ol=Vh(wn.fixed-Na,qa,wn.stretch,Cs),jl=new ge(es,os),Nl=new ge(Vs,os),Zl=new ge(Vs,Ll),Ul=new ge(es,Ll),Gl=new ge(ss/Hr,cs/Hr),ql=new ge(Eo/Hr,Ol/Hr),Hl=at*Math.PI/180;if(Hl){const rt=Math.sin(Hl),at=Math.cos(Hl),Tt=[at,-rt,rt,at];jl._matMult(Tt),Nl._matMult(Tt),Ul._matMult(Tt),Zl._matMult(Tt)}const Xl=rt.stretch+rt.fixed,Kl=$t.stretch+$t.fixed;return{tl:jl,tr:Nl,bl:Ul,br:Zl,tex:{x:Kt.paddedRect.x+kp+Xl,y:Kt.paddedRect.y+kp+Kl,w:qt.stretch+qt.fixed-Xl,h:wn.stretch+wn.fixed-Kl},writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:Gl,pixelOffsetBR:ql,minFontScaleX:Va/Hr/zl,minFontScaleY:qa/Hr/Dl,isSDF:Tt}};if($t&&(Kt.stretchX||Kt.stretchY)){const rt=Ch(os,Vs,ds),at=Ch(cs,Eo,Cs);for(let Tt=0;Tt<rt.length-1;Tt++){const $t=rt[Tt],Kt=rt[Tt+1];for(let rt=0;rt<at.length-1;rt++)qt.push(C($t,at[rt],Kt,at[rt+1]))}}else qt.push(C({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:wn+1},{fixed:0,stretch:es+1}));return qt}function Ph(rt,at,Tt){let $t=0;for(const qt of rt)$t+=Math.max(at,Math.min(Tt,qt[1]))-Math.max(at,Math.min(Tt,qt[0]));return $t}function Ch(rt,at,Tt){const $t=[{fixed:-1,stretch:0}];for(const[at,Tt]of rt){const rt=$t[$t.length-1];$t.push({fixed:at-rt.stretch,stretch:rt.stretch}),$t.push({fixed:at-rt.stretch,stretch:rt.stretch+(Tt-at)})}return $t.push({fixed:at+kp,stretch:Tt}),$t}function Bh(rt,at,Tt,$t){return rt/at*Tt+$t}function Vh(rt,at,Tt,$t){return rt-at*Tt/$t}class Eh{constructor(rt,at,Tt,$t,qt,Kt,Hr,wn,es,ss){var os;if(this.boxStartIndex=rt.length,es){let rt=Kt.top,at=Kt.bottom;const Tt=Kt.collisionPadding;Tt&&(rt-=Tt[1],at+=Tt[3]);let $t=at-rt;$t>0&&($t=Math.max(10,$t),this.circleDiameter=$t)}else{const es=(null===(os=Kt.image)||void 0===os?void 0:os.content)&&(Kt.image.textFitWidth||Kt.image.textFitHeight)?wc(Kt):{x1:Kt.left,y1:Kt.top,x2:Kt.right,y2:Kt.bottom};es.y1=es.y1*Hr-wn[0],es.y2=es.y2*Hr+wn[2],es.x1=es.x1*Hr-wn[3],es.x2=es.x2*Hr+wn[1];const cs=Kt.collisionPadding;if(cs&&(es.x1-=cs[0]*Hr,es.y1-=cs[1]*Hr,es.x2+=cs[2]*Hr,es.y2+=cs[3]*Hr),ss){const rt=new ge(es.x1,es.y1),at=new ge(es.x2,es.y1),Tt=new ge(es.x1,es.y2),$t=new ge(es.x2,es.y2),qt=ss*Math.PI/180;rt._rotate(qt),at._rotate(qt),Tt._rotate(qt),$t._rotate(qt),es.x1=Math.min(rt.x,at.x,Tt.x,$t.x),es.x2=Math.max(rt.x,at.x,Tt.x,$t.x),es.y1=Math.min(rt.y,at.y,Tt.y,$t.y),es.y2=Math.max(rt.y,at.y,Tt.y,$t.y)}rt.emplaceBack(at.x,at.y,es.x1,es.y1,es.x2,es.y2,Tt,$t,qt)}this.boxEndIndex=rt.length}}class Th{constructor(rt=[],at=(rt,at)=>rt<at?-1:rt>at?1:0){if(this.data=rt,this.length=this.data.length,this.compare=at,this.length>0)for(let rt=(this.length>>1)-1;rt>=0;rt--)this._down(rt)}push(rt){this.data.push(rt),this._up(this.length++)}pop(){if(0===this.length)return;const rt=this.data[0],at=this.data.pop();return--this.length>0&&(this.data[0]=at,this._down(0)),rt}peek(){return this.data[0]}_up(rt){const{data:at,compare:Tt}=this,$t=at[rt];for(;rt>0;){const qt=rt-1>>1,Kt=at[qt];if(Tt($t,Kt)>=0)break;at[rt]=Kt,rt=qt}at[rt]=$t}_down(rt){const{data:at,compare:Tt}=this,$t=this.length>>1,qt=at[rt];for(;rt<$t;){let $t=1+(rt<<1);const Kt=$t+1;if(Kt<this.length&&Tt(at[Kt],at[$t])<0&&($t=Kt),Tt(at[$t],qt)>=0)break;at[rt]=at[$t],rt=$t}at[rt]=qt}}function Fh(rt,at=1,Tt=!1){let $t=1/0,qt=1/0,Kt=-1/0,Hr=-1/0;const wn=rt[0];for(let rt=0;rt<wn.length;rt++){const at=wn[rt];(!rt||at.x<$t)&&($t=at.x),(!rt||at.y<qt)&&(qt=at.y),(!rt||at.x>Kt)&&(Kt=at.x),(!rt||at.y>Hr)&&(Hr=at.y)}const es=Math.min(Kt-$t,Hr-qt);let ss=es/2;const os=new Th([],$h);if(0===es)return new ge($t,qt);for(let at=$t;at<Kt;at+=es)for(let Tt=qt;Tt<Hr;Tt+=es)os.push(new Lh(at+ss,Tt+ss,ss,rt));let cs=function(rt){let at=0,Tt=0,$t=0;const qt=rt[0];for(let rt=0,Kt=qt.length,ge=Kt-1;rt<Kt;ge=rt++){const Kt=qt[rt],Hr=qt[ge],wn=Kt.x*Hr.y-Hr.x*Kt.y;Tt+=(Kt.x+Hr.x)*wn,$t+=(Kt.y+Hr.y)*wn,at+=3*wn}return new Lh(Tt/at,$t/at,0,rt)}(rt),ds=os.length;for(;os.length;){const $t=os.pop();($t.d>cs.d||!cs.d)&&(cs=$t,Tt&&console.log("found best %d after %d probes",Math.round(1e4*$t.d)/1e4,ds)),$t.max-cs.d<=at||(ss=$t.h/2,os.push(new Lh($t.p.x-ss,$t.p.y-ss,ss,rt)),os.push(new Lh($t.p.x+ss,$t.p.y-ss,ss,rt)),os.push(new Lh($t.p.x-ss,$t.p.y+ss,ss,rt)),os.push(new Lh($t.p.x+ss,$t.p.y+ss,ss,rt)),ds+=4)}return Tt&&(console.log(`num probes: ${ds}`),console.log(`best distance: ${cs.d}`)),cs.p}function $h(rt,at){return at.max-rt.max}function Lh(at,Tt,$t,qt){(this||rt).p=new ge(at,Tt),(this||rt).h=$t,(this||rt).d=function(rt,at){let Tt=!1,$t=1/0;for(let qt=0;qt<at.length;qt++){const Kt=at[qt];for(let at=0,qt=Kt.length,ge=qt-1;at<qt;ge=at++){const qt=Kt[at],Hr=Kt[ge];qt.y>rt.y!=Hr.y>rt.y&&rt.x<(Hr.x-qt.x)*(rt.y-qt.y)/(Hr.y-qt.y)+qt.x&&(Tt=!Tt),$t=Math.min($t,ko(rt,qt,Hr))}}return(Tt?1:-1)*Math.sqrt($t)}((this||rt).p,qt),(this||rt).max=(this||rt).d+(this||rt).h*Math.SQRT2}var Dp;at.aB=void 0,(Dp=at.aB||(at.aB={}))[Dp.center=1]="center",Dp[Dp.left=2]="left",Dp[Dp.right=3]="right",Dp[Dp.top=4]="top",Dp[Dp.bottom=5]="bottom",Dp[Dp["top-left"]=6]="top-left",Dp[Dp["top-right"]=7]="top-right",Dp[Dp["bottom-left"]=8]="bottom-left",Dp[Dp["bottom-right"]=9]="bottom-right";const Rp=7,Lp=Number.POSITIVE_INFINITY;function jh(rt,at){return at[1]!==Lp?function(rt,at,Tt){let $t=0,qt=0;switch(at=Math.abs(at),Tt=Math.abs(Tt),rt){case"top-right":case"top-left":case"top":qt=Tt-Rp;break;case"bottom-right":case"bottom-left":case"bottom":qt=-Tt+Rp}switch(rt){case"top-right":case"bottom-right":case"right":$t=-at;break;case"top-left":case"bottom-left":case"left":$t=at}return[$t,qt]}(rt,at[0],at[1]):function(rt,at){let Tt=0,$t=0;at<0&&(at=0);const qt=at/Math.SQRT2;switch(rt){case"top-right":case"top-left":$t=qt-Rp;break;case"bottom-right":case"bottom-left":$t=-qt+Rp;break;case"bottom":$t=-at+Rp;break;case"top":$t=at-Rp}switch(rt){case"top-right":case"bottom-right":Tt=-qt;break;case"top-left":case"bottom-left":Tt=qt;break;case"left":Tt=at;break;case"right":Tt=-at}return[Tt,$t]}(rt,at[0])}function Nh(rt,at,Tt){var $t;const qt=rt.layout,Kt=null===($t=qt.get("text-variable-anchor-offset"))||void 0===$t?void 0:$t.evaluate(at,{},Tt);if(Kt){const rt=Kt.values,at=[];for(let Tt=0;Tt<rt.length;Tt+=2){const $t=at[Tt]=rt[Tt],qt=rt[Tt+1].map((rt=>rt*op));$t.startsWith("top")?qt[1]-=Rp:$t.startsWith("bottom")&&(qt[1]+=Rp),at[Tt+1]=qt}return new ze(at)}const ge=qt.get("text-variable-anchor");if(ge){let $t;$t=void 0!==rt._unevaluatedLayout.getValue("text-radial-offset")?[qt.get("text-radial-offset").evaluate(at,{},Tt)*op,Lp]:qt.get("text-offset").evaluate(at,{},Tt).map((rt=>rt*op));const Kt=[];for(const rt of ge)Kt.push(rt,jh(rt,$t));return new ze(Kt)}return null}function Uh(rt){switch(rt){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function qh(rt,Tt,$t,qt,Kt,ge,Hr,wn,es,ss,os,cs){let ds=ge.textMaxSize.evaluate(Tt,{});void 0===ds&&(ds=Hr);const Cs=rt.layers[0].layout,Eo=Cs.get("icon-offset").evaluate(Tt,{},os),Do=Zh($t.horizontal),Ho=Hr/24,Ea=rt.tilePixelRatio*Ho,La=rt.tilePixelRatio*ds/24,ja=rt.tilePixelRatio*wn,Va=rt.tilePixelRatio*Cs.get("symbol-spacing"),Na=Cs.get("text-padding")*rt.tilePixelRatio,qa=function(rt,at,Tt,$t=1){const qt=rt.get("icon-padding").evaluate(at,{},Tt),Kt=qt&&qt.values;return[Kt[0]*$t,Kt[1]*$t,Kt[2]*$t,Kt[3]*$t]}(Cs,Tt,os,rt.tilePixelRatio),Qa=Cs.get("text-max-angle")/180*Math.PI,Pl="viewport"!==Cs.get("text-rotation-alignment")&&"point"!==Cs.get("symbol-placement"),zl="map"===Cs.get("icon-rotation-alignment")&&"point"!==Cs.get("symbol-placement"),Dl=Cs.get("symbol-placement"),Ll=Va/2,Ol=Cs.get("icon-text-fit");let jl;qt&&"none"!==Ol&&(rt.allowVerticalPlacement&&$t.vertical&&(jl=_c(qt,$t.vertical,Ol,Cs.get("icon-text-fit-padding"),Eo,Ho)),Do&&(qt=_c(qt,Do,Ol,Cs.get("icon-text-fit-padding"),Eo,Ho)));const Nl=os?cs.line.getGranularityForZoomLevel(os.z):1,E=(wn,cs)=>{cs.x<0||cs.x>=Vs||cs.y<0||cs.y>=Vs||function(rt,Tt,$t,qt,Kt,ge,Hr,wn,es,ss,os,cs,ds,Cs,Vs,Eo,Do,Ho,Ea,La,ja,Va,Na,qa,Qa){const Pl=rt.addToLineVertexArray(Tt,$t);let zl,Dl,Ll,Ol,jl=0,Nl=0,Zl=0,Ul=0,Gl=-1,ql=-1;const Hl={};let Xl=rd("");if(rt.allowVerticalPlacement&&qt.vertical){const rt=wn.layout.get("text-rotate").evaluate(ja,{},qa)+90;Ll=new Eh(es,Tt,ss,os,cs,qt.vertical,ds,Cs,Vs,rt),Hr&&(Ol=new Eh(es,Tt,ss,os,cs,Hr,Do,Ho,Vs,rt))}if(Kt){const $t=wn.layout.get("icon-rotate").evaluate(ja,{}),qt="none"!==wn.layout.get("icon-text-fit"),ge=zh(Kt,$t,Na,qt),ds=Hr?zh(Hr,$t,Na,qt):void 0;Dl=new Eh(es,Tt,ss,os,cs,Kt,Do,Ho,!1,$t),jl=4*ge.length;const Cs=rt.iconSizeData;let Vs=null;"source"===Cs.kind?(Vs=[yp*wn.layout.get("icon-size").evaluate(ja,{})],Vs[0]>xp&&U(`${rt.layerIds[0]}: Value for "icon-size" is >= ${gp}. Reduce your "icon-size".`)):"composite"===Cs.kind&&(Vs=[yp*Va.compositeIconSizes[0].evaluate(ja,{},qa),yp*Va.compositeIconSizes[1].evaluate(ja,{},qa)],(Vs[0]>xp||Vs[1]>xp)&&U(`${rt.layerIds[0]}: Value for "icon-size" is >= ${gp}. Reduce your "icon-size".`)),rt.addSymbols(rt.icon,ge,Vs,La,Ea,ja,at.al.none,Tt,Pl.lineStartIndex,Pl.lineLength,-1,qa),Gl=rt.icon.placedSymbolArray.length-1,ds&&(Nl=4*ds.length,rt.addSymbols(rt.icon,ds,Vs,La,Ea,ja,at.al.vertical,Tt,Pl.lineStartIndex,Pl.lineLength,-1,qa),ql=rt.icon.placedSymbolArray.length-1)}const Kl=Object.keys(qt.horizontal);for(const $t of Kl){const Kt=qt.horizontal[$t];if(!zl){Xl=rd(Kt.text);const rt=wn.layout.get("text-rotate").evaluate(ja,{},qa);zl=new Eh(es,Tt,ss,os,cs,Kt,ds,Cs,Vs,rt)}const Hr=1===Kt.positionedLines.length;if(Zl+=Gh(rt,Tt,Kt,ge,wn,Vs,ja,Eo,Pl,qt.vertical?at.al.horizontal:at.al.horizontalOnly,Hr?Kl:[$t],Hl,Gl,Va,qa),Hr)break}qt.vertical&&(Ul+=Gh(rt,Tt,qt.vertical,ge,wn,Vs,ja,Eo,Pl,at.al.vertical,["vertical"],Hl,ql,Va,qa));const Yl=zl?zl.boxStartIndex:rt.collisionBoxArray.length,Jl=zl?zl.boxEndIndex:rt.collisionBoxArray.length,tc=Ll?Ll.boxStartIndex:rt.collisionBoxArray.length,ic=Ll?Ll.boxEndIndex:rt.collisionBoxArray.length,sc=Dl?Dl.boxStartIndex:rt.collisionBoxArray.length,ac=Dl?Dl.boxEndIndex:rt.collisionBoxArray.length,Pc=Ol?Ol.boxStartIndex:rt.collisionBoxArray.length,Sc=Ol?Ol.boxEndIndex:rt.collisionBoxArray.length;let Ac=-1;const Y=(rt,at)=>rt&&rt.circleDiameter?Math.max(rt.circleDiameter,at):at;Ac=Y(zl,Ac),Ac=Y(Ll,Ac),Ac=Y(Dl,Ac),Ac=Y(Ol,Ac);const zc=Ac>-1?1:0;zc&&(Ac*=Qa/op),rt.glyphOffsetArray.length>=Fc.MAX_GLYPHS&&U("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),void 0!==ja.sortKey&&rt.addToSortKeyRanges(rt.symbolInstances.length,ja.sortKey);const kc=Nh(wn,ja,qa),[Lc,Oc]=function(rt,Tt){const $t=rt.length,qt=null==Tt?void 0:Tt.values;if((null==qt?void 0:qt.length)>0)for(let Tt=0;Tt<qt.length;Tt+=2){const $t=qt[Tt+1];rt.emplaceBack(at.aB[qt[Tt]],$t[0],$t[1])}return[$t,rt.length]}(rt.textAnchorOffsets,kc);rt.symbolInstances.emplaceBack(Tt.x,Tt.y,Hl.right>=0?Hl.right:-1,Hl.center>=0?Hl.center:-1,Hl.left>=0?Hl.left:-1,Hl.vertical||-1,Gl,ql,Xl,Yl,Jl,tc,ic,sc,ac,Pc,Sc,ss,Zl,Ul,jl,Nl,zc,0,ds,Ac,Lc,Oc)}(rt,cs,wn,$t,qt,Kt,jl,rt.layers[0],rt.collisionBoxArray,Tt.index,Tt.sourceLayerIndex,rt.index,Ea,[Na,Na,Na,Na],Pl,es,ja,qa,zl,Eo,Tt,ge,ss,os,Hr)};if("line"===Dl)for(const at of xh(Tt.geometry,0,0,Vs,Vs)){const Tt=Vl(at,Nl),Kt=kh(Tt,Va,Qa,$t.vertical||Do,qt,24,La,rt.overscaling,Vs);for(const at of Kt)Do&&Kh(rt,Do.text,Ll,at)||E(Tt,at)}else if("line-center"===Dl){for(const rt of Tt.geometry)if(rt.length>1){const at=Vl(rt,Nl),Tt=Ah(at,Qa,$t.vertical||Do,qt,24,La);Tt&&E(at,Tt)}}else if("Polygon"===Tt.type)for(const rt of Gr(Tt.geometry,0)){const at=Fh(rt,16);E(Vl(rt[0],Nl,!0),new vh(at.x,at.y,0))}else if("LineString"===Tt.type)for(const rt of Tt.geometry){const at=Vl(rt,Nl);E(at,new vh(at[0].x,at[0].y,0))}else if("Point"===Tt.type)for(const rt of Tt.geometry)for(const at of rt)E([at],new vh(at.x,at.y,0))}function Gh(rt,at,Tt,$t,qt,Kt,Hr,wn,es,ss,os,cs,ds,Cs,Vs){const Eo=function(rt,at,Tt,$t,qt,Kt,Hr,wn){const es=$t.layout.get("text-rotate").evaluate(Kt,{})*Math.PI/180,ss=[];for(const rt of at.positionedLines)for(const $t of rt.positionedGlyphs){if(!$t.rect)continue;const Kt=$t.rect||{};let os=hp+1,cs=!0,ds=1,Cs=0;const Vs=(qt||wn)&&$t.vertical,Eo=$t.metrics.advance*$t.scale/2;if(wn&&at.verticalizable&&(Cs=rt.lineOffset/2-($t.imageName?-(op-$t.metrics.width*$t.scale)/2:($t.scale-1)*op)),$t.imageName){const rt=Hr[$t.imageName];cs=rt.sdf,ds=rt.pixelRatio,os=up/ds}const Do=qt?[$t.x+Eo,$t.y]:[0,0];let Ho=qt?[0,0]:[$t.x+Eo+Tt[0],$t.y+Tt[1]-Cs],Ea=[0,0];Vs&&(Ea=Ho,Ho=[0,0]);const La=$t.metrics.isDoubleResolution?2:1,ja=($t.metrics.left-os)*$t.scale-Eo+Ho[0],Va=(-$t.metrics.top-os)*$t.scale+Ho[1],Na=ja+Kt.w/La*$t.scale/ds,qa=Va+Kt.h/La*$t.scale/ds,Qa=new ge(ja,Va),Pl=new ge(Na,Va),zl=new ge(ja,qa),Dl=new ge(Na,qa);if(Vs){const rt=new ge(-Eo,Eo-pp),at=-Math.PI/2,Tt=op/2-Eo,qt=new ge(5-pp-Tt,-($t.imageName?Tt:0)),Kt=new ge(...Ea);Qa._rotateAround(at,rt)._add(qt)._add(Kt),Pl._rotateAround(at,rt)._add(qt)._add(Kt),zl._rotateAround(at,rt)._add(qt)._add(Kt),Dl._rotateAround(at,rt)._add(qt)._add(Kt)}if(es){const rt=Math.sin(es),at=Math.cos(es),Tt=[at,-rt,rt,at];Qa._matMult(Tt),Pl._matMult(Tt),zl._matMult(Tt),Dl._matMult(Tt)}const Ll=new ge(0,0),Ol=new ge(0,0);ss.push({tl:Qa,tr:Pl,bl:zl,br:Dl,tex:Kt,writingMode:at.writingMode,glyphOffset:Do,sectionIndex:$t.sectionIndex,isSDF:cs,pixelOffsetTL:Ll,pixelOffsetBR:Ol,minFontScaleX:0,minFontScaleY:0})}return ss}(0,Tt,wn,qt,Kt,Hr,$t,rt.allowVerticalPlacement),Do=rt.textSizeData;let Ho=null;"source"===Do.kind?(Ho=[yp*qt.layout.get("text-size").evaluate(Hr,{})],Ho[0]>xp&&U(`${rt.layerIds[0]}: Value for "text-size" is >= ${gp}. Reduce your "text-size".`)):"composite"===Do.kind&&(Ho=[yp*Cs.compositeTextSizes[0].evaluate(Hr,{},Vs),yp*Cs.compositeTextSizes[1].evaluate(Hr,{},Vs)],(Ho[0]>xp||Ho[1]>xp)&&U(`${rt.layerIds[0]}: Value for "text-size" is >= ${gp}. Reduce your "text-size".`)),rt.addSymbols(rt.text,Eo,Ho,wn,Kt,Hr,ss,at,es.lineStartIndex,es.lineLength,ds,Vs);for(const at of os)cs[at]=rt.text.placedSymbolArray.length-1;return 4*Eo.length}function Zh(rt){for(const at in rt)return rt[at];return null}function Kh(rt,at,Tt,$t){const qt=rt.compareText;if(at in qt){const rt=qt[at];for(let at=rt.length-1;at>=0;at--)if($t.dist(rt[at])<Tt)return!0}else qt[at]=[];return qt[at].push($t),!1}const Fp=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class Hh{static from(rt){if(!(rt instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[at,Tt]=new Uint8Array(rt,0,2);if(219!==at)throw new Error("Data does not appear to be in a KDBush format.");const $t=Tt>>4;if(1!==$t)throw new Error(`Got v${$t} data when expected v1.`);const qt=Fp[15&Tt];if(!qt)throw new Error("Unrecognized array type.");const[Kt]=new Uint16Array(rt,2,1),[ge]=new Uint32Array(rt,4,1);return new Hh(ge,Kt,qt,rt)}constructor(rt,at=64,Tt=Float64Array,$t){if(isNaN(rt)||rt<0)throw new Error(`Unpexpected numItems value: ${rt}.`);this.numItems=+rt,this.nodeSize=Math.min(Math.max(+at,2),65535),this.ArrayType=Tt,this.IndexArrayType=rt<65536?Uint16Array:Uint32Array;const qt=Fp.indexOf(this.ArrayType),Kt=2*rt*this.ArrayType.BYTES_PER_ELEMENT,ge=rt*this.IndexArrayType.BYTES_PER_ELEMENT,Hr=(8-ge%8)%8;if(qt<0)throw new Error(`Unexpected typed array class: ${Tt}.`);$t&&$t instanceof ArrayBuffer?(this.data=$t,this.ids=new this.IndexArrayType(this.data,8,rt),this.coords=new this.ArrayType(this.data,8+ge+Hr,2*rt),this._pos=2*rt,this._finished=!0):(this.data=new ArrayBuffer(8+Kt+ge+Hr),this.ids=new this.IndexArrayType(this.data,8,rt),this.coords=new this.ArrayType(this.data,8+ge+Hr,2*rt),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+qt]),new Uint16Array(this.data,2,1)[0]=at,new Uint32Array(this.data,4,1)[0]=rt)}add(rt,at){const Tt=this._pos>>1;return this.ids[Tt]=Tt,this.coords[this._pos++]=rt,this.coords[this._pos++]=at,Tt}finish(){const rt=this._pos>>1;if(rt!==this.numItems)throw new Error(`Added ${rt} items when expected ${this.numItems}.`);return Yh(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(rt,at,Tt,$t){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:qt,coords:Kt,nodeSize:ge}=this,Hr=[0,qt.length-1,0],wn=[];for(;Hr.length;){const es=Hr.pop()||0,ss=Hr.pop()||0,os=Hr.pop()||0;if(ss-os<=ge){for(let ge=os;ge<=ss;ge++){const Hr=Kt[2*ge],es=Kt[2*ge+1];Hr>=rt&&Hr<=Tt&&es>=at&&es<=$t&&wn.push(qt[ge])}continue}const cs=os+ss>>1,ds=Kt[2*cs],Cs=Kt[2*cs+1];ds>=rt&&ds<=Tt&&Cs>=at&&Cs<=$t&&wn.push(qt[cs]),(0===es?rt<=ds:at<=Cs)&&(Hr.push(os),Hr.push(cs-1),Hr.push(1-es)),(0===es?Tt>=ds:$t>=Cs)&&(Hr.push(cs+1),Hr.push(ss),Hr.push(1-es))}return wn}within(rt,at,Tt){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:$t,coords:qt,nodeSize:Kt}=this,ge=[0,$t.length-1,0],Hr=[],wn=Tt*Tt;for(;ge.length;){const es=ge.pop()||0,ss=ge.pop()||0,os=ge.pop()||0;if(ss-os<=Kt){for(let Tt=os;Tt<=ss;Tt++)tp(qt[2*Tt],qt[2*Tt+1],rt,at)<=wn&&Hr.push($t[Tt]);continue}const cs=os+ss>>1,ds=qt[2*cs],Cs=qt[2*cs+1];tp(ds,Cs,rt,at)<=wn&&Hr.push($t[cs]),(0===es?rt-Tt<=ds:at-Tt<=Cs)&&(ge.push(os),ge.push(cs-1),ge.push(1-es)),(0===es?rt+Tt>=ds:at+Tt>=Cs)&&(ge.push(cs+1),ge.push(ss),ge.push(1-es))}return Hr}}function Yh(rt,at,Tt,$t,qt,Kt){if(qt-$t<=Tt)return;const ge=$t+qt>>1;Jh(rt,at,ge,$t,qt,Kt),Yh(rt,at,Tt,$t,ge-1,1-Kt),Yh(rt,at,Tt,ge+1,qt,1-Kt)}function Jh(rt,at,Tt,$t,qt,Kt){for(;qt>$t;){if(qt-$t>600){const ge=qt-$t+1,Hr=Tt-$t+1,wn=Math.log(ge),es=.5*Math.exp(2*wn/3),ss=.5*Math.sqrt(wn*es*(ge-es)/ge)*(Hr-ge/2<0?-1:1);Jh(rt,at,Tt,Math.max($t,Math.floor(Tt-Hr*es/ge+ss)),Math.min(qt,Math.floor(Tt+(ge-Hr)*es/ge+ss)),Kt)}const ge=at[2*Tt+Kt];let Hr=$t,wn=qt;for(Wh(rt,at,$t,Tt),at[2*qt+Kt]>ge&&Wh(rt,at,$t,qt);Hr<wn;){for(Wh(rt,at,Hr,wn),Hr++,wn--;at[2*Hr+Kt]<ge;)Hr++;for(;at[2*wn+Kt]>ge;)wn--}at[2*$t+Kt]===ge?Wh(rt,at,$t,wn):(wn++,Wh(rt,at,wn,qt)),wn<=Tt&&($t=wn+1),Tt<=wn&&(qt=wn-1)}}function Wh(rt,at,Tt,$t){Qh(rt,Tt,$t),Qh(at,2*Tt,2*$t),Qh(at,2*Tt+1,2*$t+1)}function Qh(rt,at,Tt){const $t=rt[at];rt[at]=rt[Tt],rt[Tt]=$t}function tp(rt,at,Tt,$t){const qt=rt-Tt,Kt=at-$t;return qt*qt+Kt*Kt}var Bp;at.cm=void 0,(Bp=at.cm||(at.cm={})).create="create",Bp.load="load",Bp.fullLoad="fullLoad";let Op=null,jp=[];const Vp=1e3/60,Np="loadTime",Zp="fullLoadTime",Up={mark(rt){performance.mark(rt)},frame(rt){const at=rt;null!=Op&&jp.push(at-Op),Op=at},clearMetrics(){Op=null,jp=[],performance.clearMeasures(Np),performance.clearMeasures(Zp);for(const rt in at.cm)performance.clearMarks(at.cm[rt])},getPerformanceMetrics(){performance.measure(Np,at.cm.create,at.cm.load),performance.measure(Zp,at.cm.create,at.cm.fullLoad);const rt=performance.getEntriesByName(Np)[0].duration,Tt=performance.getEntriesByName(Zp)[0].duration,$t=jp.length,qt=1/(jp.reduce(((rt,at)=>rt+at),0)/$t/1e3),Kt=jp.filter((rt=>rt>Vp)).reduce(((rt,at)=>rt+(at-Vp)/Vp),0);return{loadTime:rt,fullLoadTime:Tt,fps:qt,percentDroppedFrames:Kt/($t+Kt)*100,totalFrames:$t}}};at.$=sh,at.A=cs,at.B=Dh,at.C=ys,at.D=As,at.E=yt,at.F=Mu,at.G=function(rt){if(null==Ea){const at=rt.navigator?rt.navigator.userAgent:null;Ea=!!rt.safari||!(!at||!(/\b(iPad|iPhone|iPod)\b/.test(at)||at.match("Safari")&&!at.match("Chrome")))}return Ea},at.H=class{constructor(rt,at){this.target=rt,this.mapId=at,this.resolveRejects={},this.tasks={},this.taskQueue=[],this.abortControllers={},this.messageHandlers={},this.invoker=new Xc((()=>this.process())),this.subscription=W(this.target,"message",(rt=>this.receive(rt)),!1),this.globalScope=G(self)?rt:window}registerMessageHandler(rt,at){this.messageHandlers[rt]=at}sendAsync(rt,at){return new Promise(((Tt,$t)=>{const qt=Math.round(1e18*Math.random()).toString(36).substring(0,10),Kt=at?W(at.signal,"abort",(()=>{null==Kt||Kt.unsubscribe(),delete this.resolveRejects[qt];const at={id:qt,type:"<cancel>",origin:location.origin,targetMapId:rt.targetMapId,sourceMapId:this.mapId};this.target.postMessage(at)}),Ap):null;this.resolveRejects[qt]={resolve:rt=>{null==Kt||Kt.unsubscribe(),Tt(rt)},reject:rt=>{null==Kt||Kt.unsubscribe(),$t(rt)}};const ge=[],Hr=Object.assign(Object.assign({},rt),{id:qt,sourceMapId:this.mapId,origin:location.origin,data:Wi(rt.data,ge)});this.target.postMessage(Hr,{transfer:ge})}))}receive(rt){const at=rt.data,Tt=at.id;if(!("file://"!==at.origin&&"file://"!==location.origin&&"resource://android"!==at.origin&&"resource://android"!==location.origin&&at.origin!==location.origin||at.targetMapId&&this.mapId!==at.targetMapId)){if("<cancel>"===at.type){delete this.tasks[Tt];const rt=this.abortControllers[Tt];return delete this.abortControllers[Tt],void(rt&&rt.abort())}if(G(self)||at.mustQueue)return this.tasks[Tt]=at,this.taskQueue.push(Tt),void this.invoker.trigger();this.processTask(Tt,at)}}process(){if(0===this.taskQueue.length)return;const rt=this.taskQueue.shift(),at=this.tasks[rt];delete this.tasks[rt],this.taskQueue.length>0&&this.invoker.trigger(),at&&this.processTask(rt,at)}processTask(rt,at){return e(this,void 0,void 0,(function*(){if("<response>"===at.type){const Tt=this.resolveRejects[rt];if(delete this.resolveRejects[rt],!Tt)return;return void(at.error?Tt.reject(Qi(at.error)):Tt.resolve(Qi(at.data)))}if(!this.messageHandlers[at.type])return void this.completeTask(rt,new Error(`Could not find a registered handler for ${at.type}, map ID: ${this.mapId}, available handlers: ${Object.keys(this.messageHandlers).join(", ")}`));const Tt=Qi(at.data),$t=new AbortController;this.abortControllers[rt]=$t;try{const qt=yield this.messageHandlers[at.type](at.sourceMapId,Tt,$t);this.completeTask(rt,null,qt)}catch(Tt){this.completeTask(rt,Tt)}}))}completeTask(rt,at,Tt){const $t=[];delete this.abortControllers[rt];const qt={id:rt,type:"<response>",sourceMapId:this.mapId,origin:location.origin,error:at?Wi(at):null,data:Wi(Tt,$t)};this.target.postMessage(qt,{transfer:$t})}remove(){this.invoker.remove(),this.subscription.unsubscribe()}},at.I=Ju,at.J=zl,at.K=function(){var rt=new cs(16);return cs!=Float32Array&&(rt[1]=0,rt[2]=0,rt[3]=0,rt[4]=0,rt[6]=0,rt[7]=0,rt[8]=0,rt[9]=0,rt[11]=0,rt[12]=0,rt[13]=0,rt[14]=0),rt[0]=1,rt[5]=1,rt[10]=1,rt[15]=1,rt},at.L=function(rt,at,Tt){var $t,qt,Kt,ge,Hr,wn,es,ss,os,cs,ds,Cs,Vs=Tt[0],Eo=Tt[1],Do=Tt[2];return at===rt?(rt[12]=at[0]*Vs+at[4]*Eo+at[8]*Do+at[12],rt[13]=at[1]*Vs+at[5]*Eo+at[9]*Do+at[13],rt[14]=at[2]*Vs+at[6]*Eo+at[10]*Do+at[14],rt[15]=at[3]*Vs+at[7]*Eo+at[11]*Do+at[15]):(qt=at[1],Kt=at[2],ge=at[3],Hr=at[4],wn=at[5],es=at[6],ss=at[7],os=at[8],cs=at[9],ds=at[10],Cs=at[11],rt[0]=$t=at[0],rt[1]=qt,rt[2]=Kt,rt[3]=ge,rt[4]=Hr,rt[5]=wn,rt[6]=es,rt[7]=ss,rt[8]=os,rt[9]=cs,rt[10]=ds,rt[11]=Cs,rt[12]=$t*Vs+Hr*Eo+os*Do+at[12],rt[13]=qt*Vs+wn*Eo+cs*Do+at[13],rt[14]=Kt*Vs+es*Eo+ds*Do+at[14],rt[15]=ge*Vs+ss*Eo+Cs*Do+at[15]),rt},at.M=function(rt,at,Tt){var $t=Tt[0],qt=Tt[1],Kt=Tt[2];return rt[0]=at[0]*$t,rt[1]=at[1]*$t,rt[2]=at[2]*$t,rt[3]=at[3]*$t,rt[4]=at[4]*qt,rt[5]=at[5]*qt,rt[6]=at[6]*qt,rt[7]=at[7]*qt,rt[8]=at[8]*Kt,rt[9]=at[9]*Kt,rt[10]=at[10]*Kt,rt[11]=at[11]*Kt,rt[12]=at[12],rt[13]=at[13],rt[14]=at[14],rt[15]=at[15],rt},at.N=function(rt,at,Tt){var $t=at[0],qt=at[1],Kt=at[2],ge=at[3],Hr=at[4],wn=at[5],es=at[6],ss=at[7],os=at[8],cs=at[9],ds=at[10],Cs=at[11],Vs=at[12],Eo=at[13],Do=at[14],Ho=at[15],Ea=Tt[0],La=Tt[1],ja=Tt[2],Va=Tt[3];return rt[0]=Ea*$t+La*Hr+ja*os+Va*Vs,rt[1]=Ea*qt+La*wn+ja*cs+Va*Eo,rt[2]=Ea*Kt+La*es+ja*ds+Va*Do,rt[3]=Ea*ge+La*ss+ja*Cs+Va*Ho,rt[4]=(Ea=Tt[4])*$t+(La=Tt[5])*Hr+(ja=Tt[6])*os+(Va=Tt[7])*Vs,rt[5]=Ea*qt+La*wn+ja*cs+Va*Eo,rt[6]=Ea*Kt+La*es+ja*ds+Va*Do,rt[7]=Ea*ge+La*ss+ja*Cs+Va*Ho,rt[8]=(Ea=Tt[8])*$t+(La=Tt[9])*Hr+(ja=Tt[10])*os+(Va=Tt[11])*Vs,rt[9]=Ea*qt+La*wn+ja*cs+Va*Eo,rt[10]=Ea*Kt+La*es+ja*ds+Va*Do,rt[11]=Ea*ge+La*ss+ja*Cs+Va*Ho,rt[12]=(Ea=Tt[12])*$t+(La=Tt[13])*Hr+(ja=Tt[14])*os+(Va=Tt[15])*Vs,rt[13]=Ea*qt+La*wn+ja*cs+Va*Eo,rt[14]=Ea*Kt+La*es+ja*ds+Va*Do,rt[15]=Ea*ge+La*ss+ja*Cs+Va*Ho,rt},at.O=function(rt,at){const Tt={};for(let $t=0;$t<at.length;$t++){const qt=at[$t];qt in rt&&(Tt[qt]=rt[qt])}return Tt},at.P=ge,at.Q=Jc,at.R=qo,at.S=eh,at.T=xs,at.U=th,at.V=f,at.W=d,at.X=H,at.Y=uh,at.Z=Vs,at._=e,at.a=Pl,at.a$=function(rt,at,Tt){var $t=Math.sin(Tt),qt=Math.cos(Tt),Kt=at[4],ge=at[5],Hr=at[6],wn=at[7],es=at[8],ss=at[9],os=at[10],cs=at[11];return at!==rt&&(rt[0]=at[0],rt[1]=at[1],rt[2]=at[2],rt[3]=at[3],rt[12]=at[12],rt[13]=at[13],rt[14]=at[14],rt[15]=at[15]),rt[4]=Kt*qt+es*$t,rt[5]=ge*qt+ss*$t,rt[6]=Hr*qt+os*$t,rt[7]=wn*qt+cs*$t,rt[8]=es*qt-Kt*$t,rt[9]=ss*qt-ge*$t,rt[10]=os*qt-Hr*$t,rt[11]=cs*qt-wn*$t,rt},at.a0=25,at.a1=oh,at.a2=rt=>{const at=window.document.createElement("video");return at.muted=!0,new Promise((Tt=>{at.onloadstart=()=>{Tt(at)};for(const Tt of rt){const rt=window.document.createElement("source");ct(Tt)||(at.crossOrigin="Anonymous"),rt.src=Tt,at.appendChild(rt)}}))},at.a3=zt,at.a4=function(){return Do++},at.a5=oa,at.a6=Fc,at.a7=ei,at.a8=fo,at.a9=fh,at.aA=function(rt,at,Tt,$t,qt=!1){if(!Tt[0]&&!Tt[1])return[0,0];const Kt=qt?"map"===$t?-rt.bearingInRadians:0:"viewport"===$t?rt.bearingInRadians:0;if(Kt){const rt=Math.sin(Kt),at=Math.cos(Kt);Tt=[Tt[0]*at-Tt[1]*rt,Tt[0]*rt+Tt[1]*at]}return[qt?Tt[0]:P(at,Tt[0],rt.zoom),qt?Tt[1]:P(at,Tt[1],rt.zoom)]},at.aC=Ic,at.aD=Uh,at.aE=fc,at.aF=Hh,at.aG=Fs,at.aH=Il,at.aI=xa,at.aJ=Ta,at.aK=Ca,at.aL=$,at.aM=Q,at.aN=ih,at.aO=function(rt,at,Tt){return rt[0]=at[0]*Tt,rt[1]=at[1]*Tt,rt[2]=at[2]*Tt,rt},at.aP=function(rt,at,Tt){return rt[0]=at[0]+Tt[0],rt[1]=at[1]+Tt[1],rt[2]=at[2]+Tt[2],rt},at.aQ=function(rt){var at=new cs(3);return at[0]=rt[0],at[1]=rt[1],at[2]=rt[2],at},at.aR=function(rt,at,Tt){return rt[0]=at[0]*Tt[0],rt[1]=at[1]*Tt[1],rt[2]=at[2]*Tt[2],rt[3]=at[3]*Tt[3],rt},at.aS=function(rt,at,Tt){return rt[0]=at[0]-Tt[0],rt[1]=at[1]-Tt[1],rt[2]=at[2]-Tt[2],rt},at.aT=function(rt,at){var Tt=at[0],$t=at[1],qt=at[2],Kt=Tt*Tt+$t*$t+qt*qt;return Kt>0&&(Kt=1/Math.sqrt(Kt)),rt[0]=at[0]*Kt,rt[1]=at[1]*Kt,rt[2]=at[2]*Kt,rt},at.aU=function(rt,at,Tt){var $t=at[0],qt=at[1],Kt=at[2],ge=Tt[0],Hr=Tt[1],wn=Tt[2];return rt[0]=qt*wn-Kt*Hr,rt[1]=Kt*ge-$t*wn,rt[2]=$t*Hr-qt*ge,rt},at.aV=function(rt,at){return rt[0]*at[0]+rt[1]*at[1]+rt[2]*at[2]},at.aW=lh,at.aX=ch,at.aY=function(rt,at,Tt,$t,qt){var Kt,ge=1/Math.tan(at/2);return rt[0]=ge/Tt,rt[1]=0,rt[2]=0,rt[3]=0,rt[4]=0,rt[5]=ge,rt[6]=0,rt[7]=0,rt[8]=0,rt[9]=0,rt[11]=-1,rt[12]=0,rt[13]=0,rt[15]=0,null!=qt&&qt!==1/0?(rt[10]=(qt+$t)*(Kt=1/($t-qt)),rt[14]=2*qt*$t*Kt):(rt[10]=-1,rt[14]=-2*$t),rt},at.aZ=function(rt){var at=new cs(16);return at[0]=rt[0],at[1]=rt[1],at[2]=rt[2],at[3]=rt[3],at[4]=rt[4],at[5]=rt[5],at[6]=rt[6],at[7]=rt[7],at[8]=rt[8],at[9]=rt[9],at[10]=rt[10],at[11]=rt[11],at[12]=rt[12],at[13]=rt[13],at[14]=rt[14],at[15]=rt[15],at},at.a_=function(rt,at,Tt){var $t=Math.sin(Tt),qt=Math.cos(Tt),Kt=at[0],ge=at[1],Hr=at[2],wn=at[3],es=at[4],ss=at[5],os=at[6],cs=at[7];return at!==rt&&(rt[8]=at[8],rt[9]=at[9],rt[10]=at[10],rt[11]=at[11],rt[12]=at[12],rt[13]=at[13],rt[14]=at[14],rt[15]=at[15]),rt[0]=Kt*qt+es*$t,rt[1]=ge*qt+ss*$t,rt[2]=Hr*qt+os*$t,rt[3]=wn*qt+cs*$t,rt[4]=es*qt-Kt*$t,rt[5]=ss*qt-ge*$t,rt[6]=os*qt-Hr*$t,rt[7]=cs*qt-wn*$t,rt},at.aa=function(rt){const at={};if(rt.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,((rt,Tt,$t,qt)=>{const Kt=$t||qt;return at[Tt]=!Kt||Kt.toLowerCase(),""})),at["max-age"]){const rt=parseInt(at["max-age"],10);isNaN(rt)?delete at["max-age"]:at["max-age"]=rt}return at},at.ab=function(rt){return rt*Math.PI/180},at.ac=function(rt){return Math.pow(2,rt)},at.ad=x,at.ae=F,at.af=85.051129,at.ag=rh,at.ah=function(rt){return Math.log(rt)/Math.LN2},at.ai=function(rt){var at=rt[0],Tt=rt[1];return at*at+Tt*Tt},at.aj=function(rt,at){const Tt=[];for(const $t in rt)$t in at||Tt.push($t);return Tt},at.ak=function(rt,at){let Tt=0,$t=0;if("constant"===rt.kind)$t=rt.layoutSize;else if("source"!==rt.kind){const{interpolationType:qt,minZoom:Kt,maxZoom:ge}=rt,Hr=qt?F(ir.interpolationFactor(qt,at,Kt,ge),0,1):0;"camera"===rt.kind?$t=Dh.number(rt.minSize,rt.maxSize,Hr):Tt=Hr}return{uSizeT:Tt,uSize:$t}},at.am=function(rt,{uSize:at,uSizeT:Tt},{lowerSize:$t,upperSize:qt}){return"source"===rt.kind?$t/yp:"composite"===rt.kind?Dh.number($t/yp,qt/yp,Tt):at},at.an=function(rt,at){var Tt=at[0],$t=at[1],qt=at[2],Kt=at[3],ge=at[4],Hr=at[5],wn=at[6],es=at[7],ss=at[8],os=at[9],cs=at[10],ds=at[11],Cs=at[12],Vs=at[13],Eo=at[14],Do=at[15],Ho=Tt*Hr-$t*ge,Ea=Tt*wn-qt*ge,La=Tt*es-Kt*ge,ja=$t*wn-qt*Hr,Va=$t*es-Kt*Hr,Na=qt*es-Kt*wn,qa=ss*Vs-os*Cs,Qa=ss*Eo-cs*Cs,Pl=ss*Do-ds*Cs,zl=os*Eo-cs*Vs,Dl=os*Do-ds*Vs,Ll=cs*Do-ds*Eo,Ol=Ho*Ll-Ea*Dl+La*zl+ja*Pl-Va*Qa+Na*qa;return Ol?(rt[0]=(Hr*Ll-wn*Dl+es*zl)*(Ol=1/Ol),rt[1]=(qt*Dl-$t*Ll-Kt*zl)*Ol,rt[2]=(Vs*Na-Eo*Va+Do*ja)*Ol,rt[3]=(cs*Va-os*Na-ds*ja)*Ol,rt[4]=(wn*Pl-ge*Ll-es*Qa)*Ol,rt[5]=(Tt*Ll-qt*Pl+Kt*Qa)*Ol,rt[6]=(Eo*La-Cs*Na-Do*Ea)*Ol,rt[7]=(ss*Na-cs*La+ds*Ea)*Ol,rt[8]=(ge*Dl-Hr*Pl+es*qa)*Ol,rt[9]=($t*Pl-Tt*Dl-Kt*qa)*Ol,rt[10]=(Cs*Va-Vs*La+Do*Ho)*Ol,rt[11]=(os*La-ss*Va-ds*Ho)*Ol,rt[12]=(Hr*Qa-ge*zl-wn*qa)*Ol,rt[13]=(Tt*zl-$t*Qa+qt*qa)*Ol,rt[14]=(Vs*Ea-Cs*ja-Eo*Ho)*Ol,rt[15]=(ss*ja-os*Ea+cs*Ho)*Ol,rt):null},at.ao=M,at.ap=function(rt){return Math.hypot(rt[0],rt[1])},at.aq=function(rt){return rt[0]=0,rt[1]=0,rt},at.ar=function(rt,at,Tt){return rt[0]=at[0]*Tt,rt[1]=at[1]*Tt,rt},at.as=Bc,at.at=A,at.au=function(rt,at,Tt,$t){const qt=at.y-rt.y,Kt=at.x-rt.x,Hr=$t.y-Tt.y,wn=$t.x-Tt.x,es=Hr*Kt-wn*qt;if(0===es)return null;const ss=(wn*(rt.y-Tt.y)-Hr*(rt.x-Tt.x))/es;return new ge(rt.x+ss*Kt,rt.y+ss*qt)},at.av=xh,at.aw=xo,at.ax=function(rt){let at=1/0,Tt=1/0,$t=-1/0,qt=-1/0;for(const Kt of rt)at=Math.min(at,Kt.x),Tt=Math.min(Tt,Kt.y),$t=Math.max($t,Kt.x),qt=Math.max(qt,Kt.y);return[at,Tt,$t,qt]},at.ay=op,at.az=P,at.b=K,at.b$=function(rt,at){var Tt=rt[0],$t=rt[1],qt=rt[2],Kt=rt[3],ge=rt[4],Hr=rt[5],wn=rt[6],es=rt[7],ss=rt[8],cs=rt[9],ds=rt[10],Cs=rt[11],Vs=rt[12],Eo=rt[13],Do=rt[14],Ho=rt[15],Ea=at[0],La=at[1],ja=at[2],Va=at[3],Na=at[4],qa=at[5],Qa=at[6],Pl=at[7],zl=at[8],Dl=at[9],Ll=at[10],Ol=at[11],jl=at[12],Nl=at[13],Zl=at[14],Ul=at[15];return Math.abs(Tt-Ea)<=os*Math.max(1,Math.abs(Tt),Math.abs(Ea))&&Math.abs($t-La)<=os*Math.max(1,Math.abs($t),Math.abs(La))&&Math.abs(qt-ja)<=os*Math.max(1,Math.abs(qt),Math.abs(ja))&&Math.abs(Kt-Va)<=os*Math.max(1,Math.abs(Kt),Math.abs(Va))&&Math.abs(ge-Na)<=os*Math.max(1,Math.abs(ge),Math.abs(Na))&&Math.abs(Hr-qa)<=os*Math.max(1,Math.abs(Hr),Math.abs(qa))&&Math.abs(wn-Qa)<=os*Math.max(1,Math.abs(wn),Math.abs(Qa))&&Math.abs(es-Pl)<=os*Math.max(1,Math.abs(es),Math.abs(Pl))&&Math.abs(ss-zl)<=os*Math.max(1,Math.abs(ss),Math.abs(zl))&&Math.abs(cs-Dl)<=os*Math.max(1,Math.abs(cs),Math.abs(Dl))&&Math.abs(ds-Ll)<=os*Math.max(1,Math.abs(ds),Math.abs(Ll))&&Math.abs(Cs-Ol)<=os*Math.max(1,Math.abs(Cs),Math.abs(Ol))&&Math.abs(Vs-jl)<=os*Math.max(1,Math.abs(Vs),Math.abs(jl))&&Math.abs(Eo-Nl)<=os*Math.max(1,Math.abs(Eo),Math.abs(Nl))&&Math.abs(Do-Zl)<=os*Math.max(1,Math.abs(Do),Math.abs(Zl))&&Math.abs(Ho-Ul)<=os*Math.max(1,Math.abs(Ho),Math.abs(Ul))},at.b0=function(){const rt=new Float32Array(16);return x(rt),rt},at.b1=function(){const rt=new Float64Array(16);return x(rt),rt},at.b2=function(){return new Float64Array(16)},at.b3=function(rt,at,Tt){const $t=new Float64Array(4);return function(rt,at,Tt,$t){var qt=.5*Math.PI/180;at*=qt,Tt*=qt,$t*=qt;var Kt=Math.sin(at),ge=Math.cos(at),Hr=Math.sin(Tt),wn=Math.cos(Tt),es=Math.sin($t),ss=Math.cos($t);rt[0]=Kt*wn*ss-ge*Hr*es,rt[1]=ge*Hr*ss+Kt*wn*es,rt[2]=ge*wn*es-Kt*Hr*ss,rt[3]=ge*wn*ss+Kt*Hr*es}($t,rt,at-90,Tt),$t},at.b4=function(rt,at,Tt,$t){var qt,Kt,ge,Hr,wn,es=at[0],ss=at[1],cs=at[2],ds=at[3],Cs=Tt[0],Vs=Tt[1],Eo=Tt[2],Do=Tt[3];return(Kt=es*Cs+ss*Vs+cs*Eo+ds*Do)<0&&(Kt=-Kt,Cs=-Cs,Vs=-Vs,Eo=-Eo,Do=-Do),1-Kt>os?(qt=Math.acos(Kt),ge=Math.sin(qt),Hr=Math.sin((1-$t)*qt)/ge,wn=Math.sin($t*qt)/ge):(Hr=1-$t,wn=$t),rt[0]=Hr*es+wn*Cs,rt[1]=Hr*ss+wn*Vs,rt[2]=Hr*cs+wn*Eo,rt[3]=Hr*ds+wn*Do,rt},at.b5=function(rt){const at=new Float64Array(9);var Tt,$t,qt,Kt,ge,Hr,wn,es,ss,os,cs,ds,Cs,Vs,Eo,Do,Ho,Ea;os=(qt=($t=rt)[0])*(wn=qt+qt),cs=(Kt=$t[1])*wn,Cs=(ge=$t[2])*wn,Vs=ge*(es=Kt+Kt),Do=(Hr=$t[3])*wn,Ho=Hr*es,Ea=Hr*(ss=ge+ge),(Tt=at)[0]=1-(ds=Kt*es)-(Eo=ge*ss),Tt[3]=cs-Ea,Tt[6]=Cs+Ho,Tt[1]=cs+Ea,Tt[4]=1-os-Eo,Tt[7]=Vs-Do,Tt[2]=Cs-Ho,Tt[5]=Vs+Do,Tt[8]=1-os-ds;const La=Q(-Math.asin(F(at[2],-1,1)));let ja,Va;return Math.hypot(at[5],at[8])<.001?(ja=0,Va=-Q(Math.atan2(at[3],at[4]))):(ja=Q(0===at[5]&&0===at[8]?0:Math.atan2(at[5],at[8])),Va=Q(0===at[1]&&0===at[0]?0:Math.atan2(at[1],at[0]))),{roll:ja,pitch:La+90,bearing:Va}},at.b6=function(rt,at){return rt.roll==at.roll&&rt.pitch==at.pitch&&rt.bearing==at.bearing},at.b7=be,at.b8=Ya,at.b9=yd,at.bA=function(rt){if("custom"===rt.type)return new Kc(rt);switch(rt.type){case"background":return new Uc(rt);case"circle":return new Fo(rt);case"fill":return new Rl(rt);case"fill-extrusion":return new hu(rt);case"heatmap":return new Ko(rt);case"hillshade":return new Yo(rt);case"line":return new Iu(rt);case"raster":return new Zc(rt);case"symbol":return new Rc(rt)}},at.bB=j,at.bC=function(rt,at){if(!rt)return[{command:"setStyle",args:[at]}];let Tt=[];try{if(!vt(rt.version,at.version))return[{command:"setStyle",args:[at]}];vt(rt.center,at.center)||Tt.push({command:"setCenter",args:[at.center]}),vt(rt.centerAltitude,at.centerAltitude)||Tt.push({command:"setCenterAltitude",args:[at.centerAltitude]}),vt(rt.zoom,at.zoom)||Tt.push({command:"setZoom",args:[at.zoom]}),vt(rt.bearing,at.bearing)||Tt.push({command:"setBearing",args:[at.bearing]}),vt(rt.pitch,at.pitch)||Tt.push({command:"setPitch",args:[at.pitch]}),vt(rt.roll,at.roll)||Tt.push({command:"setRoll",args:[at.roll]}),vt(rt.sprite,at.sprite)||Tt.push({command:"setSprite",args:[at.sprite]}),vt(rt.glyphs,at.glyphs)||Tt.push({command:"setGlyphs",args:[at.glyphs]}),vt(rt.transition,at.transition)||Tt.push({command:"setTransition",args:[at.transition]}),vt(rt.light,at.light)||Tt.push({command:"setLight",args:[at.light]}),vt(rt.terrain,at.terrain)||Tt.push({command:"setTerrain",args:[at.terrain]}),vt(rt.sky,at.sky)||Tt.push({command:"setSky",args:[at.sky]}),vt(rt.projection,at.projection)||Tt.push({command:"setProjection",args:[at.projection]});const $t={},qt=[];!function(rt,at,Tt,$t){let qt;for(qt in at=at||{},rt=rt||{})Object.prototype.hasOwnProperty.call(rt,qt)&&(Object.prototype.hasOwnProperty.call(at,qt)||_t(qt,Tt,$t));for(qt in at)Object.prototype.hasOwnProperty.call(at,qt)&&(Object.prototype.hasOwnProperty.call(rt,qt)?vt(rt[qt],at[qt])||("geojson"===rt[qt].type&&"geojson"===at[qt].type&&At(rt,at,qt)?bt(Tt,{command:"setGeoJSONSourceData",args:[qt,at[qt].data]}):St(qt,at,Tt,$t)):wt(qt,at,Tt))}(rt.sources,at.sources,qt,$t);const Kt=[];rt.layers&&rt.layers.forEach((rt=>{"source"in rt&&$t[rt.source]?Tt.push({command:"removeLayer",args:[rt.id]}):Kt.push(rt)})),Tt=Tt.concat(qt),function(rt,at,Tt){at=at||[];const $t=(rt=rt||[]).map(Mt),qt=at.map(Mt),Kt=rt.reduce(It,{}),ge=at.reduce(It,{}),Hr=$t.slice(),wn=Object.create(null);let es,ss,os,cs,ds;for(let rt=0,at=0;rt<$t.length;rt++)es=$t[rt],Object.prototype.hasOwnProperty.call(ge,es)?at++:(bt(Tt,{command:"removeLayer",args:[es]}),Hr.splice(Hr.indexOf(es,at),1));for(let rt=0,at=0;rt<qt.length;rt++)es=qt[qt.length-1-rt],Hr[Hr.length-1-rt]!==es&&(Object.prototype.hasOwnProperty.call(Kt,es)?(bt(Tt,{command:"removeLayer",args:[es]}),Hr.splice(Hr.lastIndexOf(es,Hr.length-at),1)):at++,cs=Hr[Hr.length-rt],bt(Tt,{command:"addLayer",args:[ge[es],cs]}),Hr.splice(Hr.length-rt,0,es),wn[es]=!0);for(let rt=0;rt<qt.length;rt++)if(es=qt[rt],ss=Kt[es],os=ge[es],!wn[es]&&!vt(ss,os))if(vt(ss.source,os.source)&&vt(ss["source-layer"],os["source-layer"])&&vt(ss.type,os.type)){for(ds in kt(ss.layout,os.layout,Tt,es,null,"setLayoutProperty"),kt(ss.paint,os.paint,Tt,es,null,"setPaintProperty"),vt(ss.filter,os.filter)||bt(Tt,{command:"setFilter",args:[es,os.filter]}),vt(ss.minzoom,os.minzoom)&&vt(ss.maxzoom,os.maxzoom)||bt(Tt,{command:"setLayerZoomRange",args:[es,os.minzoom,os.maxzoom]}),ss)Object.prototype.hasOwnProperty.call(ss,ds)&&"layout"!==ds&&"paint"!==ds&&"filter"!==ds&&"metadata"!==ds&&"minzoom"!==ds&&"maxzoom"!==ds&&(0===ds.indexOf("paint.")?kt(ss[ds],os[ds],Tt,es,ds.slice(6),"setPaintProperty"):vt(ss[ds],os[ds])||bt(Tt,{command:"setLayerProperty",args:[es,ds,os[ds]]}));for(ds in os)Object.prototype.hasOwnProperty.call(os,ds)&&!Object.prototype.hasOwnProperty.call(ss,ds)&&"layout"!==ds&&"paint"!==ds&&"filter"!==ds&&"metadata"!==ds&&"minzoom"!==ds&&"maxzoom"!==ds&&(0===ds.indexOf("paint.")?kt(ss[ds],os[ds],Tt,es,ds.slice(6),"setPaintProperty"):vt(ss[ds],os[ds])||bt(Tt,{command:"setLayerProperty",args:[es,ds,os[ds]]}))}else bt(Tt,{command:"removeLayer",args:[es]}),cs=Hr[Hr.lastIndexOf(es)+1],bt(Tt,{command:"addLayer",args:[os,cs]})}(Kt,at.layers,Tt)}catch(rt){console.warn("Unable to compute style diff:",rt),Tt=[{command:"setStyle",args:[at]}]}return Tt},at.bD=function(rt){const at=[],Tt=rt.id;return void 0===Tt&&at.push({message:`layers.${Tt}: missing required property "id"`}),void 0===rt.render&&at.push({message:`layers.${Tt}: missing required method "render"`}),rt.renderingMode&&"2d"!==rt.renderingMode&&"3d"!==rt.renderingMode&&at.push({message:`layers.${Tt}: property "renderingMode" must be either "2d" or "3d"`}),at},at.bE=function t(rt,at){if(Array.isArray(rt)){if(!Array.isArray(at)||rt.length!==at.length)return!1;for(let Tt=0;Tt<rt.length;Tt++)if(!t(rt[Tt],at[Tt]))return!1;return!0}if("object"==typeof rt&&null!==rt&&null!==at){if("object"!=typeof at)return!1;if(Object.keys(rt).length!==Object.keys(at).length)return!1;for(const Tt in rt)if(!t(rt[Tt],at[Tt]))return!1;return!0}return rt===at},at.bF=D,at.bG=R,at.bH=class extends Ha{constructor(rt,at){super(rt,at),this.current=0}set(rt){this.current!==rt&&(this.current=rt,this.gl.uniform1i(this.location,rt))}},at.bI=Wa,at.bJ=class extends Ha{constructor(rt,at){super(rt,at),this.current=nd}set(rt){if(rt[12]!==this.current[12]||rt[0]!==this.current[0])return this.current=rt,void this.gl.uniformMatrix4fv(this.location,!1,rt);for(let at=1;at<16;at++)if(rt[at]!==this.current[at]){this.current=rt,this.gl.uniformMatrix4fv(this.location,!1,rt);break}}},at.bK=Ja,at.bL=class extends Ha{constructor(rt,at){super(rt,at),this.current=[0,0,0]}set(rt){rt[0]===this.current[0]&&rt[1]===this.current[1]&&rt[2]===this.current[2]||(this.current=rt,this.gl.uniform3f(this.location,rt[0],rt[1],rt[2]))}},at.bM=class extends Ha{constructor(rt,at){super(rt,at),this.current=[0,0]}set(rt){rt[0]===this.current[0]&&rt[1]===this.current[1]||(this.current=rt,this.gl.uniform2f(this.location,rt[0],rt[1]))}},at.bN=g,at.bO=function(rt,at){var Tt=Math.sin(at),$t=Math.cos(at);return rt[0]=$t,rt[1]=Tt,rt[2]=0,rt[3]=-Tt,rt[4]=$t,rt[5]=0,rt[6]=0,rt[7]=0,rt[8]=1,rt},at.bP=function(rt,at,Tt){var $t=at[0],qt=at[1],Kt=at[2];return rt[0]=$t*Tt[0]+qt*Tt[3]+Kt*Tt[6],rt[1]=$t*Tt[1]+qt*Tt[4]+Kt*Tt[7],rt[2]=$t*Tt[2]+qt*Tt[5]+Kt*Tt[8],rt},at.bQ=function(rt,at,Tt,$t,qt,Kt,ge){var Hr=1/(at-Tt),wn=1/($t-qt),es=1/(Kt-ge);return rt[0]=-2*Hr,rt[1]=0,rt[2]=0,rt[3]=0,rt[4]=0,rt[5]=-2*wn,rt[6]=0,rt[7]=0,rt[8]=0,rt[9]=0,rt[10]=2*es,rt[11]=0,rt[12]=(at+Tt)*Hr,rt[13]=(qt+$t)*wn,rt[14]=(ge+Kt)*es,rt[15]=1,rt},at.bR=class extends Hs{},at.bS=ep,at.bT=class extends Js{},at.bU=pd,at.bV=function(rt){return rt<=1?1:Math.pow(2,Math.ceil(Math.log(rt)/Math.LN2))},at.bW=Go,at.bX=function(rt,at,Tt){var $t=at[0],qt=at[1],Kt=at[2],ge=Tt[3]*$t+Tt[7]*qt+Tt[11]*Kt+Tt[15];return rt[0]=(Tt[0]*$t+Tt[4]*qt+Tt[8]*Kt+Tt[12])/(ge=ge||1),rt[1]=(Tt[1]*$t+Tt[5]*qt+Tt[9]*Kt+Tt[13])/ge,rt[2]=(Tt[2]*$t+Tt[6]*qt+Tt[10]*Kt+Tt[14])/ge,rt},at.bY=class extends Ds{},at.bZ=class extends ia{},at.b_=function(rt,at){return rt[0]===at[0]&&rt[1]===at[1]&&rt[2]===at[2]&&rt[3]===at[3]&&rt[4]===at[4]&&rt[5]===at[5]&&rt[6]===at[6]&&rt[7]===at[7]&&rt[8]===at[8]&&rt[9]===at[9]&&rt[10]===at[10]&&rt[11]===at[11]&&rt[12]===at[12]&&rt[13]===at[13]&&rt[14]===at[14]&&rt[15]===at[15]},at.ba=xd,at.bb=Ml,at.bc=B,at.bd=V,at.be=Ce,at.bf=function(rt,at,Tt,$t,qt){return B($t,qt,F((rt-at)/(Tt-at),0,1))},at.bg=C,at.bh=function(){return new Float64Array(3)},at.bi=function(rt,at,Tt,$t){return rt[0]=at[0]+Tt[0]*$t,rt[1]=at[1]+Tt[1]*$t,rt[2]=at[2]+Tt[2]*$t,rt},at.bj=Cs,at.bk=function(){return new Float64Array(4)},at.bl=function(rt,at,Tt,$t){var qt=[],Kt=[];return qt[0]=at[0]-Tt[0],qt[1]=at[1]-Tt[1],qt[2]=at[2]-Tt[2],Kt[0]=qt[0]*Math.cos($t)-qt[1]*Math.sin($t),Kt[1]=qt[0]*Math.sin($t)+qt[1]*Math.cos($t),Kt[2]=qt[2],rt[0]=Kt[0]+Tt[0],rt[1]=Kt[1]+Tt[1],rt[2]=Kt[2]+Tt[2],rt},at.bm=function(rt,at,Tt,$t){var qt=[],Kt=[];return qt[0]=at[0]-Tt[0],qt[1]=at[1]-Tt[1],qt[2]=at[2]-Tt[2],Kt[0]=qt[0],Kt[1]=qt[1]*Math.cos($t)-qt[2]*Math.sin($t),Kt[2]=qt[1]*Math.sin($t)+qt[2]*Math.cos($t),rt[0]=Kt[0]+Tt[0],rt[1]=Kt[1]+Tt[1],rt[2]=Kt[2]+Tt[2],rt},at.bn=function(rt,at,Tt,$t){var qt=[],Kt=[];return qt[0]=at[0]-Tt[0],qt[1]=at[1]-Tt[1],qt[2]=at[2]-Tt[2],Kt[0]=qt[2]*Math.sin($t)+qt[0]*Math.cos($t),Kt[1]=qt[1],Kt[2]=qt[2]*Math.cos($t)-qt[0]*Math.sin($t),rt[0]=Kt[0]+Tt[0],rt[1]=Kt[1]+Tt[1],rt[2]=Kt[2]+Tt[2],rt},at.bo=b,at.bp=function(rt,at,Tt){var $t=Math.sin(Tt),qt=Math.cos(Tt),Kt=at[0],ge=at[1],Hr=at[2],wn=at[3],es=at[8],ss=at[9],os=at[10],cs=at[11];return at!==rt&&(rt[4]=at[4],rt[5]=at[5],rt[6]=at[6],rt[7]=at[7],rt[12]=at[12],rt[13]=at[13],rt[14]=at[14],rt[15]=at[15]),rt[0]=Kt*qt-es*$t,rt[1]=ge*qt-ss*$t,rt[2]=Hr*qt-os*$t,rt[3]=wn*qt-cs*$t,rt[8]=Kt*$t+es*qt,rt[9]=ge*$t+ss*qt,rt[10]=Hr*$t+os*qt,rt[11]=wn*$t+cs*qt,rt},at.bq=function(rt,at){const Tt=C(rt,360),$t=C(at,360),qt=$t-Tt,Kt=$t>Tt?qt-360:qt+360;return Math.abs(qt)<Math.abs(Kt)?qt:Kt},at.br=function(rt){return rt[0]=0,rt[1]=0,rt[2]=0,rt},at.bs=function(rt,at,Tt,$t){const qt=Math.sqrt(rt*rt+at*at),Kt=Math.sqrt(Tt*Tt+$t*$t);rt/=qt,at/=qt,Tt/=Kt,$t/=Kt;const ge=Math.acos(rt*Tt+at*$t);return-at*Tt+rt*$t>0?ge:-ge},at.bt=function(rt,at){return rt[0]*at[0]+rt[1]*at[1]+rt[2]*at[2]+rt[3]},at.bu=Ep,at.bv=function(rt,at){const Tt=C(rt,2*Math.PI),$t=C(at,2*Math.PI);return Math.min(Math.abs(Tt-$t),Math.abs(Tt-$t+2*Math.PI),Math.abs(Tt-$t-2*Math.PI))},at.bw=function(){const rt={},at=Dl.$version;for(const Tt in Dl.$root){const $t=Dl.$root[Tt];if($t.required){let qt=null;qt="version"===Tt?at:"array"===$t.type?[]:{},null!=qt&&(rt[Tt]=qt)}}return rt},at.bx=ts,at.by=lt,at.bz=function(rt){rt=rt.slice();const at=Object.create(null);for(let Tt=0;Tt<rt.length;Tt++)at[rt[Tt].id]=rt[Tt];for(let Tt=0;Tt<rt.length;Tt++)"ref"in rt[Tt]&&(rt[Tt]=xt(rt[Tt],at[rt[Tt].ref]));return rt},at.c=nt,at.c0=function(rt,at){return rt[0]=at[0],rt[1]=at[1],rt[2]=at[2],rt[3]=at[3],rt[4]=at[4],rt[5]=at[5],rt[6]=at[6],rt[7]=at[7],rt[8]=at[8],rt[9]=at[9],rt[10]=at[10],rt[11]=at[11],rt[12]=at[12],rt[13]=at[13],rt[14]=at[14],rt[15]=at[15],rt},at.c1=rt=>"symbol"===rt.type,at.c2=rt=>"circle"===rt.type,at.c3=rt=>"heatmap"===rt.type,at.c4=rt=>"line"===rt.type,at.c5=rt=>"fill"===rt.type,at.c6=rt=>"fill-extrusion"===rt.type,at.c7=rt=>"hillshade"===rt.type,at.c8=rt=>"raster"===rt.type,at.c9=rt=>"background"===rt.type,at.cA=Rd,at.cB=lp,at.cC=class{constructor(rt){this._marks={start:[rt.url,"start"].join("#"),end:[rt.url,"end"].join("#"),measure:rt.url.toString()},performance.mark(this._marks.start)}finish(){performance.mark(this._marks.end);let rt=performance.getEntriesByName(this._marks.measure);return 0===rt.length&&(performance.measure(this._marks.measure,this._marks.start,this._marks.end),rt=performance.getEntriesByName(this._marks.measure),performance.clearMarks(this._marks.start),performance.clearMarks(this._marks.end),performance.clearMeasures(this._marks.measure)),rt}},at.cD=function(at,Tt,$t,qt,Kt){return e(this||rt,void 0,void 0,(function*(){if(d())try{return yield H(at,Tt,$t,qt,Kt)}catch(rt){}return function(rt,at,Tt,$t,qt){const Kt=rt.width,ge=rt.height;ja&&Va||(ja=new OffscreenCanvas(Kt,ge),Va=ja.getContext("2d",{willReadFrequently:!0})),ja.width=Kt,ja.height=ge,Va.drawImage(rt,0,0,Kt,ge);const Hr=Va.getImageData(at,Tt,$t,qt);return Va.clearRect(0,0,Kt,ge),Hr.data}(at,Tt,$t,qt,Kt)}))},at.cE=hh,at.cF=r,at.cG=s,at.cH=tu,at.cI=Nu,at.cJ=Kn,at.cK=Fu,at.ca=rt=>"custom"===rt.type,at.cb=E,at.cc=function(rt,at,Tt){const $t=I(at.x-Tt.x,at.y-Tt.y),qt=I(rt.x-Tt.x,rt.y-Tt.y);var Kt,ge;return Q(Math.atan2($t[0]*qt[1]-$t[1]*qt[0],(Kt=$t)[0]*(ge=qt)[0]+Kt[1]*ge[1]))},at.cd=Eo,at.ce=function(rt,at){return qa[at]&&(rt instanceof MouseEvent||rt instanceof WheelEvent)},at.cf=function(rt,at){return Na[at]&&"touches"in rt},at.cg=function(rt){return Na[rt]||qa[rt]},at.ch=function(rt,at,Tt){var $t=at[0],qt=at[1];return rt[0]=Tt[0]*$t+Tt[4]*qt+Tt[12],rt[1]=Tt[1]*$t+Tt[5]*qt+Tt[13],rt},at.ci=function(rt,at){const{x:Tt,y:$t}=sh.fromLngLat(at);return!(rt<0||rt>25||$t<0||$t>=1||Tt<0||Tt>=1)},at.cj=function(rt,at){return rt[0]=at[0],rt[1]=0,rt[2]=0,rt[3]=0,rt[4]=0,rt[5]=at[1],rt[6]=0,rt[7]=0,rt[8]=0,rt[9]=0,rt[10]=at[2],rt[11]=0,rt[12]=0,rt[13]=0,rt[14]=0,rt[15]=1,rt},at.ck=class extends Os{},at.cl=Up,at.cn=function(rt){return rt.message===Qa},at.co=ot,at.cp=function(rt,at){Pl.REGISTERED_PROTOCOLS[rt]=at},at.cq=function(rt){delete Pl.REGISTERED_PROTOCOLS[rt]},at.cr=function(rt,at){const Tt={};for(let $t=0;$t<rt.length;$t++){const qt=at&&at[rt[$t].id]||ci(rt[$t]);at&&(at[rt[$t].id]=qt);let Kt=Tt[qt];Kt||(Kt=Tt[qt]=[]),Kt.push(rt[$t])}const $t=[];for(const rt in Tt)$t.push(Tt[rt]);return $t},at.cs=Xi,at.ct=ph,at.cu=dh,at.cv=Wu,at.cw=function(rt){rt.bucket.createArrays(),rt.bucket.tilePixelRatio=Vs/(512*rt.bucket.overscaling),rt.bucket.compareText={},rt.bucket.iconsNeedLinear=!1;const Tt=rt.bucket.layers[0],$t=Tt.layout,qt=Tt._unevaluatedLayout._values,Kt={layoutIconSize:qt["icon-size"].possiblyEvaluate(new ys(rt.bucket.zoom+1),rt.canonical),layoutTextSize:qt["text-size"].possiblyEvaluate(new ys(rt.bucket.zoom+1),rt.canonical),textMaxSize:qt["text-size"].possiblyEvaluate(new ys(18))};if("composite"===rt.bucket.textSizeData.kind){const{minZoom:at,maxZoom:Tt}=rt.bucket.textSizeData;Kt.compositeTextSizes=[qt["text-size"].possiblyEvaluate(new ys(at),rt.canonical),qt["text-size"].possiblyEvaluate(new ys(Tt),rt.canonical)]}if("composite"===rt.bucket.iconSizeData.kind){const{minZoom:at,maxZoom:Tt}=rt.bucket.iconSizeData;Kt.compositeIconSizes=[qt["icon-size"].possiblyEvaluate(new ys(at),rt.canonical),qt["icon-size"].possiblyEvaluate(new ys(Tt),rt.canonical)]}const ge=$t.get("text-line-height")*op,Hr="viewport"!==$t.get("text-rotation-alignment")&&"point"!==$t.get("symbol-placement"),wn=$t.get("text-keep-upright"),es=$t.get("text-size");for(const qt of rt.bucket.features){const ss=$t.get("text-font").evaluate(qt,{},rt.canonical).join(","),os=es.evaluate(qt,{},rt.canonical),cs=Kt.layoutTextSize.evaluate(qt,{},rt.canonical),ds=Kt.layoutIconSize.evaluate(qt,{},rt.canonical),Cs={horizontal:{},vertical:void 0},Vs=qt.text;let Eo,Do=[0,0];if(Vs){const Kt=Vs.toString(),es=$t.get("text-letter-spacing").evaluate(qt,{},rt.canonical)*op,ds=ns(Kt)?es:0,Eo=$t.get("text-anchor").evaluate(qt,{},rt.canonical),Ho=Nh(Tt,qt,rt.canonical);if(!Ho){const at=$t.get("text-radial-offset").evaluate(qt,{},rt.canonical);Do=at?jh(Eo,[at*op,Lp]):$t.get("text-offset").evaluate(qt,{},rt.canonical).map((rt=>rt*op))}let Ea=Hr?"center":$t.get("text-justify").evaluate(qt,{},rt.canonical);const La="point"===$t.get("symbol-placement")?$t.get("text-max-width").evaluate(qt,{},rt.canonical)*op:1/0,w=()=>{rt.bucket.allowVerticalPlacement&&rs(Kt)&&(Cs.vertical=nc(Vs,rt.glyphMap,rt.glyphPositions,rt.imagePositions,ss,La,ge,Eo,"left",ds,Do,at.al.vertical,!0,cs,os))};if(!Hr&&Ho){const Tt=new Set;if("auto"===Ea)for(let rt=0;rt<Ho.values.length;rt+=2)Tt.add(Uh(Ho.values[rt]));else Tt.add(Ea);let $t=!1;for(const qt of Tt)if(!Cs.horizontal[qt])if($t)Cs.horizontal[qt]=Cs.horizontal[0];else{const Tt=nc(Vs,rt.glyphMap,rt.glyphPositions,rt.imagePositions,ss,La,ge,"center",qt,ds,Do,at.al.horizontal,!1,cs,os);Tt&&(Cs.horizontal[qt]=Tt,$t=1===Tt.positionedLines.length)}w()}else{"auto"===Ea&&(Ea=Uh(Eo));const Tt=nc(Vs,rt.glyphMap,rt.glyphPositions,rt.imagePositions,ss,La,ge,Eo,Ea,ds,Do,at.al.horizontal,!1,cs,os);Tt&&(Cs.horizontal[Ea]=Tt),w(),rs(Kt)&&Hr&&wn&&(Cs.vertical=nc(Vs,rt.glyphMap,rt.glyphPositions,rt.imagePositions,ss,La,ge,Eo,Ea,ds,Do,at.al.vertical,!1,cs,os))}}let Ho=!1;if(qt.icon&&qt.icon.name){const at=rt.imageMap[qt.icon.name];at&&(Eo=bc(rt.imagePositions[qt.icon.name],$t.get("icon-offset").evaluate(qt,{},rt.canonical),$t.get("icon-anchor").evaluate(qt,{},rt.canonical)),Ho=!!at.sdf,void 0===rt.bucket.sdfIcons?rt.bucket.sdfIcons=Ho:rt.bucket.sdfIcons!==Ho&&U("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(at.pixelRatio!==rt.bucket.pixelRatio||0!==$t.get("icon-rotate").constantOr(1))&&(rt.bucket.iconsNeedLinear=!0))}const Ea=Zh(Cs.horizontal)||Cs.vertical;rt.bucket.iconsInText=!!Ea&&Ea.iconsInText,(Ea||Eo)&&qh(rt.bucket,qt,Cs,Eo,rt.imageMap,Kt,cs,ds,Do,Ho,rt.canonical,rt.subdivisionGranularity)}rt.showCollisionBoxes&&rt.bucket.generateCollisionDebugBuffers()},at.cx=wu,at.cy=$l,at.cz=su,at.d=ct,at.e=L,at.f=rt=>e(void 0,void 0,void 0,(function*(){if(0===rt.byteLength)return createImageBitmap(new ImageData(1,1));const at=new Blob([new Uint8Array(rt)],{type:"image/png"});try{return createImageBitmap(at)}catch(rt){throw new Error(`Could not load image because of ${rt.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`)}})),at.g=st,at.h=rt=>new Promise(((at,Tt)=>{const $t=new Image;$t.onload=()=>{at($t),URL.revokeObjectURL($t.src),$t.onload=null,window.requestAnimationFrame((()=>{$t.src=La}))},$t.onerror=()=>Tt(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const qt=new Blob([new Uint8Array(rt)],{type:"image/png"});$t.src=rt.byteLength?URL.createObjectURL(qt):La})),at.i=G,at.j=(rt,at)=>ut(L(rt,{type:"json"}),at),at.k=dt,at.l=ft,at.m=ut,at.n=(rt,at)=>ut(L(rt,{type:"arrayBuffer"}),at),at.o=function(rt){return new lp(rt).readFields(Gu,[])},at.p=Hu,at.q=Uo,at.r=Ps,at.s=W,at.t=Pu,at.u=Eu,at.v=Dl,at.w=U,at.x=Gi,at.y=bu,at.z=function([rt,at,Tt]){return at+=90,at*=Math.PI/180,Tt*=Math.PI/180,{x:rt*Math.cos(at)*Math.sin(Tt),y:rt*Math.sin(at)*Math.sin(Tt),z:rt*Math.cos(Tt)}}}));define("worker",["./shared"],(function(at){class t{constructor(rt){this.keyCache={},rt&&this.replace(rt)}replace(rt){this._layerConfigs={},this._layers={},this.update(rt,[])}update(rt,Tt){for(const Tt of rt){this._layerConfigs[Tt.id]=Tt;const rt=this._layers[Tt.id]=at.bA(Tt);rt._featureFilter=at.a7(rt.filter),this.keyCache[Tt.id]&&delete this.keyCache[Tt.id]}for(const rt of Tt)delete this.keyCache[rt],delete this._layerConfigs[rt],delete this._layers[rt];this.familiesBySource={};const $t=at.cr(Object.values(this._layerConfigs),this.keyCache);for(const rt of $t){const at=rt.map((rt=>this._layers[rt.id])),Tt=at[0];if("none"===Tt.visibility)continue;const $t=Tt.source||"";let qt=this.familiesBySource[$t];qt||(qt=this.familiesBySource[$t]={});const Kt=Tt.sourceLayer||"_geojsonTileLayer";let ge=qt[Kt];ge||(ge=qt[Kt]=[]),ge.push(at)}}}class o{constructor(rt){const Tt={},$t=[];for(const at in rt){const qt=rt[at],Kt=Tt[at]={};for(const rt in qt){const at=qt[+rt];if(!at||0===at.bitmap.width||0===at.bitmap.height)continue;const Tt={x:0,y:0,w:at.bitmap.width+2,h:at.bitmap.height+2};$t.push(Tt),Kt[rt]={rect:Tt,metrics:at.metrics}}}const{w:qt,h:Kt}=at.p($t),ge=new at.q({width:qt||1,height:Kt||1});for(const $t in rt){const qt=rt[$t];for(const rt in qt){const Kt=qt[+rt];if(!Kt||0===Kt.bitmap.width||0===Kt.bitmap.height)continue;const Hr=Tt[$t][rt].rect;at.q.copy(Kt.bitmap,ge,{x:0,y:0},{x:Hr.x+1,y:Hr.y+1},Kt.bitmap)}}this.image=ge,this.positions=Tt}}at.cs("GlyphAtlas",o);class i{constructor(rt){this.tileID=new at.Y(rt.tileID.overscaledZ,rt.tileID.wrap,rt.tileID.canonical.z,rt.tileID.canonical.x,rt.tileID.canonical.y),this.uid=rt.uid,this.zoom=rt.zoom,this.pixelRatio=rt.pixelRatio,this.tileSize=rt.tileSize,this.source=rt.source,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=rt.showCollisionBoxes,this.collectResourceTiming=!!rt.collectResourceTiming,this.returnDependencies=!!rt.returnDependencies,this.promoteId=rt.promoteId,this.inFlightDependencies=[]}parse(rt,Tt,$t,qt,Kt){return at._(this,void 0,void 0,(function*(){this.status="parsing",this.data=rt,this.collisionBoxArray=new at.a5;const ge=new at.ct(Object.keys(rt.layers).sort()),Hr=new at.cu(this.tileID,this.promoteId);Hr.bucketLayerIDs=[];const wn={},es={featureIndex:Hr,iconDependencies:{},patternDependencies:{},glyphDependencies:{},availableImages:$t,subdivisionGranularity:Kt},ss=Tt.familiesBySource[this.source];for(const Tt in ss){const qt=rt.layers[Tt];if(!qt)continue;1===qt.version&&at.w(`Vector tile source "${this.source}" layer "${Tt}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const Kt=ge.encode(Tt),os=[];for(let rt=0;rt<qt.length;rt++){const at=qt.feature(rt),$t=Hr.getId(at,Tt);os.push({feature:at,id:$t,index:rt,sourceLayerIndex:Kt})}for(const rt of ss[Tt]){const Tt=rt[0];Tt.source!==this.source&&at.w(`layer.source = ${Tt.source} does not equal this.source = ${this.source}`),Tt.minzoom&&this.zoom<Math.floor(Tt.minzoom)||Tt.maxzoom&&this.zoom>=Tt.maxzoom||"none"!==Tt.visibility&&(r(rt,this.zoom,$t),(wn[Tt.id]=Tt.createBucket({index:Hr.bucketLayerIDs.length,layers:rt,zoom:this.zoom,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:Kt,sourceID:this.source})).populate(os,es,this.tileID.canonical),Hr.bucketLayerIDs.push(rt.map((rt=>rt.id))))}}const os=at.bF(es.glyphDependencies,(rt=>Object.keys(rt).map(Number)));this.inFlightDependencies.forEach((rt=>null==rt?void 0:rt.abort())),this.inFlightDependencies=[];let cs=Promise.resolve({});if(Object.keys(os).length){const rt=new AbortController;this.inFlightDependencies.push(rt),cs=qt.sendAsync({type:"GG",data:{stacks:os,source:this.source,tileID:this.tileID,type:"glyphs"}},rt)}const ds=Object.keys(es.iconDependencies);let Cs=Promise.resolve({});if(ds.length){const rt=new AbortController;this.inFlightDependencies.push(rt),Cs=qt.sendAsync({type:"GI",data:{icons:ds,source:this.source,tileID:this.tileID,type:"icons"}},rt)}const Vs=Object.keys(es.patternDependencies);let Eo=Promise.resolve({});if(Vs.length){const rt=new AbortController;this.inFlightDependencies.push(rt),Eo=qt.sendAsync({type:"GI",data:{icons:Vs,source:this.source,tileID:this.tileID,type:"patterns"}},rt)}const[Do,Ho,Ea]=yield Promise.all([cs,Cs,Eo]),La=new o(Do),ja=new at.cv(Ho,Ea);for(const rt in wn){const Tt=wn[rt];Tt instanceof at.a6?(r(Tt.layers,this.zoom,$t),at.cw({bucket:Tt,glyphMap:Do,glyphPositions:La.positions,imageMap:Ho,imagePositions:ja.iconPositions,showCollisionBoxes:this.showCollisionBoxes,canonical:this.tileID.canonical,subdivisionGranularity:es.subdivisionGranularity})):Tt.hasPattern&&(Tt instanceof at.cx||Tt instanceof at.cy||Tt instanceof at.cz)&&(r(Tt.layers,this.zoom,$t),Tt.addFeatures(es,this.tileID.canonical,ja.patternPositions))}return this.status="done",{buckets:Object.values(wn).filter((rt=>!rt.isEmpty())),featureIndex:Hr,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:La.image,imageAtlas:ja,glyphMap:this.returnDependencies?Do:null,iconMap:this.returnDependencies?Ho:null,glyphPositions:this.returnDependencies?La.positions:null}}))}}function r(rt,Tt,$t){const qt=new at.C(Tt);for(const at of rt)at.recalculate(qt,$t)}class s{constructor(rt,at,Tt){this.actor=rt,this.layerIndex=at,this.availableImages=Tt,this.fetching={},this.loading={},this.loaded={}}loadVectorTile(rt,Tt){return at._(this,void 0,void 0,(function*(){const $t=yield at.n(rt.request,Tt);try{return{vectorTile:new at.cA.VectorTile(new at.cB($t.data)),rawData:$t.data,cacheControl:$t.cacheControl,expires:$t.expires}}catch(at){const Tt=new Uint8Array($t.data);let qt=`Unable to parse the tile at ${rt.request.url}, `;throw qt+=31===Tt[0]&&139===Tt[1]?"please make sure the data is not gzipped and that you have configured the relevant header in the server":`got error: ${at.message}`,new Error(qt)}}))}loadTile(rt){return at._(this,void 0,void 0,(function*(){const Tt=rt.uid,$t=!!(rt&&rt.request&&rt.request.collectResourceTiming)&&new at.cC(rt.request),qt=new i(rt);this.loading[Tt]=qt;const Kt=new AbortController;qt.abort=Kt;try{const ge=yield this.loadVectorTile(rt,Kt);if(delete this.loading[Tt],!ge)return null;const Hr=ge.rawData,wn={};ge.expires&&(wn.expires=ge.expires),ge.cacheControl&&(wn.cacheControl=ge.cacheControl);const es={};if($t){const rt=$t.finish();rt&&(es.resourceTiming=JSON.parse(JSON.stringify(rt)))}qt.vectorTile=ge.vectorTile;const ss=qt.parse(ge.vectorTile,this.layerIndex,this.availableImages,this.actor,rt.subdivisionGranularity);this.loaded[Tt]=qt,this.fetching[Tt]={rawTileData:Hr,cacheControl:wn,resourceTiming:es};try{const rt=yield ss;return at.e({rawTileData:Hr.slice(0)},rt,wn,es)}finally{delete this.fetching[Tt]}}catch(rt){throw delete this.loading[Tt],qt.status="done",this.loaded[Tt]=qt,rt}}))}reloadTile(rt){return at._(this,void 0,void 0,(function*(){const Tt=rt.uid;if(!this.loaded||!this.loaded[Tt])throw new Error("Should not be trying to reload a tile that was never loaded or has been removed");const $t=this.loaded[Tt];if($t.showCollisionBoxes=rt.showCollisionBoxes,"parsing"===$t.status){const qt=yield $t.parse($t.vectorTile,this.layerIndex,this.availableImages,this.actor,rt.subdivisionGranularity);let Kt;if(this.fetching[Tt]){const{rawTileData:rt,cacheControl:$t,resourceTiming:ge}=this.fetching[Tt];delete this.fetching[Tt],Kt=at.e({rawTileData:rt.slice(0)},qt,$t,ge)}else Kt=qt;return Kt}if("done"===$t.status&&$t.vectorTile)return $t.parse($t.vectorTile,this.layerIndex,this.availableImages,this.actor,rt.subdivisionGranularity)}))}abortTile(rt){return at._(this,void 0,void 0,(function*(){const at=this.loading,Tt=rt.uid;at&&at[Tt]&&at[Tt].abort&&(at[Tt].abort.abort(),delete at[Tt])}))}removeTile(rt){return at._(this,void 0,void 0,(function*(){this.loaded&&this.loaded[rt.uid]&&delete this.loaded[rt.uid]}))}}class n{constructor(){this.loaded={}}loadTile(rt){return at._(this,void 0,void 0,(function*(){const{uid:Tt,encoding:$t,rawImageData:qt,redFactor:Kt,greenFactor:ge,blueFactor:Hr,baseShift:wn}=rt,es=qt.width+2,ss=qt.height+2,os=at.b(qt)?new at.R({width:es,height:ss},yield at.cD(qt,-1,-1,es,ss)):qt,cs=new at.cE(Tt,os,$t,Kt,ge,Hr,wn);return this.loaded=this.loaded||{},this.loaded[Tt]=cs,cs}))}removeTile(rt){const at=this.loaded,Tt=rt.uid;at&&at[Tt]&&delete at[Tt]}}var Tt,$t,qt=function(){if($t)return Tt;function e(rt,at){if(0!==rt.length){t(rt[0],at);for(var Tt=1;Tt<rt.length;Tt++)t(rt[Tt],!at)}}function t(rt,at){for(var Tt=0,$t=0,qt=0,Kt=rt.length,ge=Kt-1;qt<Kt;ge=qt++){var Hr=(rt[qt][0]-rt[ge][0])*(rt[ge][1]+rt[qt][1]),wn=Tt+Hr;$t+=Math.abs(Tt)>=Math.abs(Hr)?Tt-wn+Hr:Hr-wn+Tt,Tt=wn}Tt+$t>=0!=!!at&&rt.reverse()}return $t=1,Tt=function t(rt,at){var Tt,$t=rt&&rt.type;if("FeatureCollection"===$t)for(Tt=0;Tt<rt.features.length;Tt++)t(rt.features[Tt],at);else if("GeometryCollection"===$t)for(Tt=0;Tt<rt.geometries.length;Tt++)t(rt.geometries[Tt],at);else if("Feature"===$t)t(rt.geometry,at);else if("Polygon"===$t)e(rt.coordinates,at);else if("MultiPolygon"===$t)for(Tt=0;Tt<rt.coordinates.length;Tt++)e(rt.coordinates[Tt],at);return rt}}(),Kt=at.cF(qt);const ge=at.cA.VectorTileFeature.prototype.toGeoJSON;class d{constructor(rt){this._feature=rt,this.extent=at.Z,this.type=rt.type,this.properties=rt.tags,"id"in rt&&!isNaN(rt.id)&&(this.id=parseInt(rt.id,10))}loadGeometry(){if(1===this._feature.type){const rt=[];for(const Tt of this._feature.geometry)rt.push([new at.P(Tt[0],Tt[1])]);return rt}{const rt=[];for(const Tt of this._feature.geometry){const $t=[];for(const rt of Tt)$t.push(new at.P(rt[0],rt[1]));rt.push($t)}return rt}}toGeoJSON(rt,at,Tt){return ge.call(this,rt,at,Tt)}}class f{constructor(rt){this.layers={_geojsonTileLayer:this},this.name="_geojsonTileLayer",this.extent=at.Z,this.length=rt.length,this._features=rt}feature(rt){return new d(this._features[rt])}}var Hr,wn,es,ss={exports:{}},os=function(){if(es)return ss.exports;es=1;var Tt=at.cI(),$t=function(){if(wn)return Hr;wn=1;var Tt=at.cG(),$t=at.cH().VectorTileFeature;function i(at,Tt){(this||rt).options=Tt||{},(this||rt).features=at,(this||rt).length=at.length}function r(at,Tt){(this||rt).id="number"==typeof at.id?at.id:void 0,(this||rt).type=at.type,(this||rt).rawGeometry=1===at.type?[at.geometry]:at.geometry,(this||rt).properties=at.tags,(this||rt).extent=Tt||4096}return Hr=i,i.prototype.feature=function(at){return new r((this||rt).features[at],(this||rt).options.extent)},r.prototype.loadGeometry=function(){var at=(this||rt).rawGeometry;(this||rt).geometry=[];for(var $t=0;$t<at.length;$t++){for(var qt=at[$t],Kt=[],ge=0;ge<qt.length;ge++)Kt.push(new Tt(qt[ge][0],qt[ge][1]));(this||rt).geometry.push(Kt)}return(this||rt).geometry},r.prototype.bbox=function(){(this||rt).geometry||this.loadGeometry();for(var at=(this||rt).geometry,Tt=1/0,$t=-1/0,qt=1/0,Kt=-1/0,ge=0;ge<at.length;ge++)for(var Hr=at[ge],wn=0;wn<Hr.length;wn++){var es=Hr[wn];Tt=Math.min(Tt,es.x),$t=Math.max($t,es.x),qt=Math.min(qt,es.y),Kt=Math.max(Kt,es.y)}return[Tt,qt,$t,Kt]},r.prototype.toGeoJSON=$t.prototype.toGeoJSON,Hr}();function i(rt){var at=new Tt;return function(rt,at){for(var Tt in rt.layers)at.writeMessage(3,r,rt.layers[Tt])}(rt,at),at.finish()}function r(rt,at){var Tt;at.writeVarintField(15,rt.version||1),at.writeStringField(1,rt.name||""),at.writeVarintField(5,rt.extent||4096);var $t={keys:[],values:[],keycache:{},valuecache:{}};for(Tt=0;Tt<rt.length;Tt++)$t.feature=rt.feature(Tt),at.writeMessage(2,s,$t);var qt=$t.keys;for(Tt=0;Tt<qt.length;Tt++)at.writeStringField(3,qt[Tt]);var Kt=$t.values;for(Tt=0;Tt<Kt.length;Tt++)at.writeMessage(4,u,Kt[Tt])}function s(rt,at){var Tt=rt.feature;void 0!==Tt.id&&at.writeVarintField(1,Tt.id),at.writeMessage(2,n,rt),at.writeVarintField(3,Tt.type),at.writeMessage(4,c,Tt)}function n(rt,at){var Tt=rt.feature,$t=rt.keys,qt=rt.values,Kt=rt.keycache,ge=rt.valuecache;for(var Hr in Tt.properties){var wn=Tt.properties[Hr],es=Kt[Hr];if(null!==wn){void 0===es&&($t.push(Hr),Kt[Hr]=es=$t.length-1),at.writeVarint(es);var ss=typeof wn;"string"!==ss&&"boolean"!==ss&&"number"!==ss&&(wn=JSON.stringify(wn));var os=ss+":"+wn,cs=ge[os];void 0===cs&&(qt.push(wn),ge[os]=cs=qt.length-1),at.writeVarint(cs)}}}function a(rt,at){return(at<<3)+(7&rt)}function l(rt){return rt<<1^rt>>31}function c(rt,at){for(var Tt=rt.loadGeometry(),$t=rt.type,qt=0,Kt=0,ge=Tt.length,Hr=0;Hr<ge;Hr++){var wn=Tt[Hr],es=1;1===$t&&(es=wn.length),at.writeVarint(a(1,es));for(var ss=3===$t?wn.length-1:wn.length,os=0;os<ss;os++){1===os&&1!==$t&&at.writeVarint(a(2,ss-1));var cs=wn[os].x-qt,ds=wn[os].y-Kt;at.writeVarint(l(cs)),at.writeVarint(l(ds)),qt+=cs,Kt+=ds}3===$t&&at.writeVarint(a(7,1))}}function u(rt,at){var Tt=typeof rt;"string"===Tt?at.writeStringField(1,rt):"boolean"===Tt?at.writeBooleanField(7,rt):"number"===Tt&&(rt%1!=0?at.writeDoubleField(3,rt):rt<0?at.writeSVarintField(6,rt):at.writeVarintField(5,rt))}return ss.exports=i,ss.exports.fromVectorTileJs=i,ss.exports.fromGeojsonVt=function(rt,at){at=at||{};var Tt={};for(var qt in rt)Tt[qt]=new $t(rt[qt].features,at),Tt[qt].name=qt,Tt[qt].version=at.version,Tt[qt].extent=at.extent;return i({layers:Tt})},ss.exports.GeoJSONWrapper=$t,ss.exports}(),cs=at.cF(os);const ds={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:rt=>rt},Cs=Math.fround||(Vs=new Float32Array(1),rt=>(Vs[0]=+rt,Vs[0]));var Vs;const Eo=3,Do=5,Ho=6;class P{constructor(rt){this.options=Object.assign(Object.create(ds),rt),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(rt){const{log:at,minZoom:Tt,maxZoom:$t}=this.options;at&&console.time("total time");const qt=`prepare ${rt.length} points`;at&&console.time(qt),this.points=rt;const Kt=[];for(let at=0;at<rt.length;at++){const Tt=rt[at];if(!Tt.geometry)continue;const[$t,qt]=Tt.geometry.coordinates,ge=Cs(D($t)),Hr=Cs(C(qt));Kt.push(ge,Hr,1/0,at,-1,1),this.options.reduce&&Kt.push(0)}let ge=this.trees[$t+1]=this._createTree(Kt);at&&console.timeEnd(qt);for(let rt=$t;rt>=Tt;rt--){const Tt=+Date.now();ge=this.trees[rt]=this._createTree(this._cluster(ge,rt)),at&&console.log("z%d: %d clusters in %dms",rt,ge.numItems,+Date.now()-Tt)}return at&&console.timeEnd("total time"),this}getClusters(rt,at){let Tt=((rt[0]+180)%360+360)%360-180;const $t=Math.max(-90,Math.min(90,rt[1]));let qt=180===rt[2]?180:((rt[2]+180)%360+360)%360-180;const Kt=Math.max(-90,Math.min(90,rt[3]));if(rt[2]-rt[0]>=360)Tt=-180,qt=180;else if(Tt>qt){const rt=this.getClusters([Tt,$t,180,Kt],at),ge=this.getClusters([-180,$t,qt,Kt],at);return rt.concat(ge)}const ge=this.trees[this._limitZoom(at)],Hr=ge.range(D(Tt),C(Kt),D(qt),C($t)),wn=ge.data,es=[];for(const rt of Hr){const at=this.stride*rt;es.push(wn[at+Do]>1?k(wn,at,this.clusterProps):this.points[wn[at+Eo]])}return es}getChildren(rt){const at=this._getOriginId(rt),Tt=this._getOriginZoom(rt),$t="No cluster with the specified id.",qt=this.trees[Tt];if(!qt)throw new Error($t);const Kt=qt.data;if(at*this.stride>=Kt.length)throw new Error($t);const ge=this.options.radius/(this.options.extent*Math.pow(2,Tt-1)),Hr=qt.within(Kt[at*this.stride],Kt[at*this.stride+1],ge),wn=[];for(const at of Hr){const Tt=at*this.stride;Kt[Tt+4]===rt&&wn.push(Kt[Tt+Do]>1?k(Kt,Tt,this.clusterProps):this.points[Kt[Tt+Eo]])}if(0===wn.length)throw new Error($t);return wn}getLeaves(rt,at,Tt){const $t=[];return this._appendLeaves($t,rt,at=at||10,Tt=Tt||0,0),$t}getTile(rt,at,Tt){const $t=this.trees[this._limitZoom(rt)],qt=Math.pow(2,rt),{extent:Kt,radius:ge}=this.options,Hr=ge/Kt,wn=(Tt-Hr)/qt,es=(Tt+1+Hr)/qt,ss={features:[]};return this._addTileFeatures($t.range((at-Hr)/qt,wn,(at+1+Hr)/qt,es),$t.data,at,Tt,qt,ss),0===at&&this._addTileFeatures($t.range(1-Hr/qt,wn,1,es),$t.data,qt,Tt,qt,ss),at===qt-1&&this._addTileFeatures($t.range(0,wn,Hr/qt,es),$t.data,-1,Tt,qt,ss),ss.features.length?ss:null}getClusterExpansionZoom(rt){let at=this._getOriginZoom(rt)-1;for(;at<=this.options.maxZoom;){const Tt=this.getChildren(rt);if(at++,1!==Tt.length)break;rt=Tt[0].properties.cluster_id}return at}_appendLeaves(rt,at,Tt,$t,qt){const Kt=this.getChildren(at);for(const at of Kt){const Kt=at.properties;if(Kt&&Kt.cluster?qt+Kt.point_count<=$t?qt+=Kt.point_count:qt=this._appendLeaves(rt,Kt.cluster_id,Tt,$t,qt):qt<$t?qt++:rt.push(at),rt.length===Tt)break}return qt}_createTree(rt){const Tt=new at.aF(rt.length/this.stride|0,this.options.nodeSize,Float32Array);for(let at=0;at<rt.length;at+=this.stride)Tt.add(rt[at],rt[at+1]);return Tt.finish(),Tt.data=rt,Tt}_addTileFeatures(rt,at,Tt,$t,qt,Kt){for(const ge of rt){const rt=ge*this.stride,Hr=at[rt+Do]>1;let wn,es,ss;if(Hr)wn=T(at,rt,this.clusterProps),es=at[rt],ss=at[rt+1];else{const Tt=this.points[at[rt+Eo]];wn=Tt.properties;const[$t,qt]=Tt.geometry.coordinates;es=D($t),ss=C(qt)}const os={type:1,geometry:[[Math.round(this.options.extent*(es*qt-Tt)),Math.round(this.options.extent*(ss*qt-$t))]],tags:wn};let cs;cs=Hr||this.options.generateId?at[rt+Eo]:this.points[at[rt+Eo]].id,void 0!==cs&&(os.id=cs),Kt.features.push(os)}}_limitZoom(rt){return Math.max(this.options.minZoom,Math.min(Math.floor(+rt),this.options.maxZoom+1))}_cluster(rt,at){const{radius:Tt,extent:$t,reduce:qt,minPoints:Kt}=this.options,ge=Tt/($t*Math.pow(2,at)),Hr=rt.data,wn=[],es=this.stride;for(let Tt=0;Tt<Hr.length;Tt+=es){if(Hr[Tt+2]<=at)continue;Hr[Tt+2]=at;const $t=Hr[Tt],ss=Hr[Tt+1],os=rt.within(Hr[Tt],Hr[Tt+1],ge),cs=Hr[Tt+Do];let ds=cs;for(const rt of os){const Tt=rt*es;Hr[Tt+2]>at&&(ds+=Hr[Tt+Do])}if(ds>cs&&ds>=Kt){let rt,Kt=$t*cs,ge=ss*cs,Cs=-1;const Vs=(Tt/es<<5)+(at+1)+this.points.length;for(const $t of os){const wn=$t*es;if(Hr[wn+2]<=at)continue;Hr[wn+2]=at;const ss=Hr[wn+Do];Kt+=Hr[wn]*ss,ge+=Hr[wn+1]*ss,Hr[wn+4]=Vs,qt&&(rt||(rt=this._map(Hr,Tt,!0),Cs=this.clusterProps.length,this.clusterProps.push(rt)),qt(rt,this._map(Hr,wn)))}Hr[Tt+4]=Vs,wn.push(Kt/ds,ge/ds,1/0,Vs,-1,ds),qt&&wn.push(Cs)}else{for(let rt=0;rt<es;rt++)wn.push(Hr[Tt+rt]);if(ds>1)for(const rt of os){const Tt=rt*es;if(!(Hr[Tt+2]<=at)){Hr[Tt+2]=at;for(let rt=0;rt<es;rt++)wn.push(Hr[Tt+rt])}}}}return wn}_getOriginId(rt){return rt-this.points.length>>5}_getOriginZoom(rt){return(rt-this.points.length)%32}_map(rt,at,Tt){if(rt[at+Do]>1){const $t=this.clusterProps[rt[at+Ho]];return Tt?Object.assign({},$t):$t}const $t=this.points[rt[at+Eo]].properties,qt=this.options.map($t);return Tt&&qt===$t?Object.assign({},qt):qt}}function k(rt,at,Tt){return{type:"Feature",id:rt[at+Eo],properties:T(rt,at,Tt),geometry:{type:"Point",coordinates:[($t=rt[at],360*($t-.5)),O(rt[at+1])]}};var $t}function T(rt,at,Tt){const $t=rt[at+Do],qt=$t>=1e4?`${Math.round($t/1e3)}k`:$t>=1e3?Math.round($t/100)/10+"k":$t,Kt=rt[at+Ho],ge=-1===Kt?{}:Object.assign({},Tt[Kt]);return Object.assign(ge,{cluster:!0,cluster_id:rt[at+Eo],point_count:$t,point_count_abbreviated:qt})}function D(rt){return rt/360+.5}function C(rt){const at=Math.sin(rt*Math.PI/180),Tt=.5-.25*Math.log((1+at)/(1-at))/Math.PI;return Tt<0?0:Tt>1?1:Tt}function O(rt){const at=(180-360*rt)*Math.PI/180;return 360*Math.atan(Math.exp(at))/Math.PI-90}function L(rt,at,Tt,$t){let qt=$t;const Kt=at+(Tt-at>>1);let ge,Hr=Tt-at;const wn=rt[at],es=rt[at+1],ss=rt[Tt],os=rt[Tt+1];for(let $t=at+3;$t<Tt;$t+=3){const at=F(rt[$t],rt[$t+1],wn,es,ss,os);if(at>qt)ge=$t,qt=at;else if(at===qt){const rt=Math.abs($t-Kt);rt<Hr&&(ge=$t,Hr=rt)}}qt>$t&&(ge-at>3&&L(rt,at,ge,$t),rt[ge+2]=qt,Tt-ge>3&&L(rt,ge,Tt,$t))}function F(rt,at,Tt,$t,qt,Kt){let ge=qt-Tt,Hr=Kt-$t;if(0!==ge||0!==Hr){const wn=((rt-Tt)*ge+(at-$t)*Hr)/(ge*ge+Hr*Hr);wn>1?(Tt=qt,$t=Kt):wn>0&&(Tt+=ge*wn,$t+=Hr*wn)}return ge=rt-Tt,Hr=at-$t,ge*ge+Hr*Hr}function G(rt,at,Tt,$t){const qt={id:null==rt?null:rt,type:at,geometry:Tt,tags:$t,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};if("Point"===at||"MultiPoint"===at||"LineString"===at)z(qt,Tt);else if("Polygon"===at)z(qt,Tt[0]);else if("MultiLineString"===at)for(const rt of Tt)z(qt,rt);else if("MultiPolygon"===at)for(const rt of Tt)z(qt,rt[0]);return qt}function z(rt,at){for(let Tt=0;Tt<at.length;Tt+=3)rt.minX=Math.min(rt.minX,at[Tt]),rt.minY=Math.min(rt.minY,at[Tt+1]),rt.maxX=Math.max(rt.maxX,at[Tt]),rt.maxY=Math.max(rt.maxY,at[Tt+1])}function A(rt,at,Tt,$t){if(!at.geometry)return;const qt=at.geometry.coordinates;if(qt&&0===qt.length)return;const Kt=at.geometry.type,ge=Math.pow(Tt.tolerance/((1<<Tt.maxZoom)*Tt.extent),2);let Hr=[],wn=at.id;if(Tt.promoteId?wn=at.properties[Tt.promoteId]:Tt.generateId&&(wn=$t||0),"Point"===Kt)j(qt,Hr);else if("MultiPoint"===Kt)for(const rt of qt)j(rt,Hr);else if("LineString"===Kt)E(qt,Hr,ge,!1);else if("MultiLineString"===Kt){if(Tt.lineMetrics){for(const Tt of qt)Hr=[],E(Tt,Hr,ge,!1),rt.push(G(wn,"LineString",Hr,at.properties));return}Z(qt,Hr,ge,!1)}else if("Polygon"===Kt)Z(qt,Hr,ge,!0);else{if("MultiPolygon"!==Kt){if("GeometryCollection"===Kt){for(const qt of at.geometry.geometries)A(rt,{id:wn,geometry:qt,properties:at.properties},Tt,$t);return}throw new Error("Input data is not a valid GeoJSON object.")}for(const rt of qt){const at=[];Z(rt,at,ge,!0),Hr.push(at)}}rt.push(G(wn,Kt,Hr,at.properties))}function j(rt,at){at.push(J(rt[0]),N(rt[1]),0)}function E(rt,at,Tt,$t){let qt,Kt,ge=0;for(let Tt=0;Tt<rt.length;Tt++){const Hr=J(rt[Tt][0]),wn=N(rt[Tt][1]);at.push(Hr,wn,0),Tt>0&&(ge+=$t?(qt*wn-Hr*Kt)/2:Math.sqrt(Math.pow(Hr-qt,2)+Math.pow(wn-Kt,2))),qt=Hr,Kt=wn}const Hr=at.length-3;at[2]=1,L(at,0,Hr,Tt),at[Hr+2]=1,at.size=Math.abs(ge),at.start=0,at.end=at.size}function Z(rt,at,Tt,$t){for(let qt=0;qt<rt.length;qt++){const Kt=[];E(rt[qt],Kt,Tt,$t),at.push(Kt)}}function J(rt){return rt/360+.5}function N(rt){const at=Math.sin(rt*Math.PI/180),Tt=.5-.25*Math.log((1+at)/(1-at))/Math.PI;return Tt<0?0:Tt>1?1:Tt}function W(rt,at,Tt,$t,qt,Kt,ge,Hr){if($t/=at,Kt>=(Tt/=at)&&ge<$t)return rt;if(ge<Tt||Kt>=$t)return null;const wn=[];for(const at of rt){const rt=at.geometry;let Kt=at.type;const ge=0===qt?at.minX:at.minY,es=0===qt?at.maxX:at.maxY;if(ge>=Tt&&es<$t){wn.push(at);continue}if(es<Tt||ge>=$t)continue;let ss=[];if("Point"===Kt||"MultiPoint"===Kt)R(rt,ss,Tt,$t,qt);else if("LineString"===Kt)Y(rt,ss,Tt,$t,qt,!1,Hr.lineMetrics);else if("MultiLineString"===Kt)V(rt,ss,Tt,$t,qt,!1);else if("Polygon"===Kt)V(rt,ss,Tt,$t,qt,!0);else if("MultiPolygon"===Kt)for(const at of rt){const rt=[];V(at,rt,Tt,$t,qt,!0),rt.length&&ss.push(rt)}if(ss.length){if(Hr.lineMetrics&&"LineString"===Kt){for(const rt of ss)wn.push(G(at.id,Kt,rt,at.tags));continue}"LineString"!==Kt&&"MultiLineString"!==Kt||(1===ss.length?(Kt="LineString",ss=ss[0]):Kt="MultiLineString"),"Point"!==Kt&&"MultiPoint"!==Kt||(Kt=3===ss.length?"Point":"MultiPoint"),wn.push(G(at.id,Kt,ss,at.tags))}}return wn.length?wn:null}function R(rt,at,Tt,$t,qt){for(let Kt=0;Kt<rt.length;Kt+=3){const ge=rt[Kt+qt];ge>=Tt&&ge<=$t&&H(at,rt[Kt],rt[Kt+1],rt[Kt+2])}}function Y(rt,at,Tt,$t,qt,Kt,ge){let Hr=q(rt);const wn=0===qt?X:B;let es,ss,os=rt.start;for(let cs=0;cs<rt.length-3;cs+=3){const ds=rt[cs],Cs=rt[cs+1],Vs=rt[cs+2],Eo=rt[cs+3],Do=rt[cs+4],Ho=0===qt?ds:Cs,Ea=0===qt?Eo:Do;let La=!1;ge&&(es=Math.sqrt(Math.pow(ds-Eo,2)+Math.pow(Cs-Do,2))),Ho<Tt?Ea>Tt&&(ss=wn(Hr,ds,Cs,Eo,Do,Tt),ge&&(Hr.start=os+es*ss)):Ho>$t?Ea<$t&&(ss=wn(Hr,ds,Cs,Eo,Do,$t),ge&&(Hr.start=os+es*ss)):H(Hr,ds,Cs,Vs),Ea<Tt&&Ho>=Tt&&(ss=wn(Hr,ds,Cs,Eo,Do,Tt),La=!0),Ea>$t&&Ho<=$t&&(ss=wn(Hr,ds,Cs,Eo,Do,$t),La=!0),!Kt&&La&&(ge&&(Hr.end=os+es*ss),at.push(Hr),Hr=q(rt)),ge&&(os+=es)}let cs=rt.length-3;const ds=rt[cs],Cs=rt[cs+1],Vs=0===qt?ds:Cs;Vs>=Tt&&Vs<=$t&&H(Hr,ds,Cs,rt[cs+2]),cs=Hr.length-3,Kt&&cs>=3&&(Hr[cs]!==Hr[0]||Hr[cs+1]!==Hr[1])&&H(Hr,Hr[0],Hr[1],Hr[2]),Hr.length&&at.push(Hr)}function q(rt){const at=[];return at.size=rt.size,at.start=rt.start,at.end=rt.end,at}function V(rt,at,Tt,$t,qt,Kt){for(const ge of rt)Y(ge,at,Tt,$t,qt,Kt,!1)}function H(rt,at,Tt,$t){rt.push(at,Tt,$t)}function X(rt,at,Tt,$t,qt,Kt){const ge=(Kt-at)/($t-at);return H(rt,Kt,Tt+(qt-Tt)*ge,1),ge}function B(rt,at,Tt,$t,qt,Kt){const ge=(Kt-Tt)/(qt-Tt);return H(rt,at+($t-at)*ge,Kt,1),ge}function $(rt,at){const Tt=[];for(let $t=0;$t<rt.length;$t++){const qt=rt[$t],Kt=qt.type;let ge;if("Point"===Kt||"MultiPoint"===Kt||"LineString"===Kt)ge=U(qt.geometry,at);else if("MultiLineString"===Kt||"Polygon"===Kt){ge=[];for(const rt of qt.geometry)ge.push(U(rt,at))}else if("MultiPolygon"===Kt){ge=[];for(const rt of qt.geometry){const Tt=[];for(const $t of rt)Tt.push(U($t,at));ge.push(Tt)}}Tt.push(G(qt.id,Kt,ge,qt.tags))}return Tt}function U(rt,at){const Tt=[];Tt.size=rt.size,void 0!==rt.start&&(Tt.start=rt.start,Tt.end=rt.end);for(let $t=0;$t<rt.length;$t+=3)Tt.push(rt[$t]+at,rt[$t+1],rt[$t+2]);return Tt}function K(rt,at){if(rt.transformed)return rt;const Tt=1<<rt.z,$t=rt.x,qt=rt.y;for(const Kt of rt.features){const rt=Kt.geometry,ge=Kt.type;if(Kt.geometry=[],1===ge)for(let ge=0;ge<rt.length;ge+=2)Kt.geometry.push(Q(rt[ge],rt[ge+1],at,Tt,$t,qt));else for(let ge=0;ge<rt.length;ge++){const Hr=[];for(let Kt=0;Kt<rt[ge].length;Kt+=2)Hr.push(Q(rt[ge][Kt],rt[ge][Kt+1],at,Tt,$t,qt));Kt.geometry.push(Hr)}}return rt.transformed=!0,rt}function Q(rt,at,Tt,$t,qt,Kt){return[Math.round(Tt*(rt*$t-qt)),Math.round(Tt*(at*$t-Kt))]}function ee(rt,at,Tt,$t,qt){const Kt=at===qt.maxZoom?0:qt.tolerance/((1<<at)*qt.extent),ge={features:[],numPoints:0,numSimplified:0,numFeatures:rt.length,source:null,x:Tt,y:$t,z:at,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0};for(const at of rt)te(ge,at,Kt,qt);return ge}function te(rt,at,Tt,$t){const qt=at.geometry,Kt=at.type,ge=[];if(rt.minX=Math.min(rt.minX,at.minX),rt.minY=Math.min(rt.minY,at.minY),rt.maxX=Math.max(rt.maxX,at.maxX),rt.maxY=Math.max(rt.maxY,at.maxY),"Point"===Kt||"MultiPoint"===Kt)for(let at=0;at<qt.length;at+=3)ge.push(qt[at],qt[at+1]),rt.numPoints++,rt.numSimplified++;else if("LineString"===Kt)oe(ge,qt,rt,Tt,!1,!1);else if("MultiLineString"===Kt||"Polygon"===Kt)for(let at=0;at<qt.length;at++)oe(ge,qt[at],rt,Tt,"Polygon"===Kt,0===at);else if("MultiPolygon"===Kt)for(let at=0;at<qt.length;at++){const $t=qt[at];for(let at=0;at<$t.length;at++)oe(ge,$t[at],rt,Tt,!0,0===at)}if(ge.length){let Tt=at.tags||null;if("LineString"===Kt&&$t.lineMetrics){Tt={};for(const rt in at.tags)Tt[rt]=at.tags[rt];Tt.mapbox_clip_start=qt.start/qt.size,Tt.mapbox_clip_end=qt.end/qt.size}const Hr={geometry:ge,type:"Polygon"===Kt||"MultiPolygon"===Kt?3:"LineString"===Kt||"MultiLineString"===Kt?2:1,tags:Tt};null!==at.id&&(Hr.id=at.id),rt.features.push(Hr)}}function oe(rt,at,Tt,$t,qt,Kt){const ge=$t*$t;if($t>0&&at.size<(qt?ge:$t))return void(Tt.numPoints+=at.length/3);const Hr=[];for(let rt=0;rt<at.length;rt+=3)(0===$t||at[rt+2]>ge)&&(Tt.numSimplified++,Hr.push(at[rt],at[rt+1])),Tt.numPoints++;qt&&function(rt,at){let Tt=0;for(let at=0,$t=rt.length,qt=$t-2;at<$t;qt=at,at+=2)Tt+=(rt[at]-rt[qt])*(rt[at+1]+rt[qt+1]);if(Tt>0===at)for(let at=0,Tt=rt.length;at<Tt/2;at+=2){const $t=rt[at],qt=rt[at+1];rt[at]=rt[Tt-2-at],rt[at+1]=rt[Tt-1-at],rt[Tt-2-at]=$t,rt[Tt-1-at]=qt}}(Hr,Kt),rt.push(Hr)}const Ea={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0};class re{constructor(rt,at){const Tt=(at=this.options=function(rt,at){for(const Tt in at)rt[Tt]=at[Tt];return rt}(Object.create(Ea),at)).debug;if(Tt&&console.time("preprocess data"),at.maxZoom<0||at.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(at.promoteId&&at.generateId)throw new Error("promoteId and generateId cannot be used together.");let $t=function(rt,at){const Tt=[];if("FeatureCollection"===rt.type)for(let $t=0;$t<rt.features.length;$t++)A(Tt,rt.features[$t],at,$t);else A(Tt,"Feature"===rt.type?rt:{geometry:rt},at);return Tt}(rt,at);this.tiles={},this.tileCoords=[],Tt&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",at.indexMaxZoom,at.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),$t=function(rt,at){const Tt=at.buffer/at.extent;let $t=rt;const qt=W(rt,1,-1-Tt,Tt,0,-1,2,at),Kt=W(rt,1,1-Tt,2+Tt,0,-1,2,at);return(qt||Kt)&&($t=W(rt,1,-Tt,1+Tt,0,-1,2,at)||[],qt&&($t=$(qt,1).concat($t)),Kt&&($t=$t.concat($(Kt,-1)))),$t}($t,at),$t.length&&this.splitTile($t,0,0,0),Tt&&($t.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}splitTile(rt,at,Tt,$t,qt,Kt,ge){const Hr=[rt,at,Tt,$t],wn=this.options,es=wn.debug;for(;Hr.length;){$t=Hr.pop(),Tt=Hr.pop(),at=Hr.pop(),rt=Hr.pop();const ss=1<<at,os=se(at,Tt,$t);let cs=this.tiles[os];if(!cs&&(es>1&&console.time("creation"),cs=this.tiles[os]=ee(rt,at,Tt,$t,wn),this.tileCoords.push({z:at,x:Tt,y:$t}),es)){es>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",at,Tt,$t,cs.numFeatures,cs.numPoints,cs.numSimplified),console.timeEnd("creation"));const rt=`z${at}`;this.stats[rt]=(this.stats[rt]||0)+1,this.total++}if(cs.source=rt,null==qt){if(at===wn.indexMaxZoom||cs.numPoints<=wn.indexMaxPoints)continue}else{if(at===wn.maxZoom||at===qt)continue;if(null!=qt){const rt=qt-at;if(Tt!==Kt>>rt||$t!==ge>>rt)continue}}if(cs.source=null,0===rt.length)continue;es>1&&console.time("clipping");const ds=.5*wn.buffer/wn.extent,Cs=.5-ds,Vs=.5+ds,Eo=1+ds;let Do=null,Ho=null,Ea=null,La=null,ja=W(rt,ss,Tt-ds,Tt+Vs,0,cs.minX,cs.maxX,wn),Va=W(rt,ss,Tt+Cs,Tt+Eo,0,cs.minX,cs.maxX,wn);rt=null,ja&&(Do=W(ja,ss,$t-ds,$t+Vs,1,cs.minY,cs.maxY,wn),Ho=W(ja,ss,$t+Cs,$t+Eo,1,cs.minY,cs.maxY,wn),ja=null),Va&&(Ea=W(Va,ss,$t-ds,$t+Vs,1,cs.minY,cs.maxY,wn),La=W(Va,ss,$t+Cs,$t+Eo,1,cs.minY,cs.maxY,wn),Va=null),es>1&&console.timeEnd("clipping"),Hr.push(Do||[],at+1,2*Tt,2*$t),Hr.push(Ho||[],at+1,2*Tt,2*$t+1),Hr.push(Ea||[],at+1,2*Tt+1,2*$t),Hr.push(La||[],at+1,2*Tt+1,2*$t+1)}}getTile(rt,at,Tt){rt=+rt,at=+at,Tt=+Tt;const $t=this.options,{extent:qt,debug:Kt}=$t;if(rt<0||rt>24)return null;const ge=1<<rt,Hr=se(rt,at=at+ge&ge-1,Tt);if(this.tiles[Hr])return K(this.tiles[Hr],qt);Kt>1&&console.log("drilling down to z%d-%d-%d",rt,at,Tt);let wn,es=rt,ss=at,os=Tt;for(;!wn&&es>0;)es--,ss>>=1,os>>=1,wn=this.tiles[se(es,ss,os)];return wn&&wn.source?(Kt>1&&(console.log("found parent tile z%d-%d-%d",es,ss,os),console.time("drilling down")),this.splitTile(wn.source,es,ss,os,rt,at,Tt),Kt>1&&console.timeEnd("drilling down"),this.tiles[Hr]?K(this.tiles[Hr],qt):null):null}}function se(rt,at,Tt){return 32*((1<<rt)*Tt+at)+rt}function ne(rt,at){return at?rt.properties[at]:rt.id}function ae(rt,at){if(null==rt)return!0;if("Feature"===rt.type)return null!=ne(rt,at);if("FeatureCollection"===rt.type){const Tt=new Set;for(const $t of rt.features){const rt=ne($t,at);if(null==rt)return!1;if(Tt.has(rt))return!1;Tt.add(rt)}return!0}return!1}function le(rt,at){const Tt=new Map;if(null==rt);else if("Feature"===rt.type)Tt.set(ne(rt,at),rt);else for(const $t of rt.features)Tt.set(ne($t,at),$t);return Tt}class ce extends s{constructor(){super(...arguments),this._dataUpdateable=new Map}loadVectorTile(rt,Tt){return at._(this,void 0,void 0,(function*(){const at=rt.tileID.canonical;if(!this._geoJSONIndex)throw new Error("Unable to parse the data into a cluster or geojson");const Tt=this._geoJSONIndex.getTile(at.z,at.x,at.y);if(!Tt)return null;const $t=new f(Tt.features);let qt=cs($t);return 0===qt.byteOffset&&qt.byteLength===qt.buffer.byteLength||(qt=new Uint8Array(qt)),{vectorTile:$t,rawData:qt.buffer}}))}loadData(rt){return at._(this,void 0,void 0,(function*(){var Tt;null===(Tt=this._pendingRequest)||void 0===Tt||Tt.abort();const $t=!!(rt&&rt.request&&rt.request.collectResourceTiming)&&new at.cC(rt.request);this._pendingRequest=new AbortController;try{this._pendingData=this.loadAndProcessGeoJSON(rt,this._pendingRequest),this._geoJSONIndex=rt.cluster?new P(function({superclusterOptions:rt,clusterProperties:Tt}){if(!Tt||!rt)return rt;const $t={},qt={},Kt={accumulated:null,zoom:0},ge={properties:null},Hr=Object.keys(Tt);for(const rt of Hr){const[Kt,ge]=Tt[rt],Hr=at.cJ(ge),wn=at.cJ("string"==typeof Kt?[Kt,["accumulated"],["get",rt]]:Kt);$t[rt]=Hr.value,qt[rt]=wn.value}return rt.map=rt=>{ge.properties=rt;const at={};for(const rt of Hr)at[rt]=$t[rt].evaluate(Kt,ge);return at},rt.reduce=(rt,at)=>{ge.properties=at;for(const at of Hr)Kt.accumulated=rt[at],rt[at]=qt[at].evaluate(Kt,ge)},rt}(rt)).load((yield this._pendingData).features):(qt=yield this._pendingData,new re(qt,rt.geojsonVtOptions)),this.loaded={};const Tt={};if($t){const at=$t.finish();at&&(Tt.resourceTiming={},Tt.resourceTiming[rt.source]=JSON.parse(JSON.stringify(at)))}return Tt}catch(rt){if(delete this._pendingRequest,at.cn(rt))return{abandoned:!0};throw rt}var qt}))}getData(){return at._(this,void 0,void 0,(function*(){return this._pendingData}))}reloadTile(rt){const at=this.loaded;return at&&at[rt.uid]?super.reloadTile(rt):this.loadTile(rt)}loadAndProcessGeoJSON(rt,Tt){return at._(this,void 0,void 0,(function*(){let $t=yield this.loadGeoJSON(rt,Tt);if(delete this._pendingRequest,"object"!=typeof $t)throw new Error(`Input data given to '${rt.source}' is not a valid GeoJSON object.`);if(Kt($t,!0),rt.filter){const Tt=at.cJ(rt.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if("error"===Tt.result)throw new Error(Tt.value.map((rt=>`${rt.key}: ${rt.message}`)).join(", "));const qt=$t.features.filter((rt=>Tt.value.evaluate({zoom:0},rt)));$t={type:"FeatureCollection",features:qt}}return $t}))}loadGeoJSON(rt,Tt){return at._(this,void 0,void 0,(function*(){const{promoteId:$t}=rt;if(rt.request){const qt=yield at.j(rt.request,Tt);return this._dataUpdateable=ae(qt.data,$t)?le(qt.data,$t):void 0,qt.data}if("string"==typeof rt.data)try{const at=JSON.parse(rt.data);return this._dataUpdateable=ae(at,$t)?le(at,$t):void 0,at}catch(at){throw new Error(`Input data given to '${rt.source}' is not a valid GeoJSON object.`)}if(!rt.dataDiff)throw new Error(`Input data given to '${rt.source}' is not a valid GeoJSON object.`);if(!this._dataUpdateable)throw new Error(`Cannot update existing geojson data in ${rt.source}`);return function(rt,at,Tt){var $t,qt,Kt,ge;if(at.removeAll&&rt.clear(),at.remove)for(const Tt of at.remove)rt.delete(Tt);if(at.add)for(const $t of at.add){const at=ne($t,Tt);null!=at&&rt.set(at,$t)}if(at.update)for(const Tt of at.update){let at=rt.get(Tt.id);if(null==at)continue;const Hr=!Tt.removeAllProperties&&((null===($t=Tt.removeProperties)||void 0===$t?void 0:$t.length)>0||(null===(qt=Tt.addOrUpdateProperties)||void 0===qt?void 0:qt.length)>0);if((Tt.newGeometry||Tt.removeAllProperties||Hr)&&(at=Object.assign({},at),rt.set(Tt.id,at),Hr&&(at.properties=Object.assign({},at.properties))),Tt.newGeometry&&(at.geometry=Tt.newGeometry),Tt.removeAllProperties)at.properties={};else if((null===(Kt=Tt.removeProperties)||void 0===Kt?void 0:Kt.length)>0)for(const rt of Tt.removeProperties)Object.prototype.hasOwnProperty.call(at.properties,rt)&&delete at.properties[rt];if((null===(ge=Tt.addOrUpdateProperties)||void 0===ge?void 0:ge.length)>0)for(const{key:rt,value:$t}of Tt.addOrUpdateProperties)at.properties[rt]=$t}}(this._dataUpdateable,rt.dataDiff,$t),{type:"FeatureCollection",features:Array.from(this._dataUpdateable.values())}}))}removeSource(rt){return at._(this,void 0,void 0,(function*(){this._pendingRequest&&this._pendingRequest.abort()}))}getClusterExpansionZoom(rt){return this._geoJSONIndex.getClusterExpansionZoom(rt.clusterId)}getClusterChildren(rt){return this._geoJSONIndex.getChildren(rt.clusterId)}getClusterLeaves(rt){return this._geoJSONIndex.getLeaves(rt.clusterId,rt.limit,rt.offset)}}class ue{constructor(rt){this.self=rt,this.actor=new at.H(rt),this.layerIndexes={},this.availableImages={},this.workerSources={},this.demWorkerSources={},this.externalWorkerSourceTypes={},this.self.registerWorkerSource=(rt,at)=>{if(this.externalWorkerSourceTypes[rt])throw new Error(`Worker source with name "${rt}" already registered.`);this.externalWorkerSourceTypes[rt]=at},this.self.addProtocol=at.cp,this.self.removeProtocol=at.cq,this.self.registerRTLTextPlugin=rt=>{at.cK.setMethods(rt)},this.actor.registerMessageHandler("LDT",((rt,at)=>this._getDEMWorkerSource(rt,at.source).loadTile(at))),this.actor.registerMessageHandler("RDT",((rt,Tt)=>at._(this,void 0,void 0,(function*(){this._getDEMWorkerSource(rt,Tt.source).removeTile(Tt)})))),this.actor.registerMessageHandler("GCEZ",((rt,Tt)=>at._(this,void 0,void 0,(function*(){return this._getWorkerSource(rt,Tt.type,Tt.source).getClusterExpansionZoom(Tt)})))),this.actor.registerMessageHandler("GCC",((rt,Tt)=>at._(this,void 0,void 0,(function*(){return this._getWorkerSource(rt,Tt.type,Tt.source).getClusterChildren(Tt)})))),this.actor.registerMessageHandler("GCL",((rt,Tt)=>at._(this,void 0,void 0,(function*(){return this._getWorkerSource(rt,Tt.type,Tt.source).getClusterLeaves(Tt)})))),this.actor.registerMessageHandler("LD",((rt,at)=>this._getWorkerSource(rt,at.type,at.source).loadData(at))),this.actor.registerMessageHandler("GD",((rt,at)=>this._getWorkerSource(rt,at.type,at.source).getData())),this.actor.registerMessageHandler("LT",((rt,at)=>this._getWorkerSource(rt,at.type,at.source).loadTile(at))),this.actor.registerMessageHandler("RT",((rt,at)=>this._getWorkerSource(rt,at.type,at.source).reloadTile(at))),this.actor.registerMessageHandler("AT",((rt,at)=>this._getWorkerSource(rt,at.type,at.source).abortTile(at))),this.actor.registerMessageHandler("RMT",((rt,at)=>this._getWorkerSource(rt,at.type,at.source).removeTile(at))),this.actor.registerMessageHandler("RS",((rt,Tt)=>at._(this,void 0,void 0,(function*(){if(!this.workerSources[rt]||!this.workerSources[rt][Tt.type]||!this.workerSources[rt][Tt.type][Tt.source])return;const at=this.workerSources[rt][Tt.type][Tt.source];delete this.workerSources[rt][Tt.type][Tt.source],void 0!==at.removeSource&&at.removeSource(Tt)})))),this.actor.registerMessageHandler("RM",(rt=>at._(this,void 0,void 0,(function*(){delete this.layerIndexes[rt],delete this.availableImages[rt],delete this.workerSources[rt],delete this.demWorkerSources[rt]})))),this.actor.registerMessageHandler("SR",((rt,Tt)=>at._(this,void 0,void 0,(function*(){this.referrer=Tt})))),this.actor.registerMessageHandler("SRPS",((rt,at)=>this._syncRTLPluginState(rt,at))),this.actor.registerMessageHandler("IS",((rt,Tt)=>at._(this,void 0,void 0,(function*(){this.self.importScripts(Tt)})))),this.actor.registerMessageHandler("SI",((rt,at)=>this._setImages(rt,at))),this.actor.registerMessageHandler("UL",((rt,Tt)=>at._(this,void 0,void 0,(function*(){this._getLayerIndex(rt).update(Tt.layers,Tt.removedIds)})))),this.actor.registerMessageHandler("SL",((rt,Tt)=>at._(this,void 0,void 0,(function*(){this._getLayerIndex(rt).replace(Tt)}))))}_setImages(rt,Tt){return at._(this,void 0,void 0,(function*(){this.availableImages[rt]=Tt;for(const at in this.workerSources[rt]){const $t=this.workerSources[rt][at];for(const rt in $t)$t[rt].availableImages=Tt}}))}_syncRTLPluginState(rt,Tt){return at._(this,void 0,void 0,(function*(){return yield at.cK.syncState(Tt,this.self.importScripts)}))}_getAvailableImages(rt){let at=this.availableImages[rt];return at||(at=[]),at}_getLayerIndex(rt){let at=this.layerIndexes[rt];return at||(at=this.layerIndexes[rt]=new t),at}_getWorkerSource(rt,at,Tt){if(this.workerSources[rt]||(this.workerSources[rt]={}),this.workerSources[rt][at]||(this.workerSources[rt][at]={}),!this.workerSources[rt][at][Tt]){const $t={sendAsync:(at,Tt)=>(at.targetMapId=rt,this.actor.sendAsync(at,Tt))};switch(at){case"vector":this.workerSources[rt][at][Tt]=new s($t,this._getLayerIndex(rt),this._getAvailableImages(rt));break;case"geojson":this.workerSources[rt][at][Tt]=new ce($t,this._getLayerIndex(rt),this._getAvailableImages(rt));break;default:this.workerSources[rt][at][Tt]=new this.externalWorkerSourceTypes[at]($t,this._getLayerIndex(rt),this._getAvailableImages(rt))}}return this.workerSources[rt][at][Tt]}_getDEMWorkerSource(rt,at){return this.demWorkerSources[rt]||(this.demWorkerSources[rt]={}),this.demWorkerSources[rt][at]||(this.demWorkerSources[rt][at]=new n),this.demWorkerSources[rt][at]}}return at.i(self)&&(self.worker=new ue(self)),ue}));define("index",["exports","./shared"],(function(at,Tt){var $t="5.4.0";function r(){var rt=new Tt.A(4);return Tt.A!=Float32Array&&(rt[1]=0,rt[2]=0),rt[0]=1,rt[3]=1,rt}let qt,Kt;const ge={now:"undefined"!=typeof performance&&performance&&performance.now?performance.now.bind(performance):Date.now.bind(Date),frame(rt,at,$t){const qt=requestAnimationFrame((rt=>{Kt(),at(rt)})),{unsubscribe:Kt}=Tt.s(rt.signal,"abort",(()=>{Kt(),cancelAnimationFrame(qt),$t(Tt.c())}),!1)},frameAsync(rt){return new Promise(((at,Tt)=>{this.frame(rt,at,Tt)}))},getImageData(rt,at=0){return this.getImageCanvasContext(rt).getImageData(-at,-at,rt.width+2*at,rt.height+2*at)},getImageCanvasContext(rt){const at=window.document.createElement("canvas"),Tt=at.getContext("2d",{willReadFrequently:!0});if(!Tt)throw new Error("failed to create canvas 2d context");return at.width=rt.width,at.height=rt.height,Tt.drawImage(rt,0,0,rt.width,rt.height),Tt},resolveURL:rt=>(qt||(qt=document.createElement("a")),qt.href=rt,qt.href),hardwareConcurrency:"undefined"!=typeof navigator&&navigator.hardwareConcurrency||4,get prefersReducedMotion(){return!!matchMedia&&(null==Kt&&(Kt=matchMedia("(prefers-reduced-motion: reduce)")),Kt.matches)}};class n{static testProp(rt){if(!n.docStyle)return rt[0];for(let at=0;at<rt.length;at++)if(rt[at]in n.docStyle)return rt[at];return rt[0]}static create(rt,at,Tt){const $t=window.document.createElement(rt);return void 0!==at&&($t.className=at),Tt&&Tt.appendChild($t),$t}static createNS(rt,at){return window.document.createElementNS(rt,at)}static disableDrag(){n.docStyle&&n.selectProp&&(n.userSelect=n.docStyle[n.selectProp],n.docStyle[n.selectProp]="none")}static enableDrag(){n.docStyle&&n.selectProp&&(n.docStyle[n.selectProp]=n.userSelect)}static setTransform(rt,at){rt.style[n.transformProp]=at}static addEventListener(rt,at,Tt,$t={}){rt.addEventListener(at,Tt,"passive"in $t?$t:$t.capture)}static removeEventListener(rt,at,Tt,$t={}){rt.removeEventListener(at,Tt,"passive"in $t?$t:$t.capture)}static suppressClickInternal(rt){rt.preventDefault(),rt.stopPropagation(),window.removeEventListener("click",n.suppressClickInternal,!0)}static suppressClick(){window.addEventListener("click",n.suppressClickInternal,!0),window.setTimeout((()=>{window.removeEventListener("click",n.suppressClickInternal,!0)}),0)}static getScale(rt){const at=rt.getBoundingClientRect();return{x:at.width/rt.offsetWidth||1,y:at.height/rt.offsetHeight||1,boundingClientRect:at}}static getPoint(rt,at,$t){const qt=at.boundingClientRect;return new Tt.P(($t.clientX-qt.left)/at.x-rt.clientLeft,($t.clientY-qt.top)/at.y-rt.clientTop)}static mousePos(rt,at){const Tt=n.getScale(rt);return n.getPoint(rt,Tt,at)}static touchPos(rt,at){const Tt=[],$t=n.getScale(rt);for(let qt=0;qt<at.length;qt++)Tt.push(n.getPoint(rt,$t,at[qt]));return Tt}static mouseButton(rt){return rt.button}static remove(rt){rt.parentNode&&rt.parentNode.removeChild(rt)}static sanitize(rt){const at=(new DOMParser).parseFromString(rt,"text/html").body||document.createElement("body"),Tt=at.querySelectorAll("script");for(const rt of Tt)rt.remove();return n.clean(at),at.innerHTML}static isPossiblyDangerous(rt,at){const Tt=at.replace(/\s+/g,"").toLowerCase();return!(!["src","href","xlink:href"].includes(rt)||!Tt.includes("javascript:")&&!Tt.includes("data:"))||!!rt.startsWith("on")||void 0}static clean(rt){const at=rt.children;for(const rt of at)n.removeAttributes(rt),n.clean(rt)}static removeAttributes(rt){for(const{name:at,value:Tt}of rt.attributes)n.isPossiblyDangerous(at,Tt)&&rt.removeAttribute(at)}}n.docStyle="undefined"!=typeof window&&window.document&&window.document.documentElement.style,n.selectProp=n.testProp(["userSelect","MozUserSelect","WebkitUserSelect","msUserSelect"]),n.transformProp=n.testProp(["transform","WebkitTransform"]);const Hr={supported:!1,testSupport:function(rt){!ss&&es&&(os?_(rt):wn=rt)}};let wn,es,ss=!1,os=!1;function _(rt){const at=rt.createTexture();rt.bindTexture(rt.TEXTURE_2D,at);try{if(rt.texImage2D(rt.TEXTURE_2D,0,rt.RGBA,rt.RGBA,rt.UNSIGNED_BYTE,es),rt.isContextLost())return;Hr.supported=!0}catch(rt){}rt.deleteTexture(at),ss=!0}var cs;"undefined"!=typeof document&&(es=document.createElement("img"),es.onload=()=>{wn&&_(wn),wn=null,os=!0},es.onerror=()=>{ss=!0,wn=null},es.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA="),function(at){let $t,qt,Kt,ge;at.resetRequestQueue=()=>{$t=[],qt=0,Kt=0,ge={}},at.addThrottleControl=rt=>{const at=Kt++;return ge[at]=rt,at},at.removeThrottleControl=rt=>{delete ge[rt],n()},at.getImage=(rt,at,qt=!0)=>new Promise(((Kt,ge)=>{Hr.supported&&(rt.headers||(rt.headers={}),rt.headers.accept="image/webp,*/*"),Tt.e(rt,{type:"image"}),$t.push({abortController:at,requestParameters:rt,supportImageRefresh:qt,state:"queued",onError:rt=>{ge(rt)},onSuccess:rt=>{Kt(rt)}}),n()}));const s=at=>Tt._(this||rt,void 0,void 0,(function*(){at.state="running";const{requestParameters:rt,supportImageRefresh:$t,onError:Kt,onSuccess:ge,abortController:Hr}=at,wn=!1===$t&&!Tt.i(self)&&!Tt.g(rt.url)&&(!rt.headers||Object.keys(rt.headers).reduce(((rt,at)=>rt&&"accept"===at),!0));qt++;const es=wn?c(rt,Hr):Tt.m(rt,Hr);try{const rt=yield es;delete at.abortController,at.state="completed",rt.data instanceof HTMLImageElement||Tt.b(rt.data)?ge(rt):rt.data&&ge({data:yield(ss=rt.data,"function"==typeof createImageBitmap?Tt.f(ss):Tt.h(ss)),cacheControl:rt.cacheControl,expires:rt.expires})}catch(rt){delete at.abortController,Kt(rt)}finally{qt--,n()}var ss})),n=()=>{const rt=(()=>{for(const rt of Object.keys(ge))if(ge[rt]())return!0;return!1})()?Tt.a.MAX_PARALLEL_IMAGE_REQUESTS_PER_FRAME:Tt.a.MAX_PARALLEL_IMAGE_REQUESTS;for(let at=qt;at<rt&&$t.length>0;at++){const rt=$t.shift();rt.abortController.signal.aborted?at--:s(rt)}},c=(rt,at)=>new Promise((($t,qt)=>{const Kt=new Image,ge=rt.url,Hr=rt.credentials;Hr&&"include"===Hr?Kt.crossOrigin="use-credentials":(Hr&&"same-origin"===Hr||!Tt.d(ge))&&(Kt.crossOrigin="anonymous"),at.signal.addEventListener("abort",(()=>{Kt.src="",qt(Tt.c())})),Kt.fetchPriority="high",Kt.onload=()=>{Kt.onerror=Kt.onload=null,$t({data:Kt})},Kt.onerror=()=>{Kt.onerror=Kt.onload=null,at.signal.aborted||qt(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."))},Kt.src=ge}))}(cs||(cs={})),cs.resetRequestQueue();class m{constructor(rt){this._transformRequestFn=rt}transformRequest(rt,at){return this._transformRequestFn&&this._transformRequestFn(rt,at)||{url:rt}}setTransformRequest(rt){this._transformRequestFn=rt}}function f(rt){const at=[];if("string"==typeof rt)at.push({id:"default",url:rt});else if(rt&&rt.length>0){const Tt=[];for(const{id:$t,url:qt}of rt){const rt=`${$t}${qt}`;-1===Tt.indexOf(rt)&&(Tt.push(rt),at.push({id:$t,url:qt}))}}return at}function g(rt,at,Tt){try{const $t=new URL(rt);return $t.pathname+=`${at}${Tt}`,$t.toString()}catch(at){throw new Error(`Invalid sprite URL "${rt}", must be absolute. Modify style specification directly or use TransformStyleFunction to correct the issue dynamically`)}}class v{constructor(rt,at,Tt,$t){this.context=rt,this.format=Tt,this.texture=rt.gl.createTexture(),this.update(at,$t)}update(rt,at,$t){const{width:qt,height:Kt}=rt,ge=!(this.size&&this.size[0]===qt&&this.size[1]===Kt||$t),{context:Hr}=this,{gl:wn}=Hr;if(this.useMipmap=Boolean(at&&at.useMipmap),wn.bindTexture(wn.TEXTURE_2D,this.texture),Hr.pixelStoreUnpackFlipY.set(!1),Hr.pixelStoreUnpack.set(1),Hr.pixelStoreUnpackPremultiplyAlpha.set(this.format===wn.RGBA&&(!at||!1!==at.premultiply)),ge)this.size=[qt,Kt],rt instanceof HTMLImageElement||rt instanceof HTMLCanvasElement||rt instanceof HTMLVideoElement||rt instanceof ImageData||Tt.b(rt)?wn.texImage2D(wn.TEXTURE_2D,0,this.format,this.format,wn.UNSIGNED_BYTE,rt):wn.texImage2D(wn.TEXTURE_2D,0,this.format,qt,Kt,0,this.format,wn.UNSIGNED_BYTE,rt.data);else{const{x:at,y:ge}=$t||{x:0,y:0};rt instanceof HTMLImageElement||rt instanceof HTMLCanvasElement||rt instanceof HTMLVideoElement||rt instanceof ImageData||Tt.b(rt)?wn.texSubImage2D(wn.TEXTURE_2D,0,at,ge,wn.RGBA,wn.UNSIGNED_BYTE,rt):wn.texSubImage2D(wn.TEXTURE_2D,0,at,ge,qt,Kt,wn.RGBA,wn.UNSIGNED_BYTE,rt.data)}this.useMipmap&&this.isSizePowerOfTwo()&&wn.generateMipmap(wn.TEXTURE_2D),Hr.pixelStoreUnpackFlipY.setDefault(),Hr.pixelStoreUnpack.setDefault(),Hr.pixelStoreUnpackPremultiplyAlpha.setDefault()}bind(rt,at,Tt){const{context:$t}=this,{gl:qt}=$t;qt.bindTexture(qt.TEXTURE_2D,this.texture),Tt!==qt.LINEAR_MIPMAP_NEAREST||this.isSizePowerOfTwo()||(Tt=qt.LINEAR),rt!==this.filter&&(qt.texParameteri(qt.TEXTURE_2D,qt.TEXTURE_MAG_FILTER,rt),qt.texParameteri(qt.TEXTURE_2D,qt.TEXTURE_MIN_FILTER,Tt||rt),this.filter=rt),at!==this.wrap&&(qt.texParameteri(qt.TEXTURE_2D,qt.TEXTURE_WRAP_S,at),qt.texParameteri(qt.TEXTURE_2D,qt.TEXTURE_WRAP_T,at),this.wrap=at)}isSizePowerOfTwo(){return this.size[0]===this.size[1]&&Math.log(this.size[0])/Math.LN2%1==0}destroy(){const{gl:rt}=this.context;rt.deleteTexture(this.texture),this.texture=null}}function x(rt){const{userImage:at}=rt;return!!(at&&at.render&&at.render())&&(rt.data.replace(new Uint8Array(at.data.buffer)),!0)}class b extends Tt.E{constructor(){super(),this.images={},this.updatedImages={},this.callbackDispatchedThisFrame={},this.loaded=!1,this.requestors=[],this.patterns={},this.atlasImage=new Tt.R({width:1,height:1}),this.dirty=!0}isLoaded(){return this.loaded}setLoaded(rt){if(this.loaded!==rt&&(this.loaded=rt,rt)){for(const{ids:rt,promiseResolve:at}of this.requestors)at(this._getImagesForIds(rt));this.requestors=[]}}getImage(rt){const at=this.images[rt];if(at&&!at.data&&at.spriteData){const rt=at.spriteData;at.data=new Tt.R({width:rt.width,height:rt.height},rt.context.getImageData(rt.x,rt.y,rt.width,rt.height).data),at.spriteData=null}return at}addImage(rt,at){if(this.images[rt])throw new Error(`Image id ${rt} already exist, use updateImage instead`);this._validate(rt,at)&&(this.images[rt]=at)}_validate(rt,at){let $t=!0;const qt=at.data||at.spriteData;return this._validateStretch(at.stretchX,qt&&qt.width)||(this.fire(new Tt.k(new Error(`Image "${rt}" has invalid "stretchX" value`))),$t=!1),this._validateStretch(at.stretchY,qt&&qt.height)||(this.fire(new Tt.k(new Error(`Image "${rt}" has invalid "stretchY" value`))),$t=!1),this._validateContent(at.content,at)||(this.fire(new Tt.k(new Error(`Image "${rt}" has invalid "content" value`))),$t=!1),$t}_validateStretch(rt,at){if(!rt)return!0;let Tt=0;for(const $t of rt){if($t[0]<Tt||$t[1]<$t[0]||at<$t[1])return!1;Tt=$t[1]}return!0}_validateContent(rt,at){if(!rt)return!0;if(4!==rt.length)return!1;const Tt=at.spriteData,$t=Tt&&Tt.width||at.data.width,qt=Tt&&Tt.height||at.data.height;return!(rt[0]<0||$t<rt[0]||rt[1]<0||qt<rt[1]||rt[2]<0||$t<rt[2]||rt[3]<0||qt<rt[3]||rt[2]<rt[0]||rt[3]<rt[1])}updateImage(rt,at,Tt=!0){const $t=this.getImage(rt);if(Tt&&($t.data.width!==at.data.width||$t.data.height!==at.data.height))throw new Error(`size mismatch between old image (${$t.data.width}x${$t.data.height}) and new image (${at.data.width}x${at.data.height}).`);at.version=$t.version+1,this.images[rt]=at,this.updatedImages[rt]=!0}removeImage(rt){const at=this.images[rt];delete this.images[rt],delete this.patterns[rt],at.userImage&&at.userImage.onRemove&&at.userImage.onRemove()}listImages(){return Object.keys(this.images)}getImages(rt){return new Promise(((at,Tt)=>{let $t=!0;if(!this.isLoaded())for(const at of rt)this.images[at]||($t=!1);this.isLoaded()||$t?at(this._getImagesForIds(rt)):this.requestors.push({ids:rt,promiseResolve:at})}))}_getImagesForIds(rt){const at={};for(const $t of rt){let rt=this.getImage($t);rt||(this.fire(new Tt.l("styleimagemissing",{id:$t})),rt=this.getImage($t)),rt?at[$t]={data:rt.data.clone(),pixelRatio:rt.pixelRatio,sdf:rt.sdf,version:rt.version,stretchX:rt.stretchX,stretchY:rt.stretchY,content:rt.content,textFitWidth:rt.textFitWidth,textFitHeight:rt.textFitHeight,hasRenderCallback:Boolean(rt.userImage&&rt.userImage.render)}:Tt.w(`Image "${$t}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`)}return at}getPixelSize(){const{width:rt,height:at}=this.atlasImage;return{width:rt,height:at}}getPattern(rt){const at=this.patterns[rt],$t=this.getImage(rt);if(!$t)return null;if(at&&at.position.version===$t.version)return at.position;if(at)at.position.version=$t.version;else{const at={w:$t.data.width+2,h:$t.data.height+2,x:0,y:0},qt=new Tt.I(at,$t);this.patterns[rt]={bin:at,position:qt}}return this._updatePatternAtlas(),this.patterns[rt].position}bind(rt){const at=rt.gl;this.atlasTexture?this.dirty&&(this.atlasTexture.update(this.atlasImage),this.dirty=!1):this.atlasTexture=new v(rt,this.atlasImage,at.RGBA),this.atlasTexture.bind(at.LINEAR,at.CLAMP_TO_EDGE)}_updatePatternAtlas(){const rt=[];for(const at in this.patterns)rt.push(this.patterns[at].bin);const{w:at,h:$t}=Tt.p(rt),qt=this.atlasImage;qt.resize({width:at||1,height:$t||1});for(const rt in this.patterns){const{bin:at}=this.patterns[rt],$t=at.x+1,Kt=at.y+1,ge=this.getImage(rt).data,Hr=ge.width,wn=ge.height;Tt.R.copy(ge,qt,{x:0,y:0},{x:$t,y:Kt},{width:Hr,height:wn}),Tt.R.copy(ge,qt,{x:0,y:wn-1},{x:$t,y:Kt-1},{width:Hr,height:1}),Tt.R.copy(ge,qt,{x:0,y:0},{x:$t,y:Kt+wn},{width:Hr,height:1}),Tt.R.copy(ge,qt,{x:Hr-1,y:0},{x:$t-1,y:Kt},{width:1,height:wn}),Tt.R.copy(ge,qt,{x:0,y:0},{x:$t+Hr,y:Kt},{width:1,height:wn})}this.dirty=!0}beginFrame(){this.callbackDispatchedThisFrame={}}dispatchRenderCallbacks(rt){for(const at of rt){if(this.callbackDispatchedThisFrame[at])continue;this.callbackDispatchedThisFrame[at]=!0;const rt=this.getImage(at);rt||Tt.w(`Image with ID: "${at}" was not found`),x(rt)&&this.updateImage(at,rt)}}}const ds=1e20;function w(rt,at,Tt,$t,qt,Kt,ge,Hr,wn){for(let es=at;es<at+$t;es++)T(rt,Tt*Kt+es,Kt,qt,ge,Hr,wn);for(let es=Tt;es<Tt+qt;es++)T(rt,es*Kt+at,1,$t,ge,Hr,wn)}function T(rt,at,Tt,$t,qt,Kt,ge){Kt[0]=0,ge[0]=-1e20,ge[1]=ds,qt[0]=rt[at];for(let Hr=1,wn=0,es=0;Hr<$t;Hr++){qt[Hr]=rt[at+Hr*Tt];const $t=Hr*Hr;do{const rt=Kt[wn];es=(qt[Hr]-qt[rt]+$t-rt*rt)/(Hr-rt)/2}while(es<=ge[wn]&&--wn>-1);wn++,Kt[wn]=Hr,ge[wn]=es,ge[wn+1]=ds}for(let Hr=0,wn=0;Hr<$t;Hr++){for(;ge[wn+1]<Hr;)wn++;const $t=Kt[wn],es=Hr-$t;rt[at+Hr*Tt]=qt[$t]+es*es}}class P{constructor(rt,at){this.requestManager=rt,this.localIdeographFontFamily=at,this.entries={}}setURL(rt){this.url=rt}getGlyphs(rt){return Tt._(this,void 0,void 0,(function*(){const at=[];for(const Tt in rt)for(const $t of rt[Tt])at.push(this._getAndCacheGlyphsPromise(Tt,$t));const Tt=yield Promise.all(at),$t={};for(const{stack:rt,id:at,glyph:qt}of Tt)$t[rt]||($t[rt]={}),$t[rt][at]=qt&&{id:qt.id,bitmap:qt.bitmap.clone(),metrics:qt.metrics};return $t}))}_getAndCacheGlyphsPromise(rt,at){return Tt._(this,void 0,void 0,(function*(){let Tt=this.entries[rt];Tt||(Tt=this.entries[rt]={glyphs:{},requests:{},ranges:{}});let $t=Tt.glyphs[at];if(void 0!==$t)return{stack:rt,id:at,glyph:$t};if($t=this._tinySDF(Tt,rt,at),$t)return Tt.glyphs[at]=$t,{stack:rt,id:at,glyph:$t};const qt=Math.floor(at/256);if(256*qt>65535)throw new Error("glyphs > 65535 not supported");if(Tt.ranges[qt])return{stack:rt,id:at,glyph:$t};if(!this.url)throw new Error("glyphsUrl is not set");if(!Tt.requests[qt]){const at=P.loadGlyphRange(rt,qt,this.url,this.requestManager);Tt.requests[qt]=at}const Kt=yield Tt.requests[qt];for(const rt in Kt)this._doesCharSupportLocalGlyph(+rt)||(Tt.glyphs[+rt]=Kt[+rt]);return Tt.ranges[qt]=!0,{stack:rt,id:at,glyph:Kt[at]||null}}))}_doesCharSupportLocalGlyph(rt){return!!this.localIdeographFontFamily&&(/\p{Ideo}|\p{sc=Hang}|\p{sc=Hira}|\p{sc=Kana}/u.test(String.fromCodePoint(rt))||Tt.u["CJK Unified Ideographs"](rt)||Tt.u["Hangul Syllables"](rt)||Tt.u.Hiragana(rt)||Tt.u.Katakana(rt)||Tt.u["CJK Symbols and Punctuation"](rt)||Tt.u["Halfwidth and Fullwidth Forms"](rt))}_tinySDF(rt,at,$t){const qt=this.localIdeographFontFamily;if(!qt)return;if(!this._doesCharSupportLocalGlyph($t))return;let Kt=rt.tinySDF;if(!Kt){let Tt="400";/bold/i.test(at)?Tt="900":/medium/i.test(at)?Tt="500":/light/i.test(at)&&(Tt="200"),Kt=rt.tinySDF=new P.TinySDF({fontSize:48,buffer:6,radius:16,cutoff:.25,fontFamily:qt,fontWeight:Tt})}const ge=Kt.draw(String.fromCharCode($t));return{id:$t,bitmap:new Tt.q({width:ge.width||60,height:ge.height||60},ge.data),metrics:{width:ge.glyphWidth/2||24,height:ge.glyphHeight/2||24,left:ge.glyphLeft/2+.5||0,top:ge.glyphTop/2-27.5||-8,advance:ge.glyphAdvance/2||24,isDoubleResolution:!0}}}}P.loadGlyphRange=function(at,$t,qt,Kt){return Tt._(this||rt,void 0,void 0,(function*(){const rt=256*$t,ge=rt+255,Hr=Kt.transformRequest(qt.replace("{fontstack}",at).replace("{range}",`${rt}-${ge}`),"Glyphs"),wn=yield Tt.n(Hr,new AbortController);if(!wn||!wn.data)throw new Error(`Could not load glyph range. range: ${$t}, ${rt}-${ge}`);const es={};for(const rt of Tt.o(wn.data))es[rt.id]=rt;return es}))},P.TinySDF=class{constructor({fontSize:rt=24,buffer:at=3,radius:Tt=8,cutoff:$t=.25,fontFamily:qt="sans-serif",fontWeight:Kt="normal",fontStyle:ge="normal"}={}){this.buffer=at,this.cutoff=$t,this.radius=Tt;const Hr=this.size=rt+4*at,wn=this._createCanvas(Hr),es=this.ctx=wn.getContext("2d",{willReadFrequently:!0});es.font=`${ge} ${Kt} ${rt}px ${qt}`,es.textBaseline="alphabetic",es.textAlign="left",es.fillStyle="black",this.gridOuter=new Float64Array(Hr*Hr),this.gridInner=new Float64Array(Hr*Hr),this.f=new Float64Array(Hr),this.z=new Float64Array(Hr+1),this.v=new Uint16Array(Hr)}_createCanvas(rt){const at=document.createElement("canvas");return at.width=at.height=rt,at}draw(rt){const{width:at,actualBoundingBoxAscent:Tt,actualBoundingBoxDescent:$t,actualBoundingBoxLeft:qt,actualBoundingBoxRight:Kt}=this.ctx.measureText(rt),ge=Math.ceil(Tt),Hr=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(Kt-qt))),wn=Math.min(this.size-this.buffer,ge+Math.ceil($t)),es=Hr+2*this.buffer,ss=wn+2*this.buffer,os=Math.max(es*ss,0),cs=new Uint8ClampedArray(os),Cs={data:cs,width:es,height:ss,glyphWidth:Hr,glyphHeight:wn,glyphTop:ge,glyphLeft:0,glyphAdvance:at};if(0===Hr||0===wn)return Cs;const{ctx:Vs,buffer:Eo,gridInner:Do,gridOuter:Ho}=this;Vs.clearRect(Eo,Eo,Hr,wn),Vs.fillText(rt,Eo,Eo+ge);const Ea=Vs.getImageData(Eo,Eo,Hr,wn);Ho.fill(ds,0,os),Do.fill(0,0,os);for(let rt=0;rt<wn;rt++)for(let at=0;at<Hr;at++){const Tt=Ea.data[4*(rt*Hr+at)+3]/255;if(0===Tt)continue;const $t=(rt+Eo)*es+at+Eo;if(1===Tt)Ho[$t]=0,Do[$t]=ds;else{const rt=.5-Tt;Ho[$t]=rt>0?rt*rt:0,Do[$t]=rt<0?rt*rt:0}}w(Ho,0,0,es,ss,es,this.f,this.v,this.z),w(Do,Eo,Eo,Hr,wn,es,this.f,this.v,this.z);for(let rt=0;rt<os;rt++){const at=Math.sqrt(Ho[rt])-Math.sqrt(Do[rt]);cs[rt]=Math.round(255-255*(at/this.radius+this.cutoff))}return Cs}};class C{constructor(){this.specification=Tt.v.light.position}possiblyEvaluate(rt,at){return Tt.z(rt.expression.evaluate(at))}interpolate(rt,at,$t){return{x:Tt.B.number(rt.x,at.x,$t),y:Tt.B.number(rt.y,at.y,$t),z:Tt.B.number(rt.z,at.z,$t)}}}let Cs;class I extends Tt.E{constructor(rt){super(),Cs=Cs||new Tt.r({anchor:new Tt.D(Tt.v.light.anchor),position:new C,color:new Tt.D(Tt.v.light.color),intensity:new Tt.D(Tt.v.light.intensity)}),this._transitionable=new Tt.T(Cs),this.setLight(rt),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(rt,at={}){if(!this._validate(Tt.t,rt,at))for(const at in rt){const Tt=rt[at];at.endsWith("-transition")?this._transitionable.setTransition(at.slice(0,-11),Tt):this._transitionable.setValue(at,Tt)}}updateTransitions(rt){this._transitioning=this._transitionable.transitioned(rt,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(rt){this.properties=this._transitioning.possiblyEvaluate(rt)}_validate(rt,at,$t){return(!$t||!1!==$t.validate)&&Tt.x(this,rt.call(Tt.y,{value:at,style:{glyphs:!0,sprite:!0},styleSpec:Tt.v}))}}const Vs=new Tt.r({"sky-color":new Tt.D(Tt.v.sky["sky-color"]),"horizon-color":new Tt.D(Tt.v.sky["horizon-color"]),"fog-color":new Tt.D(Tt.v.sky["fog-color"]),"fog-ground-blend":new Tt.D(Tt.v.sky["fog-ground-blend"]),"horizon-fog-blend":new Tt.D(Tt.v.sky["horizon-fog-blend"]),"sky-horizon-blend":new Tt.D(Tt.v.sky["sky-horizon-blend"]),"atmosphere-blend":new Tt.D(Tt.v.sky["atmosphere-blend"])});class S extends Tt.E{constructor(rt){super(),this._transitionable=new Tt.T(Vs),this.setSky(rt),this._transitioning=this._transitionable.untransitioned(),this.recalculate(new Tt.C(0))}setSky(rt,at={}){if(!this._validate(Tt.F,rt,at)){rt||(rt={"sky-color":"transparent","horizon-color":"transparent","fog-color":"transparent","fog-ground-blend":1,"atmosphere-blend":0});for(const at in rt){const Tt=rt[at];at.endsWith("-transition")?this._transitionable.setTransition(at.slice(0,-11),Tt):this._transitionable.setValue(at,Tt)}}}getSky(){return this._transitionable.serialize()}updateTransitions(rt){this._transitioning=this._transitionable.transitioned(rt,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(rt){this.properties=this._transitioning.possiblyEvaluate(rt)}_validate(rt,at,$t={}){return!1!==(null==$t?void 0:$t.validate)&&Tt.x(this,rt.call(Tt.y,Tt.e({value:at,style:{glyphs:!0,sprite:!0},styleSpec:Tt.v})))}calculateFogBlendOpacity(rt){return rt<60?0:rt<70?(rt-60)/10:1}}class R{constructor(rt,at){this.width=rt,this.height=at,this.nextRow=0,this.data=new Uint8Array(this.width*this.height),this.dashEntry={}}getDash(rt,at){const Tt=rt.join(",")+String(at);return this.dashEntry[Tt]||(this.dashEntry[Tt]=this.addDash(rt,at)),this.dashEntry[Tt]}getDashRanges(rt,at,Tt){const $t=[];let qt=rt.length%2==1?-rt[rt.length-1]*Tt:0,Kt=rt[0]*Tt,ge=!0;$t.push({left:qt,right:Kt,isDash:ge,zeroLength:0===rt[0]});let Hr=rt[0];for(let at=1;at<rt.length;at++){ge=!ge;const wn=rt[at];qt=Hr*Tt,Hr+=wn,Kt=Hr*Tt,$t.push({left:qt,right:Kt,isDash:ge,zeroLength:0===wn})}return $t}addRoundDash(rt,at,Tt){const $t=at/2;for(let at=-Tt;at<=Tt;at++){const qt=this.width*(this.nextRow+Tt+at);let Kt=0,ge=rt[Kt];for(let Hr=0;Hr<this.width;Hr++){Hr/ge.right>1&&(ge=rt[++Kt]);const wn=Math.abs(Hr-ge.left),es=Math.abs(Hr-ge.right),ss=Math.min(wn,es);let os;const cs=at/Tt*($t+1);if(ge.isDash){const rt=$t-Math.abs(cs);os=Math.sqrt(ss*ss+rt*rt)}else os=$t-Math.sqrt(ss*ss+cs*cs);this.data[qt+Hr]=Math.max(0,Math.min(255,os+128))}}}addRegularDash(rt){for(let at=rt.length-1;at>=0;--at){const Tt=rt[at],$t=rt[at+1];Tt.zeroLength?rt.splice(at,1):$t&&$t.isDash===Tt.isDash&&($t.left=Tt.left,rt.splice(at,1))}const at=rt[0],Tt=rt[rt.length-1];at.isDash===Tt.isDash&&(at.left=Tt.left-this.width,Tt.right=at.right+this.width);const $t=this.width*this.nextRow;let qt=0,Kt=rt[qt];for(let at=0;at<this.width;at++){at/Kt.right>1&&(Kt=rt[++qt]);const Tt=Math.abs(at-Kt.left),ge=Math.abs(at-Kt.right),Hr=Math.min(Tt,ge);this.data[$t+at]=Math.max(0,Math.min(255,(Kt.isDash?Hr:-Hr)+128))}}addDash(rt,at){const $t=at?7:0,qt=2*$t+1;if(this.nextRow+qt>this.height)return Tt.w("LineAtlas out of space"),null;let Kt=0;for(let at=0;at<rt.length;at++)Kt+=rt[at];if(0!==Kt){const Tt=this.width/Kt,qt=this.getDashRanges(rt,this.width,Tt);at?this.addRoundDash(qt,Tt,$t):this.addRegularDash(qt)}const ge={y:(this.nextRow+$t+.5)/this.height,height:2*$t/this.height,width:Kt};return this.nextRow+=qt,this.dirty=!0,ge}bind(rt){const at=rt.gl;this.texture?(at.bindTexture(at.TEXTURE_2D,this.texture),this.dirty&&(this.dirty=!1,at.texSubImage2D(at.TEXTURE_2D,0,0,0,this.width,this.height,at.ALPHA,at.UNSIGNED_BYTE,this.data))):(this.texture=at.createTexture(),at.bindTexture(at.TEXTURE_2D,this.texture),at.texParameteri(at.TEXTURE_2D,at.TEXTURE_WRAP_S,at.REPEAT),at.texParameteri(at.TEXTURE_2D,at.TEXTURE_WRAP_T,at.REPEAT),at.texParameteri(at.TEXTURE_2D,at.TEXTURE_MIN_FILTER,at.LINEAR),at.texParameteri(at.TEXTURE_2D,at.TEXTURE_MAG_FILTER,at.LINEAR),at.texImage2D(at.TEXTURE_2D,0,at.ALPHA,this.width,this.height,0,at.ALPHA,at.UNSIGNED_BYTE,this.data))}}const Eo="maplibre_preloaded_worker_pool";class z{constructor(){this.active={}}acquire(rt){if(!this.workers)for(this.workers=[];this.workers.length<z.workerCount;)this.workers.push(new Worker(Tt.a.WORKER_URL));return this.active[rt]=!0,this.workers.slice()}release(rt){delete this.active[rt],0===this.numActive()&&(this.workers.forEach((rt=>{rt.terminate()})),this.workers=null)}isPreloaded(){return!!this.active[Eo]}numActive(){return Object.keys(this.active).length}}const Do=Math.floor(ge.hardwareConcurrency/2);let Ho,Ea;function F(){return Ho||(Ho=new z),Ho}z.workerCount=Tt.G(globalThis)?Math.max(Math.min(Do,3),1):1;class B{constructor(rt,at){this.workerPool=rt,this.actors=[],this.currentActor=0,this.id=at;const $t=this.workerPool.acquire(at);for(let rt=0;rt<$t.length;rt++){const qt=new Tt.H($t[rt],at);qt.name=`Worker ${rt}`,this.actors.push(qt)}if(!this.actors.length)throw new Error("No actors found")}broadcast(rt,at){const Tt=[];for(const $t of this.actors)Tt.push($t.sendAsync({type:rt,data:at}));return Promise.all(Tt)}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(rt=!0){this.actors.forEach((rt=>{rt.remove()})),this.actors=[],rt&&this.workerPool.release(this.id)}registerMessageHandler(rt,at){for(const Tt of this.actors)Tt.registerMessageHandler(rt,at)}}function O(){return Ea||(Ea=new B(F(),Tt.J),Ea.registerMessageHandler("GR",((rt,at,$t)=>Tt.m(at,$t)))),Ea}function j(rt,at){const $t=Tt.K();return Tt.L($t,$t,[1,1,0]),Tt.M($t,$t,[.5*rt.width,.5*rt.height,1]),rt.calculatePosMatrix?Tt.N($t,$t,rt.calculatePosMatrix(at.toUnwrapped())):$t}function Z(rt,at,Tt,$t,qt,Kt,ge){var Hr;const wn=function(rt,at,Tt){if(rt)for(const $t of rt){const rt=at[$t];if(rt&&rt.source===Tt&&"fill-extrusion"===rt.type)return!0}else for(const rt in at){const $t=at[rt];if($t.source===Tt&&"fill-extrusion"===$t.type)return!0}return!1}(null!==(Hr=null==qt?void 0:qt.layers)&&void 0!==Hr?Hr:null,at,rt.id),es=Kt.maxPitchScaleFactor(),ss=rt.tilesIn($t,es,wn);ss.sort(N);const os=[];for(const $t of ss)os.push({wrappedTileID:$t.tileID.wrapped().key,queryResults:$t.tile.queryRenderedFeatures(at,Tt,rt._state,$t.queryGeometry,$t.cameraQueryGeometry,$t.scale,qt,Kt,es,j(rt.transform,$t.tileID),ge?(rt,at)=>ge($t.tileID,rt,at):void 0)});return function(rt,at){for(const Tt in rt)for(const $t of rt[Tt])U($t,at);return rt}(function(rt){const at={},Tt={};for(const $t of rt){const rt=$t.queryResults,qt=$t.wrappedTileID,Kt=Tt[qt]=Tt[qt]||{};for(const Tt in rt){const $t=rt[Tt],qt=Kt[Tt]=Kt[Tt]||{},ge=at[Tt]=at[Tt]||[];for(const rt of $t)qt[rt.featureIndex]||(qt[rt.featureIndex]=!0,ge.push(rt))}}return at}(os),rt)}function N(rt,at){const Tt=rt.tileID,$t=at.tileID;return Tt.overscaledZ-$t.overscaledZ||Tt.canonical.y-$t.canonical.y||Tt.wrap-$t.wrap||Tt.canonical.x-$t.canonical.x}function U(rt,at){const Tt=rt.feature,$t=at.getFeatureState(Tt.layer["source-layer"],Tt.id);Tt.source=Tt.layer.source,Tt.layer["source-layer"]&&(Tt.sourceLayer=Tt.layer["source-layer"]),Tt.state=$t}function G(at,$t,qt){return Tt._(this||rt,void 0,void 0,(function*(){let rt=at;if(at.url?rt=(yield Tt.j($t.transformRequest(at.url,"Source"),qt)).data:yield ge.frameAsync(qt),!rt)return null;const Kt=Tt.O(Tt.e(rt,at),["tiles","minzoom","maxzoom","attribution","bounds","scheme","tileSize","encoding"]);return"vector_layers"in rt&&rt.vector_layers&&(Kt.vectorLayerIds=rt.vector_layers.map((rt=>rt.id))),Kt}))}class V{constructor(rt,at){rt&&(at?this.setSouthWest(rt).setNorthEast(at):Array.isArray(rt)&&(4===rt.length?this.setSouthWest([rt[0],rt[1]]).setNorthEast([rt[2],rt[3]]):this.setSouthWest(rt[0]).setNorthEast(rt[1])))}setNorthEast(rt){return this._ne=rt instanceof Tt.Q?new Tt.Q(rt.lng,rt.lat):Tt.Q.convert(rt),this}setSouthWest(rt){return this._sw=rt instanceof Tt.Q?new Tt.Q(rt.lng,rt.lat):Tt.Q.convert(rt),this}extend(rt){const at=this._sw,$t=this._ne;let qt,Kt;if(rt instanceof Tt.Q)qt=rt,Kt=rt;else{if(!(rt instanceof V))return Array.isArray(rt)?4===rt.length||rt.every(Array.isArray)?this.extend(V.convert(rt)):this.extend(Tt.Q.convert(rt)):rt&&("lng"in rt||"lon"in rt)&&"lat"in rt?this.extend(Tt.Q.convert(rt)):this;if(qt=rt._sw,Kt=rt._ne,!qt||!Kt)return this}return at||$t?(at.lng=Math.min(qt.lng,at.lng),at.lat=Math.min(qt.lat,at.lat),$t.lng=Math.max(Kt.lng,$t.lng),$t.lat=Math.max(Kt.lat,$t.lat)):(this._sw=new Tt.Q(qt.lng,qt.lat),this._ne=new Tt.Q(Kt.lng,Kt.lat)),this}getCenter(){return new Tt.Q((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new Tt.Q(this.getWest(),this.getNorth())}getSouthEast(){return new Tt.Q(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(rt){const{lng:at,lat:$t}=Tt.Q.convert(rt);let qt=this._sw.lng<=at&&at<=this._ne.lng;return this._sw.lng>this._ne.lng&&(qt=this._sw.lng>=at&&at>=this._ne.lng),this._sw.lat<=$t&&$t<=this._ne.lat&&qt}static convert(rt){return rt instanceof V?rt:rt?new V(rt):rt}static fromLngLat(rt,at=0){const $t=360*at/40075017,qt=$t/Math.cos(Math.PI/180*rt.lat);return new V(new Tt.Q(rt.lng-qt,rt.lat-$t),new Tt.Q(rt.lng+qt,rt.lat+$t))}adjustAntiMeridian(){const rt=new Tt.Q(this._sw.lng,this._sw.lat),at=new Tt.Q(this._ne.lng,this._ne.lat);return new V(rt,rt.lng>at.lng?new Tt.Q(at.lng+360,at.lat):at)}}class q{constructor(rt,at,Tt){this.bounds=V.convert(this.validateBounds(rt)),this.minzoom=at||0,this.maxzoom=Tt||24}validateBounds(rt){return Array.isArray(rt)&&4===rt.length?[Math.max(-180,rt[0]),Math.max(-90,rt[1]),Math.min(180,rt[2]),Math.min(90,rt[3])]:[-180,-90,180,90]}contains(rt){const at=Math.pow(2,rt.z),$t=Math.floor(Tt.U(this.bounds.getWest())*at),qt=Math.floor(Tt.S(this.bounds.getNorth())*at),Kt=Math.ceil(Tt.U(this.bounds.getEast())*at),ge=Math.ceil(Tt.S(this.bounds.getSouth())*at);return rt.x>=$t&&rt.x<Kt&&rt.y>=qt&&rt.y<ge}}class W extends Tt.E{constructor(rt,at,$t,qt){if(super(),this.id=rt,this.dispatcher=$t,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,Tt.e(this,Tt.O(at,["url","scheme","tileSize","promoteId"])),this._options=Tt.e({type:"vector"},at),this._collectResourceTiming=at.collectResourceTiming,512!==this.tileSize)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(qt)}load(){return Tt._(this,void 0,void 0,(function*(){this._loaded=!1,this.fire(new Tt.l("dataloading",{dataType:"source"})),this._tileJSONRequest=new AbortController;try{const rt=yield G(this._options,this.map._requestManager,this._tileJSONRequest);this._tileJSONRequest=null,this._loaded=!0,this.map.style.sourceCaches[this.id].clearTiles(),rt&&(Tt.e(this,rt),rt.bounds&&(this.tileBounds=new q(rt.bounds,this.minzoom,this.maxzoom)),this.fire(new Tt.l("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new Tt.l("data",{dataType:"source",sourceDataType:"content"})))}catch(rt){this._tileJSONRequest=null,this.fire(new Tt.k(rt))}}))}loaded(){return this._loaded}hasTile(rt){return!this.tileBounds||this.tileBounds.contains(rt.canonical)}onAdd(rt){this.map=rt,this.load()}setSourceProperty(rt){this._tileJSONRequest&&this._tileJSONRequest.abort(),rt(),this.load()}setTiles(rt){return this.setSourceProperty((()=>{this._options.tiles=rt})),this}setUrl(rt){return this.setSourceProperty((()=>{this.url=rt,this._options.url=rt})),this}onRemove(){this._tileJSONRequest&&(this._tileJSONRequest.abort(),this._tileJSONRequest=null)}serialize(){return Tt.e({},this._options)}loadTile(rt){return Tt._(this,void 0,void 0,(function*(){const at=rt.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme),Tt={request:this.map._requestManager.transformRequest(at,"Tile"),uid:rt.uid,tileID:rt.tileID,zoom:rt.tileID.overscaledZ,tileSize:this.tileSize*rt.tileID.overscaleFactor(),type:this.type,source:this.id,pixelRatio:this.map.getPixelRatio(),showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,subdivisionGranularity:this.map.style.projection.subdivisionGranularity};Tt.request.collectResourceTiming=this._collectResourceTiming;let $t="RT";if(rt.actor&&"expired"!==rt.state){if("loading"===rt.state)return new Promise(((at,Tt)=>{rt.reloadPromise={resolve:at,reject:Tt}}))}else rt.actor=this.dispatcher.getActor(),$t="LT";rt.abortController=new AbortController;try{const at=yield rt.actor.sendAsync({type:$t,data:Tt},rt.abortController);if(delete rt.abortController,rt.aborted)return;this._afterTileLoadWorkerResponse(rt,at)}catch(at){if(delete rt.abortController,rt.aborted)return;if(at&&404!==at.status)throw at;this._afterTileLoadWorkerResponse(rt,null)}}))}_afterTileLoadWorkerResponse(rt,at){if(at&&at.resourceTiming&&(rt.resourceTiming=at.resourceTiming),at&&this.map._refreshExpiredTiles&&rt.setExpiryData(at),rt.loadVectorData(at,this.map.painter),rt.reloadPromise){const at=rt.reloadPromise;rt.reloadPromise=null,this.loadTile(rt).then(at.resolve).catch(at.reject)}}abortTile(rt){return Tt._(this,void 0,void 0,(function*(){rt.abortController&&(rt.abortController.abort(),delete rt.abortController),rt.actor&&(yield rt.actor.sendAsync({type:"AT",data:{uid:rt.uid,type:this.type,source:this.id}}))}))}unloadTile(rt){return Tt._(this,void 0,void 0,(function*(){rt.unloadVectorData(),rt.actor&&(yield rt.actor.sendAsync({type:"RMT",data:{uid:rt.uid,type:this.type,source:this.id}}))}))}hasTransition(){return!1}}class H extends Tt.E{constructor(rt,at,$t,qt){super(),this.id=rt,this.dispatcher=$t,this.setEventedParent(qt),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=Tt.e({type:"raster"},at),Tt.e(this,Tt.O(at,["url","scheme","tileSize"]))}load(){return Tt._(this,arguments,void 0,(function*(rt=!1){this._loaded=!1,this.fire(new Tt.l("dataloading",{dataType:"source"})),this._tileJSONRequest=new AbortController;try{const at=yield G(this._options,this.map._requestManager,this._tileJSONRequest);this._tileJSONRequest=null,this._loaded=!0,at&&(Tt.e(this,at),at.bounds&&(this.tileBounds=new q(at.bounds,this.minzoom,this.maxzoom)),this.fire(new Tt.l("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new Tt.l("data",{dataType:"source",sourceDataType:"content",sourceDataChanged:rt})))}catch(rt){this._tileJSONRequest=null,this.fire(new Tt.k(rt))}}))}loaded(){return this._loaded}onAdd(rt){this.map=rt,this.load()}onRemove(){this._tileJSONRequest&&(this._tileJSONRequest.abort(),this._tileJSONRequest=null)}setSourceProperty(rt){this._tileJSONRequest&&(this._tileJSONRequest.abort(),this._tileJSONRequest=null),rt(),this.load(!0)}setTiles(rt){return this.setSourceProperty((()=>{this._options.tiles=rt})),this}setUrl(rt){return this.setSourceProperty((()=>{this.url=rt,this._options.url=rt})),this}serialize(){return Tt.e({},this._options)}hasTile(rt){return!this.tileBounds||this.tileBounds.contains(rt.canonical)}loadTile(rt){return Tt._(this,void 0,void 0,(function*(){const at=rt.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme);rt.abortController=new AbortController;try{const Tt=yield cs.getImage(this.map._requestManager.transformRequest(at,"Tile"),rt.abortController,this.map._refreshExpiredTiles);if(delete rt.abortController,rt.aborted)return void(rt.state="unloaded");if(Tt&&Tt.data){this.map._refreshExpiredTiles&&Tt.cacheControl&&Tt.expires&&rt.setExpiryData({cacheControl:Tt.cacheControl,expires:Tt.expires});const at=this.map.painter.context,$t=at.gl,qt=Tt.data;rt.texture=this.map.painter.getTileTexture(qt.width),rt.texture?rt.texture.update(qt,{useMipmap:!0}):(rt.texture=new v(at,qt,$t.RGBA,{useMipmap:!0}),rt.texture.bind($t.LINEAR,$t.CLAMP_TO_EDGE,$t.LINEAR_MIPMAP_NEAREST)),rt.state="loaded"}}catch(at){if(delete rt.abortController,rt.aborted)rt.state="unloaded";else if(at)throw rt.state="errored",at}}))}abortTile(rt){return Tt._(this,void 0,void 0,(function*(){rt.abortController&&(rt.abortController.abort(),delete rt.abortController)}))}unloadTile(rt){return Tt._(this,void 0,void 0,(function*(){rt.texture&&this.map.painter.saveTileTexture(rt.texture)}))}hasTransition(){return!1}}class $ extends H{constructor(rt,at,$t,qt){super(rt,at,$t,qt),this.type="raster-dem",this.maxzoom=22,this._options=Tt.e({type:"raster-dem"},at),this.encoding=at.encoding||"mapbox",this.redFactor=at.redFactor,this.greenFactor=at.greenFactor,this.blueFactor=at.blueFactor,this.baseShift=at.baseShift}loadTile(rt){return Tt._(this,void 0,void 0,(function*(){const at=rt.tileID.canonical.url(this.tiles,this.map.getPixelRatio(),this.scheme),$t=this.map._requestManager.transformRequest(at,"Tile");rt.neighboringTiles=this._getNeighboringTiles(rt.tileID),rt.abortController=new AbortController;try{const at=yield cs.getImage($t,rt.abortController,this.map._refreshExpiredTiles);if(delete rt.abortController,rt.aborted)return void(rt.state="unloaded");if(at&&at.data){const $t=at.data;this.map._refreshExpiredTiles&&at.cacheControl&&at.expires&&rt.setExpiryData({cacheControl:at.cacheControl,expires:at.expires});const qt=Tt.b($t)&&Tt.V()?$t:yield this.readImageNow($t),Kt={type:this.type,uid:rt.uid,source:this.id,rawImageData:qt,encoding:this.encoding,redFactor:this.redFactor,greenFactor:this.greenFactor,blueFactor:this.blueFactor,baseShift:this.baseShift};if(!rt.actor||"expired"===rt.state){rt.actor=this.dispatcher.getActor();const at=yield rt.actor.sendAsync({type:"LDT",data:Kt});rt.dem=at,rt.needsHillshadePrepare=!0,rt.needsTerrainPrepare=!0,rt.state="loaded"}}}catch(at){if(delete rt.abortController,rt.aborted)rt.state="unloaded";else if(at)throw rt.state="errored",at}}))}readImageNow(rt){return Tt._(this,void 0,void 0,(function*(){if("undefined"!=typeof VideoFrame&&Tt.W()){const at=rt.width+2,$t=rt.height+2;try{return new Tt.R({width:at,height:$t},yield Tt.X(rt,-1,-1,at,$t))}catch(rt){}}return ge.getImageData(rt,1)}))}_getNeighboringTiles(rt){const at=rt.canonical,$t=Math.pow(2,at.z),qt=(at.x-1+$t)%$t,Kt=0===at.x?rt.wrap-1:rt.wrap,ge=(at.x+1+$t)%$t,Hr=at.x+1===$t?rt.wrap+1:rt.wrap,wn={};return wn[new Tt.Y(rt.overscaledZ,Kt,at.z,qt,at.y).key]={backfilled:!1},wn[new Tt.Y(rt.overscaledZ,Hr,at.z,ge,at.y).key]={backfilled:!1},at.y>0&&(wn[new Tt.Y(rt.overscaledZ,Kt,at.z,qt,at.y-1).key]={backfilled:!1},wn[new Tt.Y(rt.overscaledZ,rt.wrap,at.z,at.x,at.y-1).key]={backfilled:!1},wn[new Tt.Y(rt.overscaledZ,Hr,at.z,ge,at.y-1).key]={backfilled:!1}),at.y+1<$t&&(wn[new Tt.Y(rt.overscaledZ,Kt,at.z,qt,at.y+1).key]={backfilled:!1},wn[new Tt.Y(rt.overscaledZ,rt.wrap,at.z,at.x,at.y+1).key]={backfilled:!1},wn[new Tt.Y(rt.overscaledZ,Hr,at.z,ge,at.y+1).key]={backfilled:!1}),wn}unloadTile(rt){return Tt._(this,void 0,void 0,(function*(){rt.demTexture&&this.map.painter.saveTileTexture(rt.demTexture),rt.fbo&&(rt.fbo.destroy(),delete rt.fbo),rt.dem&&delete rt.dem,delete rt.neighboringTiles,rt.state="unloaded",rt.actor&&(yield rt.actor.sendAsync({type:"RDT",data:{type:this.type,uid:rt.uid,source:this.id}}))}))}}class X extends Tt.E{constructor(rt,at,$t,qt){super(),this.id=rt,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._removed=!1,this._pendingLoads=0,this.actor=$t.getActor(),this.setEventedParent(qt),this._data=at.data,this._options=Tt.e({},at),this._collectResourceTiming=at.collectResourceTiming,void 0!==at.maxzoom&&(this.maxzoom=at.maxzoom),at.type&&(this.type=at.type),at.attribution&&(this.attribution=at.attribution),this.promoteId=at.promoteId,void 0!==at.clusterMaxZoom&&this.maxzoom<=at.clusterMaxZoom&&Tt.w(`The maxzoom value "${this.maxzoom}" is expected to be greater than the clusterMaxZoom value "${at.clusterMaxZoom}".`),this.workerOptions=Tt.e({source:this.id,cluster:at.cluster||!1,geojsonVtOptions:{buffer:this._pixelsToTileUnits(void 0!==at.buffer?at.buffer:128),tolerance:this._pixelsToTileUnits(void 0!==at.tolerance?at.tolerance:.375),extent:Tt.Z,maxZoom:this.maxzoom,lineMetrics:at.lineMetrics||!1,generateId:at.generateId||!1},superclusterOptions:{maxZoom:void 0!==at.clusterMaxZoom?at.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,at.clusterMinPoints||2),extent:Tt.Z,radius:this._pixelsToTileUnits(at.clusterRadius||50),log:!1,generateId:at.generateId||!1},clusterProperties:at.clusterProperties,filter:at.filter},at.workerOptions),"string"==typeof this.promoteId&&(this.workerOptions.promoteId=this.promoteId)}_pixelsToTileUnits(rt){return rt*(Tt.Z/this.tileSize)}load(){return Tt._(this,void 0,void 0,(function*(){yield this._updateWorkerData()}))}onAdd(rt){this.map=rt,this.load()}setData(rt){return this._data=rt,this._updateWorkerData(),this}updateData(rt){return this._updateWorkerData(rt),this}getData(){return Tt._(this,void 0,void 0,(function*(){const rt=Tt.e({type:this.type},this.workerOptions);return this.actor.sendAsync({type:"GD",data:rt})}))}getCoordinatesFromGeometry(rt){return"GeometryCollection"===rt.type?rt.geometries.map((rt=>rt.coordinates)).flat(1/0):rt.coordinates.flat(1/0)}getBounds(){return Tt._(this,void 0,void 0,(function*(){const rt=new V,at=yield this.getData();let Tt;switch(at.type){case"FeatureCollection":Tt=at.features.map((rt=>this.getCoordinatesFromGeometry(rt.geometry))).flat(1/0);break;case"Feature":Tt=this.getCoordinatesFromGeometry(at.geometry);break;default:Tt=this.getCoordinatesFromGeometry(at)}if(0==Tt.length)return rt;for(let at=0;at<Tt.length-1;at+=2)rt.extend([Tt[at],Tt[at+1]]);return rt}))}setClusterOptions(rt){return this.workerOptions.cluster=rt.cluster,rt&&(void 0!==rt.clusterRadius&&(this.workerOptions.superclusterOptions.radius=this._pixelsToTileUnits(rt.clusterRadius)),void 0!==rt.clusterMaxZoom&&(this.workerOptions.superclusterOptions.maxZoom=rt.clusterMaxZoom)),this._updateWorkerData(),this}getClusterExpansionZoom(rt){return this.actor.sendAsync({type:"GCEZ",data:{type:this.type,clusterId:rt,source:this.id}})}getClusterChildren(rt){return this.actor.sendAsync({type:"GCC",data:{type:this.type,clusterId:rt,source:this.id}})}getClusterLeaves(rt,at,Tt){return this.actor.sendAsync({type:"GCL",data:{type:this.type,source:this.id,clusterId:rt,limit:at,offset:Tt}})}_updateWorkerData(rt){return Tt._(this,void 0,void 0,(function*(){const at=Tt.e({type:this.type},this.workerOptions);rt?at.dataDiff=rt:"string"==typeof this._data?(at.request=this.map._requestManager.transformRequest(ge.resolveURL(this._data),"Source"),at.request.collectResourceTiming=this._collectResourceTiming):at.data=JSON.stringify(this._data),this._pendingLoads++,this.fire(new Tt.l("dataloading",{dataType:"source"}));try{const rt=yield this.actor.sendAsync({type:"LD",data:at});if(this._pendingLoads--,this._removed||rt.abandoned)return void this.fire(new Tt.l("dataabort",{dataType:"source"}));let $t=null;rt.resourceTiming&&rt.resourceTiming[this.id]&&($t=rt.resourceTiming[this.id].slice(0));const qt={dataType:"source"};this._collectResourceTiming&&$t&&$t.length>0&&Tt.e(qt,{resourceTiming:$t}),this.fire(new Tt.l("data",Object.assign(Object.assign({},qt),{sourceDataType:"metadata"}))),this.fire(new Tt.l("data",Object.assign(Object.assign({},qt),{sourceDataType:"content"})))}catch(rt){if(this._pendingLoads--,this._removed)return void this.fire(new Tt.l("dataabort",{dataType:"source"}));this.fire(new Tt.k(rt))}}))}loaded(){return 0===this._pendingLoads}loadTile(rt){return Tt._(this,void 0,void 0,(function*(){const at=rt.actor?"RT":"LT";rt.actor=this.actor;const Tt={type:this.type,uid:rt.uid,tileID:rt.tileID,zoom:rt.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,pixelRatio:this.map.getPixelRatio(),showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,subdivisionGranularity:this.map.style.projection.subdivisionGranularity};rt.abortController=new AbortController;const $t=yield this.actor.sendAsync({type:at,data:Tt},rt.abortController);delete rt.abortController,rt.unloadVectorData(),rt.aborted||rt.loadVectorData($t,this.map.painter,"RT"===at)}))}abortTile(rt){return Tt._(this,void 0,void 0,(function*(){rt.abortController&&(rt.abortController.abort(),delete rt.abortController),rt.aborted=!0}))}unloadTile(rt){return Tt._(this,void 0,void 0,(function*(){rt.unloadVectorData(),yield this.actor.sendAsync({type:"RMT",data:{uid:rt.uid,type:this.type,source:this.id}})}))}onRemove(){this._removed=!0,this.actor.sendAsync({type:"RS",data:{type:this.type,source:this.id}})}serialize(){return Tt.e({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}}class K extends Tt.E{constructor(rt,at,Tt,$t){super(),this.flippedWindingOrder=!1,this.id=rt,this.dispatcher=Tt,this.coordinates=at.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.setEventedParent($t),this.options=at}load(rt){return Tt._(this,void 0,void 0,(function*(){this._loaded=!1,this.fire(new Tt.l("dataloading",{dataType:"source"})),this.url=this.options.url,this._request=new AbortController;try{const at=yield cs.getImage(this.map._requestManager.transformRequest(this.url,"Image"),this._request);this._request=null,this._loaded=!0,at&&at.data&&(this.image=at.data,rt&&(this.coordinates=rt),this._finishLoading())}catch(rt){this._request=null,this._loaded=!0,this.fire(new Tt.k(rt))}}))}loaded(){return this._loaded}updateImage(rt){return rt.url?(this._request&&(this._request.abort(),this._request=null),this.options.url=rt.url,this.load(rt.coordinates).finally((()=>{this.texture=null})),this):this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new Tt.l("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(rt){this.map=rt,this.load()}onRemove(){this._request&&(this._request.abort(),this._request=null)}setCoordinates(rt){this.coordinates=rt;const at=rt.map(Tt.$.fromLngLat);var $t;return this.tileID=function(rt){let at=1/0,$t=1/0,qt=-1/0,Kt=-1/0;for(const Tt of rt)at=Math.min(at,Tt.x),$t=Math.min($t,Tt.y),qt=Math.max(qt,Tt.x),Kt=Math.max(Kt,Tt.y);const ge=Math.max(qt-at,Kt-$t),Hr=Math.max(0,Math.floor(-Math.log(ge)/Math.LN2)),wn=Math.pow(2,Hr);return new Tt.a1(Hr,Math.floor((at+qt)/2*wn),Math.floor(($t+Kt)/2*wn))}(at),this.terrainTileRanges=this._getOverlappingTileRanges(at),this.minzoom=this.maxzoom=this.tileID.z,this.tileCoords=at.map((rt=>this.tileID.getTilePoint(rt)._round())),this.flippedWindingOrder=(($t=this.tileCoords)[1].x-$t[0].x)*($t[2].y-$t[0].y)-($t[1].y-$t[0].y)*($t[2].x-$t[0].x)<0,this.fire(new Tt.l("data",{dataType:"source",sourceDataType:"content"})),this}prepare(){if(0===Object.keys(this.tiles).length||!this.image)return;const rt=this.map.painter.context,at=rt.gl;this.texture||(this.texture=new v(rt,this.image,at.RGBA),this.texture.bind(at.LINEAR,at.CLAMP_TO_EDGE));let $t=!1;for(const rt in this.tiles){const at=this.tiles[rt];"loaded"!==at.state&&(at.state="loaded",at.texture=this.texture,$t=!0)}$t&&this.fire(new Tt.l("data",{dataType:"source",sourceDataType:"idle",sourceId:this.id}))}loadTile(rt){return Tt._(this,void 0,void 0,(function*(){this.tileID&&this.tileID.equals(rt.tileID.canonical)?(this.tiles[String(rt.tileID.wrap)]=rt,rt.buckets={}):rt.state="errored"}))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}_getOverlappingTileRanges(rt){let at=1/0,$t=1/0,qt=-1/0,Kt=-1/0;for(const Tt of rt)at=Math.min(at,Tt.x),$t=Math.min($t,Tt.y),qt=Math.max(qt,Tt.x),Kt=Math.max(Kt,Tt.y);const ge={};for(let rt=0;rt<=Tt.a0;rt++){const Tt=Math.pow(2,rt),Hr=Math.floor(at*Tt),wn=Math.floor($t*Tt),es=Math.floor(qt*Tt),ss=Math.floor(Kt*Tt);ge[rt]={minTileX:Hr,minTileY:wn,maxTileX:es,maxTileY:ss}}return ge}}class Q extends K{constructor(rt,at,Tt,$t){super(rt,at,Tt,$t),this.roundZoom=!0,this.type="video",this.options=at}load(){return Tt._(this,void 0,void 0,(function*(){this._loaded=!1;const rt=this.options;this.urls=[];for(const at of rt.urls)this.urls.push(this.map._requestManager.transformRequest(at,"Source").url);try{const rt=yield Tt.a2(this.urls);if(this._loaded=!0,!rt)return;this.video=rt,this.video.loop=!0,this.video.addEventListener("playing",(()=>{this.map.triggerRepaint()})),this.map&&this.video.play(),this._finishLoading()}catch(rt){this.fire(new Tt.k(rt))}}))}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(rt){if(this.video){const at=this.video.seekable;rt<at.start(0)||rt>at.end(0)?this.fire(new Tt.k(new Tt.a3(`sources.${this.id}`,null,`Playback for this video can be set only between the ${at.start(0)} and ${at.end(0)}-second mark.`))):this.video.currentTime=rt}}getVideo(){return this.video}onAdd(rt){this.map||(this.map=rt,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(0===Object.keys(this.tiles).length||this.video.readyState<2)return;const rt=this.map.painter.context,at=rt.gl;this.texture?this.video.paused||(this.texture.bind(at.LINEAR,at.CLAMP_TO_EDGE),at.texSubImage2D(at.TEXTURE_2D,0,0,0,at.RGBA,at.UNSIGNED_BYTE,this.video)):(this.texture=new v(rt,this.video,at.RGBA),this.texture.bind(at.LINEAR,at.CLAMP_TO_EDGE));let $t=!1;for(const rt in this.tiles){const at=this.tiles[rt];"loaded"!==at.state&&(at.state="loaded",at.texture=this.texture,$t=!0)}$t&&this.fire(new Tt.l("data",{dataType:"source",sourceDataType:"idle",sourceId:this.id}))}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}}class Y extends K{constructor(rt,at,$t,qt){super(rt,at,$t,qt),at.coordinates?Array.isArray(at.coordinates)&&4===at.coordinates.length&&!at.coordinates.some((rt=>!Array.isArray(rt)||2!==rt.length||rt.some((rt=>"number"!=typeof rt))))||this.fire(new Tt.k(new Tt.a3(`sources.${rt}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new Tt.k(new Tt.a3(`sources.${rt}`,null,'missing required property "coordinates"'))),at.animate&&"boolean"!=typeof at.animate&&this.fire(new Tt.k(new Tt.a3(`sources.${rt}`,null,'optional "animate" property must be a boolean value'))),at.canvas?"string"==typeof at.canvas||at.canvas instanceof HTMLCanvasElement||this.fire(new Tt.k(new Tt.a3(`sources.${rt}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new Tt.k(new Tt.a3(`sources.${rt}`,null,'missing required property "canvas"'))),this.options=at,this.animate=void 0===at.animate||at.animate}load(){return Tt._(this,void 0,void 0,(function*(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new Tt.k(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}))}getCanvas(){return this.canvas}onAdd(rt){this.map=rt,this.load(),this.canvas&&this.animate&&this.play()}onRemove(){this.pause()}prepare(){let rt=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,rt=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,rt=!0),this._hasInvalidDimensions())return;if(0===Object.keys(this.tiles).length)return;const at=this.map.painter.context,$t=at.gl;this.texture?(rt||this._playing)&&this.texture.update(this.canvas,{premultiply:!0}):this.texture=new v(at,this.canvas,$t.RGBA,{premultiply:!0});let qt=!1;for(const rt in this.tiles){const at=this.tiles[rt];"loaded"!==at.state&&(at.state="loaded",at.texture=this.texture,qt=!0)}qt&&this.fire(new Tt.l("data",{dataType:"source",sourceDataType:"idle",sourceId:this.id}))}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const rt of[this.canvas.width,this.canvas.height])if(isNaN(rt)||rt<=0)return!0;return!1}}const La={},ee=rt=>{switch(rt){case"geojson":return X;case"image":return K;case"raster":return H;case"raster-dem":return $;case"vector":return W;case"video":return Q;case"canvas":return Y}return La[rt]},ja="RTLPluginLoaded";class ie extends Tt.E{constructor(){super(...arguments),this.status="unavailable",this.url=null,this.dispatcher=O()}_syncState(rt){return this.status=rt,this.dispatcher.broadcast("SRPS",{pluginStatus:rt,pluginURL:this.url}).catch((rt=>{throw this.status="error",rt}))}getRTLTextPluginStatus(){return this.status}clearRTLTextPlugin(){this.status="unavailable",this.url=null}setRTLTextPlugin(rt){return Tt._(this,arguments,void 0,(function*(rt,at=!1){if(this.url)throw new Error("setRTLTextPlugin cannot be called multiple times.");if(this.url=ge.resolveURL(rt),!this.url)throw new Error(`requested url ${rt} is invalid`);if("unavailable"===this.status){if(!at)return this._requestImport();this.status="deferred",this._syncState(this.status)}else if("requested"===this.status)return this._requestImport()}))}_requestImport(){return Tt._(this,void 0,void 0,(function*(){yield this._syncState("loading"),this.status="loaded",this.fire(new Tt.l(ja))}))}lazyLoad(){"unavailable"===this.status?this.status="requested":"deferred"===this.status&&this._requestImport()}}let Va=null;function oe(){return Va||(Va=new ie),Va}class ae{constructor(rt,at){this.timeAdded=0,this.fadeEndTime=0,this.tileID=rt,this.uid=Tt.a4(),this.uses=0,this.tileSize=at,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.rtt=[],this.rttCoords={},this.expiredRequestCount=0,this.state="loading"}registerFadeDuration(rt){const at=rt+this.timeAdded;at<this.fadeEndTime||(this.fadeEndTime=at)}wasRequested(){return"errored"===this.state||"loaded"===this.state||"reloading"===this.state}clearTextures(rt){this.demTexture&&rt.saveTileTexture(this.demTexture),this.demTexture=null}loadVectorData(rt,at,$t){if(this.hasData()&&this.unloadVectorData(),this.state="loaded",rt){rt.featureIndex&&(this.latestFeatureIndex=rt.featureIndex,rt.rawTileData?(this.latestRawTileData=rt.rawTileData,this.latestFeatureIndex.rawTileData=rt.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=rt.collisionBoxArray,this.buckets=function(rt,at){const Tt={};if(!at)return Tt;for(const $t of rt){const rt=$t.layerIds.map((rt=>at.getLayer(rt))).filter(Boolean);if(0!==rt.length){$t.layers=rt,$t.stateDependentLayerIds&&($t.stateDependentLayers=$t.stateDependentLayerIds.map((at=>rt.filter((rt=>rt.id===at))[0])));for(const at of rt)Tt[at.id]=$t}}return Tt}(rt.buckets,null==at?void 0:at.style),this.hasSymbolBuckets=!1;for(const rt in this.buckets){const at=this.buckets[rt];if(at instanceof Tt.a6){if(this.hasSymbolBuckets=!0,!$t)break;at.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const rt in this.buckets){const at=this.buckets[rt];if(at instanceof Tt.a6&&at.hasRTLText){this.hasRTLText=!0,oe().lazyLoad();break}}this.queryPadding=0;for(const rt in this.buckets){const Tt=this.buckets[rt];this.queryPadding=Math.max(this.queryPadding,at.style.getLayer(rt).queryRadius(Tt))}rt.imageAtlas&&(this.imageAtlas=rt.imageAtlas),rt.glyphAtlasImage&&(this.glyphAtlasImage=rt.glyphAtlasImage)}else this.collisionBoxArray=new Tt.a5}unloadVectorData(){for(const rt in this.buckets)this.buckets[rt].destroy();this.buckets={},this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.imageAtlas&&(this.imageAtlas=null),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.latestFeatureIndex=null,this.state="unloaded"}getBucket(rt){return this.buckets[rt.id]}upload(rt){for(const at in this.buckets){const Tt=this.buckets[at];Tt.uploadPending()&&Tt.upload(rt)}const at=rt.gl;this.imageAtlas&&!this.imageAtlas.uploaded&&(this.imageAtlasTexture=new v(rt,this.imageAtlas.image,at.RGBA),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new v(rt,this.glyphAtlasImage,at.ALPHA),this.glyphAtlasImage=null)}prepare(rt){this.imageAtlas&&this.imageAtlas.patchUpdatedImages(rt,this.imageAtlasTexture)}queryRenderedFeatures(rt,at,Tt,$t,qt,Kt,ge,Hr,wn,es,ss){return this.latestFeatureIndex&&this.latestFeatureIndex.rawTileData?this.latestFeatureIndex.query({queryGeometry:$t,cameraQueryGeometry:qt,scale:Kt,tileSize:this.tileSize,pixelPosMatrix:es,transform:Hr,params:ge,queryPadding:this.queryPadding*wn,getElevation:ss},rt,at,Tt):{}}querySourceFeatures(rt,at){const $t=this.latestFeatureIndex;if(!$t||!$t.rawTileData)return;const qt=$t.loadVTLayers(),Kt=at&&at.sourceLayer?at.sourceLayer:"",ge=qt._geojsonTileLayer||qt[Kt];if(!ge)return;const Hr=Tt.a7(at&&at.filter),{z:wn,x:es,y:ss}=this.tileID.canonical,os={z:wn,x:es,y:ss};for(let at=0;at<ge.length;at++){const qt=ge.feature(at);if(Hr.needGeometry){const rt=Tt.a8(qt,!0);if(!Hr.filter(new Tt.C(this.tileID.overscaledZ),rt,this.tileID.canonical))continue}else if(!Hr.filter(new Tt.C(this.tileID.overscaledZ),qt))continue;const cs=$t.getId(qt,Kt),ds=new Tt.a9(qt,wn,es,ss,cs);ds.tile=os,rt.push(ds)}}hasData(){return"loaded"===this.state||"reloading"===this.state||"expired"===this.state}patternsLoaded(){return this.imageAtlas&&!!Object.keys(this.imageAtlas.patternPositions).length}setExpiryData(rt){const at=this.expirationTime;if(rt.cacheControl){const at=Tt.aa(rt.cacheControl);at["max-age"]&&(this.expirationTime=Date.now()+1e3*at["max-age"])}else rt.expires&&(this.expirationTime=new Date(rt.expires).getTime());if(this.expirationTime){const rt=Date.now();let Tt=!1;if(this.expirationTime>rt)Tt=!1;else if(at)if(this.expirationTime<at)Tt=!0;else{const $t=this.expirationTime-at;$t?this.expirationTime=rt+Math.max($t,3e4):Tt=!0}else Tt=!0;Tt?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-(new Date).getTime(),Math.pow(2,31)-1)}setFeatureState(rt,at){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData||0===Object.keys(rt).length)return;const Tt=this.latestFeatureIndex.loadVTLayers();for(const $t in this.buckets){if(!at.style.hasLayer($t))continue;const qt=this.buckets[$t],Kt=qt.layers[0].sourceLayer||"_geojsonTileLayer",ge=Tt[Kt],Hr=rt[Kt];if(!ge||!Hr||0===Object.keys(Hr).length)continue;qt.update(Hr,ge,this.imageAtlas&&this.imageAtlas.patternPositions||{});const wn=at&&at.style&&at.style.getLayer($t);wn&&(this.queryPadding=Math.max(this.queryPadding,wn.queryRadius(qt)))}}holdingForFade(){return void 0!==this.symbolFadeHoldUntil}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<ge.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(rt){this.symbolFadeHoldUntil=ge.now()+rt}setDependencies(rt,at){const Tt={};for(const rt of at)Tt[rt]=!0;this.dependencies[rt]=Tt}hasDependency(rt,at){for(const Tt of rt){const rt=this.dependencies[Tt];if(rt)for(const Tt of at)if(rt[Tt])return!0}return!1}}class se{constructor(rt,at){this.max=rt,this.onRemove=at,this.reset()}reset(){for(const rt in this.data)for(const at of this.data[rt])at.timeout&&clearTimeout(at.timeout),this.onRemove(at.value);return this.data={},this.order=[],this}add(rt,at,Tt){const $t=rt.wrapped().key;void 0===this.data[$t]&&(this.data[$t]=[]);const qt={value:at,timeout:void 0};if(void 0!==Tt&&(qt.timeout=setTimeout((()=>{this.remove(rt,qt)}),Tt)),this.data[$t].push(qt),this.order.push($t),this.order.length>this.max){const rt=this._getAndRemoveByKey(this.order[0]);rt&&this.onRemove(rt)}return this}has(rt){return rt.wrapped().key in this.data}getAndRemove(rt){return this.has(rt)?this._getAndRemoveByKey(rt.wrapped().key):null}_getAndRemoveByKey(rt){const at=this.data[rt].shift();return at.timeout&&clearTimeout(at.timeout),0===this.data[rt].length&&delete this.data[rt],this.order.splice(this.order.indexOf(rt),1),at.value}getByKey(rt){const at=this.data[rt];return at?at[0].value:null}get(rt){return this.has(rt)?this.data[rt.wrapped().key][0].value:null}remove(rt,at){if(!this.has(rt))return this;const Tt=rt.wrapped().key,$t=void 0===at?0:this.data[Tt].indexOf(at),qt=this.data[Tt][$t];return this.data[Tt].splice($t,1),qt.timeout&&clearTimeout(qt.timeout),0===this.data[Tt].length&&delete this.data[Tt],this.onRemove(qt.value),this.order.splice(this.order.indexOf(Tt),1),this}setMaxSize(rt){for(this.max=rt;this.order.length>this.max;){const rt=this._getAndRemoveByKey(this.order[0]);rt&&this.onRemove(rt)}return this}filter(rt){const at=[];for(const Tt in this.data)for(const $t of this.data[Tt])rt($t.value)||at.push($t);for(const rt of at)this.remove(rt.value.tileID,rt)}}class ne{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(rt,at,$t){const qt=String(at);if(this.stateChanges[rt]=this.stateChanges[rt]||{},this.stateChanges[rt][qt]=this.stateChanges[rt][qt]||{},Tt.e(this.stateChanges[rt][qt],$t),null===this.deletedStates[rt]){this.deletedStates[rt]={};for(const at in this.state[rt])at!==qt&&(this.deletedStates[rt][at]=null)}else if(this.deletedStates[rt]&&null===this.deletedStates[rt][qt]){this.deletedStates[rt][qt]={};for(const at in this.state[rt][qt])$t[at]||(this.deletedStates[rt][qt][at]=null)}else for(const at in $t)this.deletedStates[rt]&&this.deletedStates[rt][qt]&&null===this.deletedStates[rt][qt][at]&&delete this.deletedStates[rt][qt][at]}removeFeatureState(rt,at,Tt){if(null===this.deletedStates[rt])return;const $t=String(at);if(this.deletedStates[rt]=this.deletedStates[rt]||{},Tt&&void 0!==at)null!==this.deletedStates[rt][$t]&&(this.deletedStates[rt][$t]=this.deletedStates[rt][$t]||{},this.deletedStates[rt][$t][Tt]=null);else if(void 0!==at)if(this.stateChanges[rt]&&this.stateChanges[rt][$t])for(Tt in this.deletedStates[rt][$t]={},this.stateChanges[rt][$t])this.deletedStates[rt][$t][Tt]=null;else this.deletedStates[rt][$t]=null;else this.deletedStates[rt]=null}getState(rt,at){const $t=String(at),qt=Tt.e({},(this.state[rt]||{})[$t],(this.stateChanges[rt]||{})[$t]);if(null===this.deletedStates[rt])return{};if(this.deletedStates[rt]){const Tt=this.deletedStates[rt][at];if(null===Tt)return{};for(const rt in Tt)delete qt[rt]}return qt}initializeTileState(rt,at){rt.setFeatureState(this.state,at)}coalesceChanges(rt,at){const $t={};for(const rt in this.stateChanges){this.state[rt]=this.state[rt]||{};const at={};for(const $t in this.stateChanges[rt])this.state[rt][$t]||(this.state[rt][$t]={}),Tt.e(this.state[rt][$t],this.stateChanges[rt][$t]),at[$t]=this.state[rt][$t];$t[rt]=at}for(const rt in this.deletedStates){this.state[rt]=this.state[rt]||{};const at={};if(null===this.deletedStates[rt])for(const Tt in this.state[rt])at[Tt]={},this.state[rt][Tt]={};else for(const Tt in this.deletedStates[rt]){if(null===this.deletedStates[rt][Tt])this.state[rt][Tt]={};else for(const at of Object.keys(this.deletedStates[rt][Tt]))delete this.state[rt][Tt][at];at[Tt]=this.state[rt][Tt]}$t[rt]=$t[rt]||{},Tt.e($t[rt],at)}if(this.stateChanges={},this.deletedStates={},0!==Object.keys($t).length)for(const Tt in rt)rt[Tt].setFeatureState($t,at)}}const Na=89.25;function ce(rt,at){const $t=Tt.ae(at.lat,-85.051129,Tt.af);return new Tt.P(Tt.U(at.lng)*rt,Tt.S($t)*rt)}function he(rt,at){return new Tt.$(at.x/rt,at.y/rt).toLngLat()}function ue(rt){return rt.cameraToCenterDistance*Math.min(.85*Math.tan(Tt.ab(90-rt.pitch)),Math.tan(Tt.ab(Na-rt.pitch)))}function de(rt,at){const $t=rt.canonical,qt=at/Tt.ac($t.z),Kt=$t.x+Math.pow(2,$t.z)*rt.wrap,ge=Tt.ad(new Float64Array(16));return Tt.L(ge,ge,[Kt*qt,$t.y*qt,0]),Tt.M(ge,ge,[qt/Tt.Z,qt/Tt.Z,1]),ge}function _e(rt,at,$t,qt,Kt){const ge=Tt.$.fromLngLat(rt,at),Hr=Kt*Tt.ag(1,rt.lat),wn=Hr*Math.cos(Tt.ab($t)),es=Math.sqrt(Hr*Hr-wn*wn),ss=es*Math.sin(Tt.ab(-qt)),os=es*Math.cos(Tt.ab(-qt));return new Tt.$(ge.x+ss,ge.y+os,ge.z+wn)}function pe(rt,at,Tt){const $t=at.intersectsFrustum(rt);if(!Tt)return $t;const qt=at.intersectsPlane(Tt);return 0===$t||0===qt?0:2===$t&&2===qt?2:1}function me(rt,at,Tt){let $t=0;const qt=(Tt-at)/10;for(let Kt=0;Kt<10;Kt++)$t+=qt*Math.pow(Math.cos(at+(Kt+.5)/10*(Tt-at)),rt);return $t}function fe(rt,at){return function($t,qt,Kt,ge,Hr){const wn=2*((rt-1)/Tt.ah(Math.cos(Tt.ab(Na-Hr))/Math.cos(Tt.ab(Na)))-1),es=Math.acos(Kt/ge),ss=2*me(wn-1,0,Tt.ab(Hr/2)),os=Math.min(Tt.ab(Na),es+Tt.ab(Hr/2)),cs=me(wn-1,Math.min(os,es-Tt.ab(Hr/2)),os),ds=Math.atan(qt/Kt),Cs=Math.hypot(qt,Kt);let Vs=$t;return Vs+=Tt.ah(ge/Cs/Math.max(.5,Math.cos(Tt.ab(Hr/2)))),Vs+=wn*Tt.ah(Math.cos(ds))/2,Vs-=Tt.ah(Math.max(1,cs/ss/at))/2,Vs}}const qa=fe(9.314,3);function ve(rt,at){const $t=(at.roundZoom?Math.round:Math.floor)(rt.zoom+Tt.ah(rt.tileSize/at.tileSize));return Math.max(0,$t)}function xe(rt,at){const $t=rt.getCameraFrustum(),qt=rt.getClippingPlane(),Kt=rt.screenPointToMercatorCoordinate(rt.getCameraPoint()),ge=Tt.$.fromLngLat(rt.center,rt.elevation);Kt.z=ge.z+Math.cos(rt.pitchInRadians)*rt.cameraToCenterDistance/rt.worldSize;const Hr=rt.getCoveringTilesDetailsProvider(),wn=Hr.allowVariableZoom(rt,at),es=ve(rt,at),ss=at.minzoom||0,os=void 0!==at.maxzoom?at.maxzoom:rt.maxZoom,cs=Math.min(Math.max(0,es),os),ds=Math.pow(2,cs),Cs=[ds*Kt.x,ds*Kt.y,0],Vs=[ds*ge.x,ds*ge.y,0],Eo=Math.hypot(ge.x-Kt.x,ge.y-Kt.y),Do=Math.abs(ge.z-Kt.z),Ho=Math.hypot(Eo,Do),x=rt=>({zoom:0,x:0,y:0,wrap:rt,fullyVisible:!1}),Ea=[],La=[];if(rt.renderWorldCopies&&Hr.allowWorldCopies())for(let rt=1;rt<=3;rt++)Ea.push(x(-rt)),Ea.push(x(rt));for(Ea.push(x(0));Ea.length>0;){const ds=Ea.pop(),Eo=ds.x,ja=ds.y;let Va=ds.fullyVisible;const Na={x:Eo,y:ja,z:ds.zoom},Qa=Hr.getTileAABB(Na,ds.wrap,rt.elevation,at);if(!Va){const rt=pe($t,Qa,qt);if(0===rt)continue;Va=2===rt}const Pl=Hr.distanceToTile2d(Kt.x,Kt.y,Na,Qa);let zl=es;wn&&(zl=(at.calculateTileZoom||qa)(rt.zoom+Tt.ah(rt.tileSize/at.tileSize),Pl,Do,Ho,rt.fov)),zl=(at.roundZoom?Math.round:Math.floor)(zl),zl=Math.max(0,zl);const Dl=Math.min(zl,os);if(ds.wrap=Hr.getWrap(ge,Na,ds.wrap),ds.zoom>=Dl){if(ds.zoom<ss)continue;const rt=cs-ds.zoom,$t=Cs[0]-.5-(Eo<<rt),qt=Cs[1]-.5-(ja<<rt),Kt=at.reparseOverscaled?Math.max(ds.zoom,zl):ds.zoom;La.push({tileID:new Tt.Y(ds.zoom===os?Kt:ds.zoom,ds.wrap,ds.zoom,Eo,ja),distanceSq:Tt.ai([Vs[0]-.5-Eo,Vs[1]-.5-ja]),tileDistanceToCamera:Math.sqrt($t*$t+qt*qt)})}else for(let rt=0;rt<4;rt++)Ea.push({zoom:ds.zoom+1,x:(Eo<<1)+rt%2,y:(ja<<1)+(rt>>1),wrap:ds.wrap,fullyVisible:Va})}return La.sort(((rt,at)=>rt.distanceSq-at.distanceSq)).map((rt=>rt.tileID))}class be extends Tt.E{constructor(rt,at,Tt){super(),this.id=rt,this.dispatcher=Tt,this.on("data",(rt=>this._dataHandler(rt))),this.on("dataloading",(()=>{this._sourceErrored=!1})),this.on("error",(()=>{this._sourceErrored=this._source.loaded()})),this._source=((rt,at,Tt,$t)=>{const qt=new(ee(at.type))(rt,at,Tt,$t);if(qt.id!==rt)throw new Error(`Expected Source id to be ${rt} instead of ${qt.id}`);return qt})(rt,at,Tt,this),this._tiles={},this._cache=new se(0,(rt=>this._unloadTile(rt))),this._timers={},this._cacheTimers={},this._maxTileCacheSize=null,this._maxTileCacheZoomLevels=null,this._loadedParentTiles={},this._coveredTiles={},this._state=new ne,this._didEmitContent=!1,this._updated=!1}onAdd(rt){this.map=rt,this._maxTileCacheSize=rt?rt._maxTileCacheSize:null,this._maxTileCacheZoomLevels=rt?rt._maxTileCacheZoomLevels:null,this._source&&this._source.onAdd&&this._source.onAdd(rt)}onRemove(rt){this.clearTiles(),this._source&&this._source.onRemove&&this._source.onRemove(rt)}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded)return!1;if(!this._source.loaded())return!1;if(!(void 0===this.used&&void 0===this.usedForTerrain||this.used||this.usedForTerrain))return!0;if(!this._updated)return!1;for(const rt in this._tiles){const at=this._tiles[rt];if("loaded"!==at.state&&"errored"!==at.state)return!1}return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const rt=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,rt&&this.reload(),this.transform&&this.update(this.transform,this.terrain)}_loadTile(rt,at,$t){return Tt._(this,void 0,void 0,(function*(){try{yield this._source.loadTile(rt),this._tileLoaded(rt,at,$t)}catch(at){rt.state="errored",404!==at.status?this._source.fire(new Tt.k(at,{tile:rt})):this.update(this.transform,this.terrain)}}))}_unloadTile(rt){this._source.unloadTile&&this._source.unloadTile(rt)}_abortTile(rt){this._source.abortTile&&this._source.abortTile(rt),this._source.fire(new Tt.l("dataabort",{tile:rt,coord:rt.tileID,dataType:"source"}))}serialize(){return this._source.serialize()}prepare(rt){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const at in this._tiles){const Tt=this._tiles[at];Tt.upload(rt),Tt.prepare(this.map.style.imageManager)}}getIds(){return Object.values(this._tiles).map((rt=>rt.tileID)).sort(ye).map((rt=>rt.key))}getRenderableIds(rt){const at=[];for(const Tt in this._tiles)this._isIdRenderable(Tt,rt)&&at.push(this._tiles[Tt]);return rt?at.sort(((rt,at)=>{const $t=rt.tileID,qt=at.tileID,Kt=new Tt.P($t.canonical.x,$t.canonical.y)._rotate(-this.transform.bearingInRadians),ge=new Tt.P(qt.canonical.x,qt.canonical.y)._rotate(-this.transform.bearingInRadians);return $t.overscaledZ-qt.overscaledZ||ge.y-Kt.y||ge.x-Kt.x})).map((rt=>rt.tileID.key)):at.map((rt=>rt.tileID)).sort(ye).map((rt=>rt.key))}hasRenderableParent(rt){const at=this.findLoadedParent(rt,0);return!!at&&this._isIdRenderable(at.tileID.key)}_isIdRenderable(rt,at){return this._tiles[rt]&&this._tiles[rt].hasData()&&!this._coveredTiles[rt]&&(at||!this._tiles[rt].holdingForFade())}reload(rt){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const at in this._tiles)(rt||"errored"!==this._tiles[at].state)&&this._reloadTile(at,"reloading")}}_reloadTile(rt,at){return Tt._(this,void 0,void 0,(function*(){const Tt=this._tiles[rt];Tt&&("loading"!==Tt.state&&(Tt.state=at),yield this._loadTile(Tt,rt,at))}))}_tileLoaded(rt,at,$t){rt.timeAdded=ge.now(),"expired"===$t&&(rt.refreshedUponExpiration=!0),this._setTileReloadTimer(at,rt),"raster-dem"===this.getSource().type&&rt.dem&&this._backfillDEM(rt),this._state.initializeTileState(rt,this.map?this.map.painter:null),rt.aborted||this._source.fire(new Tt.l("data",{dataType:"source",tile:rt,coord:rt.tileID}))}_backfillDEM(rt){const at=this.getRenderableIds();for(let Tt=0;Tt<at.length;Tt++){const $t=at[Tt];if(rt.neighboringTiles&&rt.neighboringTiles[$t]){const at=this.getTileByID($t);i(rt,at),i(at,rt)}}function i(rt,at){rt.needsHillshadePrepare=!0,rt.needsTerrainPrepare=!0;let Tt=at.tileID.canonical.x-rt.tileID.canonical.x;const $t=at.tileID.canonical.y-rt.tileID.canonical.y,qt=Math.pow(2,rt.tileID.canonical.z),Kt=at.tileID.key;0===Tt&&0===$t||Math.abs($t)>1||(Math.abs(Tt)>1&&(1===Math.abs(Tt+qt)?Tt+=qt:1===Math.abs(Tt-qt)&&(Tt-=qt)),at.dem&&rt.dem&&(rt.dem.backfillBorder(at.dem,Tt,$t),rt.neighboringTiles&&rt.neighboringTiles[Kt]&&(rt.neighboringTiles[Kt].backfilled=!0)))}}getTile(rt){return this.getTileByID(rt.key)}getTileByID(rt){return this._tiles[rt]}_retainLoadedChildren(rt,at,Tt,$t){for(const qt in this._tiles){let Kt=this._tiles[qt];if($t[qt]||!Kt.hasData()||Kt.tileID.overscaledZ<=at||Kt.tileID.overscaledZ>Tt)continue;let ge=Kt.tileID;for(;Kt&&Kt.tileID.overscaledZ>at+1;){const rt=Kt.tileID.scaledTo(Kt.tileID.overscaledZ-1);Kt=this._tiles[rt.key],Kt&&Kt.hasData()&&(ge=rt)}let Hr=ge;for(;Hr.overscaledZ>at;)if(Hr=Hr.scaledTo(Hr.overscaledZ-1),rt[Hr.key]||rt[Hr.canonical.key]){$t[ge.key]=ge;break}}}findLoadedParent(rt,at){if(rt.key in this._loadedParentTiles){const Tt=this._loadedParentTiles[rt.key];return Tt&&Tt.tileID.overscaledZ>=at?Tt:null}for(let Tt=rt.overscaledZ-1;Tt>=at;Tt--){const at=rt.scaledTo(Tt),$t=this._getLoadedTile(at);if($t)return $t}}findLoadedSibling(rt){return this._getLoadedTile(rt)}_getLoadedTile(rt){const at=this._tiles[rt.key];return at&&at.hasData()?at:this._cache.getByKey(rt.wrapped().key)}updateCacheSize(rt){const at=Math.ceil(rt.width/this._source.tileSize)+1,$t=Math.ceil(rt.height/this._source.tileSize)+1,qt=Math.floor(at*$t*(null===this._maxTileCacheZoomLevels?Tt.a.MAX_TILE_CACHE_ZOOM_LEVELS:this._maxTileCacheZoomLevels)),Kt="number"==typeof this._maxTileCacheSize?Math.min(this._maxTileCacheSize,qt):qt;this._cache.setMaxSize(Kt)}handleWrapJump(rt){const at=Math.round((rt-(void 0===this._prevLng?rt:this._prevLng))/360);if(this._prevLng=rt,at){const rt={};for(const Tt in this._tiles){const $t=this._tiles[Tt];$t.tileID=$t.tileID.unwrapTo($t.tileID.wrap+at),rt[$t.tileID.key]=$t}this._tiles=rt;for(const rt in this._timers)clearTimeout(this._timers[rt]),delete this._timers[rt];for(const rt in this._tiles)this._setTileReloadTimer(rt,this._tiles[rt])}}_updateCoveredAndRetainedTiles(rt,at,Tt,$t,qt,Kt){const Hr={},wn={},es=Object.keys(rt),ss=ge.now();for(const Tt of es){const $t=rt[Tt],qt=this._tiles[Tt];if(!qt||0!==qt.fadeEndTime&&qt.fadeEndTime<=ss)continue;const Kt=this.findLoadedParent($t,at),ge=this.findLoadedSibling($t),es=Kt||ge||null;es&&(this._addTile(es.tileID),Hr[es.tileID.key]=es.tileID),wn[Tt]=$t}this._retainLoadedChildren(wn,$t,Tt,rt);for(const at in Hr)rt[at]||(this._coveredTiles[at]=!0,rt[at]=Hr[at]);if(Kt){const at={},Tt={};for(const rt of qt)this._tiles[rt.key].hasData()?at[rt.key]=rt:Tt[rt.key]=rt;for(const $t in Tt){const qt=Tt[$t].children(this._source.maxzoom);this._tiles[qt[0].key]&&this._tiles[qt[1].key]&&this._tiles[qt[2].key]&&this._tiles[qt[3].key]&&(at[qt[0].key]=rt[qt[0].key]=qt[0],at[qt[1].key]=rt[qt[1].key]=qt[1],at[qt[2].key]=rt[qt[2].key]=qt[2],at[qt[3].key]=rt[qt[3].key]=qt[3],delete Tt[$t])}for(const $t in Tt){const qt=Tt[$t],Kt=this.findLoadedParent(qt,this._source.minzoom),ge=this.findLoadedSibling(qt),Hr=Kt||ge||null;if(Hr){at[Hr.tileID.key]=rt[Hr.tileID.key]=Hr.tileID;for(const rt in at)at[rt].isChildOf(Hr.tileID)&&delete at[rt]}}for(const rt in this._tiles)at[rt]||(this._coveredTiles[rt]=!0)}}update(rt,at){if(!this._sourceLoaded||this._paused)return;let $t;this.transform=rt,this.terrain=at,this.updateCacheSize(rt),this.handleWrapJump(this.transform.center.lng),this._coveredTiles={},this.used||this.usedForTerrain?this._source.tileID?$t=rt.getVisibleUnwrappedCoordinates(this._source.tileID).map((rt=>new Tt.Y(rt.canonical.z,rt.wrap,rt.canonical.z,rt.canonical.x,rt.canonical.y))):($t=xe(rt,{tileSize:this.usedForTerrain?this.tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:!this.usedForTerrain&&this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled,terrain:at,calculateTileZoom:this._source.calculateTileZoom}),this._source.hasTile&&($t=$t.filter((rt=>this._source.hasTile(rt))))):$t=[];const qt=ve(rt,this._source),Kt=Math.max(qt-be.maxOverzooming,this._source.minzoom),ge=Math.max(qt+be.maxUnderzooming,this._source.minzoom);if(this.usedForTerrain){const rt={};for(const at of $t)if(at.canonical.z>this._source.minzoom){const Tt=at.scaledTo(at.canonical.z-1);rt[Tt.key]=Tt;const $t=at.scaledTo(Math.max(this._source.minzoom,Math.min(at.canonical.z,5)));rt[$t.key]=$t}$t=$t.concat(Object.values(rt))}const Hr=0===$t.length&&!this._updated&&this._didEmitContent;this._updated=!0,Hr&&this.fire(new Tt.l("data",{sourceDataType:"idle",dataType:"source",sourceId:this.id}));const wn=this._updateRetainedTiles($t,qt);we(this._source.type)&&this._updateCoveredAndRetainedTiles(wn,Kt,ge,qt,$t,at);for(const rt in wn)this._tiles[rt].clearFadeHold();const es=Tt.aj(this._tiles,wn);for(const rt of es){const at=this._tiles[rt];at.hasSymbolBuckets&&!at.holdingForFade()?at.setHoldDuration(this.map._fadeDuration):at.hasSymbolBuckets&&!at.symbolFadeFinished()||this._removeTile(rt)}this._updateLoadedParentTileCache(),this._updateLoadedSiblingTileCache()}releaseSymbolFadeTiles(){for(const rt in this._tiles)this._tiles[rt].holdingForFade()&&this._removeTile(rt)}_updateRetainedTiles(rt,at){var Tt;const $t={},qt={},Kt=Math.max(at-be.maxOverzooming,this._source.minzoom),ge=Math.max(at+be.maxUnderzooming,this._source.minzoom),Hr={};for(const Tt of rt){const rt=this._addTile(Tt);$t[Tt.key]=Tt,rt.hasData()||at<this._source.maxzoom&&(Hr[Tt.key]=Tt)}this._retainLoadedChildren(Hr,at,ge,$t);for(const ge of rt){let rt=this._tiles[ge.key];if(rt.hasData())continue;if(at+1>this._source.maxzoom){const rt=ge.children(this._source.maxzoom)[0],at=this.getTile(rt);if(at&&at.hasData()){$t[rt.key]=rt;continue}}else{const rt=ge.children(this._source.maxzoom);if($t[rt[0].key]&&$t[rt[1].key]&&$t[rt[2].key]&&$t[rt[3].key])continue}let Hr=rt.wasRequested();for(let at=ge.overscaledZ-1;at>=Kt;--at){const Kt=ge.scaledTo(at);if(qt[Kt.key])break;if(qt[Kt.key]=!0,rt=this.getTile(Kt),!rt&&Hr&&(rt=this._addTile(Kt)),rt){const at=rt.hasData();if((at||!(null===(Tt=this.map)||void 0===Tt?void 0:Tt.cancelPendingTileRequestsWhileZooming)||Hr)&&($t[Kt.key]=Kt),Hr=rt.wasRequested(),at)break}}}return $t}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const rt in this._tiles){const at=[];let Tt,$t=this._tiles[rt].tileID;for(;$t.overscaledZ>0;){if($t.key in this._loadedParentTiles){Tt=this._loadedParentTiles[$t.key];break}at.push($t.key);const rt=$t.scaledTo($t.overscaledZ-1);if(Tt=this._getLoadedTile(rt),Tt)break;$t=rt}for(const rt of at)this._loadedParentTiles[rt]=Tt}}_updateLoadedSiblingTileCache(){this._loadedSiblingTiles={};for(const rt in this._tiles){const at=this._tiles[rt].tileID,Tt=this._getLoadedTile(at);this._loadedSiblingTiles[at.key]=Tt}}_addTile(rt){let at=this._tiles[rt.key];if(at)return at;at=this._cache.getAndRemove(rt),at&&(this._setTileReloadTimer(rt.key,at),at.tileID=rt,this._state.initializeTileState(at,this.map?this.map.painter:null),this._cacheTimers[rt.key]&&(clearTimeout(this._cacheTimers[rt.key]),delete this._cacheTimers[rt.key],this._setTileReloadTimer(rt.key,at)));const $t=at;return at||(at=new ae(rt,this._source.tileSize*rt.overscaleFactor()),this._loadTile(at,rt.key,at.state)),at.uses++,this._tiles[rt.key]=at,$t||this._source.fire(new Tt.l("dataloading",{tile:at,coord:at.tileID,dataType:"source"})),at}_setTileReloadTimer(rt,at){rt in this._timers&&(clearTimeout(this._timers[rt]),delete this._timers[rt]);const Tt=at.getExpiryTimeout();Tt&&(this._timers[rt]=setTimeout((()=>{this._reloadTile(rt,"expired"),delete this._timers[rt]}),Tt))}_removeTile(rt){const at=this._tiles[rt];at&&(at.uses--,delete this._tiles[rt],this._timers[rt]&&(clearTimeout(this._timers[rt]),delete this._timers[rt]),at.uses>0||(at.hasData()&&"reloading"!==at.state?this._cache.add(at.tileID,at,at.getExpiryTimeout()):(at.aborted=!0,this._abortTile(at),this._unloadTile(at))))}_dataHandler(rt){const at=rt.sourceDataType;"source"===rt.dataType&&"metadata"===at&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&"source"===rt.dataType&&"content"===at&&(this.reload(rt.sourceDataChanged),this.transform&&this.update(this.transform,this.terrain),this._didEmitContent=!0)}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const rt in this._tiles)this._removeTile(rt);this._cache.reset()}tilesIn(rt,at,$t){const qt=[],Kt=this.transform;if(!Kt)return qt;const ge=$t?Kt.getCameraQueryGeometry(rt):rt,Hr=rt.map((rt=>Kt.screenPointToMercatorCoordinate(rt,this.terrain))),wn=ge.map((rt=>Kt.screenPointToMercatorCoordinate(rt,this.terrain))),es=this.getIds();let ss=1/0,os=1/0,cs=-1/0,ds=-1/0;for(const rt of wn)ss=Math.min(ss,rt.x),os=Math.min(os,rt.y),cs=Math.max(cs,rt.x),ds=Math.max(ds,rt.y);for(let rt=0;rt<es.length;rt++){const $t=this._tiles[es[rt]];if($t.holdingForFade())continue;const ge=Kt.getCoveringTilesDetailsProvider().allowWorldCopies()?$t.tileID:$t.tileID.unwrapTo(0),Cs=Math.pow(2,Kt.zoom-$t.tileID.overscaledZ),Vs=at*$t.queryPadding*Tt.Z/$t.tileSize/Cs,Eo=[ge.getTilePoint(new Tt.$(ss,os)),ge.getTilePoint(new Tt.$(cs,ds))];if(Eo[0].x-Vs<Tt.Z&&Eo[0].y-Vs<Tt.Z&&Eo[1].x+Vs>=0&&Eo[1].y+Vs>=0){const rt=Hr.map((rt=>ge.getTilePoint(rt))),at=wn.map((rt=>ge.getTilePoint(rt)));qt.push({tile:$t,tileID:ge,queryGeometry:rt,cameraQueryGeometry:at,scale:Cs})}}return qt}getVisibleCoordinates(rt){const at=this.getRenderableIds(rt).map((rt=>this._tiles[rt].tileID));return this.transform&&this.transform.populateCache(at),at}hasTransition(){if(this._source.hasTransition())return!0;if(we(this._source.type)){const rt=ge.now();for(const at in this._tiles)if(this._tiles[at].fadeEndTime>=rt)return!0}return!1}setFeatureState(rt,at,Tt){this._state.updateState(rt=rt||"_geojsonTileLayer",at,Tt)}removeFeatureState(rt,at,Tt){this._state.removeFeatureState(rt=rt||"_geojsonTileLayer",at,Tt)}getFeatureState(rt,at){return this._state.getState(rt=rt||"_geojsonTileLayer",at)}setDependencies(rt,at,Tt){const $t=this._tiles[rt];$t&&$t.setDependencies(at,Tt)}reloadTilesForDependencies(rt,at){for(const Tt in this._tiles)this._tiles[Tt].hasDependency(rt,at)&&this._reloadTile(Tt,"reloading");this._cache.filter((Tt=>!Tt.hasDependency(rt,at)))}}function ye(rt,at){const Tt=Math.abs(2*rt.wrap)-+(rt.wrap<0),$t=Math.abs(2*at.wrap)-+(at.wrap<0);return rt.overscaledZ-at.overscaledZ||$t-Tt||at.canonical.y-rt.canonical.y||at.canonical.x-rt.canonical.x}function we(rt){return"raster"===rt||"image"===rt||"video"===rt}be.maxOverzooming=10,be.maxUnderzooming=3;class Te{constructor(rt,at){this.reset(rt,at)}reset(rt,at){this.points=rt||[],this._distances=[0];for(let rt=1;rt<this.points.length;rt++)this._distances[rt]=this._distances[rt-1]+this.points[rt].dist(this.points[rt-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(at||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(rt){if(1===this.points.length)return this.points[0];rt=Tt.ae(rt,0,1);let at=1,$t=this._distances[at];const qt=rt*this.paddedLength+this.padding;for(;$t<qt&&at<this._distances.length;)$t=this._distances[++at];const Kt=at-1,ge=this._distances[Kt],Hr=$t-ge,wn=Hr>0?(qt-ge)/Hr:0;return this.points[Kt].mult(1-wn).add(this.points[at].mult(wn))}}function Pe(rt,at){let Tt=!0;return"always"===rt||"never"!==rt&&"never"!==at||(Tt=!1),Tt}class Ce{constructor(rt,at,Tt){const $t=this.boxCells=[],qt=this.circleCells=[];this.xCellCount=Math.ceil(rt/Tt),this.yCellCount=Math.ceil(at/Tt);for(let rt=0;rt<this.xCellCount*this.yCellCount;rt++)$t.push([]),qt.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=rt,this.height=at,this.xScale=this.xCellCount/rt,this.yScale=this.yCellCount/at,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(rt,at,Tt,$t,qt){this._forEachCell(at,Tt,$t,qt,this._insertBoxCell,this.boxUid++),this.boxKeys.push(rt),this.bboxes.push(at),this.bboxes.push(Tt),this.bboxes.push($t),this.bboxes.push(qt)}insertCircle(rt,at,Tt,$t){this._forEachCell(at-$t,Tt-$t,at+$t,Tt+$t,this._insertCircleCell,this.circleUid++),this.circleKeys.push(rt),this.circles.push(at),this.circles.push(Tt),this.circles.push($t)}_insertBoxCell(rt,at,Tt,$t,qt,Kt){this.boxCells[qt].push(Kt)}_insertCircleCell(rt,at,Tt,$t,qt,Kt){this.circleCells[qt].push(Kt)}_query(rt,at,Tt,$t,qt,Kt,ge){if(Tt<0||rt>this.width||$t<0||at>this.height)return[];const Hr=[];if(rt<=0&&at<=0&&this.width<=Tt&&this.height<=$t){if(qt)return[{key:null,x1:rt,y1:at,x2:Tt,y2:$t}];for(let rt=0;rt<this.boxKeys.length;rt++)Hr.push({key:this.boxKeys[rt],x1:this.bboxes[4*rt],y1:this.bboxes[4*rt+1],x2:this.bboxes[4*rt+2],y2:this.bboxes[4*rt+3]});for(let rt=0;rt<this.circleKeys.length;rt++){const at=this.circles[3*rt],Tt=this.circles[3*rt+1],$t=this.circles[3*rt+2];Hr.push({key:this.circleKeys[rt],x1:at-$t,y1:Tt-$t,x2:at+$t,y2:Tt+$t})}}else this._forEachCell(rt,at,Tt,$t,this._queryCell,Hr,{hitTest:qt,overlapMode:Kt,seenUids:{box:{},circle:{}}},ge);return Hr}query(rt,at,Tt,$t){return this._query(rt,at,Tt,$t,!1,null)}hitTest(rt,at,Tt,$t,qt,Kt){return this._query(rt,at,Tt,$t,!0,qt,Kt).length>0}hitTestCircle(rt,at,Tt,$t,qt){const Kt=rt-Tt,ge=rt+Tt,Hr=at-Tt,wn=at+Tt;if(ge<0||Kt>this.width||wn<0||Hr>this.height)return!1;const es=[];return this._forEachCell(Kt,Hr,ge,wn,this._queryCellCircle,es,{hitTest:!0,overlapMode:$t,circle:{x:rt,y:at,radius:Tt},seenUids:{box:{},circle:{}}},qt),es.length>0}_queryCell(rt,at,Tt,$t,qt,Kt,ge,Hr){const{seenUids:wn,hitTest:es,overlapMode:ss}=ge,os=this.boxCells[qt];if(null!==os){const qt=this.bboxes;for(const ge of os)if(!wn.box[ge]){wn.box[ge]=!0;const os=4*ge,cs=this.boxKeys[ge];if(rt<=qt[os+2]&&at<=qt[os+3]&&Tt>=qt[os+0]&&$t>=qt[os+1]&&(!Hr||Hr(cs))&&(!es||!Pe(ss,cs.overlapMode))&&(Kt.push({key:cs,x1:qt[os],y1:qt[os+1],x2:qt[os+2],y2:qt[os+3]}),es))return!0}}const cs=this.circleCells[qt];if(null!==cs){const qt=this.circles;for(const ge of cs)if(!wn.circle[ge]){wn.circle[ge]=!0;const os=3*ge,cs=this.circleKeys[ge];if(this._circleAndRectCollide(qt[os],qt[os+1],qt[os+2],rt,at,Tt,$t)&&(!Hr||Hr(cs))&&(!es||!Pe(ss,cs.overlapMode))){const rt=qt[os],at=qt[os+1],Tt=qt[os+2];if(Kt.push({key:cs,x1:rt-Tt,y1:at-Tt,x2:rt+Tt,y2:at+Tt}),es)return!0}}}return!1}_queryCellCircle(rt,at,Tt,$t,qt,Kt,ge,Hr){const{circle:wn,seenUids:es,overlapMode:ss}=ge,os=this.boxCells[qt];if(null!==os){const rt=this.bboxes;for(const at of os)if(!es.box[at]){es.box[at]=!0;const Tt=4*at,$t=this.boxKeys[at];if(this._circleAndRectCollide(wn.x,wn.y,wn.radius,rt[Tt+0],rt[Tt+1],rt[Tt+2],rt[Tt+3])&&(!Hr||Hr($t))&&!Pe(ss,$t.overlapMode))return Kt.push(!0),!0}}const cs=this.circleCells[qt];if(null!==cs){const rt=this.circles;for(const at of cs)if(!es.circle[at]){es.circle[at]=!0;const Tt=3*at,$t=this.circleKeys[at];if(this._circlesCollide(rt[Tt],rt[Tt+1],rt[Tt+2],wn.x,wn.y,wn.radius)&&(!Hr||Hr($t))&&!Pe(ss,$t.overlapMode))return Kt.push(!0),!0}}}_forEachCell(rt,at,Tt,$t,qt,Kt,ge,Hr){const wn=this._convertToXCellCoord(rt),es=this._convertToYCellCoord(at),ss=this._convertToXCellCoord(Tt),os=this._convertToYCellCoord($t);for(let cs=wn;cs<=ss;cs++)for(let wn=es;wn<=os;wn++)if(qt.call(this,rt,at,Tt,$t,this.xCellCount*wn+cs,Kt,ge,Hr))return}_convertToXCellCoord(rt){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(rt*this.xScale)))}_convertToYCellCoord(rt){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(rt*this.yScale)))}_circlesCollide(rt,at,Tt,$t,qt,Kt){const ge=$t-rt,Hr=qt-at,wn=Tt+Kt;return wn*wn>ge*ge+Hr*Hr}_circleAndRectCollide(rt,at,Tt,$t,qt,Kt,ge){const Hr=(Kt-$t)/2,wn=Math.abs(rt-($t+Hr));if(wn>Hr+Tt)return!1;const es=(ge-qt)/2,ss=Math.abs(at-(qt+es));if(ss>es+Tt)return!1;if(wn<=Hr||ss<=es)return!0;const os=wn-Hr,cs=ss-es;return os*os+cs*cs<=Tt*Tt}}function Me(rt,at,$t){const qt=Tt.K();if(!rt){const{vecSouth:rt,vecEast:Tt}=Ee(at),$t=r();$t[0]=Tt[0],$t[1]=Tt[1],$t[2]=rt[0],$t[3]=rt[1],Kt=$t,(os=(Hr=(ge=$t)[0])*(ss=ge[3])-(es=ge[2])*(wn=ge[1]))&&(Kt[0]=ss*(os=1/os),Kt[1]=-wn*os,Kt[2]=-es*os,Kt[3]=Hr*os),qt[0]=$t[0],qt[1]=$t[1],qt[4]=$t[2],qt[5]=$t[3]}var Kt,ge,Hr,wn,es,ss,os;return Tt.M(qt,qt,[1/$t,1/$t,1]),qt}function Ie(rt,at,$t,qt){if(rt){const rt=Tt.K();if(!at){const{vecSouth:at,vecEast:Tt}=Ee($t);rt[0]=Tt[0],rt[1]=Tt[1],rt[4]=at[0],rt[5]=at[1]}return Tt.M(rt,rt,[qt,qt,1]),rt}return $t.pixelsToClipSpaceMatrix}function Ee(rt){const at=Math.cos(rt.rollInRadians),$t=Math.sin(rt.rollInRadians),qt=Math.cos(rt.pitchInRadians),Kt=Math.cos(rt.bearingInRadians),ge=Math.sin(rt.bearingInRadians),Hr=Tt.ao();Hr[0]=-Kt*qt*$t-ge*at,Hr[1]=-ge*qt*$t+Kt*at;const wn=Tt.ap(Hr);wn<1e-9?Tt.aq(Hr):Tt.ar(Hr,Hr,1/wn);const es=Tt.ao();es[0]=Kt*qt*at-ge*$t,es[1]=ge*qt*at+Kt*$t;const ss=Tt.ap(es);return ss<1e-9?Tt.aq(es):Tt.ar(es,es,1/ss),{vecEast:es,vecSouth:Hr}}function Se(rt,at,$t,qt){let Kt;qt?(Kt=[rt,at,qt(rt,at),1],Tt.at(Kt,Kt,$t)):(Kt=[rt,at,0,1],We(Kt,Kt,$t));const ge=Kt[3];return{point:new Tt.P(Kt[0]/ge,Kt[1]/ge),signedDistanceFromCamera:ge,isOccluded:!1}}function Re(rt,at){return.5+rt/at*.5}function De(rt,at){return rt.x>=-at[0]&&rt.x<=at[0]&&rt.y>=-at[1]&&rt.y<=at[1]}function ze(rt,at,$t,qt,Kt,ge,Hr,wn,es,ss,os,cs,ds){const Cs=$t?rt.textSizeData:rt.iconSizeData,Vs=Tt.ak(Cs,at.transform.zoom),Eo=[256/at.width*2+1,256/at.height*2+1],Do=$t?rt.text.dynamicLayoutVertexArray:rt.icon.dynamicLayoutVertexArray;Do.clear();const Ho=rt.lineVertexArray,Ea=$t?rt.text.placedSymbolArray:rt.icon.placedSymbolArray,La=at.transform.width/at.transform.height;let ja=!1;for(let $t=0;$t<Ea.length;$t++){const Va=Ea.get($t);if(Va.hidden||Va.writingMode===Tt.al.vertical&&!ja){qe(Va.numGlyphs,Do);continue}ja=!1;const Na=new Tt.P(Va.anchorX,Va.anchorY),qa={getElevation:ds,pitchedLabelPlaneMatrix:qt,lineVertexArray:Ho,pitchWithMap:ge,projectionCache:{projections:{},offsets:{},cachedAnchorPoint:void 0,anyProjectionOccluded:!1},transform:at.transform,tileAnchorPoint:Na,unwrappedTileID:es,width:ss,height:os,translation:cs},Qa=Ze(Va.anchorX,Va.anchorY,qa);if(!De(Qa.point,Eo)){qe(Va.numGlyphs,Do);continue}const Pl=Re(at.transform.cameraToCenterDistance,Qa.signedDistanceFromCamera),zl=Tt.am(Cs,Vs,Va),Dl=ge?zl*at.transform.getPitchedTextCorrection(Va.anchorX,Va.anchorY,es)/Pl:zl*Pl,Ll=ke({projectionContext:qa,pitchedLabelPlaneMatrixInverse:Kt,symbol:Va,fontSize:Dl,flip:!1,keepUpright:Hr,glyphOffsetArray:rt.glyphOffsetArray,dynamicLayoutVertexArray:Do,aspectRatio:La,rotateToLine:wn});ja=Ll.useVertical,(Ll.notEnoughRoom||ja||Ll.needsFlipping&&ke({projectionContext:qa,pitchedLabelPlaneMatrixInverse:Kt,symbol:Va,fontSize:Dl,flip:!0,keepUpright:Hr,glyphOffsetArray:rt.glyphOffsetArray,dynamicLayoutVertexArray:Do,aspectRatio:La,rotateToLine:wn}).notEnoughRoom)&&qe(Va.numGlyphs,Do)}$t?rt.text.dynamicLayoutVertexBuffer.updateData(Do):rt.icon.dynamicLayoutVertexBuffer.updateData(Do)}function Ae(rt,at,Tt,$t,qt,Kt,ge,Hr){const wn=Kt.glyphStartIndex+Kt.numGlyphs,es=Kt.lineStartIndex,ss=Kt.lineStartIndex+Kt.lineLength,os=at.getoffsetX(Kt.glyphStartIndex),cs=at.getoffsetX(wn-1),ds=Ge(rt*os,Tt,$t,qt,Kt.segment,es,ss,Hr,ge);if(!ds)return null;const Cs=Ge(rt*cs,Tt,$t,qt,Kt.segment,es,ss,Hr,ge);return Cs?Hr.projectionCache.anyProjectionOccluded?null:{first:ds,last:Cs}:null}function Le(rt,at,$t,qt){return rt===Tt.al.horizontal&&Math.abs($t.y-at.y)>Math.abs($t.x-at.x)*qt?{useVertical:!0}:(rt===Tt.al.vertical?at.y<$t.y:at.x>$t.x)?{needsFlipping:!0}:null}function ke(rt){const{projectionContext:at,pitchedLabelPlaneMatrixInverse:$t,symbol:qt,fontSize:Kt,flip:ge,keepUpright:Hr,glyphOffsetArray:wn,dynamicLayoutVertexArray:es,aspectRatio:ss,rotateToLine:os}=rt,cs=Kt/24,ds=qt.lineOffsetX*cs,Cs=qt.lineOffsetY*cs;let Vs;if(qt.numGlyphs>1){const rt=qt.glyphStartIndex+qt.numGlyphs,Tt=qt.lineStartIndex,Kt=qt.lineStartIndex+qt.lineLength,es=Ae(cs,wn,ds,Cs,ge,qt,os,at);if(!es)return{notEnoughRoom:!0};const Eo=je(es.first.point.x,es.first.point.y,at,$t),Do=je(es.last.point.x,es.last.point.y,at,$t);if(Hr&&!ge){const rt=Le(qt.writingMode,Eo,Do,ss);if(rt)return rt}Vs=[es.first];for(let $t=qt.glyphStartIndex+1;$t<rt-1;$t++)Vs.push(Ge(cs*wn.getoffsetX($t),ds,Cs,ge,qt.segment,Tt,Kt,at,os));Vs.push(es.last)}else{if(Hr&&!ge){const rt=Oe(at.tileAnchorPoint.x,at.tileAnchorPoint.y,at).point,Kt=qt.lineStartIndex+qt.segment+1,ge=new Tt.P(at.lineVertexArray.getx(Kt),at.lineVertexArray.gety(Kt)),Hr=Oe(ge.x,ge.y,at),wn=Hr.signedDistanceFromCamera>0?Hr.point:Fe(at.tileAnchorPoint,ge,rt,1,at),es=je(rt.x,rt.y,at,$t),os=je(wn.x,wn.y,at,$t),cs=Le(qt.writingMode,es,os,ss);if(cs)return cs}const rt=Ge(cs*wn.getoffsetX(qt.glyphStartIndex),ds,Cs,ge,qt.segment,qt.lineStartIndex,qt.lineStartIndex+qt.lineLength,at,os);if(!rt||at.projectionCache.anyProjectionOccluded)return{notEnoughRoom:!0};Vs=[rt]}for(const rt of Vs)Tt.as(es,rt.point,rt.angle);return{}}function Fe(rt,at,Tt,$t,qt){const Kt=rt.add(rt.sub(at)._unit()),ge=Oe(Kt.x,Kt.y,qt).point,Hr=Tt.sub(ge);return Tt.add(Hr._mult($t/Hr.mag()))}function Be(rt,at,$t){const qt=at.projectionCache;if(qt.projections[rt])return qt.projections[rt];const Kt=new Tt.P(at.lineVertexArray.getx(rt),at.lineVertexArray.gety(rt)),ge=Oe(Kt.x,Kt.y,at);if(ge.signedDistanceFromCamera>0)return qt.projections[rt]=ge.point,qt.anyProjectionOccluded=qt.anyProjectionOccluded||ge.isOccluded,ge.point;const Hr=rt-$t.direction;return Fe(0===$t.distanceFromAnchor?at.tileAnchorPoint:new Tt.P(at.lineVertexArray.getx(Hr),at.lineVertexArray.gety(Hr)),Kt,$t.previousVertex,$t.absOffsetX-$t.distanceFromAnchor+1,at)}function Oe(rt,at,Tt){const $t=rt+Tt.translation[0],qt=at+Tt.translation[1];let Kt;return Tt.pitchWithMap?(Kt=Se($t,qt,Tt.pitchedLabelPlaneMatrix,Tt.getElevation),Kt.isOccluded=!1):(Kt=Tt.transform.projectTileCoordinates($t,qt,Tt.unwrappedTileID,Tt.getElevation),Kt.point.x=(.5*Kt.point.x+.5)*Tt.width,Kt.point.y=(.5*-Kt.point.y+.5)*Tt.height),Kt}function je(rt,at,$t,qt){if($t.pitchWithMap){const Kt=[rt,at,0,1];return Tt.at(Kt,Kt,qt),$t.transform.projectTileCoordinates(Kt[0]/Kt[3],Kt[1]/Kt[3],$t.unwrappedTileID,$t.getElevation).point}return{x:rt/$t.width*2-1,y:at/$t.height*2-1}}function Ze(rt,at,Tt){return Tt.transform.projectTileCoordinates(rt,at,Tt.unwrappedTileID,Tt.getElevation)}function Ne(rt,at,Tt){return rt._unit()._perp()._mult(at*Tt)}function Ue(rt,at,$t,qt,Kt,ge,Hr,wn,es){if(wn.projectionCache.offsets[rt])return wn.projectionCache.offsets[rt];const ss=$t.add(at);if(rt+es.direction<qt||rt+es.direction>=Kt)return wn.projectionCache.offsets[rt]=ss,ss;const os=Be(rt+es.direction,wn,es),cs=Ne(os.sub($t),Hr,es.direction),ds=$t.add(cs),Cs=os.add(cs);return wn.projectionCache.offsets[rt]=Tt.au(ge,ss,ds,Cs)||ss,wn.projectionCache.offsets[rt]}function Ge(rt,at,Tt,$t,qt,Kt,ge,Hr,wn){const es=$t?rt-at:rt+at;let ss=es>0?1:-1,os=0;$t&&(ss*=-1,os=Math.PI),ss<0&&(os+=Math.PI);let cs,ds=ss>0?Kt+qt:Kt+qt+1;Hr.projectionCache.cachedAnchorPoint?cs=Hr.projectionCache.cachedAnchorPoint:(cs=Oe(Hr.tileAnchorPoint.x,Hr.tileAnchorPoint.y,Hr).point,Hr.projectionCache.cachedAnchorPoint=cs);let Cs,Vs,Eo=cs,Do=cs,Ho=0,Ea=0;const La=Math.abs(es),ja=[];let Va;for(;Ho+Ea<=La;){if(ds+=ss,ds<Kt||ds>=ge)return null;Ho+=Ea,Do=Eo,Vs=Cs;const rt={absOffsetX:La,direction:ss,distanceFromAnchor:Ho,previousVertex:Do};if(Eo=Be(ds,Hr,rt),0===Tt)ja.push(Do),Va=Eo.sub(Do);else{let at;const $t=Eo.sub(Do);at=0===$t.mag()?Ne(Be(ds+ss,Hr,rt).sub(Eo),Tt,ss):Ne($t,Tt,ss),Vs||(Vs=Do.add(at)),Cs=Ue(ds,at,Eo,Kt,ge,Vs,Tt,Hr,rt),ja.push(Vs),Va=Cs.sub(Vs)}Ea=Va.mag()}const Na=Va._mult((La-Ho)/Ea)._add(Vs||Do),qa=os+Math.atan2(Eo.y-Do.y,Eo.x-Do.x);return ja.push(Na),{point:Na,angle:wn?qa:0,path:ja}}const Qa=new Float32Array([-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0]);function qe(rt,at){for(let Tt=0;Tt<rt;Tt++){const rt=at.length;at.resize(rt+4),at.float32.set(Qa,3*rt)}}function We(rt,at,Tt){const $t=at[0],qt=at[1];return rt[0]=Tt[0]*$t+Tt[4]*qt+Tt[12],rt[1]=Tt[1]*$t+Tt[5]*qt+Tt[13],rt[3]=Tt[3]*$t+Tt[7]*qt+Tt[15],rt}const Pl=100;class $e{constructor(rt,at=new Ce(rt.width+200,rt.height+200,25),Tt=new Ce(rt.width+200,rt.height+200,25)){this.transform=rt,this.grid=at,this.ignoredGrid=Tt,this.pitchFactor=Math.cos(rt.pitch*Math.PI/180)*rt.cameraToCenterDistance,this.screenRightBoundary=rt.width+Pl,this.screenBottomBoundary=rt.height+Pl,this.gridRightBoundary=rt.width+200,this.gridBottomBoundary=rt.height+200,this.perspectiveRatioCutoff=.6}placeCollisionBox(rt,at,Tt,$t,qt,Kt,ge,Hr,wn,es,ss,os){const cs=this.projectAndGetPerspectiveRatio(rt.anchorPointX+Hr[0],rt.anchorPointY+Hr[1],qt,es,os),ds=Tt*cs.perspectiveRatio;let Cs;if(Kt||ge)Cs=this._projectCollisionBox(rt,ds,$t,qt,Kt,ge,Hr,cs,es,ss,os);else{const at=cs.x+(ss?ss.x*ds:0),Tt=cs.y+(ss?ss.y*ds:0);Cs={allPointsOccluded:!1,box:[at+rt.x1*ds,Tt+rt.y1*ds,at+rt.x2*ds,Tt+rt.y2*ds]}}const[Vs,Eo,Do,Ho]=Cs.box,Ea=Kt?Cs.allPointsOccluded:cs.isOccluded;let La=Ea;return La||(La=cs.perspectiveRatio<this.perspectiveRatioCutoff),La||(La=!this.isInsideGrid(Vs,Eo,Do,Ho)),La||"always"!==at&&this.grid.hitTest(Vs,Eo,Do,Ho,at,wn)?{box:[Vs,Eo,Do,Ho],placeable:!1,offscreen:!1,occluded:Ea}:{box:[Vs,Eo,Do,Ho],placeable:!0,offscreen:this.isOffscreen(Vs,Eo,Do,Ho),occluded:Ea}}placeCollisionCircles(rt,at,$t,qt,Kt,ge,Hr,wn,es,ss,os,cs,ds,Cs){const Vs=[],Eo=new Tt.P(at.anchorX,at.anchorY),Do=this.getPerspectiveRatio(Eo.x,Eo.y,ge,Cs),Ho=(es?Kt*this.transform.getPitchedTextCorrection(at.anchorX,at.anchorY,ge)/Do:Kt*Do)/Tt.ay,Ea={getElevation:Cs,pitchedLabelPlaneMatrix:Hr,lineVertexArray:$t,pitchWithMap:es,projectionCache:{projections:{},offsets:{},cachedAnchorPoint:void 0,anyProjectionOccluded:!1},transform:this.transform,tileAnchorPoint:Eo,unwrappedTileID:ge,width:this.transform.width,height:this.transform.height,translation:ds},La=Ae(Ho,qt,at.lineOffsetX*Ho,at.lineOffsetY*Ho,!1,at,!1,Ea);let ja=!1,Va=!1,Na=!0;if(La){const at=.5*os*Do+cs,$t=new Tt.P(-100,-100),qt=new Tt.P(this.screenRightBoundary,this.screenBottomBoundary),Kt=new Te,ge=La.first,Hr=La.last;let ds=[];for(let rt=ge.path.length-1;rt>=1;rt--)ds.push(ge.path[rt]);for(let rt=1;rt<Hr.path.length;rt++)ds.push(Hr.path[rt]);const Cs=2.5*at;if(es){const rt=this.projectPathToScreenSpace(ds,Ea);ds=rt.some((rt=>rt.signedDistanceFromCamera<=0))?[]:rt.map((rt=>rt.point))}let Eo=[];if(ds.length>0){const rt=ds[0].clone(),at=ds[0].clone();for(let Tt=1;Tt<ds.length;Tt++)rt.x=Math.min(rt.x,ds[Tt].x),rt.y=Math.min(rt.y,ds[Tt].y),at.x=Math.max(at.x,ds[Tt].x),at.y=Math.max(at.y,ds[Tt].y);Eo=rt.x>=$t.x&&at.x<=qt.x&&rt.y>=$t.y&&at.y<=qt.y?[ds]:at.x<$t.x||rt.x>qt.x||at.y<$t.y||rt.y>qt.y?[]:Tt.av([ds],$t.x,$t.y,qt.x,qt.y)}for(const Tt of Eo){Kt.reset(Tt,.25*at);let $t=0;$t=Kt.length<=.5*at?1:Math.ceil(Kt.paddedLength/Cs)+1;for(let Tt=0;Tt<$t;Tt++){const qt=Tt/Math.max($t-1,1),ge=Kt.lerp(qt),Hr=ge.x+Pl,es=ge.y+Pl;Vs.push(Hr,es,at,0);const os=Hr-at,cs=es-at,ds=Hr+at,Cs=es+at;if(Na=Na&&this.isOffscreen(os,cs,ds,Cs),Va=Va||this.isInsideGrid(os,cs,ds,Cs),"always"!==rt&&this.grid.hitTestCircle(Hr,es,at,rt,ss)&&(ja=!0,!wn))return{circles:[],offscreen:!1,collisionDetected:ja}}}}return{circles:!wn&&ja||!Va||Do<this.perspectiveRatioCutoff?[]:Vs,offscreen:Na,collisionDetected:ja}}projectPathToScreenSpace(rt,at){const $t=function(rt,at){const $t=Tt.K();return Tt.an($t,at.pitchedLabelPlaneMatrix),rt.map((rt=>{const Tt=Se(rt.x,rt.y,$t,at.getElevation),qt=at.transform.projectTileCoordinates(Tt.point.x,Tt.point.y,at.unwrappedTileID,at.getElevation);return qt.point.x=(.5*qt.point.x+.5)*at.width,qt.point.y=(.5*-qt.point.y+.5)*at.height,qt}))}(rt,at);return function(rt){let at=0,Tt=0,$t=0,qt=0;for(let Kt=0;Kt<rt.length;Kt++)rt[Kt].isOccluded?($t=Kt+1,qt=0):(qt++,qt>Tt&&(Tt=qt,at=$t));return rt.slice(at,at+Tt)}($t)}queryRenderedSymbols(rt){if(0===rt.length||0===this.grid.keysLength()&&0===this.ignoredGrid.keysLength())return{};const at=[];let $t=1/0,qt=1/0,Kt=-1/0,ge=-1/0;for(const Hr of rt){const rt=new Tt.P(Hr.x+Pl,Hr.y+Pl);$t=Math.min($t,rt.x),qt=Math.min(qt,rt.y),Kt=Math.max(Kt,rt.x),ge=Math.max(ge,rt.y),at.push(rt)}const Hr=this.grid.query($t,qt,Kt,ge).concat(this.ignoredGrid.query($t,qt,Kt,ge)),wn={},es={};for(const rt of Hr){const $t=rt.key;if(void 0===wn[$t.bucketInstanceId]&&(wn[$t.bucketInstanceId]={}),wn[$t.bucketInstanceId][$t.featureIndex])continue;const qt=[new Tt.P(rt.x1,rt.y1),new Tt.P(rt.x2,rt.y1),new Tt.P(rt.x2,rt.y2),new Tt.P(rt.x1,rt.y2)];Tt.aw(at,qt)&&(wn[$t.bucketInstanceId][$t.featureIndex]=!0,void 0===es[$t.bucketInstanceId]&&(es[$t.bucketInstanceId]=[]),es[$t.bucketInstanceId].push($t.featureIndex))}return es}insertCollisionBox(rt,at,Tt,$t,qt,Kt){(Tt?this.ignoredGrid:this.grid).insert({bucketInstanceId:$t,featureIndex:qt,collisionGroupID:Kt,overlapMode:at},rt[0],rt[1],rt[2],rt[3])}insertCollisionCircles(rt,at,Tt,$t,qt,Kt){const ge=Tt?this.ignoredGrid:this.grid,Hr={bucketInstanceId:$t,featureIndex:qt,collisionGroupID:Kt,overlapMode:at};for(let at=0;at<rt.length;at+=4)ge.insertCircle(Hr,rt[at],rt[at+1],rt[at+2])}projectAndGetPerspectiveRatio(rt,at,$t,qt,Kt){if(Kt){let $t;qt?($t=[rt,at,qt(rt,at),1],Tt.at($t,$t,Kt)):($t=[rt,at,0,1],We($t,$t,Kt));const ge=$t[3];return{x:($t[0]/ge+1)/2*this.transform.width+Pl,y:(-$t[1]/ge+1)/2*this.transform.height+Pl,perspectiveRatio:.5+this.transform.cameraToCenterDistance/ge*.5,isOccluded:!1,signedDistanceFromCamera:ge}}{const Tt=this.transform.projectTileCoordinates(rt,at,$t,qt);return{x:(Tt.point.x+1)/2*this.transform.width+Pl,y:(1-Tt.point.y)/2*this.transform.height+Pl,perspectiveRatio:.5+this.transform.cameraToCenterDistance/Tt.signedDistanceFromCamera*.5,isOccluded:Tt.isOccluded,signedDistanceFromCamera:Tt.signedDistanceFromCamera}}}getPerspectiveRatio(rt,at,Tt,$t){const qt=this.transform.projectTileCoordinates(rt,at,Tt,$t);return.5+this.transform.cameraToCenterDistance/qt.signedDistanceFromCamera*.5}isOffscreen(rt,at,Tt,$t){return Tt<Pl||rt>=this.screenRightBoundary||$t<Pl||at>this.screenBottomBoundary}isInsideGrid(rt,at,Tt,$t){return Tt>=0&&rt<this.gridRightBoundary&&$t>=0&&at<this.gridBottomBoundary}getViewportMatrix(){const rt=Tt.ad([]);return Tt.L(rt,rt,[-100,-100,0]),rt}_projectCollisionBox(rt,at,$t,qt,Kt,ge,Hr,wn,es,ss,os){let cs=1,ds=0,Cs=0,Vs=1;const Eo=rt.anchorPointX+Hr[0],Do=rt.anchorPointY+Hr[1];if(ge&&!Kt){const rt=this.projectAndGetPerspectiveRatio(Eo+1,Do,qt,es,os),at=rt.x-wn.x,Tt=Math.atan((rt.y-wn.y)/at)+(at<0?Math.PI:0),$t=Math.sin(Tt),Kt=Math.cos(Tt);cs=Kt,ds=$t,Cs=-$t,Vs=Kt}else if(!ge&&Kt){const rt=Ee(this.transform);cs=rt.vecEast[0],ds=rt.vecEast[1],Cs=rt.vecSouth[0],Vs=rt.vecSouth[1]}let Ho=wn.x,Ea=wn.y,La=at;Kt&&(Ho=Eo,Ea=Do,La=Math.pow(2,-(this.transform.zoom-$t.overscaledZ)),La*=this.transform.getPitchedTextCorrection(Eo,Do,qt),ss||(La*=Tt.ae(.5+wn.signedDistanceFromCamera/this.transform.cameraToCenterDistance*.5,0,4))),ss&&(Ho+=cs*ss.x*La+Cs*ss.y*La,Ea+=ds*ss.x*La+Vs*ss.y*La);const ja=rt.x1*La,Va=rt.x2*La,Na=(ja+Va)/2,qa=rt.y1*La,Qa=rt.y2*La,Pl=(qa+Qa)/2,zl=[{offsetX:ja,offsetY:qa},{offsetX:Na,offsetY:qa},{offsetX:Va,offsetY:qa},{offsetX:Va,offsetY:Pl},{offsetX:Va,offsetY:Qa},{offsetX:Na,offsetY:Qa},{offsetX:ja,offsetY:Qa},{offsetX:ja,offsetY:Pl}];let Dl=[];for(const{offsetX:rt,offsetY:at}of zl)Dl.push(new Tt.P(Ho+cs*rt+Cs*at,Ea+ds*rt+Vs*at));let Ll=!1;if(Kt){const rt=Dl.map((rt=>this.projectAndGetPerspectiveRatio(rt.x,rt.y,qt,es,os)));Ll=rt.some((rt=>!rt.isOccluded)),Dl=rt.map((rt=>new Tt.P(rt.x,rt.y)))}else Ll=!0;return{box:Tt.ax(Dl),allPointsOccluded:!Ll}}}class Xe{constructor(rt,at,Tt,$t){this.opacity=rt?Math.max(0,Math.min(1,rt.opacity+(rt.placed?at:-at))):$t&&Tt?1:0,this.placed=Tt}isHidden(){return 0===this.opacity&&!this.placed}}class Ke{constructor(rt,at,Tt,$t,qt){this.text=new Xe(rt?rt.text:null,at,Tt,qt),this.icon=new Xe(rt?rt.icon:null,at,$t,qt)}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class Qe{constructor(rt,at,Tt){this.text=rt,this.icon=at,this.skipFade=Tt}}class Ye{constructor(rt,at,Tt,$t,qt){this.bucketInstanceId=rt,this.featureIndex=at,this.sourceLayerIndex=Tt,this.bucketIndex=$t,this.tileID=qt}}class Je{constructor(rt){this.crossSourceCollisions=rt,this.maxGroupID=0,this.collisionGroups={}}get(rt){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[rt]){const at=++this.maxGroupID;this.collisionGroups[rt]={ID:at,predicate:rt=>rt.collisionGroupID===at}}return this.collisionGroups[rt]}}function et(rt,at,$t,qt,Kt){const{horizontalAlign:ge,verticalAlign:Hr}=Tt.aE(rt);return new Tt.P(-(ge-.5)*at+qt[0]*Kt,-(Hr-.5)*$t+qt[1]*Kt)}class tt{constructor(rt,at,Tt,$t,qt){this.transform=rt.clone(),this.terrain=at,this.collisionIndex=new $e(this.transform),this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=Tt,this.retainedQueryData={},this.collisionGroups=new Je($t),this.collisionCircleArrays={},this.collisionBoxArrays=new Map,this.prevPlacement=qt,qt&&(qt.prevPlacement=void 0),this.placedOrientations={}}_getTerrainElevationFunc(rt){const at=this.terrain;return at?(Tt,$t)=>at.getElevation(rt,Tt,$t):null}getBucketParts(rt,at,$t,qt){const Kt=$t.getBucket(at),ge=$t.latestFeatureIndex;if(!Kt||!ge||at.id!==Kt.layerIds[0])return;const Hr=$t.collisionBoxArray,wn=Kt.layers[0].layout,es=Kt.layers[0].paint,ss=Math.pow(2,this.transform.zoom-$t.tileID.overscaledZ),os=$t.tileSize/Tt.Z,cs=$t.tileID.toUnwrapped(),ds="map"===wn.get("text-rotation-alignment"),Cs=Tt.az($t,1,this.transform.zoom),Vs=Tt.aA(this.collisionIndex.transform,$t,es.get("text-translate"),es.get("text-translate-anchor")),Eo=Tt.aA(this.collisionIndex.transform,$t,es.get("icon-translate"),es.get("icon-translate-anchor")),Do=Me(ds,this.transform,Cs);this.retainedQueryData[Kt.bucketInstanceId]=new Ye(Kt.bucketInstanceId,ge,Kt.sourceLayerIndex,Kt.index,$t.tileID);const Ho={bucket:Kt,layout:wn,translationText:Vs,translationIcon:Eo,unwrappedTileID:cs,pitchedLabelPlaneMatrix:Do,scale:ss,textPixelRatio:os,holdingForFade:$t.holdingForFade(),collisionBoxArray:Hr,partiallyEvaluatedTextSize:Tt.ak(Kt.textSizeData,this.transform.zoom),collisionGroup:this.collisionGroups.get(Kt.sourceID)};if(qt)for(const at of Kt.sortKeyRanges){const{sortKey:Tt,symbolInstanceStart:$t,symbolInstanceEnd:qt}=at;rt.push({sortKey:Tt,symbolInstanceStart:$t,symbolInstanceEnd:qt,parameters:Ho})}else rt.push({symbolInstanceStart:0,symbolInstanceEnd:Kt.symbolInstances.length,parameters:Ho})}attemptAnchorPlacement(rt,at,$t,qt,Kt,ge,Hr,wn,es,ss,os,cs,ds,Cs,Vs,Eo,Do,Ho,Ea,La){const ja=Tt.aB[rt.textAnchor],Va=[rt.textOffset0,rt.textOffset1],Na=et(ja,$t,qt,Va,Kt),qa=this.collisionIndex.placeCollisionBox(at,cs,wn,es,ss,Hr,ge,Eo,os.predicate,Ea,Na,La);if((!Ho||this.collisionIndex.placeCollisionBox(Ho,cs,wn,es,ss,Hr,ge,Do,os.predicate,Ea,Na,La).placeable)&&qa.placeable){let rt;if(this.prevPlacement&&this.prevPlacement.variableOffsets[ds.crossTileID]&&this.prevPlacement.placements[ds.crossTileID]&&this.prevPlacement.placements[ds.crossTileID].text&&(rt=this.prevPlacement.variableOffsets[ds.crossTileID].anchor),0===ds.crossTileID)throw new Error("symbolInstance.crossTileID can't be 0");return this.variableOffsets[ds.crossTileID]={textOffset:Va,width:$t,height:qt,anchor:ja,textBoxScale:Kt,prevAnchor:rt},this.markUsedJustification(Cs,ja,ds,Vs),Cs.allowVerticalPlacement&&(this.markUsedOrientation(Cs,Vs,ds),this.placedOrientations[ds.crossTileID]=Vs),{shift:Na,placedGlyphBoxes:qa}}}placeLayerBucketPart(rt,at,$t){const{bucket:qt,layout:Kt,translationText:ge,translationIcon:Hr,unwrappedTileID:wn,pitchedLabelPlaneMatrix:es,textPixelRatio:ss,holdingForFade:os,collisionBoxArray:cs,partiallyEvaluatedTextSize:ds,collisionGroup:Cs}=rt.parameters,Vs=Kt.get("text-optional"),Eo=Kt.get("icon-optional"),Do=Tt.aC(Kt,"text-overlap","text-allow-overlap"),Ho="always"===Do,Ea=Tt.aC(Kt,"icon-overlap","icon-allow-overlap"),La="always"===Ea,ja="map"===Kt.get("text-rotation-alignment"),Va="map"===Kt.get("text-pitch-alignment"),Na="none"!==Kt.get("icon-text-fit"),qa="viewport-y"===Kt.get("symbol-z-order"),Qa=Ho&&(La||!qt.hasIconData()||Eo),Pl=La&&(Ho||!qt.hasTextData()||Vs);!qt.collisionArrays&&cs&&qt.deserializeCollisionBoxes(cs);const zl=this.retainedQueryData[qt.bucketInstanceId].tileID,Dl=this._getTerrainElevationFunc(zl),Ll=this.transform.getFastPathSimpleProjectionMatrix(zl),R=(rt,cs,La)=>{var qa,Ol;if(at[rt.crossTileID])return;if(os)return void(this.placements[rt.crossTileID]=new Qe(!1,!1,!1));let jl=!1,Nl=!1,Zl=!0,Ul=null,Gl={box:null,placeable:!1,offscreen:null,occluded:!1},ql={placeable:!1},Hl=null,Xl=null,Kl=null,Yl=0,Jl=0,tc=0;cs.textFeatureIndex?Yl=cs.textFeatureIndex:rt.useRuntimeCollisionCircles&&(Yl=rt.featureIndex),cs.verticalTextFeatureIndex&&(Jl=cs.verticalTextFeatureIndex);const ic=cs.textBox;if(ic){const i=at=>{let $t=Tt.al.horizontal;if(qt.allowVerticalPlacement&&!at&&this.prevPlacement){const at=this.prevPlacement.placedOrientations[rt.crossTileID];at&&(this.placedOrientations[rt.crossTileID]=at,$t=at,this.markUsedOrientation(qt,$t,rt))}return $t},a=(at,$t)=>{if(qt.allowVerticalPlacement&&rt.numVerticalGlyphVertices>0&&cs.verticalTextBox){for(const rt of qt.writingModes)if(rt===Tt.al.vertical?(Gl=$t(),ql=Gl):Gl=at(),Gl&&Gl.placeable)break}else Gl=at()},at=rt.textAnchorOffsetStartIndex,Kt=rt.textAnchorOffsetEndIndex;if(Kt===at){const r=(at,Tt)=>{const $t=this.collisionIndex.placeCollisionBox(at,Do,ss,zl,wn,Va,ja,ge,Cs.predicate,Dl,void 0,Ll);return $t&&$t.placeable&&(this.markUsedOrientation(qt,Tt,rt),this.placedOrientations[rt.crossTileID]=Tt),$t};a((()=>r(ic,Tt.al.horizontal)),(()=>{const at=cs.verticalTextBox;return qt.allowVerticalPlacement&&rt.numVerticalGlyphVertices>0&&at?r(at,Tt.al.vertical):{box:null,offscreen:null}})),i(Gl&&Gl.placeable)}else{let es=Tt.aB[null===(Ol=null===(qa=this.prevPlacement)||void 0===qa?void 0:qa.variableOffsets[rt.crossTileID])||void 0===Ol?void 0:Ol.anchor];const m=(Tt,os,cs)=>{const ds=Tt.x2-Tt.x1,Vs=Tt.y2-Tt.y1,Eo=rt.textBoxScale,Ho=Na&&"never"===Ea?os:null;let La=null,qa="never"===Do?1:2,Qa="never";es&&qa++;for(let $t=0;$t<qa;$t++){for(let $t=at;$t<Kt;$t++){const at=qt.textAnchorOffsets.get($t);if(es&&at.textAnchor!==es)continue;const Kt=this.attemptAnchorPlacement(at,Tt,ds,Vs,Eo,ja,Va,ss,zl,wn,Cs,Qa,rt,qt,cs,ge,Hr,Ho,Dl);if(Kt&&(La=Kt.placedGlyphBoxes,La&&La.placeable))return jl=!0,Ul=Kt.shift,La}es?es=null:Qa=Do}return $t&&!La&&(La={box:this.collisionIndex.placeCollisionBox(ic,"always",ss,zl,wn,Va,ja,ge,Cs.predicate,Dl,void 0,Ll).box,offscreen:!1,placeable:!1,occluded:!1}),La};a((()=>m(ic,cs.iconBox,Tt.al.horizontal)),(()=>{const at=cs.verticalTextBox;return qt.allowVerticalPlacement&&(!Gl||!Gl.placeable)&&rt.numVerticalGlyphVertices>0&&at?m(at,cs.verticalIconBox,Tt.al.vertical):{box:null,occluded:!0,offscreen:null}})),Gl&&(jl=Gl.placeable,Zl=Gl.offscreen);const os=i(Gl&&Gl.placeable);if(!jl&&this.prevPlacement){const at=this.prevPlacement.variableOffsets[rt.crossTileID];at&&(this.variableOffsets[rt.crossTileID]=at,this.markUsedJustification(qt,at.anchor,rt,os))}}}if(Hl=Gl,jl=Hl&&Hl.placeable,Zl=Hl&&Hl.offscreen,rt.useRuntimeCollisionCircles){const at=qt.text.placedSymbolArray.get(rt.centerJustifiedTextSymbolIndex),Hr=Tt.am(qt.textSizeData,ds,at),ss=Kt.get("text-padding");Xl=this.collisionIndex.placeCollisionCircles(Do,at,qt.lineVertexArray,qt.glyphOffsetArray,Hr,wn,es,$t,Va,Cs.predicate,rt.collisionCircleDiameter,ss,ge,Dl),Xl.circles.length&&Xl.collisionDetected&&!$t&&Tt.w("Collisions detected, but collision boxes are not shown"),jl=Ho||Xl.circles.length>0&&!Xl.collisionDetected,Zl=Zl&&Xl.offscreen}if(cs.iconFeatureIndex&&(tc=cs.iconFeatureIndex),cs.iconBox){const e=rt=>this.collisionIndex.placeCollisionBox(rt,Ea,ss,zl,wn,Va,ja,Hr,Cs.predicate,Dl,Na&&Ul?Ul:void 0,Ll);ql&&ql.placeable&&cs.verticalIconBox?(Kl=e(cs.verticalIconBox),Nl=Kl.placeable):(Kl=e(cs.iconBox),Nl=Kl.placeable),Zl=Zl&&Kl.offscreen}const sc=Vs||0===rt.numHorizontalGlyphVertices&&0===rt.numVerticalGlyphVertices,ac=Eo||0===rt.numIconVertices;sc||ac?ac?sc||(Nl=Nl&&jl):jl=Nl&&jl:Nl=jl=Nl&&jl;const Pc=Nl&&Kl.placeable;if(jl&&Hl.placeable&&this.collisionIndex.insertCollisionBox(Hl.box,Do,Kt.get("text-ignore-placement"),qt.bucketInstanceId,ql&&ql.placeable&&Jl?Jl:Yl,Cs.ID),Pc&&this.collisionIndex.insertCollisionBox(Kl.box,Ea,Kt.get("icon-ignore-placement"),qt.bucketInstanceId,tc,Cs.ID),Xl&&jl&&this.collisionIndex.insertCollisionCircles(Xl.circles,Do,Kt.get("text-ignore-placement"),qt.bucketInstanceId,Yl,Cs.ID),$t&&this.storeCollisionData(qt.bucketInstanceId,La,cs,Hl,Kl,Xl),0===rt.crossTileID)throw new Error("symbolInstance.crossTileID can't be 0");if(0===qt.bucketInstanceId)throw new Error("bucket.bucketInstanceId can't be 0");this.placements[rt.crossTileID]=new Qe((jl||Qa)&&!(null==Hl?void 0:Hl.occluded),(Nl||Pl)&&!(null==Kl?void 0:Kl.occluded),Zl||qt.justReloaded),at[rt.crossTileID]=!0};if(qa){if(0!==rt.symbolInstanceStart)throw new Error("bucket.bucketInstanceId should be 0");const at=qt.getSortedSymbolIndexes(-this.transform.bearingInRadians);for(let rt=at.length-1;rt>=0;--rt){const Tt=at[rt];R(qt.symbolInstances.get(Tt),qt.collisionArrays[Tt],Tt)}}else for(let at=rt.symbolInstanceStart;at<rt.symbolInstanceEnd;at++)R(qt.symbolInstances.get(at),qt.collisionArrays[at],at);qt.justReloaded=!1}storeCollisionData(rt,at,Tt,$t,qt,Kt){if(Tt.textBox||Tt.iconBox){let Kt,ge;this.collisionBoxArrays.has(rt)?Kt=this.collisionBoxArrays.get(rt):(Kt=new Map,this.collisionBoxArrays.set(rt,Kt)),Kt.has(at)?ge=Kt.get(at):(ge={text:null,icon:null},Kt.set(at,ge)),Tt.textBox&&(ge.text=$t.box),Tt.iconBox&&(ge.icon=qt.box)}if(Kt){let at=this.collisionCircleArrays[rt];void 0===at&&(at=this.collisionCircleArrays[rt]=[]);for(let rt=0;rt<Kt.circles.length;rt+=4)at.push(Kt.circles[rt+0]-Pl),at.push(Kt.circles[rt+1]-Pl),at.push(Kt.circles[rt+2]),at.push(Kt.collisionDetected?1:0)}}markUsedJustification(rt,at,$t,qt){let Kt;Kt=qt===Tt.al.vertical?$t.verticalPlacedTextSymbolIndex:{left:$t.leftJustifiedTextSymbolIndex,center:$t.centerJustifiedTextSymbolIndex,right:$t.rightJustifiedTextSymbolIndex}[Tt.aD(at)];const ge=[$t.leftJustifiedTextSymbolIndex,$t.centerJustifiedTextSymbolIndex,$t.rightJustifiedTextSymbolIndex,$t.verticalPlacedTextSymbolIndex];for(const at of ge)at>=0&&(rt.text.placedSymbolArray.get(at).crossTileID=Kt>=0&&at!==Kt?0:$t.crossTileID)}markUsedOrientation(rt,at,$t){const qt=at===Tt.al.horizontal||at===Tt.al.horizontalOnly?at:0,Kt=at===Tt.al.vertical?at:0,ge=[$t.leftJustifiedTextSymbolIndex,$t.centerJustifiedTextSymbolIndex,$t.rightJustifiedTextSymbolIndex];for(const at of ge)rt.text.placedSymbolArray.get(at).placedOrientation=qt;$t.verticalPlacedTextSymbolIndex&&(rt.text.placedSymbolArray.get($t.verticalPlacedTextSymbolIndex).placedOrientation=Kt)}commit(rt){this.commitTime=rt,this.zoomAtLastRecencyCheck=this.transform.zoom;const at=this.prevPlacement;let Tt=!1;this.prevZoomAdjustment=at?at.zoomAdjustment(this.transform.zoom):0;const $t=at?at.symbolFadeChange(rt):1,qt=at?at.opacities:{},Kt=at?at.variableOffsets:{},ge=at?at.placedOrientations:{};for(const rt in this.placements){const at=this.placements[rt],Kt=qt[rt];Kt?(this.opacities[rt]=new Ke(Kt,$t,at.text,at.icon),Tt=Tt||at.text!==Kt.text.placed||at.icon!==Kt.icon.placed):(this.opacities[rt]=new Ke(null,$t,at.text,at.icon,at.skipFade),Tt=Tt||at.text||at.icon)}for(const rt in qt){const at=qt[rt];if(!this.opacities[rt]){const qt=new Ke(at,$t,!1,!1);qt.isHidden()||(this.opacities[rt]=qt,Tt=Tt||at.text.placed||at.icon.placed)}}for(const rt in Kt)this.variableOffsets[rt]||!this.opacities[rt]||this.opacities[rt].isHidden()||(this.variableOffsets[rt]=Kt[rt]);for(const rt in ge)this.placedOrientations[rt]||!this.opacities[rt]||this.opacities[rt].isHidden()||(this.placedOrientations[rt]=ge[rt]);if(at&&void 0===at.lastPlacementChangeTime)throw new Error("Last placement time for previous placement is not defined");Tt?this.lastPlacementChangeTime=rt:"number"!=typeof this.lastPlacementChangeTime&&(this.lastPlacementChangeTime=at?at.lastPlacementChangeTime:rt)}updateLayerOpacities(rt,at){const Tt={};for(const $t of at){const at=$t.getBucket(rt);at&&$t.latestFeatureIndex&&rt.id===at.layerIds[0]&&this.updateBucketOpacities(at,$t.tileID,Tt,$t.collisionBoxArray)}}updateBucketOpacities(rt,at,$t,qt){rt.hasTextData()&&(rt.text.opacityVertexArray.clear(),rt.text.hasVisibleVertices=!1),rt.hasIconData()&&(rt.icon.opacityVertexArray.clear(),rt.icon.hasVisibleVertices=!1),rt.hasIconCollisionBoxData()&&rt.iconCollisionBox.collisionVertexArray.clear(),rt.hasTextCollisionBoxData()&&rt.textCollisionBox.collisionVertexArray.clear();const Kt=rt.layers[0],ge=Kt.layout,Hr=new Ke(null,0,!1,!1,!0),wn=ge.get("text-allow-overlap"),es=ge.get("icon-allow-overlap"),ss=Kt._unevaluatedLayout.hasValue("text-variable-anchor")||Kt._unevaluatedLayout.hasValue("text-variable-anchor-offset"),os="map"===ge.get("text-rotation-alignment"),cs="map"===ge.get("text-pitch-alignment"),ds="none"!==ge.get("icon-text-fit"),Cs=new Ke(null,0,wn&&(es||!rt.hasIconData()||ge.get("icon-optional")),es&&(wn||!rt.hasTextData()||ge.get("text-optional")),!0);!rt.collisionArrays&&qt&&(rt.hasIconCollisionBoxData()||rt.hasTextCollisionBoxData())&&rt.deserializeCollisionBoxes(qt);const m=(rt,at,Tt)=>{for(let $t=0;$t<at/4;$t++)rt.opacityVertexArray.emplaceBack(Tt);rt.hasVisibleVertices=rt.hasVisibleVertices||Tt!==Ul},Vs=this.collisionBoxArrays.get(rt.bucketInstanceId);for(let at=0;at<rt.symbolInstances.length;at++){const qt=rt.symbolInstances.get(at),{numHorizontalGlyphVertices:Kt,numVerticalGlyphVertices:ge,crossTileID:wn}=qt;let es=this.opacities[wn];$t[wn]?es=Hr:es||(es=Cs,this.opacities[wn]=es),$t[wn]=!0;const Eo=qt.numIconVertices>0,Do=this.placedOrientations[qt.crossTileID],Ho=Do===Tt.al.vertical,Ea=Do===Tt.al.horizontal||Do===Tt.al.horizontalOnly;if(Kt>0||ge>0){const at=ht(es.text);m(rt.text,Kt,Ho?Ul:at),m(rt.text,ge,Ea?Ul:at);const Tt=es.text.isHidden();[qt.rightJustifiedTextSymbolIndex,qt.centerJustifiedTextSymbolIndex,qt.leftJustifiedTextSymbolIndex].forEach((at=>{at>=0&&(rt.text.placedSymbolArray.get(at).hidden=Tt||Ho?1:0)})),qt.verticalPlacedTextSymbolIndex>=0&&(rt.text.placedSymbolArray.get(qt.verticalPlacedTextSymbolIndex).hidden=Tt||Ea?1:0);const $t=this.variableOffsets[qt.crossTileID];$t&&this.markUsedJustification(rt,$t.anchor,qt,Do);const Hr=this.placedOrientations[qt.crossTileID];Hr&&(this.markUsedJustification(rt,"left",qt,Hr),this.markUsedOrientation(rt,Hr,qt))}if(Eo){const at=ht(es.icon),Tt=!(ds&&qt.verticalPlacedIconSymbolIndex&&Ho);qt.placedIconSymbolIndex>=0&&(m(rt.icon,qt.numIconVertices,Tt?at:Ul),rt.icon.placedSymbolArray.get(qt.placedIconSymbolIndex).hidden=es.icon.isHidden()),qt.verticalPlacedIconSymbolIndex>=0&&(m(rt.icon,qt.numVerticalIconVertices,Tt?Ul:at),rt.icon.placedSymbolArray.get(qt.verticalPlacedIconSymbolIndex).hidden=es.icon.isHidden())}const La=Vs&&Vs.has(at)?Vs.get(at):{text:null,icon:null};if(rt.hasIconCollisionBoxData()||rt.hasTextCollisionBoxData()){const $t=rt.collisionArrays[at];if($t){let at=new Tt.P(0,0);if($t.textBox||$t.verticalTextBox){let Tt=!0;if(ss){const rt=this.variableOffsets[wn];rt?(at=et(rt.anchor,rt.width,rt.height,rt.textOffset,rt.textBoxScale),os&&at._rotate(cs?-this.transform.bearingInRadians:this.transform.bearingInRadians)):Tt=!1}if($t.textBox||$t.verticalTextBox){let qt;$t.textBox&&(qt=Ho),$t.verticalTextBox&&(qt=Ea),it(rt.textCollisionBox.collisionVertexArray,es.text.placed,!Tt||qt,La.text,at.x,at.y)}}if($t.iconBox||$t.verticalIconBox){const Tt=Boolean(!Ea&&$t.verticalIconBox);let qt;$t.iconBox&&(qt=Tt),$t.verticalIconBox&&(qt=!Tt),it(rt.iconCollisionBox.collisionVertexArray,es.icon.placed,qt,La.icon,ds?at.x:0,ds?at.y:0)}}}}if(rt.sortFeatures(-this.transform.bearingInRadians),this.retainedQueryData[rt.bucketInstanceId]&&(this.retainedQueryData[rt.bucketInstanceId].featureSortOrder=rt.featureSortOrder),rt.hasTextData()&&rt.text.opacityVertexBuffer&&rt.text.opacityVertexBuffer.updateData(rt.text.opacityVertexArray),rt.hasIconData()&&rt.icon.opacityVertexBuffer&&rt.icon.opacityVertexBuffer.updateData(rt.icon.opacityVertexArray),rt.hasIconCollisionBoxData()&&rt.iconCollisionBox.collisionVertexBuffer&&rt.iconCollisionBox.collisionVertexBuffer.updateData(rt.iconCollisionBox.collisionVertexArray),rt.hasTextCollisionBoxData()&&rt.textCollisionBox.collisionVertexBuffer&&rt.textCollisionBox.collisionVertexBuffer.updateData(rt.textCollisionBox.collisionVertexArray),rt.text.opacityVertexArray.length!==rt.text.layoutVertexArray.length/4)throw new Error(`bucket.text.opacityVertexArray.length (= ${rt.text.opacityVertexArray.length}) !== bucket.text.layoutVertexArray.length (= ${rt.text.layoutVertexArray.length}) / 4`);if(rt.icon.opacityVertexArray.length!==rt.icon.layoutVertexArray.length/4)throw new Error(`bucket.icon.opacityVertexArray.length (= ${rt.icon.opacityVertexArray.length}) !== bucket.icon.layoutVertexArray.length (= ${rt.icon.layoutVertexArray.length}) / 4`);rt.bucketInstanceId in this.collisionCircleArrays&&(rt.collisionCircleArray=this.collisionCircleArrays[rt.bucketInstanceId],delete this.collisionCircleArrays[rt.bucketInstanceId])}symbolFadeChange(rt){return 0===this.fadeDuration?1:(rt-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(rt){return Math.max(0,(this.transform.zoom-rt)/1.5)}hasTransitions(rt){return this.stale||rt-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(rt,at){const Tt=this.zoomAtLastRecencyCheck===at?1-this.zoomAdjustment(at):1;return this.zoomAtLastRecencyCheck=at,this.commitTime+this.fadeDuration*Tt>rt}setStale(){this.stale=!0}}function it(rt,at,Tt,$t,qt,Kt){$t&&0!==$t.length||($t=[0,0,0,0]);const ge=$t[0]-Pl,Hr=$t[1]-Pl,wn=$t[2]-Pl,es=$t[3]-Pl;rt.emplaceBack(at?1:0,Tt?1:0,qt||0,Kt||0,ge,Hr),rt.emplaceBack(at?1:0,Tt?1:0,qt||0,Kt||0,wn,Hr),rt.emplaceBack(at?1:0,Tt?1:0,qt||0,Kt||0,wn,es),rt.emplaceBack(at?1:0,Tt?1:0,qt||0,Kt||0,ge,es)}const zl=Math.pow(2,25),Dl=Math.pow(2,24),Ll=Math.pow(2,17),Ol=Math.pow(2,16),jl=Math.pow(2,9),Nl=Math.pow(2,8),Zl=Math.pow(2,1);function ht(rt){if(0===rt.opacity&&!rt.placed)return 0;if(1===rt.opacity&&rt.placed)return 4294967295;const at=rt.placed?1:0,Tt=Math.floor(127*rt.opacity);return Tt*zl+at*Dl+Tt*Ll+at*Ol+Tt*jl+at*Nl+Tt*Zl+at}const Ul=0;class dt{constructor(rt){this._sortAcrossTiles="viewport-y"!==rt.layout.get("symbol-z-order")&&!rt.layout.get("symbol-sort-key").isConstant(),this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs={},this._bucketParts=[]}continuePlacement(rt,at,Tt,$t,qt){const Kt=this._bucketParts;for(;this._currentTileIndex<rt.length;)if(at.getBucketParts(Kt,$t,rt[this._currentTileIndex],this._sortAcrossTiles),this._currentTileIndex++,qt())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,Kt.sort(((rt,at)=>rt.sortKey-at.sortKey)));this._currentPartIndex<Kt.length;)if(at.placeLayerBucketPart(Kt[this._currentPartIndex],this._seenCrossTileIDs,Tt),this._currentPartIndex++,qt())return!0;return!1}}class _t{constructor(rt,at,Tt,$t,qt,Kt,ge,Hr){this.placement=new tt(rt,at,Kt,ge,Hr),this._currentPlacementIndex=Tt.length-1,this._forceFullPlacement=$t,this._showCollisionBoxes=qt,this._done=!1}isDone(){return this._done}continuePlacement(rt,at,Tt){const $t=ge.now(),o=()=>!this._forceFullPlacement&&ge.now()-$t>2;for(;this._currentPlacementIndex>=0;){const $t=at[rt[this._currentPlacementIndex]],qt=this.placement.collisionIndex.transform.zoom;if("symbol"===$t.type&&(!$t.minzoom||$t.minzoom<=qt)&&(!$t.maxzoom||$t.maxzoom>qt)){if(this._inProgressLayer||(this._inProgressLayer=new dt($t)),this._inProgressLayer.continuePlacement(Tt[$t.source],this.placement,this._showCollisionBoxes,$t,o))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(rt){return this.placement.commit(rt),this.placement}}const Gl=512/Tt.Z/2;class mt{constructor(rt,at,$t){this.tileID=rt,this.bucketInstanceId=$t,this._symbolsByKey={};const qt=new Map;for(let rt=0;rt<at.length;rt++){const Tt=at.get(rt),$t=Tt.key,Kt=qt.get($t);Kt?Kt.push(Tt):qt.set($t,[Tt])}for(const[rt,at]of qt){const $t={positions:at.map((rt=>({x:Math.floor(rt.anchorX*Gl),y:Math.floor(rt.anchorY*Gl)}))),crossTileIDs:at.map((rt=>rt.crossTileID))};if($t.positions.length>128){const rt=new Tt.aF($t.positions.length,16,Uint16Array);for(const{x:at,y:Tt}of $t.positions)rt.add(at,Tt);rt.finish(),delete $t.positions,$t.index=rt}this._symbolsByKey[rt]=$t}}getScaledCoordinates(rt,at){const{x:$t,y:qt,z:Kt}=this.tileID.canonical,{x:ge,y:Hr,z:wn}=at.canonical,es=Gl/Math.pow(2,wn-Kt),ss=(Hr*Tt.Z+rt.anchorY)*es,os=qt*Tt.Z*Gl;return{x:Math.floor((ge*Tt.Z+rt.anchorX)*es-$t*Tt.Z*Gl),y:Math.floor(ss-os)}}findMatches(rt,at,Tt){const $t=this.tileID.canonical.z<at.canonical.z?1:Math.pow(2,this.tileID.canonical.z-at.canonical.z);for(let qt=0;qt<rt.length;qt++){const Kt=rt.get(qt);if(Kt.crossTileID)continue;const ge=this._symbolsByKey[Kt.key];if(!ge)continue;const Hr=this.getScaledCoordinates(Kt,at);if(ge.index){const rt=ge.index.range(Hr.x-$t,Hr.y-$t,Hr.x+$t,Hr.y+$t).sort();for(const at of rt){const rt=ge.crossTileIDs[at];if(!Tt[rt]){Tt[rt]=!0,Kt.crossTileID=rt;break}}}else if(ge.positions)for(let rt=0;rt<ge.positions.length;rt++){const at=ge.positions[rt],qt=ge.crossTileIDs[rt];if(Math.abs(at.x-Hr.x)<=$t&&Math.abs(at.y-Hr.y)<=$t&&!Tt[qt]){Tt[qt]=!0,Kt.crossTileID=qt;break}}}}getCrossTileIDsLists(){return Object.values(this._symbolsByKey).map((({crossTileIDs:rt})=>rt))}}class ft{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class gt{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(rt){const at=Math.round((rt-this.lng)/360);if(0!==at)for(const rt in this.indexes){const Tt=this.indexes[rt],$t={};for(const rt in Tt){const qt=Tt[rt];qt.tileID=qt.tileID.unwrapTo(qt.tileID.wrap+at),$t[qt.tileID.key]=qt}this.indexes[rt]=$t}this.lng=rt}addBucket(rt,at,Tt){if(this.indexes[rt.overscaledZ]&&this.indexes[rt.overscaledZ][rt.key]){if(this.indexes[rt.overscaledZ][rt.key].bucketInstanceId===at.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(rt.overscaledZ,this.indexes[rt.overscaledZ][rt.key])}for(let rt=0;rt<at.symbolInstances.length;rt++)at.symbolInstances.get(rt).crossTileID=0;this.usedCrossTileIDs[rt.overscaledZ]||(this.usedCrossTileIDs[rt.overscaledZ]={});const $t=this.usedCrossTileIDs[rt.overscaledZ];for(const Tt in this.indexes){const qt=this.indexes[Tt];if(Number(Tt)>rt.overscaledZ)for(const Tt in qt){const Kt=qt[Tt];Kt.tileID.isChildOf(rt)&&Kt.findMatches(at.symbolInstances,rt,$t)}else{const Kt=qt[rt.scaledTo(Number(Tt)).key];Kt&&Kt.findMatches(at.symbolInstances,rt,$t)}}for(let rt=0;rt<at.symbolInstances.length;rt++){const qt=at.symbolInstances.get(rt);qt.crossTileID||(qt.crossTileID=Tt.generate(),$t[qt.crossTileID]=!0)}return void 0===this.indexes[rt.overscaledZ]&&(this.indexes[rt.overscaledZ]={}),this.indexes[rt.overscaledZ][rt.key]=new mt(rt,at.symbolInstances,at.bucketInstanceId),!0}removeBucketCrossTileIDs(rt,at){for(const Tt of at.getCrossTileIDsLists())for(const at of Tt)delete this.usedCrossTileIDs[rt][at]}removeStaleBuckets(rt){let at=!1;for(const Tt in this.indexes){const $t=this.indexes[Tt];for(const qt in $t)rt[$t[qt].bucketInstanceId]||(this.removeBucketCrossTileIDs(Tt,$t[qt]),delete $t[qt],at=!0)}return at}}class vt{constructor(){this.layerIndexes={},this.crossTileIDs=new ft,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(rt,at,Tt){let $t=this.layerIndexes[rt.id];void 0===$t&&($t=this.layerIndexes[rt.id]=new gt);let qt=!1;const Kt={};$t.handleWrapJump(Tt);for(const Tt of at){const at=Tt.getBucket(rt);at&&rt.id===at.layerIds[0]&&(at.bucketInstanceId||(at.bucketInstanceId=++this.maxBucketInstanceId),$t.addBucket(Tt.tileID,at,this.crossTileIDs)&&(qt=!0),Kt[at.bucketInstanceId]=!0)}return $t.removeStaleBuckets(Kt)&&(qt=!0),qt}pruneUnusedLayers(rt){const at={};rt.forEach((rt=>{at[rt]=!0}));for(const rt in this.layerIndexes)at[rt]||delete this.layerIndexes[rt]}}var ql="void main() {fragColor=vec4(1.0);}";const Hl={prelude:yt("#ifdef GL_ES\nprecision mediump float;\n#else\n#if !defined(lowp)\n#define lowp\n#endif\n#if !defined(mediump)\n#define mediump\n#endif\n#if !defined(highp)\n#define highp\n#endif\n#endif\nout highp vec4 fragColor;","#ifdef GL_ES\nprecision highp float;\n#else\n#if !defined(lowp)\n#define lowp\n#endif\n#if !defined(mediump)\n#define mediump\n#endif\n#if !defined(highp)\n#define highp\n#endif\n#endif\nvec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(unpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0\n);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (tile_units_to_pixels*pos+offset)/pattern_size;}mat3 rotationMatrixFromAxisAngle(vec3 u,float angle) {float c=cos(angle);float s=sin(angle);float c2=1.0-c;return mat3(u.x*u.x*c2+      c,u.x*u.y*c2-u.z*s,u.x*u.z*c2+u.y*s,u.y*u.x*c2+u.z*s,u.y*u.y*c2+    c,u.y*u.z*c2-u.x*s,u.z*u.x*c2-u.y*s,u.z*u.y*c2+u.x*s,u.z*u.z*c2+    c\n);}\n#ifdef TERRAIN3D\nuniform sampler2D u_terrain;uniform float u_terrain_dim;uniform mat4 u_terrain_matrix;uniform vec4 u_terrain_unpack;uniform float u_terrain_exaggeration;uniform highp sampler2D u_depth;\n#endif\nconst highp vec4 bitSh=vec4(256.*256.*256.,256.*256.,256.,1.);const highp vec4 bitShifts=vec4(1.)/bitSh;highp float unpack(highp vec4 color) {return dot(color,bitShifts);}highp float depthOpacity(vec3 frag) {\n#ifdef TERRAIN3D\nhighp float d=unpack(texture(u_depth,frag.xy*0.5+0.5))+0.0001-frag.z;return 1.0-max(0.0,min(1.0,-d*500.0));\n#else\nreturn 1.0;\n#endif\n}float calculate_visibility(vec4 pos) {\n#ifdef TERRAIN3D\nvec3 frag=pos.xyz/pos.w;highp float d=depthOpacity(frag);if (d > 0.95) return 1.0;return (d+depthOpacity(frag+vec3(0.0,0.01,0.0)))/2.0;\n#else\nreturn 1.0;\n#endif\n}float ele(vec2 pos) {\n#ifdef TERRAIN3D\nvec4 rgb=(texture(u_terrain,pos)*255.0)*u_terrain_unpack;return rgb.r+rgb.g+rgb.b-u_terrain_unpack.a;\n#else\nreturn 0.0;\n#endif\n}float get_elevation(vec2 pos) {\n#ifdef TERRAIN3D\n#ifdef GLOBE\nif ((pos.y <-32767.5) || (pos.y > 32766.5)) {return 0.0;}\n#endif\nvec2 coord=(u_terrain_matrix*vec4(pos,0.0,1.0)).xy*u_terrain_dim+1.0;vec2 f=fract(coord);vec2 c=(floor(coord)+0.5)/(u_terrain_dim+2.0);float d=1.0/(u_terrain_dim+2.0);float tl=ele(c);float tr=ele(c+vec2(d,0.0));float bl=ele(c+vec2(0.0,d));float br=ele(c+vec2(d,d));float elevation=mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);return elevation*u_terrain_exaggeration;\n#else\nreturn 0.0;\n#endif\n}const float PI=3.141592653589793;uniform mat4 u_projection_matrix;"),projectionMercator:yt("","float projectLineThickness(float tileY) {return 1.0;}float projectCircleRadius(float tileY) {return 1.0;}vec4 projectTile(vec2 p) {vec4 result=u_projection_matrix*vec4(p,0.0,1.0);return result;}vec4 projectTile(vec2 p,vec2 rawPos) {vec4 result=u_projection_matrix*vec4(p,0.0,1.0);if (rawPos.y <-32767.5 || rawPos.y > 32766.5) {result.z=-10000000.0;}return result;}vec4 projectTileWithElevation(vec2 posInTile,float elevation) {return u_projection_matrix*vec4(posInTile,elevation,1.0);}vec4 projectTileFor3D(vec2 posInTile,float elevation) {return projectTileWithElevation(posInTile,elevation);}"),projectionGlobe:yt("","#define GLOBE_RADIUS 6371008.8\nuniform highp vec4 u_projection_tile_mercator_coords;uniform highp vec4 u_projection_clipping_plane;uniform highp float u_projection_transition;uniform mat4 u_projection_fallback_matrix;vec3 globeRotateVector(vec3 vec,vec2 angles) {vec3 axisRight=vec3(vec.z,0.0,-vec.x);vec3 axisUp=cross(axisRight,vec);axisRight=normalize(axisRight);axisUp=normalize(axisUp);vec2 t=tan(angles);return normalize(vec+axisRight*t.x+axisUp*t.y);}mat3 globeGetRotationMatrix(vec3 spherePos) {vec3 axisRight=vec3(spherePos.z,0.0,-spherePos.x);vec3 axisDown=cross(axisRight,spherePos);axisRight=normalize(axisRight);axisDown=normalize(axisDown);return mat3(axisRight,axisDown,spherePos\n);}float circumferenceRatioAtTileY(float tileY) {float mercator_pos_y=u_projection_tile_mercator_coords.y+u_projection_tile_mercator_coords.w*tileY;float spherical_y=2.0*atan(exp(PI-(mercator_pos_y*PI*2.0)))-PI*0.5;return cos(spherical_y);}float projectLineThickness(float tileY) {float thickness=1.0/circumferenceRatioAtTileY(tileY); \nif (u_projection_transition < 0.999) {return mix(1.0,thickness,u_projection_transition);} else {return thickness;}}vec3 projectToSphere(vec2 translatedPos,vec2 rawPos) {vec2 mercator_pos=u_projection_tile_mercator_coords.xy+u_projection_tile_mercator_coords.zw*translatedPos;vec2 spherical;spherical.x=mercator_pos.x*PI*2.0+PI;spherical.y=2.0*atan(exp(PI-(mercator_pos.y*PI*2.0)))-PI*0.5;float len=cos(spherical.y);vec3 pos=vec3(sin(spherical.x)*len,sin(spherical.y),cos(spherical.x)*len\n);if (rawPos.y <-32767.5) {pos=vec3(0.0,1.0,0.0);}if (rawPos.y > 32766.5) {pos=vec3(0.0,-1.0,0.0);}return pos;}vec3 projectToSphere(vec2 posInTile) {return projectToSphere(posInTile,vec2(0.0,0.0));}float globeComputeClippingZ(vec3 spherePos) {return (1.0-(dot(spherePos,u_projection_clipping_plane.xyz)+u_projection_clipping_plane.w));}vec4 interpolateProjection(vec2 posInTile,vec3 spherePos,float elevation) {vec3 elevatedPos=spherePos*(1.0+elevation/GLOBE_RADIUS);vec4 globePosition=u_projection_matrix*vec4(elevatedPos,1.0);globePosition.z=globeComputeClippingZ(elevatedPos)*globePosition.w;if (u_projection_transition > 0.999) {return globePosition;}vec4 flatPosition=u_projection_fallback_matrix*vec4(posInTile,elevation,1.0);const float z_globeness_threshold=0.2;vec4 result=globePosition;result.z=mix(0.0,globePosition.z,clamp((u_projection_transition-z_globeness_threshold)/(1.0-z_globeness_threshold),0.0,1.0));result.xyw=mix(flatPosition.xyw,globePosition.xyw,u_projection_transition);if ((posInTile.y <-32767.5) || (posInTile.y > 32766.5)) {result=globePosition;const float poles_hidden_anim_percentage=0.02;result.z=mix(globePosition.z,100.0,pow(max((1.0-u_projection_transition)/poles_hidden_anim_percentage,0.0),8.0));}return result;}vec4 interpolateProjectionFor3D(vec2 posInTile,vec3 spherePos,float elevation) {vec3 elevatedPos=spherePos*(1.0+elevation/GLOBE_RADIUS);vec4 globePosition=u_projection_matrix*vec4(elevatedPos,1.0);if (u_projection_transition > 0.999) {return globePosition;}vec4 fallbackPosition=u_projection_fallback_matrix*vec4(posInTile,elevation,1.0);return mix(fallbackPosition,globePosition,u_projection_transition);}vec4 projectTile(vec2 posInTile) {return interpolateProjection(posInTile,projectToSphere(posInTile),0.0);}vec4 projectTile(vec2 posInTile,vec2 rawPos) {return interpolateProjection(posInTile,projectToSphere(posInTile,rawPos),0.0);}vec4 projectTileWithElevation(vec2 posInTile,float elevation) {return interpolateProjection(posInTile,projectToSphere(posInTile),elevation);}vec4 projectTileFor3D(vec2 posInTile,float elevation) {vec3 spherePos=projectToSphere(posInTile,posInTile);return interpolateProjectionFor3D(posInTile,spherePos,elevation);}"),background:yt("uniform vec4 u_color;uniform float u_opacity;void main() {fragColor=u_color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\nfragColor=vec4(1.0);\n#endif\n}","in vec2 a_pos;void main() {gl_Position=projectTile(a_pos);}"),backgroundPattern:yt("uniform vec2 u_pattern_tl_a;uniform vec2 u_pattern_br_a;uniform vec2 u_pattern_tl_b;uniform vec2 u_pattern_br_b;uniform vec2 u_texsize;uniform float u_mix;uniform float u_opacity;uniform sampler2D u_image;in vec2 v_pos_a;in vec2 v_pos_b;void main() {vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(u_pattern_tl_a/u_texsize,u_pattern_br_a/u_texsize,imagecoord);vec4 color1=texture(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(u_pattern_tl_b/u_texsize,u_pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture(u_image,pos2);fragColor=mix(color1,color2,u_mix)*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\nfragColor=vec4(1.0);\n#endif\n}","uniform vec2 u_pattern_size_a;uniform vec2 u_pattern_size_b;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_scale_a;uniform float u_scale_b;uniform float u_tile_units_to_pixels;in vec2 a_pos;out vec2 v_pos_a;out vec2 v_pos_b;void main() {gl_Position=projectTile(a_pos);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_a*u_pattern_size_a,u_tile_units_to_pixels,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_b*u_pattern_size_b,u_tile_units_to_pixels,a_pos);}"),circle:yt("in vec3 v_data;in float v_visibility;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump float radius\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp vec4 stroke_color\n#pragma mapbox: define mediump float stroke_width\n#pragma mapbox: define lowp float stroke_opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump float radius\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp vec4 stroke_color\n#pragma mapbox: initialize mediump float stroke_width\n#pragma mapbox: initialize lowp float stroke_opacity\nvec2 extrude=v_data.xy;float extrude_length=length(extrude);float antialiased_blur=v_data.z;float opacity_t=smoothstep(0.0,antialiased_blur,extrude_length-1.0);float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(antialiased_blur,0.0,extrude_length-radius/(radius+stroke_width));fragColor=v_visibility*opacity_t*mix(color*opacity,stroke_color*stroke_opacity,color_t);const float epsilon=0.5/255.0;if (fragColor.r < epsilon && fragColor.g < epsilon && fragColor.b < epsilon && fragColor.a < epsilon) {discard;}\n#ifdef OVERDRAW_INSPECTOR\nfragColor=vec4(1.0);\n#endif\n}","uniform bool u_scale_with_map;uniform bool u_pitch_with_map;uniform vec2 u_extrude_scale;uniform highp float u_globe_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;uniform vec2 u_translate;in vec2 a_pos;out vec3 v_data;out float v_visibility;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump float radius\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp vec4 stroke_color\n#pragma mapbox: define mediump float stroke_width\n#pragma mapbox: define lowp float stroke_opacity\nvoid main(void) {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump float radius\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp vec4 stroke_color\n#pragma mapbox: initialize mediump float stroke_width\n#pragma mapbox: initialize lowp float stroke_opacity\nvec2 pos_raw=a_pos+32768.0;vec2 extrude=vec2(mod(pos_raw,8.0)/7.0*2.0-1.0);vec2 circle_center=floor(pos_raw/8.0)+u_translate;float ele=get_elevation(circle_center);v_visibility=calculate_visibility(projectTileWithElevation(circle_center,ele));if (u_pitch_with_map) {\n#ifdef GLOBE\nvec3 center_vector=projectToSphere(circle_center);\n#endif\nfloat angle_scale=u_globe_extrude_scale;vec2 corner_position=circle_center;if (u_scale_with_map) {angle_scale*=(radius+stroke_width);corner_position+=extrude*u_extrude_scale*(radius+stroke_width);} else {\n#ifdef GLOBE\nvec4 projected_center=interpolateProjection(circle_center,center_vector,ele);\n#else\nvec4 projected_center=projectTileWithElevation(circle_center,ele);\n#endif\ncorner_position+=extrude*u_extrude_scale*(radius+stroke_width)*(projected_center.w/u_camera_to_center_distance);angle_scale*=(radius+stroke_width)*(projected_center.w/u_camera_to_center_distance);}\n#ifdef GLOBE\nvec2 angles=extrude*angle_scale;vec3 corner_vector=globeRotateVector(center_vector,angles);gl_Position=interpolateProjection(corner_position,corner_vector,ele);\n#else\ngl_Position=projectTileWithElevation(corner_position,ele);\n#endif\n} else {gl_Position=projectTileWithElevation(circle_center,ele);if (gl_Position.z/gl_Position.w > 1.0) {gl_Position.xy=vec2(10000.0);}if (u_scale_with_map) {gl_Position.xy+=extrude*(radius+stroke_width)*u_extrude_scale*u_camera_to_center_distance;} else {gl_Position.xy+=extrude*(radius+stroke_width)*u_extrude_scale*gl_Position.w;}}float antialiasblur=-max(1.0/u_device_pixel_ratio/(radius+stroke_width),blur);v_data=vec3(extrude.x,extrude.y,antialiasblur);}"),clippingMask:yt(ql,"in vec2 a_pos;void main() {gl_Position=projectTile(a_pos);}"),heatmap:yt("uniform highp float u_intensity;in vec2 v_extrude;\n#pragma mapbox: define highp float weight\n#define GAUSS_COEF 0.3989422804014327\nvoid main() {\n#pragma mapbox: initialize highp float weight\nfloat d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);fragColor=vec4(val,1.0,1.0,1.0);\n#ifdef OVERDRAW_INSPECTOR\nfragColor=vec4(1.0);\n#endif\n}","uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;uniform highp float u_globe_extrude_scale;in vec2 a_pos;out vec2 v_extrude;\n#pragma mapbox: define highp float weight\n#pragma mapbox: define mediump float radius\nconst highp float ZERO=1.0/255.0/16.0;\n#define GAUSS_COEF 0.3989422804014327\nvoid main(void) {\n#pragma mapbox: initialize highp float weight\n#pragma mapbox: initialize mediump float radius\nvec2 pos_raw=a_pos+32768.0;vec2 unscaled_extrude=vec2(mod(pos_raw,8.0)/7.0*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 circle_center=floor(pos_raw/8.0);\n#ifdef GLOBE\nvec2 angles=v_extrude*radius*u_globe_extrude_scale;vec3 center_vector=projectToSphere(circle_center);vec3 corner_vector=globeRotateVector(center_vector,angles);gl_Position=interpolateProjection(circle_center+extrude,corner_vector,0.0);\n#else\ngl_Position=projectTileFor3D(circle_center+extrude,get_elevation(circle_center));\n#endif\n}"),heatmapTexture:yt("uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;in vec2 v_pos;void main() {float t=texture(u_image,v_pos).r;vec4 color=texture(u_color_ramp,vec2(t,0.5));fragColor=color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\nfragColor=vec4(0.0);\n#endif\n}","uniform mat4 u_matrix;uniform vec2 u_world;in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos*u_world,0,1);v_pos.x=a_pos.x;v_pos.y=1.0-a_pos.y;}"),collisionBox:yt("in float v_placed;in float v_notUsed;void main() {float alpha=0.5;fragColor=vec4(1.0,0.0,0.0,1.0)*alpha;if (v_placed > 0.5) {fragColor=vec4(0.0,0.0,1.0,0.5)*alpha;}if (v_notUsed > 0.5) {fragColor*=.1;}}","in vec2 a_anchor_pos;in vec2 a_placed;in vec2 a_box_real;uniform vec2 u_pixel_extrude_scale;out float v_placed;out float v_notUsed;void main() {gl_Position=projectTileWithElevation(a_anchor_pos,get_elevation(a_anchor_pos));gl_Position.xy=((a_box_real+0.5)*u_pixel_extrude_scale*2.0-1.0)*vec2(1.0,-1.0)*gl_Position.w;if (gl_Position.z/gl_Position.w < 1.1) {gl_Position.z=0.5;}v_placed=a_placed.x;v_notUsed=a_placed.y;}"),collisionCircle:yt("in float v_radius;in vec2 v_extrude;in float v_collision;void main() {float alpha=0.5;float stroke_radius=0.9;float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);fragColor=color*alpha*opacity_t;}","in vec2 a_pos;in float a_radius;in vec2 a_flags;uniform vec2 u_viewport_size;out float v_radius;out vec2 v_extrude;out float v_collision;void main() {float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(mix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_collision=collision;gl_Position=vec4((a_pos/u_viewport_size*2.0-1.0)*vec2(1.0,-1.0),0.0,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}"),debug:yt("uniform highp vec4 u_color;uniform sampler2D u_overlay;in vec2 v_uv;void main() {vec4 overlay_color=texture(u_overlay,v_uv);fragColor=mix(u_color,overlay_color,overlay_color.a);}","in vec2 a_pos;out vec2 v_uv;uniform float u_overlay_scale;void main() {v_uv=a_pos/8192.0;gl_Position=projectTileWithElevation(a_pos*u_overlay_scale,get_elevation(a_pos));}"),depth:yt(ql,"in vec2 a_pos;void main() {\n#ifdef GLOBE\ngl_Position=projectTileFor3D(a_pos,0.0);\n#else\ngl_Position=u_projection_matrix*vec4(a_pos,0.0,1.0);\n#endif\n}"),fill:yt("#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float opacity\nfragColor=color*opacity;\n#ifdef OVERDRAW_INSPECTOR\nfragColor=vec4(1.0);\n#endif\n}","uniform vec2 u_fill_translate;in vec2 a_pos;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float opacity\ngl_Position=projectTile(a_pos+u_fill_translate,a_pos);}"),fillOutline:yt("in vec2 v_pos;\n#ifdef GLOBE\nin float v_depth;\n#endif\n#pragma mapbox: define highp vec4 outline_color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 outline_color\n#pragma mapbox: initialize lowp float opacity\nfloat dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);fragColor=outline_color*(alpha*opacity);\n#ifdef GLOBE\nif (v_depth > 1.0) {discard;}\n#endif\n#ifdef OVERDRAW_INSPECTOR\nfragColor=vec4(1.0);\n#endif\n}","uniform vec2 u_world;uniform vec2 u_fill_translate;in vec2 a_pos;out vec2 v_pos;\n#ifdef GLOBE\nout float v_depth;\n#endif\n#pragma mapbox: define highp vec4 outline_color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 outline_color\n#pragma mapbox: initialize lowp float opacity\ngl_Position=projectTile(a_pos+u_fill_translate,a_pos);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;\n#ifdef GLOBE\nv_depth=gl_Position.z/gl_Position.w;\n#endif\n}"),fillOutlinePattern:yt("uniform vec2 u_texsize;uniform sampler2D u_image;uniform float u_fade;in vec2 v_pos_a;in vec2 v_pos_b;in vec2 v_pos;\n#ifdef GLOBE\nin float v_depth;\n#endif\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern_from\n#pragma mapbox: define lowp vec4 pattern_to\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern_from\n#pragma mapbox: initialize mediump vec4 pattern_to\nvec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture(u_image,pos2);float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);fragColor=mix(color1,color2,u_fade)*alpha*opacity;\n#ifdef GLOBE\nif (v_depth > 1.0) {discard;}\n#endif\n#ifdef OVERDRAW_INSPECTOR\nfragColor=vec4(1.0);\n#endif\n}","uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec3 u_scale;uniform vec2 u_fill_translate;in vec2 a_pos;out vec2 v_pos_a;out vec2 v_pos_b;out vec2 v_pos;\n#ifdef GLOBE\nout float v_depth;\n#endif\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern_from\n#pragma mapbox: define lowp vec4 pattern_to\n#pragma mapbox: define lowp float pixel_ratio_from\n#pragma mapbox: define lowp float pixel_ratio_to\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern_from\n#pragma mapbox: initialize mediump vec4 pattern_to\n#pragma mapbox: initialize lowp float pixel_ratio_from\n#pragma mapbox: initialize lowp float pixel_ratio_to\nvec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;gl_Position=projectTile(a_pos+u_fill_translate,a_pos);vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileRatio,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileRatio,a_pos);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;\n#ifdef GLOBE\nv_depth=gl_Position.z/gl_Position.w;\n#endif\n}"),fillPattern:yt("#ifdef GL_ES\nprecision highp float;\n#endif\nuniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;in vec2 v_pos_a;in vec2 v_pos_b;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern_from\n#pragma mapbox: define lowp vec4 pattern_to\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern_from\n#pragma mapbox: initialize mediump vec4 pattern_to\nvec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture(u_image,pos2);fragColor=mix(color1,color2,u_fade)*opacity;\n#ifdef OVERDRAW_INSPECTOR\nfragColor=vec4(1.0);\n#endif\n}","uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec3 u_scale;uniform vec2 u_fill_translate;in vec2 a_pos;out vec2 v_pos_a;out vec2 v_pos_b;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern_from\n#pragma mapbox: define lowp vec4 pattern_to\n#pragma mapbox: define lowp float pixel_ratio_from\n#pragma mapbox: define lowp float pixel_ratio_to\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern_from\n#pragma mapbox: initialize mediump vec4 pattern_to\n#pragma mapbox: initialize lowp float pixel_ratio_from\n#pragma mapbox: initialize lowp float pixel_ratio_to\nvec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;gl_Position=projectTile(a_pos+u_fill_translate,a_pos);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileZoomRatio,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileZoomRatio,a_pos);}"),fillExtrusion:yt("in vec4 v_color;void main() {fragColor=v_color;\n#ifdef OVERDRAW_INSPECTOR\nfragColor=vec4(1.0);\n#endif\n}","uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp vec3 u_lightpos_globe;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform vec2 u_fill_translate;in vec2 a_pos;in vec4 a_normal_ed;\n#ifdef TERRAIN3D\nin vec2 a_centroid;\n#endif\nout vec4 v_color;\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define highp vec4 color\nvoid main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize highp vec4 color\nvec3 normal=a_normal_ed.xyz;\n#ifdef TERRAIN3D\nfloat height_terrain3d_offset=get_elevation(a_centroid);float base_terrain3d_offset=height_terrain3d_offset-(base > 0.0 ? 0.0 : 10.0);\n#else\nfloat height_terrain3d_offset=0.0;float base_terrain3d_offset=0.0;\n#endif\nbase=max(0.0,base)+base_terrain3d_offset;height=max(0.0,height)+height_terrain3d_offset;float t=mod(normal.x,2.0);float elevation=t > 0.0 ? height : base;vec2 posInTile=a_pos+u_fill_translate;\n#ifdef GLOBE\nvec3 spherePos=projectToSphere(posInTile,a_pos);gl_Position=interpolateProjectionFor3D(posInTile,spherePos,elevation);\n#else\ngl_Position=u_projection_matrix*vec4(posInTile,elevation,1.0);\n#endif\nfloat colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;v_color=vec4(0.0,0.0,0.0,1.0);vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;vec3 normalForLighting=normal/16384.0;float directional=clamp(dot(normalForLighting,u_lightpos),0.0,1.0);\n#ifdef GLOBE\nmat3 rotMatrix=globeGetRotationMatrix(spherePos);normalForLighting=rotMatrix*normalForLighting;directional=mix(directional,clamp(dot(normalForLighting,u_lightpos_globe),0.0,1.0),u_projection_transition);\n#endif\ndirectional=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),directional);if (normal.y !=0.0) {directional*=((1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0)));}v_color.r+=clamp(color.r*directional*u_lightcolor.r,mix(0.0,0.3,1.0-u_lightcolor.r),1.0);v_color.g+=clamp(color.g*directional*u_lightcolor.g,mix(0.0,0.3,1.0-u_lightcolor.g),1.0);v_color.b+=clamp(color.b*directional*u_lightcolor.b,mix(0.0,0.3,1.0-u_lightcolor.b),1.0);v_color*=u_opacity;}"),fillExtrusionPattern:yt("uniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;in vec2 v_pos_a;in vec2 v_pos_b;in vec4 v_lighting;\n#pragma mapbox: define lowp float base\n#pragma mapbox: define lowp float height\n#pragma mapbox: define lowp vec4 pattern_from\n#pragma mapbox: define lowp vec4 pattern_to\n#pragma mapbox: define lowp float pixel_ratio_from\n#pragma mapbox: define lowp float pixel_ratio_to\nvoid main() {\n#pragma mapbox: initialize lowp float base\n#pragma mapbox: initialize lowp float height\n#pragma mapbox: initialize mediump vec4 pattern_from\n#pragma mapbox: initialize mediump vec4 pattern_to\n#pragma mapbox: initialize lowp float pixel_ratio_from\n#pragma mapbox: initialize lowp float pixel_ratio_to\nvec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture(u_image,pos2);vec4 mixedColor=mix(color1,color2,u_fade);fragColor=mixedColor*v_lighting;\n#ifdef OVERDRAW_INSPECTOR\nfragColor=vec4(1.0);\n#endif\n}","uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform vec3 u_scale;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform vec2 u_fill_translate;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp vec3 u_lightpos_globe;uniform lowp float u_lightintensity;in vec2 a_pos;in vec4 a_normal_ed;\n#ifdef TERRAIN3D\nin vec2 a_centroid;\n#endif\n#ifdef GLOBE\nout vec3 v_sphere_pos;\n#endif\nout vec2 v_pos_a;out vec2 v_pos_b;out vec4 v_lighting;\n#pragma mapbox: define lowp float base\n#pragma mapbox: define lowp float height\n#pragma mapbox: define lowp vec4 pattern_from\n#pragma mapbox: define lowp vec4 pattern_to\n#pragma mapbox: define lowp float pixel_ratio_from\n#pragma mapbox: define lowp float pixel_ratio_to\nvoid main() {\n#pragma mapbox: initialize lowp float base\n#pragma mapbox: initialize lowp float height\n#pragma mapbox: initialize mediump vec4 pattern_from\n#pragma mapbox: initialize mediump vec4 pattern_to\n#pragma mapbox: initialize lowp float pixel_ratio_from\n#pragma mapbox: initialize lowp float pixel_ratio_to\nvec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec3 normal=a_normal_ed.xyz;float edgedistance=a_normal_ed.w;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;\n#ifdef TERRAIN3D\nfloat height_terrain3d_offset=get_elevation(a_centroid);float base_terrain3d_offset=height_terrain3d_offset-(base > 0.0 ? 0.0 : 10.0);\n#else\nfloat height_terrain3d_offset=0.0;float base_terrain3d_offset=0.0;\n#endif\nbase=max(0.0,base)+base_terrain3d_offset;height=max(0.0,height)+height_terrain3d_offset;float t=mod(normal.x,2.0);float elevation=t > 0.0 ? height : base;vec2 posInTile=a_pos+u_fill_translate;\n#ifdef GLOBE\nvec3 spherePos=projectToSphere(posInTile,a_pos);vec3 elevatedPos=spherePos*(1.0+elevation/GLOBE_RADIUS);v_sphere_pos=elevatedPos;gl_Position=interpolateProjectionFor3D(posInTile,spherePos,elevation);\n#else\ngl_Position=u_projection_matrix*vec4(posInTile,elevation,1.0);\n#endif\nvec2 pos=normal.x==1.0 && normal.y==0.0 && normal.z==16384.0\n? a_pos\n: vec2(edgedistance,elevation*u_height_factor);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileRatio,pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileRatio,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float directional=clamp(dot(normal/16383.0,u_lightpos),0.0,1.0);directional=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),directional);if (normal.y !=0.0) {directional*=((1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0)));}v_lighting.rgb+=clamp(directional*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;}"),hillshadePrepare:yt("#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;uniform vec4 u_unpack;float getElevation(vec2 coord,float bias) {vec4 data=texture(u_image,coord)*255.0;data.a=-1.0;return dot(data,u_unpack)/4.0;}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y),0.0);float b=getElevation(v_pos+vec2(0,-epsilon.y),0.0);float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y),0.0);float d=getElevation(v_pos+vec2(-epsilon.x,0),0.0);float e=getElevation(v_pos,0.0);float f=getElevation(v_pos+vec2(epsilon.x,0),0.0);float g=getElevation(v_pos+vec2(-epsilon.x,epsilon.y),0.0);float h=getElevation(v_pos+vec2(0,epsilon.y),0.0);float i=getElevation(v_pos+vec2(epsilon.x,epsilon.y),0.0);float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2((c+f+f+i)-(a+d+d+g),(g+h+h+i)-(a+b+b+c))/pow(2.0,exaggeration+(19.2562-u_zoom));fragColor=clamp(vec4(deriv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);\n#ifdef OVERDRAW_INSPECTOR\nfragColor=vec4(1.0);\n#endif\n}","uniform mat4 u_matrix;uniform vec2 u_dimension;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:yt("uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;\n#define PI 3.141592653589793\nvoid main() {vec4 pixel=texture(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);fragColor=accent_color*(1.0-shade_color.a)+shade_color;\n#ifdef OVERDRAW_INSPECTOR\nfragColor=vec4(1.0);\n#endif\n}","uniform mat4 u_matrix;in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=projectTile(a_pos,a_pos);v_pos=a_pos/8192.0;if (a_pos.y <-32767.5) {v_pos.y=0.0;}if (a_pos.y > 32766.5) {v_pos.y=1.0;}}"),line:yt("uniform lowp float u_device_pixel_ratio;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;\n#ifdef GLOBE\nin float v_depth;\n#endif\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\nfloat dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);fragColor=color*(alpha*opacity);\n#ifdef GLOBE\nif (v_depth > 1.0) {discard;}\n#endif\n#ifdef OVERDRAW_INSPECTOR\nfragColor=vec4(1.0);\n#endif\n}","\n#define scale 0.015873016\nin vec2 a_pos_normal;in vec4 a_data;uniform vec2 u_translation;uniform mediump float u_ratio;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;out vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp float v_linesofar;\n#ifdef GLOBE\nout float v_depth;\n#endif\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define lowp float offset\n#pragma mapbox: define mediump float width\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize lowp float offset\n#pragma mapbox: initialize mediump float width\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;v_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*2.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float adjustedThickness=projectLineThickness(pos.y);vec4 projected_no_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation);vec4 projected_with_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation+dist/u_ratio*adjustedThickness);gl_Position=projected_with_extrude;\n#ifdef GLOBE\nv_depth=gl_Position.z/gl_Position.w;\n#endif\n#ifdef TERRAIN3D\nv_gamma_scale=1.0;\n#else\nfloat extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length((projected_with_extrude.xy-projected_no_extrude.xy)/projected_with_extrude.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;\n#endif\nv_width2=vec2(outset,inset);}"),lineGradient:yt("uniform lowp float u_device_pixel_ratio;uniform sampler2D u_image;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;in highp vec2 v_uv;\n#ifdef GLOBE\nin float v_depth;\n#endif\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\nfloat dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);vec4 color=texture(u_image,v_uv);fragColor=color*(alpha*opacity);\n#ifdef GLOBE\nif (v_depth > 1.0) {discard;}\n#endif\n#ifdef OVERDRAW_INSPECTOR\nfragColor=vec4(1.0);\n#endif\n}","\n#define scale 0.015873016\nin vec2 a_pos_normal;in vec4 a_data;in float a_uv_x;in float a_split_index;uniform vec2 u_translation;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;uniform vec2 u_units_to_pixels;uniform float u_image_height;out vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp vec2 v_uv;\n#ifdef GLOBE\nout float v_depth;\n#endif\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define lowp float offset\n#pragma mapbox: define mediump float width\nvoid main() {\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize lowp float offset\n#pragma mapbox: initialize mediump float width\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;highp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec2(a_uv_x,a_split_index*texel_height-half_texel_height);vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float adjustedThickness=projectLineThickness(pos.y);vec4 projected_no_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation);vec4 projected_with_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation+dist/u_ratio*adjustedThickness);gl_Position=projected_with_extrude;\n#ifdef GLOBE\nv_depth=gl_Position.z/gl_Position.w;\n#endif\n#ifdef TERRAIN3D\nv_gamma_scale=1.0;\n#else\nfloat extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length((projected_with_extrude.xy-projected_no_extrude.xy)/projected_with_extrude.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;\n#endif\nv_width2=vec2(outset,inset);}"),linePattern:yt("#ifdef GL_ES\nprecision highp float;\n#endif\nuniform lowp float u_device_pixel_ratio;uniform vec2 u_texsize;uniform float u_fade;uniform mediump vec3 u_scale;uniform sampler2D u_image;in vec2 v_normal;in vec2 v_width2;in float v_linesofar;in float v_gamma_scale;in float v_width;\n#ifdef GLOBE\nin float v_depth;\n#endif\n#pragma mapbox: define lowp vec4 pattern_from\n#pragma mapbox: define lowp vec4 pattern_to\n#pragma mapbox: define lowp float pixel_ratio_from\n#pragma mapbox: define lowp float pixel_ratio_to\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize mediump vec4 pattern_from\n#pragma mapbox: initialize mediump vec4 pattern_to\n#pragma mapbox: initialize lowp float pixel_ratio_from\n#pragma mapbox: initialize lowp float pixel_ratio_to\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\nvec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;vec2 pattern_size_a=vec2(display_size_a.x*fromScale/tileZoomRatio,display_size_a.y);vec2 pattern_size_b=vec2(display_size_b.x*toScale/tileZoomRatio,display_size_b.y);float aspect_a=display_size_a.y/v_width;float aspect_b=display_size_b.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float x_a=mod(v_linesofar/pattern_size_a.x*aspect_a,1.0);float x_b=mod(v_linesofar/pattern_size_b.x*aspect_b,1.0);float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;vec2 pos_a=mix(pattern_tl_a*texel_size-texel_size,pattern_br_a*texel_size+texel_size,vec2(x_a,y));vec2 pos_b=mix(pattern_tl_b*texel_size-texel_size,pattern_br_b*texel_size+texel_size,vec2(x_b,y));vec4 color=mix(texture(u_image,pos_a),texture(u_image,pos_b),u_fade);fragColor=color*alpha*opacity;\n#ifdef GLOBE\nif (v_depth > 1.0) {discard;}\n#endif\n#ifdef OVERDRAW_INSPECTOR\nfragColor=vec4(1.0);\n#endif\n}","\n#define scale 0.015873016\n#define LINE_DISTANCE_SCALE 2.0\nin vec2 a_pos_normal;in vec4 a_data;uniform vec2 u_translation;uniform vec2 u_units_to_pixels;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;out vec2 v_normal;out vec2 v_width2;out float v_linesofar;out float v_gamma_scale;out float v_width;\n#ifdef GLOBE\nout float v_depth;\n#endif\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float offset\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define mediump float width\n#pragma mapbox: define lowp float floorwidth\n#pragma mapbox: define lowp vec4 pattern_from\n#pragma mapbox: define lowp vec4 pattern_to\n#pragma mapbox: define lowp float pixel_ratio_from\n#pragma mapbox: define lowp float pixel_ratio_to\nvoid main() {\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float offset\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize mediump float width\n#pragma mapbox: initialize lowp float floorwidth\n#pragma mapbox: initialize mediump vec4 pattern_from\n#pragma mapbox: initialize mediump vec4 pattern_to\n#pragma mapbox: initialize lowp float pixel_ratio_from\n#pragma mapbox: initialize lowp float pixel_ratio_to\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;float a_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*LINE_DISTANCE_SCALE;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float adjustedThickness=projectLineThickness(pos.y);vec4 projected_no_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation);vec4 projected_with_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation+dist/u_ratio*adjustedThickness);gl_Position=projected_with_extrude;\n#ifdef GLOBE\nv_depth=gl_Position.z/gl_Position.w;\n#endif\n#ifdef TERRAIN3D\nv_gamma_scale=1.0;\n#else\nfloat extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length((projected_with_extrude.xy-projected_no_extrude.xy)/projected_with_extrude.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;\n#endif\nv_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=floorwidth;}"),lineSDF:yt("uniform lowp float u_device_pixel_ratio;uniform sampler2D u_image;uniform float u_sdfgamma;uniform float u_mix;in vec2 v_normal;in vec2 v_width2;in vec2 v_tex_a;in vec2 v_tex_b;in float v_gamma_scale;\n#ifdef GLOBE\nin float v_depth;\n#endif\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define mediump float width\n#pragma mapbox: define lowp float floorwidth\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump float width\n#pragma mapbox: initialize lowp float floorwidth\nfloat dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float sdfdist_a=texture(u_image,v_tex_a).a;float sdfdist_b=texture(u_image,v_tex_b).a;float sdfdist=mix(sdfdist_a,sdfdist_b,u_mix);alpha*=smoothstep(0.5-u_sdfgamma/floorwidth,0.5+u_sdfgamma/floorwidth,sdfdist);fragColor=color*(alpha*opacity);\n#ifdef GLOBE\nif (v_depth > 1.0) {discard;}\n#endif\n#ifdef OVERDRAW_INSPECTOR\nfragColor=vec4(1.0);\n#endif\n}","\n#define scale 0.015873016\n#define LINE_DISTANCE_SCALE 2.0\nin vec2 a_pos_normal;in vec4 a_data;uniform vec2 u_translation;uniform mediump float u_ratio;uniform lowp float u_device_pixel_ratio;uniform vec2 u_patternscale_a;uniform float u_tex_y_a;uniform vec2 u_patternscale_b;uniform float u_tex_y_b;uniform vec2 u_units_to_pixels;out vec2 v_normal;out vec2 v_width2;out vec2 v_tex_a;out vec2 v_tex_b;out float v_gamma_scale;\n#ifdef GLOBE\nout float v_depth;\n#endif\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define lowp float offset\n#pragma mapbox: define mediump float width\n#pragma mapbox: define lowp float floorwidth\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize lowp float offset\n#pragma mapbox: initialize mediump float width\n#pragma mapbox: initialize lowp float floorwidth\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;float a_linesofar=(floor(a_data.z/4.0)+a_data.w*64.0)*LINE_DISTANCE_SCALE;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float adjustedThickness=projectLineThickness(pos.y);vec4 projected_no_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation);vec4 projected_with_extrude=projectTile(pos+offset2/u_ratio*adjustedThickness+u_translation+dist/u_ratio*adjustedThickness);gl_Position=projected_with_extrude;\n#ifdef GLOBE\nv_depth=gl_Position.z/gl_Position.w;\n#endif\n#ifdef TERRAIN3D\nv_gamma_scale=1.0;\n#else\nfloat extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length((projected_with_extrude.xy-projected_no_extrude.xy)/projected_with_extrude.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;\n#endif\nv_tex_a=vec2(a_linesofar*u_patternscale_a.x/floorwidth,normal.y*u_patternscale_a.y+u_tex_y_a);v_tex_b=vec2(a_linesofar*u_patternscale_b.x/floorwidth,normal.y*u_patternscale_b.y+u_tex_y_b);v_width2=vec2(outset,inset);}"),raster:yt("uniform float u_fade_t;uniform float u_opacity;uniform sampler2D u_image0;uniform sampler2D u_image1;in vec2 v_pos0;in vec2 v_pos1;uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;void main() {vec4 color0=texture(u_image0,v_pos0);vec4 color1=texture(u_image1,v_pos1);if (color0.a > 0.0) {color0.rgb=color0.rgb/color0.a;}if (color1.a > 0.0) {color1.rgb=color1.rgb/color1.a;}vec4 color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 rgb=color.rgb;rgb=vec3(dot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);fragColor=vec4(mix(u_high_vec,u_low_vec,rgb)*color.a,color.a);\n#ifdef OVERDRAW_INSPECTOR\nfragColor=vec4(1.0);\n#endif\n}","uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_buffer_scale;uniform vec4 u_coords_top;uniform vec4 u_coords_bottom;in vec2 a_pos;out vec2 v_pos0;out vec2 v_pos1;void main() {vec2 fractionalPos=a_pos/8192.0;vec2 position=mix(mix(u_coords_top.xy,u_coords_top.zw,fractionalPos.x),mix(u_coords_bottom.xy,u_coords_bottom.zw,fractionalPos.x),fractionalPos.y);gl_Position=projectTile(position,position);v_pos0=((fractionalPos-0.5)/u_buffer_scale)+0.5;\n#ifdef GLOBE\nif (a_pos.y <-32767.5) {v_pos0.y=0.0;}if (a_pos.y > 32766.5) {v_pos0.y=1.0;}\n#endif\nv_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}"),symbolIcon:yt("uniform sampler2D u_texture;in vec2 v_tex;in float v_fade_opacity;\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\nlowp float alpha=opacity*v_fade_opacity;fragColor=texture(u_texture,v_tex)*alpha;\n#ifdef OVERDRAW_INSPECTOR\nfragColor=vec4(1.0);\n#endif\n}","in vec4 a_pos_offset;in vec4 a_data;in vec4 a_pixeloffset;in vec3 a_projected_pos;in float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform highp float u_camera_to_center_distance;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform float u_fade_change;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform vec2 u_texsize;uniform bool u_is_along_line;uniform bool u_is_variable_anchor;uniform vec2 u_translation;uniform float u_pitched_scale;out vec2 v_tex;out float v_fade_opacity;\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\nvec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_minFontScale=a_pixeloffset.zw/256.0;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 translated_a_pos=a_pos+u_translation;vec4 projectedPoint=projectTileWithElevation(translated_a_pos,ele);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?\ncamera_to_anchor_distance/u_camera_to_center_distance :\nu_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=projectTileWithElevation(translated_a_pos+vec2(1,0),ele);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos;if (u_is_along_line || u_is_variable_anchor) {projected_pos=vec4(a_projected_pos.xy,ele,1.0);} else if (u_pitch_with_map) {projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy+u_translation,ele,1.0);} else {projected_pos=u_label_plane_matrix*projectTileWithElevation(a_projected_pos.xy+u_translation,ele);}float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;float projectionScaling=1.0;\n#ifdef GLOBE\nif(u_pitch_with_map) {float anchor_pos_tile_y=(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w,z,1.0)).y;projectionScaling=mix(projectionScaling,1.0/circumferenceRatioAtTileY(anchor_pos_tile_y)*u_pitched_scale,u_projection_transition);}\n#endif\nvec4 finalPos=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*max(a_minFontScale,fontScale)+a_pxoffset/16.0)*projectionScaling,z,1.0);if(u_pitch_with_map) {finalPos=projectTileWithElevation(finalPos.xy,finalPos.z);}gl_Position=finalPos;v_tex=a_tex/u_texsize;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float visibility=calculate_visibility(projectedPoint);v_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));}"),symbolSDF:yt("#define SDF_PX 8.0\nuniform bool u_is_halo;uniform sampler2D u_texture;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;in vec2 v_data0;in vec3 v_data1;\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\nfloat EDGE_GAMMA=0.105/u_device_pixel_ratio;vec2 tex=v_data0.xy;float gamma_scale=v_data1.x;float size=v_data1.y;float fade_opacity=v_data1[2];float fontScale=u_is_text ? size/24.0 : size;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float inner_edge=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);inner_edge=inner_edge+gamma*gamma_scale;}lowp float dist=texture(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(inner_edge-gamma_scaled,inner_edge+gamma_scaled,dist);if (u_is_halo) {lowp float halo_edge=(6.0-halo_width/fontScale)/SDF_PX;alpha=min(smoothstep(halo_edge-gamma_scaled,halo_edge+gamma_scaled,dist),1.0-alpha);}fragColor=color*(alpha*opacity*fade_opacity);\n#ifdef OVERDRAW_INSPECTOR\nfragColor=vec4(1.0);\n#endif\n}","in vec4 a_pos_offset;in vec4 a_data;in vec4 a_pixeloffset;in vec3 a_projected_pos;in float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform bool u_is_along_line;uniform bool u_is_variable_anchor;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec2 u_translation;uniform float u_pitched_scale;out vec2 v_data0;out vec3 v_data1;\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\nvec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 translated_a_pos=a_pos+u_translation;vec4 projectedPoint=projectTileWithElevation(translated_a_pos,ele);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?\ncamera_to_anchor_distance/u_camera_to_center_distance :\nu_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=projectTileWithElevation(translated_a_pos+vec2(1,0),ele);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos;if (u_is_along_line || u_is_variable_anchor) {projected_pos=vec4(a_projected_pos.xy,ele,1.0);} else if (u_pitch_with_map) {projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy+u_translation,ele,1.0);} else {projected_pos=u_label_plane_matrix*projectTileWithElevation(a_projected_pos.xy+u_translation,ele);}float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;float projectionScaling=1.0;\n#ifdef GLOBE\nif(u_pitch_with_map) {float anchor_pos_tile_y=(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w,z,1.0)).y;projectionScaling=mix(projectionScaling,1.0/circumferenceRatioAtTileY(anchor_pos_tile_y)*u_pitched_scale,u_projection_transition);}\n#endif\nvec4 finalPos=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*fontScale+a_pxoffset)*projectionScaling,z,1.0);if(u_pitch_with_map) {finalPos=projectTileWithElevation(finalPos.xy,finalPos.z);}float gamma_scale=finalPos.w;gl_Position=finalPos;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float visibility=calculate_visibility(projectedPoint);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));v_data0=a_tex/u_texsize;v_data1=vec3(gamma_scale,size,interpolated_fade_opacity);}"),symbolTextAndIcon:yt("#define SDF_PX 8.0\n#define SDF 1.0\n#define ICON 0.0\nuniform bool u_is_halo;uniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;in vec4 v_data0;in vec4 v_data1;\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\nfloat fade_opacity=v_data1[2];if (v_data1.w==ICON) {vec2 tex_icon=v_data0.zw;lowp float alpha=opacity*fade_opacity;fragColor=texture(u_texture_icon,tex_icon)*alpha;\n#ifdef OVERDRAW_INSPECTOR\nfragColor=vec4(1.0);\n#endif\nreturn;}vec2 tex=v_data0.xy;float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_data1.x;float size=v_data1.y;float fontScale=size/24.0;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);fragColor=color*(alpha*opacity*fade_opacity);\n#ifdef OVERDRAW_INSPECTOR\nfragColor=vec4(1.0);\n#endif\n}","in vec4 a_pos_offset;in vec4 a_data;in vec3 a_projected_pos;in float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec2 u_texsize_icon;uniform bool u_is_along_line;uniform bool u_is_variable_anchor;uniform vec2 u_translation;uniform float u_pitched_scale;out vec4 v_data0;out vec4 v_data1;\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\nvec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_data.xy;vec2 a_size=a_data.zw;float a_size_min=floor(a_size[0]*0.5);float is_sdf=a_size[0]-2.0*a_size_min;float ele=get_elevation(a_pos);highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 translated_a_pos=a_pos+u_translation;vec4 projectedPoint=projectTileWithElevation(translated_a_pos,ele);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?\ncamera_to_anchor_distance/u_camera_to_center_distance :\nu_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(0.5+0.5*distance_ratio,0.0,4.0);size*=perspective_ratio;float fontScale=size/24.0;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=projectTileWithElevation(translated_a_pos+vec2(1,0),ele);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);vec4 projected_pos;if (u_is_along_line || u_is_variable_anchor) {projected_pos=vec4(a_projected_pos.xy,ele,1.0);} else if (u_pitch_with_map) {projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy+u_translation,ele,1.0);} else {projected_pos=u_label_plane_matrix*projectTileWithElevation(a_projected_pos.xy+u_translation,ele);}float z=float(u_pitch_with_map)*projected_pos.z/projected_pos.w;float projectionScaling=1.0;\n#ifdef GLOBE\nif(u_pitch_with_map && !u_is_along_line) {float anchor_pos_tile_y=(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w,z,1.0)).y;projectionScaling=mix(projectionScaling,1.0/circumferenceRatioAtTileY(anchor_pos_tile_y)*u_pitched_scale,u_projection_transition);}\n#endif\nvec4 finalPos=u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+rotation_matrix*(a_offset/32.0*fontScale)*projectionScaling,z,1.0);if(u_pitch_with_map) {finalPos=projectTileWithElevation(finalPos.xy,finalPos.z);}float gamma_scale=finalPos.w;gl_Position=finalPos;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float visibility=calculate_visibility(projectedPoint);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(visibility,fade_opacity[0]+fade_change));v_data0.xy=a_tex/u_texsize;v_data0.zw=a_tex/u_texsize_icon;v_data1=vec4(gamma_scale,size,interpolated_fade_opacity,is_sdf);}"),terrain:yt("uniform sampler2D u_texture;uniform vec4 u_fog_color;uniform vec4 u_horizon_color;uniform float u_fog_ground_blend;uniform float u_fog_ground_blend_opacity;uniform float u_horizon_fog_blend;uniform bool u_is_globe_mode;in vec2 v_texture_pos;in float v_fog_depth;const float gamma=2.2;vec4 gammaToLinear(vec4 color) {return pow(color,vec4(gamma));}vec4 linearToGamma(vec4 color) {return pow(color,vec4(1.0/gamma));}void main() {vec4 surface_color=texture(u_texture,vec2(v_texture_pos.x,1.0-v_texture_pos.y));if (!u_is_globe_mode && v_fog_depth > u_fog_ground_blend) {vec4 surface_color_linear=gammaToLinear(surface_color);float blend_color=smoothstep(0.0,1.0,max((v_fog_depth-u_horizon_fog_blend)/(1.0-u_horizon_fog_blend),0.0));vec4 fog_horizon_color_linear=mix(gammaToLinear(u_fog_color),gammaToLinear(u_horizon_color),blend_color);float factor_fog=max(v_fog_depth-u_fog_ground_blend,0.0)/(1.0-u_fog_ground_blend);fragColor=linearToGamma(mix(surface_color_linear,fog_horizon_color_linear,pow(factor_fog,2.0)*u_fog_ground_blend_opacity));} else {fragColor=surface_color;}}","in vec3 a_pos3d;uniform mat4 u_fog_matrix;uniform float u_ele_delta;out vec2 v_texture_pos;out float v_fog_depth;void main() {float ele=get_elevation(a_pos3d.xy);float ele_delta=a_pos3d.z==1.0 ? u_ele_delta : 0.0;v_texture_pos=a_pos3d.xy/8192.0;gl_Position=projectTileFor3D(a_pos3d.xy,get_elevation(a_pos3d.xy)-ele_delta);vec4 pos=u_fog_matrix*vec4(a_pos3d.xy,ele,1.0);v_fog_depth=pos.z/pos.w*0.5+0.5;}"),terrainDepth:yt("in float v_depth;const highp vec4 bitSh=vec4(256.*256.*256.,256.*256.,256.,1.);const highp vec4 bitMsk=vec4(0.,vec3(1./256.0));highp vec4 pack(highp float value) {highp vec4 comp=fract(value*bitSh);comp-=comp.xxyz*bitMsk;return comp;}void main() {fragColor=pack(v_depth);}","in vec3 a_pos3d;uniform float u_ele_delta;out float v_depth;void main() {float ele=get_elevation(a_pos3d.xy);float ele_delta=a_pos3d.z==1.0 ? u_ele_delta : 0.0;gl_Position=projectTileFor3D(a_pos3d.xy,ele-ele_delta);v_depth=gl_Position.z/gl_Position.w;}"),terrainCoords:yt("precision mediump float;uniform sampler2D u_texture;uniform float u_terrain_coords_id;in vec2 v_texture_pos;void main() {vec4 rgba=texture(u_texture,v_texture_pos);fragColor=vec4(rgba.r,rgba.g,rgba.b,u_terrain_coords_id);}","in vec3 a_pos3d;uniform float u_ele_delta;out vec2 v_texture_pos;void main() {float ele=get_elevation(a_pos3d.xy);float ele_delta=a_pos3d.z==1.0 ? u_ele_delta : 0.0;v_texture_pos=a_pos3d.xy/8192.0;gl_Position=projectTileFor3D(a_pos3d.xy,ele-ele_delta);}"),projectionErrorMeasurement:yt("in vec4 v_output_error_encoded;void main() {fragColor=v_output_error_encoded;}","in vec2 a_pos;uniform highp float u_input;uniform highp float u_output_expected;out vec4 v_output_error_encoded;void main() {float real_output=2.0*atan(exp(PI-(u_input*PI*2.0)))-PI*0.5;float error=real_output-u_output_expected;float abs_error=abs(error)*128.0;v_output_error_encoded.x=min(floor(abs_error*256.0),255.0)/255.0;abs_error-=v_output_error_encoded.x;v_output_error_encoded.y=min(floor(abs_error*65536.0),255.0)/255.0;abs_error-=v_output_error_encoded.x/255.0;v_output_error_encoded.z=min(floor(abs_error*16777216.0),255.0)/255.0;v_output_error_encoded.w=error >=0.0 ? 1.0 : 0.0;gl_Position=vec4(a_pos,0.0,1.0);}"),atmosphere:yt("in vec3 view_direction;uniform vec3 u_sun_pos;uniform vec3 u_globe_position;uniform float u_globe_radius;uniform float u_atmosphere_blend;/**Shader use from https:*Made some change to adapt to MapLibre Globe geometry*/const float PI=3.141592653589793;const int iSteps=5;const int jSteps=3;/*radius of the planet*/const float EARTH_RADIUS=6371e3;/*radius of the atmosphere*/const float ATMOS_RADIUS=6471e3;vec2 rsi(vec3 r0,vec3 rd,float sr) {float a=dot(rd,rd);float b=2.0*dot(rd,r0);float c=dot(r0,r0)-(sr*sr);float d=(b*b)-4.0*a*c;if (d < 0.0) return vec2(1e5,-1e5);return vec2((-b-sqrt(d))/(2.0*a),(-b+sqrt(d))/(2.0*a));}vec4 atmosphere(vec3 r,vec3 r0,vec3 pSun,float iSun,float rPlanet,float rAtmos,vec3 kRlh,float kMie,float shRlh,float shMie,float g) {pSun=normalize(pSun);r=normalize(r);vec2 p=rsi(r0,r,rAtmos);if (p.x > p.y) {return vec4(0.0,0.0,0.0,1.0);}if (p.x < 0.0) {p.x=0.0;}vec3 pos=r0+r*p.x;vec2 p2=rsi(r0,r,rPlanet);if (p2.x <=p2.y && p2.x > 0.0) {p.y=min(p.y,p2.x);}float iStepSize=(p.y-p.x)/float(iSteps);float iTime=p.x+iStepSize*0.5;vec3 totalRlh=vec3(0,0,0);vec3 totalMie=vec3(0,0,0);float iOdRlh=0.0;float iOdMie=0.0;float mu=dot(r,pSun);float mumu=mu*mu;float gg=g*g;float pRlh=3.0/(16.0*PI)*(1.0+mumu);float pMie=3.0/(8.0*PI)*((1.0-gg)*(mumu+1.0))/(pow(1.0+gg-2.0*mu*g,1.5)*(2.0+gg));for (int i=0; i < iSteps; i++) {vec3 iPos=r0+r*iTime;float iHeight=length(iPos)-rPlanet;float odStepRlh=exp(-iHeight/shRlh)*iStepSize;float odStepMie=exp(-iHeight/shMie)*iStepSize;iOdRlh+=odStepRlh;iOdMie+=odStepMie;float jStepSize=rsi(iPos,pSun,rAtmos).y/float(jSteps);float jTime=jStepSize*0.5;float jOdRlh=0.0;float jOdMie=0.0;for (int j=0; j < jSteps; j++) {vec3 jPos=iPos+pSun*jTime;float jHeight=length(jPos)-rPlanet;jOdRlh+=exp(-jHeight/shRlh)*jStepSize;jOdMie+=exp(-jHeight/shMie)*jStepSize;jTime+=jStepSize;}vec3 attn=exp(-(kMie*(iOdMie+jOdMie)+kRlh*(iOdRlh+jOdRlh)));totalRlh+=odStepRlh*attn;totalMie+=odStepMie*attn;iTime+=iStepSize;}float opacity=exp(-(length(kRlh)*length(totalRlh)+kMie*length(totalMie)));vec3 color=iSun*(pRlh*kRlh*totalRlh+pMie*kMie*totalMie);return vec4(color,opacity);}void main() {vec3 scale_camera_pos=-u_globe_position*EARTH_RADIUS/u_globe_radius;vec4 color=atmosphere(normalize(view_direction),scale_camera_pos,u_sun_pos,22.0,EARTH_RADIUS,ATMOS_RADIUS,vec3(5.5e-6,13.0e-6,22.4e-6),21e-6,8e3,1.2e3,0.758\n);color.rgb=1.0-exp(-1.0*color.rgb);color=pow(color,vec4(1.0/2.2));fragColor=vec4(color.rgb,1.0-color.a)*u_atmosphere_blend;}","in vec2 a_pos;uniform mat4 u_inv_proj_matrix;out vec3 view_direction;void main() {view_direction=(u_inv_proj_matrix*vec4(a_pos,0.0,1.0)).xyz;gl_Position=vec4(a_pos,0.0,1.0);}"),sky:yt("uniform vec4 u_sky_color;uniform vec4 u_horizon_color;uniform vec2 u_horizon;uniform vec2 u_horizon_normal;uniform float u_sky_horizon_blend;uniform float u_sky_blend;void main() {float x=gl_FragCoord.x;float y=gl_FragCoord.y;float blend=(y-u_horizon.y)*u_horizon_normal.y+(x-u_horizon.x)*u_horizon_normal.x;if (blend > 0.0) {if (blend < u_sky_horizon_blend) {fragColor=mix(u_sky_color,u_horizon_color,pow(1.0-blend/u_sky_horizon_blend,2.0));} else {fragColor=u_sky_color;}}fragColor=mix(fragColor,vec4(vec3(0.0),0.0),u_sky_blend);}","in vec2 a_pos;void main() {gl_Position=vec4(a_pos,1.0,1.0);}")};function yt(rt,at){const Tt=/#pragma mapbox: ([\w]+) ([\w]+) ([\w]+) ([\w]+)/g,$t=at.match(/in ([\w]+) ([\w]+)/g),qt=rt.match(/uniform ([\w]+) ([\w]+)([\s]*)([\w]*)/g),Kt=at.match(/uniform ([\w]+) ([\w]+)([\s]*)([\w]*)/g),ge=Kt?Kt.concat(qt):qt,Hr={};return{fragmentSource:rt=rt.replace(Tt,((rt,at,Tt,$t,qt)=>(Hr[qt]=!0,"define"===at?`\n#ifndef HAS_UNIFORM_u_${qt}\nin ${Tt} ${$t} ${qt};\n#else\nuniform ${Tt} ${$t} u_${qt};\n#endif\n`:`\n#ifdef HAS_UNIFORM_u_${qt}\n    ${Tt} ${$t} ${qt} = u_${qt};\n#endif\n`))),vertexSource:at=at.replace(Tt,((rt,at,Tt,$t,qt)=>{const Kt="float"===$t?"vec2":"vec4",ge=qt.match(/color/)?"color":Kt;return Hr[qt]?"define"===at?`\n#ifndef HAS_UNIFORM_u_${qt}\nuniform lowp float u_${qt}_t;\nin ${Tt} ${Kt} a_${qt};\nout ${Tt} ${$t} ${qt};\n#else\nuniform ${Tt} ${$t} u_${qt};\n#endif\n`:"vec4"===ge?`\n#ifndef HAS_UNIFORM_u_${qt}\n    ${qt} = a_${qt};\n#else\n    ${Tt} ${$t} ${qt} = u_${qt};\n#endif\n`:`\n#ifndef HAS_UNIFORM_u_${qt}\n    ${qt} = unpack_mix_${ge}(a_${qt}, u_${qt}_t);\n#else\n    ${Tt} ${$t} ${qt} = u_${qt};\n#endif\n`:"define"===at?`\n#ifndef HAS_UNIFORM_u_${qt}\nuniform lowp float u_${qt}_t;\nin ${Tt} ${Kt} a_${qt};\n#else\nuniform ${Tt} ${$t} u_${qt};\n#endif\n`:"vec4"===ge?`\n#ifndef HAS_UNIFORM_u_${qt}\n    ${Tt} ${$t} ${qt} = a_${qt};\n#else\n    ${Tt} ${$t} ${qt} = u_${qt};\n#endif\n`:`\n#ifndef HAS_UNIFORM_u_${qt}\n    ${Tt} ${$t} ${qt} = unpack_mix_${ge}(a_${qt}, u_${qt}_t);\n#else\n    ${Tt} ${$t} ${qt} = u_${qt};\n#endif\n`})),staticAttributes:$t,staticUniforms:ge}}class wt{constructor(rt,at,Tt){this.vertexBuffer=rt,this.indexBuffer=at,this.segments=Tt}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.vertexBuffer=null,this.indexBuffer=null,this.segments=null}}var Xl=Tt.aG([{name:"a_pos",type:"Int16",components:2}]);const Kl="#define PROJECTION_MERCATOR",Yl="mercator";class Mt{constructor(){this._cachedMesh=null}get name(){return"mercator"}get useSubdivision(){return!1}get shaderVariantName(){return Yl}get shaderDefine(){return Kl}get shaderPreludeCode(){return Hl.projectionMercator}get vertexShaderPreludeCode(){return Hl.projectionMercator.vertexSource}get subdivisionGranularity(){return Tt.aH.noSubdivision}get useGlobeControls(){return!1}get transitionState(){return 0}get latitudeErrorCorrectionRadians(){return 0}destroy(){}updateGPUdependent(rt){}getMeshFromTileID(rt,at,$t,qt,Kt){if(this._cachedMesh)return this._cachedMesh;const ge=new Tt.aI;ge.emplaceBack(0,0),ge.emplaceBack(Tt.Z,0),ge.emplaceBack(0,Tt.Z),ge.emplaceBack(Tt.Z,Tt.Z);const Hr=rt.createVertexBuffer(ge,Xl.members),wn=Tt.aJ.simpleSegment(0,0,4,2),es=new Tt.aK;es.emplaceBack(1,0,2),es.emplaceBack(1,2,3);const ss=rt.createIndexBuffer(es);return this._cachedMesh=new wt(Hr,ss,wn),this._cachedMesh}recalculate(){}hasTransition(){return!1}setErrorQueryLatitudeDegrees(rt){}}class It{constructor(rt=0,at=0,Tt=0,$t=0){if(isNaN(rt)||rt<0||isNaN(at)||at<0||isNaN(Tt)||Tt<0||isNaN($t)||$t<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=rt,this.bottom=at,this.left=Tt,this.right=$t}interpolate(rt,at,$t){return null!=at.top&&null!=rt.top&&(this.top=Tt.B.number(rt.top,at.top,$t)),null!=at.bottom&&null!=rt.bottom&&(this.bottom=Tt.B.number(rt.bottom,at.bottom,$t)),null!=at.left&&null!=rt.left&&(this.left=Tt.B.number(rt.left,at.left,$t)),null!=at.right&&null!=rt.right&&(this.right=Tt.B.number(rt.right,at.right,$t)),this}getCenter(rt,at){const $t=Tt.ae((this.left+rt-this.right)/2,0,rt),qt=Tt.ae((this.top+at-this.bottom)/2,0,at);return new Tt.P($t,qt)}equals(rt){return this.top===rt.top&&this.bottom===rt.bottom&&this.left===rt.left&&this.right===rt.right}clone(){return new It(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}function Et(rt,at){if(!rt.renderWorldCopies||rt.lngRange)return;const Tt=at.lng-rt.center.lng;at.lng+=Tt>180?-360:Tt<-180?360:0}function St(rt){return Math.max(0,Math.floor(rt))}class Rt{constructor(rt,at,$t,qt,Kt,ge){this._callbacks=rt,this._tileSize=512,this._renderWorldCopies=void 0===ge||!!ge,this._minZoom=at||0,this._maxZoom=$t||22,this._minPitch=null==qt?0:qt,this._maxPitch=null==Kt?60:Kt,this.setMaxBounds(),this._width=0,this._height=0,this._center=new Tt.Q(0,0),this._elevation=0,this._zoom=0,this._tileZoom=St(this._zoom),this._scale=Tt.ac(this._zoom),this._bearingInRadians=0,this._fovInRadians=.6435011087932844,this._pitchInRadians=0,this._rollInRadians=0,this._unmodified=!0,this._edgeInsets=new It,this._minElevationForCurrentTile=0,this._autoCalculateNearFarZ=!0}apply(rt,at,$t){this._latRange=rt.latRange,this._lngRange=rt.lngRange,this._width=rt.width,this._height=rt.height,this._center=rt.center,this._elevation=rt.elevation,this._minElevationForCurrentTile=rt.minElevationForCurrentTile,this._zoom=rt.zoom,this._tileZoom=St(this._zoom),this._scale=Tt.ac(this._zoom),this._bearingInRadians=rt.bearingInRadians,this._fovInRadians=rt.fovInRadians,this._pitchInRadians=rt.pitchInRadians,this._rollInRadians=rt.rollInRadians,this._unmodified=rt.unmodified,this._edgeInsets=new It(rt.padding.top,rt.padding.bottom,rt.padding.left,rt.padding.right),this._minZoom=rt.minZoom,this._maxZoom=rt.maxZoom,this._minPitch=rt.minPitch,this._maxPitch=rt.maxPitch,this._renderWorldCopies=rt.renderWorldCopies,this._cameraToCenterDistance=rt.cameraToCenterDistance,this._nearZ=rt.nearZ,this._farZ=rt.farZ,this._autoCalculateNearFarZ=!$t&&rt.autoCalculateNearFarZ,at&&this._constrain(),this._calcMatrices()}get pixelsToClipSpaceMatrix(){return this._pixelsToClipSpaceMatrix}get clipSpaceToPixelsMatrix(){return this._clipSpaceToPixelsMatrix}get minElevationForCurrentTile(){return this._minElevationForCurrentTile}setMinElevationForCurrentTile(rt){this._minElevationForCurrentTile=rt}get tileSize(){return this._tileSize}get tileZoom(){return this._tileZoom}get scale(){return this._scale}get width(){return this._width}get height(){return this._height}get bearingInRadians(){return this._bearingInRadians}get lngRange(){return this._lngRange}get latRange(){return this._latRange}get pixelsToGLUnits(){return this._pixelsToGLUnits}get minZoom(){return this._minZoom}setMinZoom(rt){this._minZoom!==rt&&(this._minZoom=rt,this.setZoom(this.getConstrained(this._center,this.zoom).zoom))}get maxZoom(){return this._maxZoom}setMaxZoom(rt){this._maxZoom!==rt&&(this._maxZoom=rt,this.setZoom(this.getConstrained(this._center,this.zoom).zoom))}get minPitch(){return this._minPitch}setMinPitch(rt){this._minPitch!==rt&&(this._minPitch=rt,this.setPitch(Math.max(this.pitch,rt)))}get maxPitch(){return this._maxPitch}setMaxPitch(rt){this._maxPitch!==rt&&(this._maxPitch=rt,this.setPitch(Math.min(this.pitch,rt)))}get renderWorldCopies(){return this._renderWorldCopies}setRenderWorldCopies(rt){void 0===rt?rt=!0:null===rt&&(rt=!1),this._renderWorldCopies=rt}get worldSize(){return this._tileSize*this._scale}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new Tt.P(this._width,this._height)}get bearing(){return this._bearingInRadians/Math.PI*180}setBearing(rt){const at=Tt.aL(rt,-180,180)*Math.PI/180;var $t,qt,Kt,ge,Hr,wn,es,ss,os;this._bearingInRadians!==at&&(this._unmodified=!1,this._bearingInRadians=at,this._calcMatrices(),this._rotationMatrix=r(),$t=this._rotationMatrix,Kt=-this._bearingInRadians,ge=(qt=this._rotationMatrix)[0],Hr=qt[1],wn=qt[2],es=qt[3],ss=Math.sin(Kt),os=Math.cos(Kt),$t[0]=ge*os+wn*ss,$t[1]=Hr*os+es*ss,$t[2]=ge*-ss+wn*os,$t[3]=Hr*-ss+es*os)}get rotationMatrix(){return this._rotationMatrix}get pitchInRadians(){return this._pitchInRadians}get pitch(){return this._pitchInRadians/Math.PI*180}setPitch(rt){const at=Tt.ae(rt,this.minPitch,this.maxPitch)/180*Math.PI;this._pitchInRadians!==at&&(this._unmodified=!1,this._pitchInRadians=at,this._calcMatrices())}get rollInRadians(){return this._rollInRadians}get roll(){return this._rollInRadians/Math.PI*180}setRoll(rt){const at=rt/180*Math.PI;this._rollInRadians!==at&&(this._unmodified=!1,this._rollInRadians=at,this._calcMatrices())}get fovInRadians(){return this._fovInRadians}get fov(){return Tt.aM(this._fovInRadians)}setFov(rt){rt=Tt.ae(rt,.1,150),this.fov!==rt&&(this._unmodified=!1,this._fovInRadians=Tt.ab(rt),this._calcMatrices())}get zoom(){return this._zoom}setZoom(rt){const at=this.getConstrained(this._center,rt).zoom;this._zoom!==at&&(this._unmodified=!1,this._zoom=at,this._tileZoom=Math.max(0,Math.floor(at)),this._scale=Tt.ac(at),this._constrain(),this._calcMatrices())}get center(){return this._center}setCenter(rt){rt.lat===this._center.lat&&rt.lng===this._center.lng||(this._unmodified=!1,this._center=rt,this._constrain(),this._calcMatrices())}get elevation(){return this._elevation}setElevation(rt){rt!==this._elevation&&(this._elevation=rt,this._constrain(),this._calcMatrices())}get padding(){return this._edgeInsets.toJSON()}setPadding(rt){this._edgeInsets.equals(rt)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,rt,1),this._calcMatrices())}get centerPoint(){return this._edgeInsets.getCenter(this._width,this._height)}get pixelsPerMeter(){return this._pixelPerMeter}get unmodified(){return this._unmodified}get cameraToCenterDistance(){return this._cameraToCenterDistance}get nearZ(){return this._nearZ}get farZ(){return this._farZ}get autoCalculateNearFarZ(){return this._autoCalculateNearFarZ}overrideNearFarZ(rt,at){this._autoCalculateNearFarZ=!1,this._nearZ=rt,this._farZ=at,this._calcMatrices()}clearNearFarZOverride(){this._autoCalculateNearFarZ=!0,this._calcMatrices()}isPaddingEqual(rt){return this._edgeInsets.equals(rt)}interpolatePadding(rt,at,Tt){this._unmodified=!1,this._edgeInsets.interpolate(rt,at,Tt),this._constrain(),this._calcMatrices()}resize(rt,at,Tt=!0){this._width=rt,this._height=at,Tt&&this._constrain(),this._calcMatrices()}getMaxBounds(){return this._latRange&&2===this._latRange.length&&this._lngRange&&2===this._lngRange.length?new V([this._lngRange[0],this._latRange[0]],[this._lngRange[1],this._latRange[1]]):null}setMaxBounds(rt){rt?(this._lngRange=[rt.getWest(),rt.getEast()],this._latRange=[rt.getSouth(),rt.getNorth()],this._constrain()):(this._lngRange=null,this._latRange=[-85.051129,Tt.af])}getConstrained(rt,at){return this._callbacks.getConstrained(rt,at)}getCameraQueryGeometry(rt,at){if(1===at.length)return[at[0],rt];{let $t=rt.x,qt=rt.y,Kt=rt.x,ge=rt.y;for(const rt of at)$t=Math.min($t,rt.x),qt=Math.min(qt,rt.y),Kt=Math.max(Kt,rt.x),ge=Math.max(ge,rt.y);return[new Tt.P($t,qt),new Tt.P(Kt,qt),new Tt.P(Kt,ge),new Tt.P($t,ge),new Tt.P($t,qt)]}}_constrain(){if(!this.center||!this._width||!this._height||this._constraining)return;this._constraining=!0;const rt=this._unmodified,{center:at,zoom:Tt}=this.getConstrained(this.center,this.zoom);this.setCenter(at),this.setZoom(Tt),this._unmodified=rt,this._constraining=!1}_calcMatrices(){if(this._width&&this._height){this._pixelsToGLUnits=[2/this._width,-2/this._height];let rt=Tt.ad(new Float64Array(16));Tt.M(rt,rt,[this._width/2,-this._height/2,1]),Tt.L(rt,rt,[1,-1,0]),this._clipSpaceToPixelsMatrix=rt,rt=Tt.ad(new Float64Array(16)),Tt.M(rt,rt,[1,-1,1]),Tt.L(rt,rt,[-1,-1,0]),Tt.M(rt,rt,[2/this._width,2/this._height,1]),this._pixelsToClipSpaceMatrix=rt,this._cameraToCenterDistance=.5/Math.tan(this.fovInRadians/2)*this._height}this._callbacks.calcMatrices()}calculateCenterFromCameraLngLatAlt(rt,at,$t,qt){const Kt=void 0!==$t?$t:this.bearing,ge=qt=void 0!==qt?qt:this.pitch,Hr=Tt.$.fromLngLat(rt,at),wn=-Math.cos(Tt.ab(ge)),es=Math.sin(Tt.ab(ge)),ss=es*Math.sin(Tt.ab(Kt)),os=-es*Math.cos(Tt.ab(Kt));let cs=this.elevation;const ds=at-cs;let Cs;wn*ds>=0||Math.abs(wn)<.1?(Cs=1e4,cs=at+Cs*wn):Cs=-ds/wn;let Vs,Eo,Do=Tt.aN(1,Hr.y),Ho=0;do{if(Ho+=1,Ho>10)break;Eo=Cs/Do,Vs=new Tt.$(Hr.x+ss*Eo,Hr.y+os*Eo),Do=1/Vs.meterInMercatorCoordinateUnits()}while(Math.abs(Cs-Eo*Do)>1e-12);return{center:Vs.toLngLat(),elevation:cs,zoom:Tt.ah(this.height/2/Math.tan(this.fovInRadians/2)/Eo/this.tileSize)}}recalculateZoomAndCenter(rt){if(this.elevation-rt==0)return;const at=Tt.ag(1,this.center.lat)*this.worldSize,$t=this.cameraToCenterDistance/at,qt=Tt.$.fromLngLat(this.center,this.elevation),Kt=_e(this.center,this.elevation,this.pitch,this.bearing,$t);this._elevation=rt;const ge=this.calculateCenterFromCameraLngLatAlt(Kt.toLngLat(),Tt.aN(Kt.z,qt.y),this.bearing,this.pitch);this._elevation=ge.elevation,this._center=ge.center,this.setZoom(ge.zoom)}getCameraPoint(){const rt=Math.tan(this.pitchInRadians)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new Tt.P(rt*Math.sin(this.rollInRadians),rt*Math.cos(this.rollInRadians)))}getCameraAltitude(){return Math.cos(this.pitchInRadians)*this._cameraToCenterDistance/this._pixelPerMeter+this.elevation}getCameraLngLat(){const rt=Tt.ag(1,this.center.lat)*this.worldSize;return _e(this.center,this.elevation,this.pitch,this.bearing,this.cameraToCenterDistance/rt).toLngLat()}getMercatorTileCoordinates(rt){if(!rt)return[0,0,1,1];const at=rt.canonical.z>=0?1<<rt.canonical.z:Math.pow(2,rt.canonical.z);return[rt.canonical.x/at,rt.canonical.y/at,1/at/Tt.Z,1/at/Tt.Z]}}class Dt{constructor(rt,at){this.min=rt,this.max=at,this.center=Tt.aO([],Tt.aP([],this.min,this.max),.5)}quadrant(rt){const at=[rt%2==0,rt<2],$t=Tt.aQ(this.min),qt=Tt.aQ(this.max);for(let rt=0;rt<at.length;rt++)$t[rt]=at[rt]?this.min[rt]:this.center[rt],qt[rt]=at[rt]?this.center[rt]:this.max[rt];return qt[2]=this.max[2],new Dt($t,qt)}distanceX(rt){return Math.max(Math.min(this.max[0],rt[0]),this.min[0])-rt[0]}distanceY(rt){return Math.max(Math.min(this.max[1],rt[1]),this.min[1])-rt[1]}intersectsFrustum(rt){let at=!0;for(let Tt=0;Tt<rt.planes.length;Tt++){const $t=this.intersectsPlane(rt.planes[Tt]);if(0===$t)return 0;1===$t&&(at=!1)}return at?2:rt.aabb.min[0]>this.max[0]||rt.aabb.min[1]>this.max[1]||rt.aabb.min[2]>this.max[2]||rt.aabb.max[0]<this.min[0]||rt.aabb.max[1]<this.min[1]||rt.aabb.max[2]<this.min[2]?0:1}intersectsPlane(rt){let at=rt[3],Tt=rt[3];for(let $t=0;$t<3;$t++)rt[$t]>0?(at+=rt[$t]*this.min[$t],Tt+=rt[$t]*this.max[$t]):(Tt+=rt[$t]*this.min[$t],at+=rt[$t]*this.max[$t]);return at>=0?2:Tt<0?0:1}}class zt{distanceToTile2d(rt,at,Tt,$t){const qt=$t.distanceX([rt,at]),Kt=$t.distanceY([rt,at]);return Math.hypot(qt,Kt)}getWrap(rt,at,Tt){return Tt}getTileAABB(rt,at,$t,qt){var Kt,ge;let Hr=$t,wn=$t;if(qt.terrain){const es=new Tt.Y(rt.z,at,rt.z,rt.x,rt.y),ss=qt.terrain.getMinMaxElevation(es);Hr=null!==(Kt=ss.minElevation)&&void 0!==Kt?Kt:$t,wn=null!==(ge=ss.maxElevation)&&void 0!==ge?ge:$t}const es=1<<rt.z;return new Dt([at+rt.x/es,rt.y/es,Hr],[at+(rt.x+1)/es,(rt.y+1)/es,wn])}allowVariableZoom(rt,at){const $t=rt.fov*(Math.abs(Math.cos(rt.rollInRadians))*rt.height+Math.abs(Math.sin(rt.rollInRadians))*rt.width)/rt.height,qt=Tt.ae(78.5-$t/2,0,60);return!!at.terrain||rt.pitch>qt}allowWorldCopies(){return!0}recalculateCache(){}}class At{constructor(rt,at,Tt){this.points=rt,this.planes=at,this.aabb=Tt}static fromInvProjectionMatrix(rt,at=1,$t=0){const qt=Math.pow(2,$t),Kt=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map(($t=>{const Kt=1/($t=Tt.at([],$t,rt))[3]/at*qt;return Tt.aR($t,$t,[Kt,Kt,1/$t[3],Kt])})),ge=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map((rt=>{const at=Tt.aS([],Kt[rt[0]],Kt[rt[1]]),$t=Tt.aS([],Kt[rt[2]],Kt[rt[1]]),qt=Tt.aT([],Tt.aU([],at,$t)),ge=-Tt.aV(qt,Kt[rt[1]]);return qt.concat(ge)})),Hr=[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY],wn=[Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY];for(const rt of Kt)for(let at=0;at<3;at++)Hr[at]=Math.min(Hr[at],rt[at]),wn[at]=Math.max(wn[at],rt[at]);return new At(Kt,ge,new Dt(Hr,wn))}}class Lt{get pixelsToClipSpaceMatrix(){return this._helper.pixelsToClipSpaceMatrix}get clipSpaceToPixelsMatrix(){return this._helper.clipSpaceToPixelsMatrix}get pixelsToGLUnits(){return this._helper.pixelsToGLUnits}get centerOffset(){return this._helper.centerOffset}get size(){return this._helper.size}get rotationMatrix(){return this._helper.rotationMatrix}get centerPoint(){return this._helper.centerPoint}get pixelsPerMeter(){return this._helper.pixelsPerMeter}setMinZoom(rt){this._helper.setMinZoom(rt)}setMaxZoom(rt){this._helper.setMaxZoom(rt)}setMinPitch(rt){this._helper.setMinPitch(rt)}setMaxPitch(rt){this._helper.setMaxPitch(rt)}setRenderWorldCopies(rt){this._helper.setRenderWorldCopies(rt)}setBearing(rt){this._helper.setBearing(rt)}setPitch(rt){this._helper.setPitch(rt)}setRoll(rt){this._helper.setRoll(rt)}setFov(rt){this._helper.setFov(rt)}setZoom(rt){this._helper.setZoom(rt)}setCenter(rt){this._helper.setCenter(rt)}setElevation(rt){this._helper.setElevation(rt)}setMinElevationForCurrentTile(rt){this._helper.setMinElevationForCurrentTile(rt)}setPadding(rt){this._helper.setPadding(rt)}interpolatePadding(rt,at,Tt){return this._helper.interpolatePadding(rt,at,Tt)}isPaddingEqual(rt){return this._helper.isPaddingEqual(rt)}resize(rt,at,Tt=!0){this._helper.resize(rt,at,Tt)}getMaxBounds(){return this._helper.getMaxBounds()}setMaxBounds(rt){this._helper.setMaxBounds(rt)}overrideNearFarZ(rt,at){this._helper.overrideNearFarZ(rt,at)}clearNearFarZOverride(){this._helper.clearNearFarZOverride()}getCameraQueryGeometry(rt){return this._helper.getCameraQueryGeometry(this.getCameraPoint(),rt)}get tileSize(){return this._helper.tileSize}get tileZoom(){return this._helper.tileZoom}get scale(){return this._helper.scale}get worldSize(){return this._helper.worldSize}get width(){return this._helper.width}get height(){return this._helper.height}get lngRange(){return this._helper.lngRange}get latRange(){return this._helper.latRange}get minZoom(){return this._helper.minZoom}get maxZoom(){return this._helper.maxZoom}get zoom(){return this._helper.zoom}get center(){return this._helper.center}get minPitch(){return this._helper.minPitch}get maxPitch(){return this._helper.maxPitch}get pitch(){return this._helper.pitch}get pitchInRadians(){return this._helper.pitchInRadians}get roll(){return this._helper.roll}get rollInRadians(){return this._helper.rollInRadians}get bearing(){return this._helper.bearing}get bearingInRadians(){return this._helper.bearingInRadians}get fov(){return this._helper.fov}get fovInRadians(){return this._helper.fovInRadians}get elevation(){return this._helper.elevation}get minElevationForCurrentTile(){return this._helper.minElevationForCurrentTile}get padding(){return this._helper.padding}get unmodified(){return this._helper.unmodified}get renderWorldCopies(){return this._helper.renderWorldCopies}get cameraToCenterDistance(){return this._helper.cameraToCenterDistance}get nearZ(){return this._helper.nearZ}get farZ(){return this._helper.farZ}get autoCalculateNearFarZ(){return this._helper.autoCalculateNearFarZ}setTransitionState(rt,at){}constructor(rt,at,Tt,$t,qt){this._posMatrixCache=new Map,this._alignedPosMatrixCache=new Map,this._fogMatrixCacheF32=new Map,this._helper=new Rt({calcMatrices:()=>{this._calcMatrices()},getConstrained:(rt,at)=>this.getConstrained(rt,at)},rt,at,Tt,$t,qt),this._coveringTilesDetailsProvider=new zt}clone(){const rt=new Lt;return rt.apply(this),rt}apply(rt,at,Tt){this._helper.apply(rt,at,Tt)}get cameraPosition(){return this._cameraPosition}get projectionMatrix(){return this._projectionMatrix}get modelViewProjectionMatrix(){return this._viewProjMatrix}get inverseProjectionMatrix(){return this._invProjMatrix}get mercatorMatrix(){return this._mercatorMatrix}getVisibleUnwrappedCoordinates(rt){const at=[new Tt.aW(0,rt)];if(this._helper._renderWorldCopies){const $t=this.screenPointToMercatorCoordinate(new Tt.P(0,0)),qt=this.screenPointToMercatorCoordinate(new Tt.P(this._helper._width,0)),Kt=this.screenPointToMercatorCoordinate(new Tt.P(this._helper._width,this._helper._height)),ge=this.screenPointToMercatorCoordinate(new Tt.P(0,this._helper._height)),Hr=Math.floor(Math.min($t.x,qt.x,Kt.x,ge.x)),wn=Math.floor(Math.max($t.x,qt.x,Kt.x,ge.x)),es=1;for(let $t=Hr-es;$t<=wn+es;$t++)0!==$t&&at.push(new Tt.aW($t,rt))}return at}getCameraFrustum(){return At.fromInvProjectionMatrix(this._invViewProjMatrix,this.worldSize)}getClippingPlane(){return null}getCoveringTilesDetailsProvider(){return this._coveringTilesDetailsProvider}recalculateZoomAndCenter(rt){const at=this.screenPointToLocation(this.centerPoint,rt),Tt=rt?rt.getElevationForLngLatZoom(at,this._helper._tileZoom):0;this._helper.recalculateZoomAndCenter(Tt)}setLocationAtPoint(rt,at){const $t=Tt.ag(this.elevation,this.center.lat),qt=this.screenPointToMercatorCoordinateAtZ(at,$t),Kt=this.screenPointToMercatorCoordinateAtZ(this.centerPoint,$t),ge=Tt.$.fromLngLat(rt),Hr=new Tt.$(ge.x-(qt.x-Kt.x),ge.y-(qt.y-Kt.y));this.setCenter(null==Hr?void 0:Hr.toLngLat()),this._helper._renderWorldCopies&&this.setCenter(this.center.wrap())}locationToScreenPoint(rt,at){return at?this.coordinatePoint(Tt.$.fromLngLat(rt),at.getElevationForLngLatZoom(rt,this._helper._tileZoom),this._pixelMatrix3D):this.coordinatePoint(Tt.$.fromLngLat(rt))}screenPointToLocation(rt,at){var Tt;return null===(Tt=this.screenPointToMercatorCoordinate(rt,at))||void 0===Tt?void 0:Tt.toLngLat()}screenPointToMercatorCoordinate(rt,at){if(at){const Tt=at.pointCoordinate(rt);if(null!=Tt)return Tt}return this.screenPointToMercatorCoordinateAtZ(rt)}screenPointToMercatorCoordinateAtZ(rt,at){const $t=at||0,qt=[rt.x,rt.y,0,1],Kt=[rt.x,rt.y,1,1];Tt.at(qt,qt,this._pixelMatrixInverse),Tt.at(Kt,Kt,this._pixelMatrixInverse);const ge=qt[3],Hr=Kt[3],wn=qt[1]/ge,es=Kt[1]/Hr,ss=qt[2]/ge,os=Kt[2]/Hr,cs=ss===os?0:($t-ss)/(os-ss);return new Tt.$(Tt.B.number(qt[0]/ge,Kt[0]/Hr,cs)/this.worldSize,Tt.B.number(wn,es,cs)/this.worldSize,$t)}coordinatePoint(rt,at=0,$t=this._pixelMatrix){const qt=[rt.x*this.worldSize,rt.y*this.worldSize,at,1];return Tt.at(qt,qt,$t),new Tt.P(qt[0]/qt[3],qt[1]/qt[3])}getBounds(){const rt=Math.max(0,this._helper._height/2-ue(this));return(new V).extend(this.screenPointToLocation(new Tt.P(0,rt))).extend(this.screenPointToLocation(new Tt.P(this._helper._width,rt))).extend(this.screenPointToLocation(new Tt.P(this._helper._width,this._helper._height))).extend(this.screenPointToLocation(new Tt.P(0,this._helper._height)))}isPointOnMapSurface(rt,at){return at?null!=at.pointCoordinate(rt):rt.y>this.height/2-ue(this)}calculatePosMatrix(rt,at=!1,$t){var qt;const Kt=null!==(qt=rt.key)&&void 0!==qt?qt:Tt.aX(rt.wrap,rt.canonical.z,rt.canonical.z,rt.canonical.x,rt.canonical.y),ge=at?this._alignedPosMatrixCache:this._posMatrixCache;if(ge.has(Kt)){const rt=ge.get(Kt);return $t?rt.f32:rt.f64}const Hr=de(rt,this.worldSize);Tt.N(Hr,at?this._alignedProjMatrix:this._viewProjMatrix,Hr);const wn={f64:Hr,f32:new Float32Array(Hr)};return ge.set(Kt,wn),$t?wn.f32:wn.f64}calculateFogMatrix(rt){const at=rt.key,$t=this._fogMatrixCacheF32;if($t.has(at))return $t.get(at);const qt=de(rt,this.worldSize);return Tt.N(qt,this._fogMatrix,qt),$t.set(at,new Float32Array(qt)),$t.get(at)}getConstrained(rt,at){at=Tt.ae(+at,this.minZoom,this.maxZoom);const $t={center:new Tt.Q(rt.lng,rt.lat),zoom:at};let qt=this._helper._lngRange;this._helper._renderWorldCopies||null!==qt||(qt=[-179.9999999999,180-1e-10]);const Kt=this.tileSize*Tt.ac($t.zoom);let ge=0,Hr=Kt,wn=0,es=Kt,ss=0,os=0;const{x:cs,y:ds}=this.size;if(this._helper._latRange){const rt=this._helper._latRange;ge=Tt.S(rt[1])*Kt,Hr=Tt.S(rt[0])*Kt,Hr-ge<ds&&(ss=ds/(Hr-ge))}qt&&(wn=Tt.aL(Tt.U(qt[0])*Kt,0,Kt),es=Tt.aL(Tt.U(qt[1])*Kt,0,Kt),es<wn&&(es+=Kt),es-wn<cs&&(os=cs/(es-wn)));const{x:Cs,y:Vs}=ce(Kt,rt);let Eo,Do;const Ho=Math.max(os||0,ss||0);if(Ho){const rt=new Tt.P(os?(es+wn)/2:Cs,ss?(Hr+ge)/2:Vs);return $t.center=he(Kt,rt).wrap(),$t.zoom+=Tt.ah(Ho),$t}if(this._helper._latRange){const rt=ds/2;Vs-rt<ge&&(Do=ge+rt),Vs+rt>Hr&&(Do=Hr-rt)}if(qt){const rt=(wn+es)/2;let at=Cs;this._helper._renderWorldCopies&&(at=Tt.aL(Cs,rt-Kt/2,rt+Kt/2));const $t=cs/2;at-$t<wn&&(Eo=wn+$t),at+$t>es&&(Eo=es-$t)}if(void 0!==Eo||void 0!==Do){const rt=new Tt.P(null!=Eo?Eo:Cs,null!=Do?Do:Vs);$t.center=he(Kt,rt).wrap()}return $t}calculateCenterFromCameraLngLatAlt(rt,at,Tt,$t){return this._helper.calculateCenterFromCameraLngLatAlt(rt,at,Tt,$t)}_calculateNearFarZIfNeeded(rt,at,$t){if(!this._helper.autoCalculateNearFarZ)return;const qt=Math.min(this.elevation,this.minElevationForCurrentTile,this.getCameraAltitude()-100),Kt=rt-qt*this._helper._pixelPerMeter/Math.cos(at),ge=qt<0?Kt:rt,Hr=Math.PI/2+this.pitchInRadians,wn=Tt.ab(this.fov)*(Math.abs(Math.cos(Tt.ab(this.roll)))*this.height+Math.abs(Math.sin(Tt.ab(this.roll)))*this.width)/this.height*(.5+$t.y/this.height),es=Math.sin(wn)*ge/Math.sin(Tt.ae(Math.PI-Hr-wn,.01,Math.PI-.01)),ss=ue(this),os=Math.atan(ss/this._helper.cameraToCenterDistance),cs=Tt.ab(.75),ds=os>cs?2*os*(.5+$t.y/(2*ss)):cs,Cs=Math.sin(ds)*ge/Math.sin(Tt.ae(Math.PI-Hr-ds,.01,Math.PI-.01)),Vs=Math.min(es,Cs);this._helper._farZ=1.01*(Math.cos(Math.PI/2-at)*Vs+ge),this._helper._nearZ=this._helper._height/50}_calcMatrices(){if(!this._helper._height)return;const rt=this.centerOffset,at=ce(this.worldSize,this.center),$t=at.x,qt=at.y;this._helper._pixelPerMeter=Tt.ag(1,this.center.lat)*this.worldSize;const Kt=Tt.ab(Math.min(this.pitch,Na)),ge=Math.max(this._helper.cameraToCenterDistance/2,this._helper.cameraToCenterDistance+this._helper._elevation*this._helper._pixelPerMeter/Math.cos(Kt));let Hr;this._calculateNearFarZIfNeeded(ge,Kt,rt),Hr=new Float64Array(16),Tt.aY(Hr,this.fovInRadians,this._helper._width/this._helper._height,this._helper._nearZ,this._helper._farZ),this._invProjMatrix=new Float64Array(16),Tt.an(this._invProjMatrix,Hr),Hr[8]=2*-rt.x/this._helper._width,Hr[9]=2*rt.y/this._helper._height,this._projectionMatrix=Tt.aZ(Hr),Tt.M(Hr,Hr,[1,-1,1]),Tt.L(Hr,Hr,[0,0,-this._helper.cameraToCenterDistance]),Tt.a_(Hr,Hr,-this.rollInRadians),Tt.a$(Hr,Hr,this.pitchInRadians),Tt.a_(Hr,Hr,-this.bearingInRadians),Tt.L(Hr,Hr,[-$t,-qt,0]),this._mercatorMatrix=Tt.M([],Hr,[this.worldSize,this.worldSize,this.worldSize]),Tt.M(Hr,Hr,[1,1,this._helper._pixelPerMeter]),this._pixelMatrix=Tt.N(new Float64Array(16),this.clipSpaceToPixelsMatrix,Hr),Tt.L(Hr,Hr,[0,0,-this.elevation]),this._viewProjMatrix=Hr,this._invViewProjMatrix=Tt.an([],Hr);const wn=[0,0,-1,1];Tt.at(wn,wn,this._invViewProjMatrix),this._cameraPosition=[wn[0]/wn[3],wn[1]/wn[3],wn[2]/wn[3]],this._fogMatrix=new Float64Array(16),Tt.aY(this._fogMatrix,this.fovInRadians,this.width/this.height,ge,this._helper._farZ),this._fogMatrix[8]=2*-rt.x/this.width,this._fogMatrix[9]=2*rt.y/this.height,Tt.M(this._fogMatrix,this._fogMatrix,[1,-1,1]),Tt.L(this._fogMatrix,this._fogMatrix,[0,0,-this.cameraToCenterDistance]),Tt.a_(this._fogMatrix,this._fogMatrix,-this.rollInRadians),Tt.a$(this._fogMatrix,this._fogMatrix,this.pitchInRadians),Tt.a_(this._fogMatrix,this._fogMatrix,-this.bearingInRadians),Tt.L(this._fogMatrix,this._fogMatrix,[-$t,-qt,0]),Tt.M(this._fogMatrix,this._fogMatrix,[1,1,this._helper._pixelPerMeter]),Tt.L(this._fogMatrix,this._fogMatrix,[0,0,-this.elevation]),this._pixelMatrix3D=Tt.N(new Float64Array(16),this.clipSpaceToPixelsMatrix,Hr);const es=this._helper._width%2/2,ss=this._helper._height%2/2,os=Math.cos(this.bearingInRadians),cs=Math.sin(-this.bearingInRadians),ds=$t-Math.round($t)+os*es+cs*ss,Cs=qt-Math.round(qt)+os*ss+cs*es,Vs=new Float64Array(Hr);if(Tt.L(Vs,Vs,[ds>.5?ds-1:ds,Cs>.5?Cs-1:Cs,0]),this._alignedProjMatrix=Vs,Hr=Tt.an(new Float64Array(16),this._pixelMatrix),!Hr)throw new Error("failed to invert matrix");this._pixelMatrixInverse=Hr,this._clearMatrixCaches()}_clearMatrixCaches(){this._posMatrixCache.clear(),this._alignedPosMatrixCache.clear(),this._fogMatrixCacheF32.clear()}maxPitchScaleFactor(){if(!this._pixelMatrixInverse)return 1;const rt=this.screenPointToMercatorCoordinate(new Tt.P(0,0)),at=[rt.x*this.worldSize,rt.y*this.worldSize,0,1];return Tt.at(at,at,this._pixelMatrix)[3]/this._helper.cameraToCenterDistance}getCameraPoint(){return this._helper.getCameraPoint()}getCameraAltitude(){return this._helper.getCameraAltitude()}getCameraLngLat(){const rt=Tt.ag(1,this.center.lat)*this.worldSize;return _e(this.center,this.elevation,this.pitch,this.bearing,this._helper.cameraToCenterDistance/rt).toLngLat()}lngLatToCameraDepth(rt,at){const $t=Tt.$.fromLngLat(rt),qt=[$t.x*this.worldSize,$t.y*this.worldSize,at,1];return Tt.at(qt,qt,this._viewProjMatrix),qt[2]/qt[3]}getProjectionData(rt){const{overscaledTileID:at,aligned:$t,applyTerrainMatrix:qt}=rt,Kt=this._helper.getMercatorTileCoordinates(at),ge=at?this.calculatePosMatrix(at,$t,!0):null;let Hr;return Hr=at&&at.terrainRttPosMatrix32f&&qt?at.terrainRttPosMatrix32f:ge||Tt.b0(),{mainMatrix:Hr,tileMercatorCoords:Kt,clippingPlane:[0,0,0,0],projectionTransition:0,fallbackMatrix:Hr}}isLocationOccluded(rt){return!1}getPixelScale(){return 1}getCircleRadiusCorrection(){return 1}getPitchedTextCorrection(rt,at,Tt){return 1}transformLightDirection(rt){return Tt.aQ(rt)}getRayDirectionFromPixel(rt){throw new Error("Not implemented.")}projectTileCoordinates(rt,at,$t,qt){const Kt=this.calculatePosMatrix($t);let ge;qt?(ge=[rt,at,qt(rt,at),1],Tt.at(ge,ge,Kt)):(ge=[rt,at,0,1],We(ge,ge,Kt));const Hr=ge[3];return{point:new Tt.P(ge[0]/Hr,ge[1]/Hr),signedDistanceFromCamera:Hr,isOccluded:!1}}populateCache(rt){for(const at of rt)this.calculatePosMatrix(at)}getMatrixForModel(rt,at){const $t=Tt.$.fromLngLat(rt,at),qt=$t.meterInMercatorCoordinateUnits(),Kt=Tt.b1();return Tt.L(Kt,Kt,[$t.x,$t.y,$t.z]),Tt.a_(Kt,Kt,Math.PI),Tt.a$(Kt,Kt,Math.PI/2),Tt.M(Kt,Kt,[-qt,qt,qt]),Kt}getProjectionDataForCustomLayer(rt=!0){const at=new Tt.Y(0,0,0,0,0),$t=this.getProjectionData({overscaledTileID:at,applyGlobeMatrix:rt}),qt=de(at,this.worldSize);Tt.N(qt,this._viewProjMatrix,qt),$t.tileMercatorCoords=[0,0,1,1];const Kt=[Tt.Z,Tt.Z,this.worldSize/this._helper.pixelsPerMeter],ge=Tt.b2();return Tt.M(ge,qt,Kt),$t.fallbackMatrix=ge,$t.mainMatrix=ge,$t}getFastPathSimpleProjectionMatrix(rt){return this.calculatePosMatrix(rt)}}function kt(){Tt.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.")}function Ft(rt){if(rt.useSlerp)if(rt.k<1){const at=Tt.b3(rt.startEulerAngles.roll,rt.startEulerAngles.pitch,rt.startEulerAngles.bearing),$t=Tt.b3(rt.endEulerAngles.roll,rt.endEulerAngles.pitch,rt.endEulerAngles.bearing),qt=new Float64Array(4);Tt.b4(qt,at,$t,rt.k);const Kt=Tt.b5(qt);rt.tr.setRoll(Kt.roll),rt.tr.setPitch(Kt.pitch),rt.tr.setBearing(Kt.bearing)}else rt.tr.setRoll(rt.endEulerAngles.roll),rt.tr.setPitch(rt.endEulerAngles.pitch),rt.tr.setBearing(rt.endEulerAngles.bearing);else rt.tr.setRoll(Tt.B.number(rt.startEulerAngles.roll,rt.endEulerAngles.roll,rt.k)),rt.tr.setPitch(Tt.B.number(rt.startEulerAngles.pitch,rt.endEulerAngles.pitch,rt.k)),rt.tr.setBearing(Tt.B.number(rt.startEulerAngles.bearing,rt.endEulerAngles.bearing,rt.k))}function Bt(rt,at,$t,qt,Kt){const ge=Kt.padding,Hr=ce(Kt.worldSize,$t.getNorthWest()),wn=ce(Kt.worldSize,$t.getNorthEast()),es=ce(Kt.worldSize,$t.getSouthEast()),ss=ce(Kt.worldSize,$t.getSouthWest()),os=Tt.ab(-qt),cs=Hr.rotate(os),ds=wn.rotate(os),Cs=es.rotate(os),Vs=ss.rotate(os),Eo=new Tt.P(Math.max(cs.x,ds.x,Vs.x,Cs.x),Math.max(cs.y,ds.y,Vs.y,Cs.y)),Do=new Tt.P(Math.min(cs.x,ds.x,Vs.x,Cs.x),Math.min(cs.y,ds.y,Vs.y,Cs.y)),Ho=Eo.sub(Do),Ea=(Kt.width-(ge.left+ge.right+at.left+at.right))/Ho.x,La=(Kt.height-(ge.top+ge.bottom+at.top+at.bottom))/Ho.y;if(La<0||Ea<0)return void kt();const ja=Math.min(Tt.ah(Kt.scale*Math.min(Ea,La)),rt.maxZoom),Va=Tt.P.convert(rt.offset),Na=new Tt.P((at.left-at.right)/2,(at.top-at.bottom)/2).rotate(Tt.ab(qt)),qa=Va.add(Na).mult(Kt.scale/Tt.ac(ja));return{center:he(Kt.worldSize,Hr.add(es).div(2).sub(qa)),zoom:ja,bearing:qt}}class Ot{get useGlobeControls(){return!1}handlePanInertia(rt,at){return{easingOffset:rt,easingCenter:at.center}}handleMapControlsRollPitchBearingZoom(rt,at){rt.bearingDelta&&at.setBearing(at.bearing+rt.bearingDelta),rt.pitchDelta&&at.setPitch(at.pitch+rt.pitchDelta),rt.rollDelta&&at.setRoll(at.roll+rt.rollDelta),rt.zoomDelta&&at.setZoom(at.zoom+rt.zoomDelta)}handleMapControlsPan(rt,at,Tt){rt.around.distSqr(at.centerPoint)<.01||at.setLocationAtPoint(Tt,rt.around)}cameraForBoxAndBearing(rt,at,Tt,$t,qt){return Bt(rt,at,Tt,$t,qt)}handleJumpToCenterZoom(rt,at){rt.zoom!==(void 0!==at.zoom?+at.zoom:rt.zoom)&&rt.setZoom(+at.zoom),void 0!==at.center&&rt.setCenter(Tt.Q.convert(at.center))}handleEaseTo(rt,at){const $t=rt.zoom,qt=rt.padding,Kt={roll:rt.roll,pitch:rt.pitch,bearing:rt.bearing},ge={roll:void 0===at.roll?rt.roll:at.roll,pitch:void 0===at.pitch?rt.pitch:at.pitch,bearing:void 0===at.bearing?rt.bearing:at.bearing},Hr=void 0!==at.zoom,wn=!rt.isPaddingEqual(at.padding);let es=!1;const ss=Hr?+at.zoom:rt.zoom;let os=rt.centerPoint.add(at.offsetAsPoint);const cs=rt.screenPointToLocation(os),{center:ds,zoom:Cs}=rt.getConstrained(Tt.Q.convert(at.center||cs),null!=ss?ss:$t);Et(rt,ds);const Vs=ce(rt.worldSize,cs),Eo=ce(rt.worldSize,ds).sub(Vs),Do=Tt.ac(Cs-$t);return es=Cs!==$t,{easeFunc:Hr=>{if(es&&rt.setZoom(Tt.B.number($t,Cs,Hr)),Tt.b6(Kt,ge)||Ft({startEulerAngles:Kt,endEulerAngles:ge,tr:rt,k:Hr,useSlerp:Kt.roll!=ge.roll}),wn&&(rt.interpolatePadding(qt,at.padding,Hr),os=rt.centerPoint.add(at.offsetAsPoint)),at.around)rt.setLocationAtPoint(at.around,at.aroundPoint);else{const at=Tt.ac(rt.zoom-$t),qt=Cs>$t?Math.min(2,Do):Math.max(.5,Do),Kt=Math.pow(qt,1-Hr),ge=he(rt.worldSize,Vs.add(Eo.mult(Hr*Kt)).mult(at));rt.setLocationAtPoint(rt.renderWorldCopies?ge.wrap():ge,os)}},isZooming:es,elevationCenter:ds}}handleFlyTo(rt,at){const $t=void 0!==at.zoom,qt=rt.zoom,Kt=rt.getConstrained(Tt.Q.convert(at.center||at.locationAtOffset),$t?+at.zoom:qt),ge=Kt.center,Hr=Kt.zoom;Et(rt,ge);const wn=ce(rt.worldSize,at.locationAtOffset),es=ce(rt.worldSize,ge).sub(wn),ss=es.mag(),os=Tt.ac(Hr-qt);let cs;if(void 0!==at.minZoom){const $t=Math.min(+at.minZoom,qt,Hr),Kt=rt.getConstrained(ge,$t).zoom;cs=Tt.ac(Kt-qt)}return{easeFunc:(at,$t,Kt,ss)=>{rt.setZoom(1===at?Hr:qt+Tt.ah($t));const os=1===at?ge:he(rt.worldSize,wn.add(es.mult(Kt)).mult($t));rt.setLocationAtPoint(rt.renderWorldCopies?os.wrap():os,ss)},scaleOfZoom:os,targetCenter:ge,scaleOfMinZoom:cs,pixelPathLength:ss}}}class jt{constructor(rt,at,Tt){this.blendFunction=rt,this.blendColor=at,this.mask=Tt}}jt.Replace=[1,0],jt.disabled=new jt(jt.Replace,Tt.b7.transparent,[!1,!1,!1,!1]),jt.unblended=new jt(jt.Replace,Tt.b7.transparent,[!0,!0,!0,!0]),jt.alphaBlended=new jt([1,771],Tt.b7.transparent,[!0,!0,!0,!0]);const Jl=2305;class Nt{constructor(rt,at,Tt){this.enable=rt,this.mode=at,this.frontFace=Tt}}Nt.disabled=new Nt(!1,1029,Jl),Nt.backCCW=new Nt(!0,1029,Jl),Nt.frontCCW=new Nt(!0,1028,Jl);class Ut{constructor(rt,at,Tt){this.func=rt,this.mask=at,this.range=Tt}}Ut.ReadOnly=!1,Ut.ReadWrite=!0,Ut.disabled=new Ut(519,Ut.ReadOnly,[0,1]);const tc=7680;class Vt{constructor(rt,at,Tt,$t,qt,Kt){this.test=rt,this.ref=at,this.mask=Tt,this.fail=$t,this.depthFail=qt,this.pass=Kt}}Vt.disabled=new Vt({func:519,mask:0},0,0,tc,tc,tc);const ic=new WeakMap;function Wt(rt){var at;if(ic.has(rt))return ic.get(rt);{const Tt=null===(at=rt.getParameter(rt.VERSION))||void 0===at?void 0:at.startsWith("WebGL 2.0");return ic.set(rt,Tt),Tt}}class Ht{get awaitingQuery(){return!!this._readbackQueue}constructor(rt){this._readbackWaitFrames=4,this._measureWaitFrames=6,this._texWidth=1,this._texHeight=1,this._measuredError=0,this._updateCount=0,this._lastReadbackFrame=-1e3,this._readbackQueue=null,this._cachedRenderContext=rt;const at=rt.context,$t=at.gl;this._texFormat=$t.RGBA,this._texType=$t.UNSIGNED_BYTE;const qt=new Tt.aI;qt.emplaceBack(-1,-1),qt.emplaceBack(2,-1),qt.emplaceBack(-1,2);const Kt=new Tt.aK;Kt.emplaceBack(0,1,2),this._fullscreenTriangle=new wt(at.createVertexBuffer(qt,Xl.members),at.createIndexBuffer(Kt),Tt.aJ.simpleSegment(0,0,qt.length,Kt.length)),this._resultBuffer=new Uint8Array(4),at.activeTexture.set($t.TEXTURE1);const ge=$t.createTexture();$t.bindTexture($t.TEXTURE_2D,ge),$t.texParameteri($t.TEXTURE_2D,$t.TEXTURE_WRAP_S,$t.CLAMP_TO_EDGE),$t.texParameteri($t.TEXTURE_2D,$t.TEXTURE_WRAP_T,$t.CLAMP_TO_EDGE),$t.texParameteri($t.TEXTURE_2D,$t.TEXTURE_MIN_FILTER,$t.NEAREST),$t.texParameteri($t.TEXTURE_2D,$t.TEXTURE_MAG_FILTER,$t.NEAREST),$t.texImage2D($t.TEXTURE_2D,0,this._texFormat,this._texWidth,this._texHeight,0,this._texFormat,this._texType,null),this._fbo=at.createFramebuffer(this._texWidth,this._texHeight,!1,!1),this._fbo.colorAttachment.set(ge),Wt($t)&&(this._pbo=$t.createBuffer(),$t.bindBuffer($t.PIXEL_PACK_BUFFER,this._pbo),$t.bufferData($t.PIXEL_PACK_BUFFER,4,$t.STREAM_READ),$t.bindBuffer($t.PIXEL_PACK_BUFFER,null))}destroy(){const rt=this._cachedRenderContext.context.gl;this._fullscreenTriangle.destroy(),this._fbo.destroy(),rt.deleteBuffer(this._pbo),this._fullscreenTriangle=null,this._fbo=null,this._pbo=null,this._resultBuffer=null}updateErrorLoop(rt,at){const Tt=this._updateCount;return this._readbackQueue?Tt>=this._readbackQueue.frameNumberIssued+this._readbackWaitFrames&&this._tryReadback():Tt>=this._lastReadbackFrame+this._measureWaitFrames&&this._renderErrorTexture(rt,at),this._updateCount++,this._measuredError}_bindFramebuffer(){const rt=this._cachedRenderContext.context,at=rt.gl;rt.activeTexture.set(at.TEXTURE1),at.bindTexture(at.TEXTURE_2D,this._fbo.colorAttachment.get()),rt.bindFramebuffer.set(this._fbo.framebuffer)}_renderErrorTexture(rt,at){const $t=this._cachedRenderContext.context,qt=$t.gl;if(this._bindFramebuffer(),$t.viewport.set([0,0,this._texWidth,this._texHeight]),$t.clear({color:Tt.b7.transparent}),this._cachedRenderContext.useProgram("projectionErrorMeasurement").draw($t,qt.TRIANGLES,Ut.disabled,Vt.disabled,jt.unblended,Nt.disabled,((rt,at)=>({u_input:rt,u_output_expected:at}))(rt,at),null,null,"$clipping",this._fullscreenTriangle.vertexBuffer,this._fullscreenTriangle.indexBuffer,this._fullscreenTriangle.segments),this._pbo&&Wt(qt)){qt.bindBuffer(qt.PIXEL_PACK_BUFFER,this._pbo),qt.readBuffer(qt.COLOR_ATTACHMENT0),qt.readPixels(0,0,this._texWidth,this._texHeight,this._texFormat,this._texType,0),qt.bindBuffer(qt.PIXEL_PACK_BUFFER,null);const rt=qt.fenceSync(qt.SYNC_GPU_COMMANDS_COMPLETE,0);qt.flush(),this._readbackQueue={frameNumberIssued:this._updateCount,sync:rt}}else this._readbackQueue={frameNumberIssued:this._updateCount,sync:null}}_tryReadback(){const rt=this._cachedRenderContext.context.gl;if(this._pbo&&this._readbackQueue&&Wt(rt)){const at=rt.clientWaitSync(this._readbackQueue.sync,0,0);if(at===rt.WAIT_FAILED)return Tt.w("WebGL2 clientWaitSync failed."),this._readbackQueue=null,void(this._lastReadbackFrame=this._updateCount);if(at===rt.TIMEOUT_EXPIRED)return;rt.bindBuffer(rt.PIXEL_PACK_BUFFER,this._pbo),rt.getBufferSubData(rt.PIXEL_PACK_BUFFER,0,this._resultBuffer,0,4),rt.bindBuffer(rt.PIXEL_PACK_BUFFER,null)}else this._bindFramebuffer(),rt.readPixels(0,0,this._texWidth,this._texHeight,this._texFormat,this._texType,this._resultBuffer);this._readbackQueue=null,this._measuredError=Ht._parseRGBA8float(this._resultBuffer),this._lastReadbackFrame=this._updateCount}static _parseRGBA8float(rt){let at=0;return at+=rt[0]/256,at+=rt[1]/65536,at+=rt[2]/16777216,rt[3]<127&&(at=-at),at/128}}const sc=Tt.Z/128;function Xt(rt,at){const $t=void 0!==rt.granularity?Math.max(rt.granularity,1):1,qt=$t+(rt.generateBorders?2:0),Kt=$t+(rt.extendToNorthPole||rt.generateBorders?1:0)+(rt.extendToSouthPole||rt.generateBorders?1:0),ge=qt+1,Hr=Kt+1,wn=rt.generateBorders?-1:0,es=rt.generateBorders||rt.extendToNorthPole?-1:0,ss=$t+(rt.generateBorders?1:0),os=$t+(rt.generateBorders||rt.extendToSouthPole?1:0),cs=ge*Hr,ds=qt*Kt*6,Cs=ge*Hr>65536;if(Cs&&"16bit"===at)throw new Error("Granularity is too large and meshes would not fit inside 16 bit vertex indices.");const Vs=Cs||"32bit"===at,Eo=new Int16Array(2*cs);let Do=0;for(let at=es;at<=os;at++)for(let qt=wn;qt<=ss;qt++){let Kt=qt/$t*Tt.Z;-1===qt&&(Kt=-64),qt===$t+1&&(Kt=Tt.Z+sc);let ge=at/$t*Tt.Z;-1===at&&(ge=rt.extendToNorthPole?Tt.b9:-64),at===$t+1&&(ge=rt.extendToSouthPole?Tt.ba:Tt.Z+sc),Eo[Do++]=Kt,Eo[Do++]=ge}const Ho=Vs?new Uint32Array(ds):new Uint16Array(ds);let Ea=0;for(let rt=0;rt<Kt;rt++)for(let at=0;at<qt;at++){const Tt=at+1+rt*ge,$t=at+(rt+1)*ge,qt=at+1+(rt+1)*ge;Ho[Ea++]=at+rt*ge,Ho[Ea++]=$t,Ho[Ea++]=Tt,Ho[Ea++]=Tt,Ho[Ea++]=$t,Ho[Ea++]=qt}return{vertices:Eo.buffer.slice(0),indices:Ho.buffer.slice(0),uses32bitIndices:Vs}}const ac=new Tt.aH({fill:new Tt.bb(128,2),line:new Tt.bb(512,0),tile:new Tt.bb(128,32),stencil:new Tt.bb(128,1),circle:3});class Qt{constructor(){this._tileMeshCache={},this._errorCorrectionUsable=0,this._errorMeasurementLastValue=0,this._errorCorrectionPreviousValue=0,this._errorMeasurementLastChangeTime=-1e3}get name(){return"vertical-perspective"}get transitionState(){return 1}get useSubdivision(){return!0}get shaderVariantName(){return"globe"}get shaderDefine(){return"#define GLOBE"}get shaderPreludeCode(){return Hl.projectionGlobe}get vertexShaderPreludeCode(){return Hl.projectionMercator.vertexSource}get subdivisionGranularity(){return ac}get useGlobeControls(){return!0}get latitudeErrorCorrectionRadians(){return this._errorCorrectionUsable}destroy(){this._errorMeasurement&&this._errorMeasurement.destroy()}updateGPUdependent(rt){this._errorMeasurement||(this._errorMeasurement=new Ht(rt));const at=Tt.S(this._errorQueryLatitudeDegrees),$t=2*Math.atan(Math.exp(Math.PI-at*Math.PI*2))-.5*Math.PI,qt=this._errorMeasurement.updateErrorLoop(at,$t),Kt=ge.now();qt!==this._errorMeasurementLastValue&&(this._errorCorrectionPreviousValue=this._errorCorrectionUsable,this._errorMeasurementLastValue=qt,this._errorMeasurementLastChangeTime=Kt);const Hr=Math.min(Math.max((Kt-this._errorMeasurementLastChangeTime)/1e3/.5,0),1);this._errorCorrectionUsable=Tt.bc(this._errorCorrectionPreviousValue,-this._errorMeasurementLastValue,Tt.bd(Hr))}_getMeshKey(rt){return`${rt.granularity.toString(36)}_${rt.generateBorders?"b":""}${rt.extendToNorthPole?"n":""}${rt.extendToSouthPole?"s":""}`}getMeshFromTileID(rt,at,Tt,$t,qt){const Kt=("stencil"===qt?ac.stencil:ac.tile).getGranularityForZoomLevel(at.z);return this._getMesh(rt,{granularity:Kt,generateBorders:Tt,extendToNorthPole:0===at.y&&$t,extendToSouthPole:at.y===(1<<at.z)-1&&$t})}_getMesh(rt,at){const $t=this._getMeshKey(at);if($t in this._tileMeshCache)return this._tileMeshCache[$t];const qt=function(rt,at){const $t=Xt(at,"16bit"),qt=Tt.aI.deserialize({arrayBuffer:$t.vertices,length:$t.vertices.byteLength/2/2}),Kt=Tt.aK.deserialize({arrayBuffer:$t.indices,length:$t.indices.byteLength/2/3});return new wt(rt.createVertexBuffer(qt,Xl.members),rt.createIndexBuffer(Kt),Tt.aJ.simpleSegment(0,0,qt.length,Kt.length))}(rt,at);return this._tileMeshCache[$t]=qt,qt}recalculate(rt){}hasTransition(){const rt=ge.now();let at=!1;return at=at||(rt-this._errorMeasurementLastChangeTime)/1e3<.7,at=at||this._errorMeasurement&&this._errorMeasurement.awaitingQuery,at}setErrorQueryLatitudeDegrees(rt){this._errorQueryLatitudeDegrees=rt}}const Pc=new Tt.r({type:new Tt.D(Tt.v.projection.type)});class Jt extends Tt.E{constructor(rt){super(),this._transitionable=new Tt.T(Pc),this.setProjection(rt),this._transitioning=this._transitionable.untransitioned(),this.recalculate(new Tt.C(0)),this._mercatorProjection=new Mt,this._verticalPerspectiveProjection=new Qt}get transitionState(){const rt=this.properties.get("type");if("string"==typeof rt&&"mercator"===rt)return 0;if("string"==typeof rt&&"vertical-perspective"===rt)return 1;if(rt instanceof Tt.be){if("vertical-perspective"===rt.from&&"mercator"===rt.to)return 1-rt.transition;if("mercator"===rt.from&&"vertical-perspective"===rt.to)return rt.transition}return 1}get useGlobeRendering(){return this.transitionState>0}get latitudeErrorCorrectionRadians(){return this._verticalPerspectiveProjection.latitudeErrorCorrectionRadians}get currentProjection(){return this.useGlobeRendering?this._verticalPerspectiveProjection:this._mercatorProjection}get name(){return"globe"}get useSubdivision(){return this.currentProjection.useSubdivision}get shaderVariantName(){return this.currentProjection.shaderVariantName}get shaderDefine(){return this.currentProjection.shaderDefine}get shaderPreludeCode(){return this.currentProjection.shaderPreludeCode}get vertexShaderPreludeCode(){return this.currentProjection.vertexShaderPreludeCode}get subdivisionGranularity(){return this.currentProjection.subdivisionGranularity}get useGlobeControls(){return this.transitionState>0}destroy(){this._mercatorProjection.destroy(),this._verticalPerspectiveProjection.destroy()}updateGPUdependent(rt){this._mercatorProjection.updateGPUdependent(rt),this._verticalPerspectiveProjection.updateGPUdependent(rt)}getMeshFromTileID(rt,at,Tt,$t,qt){return this.currentProjection.getMeshFromTileID(rt,at,Tt,$t,qt)}setProjection(rt){this._transitionable.setValue("type",(null==rt?void 0:rt.type)||"mercator")}updateTransitions(rt){this._transitioning=this._transitionable.transitioned(rt,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()||this.currentProjection.hasTransition()}recalculate(rt){this.properties=this._transitioning.possiblyEvaluate(rt)}setErrorQueryLatitudeDegrees(rt){this._verticalPerspectiveProjection.setErrorQueryLatitudeDegrees(rt),this._mercatorProjection.setErrorQueryLatitudeDegrees(rt)}}function ei(rt){const at=ri(rt.worldSize,rt.center.lat);return 2*Math.PI*at}function ti(rt,at,$t,qt,Kt){const ge=1/(1<<Kt),Hr=at/Tt.Z*ge+qt*ge,wn=Tt.bg((rt/Tt.Z*ge+$t*ge)*Math.PI*2+Math.PI,2*Math.PI),es=2*Math.atan(Math.exp(Math.PI-Hr*Math.PI*2))-.5*Math.PI,ss=Math.cos(es),os=new Float64Array(3);return os[0]=Math.sin(wn)*ss,os[1]=Math.sin(es),os[2]=Math.cos(wn)*ss,os}function ii(rt){return function(rt,at){const Tt=Math.cos(at),$t=new Float64Array(3);return $t[0]=Math.sin(rt)*Tt,$t[1]=Math.sin(at),$t[2]=Math.cos(rt)*Tt,$t}(rt.lng*Math.PI/180,rt.lat*Math.PI/180)}function ri(rt,at){return rt/(2*Math.PI)/Math.cos(at*Math.PI/180)}function oi(rt){const at=Math.asin(rt[1])/Math.PI*180,$t=Math.sqrt(rt[0]*rt[0]+rt[2]*rt[2]);if($t>1e-6){const qt=rt[0]/$t,Kt=Math.acos(rt[2]/$t),ge=(qt>0?Kt:-Kt)/Math.PI*180;return new Tt.Q(Tt.aL(ge,-180,180),at)}return new Tt.Q(0,at)}function ai(rt){return Math.cos(rt*Math.PI/180)}function si(rt,at){const $t=ai(rt),qt=ai(at);return Tt.ah(qt/$t)}function ni(rt,at){const $t=rt.rotate(at.bearingInRadians),qt=at.zoom+si(at.center.lat,0),Kt=Tt.bc(1/ai(at.center.lat),1/ai(Math.min(Math.abs(at.center.lat),60)),Tt.bf(qt,7,3,0,1)),ge=360/ei({worldSize:at.worldSize,center:{lat:at.center.lat}});return new Tt.Q(at.center.lng-$t.x*ge*Kt,Tt.ae(at.center.lat+$t.y*ge,-85.051129,Tt.af))}function li(rt){const at=.5*rt,Tt=Math.sin(at),$t=Math.cos(at);return Math.log(Tt+$t)-Math.log($t-Tt)}function ci(rt,at,$t,qt){const Kt=rt.lat+$t*qt;if(Math.abs($t)>1){const ge=(Math.sign(rt.lat+$t)!==Math.sign(rt.lat)?-Math.abs(rt.lat):Math.abs(rt.lat))*Math.PI/180,Hr=Math.abs(rt.lat+$t)*Math.PI/180,wn=li(ge+qt*(Hr-ge)),es=li(ge),ss=li(Hr);return new Tt.Q(rt.lng+at*((wn-es)/(ss-es)),Kt)}return new Tt.Q(rt.lng+at*qt,Kt)}class hi{constructor(rt){this._cachePrevious=new Map,this._cache=new Map,this._hadAnyChanges=!1,this._aabbFactory=rt}recalculateCache(){if(!this._hadAnyChanges)return;const rt=this._cachePrevious;this._cachePrevious=this._cache,this._cache=rt,this._cache.clear(),this._hadAnyChanges=!1}getTileAABB(rt,at,Tt,$t){const qt=`${rt.z}_${rt.x}_${rt.y}`,Kt=this._cache.get(qt);if(Kt)return Kt;const ge=this._cachePrevious.get(qt);if(ge)return this._cache.set(qt,ge),ge;const Hr=this._aabbFactory(rt,at,Tt,$t);return this._cache.set(qt,Hr),this._hadAnyChanges=!0,Hr}}function ui(rt,at,Tt){const $t=rt-at;return $t<0?-$t:Math.max(0,$t-Tt)}function di(rt,at,Tt,$t,qt){const Kt=rt-Tt;let ge;return ge=Kt<0?Math.min(-Kt,1+Kt-qt):Kt>1?Math.min(Math.max(Kt-qt,0),1-Kt):0,Math.max(ge,ui(at,$t,qt))}class _i{constructor(){this._aabbCache=new hi(this._computeTileAABB)}recalculateCache(){this._aabbCache.recalculateCache()}distanceToTile2d(rt,at,Tt,$t){const qt=1<<Tt.z,Kt=1/qt,ge=Tt.x/qt,Hr=Tt.y/qt;let wn=2;return wn=Math.min(wn,di(rt,at,ge,Hr,Kt)),wn=Math.min(wn,di(rt,at,ge+.5,-Hr-Kt,Kt)),wn=Math.min(wn,di(rt,at,ge+.5,2-Hr-Kt,Kt)),wn}getWrap(rt,at,Tt){const $t=1<<at.z,qt=1/$t,Kt=at.x/$t,ge=ui(rt.x,Kt,qt),Hr=ui(rt.x,Kt-1,qt),wn=ui(rt.x,Kt+1,qt),es=Math.min(ge,Hr,wn);return es===wn?1:es===Hr?-1:0}allowVariableZoom(rt,at){return ve(rt,at)>4}allowWorldCopies(){return!1}getTileAABB(rt,at,Tt,$t){return this._aabbCache.getTileAABB(rt,at,Tt,$t)}_computeTileAABB(rt,at,$t,qt){if(rt.z<=0)return new Dt([-1,-1,-1],[1,1,1]);if(1===rt.z)return new Dt([0===rt.x?-1:0,0===rt.y?0:-1,-1],[0===rt.x?0:1,0===rt.y?1:0,1]);{const at=[ti(0,0,rt.x,rt.y,rt.z),ti(Tt.Z,0,rt.x,rt.y,rt.z),ti(Tt.Z,Tt.Z,rt.x,rt.y,rt.z),ti(0,Tt.Z,rt.x,rt.y,rt.z)],$t=[1,1,1],qt=[-1,-1,-1];for(const rt of at)for(let at=0;at<3;at++)$t[at]=Math.min($t[at],rt[at]),qt[at]=Math.max(qt[at],rt[at]);if(0===rt.y||rt.y===(1<<rt.z)-1){const at=[0,0===rt.y?1:-1,0];for(let rt=0;rt<3;rt++)$t[rt]=Math.min($t[rt],at[rt]),qt[rt]=Math.max(qt[rt],at[rt])}return new Dt($t,qt)}}}class pi{get pixelsToClipSpaceMatrix(){return this._helper.pixelsToClipSpaceMatrix}get clipSpaceToPixelsMatrix(){return this._helper.clipSpaceToPixelsMatrix}get pixelsToGLUnits(){return this._helper.pixelsToGLUnits}get centerOffset(){return this._helper.centerOffset}get size(){return this._helper.size}get rotationMatrix(){return this._helper.rotationMatrix}get centerPoint(){return this._helper.centerPoint}get pixelsPerMeter(){return this._helper.pixelsPerMeter}setMinZoom(rt){this._helper.setMinZoom(rt)}setMaxZoom(rt){this._helper.setMaxZoom(rt)}setMinPitch(rt){this._helper.setMinPitch(rt)}setMaxPitch(rt){this._helper.setMaxPitch(rt)}setRenderWorldCopies(rt){this._helper.setRenderWorldCopies(rt)}setBearing(rt){this._helper.setBearing(rt)}setPitch(rt){this._helper.setPitch(rt)}setRoll(rt){this._helper.setRoll(rt)}setFov(rt){this._helper.setFov(rt)}setZoom(rt){this._helper.setZoom(rt)}setCenter(rt){this._helper.setCenter(rt)}setElevation(rt){this._helper.setElevation(rt)}setMinElevationForCurrentTile(rt){this._helper.setMinElevationForCurrentTile(rt)}setPadding(rt){this._helper.setPadding(rt)}interpolatePadding(rt,at,Tt){return this._helper.interpolatePadding(rt,at,Tt)}isPaddingEqual(rt){return this._helper.isPaddingEqual(rt)}resize(rt,at){this._helper.resize(rt,at)}getMaxBounds(){return this._helper.getMaxBounds()}setMaxBounds(rt){this._helper.setMaxBounds(rt)}overrideNearFarZ(rt,at){this._helper.overrideNearFarZ(rt,at)}clearNearFarZOverride(){this._helper.clearNearFarZOverride()}getCameraQueryGeometry(rt){return this._helper.getCameraQueryGeometry(this.getCameraPoint(),rt)}get tileSize(){return this._helper.tileSize}get tileZoom(){return this._helper.tileZoom}get scale(){return this._helper.scale}get worldSize(){return this._helper.worldSize}get width(){return this._helper.width}get height(){return this._helper.height}get lngRange(){return this._helper.lngRange}get latRange(){return this._helper.latRange}get minZoom(){return this._helper.minZoom}get maxZoom(){return this._helper.maxZoom}get zoom(){return this._helper.zoom}get center(){return this._helper.center}get minPitch(){return this._helper.minPitch}get maxPitch(){return this._helper.maxPitch}get pitch(){return this._helper.pitch}get pitchInRadians(){return this._helper.pitchInRadians}get roll(){return this._helper.roll}get rollInRadians(){return this._helper.rollInRadians}get bearing(){return this._helper.bearing}get bearingInRadians(){return this._helper.bearingInRadians}get fov(){return this._helper.fov}get fovInRadians(){return this._helper.fovInRadians}get elevation(){return this._helper.elevation}get minElevationForCurrentTile(){return this._helper.minElevationForCurrentTile}get padding(){return this._helper.padding}get unmodified(){return this._helper.unmodified}get renderWorldCopies(){return this._helper.renderWorldCopies}get nearZ(){return this._helper.nearZ}get farZ(){return this._helper.farZ}get autoCalculateNearFarZ(){return this._helper.autoCalculateNearFarZ}setTransitionState(rt){}constructor(){this._cachedClippingPlane=Tt.bk(),this._projectionMatrix=Tt.b1(),this._globeViewProjMatrix32f=Tt.b0(),this._globeViewProjMatrixNoCorrection=Tt.b1(),this._globeViewProjMatrixNoCorrectionInverted=Tt.b1(),this._globeProjMatrixInverted=Tt.b1(),this._cameraPosition=Tt.bh(),this._globeLatitudeErrorCorrectionRadians=0,this._helper=new Rt({calcMatrices:()=>{this._calcMatrices()},getConstrained:(rt,at)=>this.getConstrained(rt,at)}),this._coveringTilesDetailsProvider=new _i}clone(){const rt=new pi;return rt.apply(this),rt}apply(rt,at){this._globeLatitudeErrorCorrectionRadians=at||0,this._helper.apply(rt)}get projectionMatrix(){return this._projectionMatrix}get modelViewProjectionMatrix(){return this._globeViewProjMatrixNoCorrection}get inverseProjectionMatrix(){return this._globeProjMatrixInverted}get cameraPosition(){const rt=Tt.bh();return rt[0]=this._cameraPosition[0],rt[1]=this._cameraPosition[1],rt[2]=this._cameraPosition[2],rt}get cameraToCenterDistance(){return this._helper.cameraToCenterDistance}getProjectionData(rt){const{overscaledTileID:at,applyGlobeMatrix:Tt}=rt,$t=this._helper.getMercatorTileCoordinates(at);return{mainMatrix:this._globeViewProjMatrix32f,tileMercatorCoords:$t,clippingPlane:this._cachedClippingPlane,projectionTransition:Tt?1:0,fallbackMatrix:this._globeViewProjMatrix32f}}_computeClippingPlane(rt){const at=this.pitchInRadians,$t=this.cameraToCenterDistance/rt,qt=Math.sin(at)*$t,Kt=Math.cos(at)*$t+1,ge=1/Math.sqrt(qt*qt+Kt*Kt)*1;let Hr=-qt,wn=Kt;const es=Math.sqrt(Hr*Hr+wn*wn);Hr/=es,wn/=es;const ss=[0,Hr,wn];Tt.bl(ss,ss,[0,0,0],-this.bearingInRadians),Tt.bm(ss,ss,[0,0,0],-1*this.center.lat*Math.PI/180),Tt.bn(ss,ss,[0,0,0],this.center.lng*Math.PI/180);const os=1/Tt.bo(ss);return Tt.aO(ss,ss,os),[...ss,-ge*os]}isLocationOccluded(rt){return!this.isSurfacePointVisible(ii(rt))}transformLightDirection(rt){const at=this._helper._center.lng*Math.PI/180,$t=this._helper._center.lat*Math.PI/180,qt=Math.cos($t),Kt=[Math.sin(at)*qt,Math.sin($t),Math.cos(at)*qt],ge=[Kt[2],0,-Kt[0]],Hr=[0,0,0];Tt.aU(Hr,ge,Kt),Tt.aT(ge,ge),Tt.aT(Hr,Hr);const wn=[0,0,0];return Tt.aT(wn,[ge[0]*rt[0]+Hr[0]*rt[1]+Kt[0]*rt[2],ge[1]*rt[0]+Hr[1]*rt[1]+Kt[1]*rt[2],ge[2]*rt[0]+Hr[2]*rt[1]+Kt[2]*rt[2]]),wn}getPixelScale(){return 1/Math.cos(this._helper._center.lat*Math.PI/180)}getCircleRadiusCorrection(){return Math.cos(this._helper._center.lat*Math.PI/180)}getPitchedTextCorrection(rt,at,$t){const qt=function(rt,at,$t){const qt=1/(1<<$t.z);return new Tt.$(rt/Tt.Z*qt+$t.x*qt,at/Tt.Z*qt+$t.y*qt)}(rt,at,$t.canonical),Kt=(ge=qt.y,[Tt.bg(qt.x*Math.PI*2+Math.PI,2*Math.PI),2*Math.atan(Math.exp(Math.PI-ge*Math.PI*2))-.5*Math.PI]);var ge;return this.getCircleRadiusCorrection()/Math.cos(Kt[1])}projectTileCoordinates(rt,at,$t,qt){const Kt=$t.canonical,ge=ti(rt,at,Kt.x,Kt.y,Kt.z),Hr=1+(qt?qt(rt,at):0)/Tt.bu,wn=[ge[0]*Hr,ge[1]*Hr,ge[2]*Hr,1];Tt.at(wn,wn,this._globeViewProjMatrixNoCorrection);const es=this._cachedClippingPlane,ss=es[0]*ge[0]+es[1]*ge[1]+es[2]*ge[2]+es[3]<0;return{point:new Tt.P(wn[0]/wn[3],wn[1]/wn[3]),signedDistanceFromCamera:wn[3],isOccluded:ss}}_calcMatrices(){if(!this._helper._width||!this._helper._height)return;const rt=ri(this.worldSize,this.center.lat),at=Tt.b2(),$t=Tt.b2();this._helper.autoCalculateNearFarZ&&(this._helper._nearZ=.5,this._helper._farZ=this.cameraToCenterDistance+2*rt),Tt.aY(at,this.fovInRadians,this.width/this.height,this._helper._nearZ,this._helper._farZ);const qt=this.centerOffset;at[8]=2*-qt.x/this._helper._width,at[9]=2*qt.y/this._helper._height,this._projectionMatrix=Tt.aZ(at),this._globeProjMatrixInverted=Tt.b2(),Tt.an(this._globeProjMatrixInverted,at),Tt.L(at,at,[0,0,-this.cameraToCenterDistance]),Tt.a_(at,at,this.rollInRadians),Tt.a$(at,at,-this.pitchInRadians),Tt.a_(at,at,this.bearingInRadians),Tt.L(at,at,[0,0,-rt]);const Kt=Tt.bh();Kt[0]=rt,Kt[1]=rt,Kt[2]=rt,Tt.a$($t,at,this.center.lat*Math.PI/180),Tt.bp($t,$t,-this.center.lng*Math.PI/180),Tt.M($t,$t,Kt),this._globeViewProjMatrixNoCorrection=$t,Tt.a$(at,at,this.center.lat*Math.PI/180-this._globeLatitudeErrorCorrectionRadians),Tt.bp(at,at,-this.center.lng*Math.PI/180),Tt.M(at,at,Kt),this._globeViewProjMatrix32f=new Float32Array(at),this._globeViewProjMatrixNoCorrectionInverted=Tt.b2(),Tt.an(this._globeViewProjMatrixNoCorrectionInverted,$t);const ge=Tt.bh();this._cameraPosition=Tt.bh(),this._cameraPosition[2]=this.cameraToCenterDistance/rt,Tt.bl(this._cameraPosition,this._cameraPosition,ge,-this.rollInRadians),Tt.bm(this._cameraPosition,this._cameraPosition,ge,this.pitchInRadians),Tt.bl(this._cameraPosition,this._cameraPosition,ge,-this.bearingInRadians),Tt.aP(this._cameraPosition,this._cameraPosition,[0,0,1]),Tt.bm(this._cameraPosition,this._cameraPosition,ge,-this.center.lat*Math.PI/180),Tt.bn(this._cameraPosition,this._cameraPosition,ge,this.center.lng*Math.PI/180),this._cachedClippingPlane=this._computeClippingPlane(rt);const Hr=Tt.aZ(this._globeViewProjMatrixNoCorrectionInverted);Tt.M(Hr,Hr,[1,1,-1]),this._cachedFrustum=At.fromInvProjectionMatrix(Hr)}calculateFogMatrix(rt){Tt.w("calculateFogMatrix is not supported on globe projection.");const at=Tt.b2();return Tt.ad(at),at}getVisibleUnwrappedCoordinates(rt){return[new Tt.aW(0,rt)]}getCameraFrustum(){return this._cachedFrustum}getClippingPlane(){return this._cachedClippingPlane}getCoveringTilesDetailsProvider(){return this._coveringTilesDetailsProvider}recalculateZoomAndCenter(rt){rt&&Tt.w("terrain is not fully supported on vertical perspective projection."),this._helper.recalculateZoomAndCenter(0)}maxPitchScaleFactor(){return 1}getCameraPoint(){return this._helper.getCameraPoint()}getCameraAltitude(){return this._helper.getCameraAltitude()}getCameraLngLat(){return this._helper.getCameraLngLat()}lngLatToCameraDepth(rt,at){if(!this._globeViewProjMatrixNoCorrection)return 1;const $t=ii(rt);Tt.aO($t,$t,1+at/Tt.bu);const qt=Tt.bk();return Tt.at(qt,[$t[0],$t[1],$t[2],1],this._globeViewProjMatrixNoCorrection),qt[2]/qt[3]}populateCache(rt){}getBounds(){const rt=.5*this.width,at=.5*this.height,$t=[new Tt.P(0,0),new Tt.P(rt,0),new Tt.P(this.width,0),new Tt.P(this.width,at),new Tt.P(this.width,this.height),new Tt.P(rt,this.height),new Tt.P(0,this.height),new Tt.P(0,at)],qt=[];for(const rt of $t)qt.push(this.unprojectScreenPoint(rt));let Kt=0,ge=0,Hr=0,wn=0;const es=this.center;for(const rt of qt){const at=Tt.bq(es.lng,rt.lng),$t=Tt.bq(es.lat,rt.lat);at<ge&&(ge=at),at>Kt&&(Kt=at),$t<wn&&(wn=$t),$t>Hr&&(Hr=$t)}const ss=[es.lng+ge,es.lat+wn,es.lng+Kt,es.lat+Hr];return this.isSurfacePointOnScreen([0,1,0])&&(ss[3]=90,ss[0]=-180,ss[2]=180),this.isSurfacePointOnScreen([0,-1,0])&&(ss[1]=-90,ss[0]=-180,ss[2]=180),new V(ss)}getConstrained(rt,at){const $t=Tt.ae(rt.lat,-85.051129,Tt.af),qt=Tt.ae(+at,this.minZoom+si(0,$t),this.maxZoom);return{center:new Tt.Q(rt.lng,$t),zoom:qt}}calculateCenterFromCameraLngLatAlt(rt,at,Tt,$t){return this._helper.calculateCenterFromCameraLngLatAlt(rt,at,Tt,$t)}setLocationAtPoint(rt,at){const $t=ii(this.unprojectScreenPoint(at)),qt=ii(rt),Kt=Tt.bh();Tt.br(Kt);const ge=Tt.bh();Tt.bn(ge,$t,Kt,-this.center.lng*Math.PI/180),Tt.bm(ge,ge,Kt,this.center.lat*Math.PI/180);const Hr=qt[0]*qt[0]+qt[2]*qt[2],wn=ge[0]*ge[0];if(Hr<wn)return;const es=Math.sqrt(Hr-wn),ss=-es,os=Tt.bs(qt[0],qt[2],ge[0],es),cs=Tt.bs(qt[0],qt[2],ge[0],ss),ds=Tt.bh();Tt.bn(ds,qt,Kt,-os);const Cs=Tt.bs(ds[1],ds[2],ge[1],ge[2]),Vs=Tt.bh();Tt.bn(Vs,qt,Kt,-cs);const Eo=Tt.bs(Vs[1],Vs[2],ge[1],ge[2]),Do=.5*Math.PI,Ho=Cs>=-Do&&Cs<=Do,Ea=Eo>=-Do&&Eo<=Do;let La,ja;if(Ho&&Ea){const rt=this.center.lng*Math.PI/180,at=this.center.lat*Math.PI/180;Tt.bv(os,rt)+Tt.bv(Cs,at)<Tt.bv(cs,rt)+Tt.bv(Eo,at)?(La=os,ja=Cs):(La=cs,ja=Eo)}else if(Ho)La=os,ja=Cs;else{if(!Ea)return;La=cs,ja=Eo}const Va=La/Math.PI*180,Na=ja/Math.PI*180,qa=this.center.lat;this.setCenter(new Tt.Q(Va,Tt.ae(Na,-90,90))),this.setZoom(this.zoom+si(qa,this.center.lat))}locationToScreenPoint(rt,at){const $t=ii(rt);if(at){const qt=at.getElevationForLngLatZoom(rt,this._helper._tileZoom);Tt.aO($t,$t,1+qt/Tt.bu)}return this._projectSurfacePointToScreen($t)}_projectSurfacePointToScreen(rt){const at=Tt.bk();return Tt.at(at,[...rt,1],this._globeViewProjMatrixNoCorrection),at[0]/=at[3],at[1]/=at[3],new Tt.P((.5*at[0]+.5)*this.width,(.5*-at[1]+.5)*this.height)}screenPointToMercatorCoordinate(rt,at){if(at){const Tt=at.pointCoordinate(rt);if(Tt)return Tt}return Tt.$.fromLngLat(this.unprojectScreenPoint(rt))}screenPointToLocation(rt,at){var Tt;return null===(Tt=this.screenPointToMercatorCoordinate(rt,at))||void 0===Tt?void 0:Tt.toLngLat()}isPointOnMapSurface(rt,at){const Tt=this._cameraPosition,$t=this.getRayDirectionFromPixel(rt);return!!this.rayPlanetIntersection(Tt,$t)}getRayDirectionFromPixel(rt){const at=Tt.bk();at[0]=rt.x/this.width*2-1,at[1]=-1*(rt.y/this.height*2-1),at[2]=1,at[3]=1,Tt.at(at,at,this._globeViewProjMatrixNoCorrectionInverted),at[0]/=at[3],at[1]/=at[3],at[2]/=at[3];const $t=Tt.bh();$t[0]=at[0]-this._cameraPosition[0],$t[1]=at[1]-this._cameraPosition[1],$t[2]=at[2]-this._cameraPosition[2];const qt=Tt.bh();return Tt.aT(qt,$t),qt}isSurfacePointVisible(rt){const at=this._cachedClippingPlane;return at[0]*rt[0]+at[1]*rt[1]+at[2]*rt[2]+at[3]>=0}isSurfacePointOnScreen(rt){if(!this.isSurfacePointVisible(rt))return!1;const at=Tt.bk();return Tt.at(at,[...rt,1],this._globeViewProjMatrixNoCorrection),at[0]/=at[3],at[1]/=at[3],at[2]/=at[3],at[0]>-1&&at[0]<1&&at[1]>-1&&at[1]<1&&at[2]>-1&&at[2]<1}rayPlanetIntersection(rt,at){const $t=Tt.aV(rt,at),qt=Tt.bh(),Kt=Tt.bh();Tt.aO(Kt,at,$t),Tt.aS(qt,rt,Kt);const ge=1-Tt.aV(qt,qt);if(ge<0)return null;const Hr=Tt.aV(rt,rt)-1,wn=-$t+($t<0?1:-1)*Math.sqrt(ge),es=Hr/wn,ss=wn;return{tMin:Math.min(es,ss),tMax:Math.max(es,ss)}}unprojectScreenPoint(rt){const at=this._cameraPosition,$t=this.getRayDirectionFromPixel(rt),qt=this.rayPlanetIntersection(at,$t);if(qt){const rt=Tt.bh();Tt.aP(rt,at,[$t[0]*qt.tMin,$t[1]*qt.tMin,$t[2]*qt.tMin]);const Kt=Tt.bh();return Tt.aT(Kt,rt),oi(Kt)}const Kt=this._cachedClippingPlane,ge=Kt[0]*$t[0]+Kt[1]*$t[1]+Kt[2]*$t[2],Hr=-Tt.bt(Kt,at)/ge,wn=Tt.bh();if(Hr>0)Tt.aP(wn,at,[$t[0]*Hr,$t[1]*Hr,$t[2]*Hr]);else{const rt=Tt.bh();Tt.aP(rt,at,[2*$t[0],2*$t[1],2*$t[2]]);const qt=Tt.bt(this._cachedClippingPlane,rt);Tt.aS(wn,rt,[this._cachedClippingPlane[0]*qt,this._cachedClippingPlane[1]*qt,this._cachedClippingPlane[2]*qt])}const es=function(rt){const at=Tt.bh();return at[0]=rt[0]*-rt[3],at[1]=rt[1]*-rt[3],at[2]=rt[2]*-rt[3],{center:at,radius:Math.sqrt(1-rt[3]*rt[3])}}(Kt);return oi(function(rt,at,$t){const qt=Tt.bh();Tt.aS(qt,$t,rt);const Kt=Tt.bh();return Tt.bi(Kt,rt,qt,at/Tt.bj(qt)),Kt}(es.center,es.radius,wn))}getMatrixForModel(rt,at){const $t=Tt.Q.convert(rt),qt=1/Tt.bu,Kt=Tt.b1();return Tt.bp(Kt,Kt,$t.lng/180*Math.PI),Tt.a$(Kt,Kt,-$t.lat/180*Math.PI),Tt.L(Kt,Kt,[0,0,1+at/Tt.bu]),Tt.a$(Kt,Kt,.5*Math.PI),Tt.M(Kt,Kt,[qt,qt,qt]),Kt}getProjectionDataForCustomLayer(rt=!0){const at=this.getProjectionData({overscaledTileID:new Tt.Y(0,0,0,0,0),applyGlobeMatrix:rt});return at.tileMercatorCoords=[0,0,1,1],at}getFastPathSimpleProjectionMatrix(rt){}}class mi{get pixelsToClipSpaceMatrix(){return this._helper.pixelsToClipSpaceMatrix}get clipSpaceToPixelsMatrix(){return this._helper.clipSpaceToPixelsMatrix}get pixelsToGLUnits(){return this._helper.pixelsToGLUnits}get centerOffset(){return this._helper.centerOffset}get size(){return this._helper.size}get rotationMatrix(){return this._helper.rotationMatrix}get centerPoint(){return this._helper.centerPoint}get pixelsPerMeter(){return this._helper.pixelsPerMeter}setMinZoom(rt){this._helper.setMinZoom(rt)}setMaxZoom(rt){this._helper.setMaxZoom(rt)}setMinPitch(rt){this._helper.setMinPitch(rt)}setMaxPitch(rt){this._helper.setMaxPitch(rt)}setRenderWorldCopies(rt){this._helper.setRenderWorldCopies(rt)}setBearing(rt){this._helper.setBearing(rt)}setPitch(rt){this._helper.setPitch(rt)}setRoll(rt){this._helper.setRoll(rt)}setFov(rt){this._helper.setFov(rt)}setZoom(rt){this._helper.setZoom(rt)}setCenter(rt){this._helper.setCenter(rt)}setElevation(rt){this._helper.setElevation(rt)}setMinElevationForCurrentTile(rt){this._helper.setMinElevationForCurrentTile(rt)}setPadding(rt){this._helper.setPadding(rt)}interpolatePadding(rt,at,Tt){return this._helper.interpolatePadding(rt,at,Tt)}isPaddingEqual(rt){return this._helper.isPaddingEqual(rt)}resize(rt,at,Tt=!0){this._helper.resize(rt,at,Tt)}getMaxBounds(){return this._helper.getMaxBounds()}setMaxBounds(rt){this._helper.setMaxBounds(rt)}overrideNearFarZ(rt,at){this._helper.overrideNearFarZ(rt,at)}clearNearFarZOverride(){this._helper.clearNearFarZOverride()}getCameraQueryGeometry(rt){return this._helper.getCameraQueryGeometry(this.getCameraPoint(),rt)}get tileSize(){return this._helper.tileSize}get tileZoom(){return this._helper.tileZoom}get scale(){return this._helper.scale}get worldSize(){return this._helper.worldSize}get width(){return this._helper.width}get height(){return this._helper.height}get lngRange(){return this._helper.lngRange}get latRange(){return this._helper.latRange}get minZoom(){return this._helper.minZoom}get maxZoom(){return this._helper.maxZoom}get zoom(){return this._helper.zoom}get center(){return this._helper.center}get minPitch(){return this._helper.minPitch}get maxPitch(){return this._helper.maxPitch}get pitch(){return this._helper.pitch}get pitchInRadians(){return this._helper.pitchInRadians}get roll(){return this._helper.roll}get rollInRadians(){return this._helper.rollInRadians}get bearing(){return this._helper.bearing}get bearingInRadians(){return this._helper.bearingInRadians}get fov(){return this._helper.fov}get fovInRadians(){return this._helper.fovInRadians}get elevation(){return this._helper.elevation}get minElevationForCurrentTile(){return this._helper.minElevationForCurrentTile}get padding(){return this._helper.padding}get unmodified(){return this._helper.unmodified}get renderWorldCopies(){return this._helper.renderWorldCopies}get cameraToCenterDistance(){return this._helper.cameraToCenterDistance}get nearZ(){return this._helper.nearZ}get farZ(){return this._helper.farZ}get autoCalculateNearFarZ(){return this._helper.autoCalculateNearFarZ}get isGlobeRendering(){return this._globeness>0}setTransitionState(rt,at){this._globeness=rt,this._globeLatitudeErrorCorrectionRadians=at,this._calcMatrices(),this._verticalPerspectiveTransform.getCoveringTilesDetailsProvider().recalculateCache(),this._mercatorTransform.getCoveringTilesDetailsProvider().recalculateCache()}get currentTransform(){return this.isGlobeRendering?this._verticalPerspectiveTransform:this._mercatorTransform}constructor(){this._globeLatitudeErrorCorrectionRadians=0,this._globeness=1,this._helper=new Rt({calcMatrices:()=>{this._calcMatrices()},getConstrained:(rt,at)=>this.getConstrained(rt,at)}),this._globeness=1,this._mercatorTransform=new Lt,this._verticalPerspectiveTransform=new pi}clone(){const rt=new mi;return rt._globeness=this._globeness,rt._globeLatitudeErrorCorrectionRadians=this._globeLatitudeErrorCorrectionRadians,rt.apply(this),rt}apply(rt){this._helper.apply(rt),this._mercatorTransform.apply(this),this._verticalPerspectiveTransform.apply(this,this._globeLatitudeErrorCorrectionRadians)}get projectionMatrix(){return this.currentTransform.projectionMatrix}get modelViewProjectionMatrix(){return this.currentTransform.modelViewProjectionMatrix}get inverseProjectionMatrix(){return this.currentTransform.inverseProjectionMatrix}get cameraPosition(){return this.currentTransform.cameraPosition}getProjectionData(rt){const at=this._mercatorTransform.getProjectionData(rt),Tt=this._verticalPerspectiveTransform.getProjectionData(rt);return{mainMatrix:this.isGlobeRendering?Tt.mainMatrix:at.mainMatrix,clippingPlane:Tt.clippingPlane,tileMercatorCoords:Tt.tileMercatorCoords,projectionTransition:rt.applyGlobeMatrix?this._globeness:0,fallbackMatrix:at.fallbackMatrix}}isLocationOccluded(rt){return this.currentTransform.isLocationOccluded(rt)}transformLightDirection(rt){return this.currentTransform.transformLightDirection(rt)}getPixelScale(){return Tt.bc(this._mercatorTransform.getPixelScale(),this._verticalPerspectiveTransform.getPixelScale(),this._globeness)}getCircleRadiusCorrection(){return Tt.bc(this._mercatorTransform.getCircleRadiusCorrection(),this._verticalPerspectiveTransform.getCircleRadiusCorrection(),this._globeness)}getPitchedTextCorrection(rt,at,$t){const qt=this._mercatorTransform.getPitchedTextCorrection(rt,at,$t),Kt=this._verticalPerspectiveTransform.getPitchedTextCorrection(rt,at,$t);return Tt.bc(qt,Kt,this._globeness)}projectTileCoordinates(rt,at,Tt,$t){return this.currentTransform.projectTileCoordinates(rt,at,Tt,$t)}_calcMatrices(){this._helper._width&&this._helper._height&&(this._verticalPerspectiveTransform.apply(this,this._globeLatitudeErrorCorrectionRadians),this._helper._nearZ=this._verticalPerspectiveTransform.nearZ,this._helper._farZ=this._verticalPerspectiveTransform.farZ,this._mercatorTransform.apply(this,!0,this.isGlobeRendering),this._helper._nearZ=this._mercatorTransform.nearZ,this._helper._farZ=this._mercatorTransform.farZ)}calculateFogMatrix(rt){return this.currentTransform.calculateFogMatrix(rt)}getVisibleUnwrappedCoordinates(rt){return this.currentTransform.getVisibleUnwrappedCoordinates(rt)}getCameraFrustum(){return this.currentTransform.getCameraFrustum()}getClippingPlane(){return this.currentTransform.getClippingPlane()}getCoveringTilesDetailsProvider(){return this.currentTransform.getCoveringTilesDetailsProvider()}recalculateZoomAndCenter(rt){this._mercatorTransform.recalculateZoomAndCenter(rt),this._verticalPerspectiveTransform.recalculateZoomAndCenter(rt)}maxPitchScaleFactor(){return this._mercatorTransform.maxPitchScaleFactor()}getCameraPoint(){return this._helper.getCameraPoint()}getCameraAltitude(){return this._helper.getCameraAltitude()}getCameraLngLat(){return this._helper.getCameraLngLat()}lngLatToCameraDepth(rt,at){return this.currentTransform.lngLatToCameraDepth(rt,at)}populateCache(rt){this._mercatorTransform.populateCache(rt),this._verticalPerspectiveTransform.populateCache(rt)}getBounds(){return this.currentTransform.getBounds()}getConstrained(rt,at){return this.currentTransform.getConstrained(rt,at)}calculateCenterFromCameraLngLatAlt(rt,at,Tt,$t){return this._helper.calculateCenterFromCameraLngLatAlt(rt,at,Tt,$t)}setLocationAtPoint(rt,at){if(!this.isGlobeRendering)return this._mercatorTransform.setLocationAtPoint(rt,at),void this.apply(this._mercatorTransform);this._verticalPerspectiveTransform.setLocationAtPoint(rt,at),this.apply(this._verticalPerspectiveTransform)}locationToScreenPoint(rt,at){return this.currentTransform.locationToScreenPoint(rt,at)}screenPointToMercatorCoordinate(rt,at){return this.currentTransform.screenPointToMercatorCoordinate(rt,at)}screenPointToLocation(rt,at){return this.currentTransform.screenPointToLocation(rt,at)}isPointOnMapSurface(rt,at){return this.currentTransform.isPointOnMapSurface(rt,at)}getRayDirectionFromPixel(rt){return this._verticalPerspectiveTransform.getRayDirectionFromPixel(rt)}getMatrixForModel(rt,at){return this.currentTransform.getMatrixForModel(rt,at)}getProjectionDataForCustomLayer(rt=!0){const at=this._mercatorTransform.getProjectionDataForCustomLayer(rt);if(!this.isGlobeRendering)return at;const Tt=this._verticalPerspectiveTransform.getProjectionDataForCustomLayer(rt);return Tt.fallbackMatrix=at.mainMatrix,Tt}getFastPathSimpleProjectionMatrix(rt){return this.currentTransform.getFastPathSimpleProjectionMatrix(rt)}}class fi{get useGlobeControls(){return!0}handlePanInertia(rt,at){const $t=ni(rt,at);return Math.abs($t.lng-at.center.lng)>180&&($t.lng=at.center.lng+179.5*Math.sign($t.lng-at.center.lng)),{easingCenter:$t,easingOffset:new Tt.P(0,0)}}handleMapControlsRollPitchBearingZoom(rt,at){const $t=rt.around,qt=at.screenPointToLocation($t);rt.bearingDelta&&at.setBearing(at.bearing+rt.bearingDelta),rt.pitchDelta&&at.setPitch(at.pitch+rt.pitchDelta),rt.rollDelta&&at.setRoll(at.roll+rt.rollDelta);const Kt=at.zoom;rt.zoomDelta&&at.setZoom(at.zoom+rt.zoomDelta);const ge=at.zoom-Kt;if(0===ge)return;const Hr=Tt.bq(at.center.lng,qt.lng),wn=Hr/(Math.abs(Hr/180)+1),es=Tt.bq(at.center.lat,qt.lat),ss=at.getRayDirectionFromPixel($t),os=at.cameraPosition,cs=-1*Tt.aV(os,ss),ds=Tt.bh();Tt.aP(ds,os,[ss[0]*cs,ss[1]*cs,ss[2]*cs]);const Cs=Tt.bo(ds)-1,Vs=Math.exp(.5*-Math.max(Cs-.3,0)),Eo=ri(at.worldSize,at.center.lat)/Math.min(at.width,at.height),Do=Tt.bf(Eo,.9,.5,1,.25),Ho=(1-Tt.ac(-ge))*Math.min(Vs,Do),Ea=at.center.lat,La=at.zoom,ja=new Tt.Q(at.center.lng+wn*Ho,Tt.ae(at.center.lat+es*Ho,-85.051129,Tt.af));at.setLocationAtPoint(qt,$t);const Va=at.center,Na=Tt.bf(Math.abs(Hr),45,85,0,1),qa=Tt.bf(Eo,.75,.35,0,1),Qa=Math.pow(Math.max(Na,qa),.25),Pl=Tt.bq(Va.lng,ja.lng),zl=Tt.bq(Va.lat,ja.lat);at.setCenter(new Tt.Q(Va.lng+Pl*Qa,Va.lat+zl*Qa).wrap()),at.setZoom(La+si(Ea,at.center.lat))}handleMapControlsPan(rt,at,Tt){if(!rt.panDelta)return;const $t=at.center.lat,qt=at.zoom;at.setCenter(ni(rt.panDelta,at).wrap()),at.setZoom(qt+si($t,at.center.lat))}cameraForBoxAndBearing(rt,at,$t,qt,Kt){const ge=Bt(rt,at,$t,qt,Kt),Hr=at.left/Kt.width*2-1,wn=(Kt.width-at.right)/Kt.width*2-1,es=at.top/Kt.height*-2+1,ss=(Kt.height-at.bottom)/Kt.height*-2+1,os=Tt.bq($t.getWest(),$t.getEast())<0,cs=os?$t.getEast():$t.getWest(),ds=os?$t.getWest():$t.getEast(),Cs=Math.max($t.getNorth(),$t.getSouth()),Vs=Math.min($t.getNorth(),$t.getSouth()),Eo=cs+.5*Tt.bq(cs,ds),Do=Cs+.5*Tt.bq(Cs,Vs),Ho=Kt.clone();Ho.setCenter(ge.center),Ho.setBearing(ge.bearing),Ho.setPitch(0),Ho.setRoll(0),Ho.setZoom(ge.zoom);const Ea=Ho.modelViewProjectionMatrix,La=[ii($t.getNorthWest()),ii($t.getNorthEast()),ii($t.getSouthWest()),ii($t.getSouthEast()),ii(new Tt.Q(ds,Do)),ii(new Tt.Q(cs,Do)),ii(new Tt.Q(Eo,Cs)),ii(new Tt.Q(Eo,Vs))],ja=ii(ge.center);let Va=Number.POSITIVE_INFINITY;for(const rt of La)Hr<0&&(Va=fi.getLesserNonNegativeNonNull(Va,fi.solveVectorScale(rt,ja,Ea,"x",Hr))),wn>0&&(Va=fi.getLesserNonNegativeNonNull(Va,fi.solveVectorScale(rt,ja,Ea,"x",wn))),es>0&&(Va=fi.getLesserNonNegativeNonNull(Va,fi.solveVectorScale(rt,ja,Ea,"y",es))),ss<0&&(Va=fi.getLesserNonNegativeNonNull(Va,fi.solveVectorScale(rt,ja,Ea,"y",ss)));if(Number.isFinite(Va)&&0!==Va)return ge.zoom=Ho.zoom+Tt.ah(Va),ge;kt()}handleJumpToCenterZoom(rt,at){const $t=rt.center.lat,qt=rt.getConstrained(at.center?Tt.Q.convert(at.center):rt.center,rt.zoom).center;rt.setCenter(qt.wrap());const Kt=void 0!==at.zoom?+at.zoom:rt.zoom+si($t,qt.lat);rt.zoom!==Kt&&rt.setZoom(Kt)}handleEaseTo(rt,at){const $t=rt.zoom,qt=rt.center,Kt=rt.padding,ge={roll:rt.roll,pitch:rt.pitch,bearing:rt.bearing},Hr={roll:void 0===at.roll?rt.roll:at.roll,pitch:void 0===at.pitch?rt.pitch:at.pitch,bearing:void 0===at.bearing?rt.bearing:at.bearing},wn=void 0!==at.zoom,es=!rt.isPaddingEqual(at.padding);let ss=!1;const os=at.center?Tt.Q.convert(at.center):qt,cs=rt.getConstrained(os,$t).center;Et(rt,cs);const ds=rt.clone();ds.setCenter(cs),ds.setZoom(wn?+at.zoom:$t+si(qt.lat,os.lat)),ds.setBearing(at.bearing);const Cs=new Tt.P(Tt.ae(rt.centerPoint.x+at.offsetAsPoint.x,0,rt.width),Tt.ae(rt.centerPoint.y+at.offsetAsPoint.y,0,rt.height));ds.setLocationAtPoint(cs,Cs);const Vs=(at.offset&&at.offsetAsPoint.mag())>0?ds.center:cs,Eo=wn?+at.zoom:$t+si(qt.lat,Vs.lat),Do=$t+si(qt.lat,0),Ho=Eo+si(Vs.lat,0),Ea=Tt.bq(qt.lng,Vs.lng),La=Tt.bq(qt.lat,Vs.lat),ja=Tt.ac(Ho-Do);return ss=Eo!==$t,{easeFunc:$t=>{if(Tt.b6(ge,Hr)||Ft({startEulerAngles:ge,endEulerAngles:Hr,tr:rt,k:$t,useSlerp:ge.roll!=Hr.roll}),es&&rt.interpolatePadding(Kt,at.padding,$t),at.around)Tt.w("Easing around a point is not supported under globe projection."),rt.setLocationAtPoint(at.around,at.aroundPoint);else{const at=Ho>Do?Math.min(2,ja):Math.max(.5,ja),Tt=Math.pow(at,1-$t),Kt=ci(qt,Ea,La,$t*Tt);rt.setCenter(Kt.wrap())}if(ss){const at=Tt.B.number(Do,Ho,$t)+si(0,rt.center.lat);rt.setZoom(at)}},isZooming:ss,elevationCenter:Vs}}handleFlyTo(rt,at){const $t=void 0!==at.zoom,qt=rt.center,Kt=rt.zoom,ge=rt.padding,Hr=!rt.isPaddingEqual(at.padding),wn=rt.getConstrained(Tt.Q.convert(at.center||at.locationAtOffset),Kt).center,es=$t?+at.zoom:rt.zoom+si(rt.center.lat,wn.lat),ss=rt.clone();ss.setCenter(wn),ss.setZoom(es),ss.setBearing(at.bearing);const os=new Tt.P(Tt.ae(rt.centerPoint.x+at.offsetAsPoint.x,0,rt.width),Tt.ae(rt.centerPoint.y+at.offsetAsPoint.y,0,rt.height));ss.setLocationAtPoint(wn,os);const cs=ss.center;Et(rt,cs);const ds=function(rt,at,$t){const qt=ii(at),Kt=ii($t),ge=Tt.aV(qt,Kt),Hr=Math.acos(ge),wn=ei(rt);return Hr/(2*Math.PI)*wn}(rt,qt,cs),Cs=Kt+si(qt.lat,0),Vs=es+si(cs.lat,0),Eo=Tt.ac(Vs-Cs);let Do;if("number"==typeof at.minZoom){const $t=+at.minZoom+si(cs.lat,0),qt=Math.min($t,Cs,Vs)+si(0,cs.lat),Kt=rt.getConstrained(cs,qt).zoom+si(cs.lat,0);Do=Tt.ac(Kt-Cs)}const Ho=Tt.bq(qt.lng,cs.lng),Ea=Tt.bq(qt.lat,cs.lat);return{easeFunc:($t,Kt,wn,ss)=>{const os=ci(qt,Ho,Ea,wn);Hr&&rt.interpolatePadding(ge,at.padding,$t);const ds=1===$t?cs:os;rt.setCenter(ds.wrap());const Vs=Cs+Tt.ah(Kt);rt.setZoom(1===$t?es:Vs+si(0,ds.lat))},scaleOfZoom:Eo,targetCenter:cs,scaleOfMinZoom:Do,pixelPathLength:ds}}static solveVectorScale(rt,at,Tt,$t,qt){const Kt="x"===$t?[Tt[0],Tt[4],Tt[8],Tt[12]]:[Tt[1],Tt[5],Tt[9],Tt[13]],ge=[Tt[3],Tt[7],Tt[11],Tt[15]],Hr=rt[0]*Kt[0]+rt[1]*Kt[1]+rt[2]*Kt[2],wn=rt[0]*ge[0]+rt[1]*ge[1]+rt[2]*ge[2],es=at[0]*Kt[0]+at[1]*Kt[1]+at[2]*Kt[2],ss=at[0]*ge[0]+at[1]*ge[1]+at[2]*ge[2];return es+qt*wn===Hr+qt*ss||ge[3]*(Hr-es)+Kt[3]*(ss-wn)+Hr*ss==es*wn?null:(es+Kt[3]-qt*ss-qt*ge[3])/(es-Hr-qt*ss+qt*wn)}static getLesserNonNegativeNonNull(rt,at){return null!==at&&at>=0&&at<rt?at:rt}}class gi{constructor(rt){this._globe=rt,this._mercatorCameraHelper=new Ot,this._verticalPerspectiveCameraHelper=new fi}get useGlobeControls(){return this._globe.useGlobeRendering}get currentHelper(){return this.useGlobeControls?this._verticalPerspectiveCameraHelper:this._mercatorCameraHelper}handlePanInertia(rt,at){return this.currentHelper.handlePanInertia(rt,at)}handleMapControlsRollPitchBearingZoom(rt,at){return this.currentHelper.handleMapControlsRollPitchBearingZoom(rt,at)}handleMapControlsPan(rt,at,Tt){this.currentHelper.handleMapControlsPan(rt,at,Tt)}cameraForBoxAndBearing(rt,at,Tt,$t,qt){return this.currentHelper.cameraForBoxAndBearing(rt,at,Tt,$t,qt)}handleJumpToCenterZoom(rt,at){this.currentHelper.handleJumpToCenterZoom(rt,at)}handleEaseTo(rt,at){return this.currentHelper.handleEaseTo(rt,at)}handleFlyTo(rt,at){return this.currentHelper.handleFlyTo(rt,at)}}const vi=(rt,at)=>Tt.x(rt,at&&at.filter((rt=>"source.canvas"!==rt.identifier))),Sc=Tt.bw();class bi extends Tt.E{constructor(rt,at={}){super(),this._rtlPluginLoaded=()=>{for(const rt in this.sourceCaches){const at=this.sourceCaches[rt].getSource().type;"vector"!==at&&"geojson"!==at||this.sourceCaches[rt].reload()}},this.map=rt,this.dispatcher=new B(F(),rt._getMapId()),this.dispatcher.registerMessageHandler("GG",((rt,at)=>this.getGlyphs(rt,at))),this.dispatcher.registerMessageHandler("GI",((rt,at)=>this.getImages(rt,at))),this.imageManager=new b,this.imageManager.setEventedParent(this),this.glyphManager=new P(rt._requestManager,at.localIdeographFontFamily),this.lineAtlas=new R(256,512),this.crossTileSymbolIndex=new vt,this._spritesImagesIds={},this._layers={},this._order=[],this.sourceCaches={},this.zoomHistory=new Tt.bx,this._loaded=!1,this._availableImages=[],this._resetUpdates(),this.dispatcher.broadcast("SR",Tt.by()),oe().on(ja,this._rtlPluginLoaded),this.on("data",(rt=>{if("source"!==rt.dataType||"metadata"!==rt.sourceDataType)return;const at=this.sourceCaches[rt.sourceId];if(!at)return;const Tt=at.getSource();if(Tt&&Tt.vectorLayerIds)for(const rt in this._layers){const at=this._layers[rt];at.source===Tt.id&&this._validateLayer(at)}}))}loadURL(rt,at={},$t){this.fire(new Tt.l("dataloading",{dataType:"style"})),at.validate="boolean"!=typeof at.validate||at.validate;const qt=this.map._requestManager.transformRequest(rt,"Style");this._loadStyleRequest=new AbortController;const Kt=this._loadStyleRequest;Tt.j(qt,this._loadStyleRequest).then((rt=>{this._loadStyleRequest=null,this._load(rt.data,at,$t)})).catch((rt=>{this._loadStyleRequest=null,rt&&!Kt.signal.aborted&&this.fire(new Tt.k(rt))}))}loadJSON(rt,at={},$t){this.fire(new Tt.l("dataloading",{dataType:"style"})),this._frameRequest=new AbortController,ge.frameAsync(this._frameRequest).then((()=>{this._frameRequest=null,at.validate=!1!==at.validate,this._load(rt,at,$t)})).catch((()=>{}))}loadEmpty(){this.fire(new Tt.l("dataloading",{dataType:"style"})),this._load(Sc,{validate:!1})}_load(rt,at,$t){var qt,Kt;const ge=at.transformStyle?at.transformStyle($t,rt):rt;if(!at.validate||!vi(this,Tt.y(ge))){this._loaded=!0,this.stylesheet=ge;for(const rt in ge.sources)this.addSource(rt,ge.sources[rt],{validate:!1});ge.sprite?this._loadSprite(ge.sprite):this.imageManager.setLoaded(!0),this.glyphManager.setURL(ge.glyphs),this._createLayers(),this.light=new I(this.stylesheet.light),this._setProjectionInternal((null===(qt=this.stylesheet.projection)||void 0===qt?void 0:qt.type)||"mercator"),this.sky=new S(this.stylesheet.sky),this.map.setTerrain(null!==(Kt=this.stylesheet.terrain)&&void 0!==Kt?Kt:null),this.fire(new Tt.l("data",{dataType:"style"})),this.fire(new Tt.l("style.load"))}}_createLayers(){const rt=Tt.bz(this.stylesheet.layers);this.dispatcher.broadcast("SL",rt),this._order=rt.map((rt=>rt.id)),this._layers={},this._serializedLayers=null;for(const at of rt){const rt=Tt.bA(at);rt.setEventedParent(this,{layer:{id:at.id}}),this._layers[at.id]=rt}}_loadSprite(rt,at=!1,$t=void 0){let qt;this.imageManager.setLoaded(!1),this._spriteRequest=new AbortController,function(rt,at,$t,qt){return Tt._(this,void 0,void 0,(function*(){const Kt=f(rt),Hr=$t>1?"@2x":"",wn={},es={};for(const{id:rt,url:$t}of Kt){const Kt=at.transformRequest(g($t,Hr,".json"),"SpriteJSON");wn[rt]=Tt.j(Kt,qt);const ge=at.transformRequest(g($t,Hr,".png"),"SpriteImage");es[rt]=cs.getImage(ge,qt)}return yield Promise.all([...Object.values(wn),...Object.values(es)]),function(rt,at){return Tt._(this,void 0,void 0,(function*(){const Tt={};for(const $t in rt){Tt[$t]={};const qt=ge.getImageCanvasContext((yield at[$t]).data),Kt=(yield rt[$t]).data;for(const rt in Kt){const{width:at,height:ge,x:Hr,y:wn,sdf:es,pixelRatio:ss,stretchX:os,stretchY:cs,content:ds,textFitWidth:Cs,textFitHeight:Vs}=Kt[rt];Tt[$t][rt]={data:null,pixelRatio:ss,sdf:es,stretchX:os,stretchY:cs,content:ds,textFitWidth:Cs,textFitHeight:Vs,spriteData:{width:at,height:ge,x:Hr,y:wn,context:qt}}}}return Tt}))}(wn,es)}))}(rt,this.map._requestManager,this.map.getPixelRatio(),this._spriteRequest).then((rt=>{if(this._spriteRequest=null,rt)for(const Tt in rt){this._spritesImagesIds[Tt]=[];const $t=this._spritesImagesIds[Tt]?this._spritesImagesIds[Tt].filter((at=>!(at in rt))):[];for(const rt of $t)this.imageManager.removeImage(rt),this._changedImages[rt]=!0;for(const $t in rt[Tt]){const qt="default"===Tt?$t:`${Tt}:${$t}`;this._spritesImagesIds[Tt].push(qt),qt in this.imageManager.images?this.imageManager.updateImage(qt,rt[Tt][$t],!1):this.imageManager.addImage(qt,rt[Tt][$t]),at&&(this._changedImages[qt]=!0)}}})).catch((rt=>{this._spriteRequest=null,qt=rt,this.fire(new Tt.k(qt))})).finally((()=>{this.imageManager.setLoaded(!0),this._availableImages=this.imageManager.listImages(),at&&(this._changed=!0),this.dispatcher.broadcast("SI",this._availableImages),this.fire(new Tt.l("data",{dataType:"style"})),$t&&$t(qt)}))}_unloadSprite(){for(const rt of Object.values(this._spritesImagesIds).flat())this.imageManager.removeImage(rt),this._changedImages[rt]=!0;this._spritesImagesIds={},this._availableImages=this.imageManager.listImages(),this._changed=!0,this.dispatcher.broadcast("SI",this._availableImages),this.fire(new Tt.l("data",{dataType:"style"}))}_validateLayer(rt){const at=this.sourceCaches[rt.source];if(!at)return;const $t=rt.sourceLayer;if(!$t)return;const qt=at.getSource();("geojson"===qt.type||qt.vectorLayerIds&&-1===qt.vectorLayerIds.indexOf($t))&&this.fire(new Tt.k(new Error(`Source layer "${$t}" does not exist on source "${qt.id}" as specified by style layer "${rt.id}".`)))}loaded(){if(!this._loaded)return!1;if(Object.keys(this._updatedSources).length)return!1;for(const rt in this.sourceCaches)if(!this.sourceCaches[rt].loaded())return!1;return!!this.imageManager.isLoaded()}_serializeByIds(rt,at=!1){const $t=this._serializedAllLayers();if(!rt||0===rt.length)return Object.values(at?Tt.bB($t):$t);const qt=[];for(const Kt of rt)if($t[Kt]){const rt=at?Tt.bB($t[Kt]):$t[Kt];qt.push(rt)}return qt}_serializedAllLayers(){let rt=this._serializedLayers;if(rt)return rt;rt=this._serializedLayers={};const at=Object.keys(this._layers);for(const Tt of at){const at=this._layers[Tt];"custom"!==at.type&&(rt[Tt]=at.serialize())}return rt}hasTransitions(){var rt,at,Tt;if(null===(rt=this.light)||void 0===rt?void 0:rt.hasTransition())return!0;if(null===(at=this.sky)||void 0===at?void 0:at.hasTransition())return!0;if(null===(Tt=this.projection)||void 0===Tt?void 0:Tt.hasTransition())return!0;for(const rt in this.sourceCaches)if(this.sourceCaches[rt].hasTransition())return!0;for(const rt in this._layers)if(this._layers[rt].hasTransition())return!0;return!1}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading.")}update(rt){if(!this._loaded)return;const at=this._changed;if(at){const at=Object.keys(this._updatedLayers),Tt=Object.keys(this._removedLayers);(at.length||Tt.length)&&this._updateWorkerLayers(at,Tt);for(const rt in this._updatedSources){const at=this._updatedSources[rt];if("reload"===at)this._reloadSource(rt);else{if("clear"!==at)throw new Error(`Invalid action ${at}`);this._clearSource(rt)}}this._updateTilesForChangedImages(),this._updateTilesForChangedGlyphs();for(const at in this._updatedPaintProps)this._layers[at].updateTransitions(rt);this.light.updateTransitions(rt),this.sky.updateTransitions(rt),this._resetUpdates()}const $t={};for(const rt in this.sourceCaches){const at=this.sourceCaches[rt];$t[rt]=at.used,at.used=!1}for(const at of this._order){const Tt=this._layers[at];Tt.recalculate(rt,this._availableImages),!Tt.isHidden(rt.zoom)&&Tt.source&&(this.sourceCaches[Tt.source].used=!0)}for(const rt in $t){const at=this.sourceCaches[rt];!!$t[rt]!=!!at.used&&at.fire(new Tt.l("data",{sourceDataType:"visibility",dataType:"source",sourceId:rt}))}this.light.recalculate(rt),this.sky.recalculate(rt),this.projection.recalculate(rt),this.z=rt.zoom,at&&this.fire(new Tt.l("data",{dataType:"style"}))}_updateTilesForChangedImages(){const rt=Object.keys(this._changedImages);if(rt.length){for(const at in this.sourceCaches)this.sourceCaches[at].reloadTilesForDependencies(["icons","patterns"],rt);this._changedImages={}}}_updateTilesForChangedGlyphs(){if(this._glyphsDidChange){for(const rt in this.sourceCaches)this.sourceCaches[rt].reloadTilesForDependencies(["glyphs"],[""]);this._glyphsDidChange=!1}}_updateWorkerLayers(rt,at){this.dispatcher.broadcast("UL",{layers:this._serializeByIds(rt,!1),removedIds:at})}_resetUpdates(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSources={},this._updatedPaintProps={},this._changedImages={},this._glyphsDidChange=!1}setState(rt,at={}){var $t;this._checkLoaded();const qt=this.serialize();if(rt=at.transformStyle?at.transformStyle(qt,rt):rt,(null===($t=at.validate)||void 0===$t||$t)&&vi(this,Tt.y(rt)))return!1;(rt=Tt.bB(rt)).layers=Tt.bz(rt.layers);const Kt=Tt.bC(qt,rt),ge=this._getOperationsToPerform(Kt);if(ge.unimplemented.length>0)throw new Error(`Unimplemented: ${ge.unimplemented.join(", ")}.`);if(0===ge.operations.length)return!1;for(const rt of ge.operations)rt();return this.stylesheet=rt,this._serializedLayers=null,!0}_getOperationsToPerform(rt){const at=[],Tt=[];for(const $t of rt)switch($t.command){case"setCenter":case"setZoom":case"setBearing":case"setPitch":case"setRoll":continue;case"addLayer":at.push((()=>this.addLayer.apply(this,$t.args)));break;case"removeLayer":at.push((()=>this.removeLayer.apply(this,$t.args)));break;case"setPaintProperty":at.push((()=>this.setPaintProperty.apply(this,$t.args)));break;case"setLayoutProperty":at.push((()=>this.setLayoutProperty.apply(this,$t.args)));break;case"setFilter":at.push((()=>this.setFilter.apply(this,$t.args)));break;case"addSource":at.push((()=>this.addSource.apply(this,$t.args)));break;case"removeSource":at.push((()=>this.removeSource.apply(this,$t.args)));break;case"setLayerZoomRange":at.push((()=>this.setLayerZoomRange.apply(this,$t.args)));break;case"setLight":at.push((()=>this.setLight.apply(this,$t.args)));break;case"setGeoJSONSourceData":at.push((()=>this.setGeoJSONSourceData.apply(this,$t.args)));break;case"setGlyphs":at.push((()=>this.setGlyphs.apply(this,$t.args)));break;case"setSprite":at.push((()=>this.setSprite.apply(this,$t.args)));break;case"setTerrain":at.push((()=>this.map.setTerrain.apply(this,$t.args)));break;case"setSky":at.push((()=>this.setSky.apply(this,$t.args)));break;case"setProjection":this.setProjection.apply(this,$t.args);break;case"setTransition":at.push((()=>{}));break;default:Tt.push($t.command)}return{operations:at,unimplemented:Tt}}addImage(rt,at){if(this.getImage(rt))return this.fire(new Tt.k(new Error(`An image named "${rt}" already exists.`)));this.imageManager.addImage(rt,at),this._afterImageUpdated(rt)}updateImage(rt,at){this.imageManager.updateImage(rt,at)}getImage(rt){return this.imageManager.getImage(rt)}removeImage(rt){if(!this.getImage(rt))return this.fire(new Tt.k(new Error(`An image named "${rt}" does not exist.`)));this.imageManager.removeImage(rt),this._afterImageUpdated(rt)}_afterImageUpdated(rt){this._availableImages=this.imageManager.listImages(),this._changedImages[rt]=!0,this._changed=!0,this.dispatcher.broadcast("SI",this._availableImages),this.fire(new Tt.l("data",{dataType:"style"}))}listImages(){return this._checkLoaded(),this.imageManager.listImages()}addSource(rt,at,$t={}){if(this._checkLoaded(),void 0!==this.sourceCaches[rt])throw new Error(`Source "${rt}" already exists.`);if(!at.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(at).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(at.type)>=0&&this._validate(Tt.y.source,`sources.${rt}`,at,null,$t))return;this.map&&this.map._collectResourceTiming&&(at.collectResourceTiming=!0);const qt=this.sourceCaches[rt]=new be(rt,at,this.dispatcher);qt.style=this,qt.setEventedParent(this,(()=>({isSourceLoaded:qt.loaded(),source:qt.serialize(),sourceId:rt}))),qt.onAdd(this.map),this._changed=!0}removeSource(rt){if(this._checkLoaded(),void 0===this.sourceCaches[rt])throw new Error("There is no source with this ID");for(const at in this._layers)if(this._layers[at].source===rt)return this.fire(new Tt.k(new Error(`Source "${rt}" cannot be removed while layer "${at}" is using it.`)));const at=this.sourceCaches[rt];delete this.sourceCaches[rt],delete this._updatedSources[rt],at.fire(new Tt.l("data",{sourceDataType:"metadata",dataType:"source",sourceId:rt})),at.setEventedParent(null),at.onRemove(this.map),this._changed=!0}setGeoJSONSourceData(rt,at){if(this._checkLoaded(),void 0===this.sourceCaches[rt])throw new Error(`There is no source with this ID=${rt}`);const Tt=this.sourceCaches[rt].getSource();if("geojson"!==Tt.type)throw new Error(`geojsonSource.type is ${Tt.type}, which is !== 'geojson`);Tt.setData(at),this._changed=!0}getSource(rt){return this.sourceCaches[rt]&&this.sourceCaches[rt].getSource()}addLayer(rt,at,$t={}){this._checkLoaded();const qt=rt.id;if(this.getLayer(qt))return void this.fire(new Tt.k(new Error(`Layer "${qt}" already exists on this map.`)));let Kt;if("custom"===rt.type){if(vi(this,Tt.bD(rt)))return;Kt=Tt.bA(rt)}else{if("source"in rt&&"object"==typeof rt.source&&(this.addSource(qt,rt.source),rt=Tt.bB(rt),rt=Tt.e(rt,{source:qt})),this._validate(Tt.y.layer,`layers.${qt}`,rt,{arrayIndex:-1},$t))return;Kt=Tt.bA(rt),this._validateLayer(Kt),Kt.setEventedParent(this,{layer:{id:qt}})}const ge=at?this._order.indexOf(at):this._order.length;if(at&&-1===ge)this.fire(new Tt.k(new Error(`Cannot add layer "${qt}" before non-existing layer "${at}".`)));else{if(this._order.splice(ge,0,qt),this._layerOrderChanged=!0,this._layers[qt]=Kt,this._removedLayers[qt]&&Kt.source&&"custom"!==Kt.type){const rt=this._removedLayers[qt];delete this._removedLayers[qt],rt.type!==Kt.type?this._updatedSources[Kt.source]="clear":(this._updatedSources[Kt.source]="reload",this.sourceCaches[Kt.source].pause())}this._updateLayer(Kt),Kt.onAdd&&Kt.onAdd(this.map)}}moveLayer(rt,at){if(this._checkLoaded(),this._changed=!0,!this._layers[rt])return void this.fire(new Tt.k(new Error(`The layer '${rt}' does not exist in the map's style and cannot be moved.`)));if(rt===at)return;const $t=this._order.indexOf(rt);this._order.splice($t,1);const qt=at?this._order.indexOf(at):this._order.length;at&&-1===qt?this.fire(new Tt.k(new Error(`Cannot move layer "${rt}" before non-existing layer "${at}".`))):(this._order.splice(qt,0,rt),this._layerOrderChanged=!0)}removeLayer(rt){this._checkLoaded();const at=this._layers[rt];if(!at)return void this.fire(new Tt.k(new Error(`Cannot remove non-existing layer "${rt}".`)));at.setEventedParent(null);const $t=this._order.indexOf(rt);this._order.splice($t,1),this._layerOrderChanged=!0,this._changed=!0,this._removedLayers[rt]=at,delete this._layers[rt],this._serializedLayers&&delete this._serializedLayers[rt],delete this._updatedLayers[rt],delete this._updatedPaintProps[rt],at.onRemove&&at.onRemove(this.map)}getLayer(rt){return this._layers[rt]}getLayersOrder(){return[...this._order]}hasLayer(rt){return rt in this._layers}setLayerZoomRange(rt,at,$t){this._checkLoaded();const qt=this.getLayer(rt);qt?qt.minzoom===at&&qt.maxzoom===$t||(null!=at&&(qt.minzoom=at),null!=$t&&(qt.maxzoom=$t),this._updateLayer(qt)):this.fire(new Tt.k(new Error(`Cannot set the zoom range of non-existing layer "${rt}".`)))}setFilter(rt,at,$t={}){this._checkLoaded();const qt=this.getLayer(rt);if(qt){if(!Tt.bE(qt.filter,at))return null==at?(qt.filter=void 0,void this._updateLayer(qt)):void(this._validate(Tt.y.filter,`layers.${qt.id}.filter`,at,null,$t)||(qt.filter=Tt.bB(at),this._updateLayer(qt)))}else this.fire(new Tt.k(new Error(`Cannot filter non-existing layer "${rt}".`)))}getFilter(rt){return Tt.bB(this.getLayer(rt).filter)}setLayoutProperty(rt,at,$t,qt={}){this._checkLoaded();const Kt=this.getLayer(rt);Kt?Tt.bE(Kt.getLayoutProperty(at),$t)||(Kt.setLayoutProperty(at,$t,qt),this._updateLayer(Kt)):this.fire(new Tt.k(new Error(`Cannot style non-existing layer "${rt}".`)))}getLayoutProperty(rt,at){const $t=this.getLayer(rt);if($t)return $t.getLayoutProperty(at);this.fire(new Tt.k(new Error(`Cannot get style of non-existing layer "${rt}".`)))}setPaintProperty(rt,at,$t,qt={}){this._checkLoaded();const Kt=this.getLayer(rt);Kt?Tt.bE(Kt.getPaintProperty(at),$t)||(Kt.setPaintProperty(at,$t,qt)&&this._updateLayer(Kt),this._changed=!0,this._updatedPaintProps[rt]=!0,this._serializedLayers=null):this.fire(new Tt.k(new Error(`Cannot style non-existing layer "${rt}".`)))}getPaintProperty(rt,at){return this.getLayer(rt).getPaintProperty(at)}setFeatureState(rt,at){this._checkLoaded();const $t=rt.source,qt=rt.sourceLayer,Kt=this.sourceCaches[$t];if(void 0===Kt)return void this.fire(new Tt.k(new Error(`The source '${$t}' does not exist in the map's style.`)));const ge=Kt.getSource().type;"geojson"===ge&&qt?this.fire(new Tt.k(new Error("GeoJSON sources cannot have a sourceLayer parameter."))):"vector"!==ge||qt?(void 0===rt.id&&this.fire(new Tt.k(new Error("The feature id parameter must be provided."))),Kt.setFeatureState(qt,rt.id,at)):this.fire(new Tt.k(new Error("The sourceLayer parameter must be provided for vector source types.")))}removeFeatureState(rt,at){this._checkLoaded();const $t=rt.source,qt=this.sourceCaches[$t];if(void 0===qt)return void this.fire(new Tt.k(new Error(`The source '${$t}' does not exist in the map's style.`)));const Kt=qt.getSource().type,ge="vector"===Kt?rt.sourceLayer:void 0;"vector"!==Kt||ge?at&&"string"!=typeof rt.id&&"number"!=typeof rt.id?this.fire(new Tt.k(new Error("A feature id is required to remove its specific state property."))):qt.removeFeatureState(ge,rt.id,at):this.fire(new Tt.k(new Error("The sourceLayer parameter must be provided for vector source types.")))}getFeatureState(rt){this._checkLoaded();const at=rt.source,$t=rt.sourceLayer,qt=this.sourceCaches[at];if(void 0!==qt)return"vector"!==qt.getSource().type||$t?(void 0===rt.id&&this.fire(new Tt.k(new Error("The feature id parameter must be provided."))),qt.getFeatureState($t,rt.id)):void this.fire(new Tt.k(new Error("The sourceLayer parameter must be provided for vector source types.")));this.fire(new Tt.k(new Error(`The source '${at}' does not exist in the map's style.`)))}getTransition(){return Tt.e({duration:300,delay:0},this.stylesheet&&this.stylesheet.transition)}serialize(){if(!this._loaded)return;const rt=Tt.bF(this.sourceCaches,(rt=>rt.serialize())),at=this._serializeByIds(this._order,!0),$t=this.map.getTerrain()||void 0,qt=this.stylesheet;return Tt.bG({version:qt.version,name:qt.name,metadata:qt.metadata,light:qt.light,sky:qt.sky,center:qt.center,zoom:qt.zoom,bearing:qt.bearing,pitch:qt.pitch,sprite:qt.sprite,glyphs:qt.glyphs,transition:qt.transition,projection:qt.projection,sources:rt,layers:at,terrain:$t},(rt=>void 0!==rt))}_updateLayer(rt){this._updatedLayers[rt.id]=!0,rt.source&&!this._updatedSources[rt.source]&&"raster"!==this.sourceCaches[rt.source].getSource().type&&(this._updatedSources[rt.source]="reload",this.sourceCaches[rt.source].pause()),this._serializedLayers=null,this._changed=!0}_flattenAndSortRenderedFeatures(rt){const t=rt=>"fill-extrusion"===this._layers[rt].type,at={},Tt=[];for(let $t=this._order.length-1;$t>=0;$t--){const qt=this._order[$t];if(t(qt)){at[qt]=$t;for(const at of rt){const rt=at[qt];if(rt)for(const at of rt)Tt.push(at)}}}Tt.sort(((rt,at)=>at.intersectionZ-rt.intersectionZ));const $t=[];for(let qt=this._order.length-1;qt>=0;qt--){const Kt=this._order[qt];if(t(Kt))for(let rt=Tt.length-1;rt>=0;rt--){const Kt=Tt[rt].feature;if(at[Kt.layer.id]<qt)break;$t.push(Kt),Tt.pop()}else for(const at of rt){const rt=at[Kt];if(rt)for(const at of rt)$t.push(at.feature)}}return $t}queryRenderedFeatures(rt,at,$t){at&&at.filter&&this._validate(Tt.y.filter,"queryRenderedFeatures.filter",at.filter,null,at);const qt={};if(at&&at.layers){if(!(Array.isArray(at.layers)||at.layers instanceof Set))return this.fire(new Tt.k(new Error("parameters.layers must be an Array or a Set of strings"))),[];for(const rt of at.layers){const at=this._layers[rt];if(!at)return this.fire(new Tt.k(new Error(`The layer '${rt}' does not exist in the map's style and cannot be queried for features.`))),[];qt[at.source]=!0}}const Kt=[];at.availableImages=this._availableImages;const ge=this._serializedAllLayers(),Hr=at.layers instanceof Set?at.layers:Array.isArray(at.layers)?new Set(at.layers):null,wn=Object.assign(Object.assign({},at),{layers:Hr});for(const Tt in this.sourceCaches)at.layers&&!qt[Tt]||Kt.push(Z(this.sourceCaches[Tt],this._layers,ge,rt,wn,$t,this.map.terrain?(rt,at,Tt)=>this.map.terrain.getElevation(rt,at,Tt):void 0));return this.placement&&Kt.push(function(rt,at,Tt,$t,qt,Kt,ge){const Hr={},wn=Kt.queryRenderedSymbols($t),es=[];for(const rt of Object.keys(wn).map(Number))es.push(ge[rt]);es.sort(N);for(const Tt of es){const $t=Tt.featureIndex.lookupSymbolFeatures(wn[Tt.bucketInstanceId],at,Tt.bucketIndex,Tt.sourceLayerIndex,qt.filter,qt.layers,qt.availableImages,rt);for(const rt in $t){const at=Hr[rt]=Hr[rt]||[],qt=$t[rt];qt.sort(((rt,at)=>{const $t=Tt.featureSortOrder;if($t){const Tt=$t.indexOf(rt.featureIndex);return $t.indexOf(at.featureIndex)-Tt}return at.featureIndex-rt.featureIndex}));for(const rt of qt)at.push(rt)}}return function(rt,at,Tt){for(const $t in rt)for(const qt of rt[$t])U(qt,Tt[at[$t].source]);return rt}(Hr,rt,Tt)}(this._layers,ge,this.sourceCaches,rt,wn,this.placement.collisionIndex,this.placement.retainedQueryData)),this._flattenAndSortRenderedFeatures(Kt)}querySourceFeatures(rt,at){at&&at.filter&&this._validate(Tt.y.filter,"querySourceFeatures.filter",at.filter,null,at);const $t=this.sourceCaches[rt];return $t?function(rt,at){const Tt=rt.getRenderableIds().map((at=>rt.getTileByID(at))),$t=[],qt={};for(let rt=0;rt<Tt.length;rt++){const Kt=Tt[rt],ge=Kt.tileID.canonical.key;qt[ge]||(qt[ge]=!0,Kt.querySourceFeatures($t,at))}return $t}($t,at):[]}getLight(){return this.light.getLight()}setLight(rt,at={}){this._checkLoaded();const $t=this.light.getLight();let qt=!1;for(const at in rt)if(!Tt.bE(rt[at],$t[at])){qt=!0;break}if(!qt)return;const Kt={now:ge.now(),transition:Tt.e({duration:300,delay:0},this.stylesheet.transition)};this.light.setLight(rt,at),this.light.updateTransitions(Kt)}getProjection(){var rt;return null===(rt=this.stylesheet)||void 0===rt?void 0:rt.projection}setProjection(rt){if(this._checkLoaded(),this.projection){if(this.projection.name===rt.type)return;this.projection.destroy(),delete this.projection}this.stylesheet.projection=rt,this._setProjectionInternal(rt.type)}getSky(){var rt;return null===(rt=this.stylesheet)||void 0===rt?void 0:rt.sky}setSky(rt,at={}){this._checkLoaded();const $t=this.getSky();let qt=!1;if(!rt&&!$t)return;if(rt&&!$t)qt=!0;else if(!rt&&$t)qt=!0;else for(const at in rt)if(!Tt.bE(rt[at],$t[at])){qt=!0;break}if(!qt)return;const Kt={now:ge.now(),transition:Tt.e({duration:300,delay:0},this.stylesheet.transition)};this.stylesheet.sky=rt,this.sky.setSky(rt,at),this.sky.updateTransitions(Kt)}_setProjectionInternal(rt){const at=function(rt){if(Array.isArray(rt)){const at=new Jt({type:rt});return{projection:at,transform:new mi,cameraHelper:new gi(at)}}switch(rt){case"mercator":return{projection:new Mt,transform:new Lt,cameraHelper:new Ot};case"globe":{const rt=new Jt({type:["interpolate",["linear"],["zoom"],11,"vertical-perspective",12,"mercator"]});return{projection:rt,transform:new mi,cameraHelper:new gi(rt)}}case"vertical-perspective":return{projection:new Qt,transform:new pi,cameraHelper:new fi};default:return Tt.w(`Unknown projection name: ${rt}. Falling back to mercator projection.`),{projection:new Mt,transform:new Lt,cameraHelper:new Ot}}}(rt);this.projection=at.projection,this.map.migrateProjection(at.transform,at.cameraHelper);for(const rt in this.sourceCaches)this.sourceCaches[rt].reload()}_validate(rt,at,$t,qt,Kt={}){return(!Kt||!1!==Kt.validate)&&vi(this,rt.call(Tt.y,Tt.e({key:at,style:this.serialize(),value:$t,styleSpec:Tt.v},qt)))}_remove(rt=!0){this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this._loadStyleRequest&&(this._loadStyleRequest.abort(),this._loadStyleRequest=null),this._spriteRequest&&(this._spriteRequest.abort(),this._spriteRequest=null),oe().off(ja,this._rtlPluginLoaded);for(const rt in this._layers)this._layers[rt].setEventedParent(null);for(const rt in this.sourceCaches){const at=this.sourceCaches[rt];at.setEventedParent(null),at.onRemove(this.map)}this.imageManager.setEventedParent(null),this.setEventedParent(null),rt&&this.dispatcher.broadcast("RM",void 0),this.dispatcher.remove(rt)}_clearSource(rt){this.sourceCaches[rt].clearTiles()}_reloadSource(rt){this.sourceCaches[rt].resume(),this.sourceCaches[rt].reload()}_updateSources(rt){for(const at in this.sourceCaches)this.sourceCaches[at].update(rt,this.map.terrain)}_generateCollisionBoxes(){for(const rt in this.sourceCaches)this._reloadSource(rt)}_updatePlacement(rt,at,Tt,$t,qt=!1){let Kt=!1,Hr=!1;const wn={};for(const at of this._order){const Tt=this._layers[at];if("symbol"!==Tt.type)continue;if(!wn[Tt.source]){const rt=this.sourceCaches[Tt.source];wn[Tt.source]=rt.getRenderableIds(!0).map((at=>rt.getTileByID(at))).sort(((rt,at)=>at.tileID.overscaledZ-rt.tileID.overscaledZ||(rt.tileID.isLessThan(at.tileID)?-1:1)))}const $t=this.crossTileSymbolIndex.addLayer(Tt,wn[Tt.source],rt.center.lng);Kt=Kt||$t}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._order),((qt=qt||this._layerOrderChanged||0===Tt)||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(ge.now(),rt.zoom))&&(this.pauseablePlacement=new _t(rt,this.map.terrain,this._order,qt,at,Tt,$t,this.placement),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._order,this._layers,wn),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(ge.now()),Hr=!0),Kt&&this.pauseablePlacement.placement.setStale()),Hr||Kt)for(const rt of this._order){const at=this._layers[rt];"symbol"===at.type&&this.placement.updateLayerOpacities(at,wn[at.source])}return!this.pauseablePlacement.isDone()||this.placement.hasTransitions(ge.now())}_releaseSymbolFadeTiles(){for(const rt in this.sourceCaches)this.sourceCaches[rt].releaseSymbolFadeTiles()}getImages(rt,at){return Tt._(this,void 0,void 0,(function*(){const rt=yield this.imageManager.getImages(at.icons);this._updateTilesForChangedImages();const Tt=this.sourceCaches[at.source];return Tt&&Tt.setDependencies(at.tileID.key,at.type,at.icons),rt}))}getGlyphs(rt,at){return Tt._(this,void 0,void 0,(function*(){const rt=yield this.glyphManager.getGlyphs(at.stacks),Tt=this.sourceCaches[at.source];return Tt&&Tt.setDependencies(at.tileID.key,at.type,[""]),rt}))}getGlyphsUrl(){return this.stylesheet.glyphs||null}setGlyphs(rt,at={}){this._checkLoaded(),rt&&this._validate(Tt.y.glyphs,"glyphs",rt,null,at)||(this._glyphsDidChange=!0,this.stylesheet.glyphs=rt,this.glyphManager.entries={},this.glyphManager.setURL(rt))}addSprite(rt,at,$t={},qt){this._checkLoaded();const Kt=[{id:rt,url:at}],ge=[...f(this.stylesheet.sprite),...Kt];this._validate(Tt.y.sprite,"sprite",ge,null,$t)||(this.stylesheet.sprite=ge,this._loadSprite(Kt,!0,qt))}removeSprite(rt){this._checkLoaded();const at=f(this.stylesheet.sprite);if(at.find((at=>at.id===rt))){if(this._spritesImagesIds[rt])for(const at of this._spritesImagesIds[rt])this.imageManager.removeImage(at),this._changedImages[at]=!0;at.splice(at.findIndex((at=>at.id===rt)),1),this.stylesheet.sprite=at.length>0?at:void 0,delete this._spritesImagesIds[rt],this._availableImages=this.imageManager.listImages(),this._changed=!0,this.dispatcher.broadcast("SI",this._availableImages),this.fire(new Tt.l("data",{dataType:"style"}))}else this.fire(new Tt.k(new Error(`Sprite "${rt}" doesn't exists on this map.`)))}getSprite(){return f(this.stylesheet.sprite)}setSprite(rt,at={},$t){this._checkLoaded(),rt&&this._validate(Tt.y.sprite,"sprite",rt,null,at)||(this.stylesheet.sprite=rt,rt?this._loadSprite(rt,!0,$t):(this._unloadSprite(),$t&&$t(null)))}}var Ac=Tt.aG([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);class wi{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffer=null,this.vao=null}bind(rt,at,Tt,$t,qt,Kt,ge,Hr,wn){this.context=rt;let es=this.boundPaintVertexBuffers.length!==$t.length;for(let rt=0;!es&&rt<$t.length;rt++)this.boundPaintVertexBuffers[rt]!==$t[rt]&&(es=!0);!this.vao||this.boundProgram!==at||this.boundLayoutVertexBuffer!==Tt||es||this.boundIndexBuffer!==qt||this.boundVertexOffset!==Kt||this.boundDynamicVertexBuffer!==ge||this.boundDynamicVertexBuffer2!==Hr||this.boundDynamicVertexBuffer3!==wn?this.freshBind(at,Tt,$t,qt,Kt,ge,Hr,wn):(rt.bindVertexArray.set(this.vao),ge&&ge.bind(),qt&&qt.dynamicDraw&&qt.bind(),Hr&&Hr.bind(),wn&&wn.bind())}freshBind(rt,at,Tt,$t,qt,Kt,ge,Hr){const wn=rt.numAttributes,es=this.context,ss=es.gl;this.vao&&this.destroy(),this.vao=es.createVertexArray(),es.bindVertexArray.set(this.vao),this.boundProgram=rt,this.boundLayoutVertexBuffer=at,this.boundPaintVertexBuffers=Tt,this.boundIndexBuffer=$t,this.boundVertexOffset=qt,this.boundDynamicVertexBuffer=Kt,this.boundDynamicVertexBuffer2=ge,this.boundDynamicVertexBuffer3=Hr,at.enableAttributes(ss,rt);for(const at of Tt)at.enableAttributes(ss,rt);Kt&&Kt.enableAttributes(ss,rt),ge&&ge.enableAttributes(ss,rt),Hr&&Hr.enableAttributes(ss,rt),at.bind(),at.setVertexAttribPointers(ss,rt,qt);for(const at of Tt)at.bind(),at.setVertexAttribPointers(ss,rt,qt);Kt&&(Kt.bind(),Kt.setVertexAttribPointers(ss,rt,qt)),$t&&$t.bind(),ge&&(ge.bind(),ge.setVertexAttribPointers(ss,rt,qt)),Hr&&(Hr.bind(),Hr.setVertexAttribPointers(ss,rt,qt)),es.currentNumAttributes=wn}destroy(){this.vao&&(this.context.deleteVertexArray(this.vao),this.vao=null)}}const Ti=(rt,at,$t,qt,Kt)=>({u_texture:0,u_ele_delta:rt,u_fog_matrix:at,u_fog_color:$t?$t.properties.get("fog-color"):Tt.b7.white,u_fog_ground_blend:$t?$t.properties.get("fog-ground-blend"):1,u_fog_ground_blend_opacity:Kt?0:$t?$t.calculateFogBlendOpacity(qt):0,u_horizon_color:$t?$t.properties.get("horizon-color"):Tt.b7.white,u_horizon_fog_blend:$t?$t.properties.get("horizon-fog-blend"):1,u_is_globe_mode:Kt?1:0}),zc={mainMatrix:"u_projection_matrix",tileMercatorCoords:"u_projection_tile_mercator_coords",clippingPlane:"u_projection_clipping_plane",projectionTransition:"u_projection_transition",fallbackMatrix:"u_projection_fallback_matrix"};function Ci(rt){const at=[];for(let Tt=0;Tt<rt.length;Tt++){if(null===rt[Tt])continue;const $t=rt[Tt].split(" ");at.push($t.pop())}return at}class Mi{constructor(rt,at,$t,qt,Kt,ge,Hr,wn){const es=rt.gl;this.program=es.createProgram();const ss=Ci(at.staticAttributes),os=$t?$t.getBinderAttributes():[],cs=ss.concat(os),ds=Hl.prelude.staticUniforms?Ci(Hl.prelude.staticUniforms):[],Cs=Hr.staticUniforms?Ci(Hr.staticUniforms):[],Vs=at.staticUniforms?Ci(at.staticUniforms):[],Eo=$t?$t.getBinderUniforms():[],Do=ds.concat(Cs).concat(Vs).concat(Eo),Ho=[];for(const rt of Do)Ho.indexOf(rt)<0&&Ho.push(rt);const Ea=$t?$t.defines():[];Wt(es)&&Ea.unshift("#version 300 es"),Kt&&Ea.push("#define OVERDRAW_INSPECTOR;"),ge&&Ea.push("#define TERRAIN3D;"),wn&&Ea.push(wn);let La=Ea.concat(Hl.prelude.fragmentSource,Hr.fragmentSource,at.fragmentSource).join("\n"),ja=Ea.concat(Hl.prelude.vertexSource,Hr.vertexSource,at.vertexSource).join("\n");Wt(es)||(La=function(rt){return rt.replace(/\bin\s/g,"varying ").replace("out highp vec4 fragColor;","").replace(/fragColor/g,"gl_FragColor").replace(/texture\(/g,"texture2D(")}(La),ja=function(rt){return rt.replace(/\bin\s/g,"attribute ").replace(/\bout\s/g,"varying ").replace(/texture\(/g,"texture2D(")}(ja));const Va=es.createShader(es.FRAGMENT_SHADER);if(es.isContextLost())return void(this.failedToCreate=!0);if(es.shaderSource(Va,La),es.compileShader(Va),!es.getShaderParameter(Va,es.COMPILE_STATUS))throw new Error(`Could not compile fragment shader: ${es.getShaderInfoLog(Va)}`);es.attachShader(this.program,Va);const Na=es.createShader(es.VERTEX_SHADER);if(es.isContextLost())return void(this.failedToCreate=!0);if(es.shaderSource(Na,ja),es.compileShader(Na),!es.getShaderParameter(Na,es.COMPILE_STATUS))throw new Error(`Could not compile vertex shader: ${es.getShaderInfoLog(Na)}`);es.attachShader(this.program,Na),this.attributes={};const qa={};this.numAttributes=cs.length;for(let rt=0;rt<this.numAttributes;rt++)cs[rt]&&(es.bindAttribLocation(this.program,rt,cs[rt]),this.attributes[cs[rt]]=rt);if(es.linkProgram(this.program),!es.getProgramParameter(this.program,es.LINK_STATUS))throw new Error(`Program failed to link: ${es.getProgramInfoLog(this.program)}`);es.deleteShader(Na),es.deleteShader(Va);for(let rt=0;rt<Ho.length;rt++){const at=Ho[rt];if(at&&!qa[at]){const rt=es.getUniformLocation(this.program,at);rt&&(qa[at]=rt)}}this.fixedUniforms=qt(rt,qa),this.terrainUniforms=((rt,at)=>({u_depth:new Tt.bH(rt,at.u_depth),u_terrain:new Tt.bH(rt,at.u_terrain),u_terrain_dim:new Tt.b8(rt,at.u_terrain_dim),u_terrain_matrix:new Tt.bJ(rt,at.u_terrain_matrix),u_terrain_unpack:new Tt.bK(rt,at.u_terrain_unpack),u_terrain_exaggeration:new Tt.b8(rt,at.u_terrain_exaggeration)}))(rt,qa),this.projectionUniforms=((rt,at)=>({u_projection_matrix:new Tt.bJ(rt,at.u_projection_matrix),u_projection_tile_mercator_coords:new Tt.bK(rt,at.u_projection_tile_mercator_coords),u_projection_clipping_plane:new Tt.bK(rt,at.u_projection_clipping_plane),u_projection_transition:new Tt.b8(rt,at.u_projection_transition),u_projection_fallback_matrix:new Tt.bJ(rt,at.u_projection_fallback_matrix)}))(rt,qa),this.binderUniforms=$t?$t.getUniforms(rt,qa):[]}draw(rt,at,Tt,$t,qt,Kt,ge,Hr,wn,es,ss,os,cs,ds,Cs,Vs,Eo,Do,Ho){const Ea=rt.gl;if(this.failedToCreate)return;if(rt.program.set(this.program),rt.setDepthMode(Tt),rt.setStencilMode($t),rt.setColorMode(qt),rt.setCullFace(Kt),Hr){rt.activeTexture.set(Ea.TEXTURE2),Ea.bindTexture(Ea.TEXTURE_2D,Hr.depthTexture),rt.activeTexture.set(Ea.TEXTURE3),Ea.bindTexture(Ea.TEXTURE_2D,Hr.texture);for(const rt in this.terrainUniforms)this.terrainUniforms[rt].set(Hr[rt])}if(wn)for(const rt in wn)this.projectionUniforms[zc[rt]].set(wn[rt]);if(ge)for(const rt in this.fixedUniforms)this.fixedUniforms[rt].set(ge[rt]);Vs&&Vs.setUniforms(rt,this.binderUniforms,ds,{zoom:Cs});let La=0;switch(at){case Ea.LINES:La=2;break;case Ea.TRIANGLES:La=3;break;case Ea.LINE_STRIP:La=1}for(const Tt of cs.get()){const $t=Tt.vaos||(Tt.vaos={});($t[es]||($t[es]=new wi)).bind(rt,this,ss,Vs?Vs.getPaintVertexBuffers():[],os,Tt.vertexOffset,Eo,Do,Ho),Ea.drawElements(at,Tt.primitiveLength*La,Ea.UNSIGNED_SHORT,Tt.primitiveOffset*La*2)}}}function Ii(rt,at,$t){const qt=1/Tt.az($t,1,at.transform.tileZoom),Kt=Math.pow(2,$t.tileID.overscaledZ),ge=$t.tileSize*Math.pow(2,at.transform.tileZoom)/Kt,Hr=ge*($t.tileID.canonical.x+$t.tileID.wrap*Kt),wn=ge*$t.tileID.canonical.y;return{u_image:0,u_texsize:$t.imageAtlasTexture.size,u_scale:[qt,rt.fromScale,rt.toScale],u_fade:rt.t,u_pixel_coord_upper:[Hr>>16,wn>>16],u_pixel_coord_lower:[65535&Hr,65535&wn]}}const Ei=(rt,at,$t,qt)=>{const Kt=rt.style.light,ge=Kt.properties.get("position"),Hr=[ge.x,ge.y,ge.z],wn=Tt.bN();"viewport"===Kt.properties.get("anchor")&&Tt.bO(wn,rt.transform.bearingInRadians),Tt.bP(Hr,Hr,wn);const es=rt.transform.transformLightDirection(Hr),ss=Kt.properties.get("color");return{u_lightpos:Hr,u_lightpos_globe:es,u_lightintensity:Kt.properties.get("intensity"),u_lightcolor:[ss.r,ss.g,ss.b],u_vertical_gradient:+at,u_opacity:$t,u_fill_translate:qt}},Si=(rt,at,$t,qt,Kt,ge,Hr)=>Tt.e(Ei(rt,at,$t,qt),Ii(ge,rt,Hr),{u_height_factor:-Math.pow(2,Kt.overscaledZ)/Hr.tileSize/8}),Ri=(rt,at,$t,qt)=>Tt.e(Ii(at,rt,$t),{u_fill_translate:qt}),Di=(rt,at)=>({u_world:rt,u_fill_translate:at}),zi=(rt,at,$t,qt,Kt)=>Tt.e(Ri(rt,at,$t,Kt),{u_world:qt}),Ai=(rt,at,$t,qt,Kt)=>{const ge=rt.transform;let Hr,wn,es=0;if("map"===$t.paint.get("circle-pitch-alignment")){const rt=Tt.az(at,1,ge.zoom);Hr=!0,wn=[rt,rt],es=rt/(Tt.Z*Math.pow(2,at.tileID.overscaledZ))*2*Math.PI*Kt}else Hr=!1,wn=ge.pixelsToGLUnits;return{u_camera_to_center_distance:ge.cameraToCenterDistance,u_scale_with_map:+("map"===$t.paint.get("circle-pitch-scale")),u_pitch_with_map:+Hr,u_device_pixel_ratio:rt.pixelRatio,u_extrude_scale:wn,u_globe_extrude_scale:es,u_translate:qt}},Li=rt=>({u_pixel_extrude_scale:[1/rt.width,1/rt.height]}),ki=rt=>({u_viewport_size:[rt.width,rt.height]}),Fi=(rt,at=1)=>({u_color:rt,u_overlay:0,u_overlay_scale:at}),Bi=(rt,at,$t,qt)=>{const Kt=Tt.az(rt,1,at)/(Tt.Z*Math.pow(2,rt.tileID.overscaledZ))*2*Math.PI*qt;return{u_extrude_scale:Tt.az(rt,1,at),u_intensity:$t,u_globe_extrude_scale:Kt}},Oi=(rt,at,$t,qt)=>{const Kt=Tt.K();Tt.bQ(Kt,0,rt.width,rt.height,0,0,1);const ge=rt.context.gl;return{u_matrix:Kt,u_world:[ge.drawingBufferWidth,ge.drawingBufferHeight],u_image:$t,u_color_ramp:qt,u_opacity:at.paint.get("heatmap-opacity")}},ji=(rt,at,Tt)=>{const $t=Tt.paint.get("hillshade-shadow-color"),qt=Tt.paint.get("hillshade-highlight-color"),Kt=Tt.paint.get("hillshade-accent-color");let ge=Tt.paint.get("hillshade-illumination-direction")*(Math.PI/180);return"viewport"===Tt.paint.get("hillshade-illumination-anchor")&&(ge+=rt.transform.bearingInRadians),{u_image:0,u_latrange:Ni(0,at.tileID),u_light:[Tt.paint.get("hillshade-exaggeration"),ge],u_shadow:$t,u_highlight:qt,u_accent:Kt}},Zi=(rt,at)=>{const $t=at.stride,qt=Tt.K();return Tt.bQ(qt,0,Tt.Z,-8192,0,0,1),Tt.L(qt,qt,[0,-8192,0]),{u_matrix:qt,u_image:1,u_dimension:[$t,$t],u_zoom:rt.overscaledZ,u_unpack:at.getUnpackVector()}};function Ni(rt,at){const $t=Math.pow(2,at.canonical.z),qt=at.canonical.y;return[new Tt.$(0,qt/$t).toLngLat().lat,new Tt.$(0,(qt+1)/$t).toLngLat().lat]}const Ui=(rt,at,$t,qt)=>{const Kt=rt.transform;return{u_translation:Hi(rt,at,$t),u_ratio:qt/Tt.az(at,1,Kt.zoom),u_device_pixel_ratio:rt.pixelRatio,u_units_to_pixels:[1/Kt.pixelsToGLUnits[0],1/Kt.pixelsToGLUnits[1]]}},Gi=(rt,at,$t,qt,Kt)=>Tt.e(Ui(rt,at,$t,qt),{u_image:0,u_image_height:Kt}),Vi=(rt,at,$t,qt,Kt)=>{const ge=rt.transform,Hr=Wi(at,ge);return{u_translation:Hi(rt,at,$t),u_texsize:at.imageAtlasTexture.size,u_ratio:qt/Tt.az(at,1,ge.zoom),u_device_pixel_ratio:rt.pixelRatio,u_image:0,u_scale:[Hr,Kt.fromScale,Kt.toScale],u_fade:Kt.t,u_units_to_pixels:[1/ge.pixelsToGLUnits[0],1/ge.pixelsToGLUnits[1]]}},qi=(rt,at,$t,qt,Kt,ge)=>{const Hr=rt.lineAtlas,wn=Wi(at,rt.transform),es="round"===$t.layout.get("line-cap"),ss=Hr.getDash(Kt.from,es),os=Hr.getDash(Kt.to,es),cs=ss.width*ge.fromScale,ds=os.width*ge.toScale;return Tt.e(Ui(rt,at,$t,qt),{u_patternscale_a:[wn/cs,-ss.height/2],u_patternscale_b:[wn/ds,-os.height/2],u_sdfgamma:Hr.width/(256*Math.min(cs,ds)*rt.pixelRatio)/2,u_image:0,u_tex_y_a:ss.y,u_tex_y_b:os.y,u_mix:ge.t})};function Wi(rt,at){return 1/Tt.az(rt,1,at.tileZoom)}function Hi(rt,at,$t){return Tt.aA(rt.transform,at,$t.paint.get("line-translate"),$t.paint.get("line-translate-anchor"))}const $i=(rt,at,Tt,$t,qt)=>{return{u_tl_parent:rt,u_scale_parent:at,u_buffer_scale:1,u_fade_t:Tt.mix,u_opacity:Tt.opacity*$t.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:$t.paint.get("raster-brightness-min"),u_brightness_high:$t.paint.get("raster-brightness-max"),u_saturation_factor:(ge=$t.paint.get("raster-saturation"),ge>0?1-1/(1.001-ge):-ge),u_contrast_factor:(Kt=$t.paint.get("raster-contrast"),Kt>0?1/(1-Kt):1+Kt),u_spin_weights:Xi($t.paint.get("raster-hue-rotate")),u_coords_top:[qt[0].x,qt[0].y,qt[1].x,qt[1].y],u_coords_bottom:[qt[3].x,qt[3].y,qt[2].x,qt[2].y]};var Kt,ge};function Xi(rt){rt*=Math.PI/180;const at=Math.sin(rt),Tt=Math.cos(rt);return[(2*Tt+1)/3,(-Math.sqrt(3)*at-Tt+1)/3,(Math.sqrt(3)*at-Tt+1)/3]}const Ki=(rt,at,Tt,$t,qt,Kt,ge,Hr,wn,es,ss,os,cs)=>{const ds=ge.transform;return{u_is_size_zoom_constant:+("constant"===rt||"source"===rt),u_is_size_feature_constant:+("constant"===rt||"camera"===rt),u_size_t:at?at.uSizeT:0,u_size:at?at.uSize:0,u_camera_to_center_distance:ds.cameraToCenterDistance,u_pitch:ds.pitch/360*2*Math.PI,u_rotate_symbol:+Tt,u_aspect_ratio:ds.width/ds.height,u_fade_change:ge.options.fadeDuration?ge.symbolFadeChange:1,u_label_plane_matrix:Hr,u_coord_matrix:wn,u_is_text:+ss,u_pitch_with_map:+$t,u_is_along_line:qt,u_is_variable_anchor:Kt,u_texsize:os,u_texture:0,u_translation:es,u_pitched_scale:cs}},Qi=(rt,at,$t,qt,Kt,ge,Hr,wn,es,ss,os,cs,ds,Cs)=>{const Vs=Hr.transform;return Tt.e(Ki(rt,at,$t,qt,Kt,ge,Hr,wn,es,ss,os,cs,Cs),{u_gamma_scale:qt?Math.cos(Vs.pitch*Math.PI/180)*Vs.cameraToCenterDistance:1,u_device_pixel_ratio:Hr.pixelRatio,u_is_halo:1})},Yi=(rt,at,$t,qt,Kt,ge,Hr,wn,es,ss,os,cs,ds)=>Tt.e(Qi(rt,at,$t,qt,Kt,ge,Hr,wn,es,ss,!0,os,0,ds),{u_texsize_icon:cs,u_texture_icon:1}),Ji=(rt,at)=>({u_opacity:rt,u_color:at}),er=(rt,at,$t,qt,Kt)=>Tt.e(function(rt,at,$t,qt){const Kt=$t.imageManager.getPattern(rt.from.toString()),ge=$t.imageManager.getPattern(rt.to.toString()),{width:Hr,height:wn}=$t.imageManager.getPixelSize(),es=Math.pow(2,qt.tileID.overscaledZ),ss=qt.tileSize*Math.pow(2,$t.transform.tileZoom)/es,os=ss*(qt.tileID.canonical.x+qt.tileID.wrap*es),cs=ss*qt.tileID.canonical.y;return{u_image:0,u_pattern_tl_a:Kt.tl,u_pattern_br_a:Kt.br,u_pattern_tl_b:ge.tl,u_pattern_br_b:ge.br,u_texsize:[Hr,wn],u_mix:at.t,u_pattern_size_a:Kt.displaySize,u_pattern_size_b:ge.displaySize,u_scale_a:at.fromScale,u_scale_b:at.toScale,u_tile_units_to_pixels:1/Tt.az(qt,1,$t.transform.tileZoom),u_pixel_coord_upper:[os>>16,cs>>16],u_pixel_coord_lower:[65535&os,65535&cs]}}($t,Kt,at,qt),{u_opacity:rt}),tr=(rt,at)=>{},kc={fillExtrusion:(rt,at)=>({u_lightpos:new Tt.bL(rt,at.u_lightpos),u_lightpos_globe:new Tt.bL(rt,at.u_lightpos_globe),u_lightintensity:new Tt.b8(rt,at.u_lightintensity),u_lightcolor:new Tt.bL(rt,at.u_lightcolor),u_vertical_gradient:new Tt.b8(rt,at.u_vertical_gradient),u_opacity:new Tt.b8(rt,at.u_opacity),u_fill_translate:new Tt.bM(rt,at.u_fill_translate)}),fillExtrusionPattern:(rt,at)=>({u_lightpos:new Tt.bL(rt,at.u_lightpos),u_lightpos_globe:new Tt.bL(rt,at.u_lightpos_globe),u_lightintensity:new Tt.b8(rt,at.u_lightintensity),u_lightcolor:new Tt.bL(rt,at.u_lightcolor),u_vertical_gradient:new Tt.b8(rt,at.u_vertical_gradient),u_height_factor:new Tt.b8(rt,at.u_height_factor),u_opacity:new Tt.b8(rt,at.u_opacity),u_fill_translate:new Tt.bM(rt,at.u_fill_translate),u_image:new Tt.bH(rt,at.u_image),u_texsize:new Tt.bM(rt,at.u_texsize),u_pixel_coord_upper:new Tt.bM(rt,at.u_pixel_coord_upper),u_pixel_coord_lower:new Tt.bM(rt,at.u_pixel_coord_lower),u_scale:new Tt.bL(rt,at.u_scale),u_fade:new Tt.b8(rt,at.u_fade)}),fill:(rt,at)=>({u_fill_translate:new Tt.bM(rt,at.u_fill_translate)}),fillPattern:(rt,at)=>({u_image:new Tt.bH(rt,at.u_image),u_texsize:new Tt.bM(rt,at.u_texsize),u_pixel_coord_upper:new Tt.bM(rt,at.u_pixel_coord_upper),u_pixel_coord_lower:new Tt.bM(rt,at.u_pixel_coord_lower),u_scale:new Tt.bL(rt,at.u_scale),u_fade:new Tt.b8(rt,at.u_fade),u_fill_translate:new Tt.bM(rt,at.u_fill_translate)}),fillOutline:(rt,at)=>({u_world:new Tt.bM(rt,at.u_world),u_fill_translate:new Tt.bM(rt,at.u_fill_translate)}),fillOutlinePattern:(rt,at)=>({u_world:new Tt.bM(rt,at.u_world),u_image:new Tt.bH(rt,at.u_image),u_texsize:new Tt.bM(rt,at.u_texsize),u_pixel_coord_upper:new Tt.bM(rt,at.u_pixel_coord_upper),u_pixel_coord_lower:new Tt.bM(rt,at.u_pixel_coord_lower),u_scale:new Tt.bL(rt,at.u_scale),u_fade:new Tt.b8(rt,at.u_fade),u_fill_translate:new Tt.bM(rt,at.u_fill_translate)}),circle:(rt,at)=>({u_camera_to_center_distance:new Tt.b8(rt,at.u_camera_to_center_distance),u_scale_with_map:new Tt.bH(rt,at.u_scale_with_map),u_pitch_with_map:new Tt.bH(rt,at.u_pitch_with_map),u_extrude_scale:new Tt.bM(rt,at.u_extrude_scale),u_device_pixel_ratio:new Tt.b8(rt,at.u_device_pixel_ratio),u_globe_extrude_scale:new Tt.b8(rt,at.u_globe_extrude_scale),u_translate:new Tt.bM(rt,at.u_translate)}),collisionBox:(rt,at)=>({u_pixel_extrude_scale:new Tt.bM(rt,at.u_pixel_extrude_scale)}),collisionCircle:(rt,at)=>({u_viewport_size:new Tt.bM(rt,at.u_viewport_size)}),debug:(rt,at)=>({u_color:new Tt.bI(rt,at.u_color),u_overlay:new Tt.bH(rt,at.u_overlay),u_overlay_scale:new Tt.b8(rt,at.u_overlay_scale)}),depth:tr,clippingMask:tr,heatmap:(rt,at)=>({u_extrude_scale:new Tt.b8(rt,at.u_extrude_scale),u_intensity:new Tt.b8(rt,at.u_intensity),u_globe_extrude_scale:new Tt.b8(rt,at.u_globe_extrude_scale)}),heatmapTexture:(rt,at)=>({u_matrix:new Tt.bJ(rt,at.u_matrix),u_world:new Tt.bM(rt,at.u_world),u_image:new Tt.bH(rt,at.u_image),u_color_ramp:new Tt.bH(rt,at.u_color_ramp),u_opacity:new Tt.b8(rt,at.u_opacity)}),hillshade:(rt,at)=>({u_image:new Tt.bH(rt,at.u_image),u_latrange:new Tt.bM(rt,at.u_latrange),u_light:new Tt.bM(rt,at.u_light),u_shadow:new Tt.bI(rt,at.u_shadow),u_highlight:new Tt.bI(rt,at.u_highlight),u_accent:new Tt.bI(rt,at.u_accent)}),hillshadePrepare:(rt,at)=>({u_matrix:new Tt.bJ(rt,at.u_matrix),u_image:new Tt.bH(rt,at.u_image),u_dimension:new Tt.bM(rt,at.u_dimension),u_zoom:new Tt.b8(rt,at.u_zoom),u_unpack:new Tt.bK(rt,at.u_unpack)}),line:(rt,at)=>({u_translation:new Tt.bM(rt,at.u_translation),u_ratio:new Tt.b8(rt,at.u_ratio),u_device_pixel_ratio:new Tt.b8(rt,at.u_device_pixel_ratio),u_units_to_pixels:new Tt.bM(rt,at.u_units_to_pixels)}),lineGradient:(rt,at)=>({u_translation:new Tt.bM(rt,at.u_translation),u_ratio:new Tt.b8(rt,at.u_ratio),u_device_pixel_ratio:new Tt.b8(rt,at.u_device_pixel_ratio),u_units_to_pixels:new Tt.bM(rt,at.u_units_to_pixels),u_image:new Tt.bH(rt,at.u_image),u_image_height:new Tt.b8(rt,at.u_image_height)}),linePattern:(rt,at)=>({u_translation:new Tt.bM(rt,at.u_translation),u_texsize:new Tt.bM(rt,at.u_texsize),u_ratio:new Tt.b8(rt,at.u_ratio),u_device_pixel_ratio:new Tt.b8(rt,at.u_device_pixel_ratio),u_image:new Tt.bH(rt,at.u_image),u_units_to_pixels:new Tt.bM(rt,at.u_units_to_pixels),u_scale:new Tt.bL(rt,at.u_scale),u_fade:new Tt.b8(rt,at.u_fade)}),lineSDF:(rt,at)=>({u_translation:new Tt.bM(rt,at.u_translation),u_ratio:new Tt.b8(rt,at.u_ratio),u_device_pixel_ratio:new Tt.b8(rt,at.u_device_pixel_ratio),u_units_to_pixels:new Tt.bM(rt,at.u_units_to_pixels),u_patternscale_a:new Tt.bM(rt,at.u_patternscale_a),u_patternscale_b:new Tt.bM(rt,at.u_patternscale_b),u_sdfgamma:new Tt.b8(rt,at.u_sdfgamma),u_image:new Tt.bH(rt,at.u_image),u_tex_y_a:new Tt.b8(rt,at.u_tex_y_a),u_tex_y_b:new Tt.b8(rt,at.u_tex_y_b),u_mix:new Tt.b8(rt,at.u_mix)}),raster:(rt,at)=>({u_tl_parent:new Tt.bM(rt,at.u_tl_parent),u_scale_parent:new Tt.b8(rt,at.u_scale_parent),u_buffer_scale:new Tt.b8(rt,at.u_buffer_scale),u_fade_t:new Tt.b8(rt,at.u_fade_t),u_opacity:new Tt.b8(rt,at.u_opacity),u_image0:new Tt.bH(rt,at.u_image0),u_image1:new Tt.bH(rt,at.u_image1),u_brightness_low:new Tt.b8(rt,at.u_brightness_low),u_brightness_high:new Tt.b8(rt,at.u_brightness_high),u_saturation_factor:new Tt.b8(rt,at.u_saturation_factor),u_contrast_factor:new Tt.b8(rt,at.u_contrast_factor),u_spin_weights:new Tt.bL(rt,at.u_spin_weights),u_coords_top:new Tt.bK(rt,at.u_coords_top),u_coords_bottom:new Tt.bK(rt,at.u_coords_bottom)}),symbolIcon:(rt,at)=>({u_is_size_zoom_constant:new Tt.bH(rt,at.u_is_size_zoom_constant),u_is_size_feature_constant:new Tt.bH(rt,at.u_is_size_feature_constant),u_size_t:new Tt.b8(rt,at.u_size_t),u_size:new Tt.b8(rt,at.u_size),u_camera_to_center_distance:new Tt.b8(rt,at.u_camera_to_center_distance),u_pitch:new Tt.b8(rt,at.u_pitch),u_rotate_symbol:new Tt.bH(rt,at.u_rotate_symbol),u_aspect_ratio:new Tt.b8(rt,at.u_aspect_ratio),u_fade_change:new Tt.b8(rt,at.u_fade_change),u_label_plane_matrix:new Tt.bJ(rt,at.u_label_plane_matrix),u_coord_matrix:new Tt.bJ(rt,at.u_coord_matrix),u_is_text:new Tt.bH(rt,at.u_is_text),u_pitch_with_map:new Tt.bH(rt,at.u_pitch_with_map),u_is_along_line:new Tt.bH(rt,at.u_is_along_line),u_is_variable_anchor:new Tt.bH(rt,at.u_is_variable_anchor),u_texsize:new Tt.bM(rt,at.u_texsize),u_texture:new Tt.bH(rt,at.u_texture),u_translation:new Tt.bM(rt,at.u_translation),u_pitched_scale:new Tt.b8(rt,at.u_pitched_scale)}),symbolSDF:(rt,at)=>({u_is_size_zoom_constant:new Tt.bH(rt,at.u_is_size_zoom_constant),u_is_size_feature_constant:new Tt.bH(rt,at.u_is_size_feature_constant),u_size_t:new Tt.b8(rt,at.u_size_t),u_size:new Tt.b8(rt,at.u_size),u_camera_to_center_distance:new Tt.b8(rt,at.u_camera_to_center_distance),u_pitch:new Tt.b8(rt,at.u_pitch),u_rotate_symbol:new Tt.bH(rt,at.u_rotate_symbol),u_aspect_ratio:new Tt.b8(rt,at.u_aspect_ratio),u_fade_change:new Tt.b8(rt,at.u_fade_change),u_label_plane_matrix:new Tt.bJ(rt,at.u_label_plane_matrix),u_coord_matrix:new Tt.bJ(rt,at.u_coord_matrix),u_is_text:new Tt.bH(rt,at.u_is_text),u_pitch_with_map:new Tt.bH(rt,at.u_pitch_with_map),u_is_along_line:new Tt.bH(rt,at.u_is_along_line),u_is_variable_anchor:new Tt.bH(rt,at.u_is_variable_anchor),u_texsize:new Tt.bM(rt,at.u_texsize),u_texture:new Tt.bH(rt,at.u_texture),u_gamma_scale:new Tt.b8(rt,at.u_gamma_scale),u_device_pixel_ratio:new Tt.b8(rt,at.u_device_pixel_ratio),u_is_halo:new Tt.bH(rt,at.u_is_halo),u_translation:new Tt.bM(rt,at.u_translation),u_pitched_scale:new Tt.b8(rt,at.u_pitched_scale)}),symbolTextAndIcon:(rt,at)=>({u_is_size_zoom_constant:new Tt.bH(rt,at.u_is_size_zoom_constant),u_is_size_feature_constant:new Tt.bH(rt,at.u_is_size_feature_constant),u_size_t:new Tt.b8(rt,at.u_size_t),u_size:new Tt.b8(rt,at.u_size),u_camera_to_center_distance:new Tt.b8(rt,at.u_camera_to_center_distance),u_pitch:new Tt.b8(rt,at.u_pitch),u_rotate_symbol:new Tt.bH(rt,at.u_rotate_symbol),u_aspect_ratio:new Tt.b8(rt,at.u_aspect_ratio),u_fade_change:new Tt.b8(rt,at.u_fade_change),u_label_plane_matrix:new Tt.bJ(rt,at.u_label_plane_matrix),u_coord_matrix:new Tt.bJ(rt,at.u_coord_matrix),u_is_text:new Tt.bH(rt,at.u_is_text),u_pitch_with_map:new Tt.bH(rt,at.u_pitch_with_map),u_is_along_line:new Tt.bH(rt,at.u_is_along_line),u_is_variable_anchor:new Tt.bH(rt,at.u_is_variable_anchor),u_texsize:new Tt.bM(rt,at.u_texsize),u_texsize_icon:new Tt.bM(rt,at.u_texsize_icon),u_texture:new Tt.bH(rt,at.u_texture),u_texture_icon:new Tt.bH(rt,at.u_texture_icon),u_gamma_scale:new Tt.b8(rt,at.u_gamma_scale),u_device_pixel_ratio:new Tt.b8(rt,at.u_device_pixel_ratio),u_is_halo:new Tt.bH(rt,at.u_is_halo),u_translation:new Tt.bM(rt,at.u_translation),u_pitched_scale:new Tt.b8(rt,at.u_pitched_scale)}),background:(rt,at)=>({u_opacity:new Tt.b8(rt,at.u_opacity),u_color:new Tt.bI(rt,at.u_color)}),backgroundPattern:(rt,at)=>({u_opacity:new Tt.b8(rt,at.u_opacity),u_image:new Tt.bH(rt,at.u_image),u_pattern_tl_a:new Tt.bM(rt,at.u_pattern_tl_a),u_pattern_br_a:new Tt.bM(rt,at.u_pattern_br_a),u_pattern_tl_b:new Tt.bM(rt,at.u_pattern_tl_b),u_pattern_br_b:new Tt.bM(rt,at.u_pattern_br_b),u_texsize:new Tt.bM(rt,at.u_texsize),u_mix:new Tt.b8(rt,at.u_mix),u_pattern_size_a:new Tt.bM(rt,at.u_pattern_size_a),u_pattern_size_b:new Tt.bM(rt,at.u_pattern_size_b),u_scale_a:new Tt.b8(rt,at.u_scale_a),u_scale_b:new Tt.b8(rt,at.u_scale_b),u_pixel_coord_upper:new Tt.bM(rt,at.u_pixel_coord_upper),u_pixel_coord_lower:new Tt.bM(rt,at.u_pixel_coord_lower),u_tile_units_to_pixels:new Tt.b8(rt,at.u_tile_units_to_pixels)}),terrain:(rt,at)=>({u_texture:new Tt.bH(rt,at.u_texture),u_ele_delta:new Tt.b8(rt,at.u_ele_delta),u_fog_matrix:new Tt.bJ(rt,at.u_fog_matrix),u_fog_color:new Tt.bI(rt,at.u_fog_color),u_fog_ground_blend:new Tt.b8(rt,at.u_fog_ground_blend),u_fog_ground_blend_opacity:new Tt.b8(rt,at.u_fog_ground_blend_opacity),u_horizon_color:new Tt.bI(rt,at.u_horizon_color),u_horizon_fog_blend:new Tt.b8(rt,at.u_horizon_fog_blend),u_is_globe_mode:new Tt.b8(rt,at.u_is_globe_mode)}),terrainDepth:(rt,at)=>({u_ele_delta:new Tt.b8(rt,at.u_ele_delta)}),terrainCoords:(rt,at)=>({u_texture:new Tt.bH(rt,at.u_texture),u_terrain_coords_id:new Tt.b8(rt,at.u_terrain_coords_id),u_ele_delta:new Tt.b8(rt,at.u_ele_delta)}),projectionErrorMeasurement:(rt,at)=>({u_input:new Tt.b8(rt,at.u_input),u_output_expected:new Tt.b8(rt,at.u_output_expected)}),atmosphere:(rt,at)=>({u_sun_pos:new Tt.bL(rt,at.u_sun_pos),u_atmosphere_blend:new Tt.b8(rt,at.u_atmosphere_blend),u_globe_position:new Tt.bL(rt,at.u_globe_position),u_globe_radius:new Tt.b8(rt,at.u_globe_radius),u_inv_proj_matrix:new Tt.bJ(rt,at.u_inv_proj_matrix)}),sky:(rt,at)=>({u_sky_color:new Tt.bI(rt,at.u_sky_color),u_horizon_color:new Tt.bI(rt,at.u_horizon_color),u_horizon:new Tt.bM(rt,at.u_horizon),u_horizon_normal:new Tt.bM(rt,at.u_horizon_normal),u_sky_horizon_blend:new Tt.b8(rt,at.u_sky_horizon_blend),u_sky_blend:new Tt.b8(rt,at.u_sky_blend)})};class rr{constructor(rt,at,Tt){this.context=rt;const $t=rt.gl;this.buffer=$t.createBuffer(),this.dynamicDraw=Boolean(Tt),this.context.unbindVAO(),rt.bindElementBuffer.set(this.buffer),$t.bufferData($t.ELEMENT_ARRAY_BUFFER,at.arrayBuffer,this.dynamicDraw?$t.DYNAMIC_DRAW:$t.STATIC_DRAW),this.dynamicDraw||delete at.arrayBuffer}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(rt){const at=this.context.gl;if(!this.dynamicDraw)throw new Error("Attempted to update data while not in dynamic mode.");this.context.unbindVAO(),this.bind(),at.bufferSubData(at.ELEMENT_ARRAY_BUFFER,0,rt.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}const Lc={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class ar{constructor(rt,at,Tt,$t){this.length=at.length,this.attributes=Tt,this.itemSize=at.bytesPerElement,this.dynamicDraw=$t,this.context=rt;const qt=rt.gl;this.buffer=qt.createBuffer(),rt.bindVertexBuffer.set(this.buffer),qt.bufferData(qt.ARRAY_BUFFER,at.arrayBuffer,this.dynamicDraw?qt.DYNAMIC_DRAW:qt.STATIC_DRAW),this.dynamicDraw||delete at.arrayBuffer}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(rt){if(rt.length!==this.length)throw new Error(`Length of new data is ${rt.length}, which doesn't match current length of ${this.length}`);const at=this.context.gl;this.bind(),at.bufferSubData(at.ARRAY_BUFFER,0,rt.arrayBuffer)}enableAttributes(rt,at){for(let Tt=0;Tt<this.attributes.length;Tt++){const $t=at.attributes[this.attributes[Tt].name];void 0!==$t&&rt.enableVertexAttribArray($t)}}setVertexAttribPointers(rt,at,Tt){for(let $t=0;$t<this.attributes.length;$t++){const qt=this.attributes[$t],Kt=at.attributes[qt.name];void 0!==Kt&&rt.vertexAttribPointer(Kt,qt.components,rt[Lc[qt.type]],!1,this.itemSize,qt.offset+this.itemSize*(Tt||0))}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class sr{constructor(rt){this.gl=rt.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(rt){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class nr extends sr{getDefault(){return Tt.b7.transparent}set(rt){const at=this.current;(rt.r!==at.r||rt.g!==at.g||rt.b!==at.b||rt.a!==at.a||this.dirty)&&(this.gl.clearColor(rt.r,rt.g,rt.b,rt.a),this.current=rt,this.dirty=!1)}}class lr extends sr{getDefault(){return 1}set(rt){(rt!==this.current||this.dirty)&&(this.gl.clearDepth(rt),this.current=rt,this.dirty=!1)}}class cr extends sr{getDefault(){return 0}set(rt){(rt!==this.current||this.dirty)&&(this.gl.clearStencil(rt),this.current=rt,this.dirty=!1)}}class hr extends sr{getDefault(){return[!0,!0,!0,!0]}set(rt){const at=this.current;(rt[0]!==at[0]||rt[1]!==at[1]||rt[2]!==at[2]||rt[3]!==at[3]||this.dirty)&&(this.gl.colorMask(rt[0],rt[1],rt[2],rt[3]),this.current=rt,this.dirty=!1)}}class ur extends sr{getDefault(){return!0}set(rt){(rt!==this.current||this.dirty)&&(this.gl.depthMask(rt),this.current=rt,this.dirty=!1)}}class dr extends sr{getDefault(){return 255}set(rt){(rt!==this.current||this.dirty)&&(this.gl.stencilMask(rt),this.current=rt,this.dirty=!1)}}class _r extends sr{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(rt){const at=this.current;(rt.func!==at.func||rt.ref!==at.ref||rt.mask!==at.mask||this.dirty)&&(this.gl.stencilFunc(rt.func,rt.ref,rt.mask),this.current=rt,this.dirty=!1)}}class pr extends sr{getDefault(){const rt=this.gl;return[rt.KEEP,rt.KEEP,rt.KEEP]}set(rt){const at=this.current;(rt[0]!==at[0]||rt[1]!==at[1]||rt[2]!==at[2]||this.dirty)&&(this.gl.stencilOp(rt[0],rt[1],rt[2]),this.current=rt,this.dirty=!1)}}class mr extends sr{getDefault(){return!1}set(rt){if(rt===this.current&&!this.dirty)return;const at=this.gl;rt?at.enable(at.STENCIL_TEST):at.disable(at.STENCIL_TEST),this.current=rt,this.dirty=!1}}class fr extends sr{getDefault(){return[0,1]}set(rt){const at=this.current;(rt[0]!==at[0]||rt[1]!==at[1]||this.dirty)&&(this.gl.depthRange(rt[0],rt[1]),this.current=rt,this.dirty=!1)}}class gr extends sr{getDefault(){return!1}set(rt){if(rt===this.current&&!this.dirty)return;const at=this.gl;rt?at.enable(at.DEPTH_TEST):at.disable(at.DEPTH_TEST),this.current=rt,this.dirty=!1}}class vr extends sr{getDefault(){return this.gl.LESS}set(rt){(rt!==this.current||this.dirty)&&(this.gl.depthFunc(rt),this.current=rt,this.dirty=!1)}}class xr extends sr{getDefault(){return!1}set(rt){if(rt===this.current&&!this.dirty)return;const at=this.gl;rt?at.enable(at.BLEND):at.disable(at.BLEND),this.current=rt,this.dirty=!1}}class br extends sr{getDefault(){const rt=this.gl;return[rt.ONE,rt.ZERO]}set(rt){const at=this.current;(rt[0]!==at[0]||rt[1]!==at[1]||this.dirty)&&(this.gl.blendFunc(rt[0],rt[1]),this.current=rt,this.dirty=!1)}}class yr extends sr{getDefault(){return Tt.b7.transparent}set(rt){const at=this.current;(rt.r!==at.r||rt.g!==at.g||rt.b!==at.b||rt.a!==at.a||this.dirty)&&(this.gl.blendColor(rt.r,rt.g,rt.b,rt.a),this.current=rt,this.dirty=!1)}}class wr extends sr{getDefault(){return this.gl.FUNC_ADD}set(rt){(rt!==this.current||this.dirty)&&(this.gl.blendEquation(rt),this.current=rt,this.dirty=!1)}}class Tr extends sr{getDefault(){return!1}set(rt){if(rt===this.current&&!this.dirty)return;const at=this.gl;rt?at.enable(at.CULL_FACE):at.disable(at.CULL_FACE),this.current=rt,this.dirty=!1}}class Pr extends sr{getDefault(){return this.gl.BACK}set(rt){(rt!==this.current||this.dirty)&&(this.gl.cullFace(rt),this.current=rt,this.dirty=!1)}}class Cr extends sr{getDefault(){return this.gl.CCW}set(rt){(rt!==this.current||this.dirty)&&(this.gl.frontFace(rt),this.current=rt,this.dirty=!1)}}class Mr extends sr{getDefault(){return null}set(rt){(rt!==this.current||this.dirty)&&(this.gl.useProgram(rt),this.current=rt,this.dirty=!1)}}class Ir extends sr{getDefault(){return this.gl.TEXTURE0}set(rt){(rt!==this.current||this.dirty)&&(this.gl.activeTexture(rt),this.current=rt,this.dirty=!1)}}class Er extends sr{getDefault(){const rt=this.gl;return[0,0,rt.drawingBufferWidth,rt.drawingBufferHeight]}set(rt){const at=this.current;(rt[0]!==at[0]||rt[1]!==at[1]||rt[2]!==at[2]||rt[3]!==at[3]||this.dirty)&&(this.gl.viewport(rt[0],rt[1],rt[2],rt[3]),this.current=rt,this.dirty=!1)}}class Sr extends sr{getDefault(){return null}set(rt){if(rt===this.current&&!this.dirty)return;const at=this.gl;at.bindFramebuffer(at.FRAMEBUFFER,rt),this.current=rt,this.dirty=!1}}class Rr extends sr{getDefault(){return null}set(rt){if(rt===this.current&&!this.dirty)return;const at=this.gl;at.bindRenderbuffer(at.RENDERBUFFER,rt),this.current=rt,this.dirty=!1}}class Dr extends sr{getDefault(){return null}set(rt){if(rt===this.current&&!this.dirty)return;const at=this.gl;at.bindTexture(at.TEXTURE_2D,rt),this.current=rt,this.dirty=!1}}class zr extends sr{getDefault(){return null}set(rt){if(rt===this.current&&!this.dirty)return;const at=this.gl;at.bindBuffer(at.ARRAY_BUFFER,rt),this.current=rt,this.dirty=!1}}class Ar extends sr{getDefault(){return null}set(rt){const at=this.gl;at.bindBuffer(at.ELEMENT_ARRAY_BUFFER,rt),this.current=rt,this.dirty=!1}}class Lr extends sr{getDefault(){return null}set(rt){var at;if(rt===this.current&&!this.dirty)return;const Tt=this.gl;Wt(Tt)?Tt.bindVertexArray(rt):null===(at=Tt.getExtension("OES_vertex_array_object"))||void 0===at||at.bindVertexArrayOES(rt),this.current=rt,this.dirty=!1}}class kr extends sr{getDefault(){return 4}set(rt){if(rt===this.current&&!this.dirty)return;const at=this.gl;at.pixelStorei(at.UNPACK_ALIGNMENT,rt),this.current=rt,this.dirty=!1}}class Fr extends sr{getDefault(){return!1}set(rt){if(rt===this.current&&!this.dirty)return;const at=this.gl;at.pixelStorei(at.UNPACK_PREMULTIPLY_ALPHA_WEBGL,rt),this.current=rt,this.dirty=!1}}class Br extends sr{getDefault(){return!1}set(rt){if(rt===this.current&&!this.dirty)return;const at=this.gl;at.pixelStorei(at.UNPACK_FLIP_Y_WEBGL,rt),this.current=rt,this.dirty=!1}}class Or extends sr{constructor(rt,at){super(rt),this.context=rt,this.parent=at}getDefault(){return null}}class jr extends Or{setDirty(){this.dirty=!0}set(rt){if(rt===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const at=this.gl;at.framebufferTexture2D(at.FRAMEBUFFER,at.COLOR_ATTACHMENT0,at.TEXTURE_2D,rt,0),this.current=rt,this.dirty=!1}}class Zr extends Or{set(rt){if(rt===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const at=this.gl;at.framebufferRenderbuffer(at.FRAMEBUFFER,at.DEPTH_ATTACHMENT,at.RENDERBUFFER,rt),this.current=rt,this.dirty=!1}}class Nr extends Or{set(rt){if(rt===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const at=this.gl;at.framebufferRenderbuffer(at.FRAMEBUFFER,at.DEPTH_STENCIL_ATTACHMENT,at.RENDERBUFFER,rt),this.current=rt,this.dirty=!1}}const Oc="Framebuffer is not complete";class Gr{constructor(rt,at,Tt,$t,qt){this.context=rt,this.width=at,this.height=Tt;const Kt=rt.gl,ge=this.framebuffer=Kt.createFramebuffer();if(this.colorAttachment=new jr(rt,ge),$t)this.depthAttachment=qt?new Nr(rt,ge):new Zr(rt,ge);else if(qt)throw new Error("Stencil cannot be set without depth");if(Kt.checkFramebufferStatus(Kt.FRAMEBUFFER)!==Kt.FRAMEBUFFER_COMPLETE)throw new Error(Oc)}destroy(){const rt=this.context.gl,at=this.colorAttachment.get();if(at&&rt.deleteTexture(at),this.depthAttachment){const at=this.depthAttachment.get();at&&rt.deleteRenderbuffer(at)}rt.deleteFramebuffer(this.framebuffer)}}class Vr{constructor(rt){var at,Tt;if(this.gl=rt,this.clearColor=new nr(this),this.clearDepth=new lr(this),this.clearStencil=new cr(this),this.colorMask=new hr(this),this.depthMask=new ur(this),this.stencilMask=new dr(this),this.stencilFunc=new _r(this),this.stencilOp=new pr(this),this.stencilTest=new mr(this),this.depthRange=new fr(this),this.depthTest=new gr(this),this.depthFunc=new vr(this),this.blend=new xr(this),this.blendFunc=new br(this),this.blendColor=new yr(this),this.blendEquation=new wr(this),this.cullFace=new Tr(this),this.cullFaceSide=new Pr(this),this.frontFace=new Cr(this),this.program=new Mr(this),this.activeTexture=new Ir(this),this.viewport=new Er(this),this.bindFramebuffer=new Sr(this),this.bindRenderbuffer=new Rr(this),this.bindTexture=new Dr(this),this.bindVertexBuffer=new zr(this),this.bindElementBuffer=new Ar(this),this.bindVertexArray=new Lr(this),this.pixelStoreUnpack=new kr(this),this.pixelStoreUnpackPremultiplyAlpha=new Fr(this),this.pixelStoreUnpackFlipY=new Br(this),this.extTextureFilterAnisotropic=rt.getExtension("EXT_texture_filter_anisotropic")||rt.getExtension("MOZ_EXT_texture_filter_anisotropic")||rt.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=rt.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT)),this.maxTextureSize=rt.getParameter(rt.MAX_TEXTURE_SIZE),Wt(rt)){this.HALF_FLOAT=rt.HALF_FLOAT;const $t=rt.getExtension("EXT_color_buffer_half_float");this.RGBA16F=null!==(at=rt.RGBA16F)&&void 0!==at?at:null==$t?void 0:$t.RGBA16F_EXT,this.RGB16F=null!==(Tt=rt.RGB16F)&&void 0!==Tt?Tt:null==$t?void 0:$t.RGB16F_EXT,rt.getExtension("EXT_color_buffer_float")}else{rt.getExtension("EXT_color_buffer_half_float"),rt.getExtension("OES_texture_half_float_linear");const at=rt.getExtension("OES_texture_half_float");this.HALF_FLOAT=null==at?void 0:at.HALF_FLOAT_OES}}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArray.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(rt,at){return new rr(this,rt,at)}createVertexBuffer(rt,at,Tt){return new ar(this,rt,at,Tt)}createRenderbuffer(rt,at,Tt){const $t=this.gl,qt=$t.createRenderbuffer();return this.bindRenderbuffer.set(qt),$t.renderbufferStorage($t.RENDERBUFFER,rt,at,Tt),this.bindRenderbuffer.set(null),qt}createFramebuffer(rt,at,Tt,$t){return new Gr(this,rt,at,Tt,$t)}clear({color:rt,depth:at,stencil:Tt}){const $t=this.gl;let qt=0;rt&&(qt|=$t.COLOR_BUFFER_BIT,this.clearColor.set(rt),this.colorMask.set([!0,!0,!0,!0])),void 0!==at&&(qt|=$t.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(at),this.depthMask.set(!0)),void 0!==Tt&&(qt|=$t.STENCIL_BUFFER_BIT,this.clearStencil.set(Tt),this.stencilMask.set(255)),$t.clear(qt)}setCullFace(rt){!1===rt.enable?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(rt.mode),this.frontFace.set(rt.frontFace))}setDepthMode(rt){rt.func!==this.gl.ALWAYS||rt.mask?(this.depthTest.set(!0),this.depthFunc.set(rt.func),this.depthMask.set(rt.mask),this.depthRange.set(rt.range)):this.depthTest.set(!1)}setStencilMode(rt){rt.test.func!==this.gl.ALWAYS||rt.mask?(this.stencilTest.set(!0),this.stencilMask.set(rt.mask),this.stencilOp.set([rt.fail,rt.depthFail,rt.pass]),this.stencilFunc.set({func:rt.test.func,ref:rt.ref,mask:rt.test.mask})):this.stencilTest.set(!1)}setColorMode(rt){Tt.bE(rt.blendFunction,jt.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(rt.blendFunction),this.blendColor.set(rt.blendColor)),this.colorMask.set(rt.mask)}createVertexArray(){var rt;return Wt(this.gl)?this.gl.createVertexArray():null===(rt=this.gl.getExtension("OES_vertex_array_object"))||void 0===rt?void 0:rt.createVertexArrayOES()}deleteVertexArray(rt){var at;return Wt(this.gl)?this.gl.deleteVertexArray(rt):null===(at=this.gl.getExtension("OES_vertex_array_object"))||void 0===at?void 0:at.deleteVertexArrayOES(rt)}unbindVAO(){this.bindVertexArray.set(null)}}let jc;function Wr(rt,at,$t,qt,Kt){const ge=rt.context,Hr=rt.transform,wn=ge.gl,es=rt.useProgram("collisionBox"),ss=[];let os=0,cs=0;for(let Tt=0;Tt<qt.length;Tt++){const ds=qt[Tt],Cs=at.getTile(ds).getBucket($t);if(!Cs)continue;const Vs=Kt?Cs.textCollisionBox:Cs.iconCollisionBox,Eo=Cs.collisionCircleArray;Eo.length>0&&(ss.push({circleArray:Eo,circleOffset:cs,coord:ds}),os+=Eo.length/4,cs=os),Vs&&es.draw(ge,wn.LINES,Ut.disabled,Vt.disabled,rt.colorModeForRenderPass(),Nt.disabled,Li(rt.transform),rt.style.map.terrain&&rt.style.map.terrain.getTerrainData(ds),Hr.getProjectionData({overscaledTileID:ds,applyGlobeMatrix:!0,applyTerrainMatrix:!0}),$t.id,Vs.layoutVertexBuffer,Vs.indexBuffer,Vs.segments,null,rt.transform.zoom,null,null,Vs.collisionVertexBuffer)}if(!Kt||!ss.length)return;const ds=rt.useProgram("collisionCircle"),Cs=new Tt.bR;Cs.resize(4*os),Cs._trim();let Vs=0;for(const rt of ss)for(let at=0;at<rt.circleArray.length/4;at++){const Tt=4*at,$t=rt.circleArray[Tt+0],qt=rt.circleArray[Tt+1],Kt=rt.circleArray[Tt+2],ge=rt.circleArray[Tt+3];Cs.emplace(Vs++,$t,qt,Kt,ge,0),Cs.emplace(Vs++,$t,qt,Kt,ge,1),Cs.emplace(Vs++,$t,qt,Kt,ge,2),Cs.emplace(Vs++,$t,qt,Kt,ge,3)}(!jc||jc.length<2*os)&&(jc=function(rt){const at=2*rt,$t=new Tt.bT;$t.resize(at),$t._trim();for(let rt=0;rt<at;rt++){const at=6*rt;$t.uint16[at+0]=4*rt+0,$t.uint16[at+1]=4*rt+1,$t.uint16[at+2]=4*rt+2,$t.uint16[at+3]=4*rt+2,$t.uint16[at+4]=4*rt+3,$t.uint16[at+5]=4*rt+0}return $t}(os));const Eo=ge.createIndexBuffer(jc,!0),Do=ge.createVertexBuffer(Cs,Tt.bS.members,!0);for(const at of ss){const qt=ki(rt.transform);ds.draw(ge,wn.TRIANGLES,Ut.disabled,Vt.disabled,rt.colorModeForRenderPass(),Nt.disabled,qt,rt.style.map.terrain&&rt.style.map.terrain.getTerrainData(at.coord),null,$t.id,Do,Eo,Tt.aJ.simpleSegment(0,2*at.circleOffset,at.circleArray.length,at.circleArray.length/2),null,rt.transform.zoom,null,null,null)}Do.destroy(),Eo.destroy()}const Nc=Tt.ad(new Float32Array(16));function $r(rt,at,$t,qt,Kt,ge){const{horizontalAlign:Hr,verticalAlign:wn}=Tt.aE(rt);return new Tt.P((-(Hr-.5)*at/Kt+qt[0])*ge,(-(wn-.5)*$t/Kt+qt[1])*ge)}function Xr(rt,at,$t,qt,Kt,ge){const Hr=at.tileAnchorPoint.add(new Tt.P(at.translation[0],at.translation[1]));if(at.pitchWithMap){let rt=qt.mult(ge);$t||(rt=rt.rotate(-Kt));const Tt=Hr.add(rt);return Se(Tt.x,Tt.y,at.pitchedLabelPlaneMatrix,at.getElevation).point}if($t){const Tt=Oe(at.tileAnchorPoint.x+1,at.tileAnchorPoint.y,at).point.sub(rt),$t=Math.atan(Tt.y/Tt.x)+(Tt.x<0?Math.PI:0);return rt.add(qt.rotate($t))}return rt.add(qt)}function Kr(rt,at,$t,qt,Kt,ge,Hr,wn,es,ss,os,cs){const ds=rt.text.placedSymbolArray,Cs=rt.text.dynamicLayoutVertexArray,Vs=rt.icon.dynamicLayoutVertexArray,Eo={};Cs.clear();for(let Vs=0;Vs<ds.length;Vs++){const Do=ds.get(Vs),Ho=Do.hidden||!Do.crossTileID||rt.allowVerticalPlacement&&!Do.placedOrientation?null:qt[Do.crossTileID];if(Ho){const qt=new Tt.P(Do.anchorX,Do.anchorY),ds={getElevation:cs,width:Kt.width,height:Kt.height,pitchedLabelPlaneMatrix:ge,pitchWithMap:$t,transform:Kt,tileAnchorPoint:qt,translation:ss,unwrappedTileID:os},Vs=$t?Ze(qt.x,qt.y,ds):Oe(qt.x,qt.y,ds),Ea=Re(Kt.cameraToCenterDistance,Vs.signedDistanceFromCamera);let La=Tt.am(rt.textSizeData,wn,Do)*Ea/Tt.ay;$t&&(La*=rt.tilePixelRatio/Hr);const{width:ja,height:Va,anchor:Na,textOffset:qa,textBoxScale:Qa}=Ho,Pl=$r(Na,ja,Va,qa,Qa,La),zl=Kt.getPitchedTextCorrection(qt.x+ss[0],qt.y+ss[1],os),Dl=Xr(Vs.point,ds,at,Pl,-Kt.bearingInRadians,zl),Ll=rt.allowVerticalPlacement&&Do.placedOrientation===Tt.al.vertical?Math.PI/2:0;for(let rt=0;rt<Do.numGlyphs;rt++)Tt.as(Cs,Dl,Ll);es&&Do.associatedIconIndex>=0&&(Eo[Do.associatedIconIndex]={shiftedAnchor:Dl,angle:Ll})}else qe(Do.numGlyphs,Cs)}if(es){Vs.clear();const at=rt.icon.placedSymbolArray;for(let rt=0;rt<at.length;rt++){const $t=at.get(rt);if($t.hidden)qe($t.numGlyphs,Vs);else{const at=Eo[rt];if(at)for(let rt=0;rt<$t.numGlyphs;rt++)Tt.as(Vs,at.shiftedAnchor,at.angle);else qe($t.numGlyphs,Vs)}}rt.icon.dynamicLayoutVertexBuffer.updateData(Vs)}rt.text.dynamicLayoutVertexBuffer.updateData(Cs)}function Qr(rt,at,Tt){return Tt.iconsInText&&at?"symbolTextAndIcon":rt?"symbolSDF":"symbolIcon"}function Yr(rt,at,$t,qt,Kt,ge,Hr,wn,es,ss,os,cs,ds){const Cs=rt.context,Vs=Cs.gl,Eo=rt.transform,Do="map"===wn,Ho="map"===es,Ea="viewport"!==wn&&"point"!==$t.layout.get("symbol-placement"),La=Do&&!Ho&&!Ea,ja=!$t.layout.get("symbol-sort-key").isConstant();let Va=!1;const Na=rt.getDepthModeForSublayer(0,Ut.ReadOnly),qa=$t._unevaluatedLayout.hasValue("text-variable-anchor")||$t._unevaluatedLayout.hasValue("text-variable-anchor-offset"),Qa=[],Pl=Eo.getCircleRadiusCorrection();for(const wn of qt){const qt=at.getTile(wn),es=qt.getBucket($t);if(!es)continue;const os=Kt?es.text:es.icon;if(!os||!os.segments.get().length||!os.hasVisibleVertices)continue;const cs=os.programConfigurations.get($t.id),Cs=Kt||es.sdfIcons,Na=Kt?es.textSizeData:es.iconSizeData,zl=Ho||0!==Eo.pitch,Dl=rt.useProgram(Qr(Cs,Kt,es),cs),Ll=Tt.ak(Na,Eo.zoom),Ol=rt.style.map.terrain&&rt.style.map.terrain.getTerrainData(wn);let jl,Nl,Zl,Ul,Gl=[0,0],ql=null;if(Kt)Nl=qt.glyphAtlasTexture,Zl=Vs.LINEAR,jl=qt.glyphAtlasTexture.size,es.iconsInText&&(Gl=qt.imageAtlasTexture.size,ql=qt.imageAtlasTexture,Ul=zl||rt.options.rotating||rt.options.zooming||"composite"===Na.kind||"camera"===Na.kind?Vs.LINEAR:Vs.NEAREST);else{const at=1!==$t.layout.get("icon-size").constantOr(0)||es.iconsNeedLinear;Nl=qt.imageAtlasTexture,Zl=Cs||rt.options.rotating||rt.options.zooming||at||zl?Vs.LINEAR:Vs.NEAREST,jl=qt.imageAtlasTexture.size}const Hl=Tt.az(qt,1,rt.transform.zoom),Xl=Me(Do,rt.transform,Hl),Kl=Tt.K();Tt.an(Kl,Xl);const Yl=Ie(Ho,Do,rt.transform,Hl),Jl=Tt.aA(Eo,qt,ge,Hr),tc=Eo.getProjectionData({overscaledTileID:wn,applyGlobeMatrix:!ds,applyTerrainMatrix:!0}),ic=qa&&es.hasTextData(),sc="none"!==$t.layout.get("icon-text-fit")&&ic&&es.hasIconData();if(Ea){const at=rt.style.map.terrain?(at,Tt)=>rt.style.map.terrain.getElevation(wn,at,Tt):null,Tt="map"===$t.layout.get("text-rotation-alignment");ze(es,rt,Kt,Xl,Kl,Ho,ss,Tt,wn.toUnwrapped(),Eo.width,Eo.height,Jl,at)}const ac=Kt&&qa||sc,Pc=Ea||ac?Nc:Ho?Xl:rt.transform.clipSpaceToPixelsMatrix,Sc=Cs&&0!==$t.paint.get(Kt?"text-halo-width":"icon-halo-width").constantOr(1);let Ac;Ac=Cs?es.iconsInText?Yi(Na.kind,Ll,La,Ho,Ea,ac,rt,Pc,Yl,Jl,jl,Gl,Pl):Qi(Na.kind,Ll,La,Ho,Ea,ac,rt,Pc,Yl,Jl,Kt,jl,0,Pl):Ki(Na.kind,Ll,La,Ho,Ea,ac,rt,Pc,Yl,Jl,Kt,jl,Pl);const zc={program:Dl,buffers:os,uniformValues:Ac,projectionData:tc,atlasTexture:Nl,atlasTextureIcon:ql,atlasInterpolation:Zl,atlasInterpolationIcon:Ul,isSDF:Cs,hasHalo:Sc};if(ja&&es.canOverlap){Va=!0;const rt=os.segments.get();for(const at of rt)Qa.push({segments:new Tt.aJ([at]),sortKey:at.sortKey,state:zc,terrainData:Ol})}else Qa.push({segments:os.segments,sortKey:0,state:zc,terrainData:Ol})}Va&&Qa.sort(((rt,at)=>rt.sortKey-at.sortKey));for(const at of Qa){const Tt=at.state;if(Cs.activeTexture.set(Vs.TEXTURE0),Tt.atlasTexture.bind(Tt.atlasInterpolation,Vs.CLAMP_TO_EDGE),Tt.atlasTextureIcon&&(Cs.activeTexture.set(Vs.TEXTURE1),Tt.atlasTextureIcon&&Tt.atlasTextureIcon.bind(Tt.atlasInterpolationIcon,Vs.CLAMP_TO_EDGE)),Tt.isSDF){const qt=Tt.uniformValues;Tt.hasHalo&&(qt.u_is_halo=1,Jr(Tt.buffers,at.segments,$t,rt,Tt.program,Na,os,cs,qt,Tt.projectionData,at.terrainData)),qt.u_is_halo=0}Jr(Tt.buffers,at.segments,$t,rt,Tt.program,Na,os,cs,Tt.uniformValues,Tt.projectionData,at.terrainData)}}function Jr(rt,at,Tt,$t,qt,Kt,ge,Hr,wn,es,ss){const os=$t.context;qt.draw(os,os.gl.TRIANGLES,Kt,ge,Hr,Nt.backCCW,wn,ss,es,Tt.id,rt.layoutVertexBuffer,rt.indexBuffer,at,Tt.paint,$t.transform.zoom,rt.programConfigurations.get(Tt.id),rt.dynamicLayoutVertexBuffer,rt.opacityVertexBuffer)}function eo(rt,at,$t,qt,Kt){const ge=rt.context,Hr=ge.gl,wn=Vt.disabled,es=new jt([Hr.ONE,Hr.ONE],Tt.b7.transparent,[!0,!0,!0,!0]),ss=at.getBucket($t);if(!ss)return;const os=qt.key;let cs=$t.heatmapFbos.get(os);cs||(cs=io(ge,at.tileSize,at.tileSize),$t.heatmapFbos.set(os,cs)),ge.bindFramebuffer.set(cs.framebuffer),ge.viewport.set([0,0,at.tileSize,at.tileSize]),ge.clear({color:Tt.b7.transparent});const ds=ss.programConfigurations.get($t.id),Cs=rt.useProgram("heatmap",ds,!Kt),Vs=rt.transform.getProjectionData({overscaledTileID:at.tileID,applyGlobeMatrix:!0,applyTerrainMatrix:!0}),Eo=rt.style.map.terrain.getTerrainData(qt);Cs.draw(ge,Hr.TRIANGLES,Ut.disabled,wn,es,Nt.disabled,Bi(at,rt.transform.zoom,$t.paint.get("heatmap-intensity"),1),Eo,Vs,$t.id,ss.layoutVertexBuffer,ss.indexBuffer,ss.segments,$t.paint,rt.transform.zoom,ds)}function to(rt,at,Tt,$t,qt){const Kt=rt.context,ge=Kt.gl,Hr=rt.transform;Kt.setColorMode(rt.colorModeForRenderPass());const wn=ro(Kt,at),es=Tt.key,ss=at.heatmapFbos.get(es);if(!ss)return;Kt.activeTexture.set(ge.TEXTURE0),ge.bindTexture(ge.TEXTURE_2D,ss.colorAttachment.get()),Kt.activeTexture.set(ge.TEXTURE1),wn.bind(ge.LINEAR,ge.CLAMP_TO_EDGE);const os=Hr.getProjectionData({overscaledTileID:Tt,applyTerrainMatrix:qt,applyGlobeMatrix:!$t});rt.useProgram("heatmapTexture").draw(Kt,ge.TRIANGLES,Ut.disabled,Vt.disabled,rt.colorModeForRenderPass(),Nt.disabled,Oi(rt,at,0,1),null,os,at.id,rt.rasterBoundsBuffer,rt.quadTriangleIndexBuffer,rt.rasterBoundsSegments,at.paint,Hr.zoom),ss.destroy(),at.heatmapFbos.delete(es)}function io(rt,at,Tt){var $t,qt;const Kt=rt.gl,ge=Kt.createTexture();Kt.bindTexture(Kt.TEXTURE_2D,ge),Kt.texParameteri(Kt.TEXTURE_2D,Kt.TEXTURE_WRAP_S,Kt.CLAMP_TO_EDGE),Kt.texParameteri(Kt.TEXTURE_2D,Kt.TEXTURE_WRAP_T,Kt.CLAMP_TO_EDGE),Kt.texParameteri(Kt.TEXTURE_2D,Kt.TEXTURE_MIN_FILTER,Kt.LINEAR),Kt.texParameteri(Kt.TEXTURE_2D,Kt.TEXTURE_MAG_FILTER,Kt.LINEAR);const Hr=null!==($t=rt.HALF_FLOAT)&&void 0!==$t?$t:Kt.UNSIGNED_BYTE,wn=null!==(qt=rt.RGBA16F)&&void 0!==qt?qt:Kt.RGBA;Kt.texImage2D(Kt.TEXTURE_2D,0,wn,at,Tt,0,Kt.RGBA,Hr,null);const es=rt.createFramebuffer(at,Tt,!1,!1);return es.colorAttachment.set(ge),es}function ro(rt,at){return at.colorRampTexture||(at.colorRampTexture=new v(rt,at.colorRamp,rt.gl.RGBA)),at.colorRampTexture}function oo(rt,at,Tt,$t,qt){if(!Tt||!$t||!$t.imageAtlas)return;const Kt=$t.imageAtlas.patternPositions;let ge=Kt[Tt.to.toString()],Hr=Kt[Tt.from.toString()];if(!ge&&Hr&&(ge=Hr),!Hr&&ge&&(Hr=ge),!ge||!Hr){const rt=qt.getPaintProperty(at);ge=Kt[rt],Hr=Kt[rt]}ge&&Hr&&rt.setConstantPatternPositions(ge,Hr)}function ao(rt,at,$t,qt,Kt,ge,Hr,wn){const es=rt.context.gl,ss="fill-pattern",os=$t.paint.get(ss),cs=os&&os.constantOr(1),ds=$t.getCrossfadeParameters();let Cs,Vs,Eo,Do,Ho;const Ea=rt.transform,La=$t.paint.get("fill-translate"),ja=$t.paint.get("fill-translate-anchor");Hr?(Vs=cs&&!$t.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",Cs=es.LINES):(Vs=cs?"fillPattern":"fill",Cs=es.TRIANGLES);const Va=os.constantOr(null);for(const os of qt){const Na=at.getTile(os);if(cs&&!Na.patternsLoaded())continue;const qa=Na.getBucket($t);if(!qa)continue;const Qa=qa.programConfigurations.get($t.id),Pl=rt.useProgram(Vs,Qa),zl=rt.style.map.terrain&&rt.style.map.terrain.getTerrainData(os);cs&&(rt.context.activeTexture.set(es.TEXTURE0),Na.imageAtlasTexture.bind(es.LINEAR,es.CLAMP_TO_EDGE),Qa.updatePaintBuffers(ds)),oo(Qa,ss,Va,Na,$t);const Dl=Ea.getProjectionData({overscaledTileID:os,applyGlobeMatrix:!wn,applyTerrainMatrix:!0}),Ll=Tt.aA(Ea,Na,La,ja);if(Hr){Do=qa.indexBuffer2,Ho=qa.segments2;const at=[es.drawingBufferWidth,es.drawingBufferHeight];Eo="fillOutlinePattern"===Vs&&cs?zi(rt,ds,Na,at,Ll):Di(at,Ll)}else Do=qa.indexBuffer,Ho=qa.segments,Eo=cs?Ri(rt,ds,Na,Ll):{u_fill_translate:Ll};let Ol;if("translucent"===rt.renderPass&&wn){const[at]=rt.getStencilConfigForOverlapAndUpdateStencilID(qt);Ol=at[os.overscaledZ]}else Ol=rt.stencilModeForClipping(os);Pl.draw(rt.context,Cs,Kt,Ol,ge,Nt.backCCW,Eo,zl,Dl,$t.id,qa.layoutVertexBuffer,Do,Ho,$t.paint,rt.transform.zoom,Qa)}}function so(rt,at,$t,qt,Kt,ge,Hr,wn){const es=rt.context,ss=es.gl,os="fill-extrusion-pattern",cs=$t.paint.get(os),ds=cs.constantOr(1),Cs=$t.getCrossfadeParameters(),Vs=$t.paint.get("fill-extrusion-opacity"),Eo=cs.constantOr(null),Do=rt.transform;for(const cs of qt){const qt=at.getTile(cs),Ho=qt.getBucket($t);if(!Ho)continue;const Ea=rt.style.map.terrain&&rt.style.map.terrain.getTerrainData(cs),La=Ho.programConfigurations.get($t.id),ja=rt.useProgram(ds?"fillExtrusionPattern":"fillExtrusion",La);ds&&(rt.context.activeTexture.set(ss.TEXTURE0),qt.imageAtlasTexture.bind(ss.LINEAR,ss.CLAMP_TO_EDGE),La.updatePaintBuffers(Cs));const Va=Do.getProjectionData({overscaledTileID:cs,applyGlobeMatrix:!wn,applyTerrainMatrix:!0});oo(La,os,Eo,qt,$t);const Na=Tt.aA(Do,qt,$t.paint.get("fill-extrusion-translate"),$t.paint.get("fill-extrusion-translate-anchor")),qa=$t.paint.get("fill-extrusion-vertical-gradient"),Qa=ds?Si(rt,qa,Vs,Na,cs,Cs,qt):Ei(rt,qa,Vs,Na);ja.draw(es,es.gl.TRIANGLES,Kt,ge,Hr,Nt.backCCW,Qa,Ea,Va,$t.id,Ho.layoutVertexBuffer,Ho.indexBuffer,Ho.segments,$t.paint,rt.transform.zoom,La,rt.style.map.terrain&&Ho.centroidVertexBuffer)}}function no(rt,at,Tt,$t,qt,Kt,ge,Hr,wn){var es;const ss=rt.style.projection,os=rt.context,cs=rt.transform,ds=os.gl,Cs=rt.useProgram("hillshade"),Vs=!rt.options.moving;for(const Eo of $t){const $t=at.getTile(Eo),Do=$t.fbo;if(!Do)continue;const Ho=ss.getMeshFromTileID(os,Eo.canonical,Hr,!0,"raster"),Ea=null===(es=rt.style.map.terrain)||void 0===es?void 0:es.getTerrainData(Eo);os.activeTexture.set(ds.TEXTURE0),ds.bindTexture(ds.TEXTURE_2D,Do.colorAttachment.get());const La=cs.getProjectionData({overscaledTileID:Eo,aligned:Vs,applyGlobeMatrix:!wn,applyTerrainMatrix:!0});Cs.draw(os,ds.TRIANGLES,Kt,qt[Eo.overscaledZ],ge,Nt.backCCW,ji(rt,$t,Tt),Ea,La,Tt.id,Ho.vertexBuffer,Ho.indexBuffer,Ho.segments)}}const $c=[new Tt.P(0,0),new Tt.P(Tt.Z,0),new Tt.P(Tt.Z,Tt.Z),new Tt.P(0,Tt.Z)];function co(rt,at,Tt,$t,qt,Kt,ge,Hr,wn=!1,es=!1){const ss=$t[$t.length-1].overscaledZ,os=rt.context,cs=os.gl,ds=rt.useProgram("raster"),Cs=rt.transform,Vs=rt.style.projection,Eo=rt.colorModeForRenderPass(),Do=!rt.options.moving;for(const Ho of $t){const $t=rt.getDepthModeForSublayer(Ho.overscaledZ-ss,1===Tt.paint.get("raster-opacity")?Ut.ReadWrite:Ut.ReadOnly,cs.LESS),Ea=at.getTile(Ho);Ea.registerFadeDuration(Tt.paint.get("raster-fade-duration"));const La=at.findLoadedParent(Ho,0),ja=at.findLoadedSibling(Ho),Va=ho(Ea,La||ja||null,at,Tt,rt.transform,rt.style.map.terrain);let Na,qa;const Qa="nearest"===Tt.paint.get("raster-resampling")?cs.NEAREST:cs.LINEAR;os.activeTexture.set(cs.TEXTURE0),Ea.texture.bind(Qa,cs.CLAMP_TO_EDGE,cs.LINEAR_MIPMAP_NEAREST),os.activeTexture.set(cs.TEXTURE1),La?(La.texture.bind(Qa,cs.CLAMP_TO_EDGE,cs.LINEAR_MIPMAP_NEAREST),Na=Math.pow(2,La.tileID.overscaledZ-Ea.tileID.overscaledZ),qa=[Ea.tileID.canonical.x*Na%1,Ea.tileID.canonical.y*Na%1]):Ea.texture.bind(Qa,cs.CLAMP_TO_EDGE,cs.LINEAR_MIPMAP_NEAREST),Ea.texture.useMipmap&&os.extTextureFilterAnisotropic&&rt.transform.pitch>20&&cs.texParameterf(cs.TEXTURE_2D,os.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,os.extTextureFilterAnisotropicMax);const Pl=rt.style.map.terrain&&rt.style.map.terrain.getTerrainData(Ho),zl=Cs.getProjectionData({overscaledTileID:Ho,aligned:Do,applyGlobeMatrix:!es,applyTerrainMatrix:!0}),Dl=$i(qa||[0,0],Na||1,Va,Tt,Hr),Ll=Vs.getMeshFromTileID(os,Ho.canonical,Kt,ge,"raster");ds.draw(os,cs.TRIANGLES,$t,qt?qt[Ho.overscaledZ]:Vt.disabled,Eo,wn?Nt.frontCCW:Nt.backCCW,Dl,Pl,zl,Tt.id,Ll.vertexBuffer,Ll.indexBuffer,Ll.segments)}}function ho(rt,at,$t,qt,Kt,Hr){const wn=qt.paint.get("raster-fade-duration");if(!Hr&&wn>0){const qt=ge.now(),Hr=(qt-rt.timeAdded)/wn,es=at?(qt-at.timeAdded)/wn:-1,ss=$t.getSource(),os=ve(Kt,{tileSize:ss.tileSize,roundZoom:ss.roundZoom}),cs=!at||Math.abs(at.tileID.overscaledZ-os)>Math.abs(rt.tileID.overscaledZ-os),ds=cs&&rt.refreshedUponExpiration?1:Tt.ae(cs?Hr:1-es,0,1);return rt.refreshedUponExpiration&&Hr>=1&&(rt.refreshedUponExpiration=!1),at?{opacity:1,mix:1-ds}:{opacity:ds,mix:0}}return{opacity:1,mix:0}}const Gc=new Tt.b7(1,0,0,1),qc=new Tt.b7(0,1,0,1),Wc=new Tt.b7(0,0,1,1),Hc=new Tt.b7(1,0,1,1),Yc=new Tt.b7(0,1,1,1);function go(rt,at,Tt,$t){xo(rt,0,at+Tt/2,rt.transform.width,Tt,$t)}function vo(rt,at,Tt,$t){xo(rt,at-Tt/2,0,Tt,rt.transform.height,$t)}function xo(rt,at,Tt,$t,qt,Kt){const ge=rt.context,Hr=ge.gl;Hr.enable(Hr.SCISSOR_TEST),Hr.scissor(at*rt.pixelRatio,Tt*rt.pixelRatio,$t*rt.pixelRatio,qt*rt.pixelRatio),ge.clear({color:Kt}),Hr.disable(Hr.SCISSOR_TEST)}function bo(rt,at,$t){const qt=rt.context,Kt=qt.gl,ge=rt.useProgram("debug"),Hr=Ut.disabled,wn=Vt.disabled,es=rt.colorModeForRenderPass(),ss="$debug",os=rt.style.map.terrain&&rt.style.map.terrain.getTerrainData($t);qt.activeTexture.set(Kt.TEXTURE0);const cs=at.getTileByID($t.key).latestRawTileData,ds=Math.floor((cs&&cs.byteLength||0)/1024),Cs=at.getTile($t).tileSize,Vs=512/Math.min(Cs,512)*($t.overscaledZ/rt.transform.zoom)*.5;let Eo=$t.canonical.toString();$t.overscaledZ!==$t.canonical.z&&(Eo+=` => ${$t.overscaledZ}`),function(rt,at){rt.initDebugOverlayCanvas();const Tt=rt.debugOverlayCanvas,$t=rt.context.gl,qt=rt.debugOverlayCanvas.getContext("2d");qt.clearRect(0,0,Tt.width,Tt.height),qt.shadowColor="white",qt.shadowBlur=2,qt.lineWidth=1.5,qt.strokeStyle="white",qt.textBaseline="top",qt.font="bold 36px Open Sans, sans-serif",qt.fillText(at,5,5),qt.strokeText(at,5,5),rt.debugOverlayTexture.update(Tt),rt.debugOverlayTexture.bind($t.LINEAR,$t.CLAMP_TO_EDGE)}(rt,`${Eo} ${ds}kB`);const Do=rt.transform.getProjectionData({overscaledTileID:$t,applyGlobeMatrix:!0,applyTerrainMatrix:!0});ge.draw(qt,Kt.TRIANGLES,Hr,wn,jt.alphaBlended,Nt.disabled,Fi(Tt.b7.transparent,Vs),null,Do,ss,rt.debugBuffer,rt.quadTriangleIndexBuffer,rt.debugSegments),ge.draw(qt,Kt.LINE_STRIP,Hr,wn,es,Nt.disabled,Fi(Tt.b7.red),os,Do,ss,rt.debugBuffer,rt.tileBorderIndexBuffer,rt.debugSegments)}function yo(rt,at,Tt,$t){const{isRenderingGlobe:qt}=$t,Kt=rt.context,ge=Kt.gl,Hr=rt.transform,wn=rt.colorModeForRenderPass(),es=rt.getDepthModeFor3D(),ss=rt.useProgram("terrain");Kt.bindFramebuffer.set(null),Kt.viewport.set([0,0,rt.width,rt.height]);for(const $t of Tt){const Tt=at.getTerrainMesh($t.tileID),os=rt.renderToTexture.getTexture($t),cs=at.getTerrainData($t.tileID);Kt.activeTexture.set(ge.TEXTURE0),ge.bindTexture(ge.TEXTURE_2D,os.texture);const ds=at.getMeshFrameDelta(Hr.zoom),Cs=Hr.calculateFogMatrix($t.tileID.toUnwrapped()),Vs=Ti(ds,Cs,rt.style.sky,Hr.pitch,qt),Eo=Hr.getProjectionData({overscaledTileID:$t.tileID,applyTerrainMatrix:!1,applyGlobeMatrix:!0});ss.draw(Kt,ge.TRIANGLES,es,Vt.disabled,wn,Nt.backCCW,Vs,cs,Eo,"terrain",Tt.vertexBuffer,Tt.indexBuffer,Tt.segments)}}function wo(rt,at){if(!at.mesh){const $t=new Tt.aI;$t.emplaceBack(-1,-1),$t.emplaceBack(1,-1),$t.emplaceBack(1,1),$t.emplaceBack(-1,1);const qt=new Tt.aK;qt.emplaceBack(0,1,2),qt.emplaceBack(0,2,3),at.mesh=new wt(rt.createVertexBuffer($t,Xl.members),rt.createIndexBuffer(qt),Tt.aJ.simpleSegment(0,0,$t.length,qt.length))}return at.mesh}class To{constructor(rt,at){this.context=new Vr(rt),this.transform=at,this._tileTextures={},this.terrainFacilitator={dirty:!0,matrix:Tt.ad(new Float64Array(16)),renderTime:0},this.setup(),this.numSublayers=be.maxUnderzooming+be.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.crossTileSymbolIndex=new vt}resize(rt,at,Tt){if(this.width=Math.floor(rt*Tt),this.height=Math.floor(at*Tt),this.pixelRatio=Tt,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const rt of this.style._order)this.style._layers[rt].resize()}setup(){const rt=this.context,at=new Tt.aI;at.emplaceBack(0,0),at.emplaceBack(Tt.Z,0),at.emplaceBack(0,Tt.Z),at.emplaceBack(Tt.Z,Tt.Z),this.tileExtentBuffer=rt.createVertexBuffer(at,Xl.members),this.tileExtentSegments=Tt.aJ.simpleSegment(0,0,4,2);const $t=new Tt.aI;$t.emplaceBack(0,0),$t.emplaceBack(Tt.Z,0),$t.emplaceBack(0,Tt.Z),$t.emplaceBack(Tt.Z,Tt.Z),this.debugBuffer=rt.createVertexBuffer($t,Xl.members),this.debugSegments=Tt.aJ.simpleSegment(0,0,4,5);const qt=new Tt.bY;qt.emplaceBack(0,0,0,0),qt.emplaceBack(Tt.Z,0,Tt.Z,0),qt.emplaceBack(0,Tt.Z,0,Tt.Z),qt.emplaceBack(Tt.Z,Tt.Z,Tt.Z,Tt.Z),this.rasterBoundsBuffer=rt.createVertexBuffer(qt,Ac.members),this.rasterBoundsSegments=Tt.aJ.simpleSegment(0,0,4,2);const Kt=new Tt.aI;Kt.emplaceBack(0,0),Kt.emplaceBack(Tt.Z,0),Kt.emplaceBack(0,Tt.Z),Kt.emplaceBack(Tt.Z,Tt.Z),this.rasterBoundsBufferPosOnly=rt.createVertexBuffer(Kt,Xl.members),this.rasterBoundsSegmentsPosOnly=Tt.aJ.simpleSegment(0,0,4,5);const ge=new Tt.aI;ge.emplaceBack(0,0),ge.emplaceBack(1,0),ge.emplaceBack(0,1),ge.emplaceBack(1,1),this.viewportBuffer=rt.createVertexBuffer(ge,Xl.members),this.viewportSegments=Tt.aJ.simpleSegment(0,0,4,2);const Hr=new Tt.bZ;Hr.emplaceBack(0),Hr.emplaceBack(1),Hr.emplaceBack(3),Hr.emplaceBack(2),Hr.emplaceBack(0),this.tileBorderIndexBuffer=rt.createIndexBuffer(Hr);const wn=new Tt.aK;wn.emplaceBack(1,0,2),wn.emplaceBack(1,2,3),this.quadTriangleIndexBuffer=rt.createIndexBuffer(wn);const es=this.context.gl;this.stencilClearMode=new Vt({func:es.ALWAYS,mask:0},0,255,es.ZERO,es.ZERO,es.ZERO),this.tileExtentMesh=new wt(this.tileExtentBuffer,this.quadTriangleIndexBuffer,this.tileExtentSegments)}clearStencil(){const rt=this.context,at=rt.gl;this.nextStencilID=1,this.currentStencilSource=void 0;const $t=Tt.K();Tt.bQ($t,0,this.width,this.height,0,0,1),Tt.M($t,$t,[at.drawingBufferWidth,at.drawingBufferHeight,0]);const qt={mainMatrix:$t,tileMercatorCoords:[0,0,1,1],clippingPlane:[0,0,0,0],projectionTransition:0,fallbackMatrix:$t};this.useProgram("clippingMask",null,!0).draw(rt,at.TRIANGLES,Ut.disabled,this.stencilClearMode,jt.disabled,Nt.disabled,null,null,qt,"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}_renderTileClippingMasks(rt,at,Tt){if(this.currentStencilSource===rt.source||!rt.isTileClipped()||!at||!at.length)return;this.currentStencilSource=rt.source,this.nextStencilID+at.length>256&&this.clearStencil();const $t=this.context;$t.setColorMode(jt.disabled),$t.setDepthMode(Ut.disabled);const qt={};for(const rt of at)qt[rt.key]=this.nextStencilID++;this._renderTileMasks(qt,at,Tt,!0),this._renderTileMasks(qt,at,Tt,!1),this._tileClippingMaskIDs=qt}_renderTileMasks(rt,at,Tt,$t){const qt=this.context,Kt=qt.gl,ge=this.style.projection,Hr=this.transform,wn=this.useProgram("clippingMask");for(const es of at){const at=rt[es.key],ss=this.style.map.terrain&&this.style.map.terrain.getTerrainData(es),os=ge.getMeshFromTileID(this.context,es.canonical,$t,!0,"stencil"),cs=Hr.getProjectionData({overscaledTileID:es,applyGlobeMatrix:!0,applyTerrainMatrix:!0});wn.draw(qt,Kt.TRIANGLES,Ut.disabled,new Vt({func:Kt.ALWAYS,mask:0},at,255,Kt.KEEP,Kt.KEEP,Kt.REPLACE),jt.disabled,Tt?Nt.disabled:Nt.backCCW,null,ss,cs,"$clipping",os.vertexBuffer,os.indexBuffer,os.segments)}}_renderTilesDepthBuffer(){const rt=this.context,at=rt.gl,Tt=this.style.projection,$t=this.transform,qt=this.useProgram("depth"),Kt=this.getDepthModeFor3D(),ge=xe($t,{tileSize:$t.tileSize});for(const Hr of ge){const ge=this.style.map.terrain&&this.style.map.terrain.getTerrainData(Hr),wn=Tt.getMeshFromTileID(this.context,Hr.canonical,!0,!0,"raster"),es=$t.getProjectionData({overscaledTileID:Hr,applyGlobeMatrix:!0,applyTerrainMatrix:!0});qt.draw(rt,at.TRIANGLES,Kt,Vt.disabled,jt.disabled,Nt.backCCW,null,ge,es,"$clipping",wn.vertexBuffer,wn.indexBuffer,wn.segments)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const rt=this.nextStencilID++,at=this.context.gl;return new Vt({func:at.NOTEQUAL,mask:255},rt,255,at.KEEP,at.KEEP,at.REPLACE)}stencilModeForClipping(rt){const at=this.context.gl;return new Vt({func:at.EQUAL,mask:255},this._tileClippingMaskIDs[rt.key],0,at.KEEP,at.KEEP,at.REPLACE)}getStencilConfigForOverlapAndUpdateStencilID(rt){const at=this.context.gl,Tt=rt.sort(((rt,at)=>at.overscaledZ-rt.overscaledZ)),$t=Tt[Tt.length-1].overscaledZ,qt=Tt[0].overscaledZ-$t+1;if(qt>1){this.currentStencilSource=void 0,this.nextStencilID+qt>256&&this.clearStencil();const rt={};for(let Tt=0;Tt<qt;Tt++)rt[Tt+$t]=new Vt({func:at.GEQUAL,mask:255},Tt+this.nextStencilID,255,at.KEEP,at.KEEP,at.REPLACE);return this.nextStencilID+=qt,[rt,Tt]}return[{[$t]:Vt.disabled},Tt]}stencilConfigForOverlapTwoPass(rt){const at=this.context.gl,Tt=rt.sort(((rt,at)=>at.overscaledZ-rt.overscaledZ)),$t=Tt[Tt.length-1].overscaledZ,qt=Tt[0].overscaledZ-$t+1;if(this.clearStencil(),qt>1){const rt={},Kt={};for(let Tt=0;Tt<qt;Tt++)rt[Tt+$t]=new Vt({func:at.GREATER,mask:255},qt+1+Tt,255,at.KEEP,at.KEEP,at.REPLACE),Kt[Tt+$t]=new Vt({func:at.GREATER,mask:255},1+Tt,255,at.KEEP,at.KEEP,at.REPLACE);return this.nextStencilID=2*qt+1,[rt,Kt,Tt]}return this.nextStencilID=3,[{[$t]:new Vt({func:at.GREATER,mask:255},2,255,at.KEEP,at.KEEP,at.REPLACE)},{[$t]:new Vt({func:at.GREATER,mask:255},1,255,at.KEEP,at.KEEP,at.REPLACE)},Tt]}colorModeForRenderPass(){const rt=this.context.gl;if(this._showOverdrawInspector){const at=1/8;return new jt([rt.CONSTANT_COLOR,rt.ONE],new Tt.b7(at,at,at,0),[!0,!0,!0,!0])}return"opaque"===this.renderPass?jt.unblended:jt.alphaBlended}getDepthModeForSublayer(rt,at,Tt){if(!this.opaquePassEnabledForLayer())return Ut.disabled;const $t=1-((1+this.currentLayer)*this.numSublayers+rt)*this.depthEpsilon;return new Ut(Tt||this.context.gl.LEQUAL,at,[$t,$t])}getDepthModeFor3D(){return new Ut(this.context.gl.LEQUAL,Ut.ReadWrite,this.depthRangeFor3D)}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}render(rt,at){var $t,qt;this.style=rt,this.options=at,this.lineAtlas=rt.lineAtlas,this.imageManager=rt.imageManager,this.glyphManager=rt.glyphManager,this.symbolFadeChange=rt.placement.symbolFadeChange(ge.now()),this.imageManager.beginFrame();const Kt=this.style._order,Hr=this.style.sourceCaches,wn={},es={},ss={},os={isRenderingToTexture:!1,isRenderingGlobe:(null===($t=rt.projection)||void 0===$t?void 0:$t.transitionState)>0};for(const rt in Hr){const at=Hr[rt];at.used&&at.prepare(this.context),wn[rt]=at.getVisibleCoordinates(!1),es[rt]=wn[rt].slice().reverse(),ss[rt]=at.getVisibleCoordinates(!0).reverse()}this.opaquePassCutoff=1/0;for(let rt=0;rt<Kt.length;rt++)if(this.style._layers[Kt[rt]].is3D()){this.opaquePassCutoff=rt;break}this.maybeDrawDepthAndCoords(!1),this.renderToTexture&&(this.renderToTexture.prepareForRender(this.style,this.transform.zoom),this.opaquePassCutoff=0),this.renderPass="offscreen";for(const rt of Kt){const at=this.style._layers[rt];if(!at.hasOffscreenPass()||at.isHidden(this.transform.zoom))continue;const Tt=es[at.source];("custom"===at.type||Tt.length)&&this.renderLayer(this,Hr[at.source],at,Tt,os)}if(null===(qt=this.style.projection)||void 0===qt||qt.updateGPUdependent({context:this.context,useProgram:rt=>this.useProgram(rt)}),this.context.viewport.set([0,0,this.width,this.height]),this.context.bindFramebuffer.set(null),this.context.clear({color:at.showOverdrawInspector?Tt.b7.black:Tt.b7.transparent,depth:1}),this.clearStencil(),this.style.sky&&function(rt,at){const Tt=rt.context,$t=Tt.gl,qt=((rt,at,Tt)=>{const $t=Math.cos(at.rollInRadians),qt=Math.sin(at.rollInRadians),Kt=ue(at),ge=at.getProjectionData({overscaledTileID:null,applyGlobeMatrix:!0,applyTerrainMatrix:!0}).projectionTransition;return{u_sky_color:rt.properties.get("sky-color"),u_horizon_color:rt.properties.get("horizon-color"),u_horizon:[(at.width/2-Kt*qt)*Tt,(at.height/2+Kt*$t)*Tt],u_horizon_normal:[-qt,$t],u_sky_horizon_blend:rt.properties.get("sky-horizon-blend")*at.height/2*Tt,u_sky_blend:ge}})(at,rt.style.map.transform,rt.pixelRatio),Kt=new Ut($t.LEQUAL,Ut.ReadWrite,[0,1]),ge=Vt.disabled,Hr=rt.colorModeForRenderPass(),wn=rt.useProgram("sky"),es=wo(Tt,at);wn.draw(Tt,$t.TRIANGLES,Kt,ge,Hr,Nt.disabled,qt,null,void 0,"sky",es.vertexBuffer,es.indexBuffer,es.segments)}(this,this.style.sky),this._showOverdrawInspector=at.showOverdrawInspector,this.depthRangeFor3D=[0,1-(rt._order.length+2)*this.numSublayers*this.depthEpsilon],!this.renderToTexture)for(this.renderPass="opaque",this.currentLayer=Kt.length-1;this.currentLayer>=0;this.currentLayer--){const rt=this.style._layers[Kt[this.currentLayer]],at=Hr[rt.source],Tt=wn[rt.source];this._renderTileClippingMasks(rt,Tt,!1),this.renderLayer(this,at,rt,Tt,os)}this.renderPass="translucent";let cs=!1;for(this.currentLayer=0;this.currentLayer<Kt.length;this.currentLayer++){const rt=this.style._layers[Kt[this.currentLayer]],at=Hr[rt.source];if(this.renderToTexture&&this.renderToTexture.renderLayer(rt,os))continue;this.opaquePassEnabledForLayer()||cs||(cs=!0,os.isRenderingGlobe&&!this.style.map.terrain&&this._renderTilesDepthBuffer());const Tt=("symbol"===rt.type?ss:es)[rt.source];this._renderTileClippingMasks(rt,wn[rt.source],!1),this.renderLayer(this,at,rt,Tt,os)}if(os.isRenderingGlobe&&function(rt,at,$t){const qt=rt.context,Kt=qt.gl,ge=rt.useProgram("atmosphere"),Hr=new Ut(Kt.LEQUAL,Ut.ReadOnly,[0,1]),wn=rt.transform,es=function(rt,at){const $t=rt.properties.get("position"),qt=[-$t.x,-$t.y,-$t.z],Kt=Tt.ad(new Float64Array(16));return"map"===rt.properties.get("anchor")&&(Tt.a_(Kt,Kt,at.rollInRadians),Tt.a$(Kt,Kt,-at.pitchInRadians),Tt.a_(Kt,Kt,at.bearingInRadians),Tt.a$(Kt,Kt,at.center.lat*Math.PI/180),Tt.bp(Kt,Kt,-at.center.lng*Math.PI/180)),Tt.bX(qt,qt,Kt),qt}($t,rt.transform),ss=wn.getProjectionData({overscaledTileID:null,applyGlobeMatrix:!0,applyTerrainMatrix:!0}),os=at.properties.get("atmosphere-blend")*ss.projectionTransition;if(0===os)return;const cs=ri(wn.worldSize,wn.center.lat),ds=wn.inverseProjectionMatrix,Cs=new Float64Array(4);Cs[3]=1,Tt.at(Cs,Cs,wn.modelViewProjectionMatrix),Cs[0]/=Cs[3],Cs[1]/=Cs[3],Cs[2]/=Cs[3],Cs[3]=1,Tt.at(Cs,Cs,ds),Cs[0]/=Cs[3],Cs[1]/=Cs[3],Cs[2]/=Cs[3],Cs[3]=1;const Vs=((rt,at,Tt,$t,qt)=>({u_sun_pos:rt,u_atmosphere_blend:at,u_globe_position:Tt,u_globe_radius:$t,u_inv_proj_matrix:qt}))(es,os,[Cs[0],Cs[1],Cs[2]],cs,ds),Eo=wo(qt,at);ge.draw(qt,Kt.TRIANGLES,Hr,Vt.disabled,jt.alphaBlended,Nt.disabled,Vs,null,null,"atmosphere",Eo.vertexBuffer,Eo.indexBuffer,Eo.segments)}(this,this.style.sky,this.style.light),this.options.showTileBoundaries){const rt=function(rt,at){let Tt=null;const $t=Object.values(rt._layers).flatMap((Tt=>Tt.source&&!Tt.isHidden(at)?[rt.sourceCaches[Tt.source]]:[])),qt=$t.filter((rt=>"vector"===rt.getSource().type)),Kt=$t.filter((rt=>"vector"!==rt.getSource().type)),s=rt=>{(!Tt||Tt.getSource().maxzoom<rt.getSource().maxzoom)&&(Tt=rt)};return qt.forEach((rt=>s(rt))),Tt||Kt.forEach((rt=>s(rt))),Tt}(this.style,this.transform.zoom);rt&&function(rt,at,Tt){for(let $t=0;$t<Tt.length;$t++)bo(rt,at,Tt[$t])}(this,rt,rt.getVisibleCoordinates())}this.options.showPadding&&function(rt){const at=rt.transform.padding;go(rt,rt.transform.height-(at.top||0),3,Gc),go(rt,at.bottom||0,3,qc),vo(rt,at.left||0,3,Wc),vo(rt,rt.transform.width-(at.right||0),3,Hc);const Tt=rt.transform.centerPoint;!function(rt,at,Tt,$t){xo(rt,at-1,Tt-10,2,20,$t),xo(rt,at-10,Tt-1,20,2,$t)}(rt,Tt.x,rt.transform.height-Tt.y,Yc)}(this),this.context.setDefault()}maybeDrawDepthAndCoords(rt){if(!this.style||!this.style.map||!this.style.map.terrain)return;const at=this.terrainFacilitator.matrix,$t=this.transform.modelViewProjectionMatrix;let qt=this.terrainFacilitator.dirty;qt||(qt=rt?!Tt.b_(at,$t):!Tt.b$(at,$t)),qt||(qt=this.style.map.terrain.sourceCache.anyTilesAfterTime(this.terrainFacilitator.renderTime)),qt&&(Tt.c0(at,$t),this.terrainFacilitator.renderTime=Date.now(),this.terrainFacilitator.dirty=!1,function(rt,at){const $t=rt.context,qt=$t.gl,Kt=rt.transform,ge=jt.unblended,Hr=new Ut(qt.LEQUAL,Ut.ReadWrite,[0,1]),wn=at.sourceCache.getRenderableTiles(),es=rt.useProgram("terrainDepth");$t.bindFramebuffer.set(at.getFramebuffer("depth").framebuffer),$t.viewport.set([0,0,rt.width/devicePixelRatio,rt.height/devicePixelRatio]),$t.clear({color:Tt.b7.transparent,depth:1});for(const rt of wn){const Tt=at.getTerrainMesh(rt.tileID),wn=at.getTerrainData(rt.tileID),ss=Kt.getProjectionData({overscaledTileID:rt.tileID,applyTerrainMatrix:!1,applyGlobeMatrix:!0}),os={u_ele_delta:at.getMeshFrameDelta(Kt.zoom)};es.draw($t,qt.TRIANGLES,Hr,Vt.disabled,ge,Nt.backCCW,os,wn,ss,"terrain",Tt.vertexBuffer,Tt.indexBuffer,Tt.segments)}$t.bindFramebuffer.set(null),$t.viewport.set([0,0,rt.width,rt.height])}(this,this.style.map.terrain),function(rt,at){const $t=rt.context,qt=$t.gl,Kt=rt.transform,ge=jt.unblended,Hr=new Ut(qt.LEQUAL,Ut.ReadWrite,[0,1]),wn=at.getCoordsTexture(),es=at.sourceCache.getRenderableTiles(),ss=rt.useProgram("terrainCoords");$t.bindFramebuffer.set(at.getFramebuffer("coords").framebuffer),$t.viewport.set([0,0,rt.width/devicePixelRatio,rt.height/devicePixelRatio]),$t.clear({color:Tt.b7.transparent,depth:1}),at.coordsIndex=[];for(const rt of es){const Tt=at.getTerrainMesh(rt.tileID),es=at.getTerrainData(rt.tileID);$t.activeTexture.set(qt.TEXTURE0),qt.bindTexture(qt.TEXTURE_2D,wn.texture);const os={u_terrain_coords_id:(255-at.coordsIndex.length)/255,u_texture:0,u_ele_delta:at.getMeshFrameDelta(Kt.zoom)},cs=Kt.getProjectionData({overscaledTileID:rt.tileID,applyTerrainMatrix:!1,applyGlobeMatrix:!0});ss.draw($t,qt.TRIANGLES,Hr,Vt.disabled,ge,Nt.backCCW,os,es,cs,"terrain",Tt.vertexBuffer,Tt.indexBuffer,Tt.segments),at.coordsIndex.push(rt.tileID.key)}$t.bindFramebuffer.set(null),$t.viewport.set([0,0,rt.width,rt.height])}(this,this.style.map.terrain))}renderLayer(rt,at,$t,qt,Kt){$t.isHidden(this.transform.zoom)||("background"===$t.type||"custom"===$t.type||(qt||[]).length)&&(this.id=$t.id,Tt.c1($t)?function(rt,at,$t,qt,Kt,ge){if("translucent"!==rt.renderPass)return;const{isRenderingToTexture:Hr}=ge,wn=Vt.disabled,es=rt.colorModeForRenderPass();($t._unevaluatedLayout.hasValue("text-variable-anchor")||$t._unevaluatedLayout.hasValue("text-variable-anchor-offset"))&&function(rt,at,$t,qt,Kt,ge,Hr,wn,es){const ss=at.transform,os=at.style.map.terrain,cs="map"===Kt,ds="map"===ge;for(const Kt of rt){const rt=qt.getTile(Kt),ge=rt.getBucket($t);if(!ge||!ge.text||!ge.text.segments.get().length)continue;const Cs=Tt.ak(ge.textSizeData,ss.zoom),Vs=Tt.az(rt,1,at.transform.zoom),Eo=Me(cs,at.transform,Vs),Do="none"!==$t.layout.get("icon-text-fit")&&ge.hasIconData();if(Cs){const at=Math.pow(2,ss.zoom-rt.tileID.overscaledZ),$t=os?(rt,at)=>os.getElevation(Kt,rt,at):null;Kr(ge,cs,ds,es,ss,Eo,at,Cs,Do,Tt.aA(ss,rt,Hr,wn),Kt.toUnwrapped(),$t)}}}(qt,rt,$t,at,$t.layout.get("text-rotation-alignment"),$t.layout.get("text-pitch-alignment"),$t.paint.get("text-translate"),$t.paint.get("text-translate-anchor"),Kt),0!==$t.paint.get("icon-opacity").constantOr(1)&&Yr(rt,at,$t,qt,!1,$t.paint.get("icon-translate"),$t.paint.get("icon-translate-anchor"),$t.layout.get("icon-rotation-alignment"),$t.layout.get("icon-pitch-alignment"),$t.layout.get("icon-keep-upright"),wn,es,Hr),0!==$t.paint.get("text-opacity").constantOr(1)&&Yr(rt,at,$t,qt,!0,$t.paint.get("text-translate"),$t.paint.get("text-translate-anchor"),$t.layout.get("text-rotation-alignment"),$t.layout.get("text-pitch-alignment"),$t.layout.get("text-keep-upright"),wn,es,Hr),at.map.showCollisionBoxes&&(Wr(rt,at,$t,qt,!0),Wr(rt,at,$t,qt,!1))}(rt,at,$t,qt,this.style.placement.variableOffsets,Kt):Tt.c2($t)?function(rt,at,$t,qt,Kt){if("translucent"!==rt.renderPass)return;const{isRenderingToTexture:ge}=Kt,Hr=$t.paint.get("circle-opacity"),wn=$t.paint.get("circle-stroke-width"),es=$t.paint.get("circle-stroke-opacity"),ss=!$t.layout.get("circle-sort-key").isConstant();if(0===Hr.constantOr(1)&&(0===wn.constantOr(1)||0===es.constantOr(1)))return;const os=rt.context,cs=os.gl,ds=rt.transform,Cs=rt.getDepthModeForSublayer(0,Ut.ReadOnly),Vs=Vt.disabled,Eo=rt.colorModeForRenderPass(),Do=[],Ho=ds.getCircleRadiusCorrection();for(let Kt=0;Kt<qt.length;Kt++){const Hr=qt[Kt],wn=at.getTile(Hr),es=wn.getBucket($t);if(!es)continue;const os=$t.paint.get("circle-translate"),cs=$t.paint.get("circle-translate-anchor"),Cs=Tt.aA(ds,wn,os,cs),Vs=es.programConfigurations.get($t.id),Eo=rt.useProgram("circle",Vs),Ea=es.layoutVertexBuffer,La=es.indexBuffer,ja=rt.style.map.terrain&&rt.style.map.terrain.getTerrainData(Hr),Va={programConfiguration:Vs,program:Eo,layoutVertexBuffer:Ea,indexBuffer:La,uniformValues:Ai(rt,wn,$t,Cs,Ho),terrainData:ja,projectionData:ds.getProjectionData({overscaledTileID:Hr,applyGlobeMatrix:!ge,applyTerrainMatrix:!0})};if(ss){const rt=es.segments.get();for(const at of rt)Do.push({segments:new Tt.aJ([at]),sortKey:at.sortKey,state:Va})}else Do.push({segments:es.segments,sortKey:0,state:Va})}ss&&Do.sort(((rt,at)=>rt.sortKey-at.sortKey));for(const at of Do){const{programConfiguration:Tt,program:qt,layoutVertexBuffer:Kt,indexBuffer:ge,uniformValues:Hr,terrainData:wn,projectionData:es}=at.state;qt.draw(os,cs.TRIANGLES,Cs,Vs,Eo,Nt.backCCW,Hr,wn,es,$t.id,Kt,ge,at.segments,$t.paint,rt.transform.zoom,Tt)}}(rt,at,$t,qt,Kt):Tt.c3($t)?function(rt,at,$t,qt,Kt){if(0===$t.paint.get("heatmap-opacity"))return;const ge=rt.context,{isRenderingToTexture:Hr,isRenderingGlobe:wn}=Kt;if(rt.style.map.terrain){for(const Tt of qt){const qt=at.getTile(Tt);at.hasRenderableParent(Tt)||("offscreen"===rt.renderPass?eo(rt,qt,$t,Tt,wn):"translucent"===rt.renderPass&&to(rt,$t,Tt,Hr,wn))}ge.viewport.set([0,0,rt.width,rt.height])}else"offscreen"===rt.renderPass?function(rt,at,$t,qt){const Kt=rt.context,ge=Kt.gl,Hr=rt.transform,wn=Vt.disabled,es=new jt([ge.ONE,ge.ONE],Tt.b7.transparent,[!0,!0,!0,!0]);(function(rt,at,$t){const qt=rt.gl;rt.activeTexture.set(qt.TEXTURE1),rt.viewport.set([0,0,at.width/4,at.height/4]);let Kt=$t.heatmapFbos.get(Tt.bU);Kt?(qt.bindTexture(qt.TEXTURE_2D,Kt.colorAttachment.get()),rt.bindFramebuffer.set(Kt.framebuffer)):(Kt=io(rt,at.width/4,at.height/4),$t.heatmapFbos.set(Tt.bU,Kt))})(Kt,rt,$t),Kt.clear({color:Tt.b7.transparent});for(let Tt=0;Tt<qt.length;Tt++){const ss=qt[Tt];if(at.hasRenderableParent(ss))continue;const os=at.getTile(ss),cs=os.getBucket($t);if(!cs)continue;const ds=cs.programConfigurations.get($t.id),Cs=rt.useProgram("heatmap",ds),Vs=Hr.getProjectionData({overscaledTileID:ss,applyGlobeMatrix:!0,applyTerrainMatrix:!1}),Eo=Hr.getCircleRadiusCorrection();Cs.draw(Kt,ge.TRIANGLES,Ut.disabled,wn,es,Nt.backCCW,Bi(os,Hr.zoom,$t.paint.get("heatmap-intensity"),Eo),null,Vs,$t.id,cs.layoutVertexBuffer,cs.indexBuffer,cs.segments,$t.paint,Hr.zoom,ds)}Kt.viewport.set([0,0,rt.width,rt.height])}(rt,at,$t,qt):"translucent"===rt.renderPass&&function(rt,at){const $t=rt.context,qt=$t.gl;$t.setColorMode(rt.colorModeForRenderPass());const Kt=at.heatmapFbos.get(Tt.bU);Kt&&($t.activeTexture.set(qt.TEXTURE0),qt.bindTexture(qt.TEXTURE_2D,Kt.colorAttachment.get()),$t.activeTexture.set(qt.TEXTURE1),ro($t,at).bind(qt.LINEAR,qt.CLAMP_TO_EDGE),rt.useProgram("heatmapTexture").draw($t,qt.TRIANGLES,Ut.disabled,Vt.disabled,rt.colorModeForRenderPass(),Nt.disabled,Oi(rt,at,0,1),null,null,at.id,rt.viewportBuffer,rt.quadTriangleIndexBuffer,rt.viewportSegments,at.paint,rt.transform.zoom))}(rt,$t)}(rt,at,$t,qt,Kt):Tt.c4($t)?function(rt,at,$t,qt,Kt){if("translucent"!==rt.renderPass)return;const{isRenderingToTexture:ge}=Kt,Hr=$t.paint.get("line-opacity"),wn=$t.paint.get("line-width");if(0===Hr.constantOr(1)||0===wn.constantOr(1))return;const es=rt.getDepthModeForSublayer(0,Ut.ReadOnly),ss=rt.colorModeForRenderPass(),os=$t.paint.get("line-dasharray"),cs=$t.paint.get("line-pattern"),ds=cs.constantOr(1),Cs=$t.paint.get("line-gradient"),Vs=$t.getCrossfadeParameters(),Eo=ds?"linePattern":os?"lineSDF":Cs?"lineGradient":"line",Do=rt.context,Ho=Do.gl,Ea=rt.transform;let La=!0;for(const Kt of qt){const Hr=at.getTile(Kt);if(ds&&!Hr.patternsLoaded())continue;const wn=Hr.getBucket($t);if(!wn)continue;const ja=wn.programConfigurations.get($t.id),Va=rt.context.program.get(),Na=rt.useProgram(Eo,ja),qa=La||Na.program!==Va,Qa=rt.style.map.terrain&&rt.style.map.terrain.getTerrainData(Kt),Pl=cs.constantOr(null);if(Pl&&Hr.imageAtlas){const rt=Hr.imageAtlas,at=rt.patternPositions[Pl.to.toString()],Tt=rt.patternPositions[Pl.from.toString()];at&&Tt&&ja.setConstantPatternPositions(at,Tt)}const zl=Ea.getProjectionData({overscaledTileID:Kt,applyGlobeMatrix:!ge,applyTerrainMatrix:!0}),Dl=Ea.getPixelScale(),Ll=ds?Vi(rt,Hr,$t,Dl,Vs):os?qi(rt,Hr,$t,Dl,os,Vs):Cs?Gi(rt,Hr,$t,Dl,wn.lineClipsArray.length):Ui(rt,Hr,$t,Dl);if(ds)Do.activeTexture.set(Ho.TEXTURE0),Hr.imageAtlasTexture.bind(Ho.LINEAR,Ho.CLAMP_TO_EDGE),ja.updatePaintBuffers(Vs);else if(os&&(qa||rt.lineAtlas.dirty))Do.activeTexture.set(Ho.TEXTURE0),rt.lineAtlas.bind(Do);else if(Cs){const qt=wn.gradients[$t.id];let ge=qt.texture;if($t.gradientVersion!==qt.version){let Hr=256;if($t.stepInterpolant){const $t=at.getSource().maxzoom,qt=Kt.canonical.z===$t?Math.ceil(1<<rt.transform.maxZoom-Kt.canonical.z):1;Hr=Tt.ae(Tt.bV(wn.maxLineLength/Tt.Z*1024*qt),256,Do.maxTextureSize)}qt.gradient=Tt.bW({expression:$t.gradientExpression(),evaluationKey:"lineProgress",resolution:Hr,image:qt.gradient||void 0,clips:wn.lineClipsArray}),qt.texture?qt.texture.update(qt.gradient):qt.texture=new v(Do,qt.gradient,Ho.RGBA),qt.version=$t.gradientVersion,ge=qt.texture}Do.activeTexture.set(Ho.TEXTURE0),ge.bind($t.stepInterpolant?Ho.NEAREST:Ho.LINEAR,Ho.CLAMP_TO_EDGE)}let Ol;if(ge){const[at]=rt.getStencilConfigForOverlapAndUpdateStencilID(qt);Ol=at[Kt.overscaledZ]}else Ol=rt.stencilModeForClipping(Kt);Na.draw(Do,Ho.TRIANGLES,es,Ol,ss,Nt.disabled,Ll,Qa,zl,$t.id,wn.layoutVertexBuffer,wn.indexBuffer,wn.segments,$t.paint,rt.transform.zoom,ja,wn.layoutVertexBuffer2),La=!1}}(rt,at,$t,qt,Kt):Tt.c5($t)?function(rt,at,$t,qt,Kt){const ge=$t.paint.get("fill-color"),Hr=$t.paint.get("fill-opacity");if(0===Hr.constantOr(1))return;const{isRenderingToTexture:wn}=Kt,es=rt.colorModeForRenderPass(),ss=$t.paint.get("fill-pattern"),os=rt.opaquePassEnabledForLayer()&&!ss.constantOr(1)&&1===ge.constantOr(Tt.b7.transparent).a&&1===Hr.constantOr(0)?"opaque":"translucent";if(rt.renderPass===os){const Tt=rt.getDepthModeForSublayer(1,"opaque"===rt.renderPass?Ut.ReadWrite:Ut.ReadOnly);ao(rt,at,$t,qt,Tt,es,!1,wn)}if("translucent"===rt.renderPass&&$t.paint.get("fill-antialias")){const Tt=rt.getDepthModeForSublayer($t.getPaintProperty("fill-outline-color")?2:0,Ut.ReadOnly);ao(rt,at,$t,qt,Tt,es,!0,wn)}}(rt,at,$t,qt,Kt):Tt.c6($t)?function(rt,at,Tt,$t,qt){const Kt=Tt.paint.get("fill-extrusion-opacity");if(0===Kt)return;const{isRenderingToTexture:ge}=qt;if("translucent"===rt.renderPass){const qt=new Ut(rt.context.gl.LEQUAL,Ut.ReadWrite,rt.depthRangeFor3D);if(1!==Kt||Tt.paint.get("fill-extrusion-pattern").constantOr(1))so(rt,at,Tt,$t,qt,Vt.disabled,jt.disabled,ge),so(rt,at,Tt,$t,qt,rt.stencilModeFor3D(),rt.colorModeForRenderPass(),ge);else{const Kt=rt.colorModeForRenderPass();so(rt,at,Tt,$t,qt,Vt.disabled,Kt,ge)}}}(rt,at,$t,qt,Kt):Tt.c7($t)?function(rt,at,Tt,$t,qt){if("offscreen"!==rt.renderPass&&"translucent"!==rt.renderPass)return;const{isRenderingToTexture:Kt}=qt,ge=rt.context,Hr=rt.style.projection.useSubdivision,wn=rt.getDepthModeForSublayer(0,Ut.ReadOnly),es=rt.colorModeForRenderPass();if("offscreen"===rt.renderPass)!function(rt,at,Tt,$t,qt,Kt,ge){const Hr=rt.context,wn=Hr.gl;for(const es of Tt){const Tt=at.getTile(es),ss=Tt.dem;if(!ss||!ss.data)continue;if(!Tt.needsHillshadePrepare)continue;const os=ss.dim,cs=ss.stride,ds=ss.getPixels();if(Hr.activeTexture.set(wn.TEXTURE1),Hr.pixelStoreUnpackPremultiplyAlpha.set(!1),Tt.demTexture=Tt.demTexture||rt.getTileTexture(cs),Tt.demTexture){const rt=Tt.demTexture;rt.update(ds,{premultiply:!1}),rt.bind(wn.NEAREST,wn.CLAMP_TO_EDGE)}else Tt.demTexture=new v(Hr,ds,wn.RGBA,{premultiply:!1}),Tt.demTexture.bind(wn.NEAREST,wn.CLAMP_TO_EDGE);Hr.activeTexture.set(wn.TEXTURE0);let Cs=Tt.fbo;if(!Cs){const rt=new v(Hr,{width:os,height:os,data:null},wn.RGBA);rt.bind(wn.LINEAR,wn.CLAMP_TO_EDGE),Cs=Tt.fbo=Hr.createFramebuffer(os,os,!0,!1),Cs.colorAttachment.set(rt.texture)}Hr.bindFramebuffer.set(Cs.framebuffer),Hr.viewport.set([0,0,os,os]),rt.useProgram("hillshadePrepare").draw(Hr,wn.TRIANGLES,qt,Kt,ge,Nt.disabled,Zi(Tt.tileID,ss),null,null,$t.id,rt.rasterBoundsBuffer,rt.quadTriangleIndexBuffer,rt.rasterBoundsSegments),Tt.needsHillshadePrepare=!1}}(rt,at,$t,Tt,wn,Vt.disabled,es),ge.viewport.set([0,0,rt.width,rt.height]);else if("translucent"===rt.renderPass)if(Hr){const[qt,ge,Hr]=rt.stencilConfigForOverlapTwoPass($t);no(rt,at,Tt,Hr,qt,wn,es,!1,Kt),no(rt,at,Tt,Hr,ge,wn,es,!0,Kt)}else{const[qt,ge]=rt.getStencilConfigForOverlapAndUpdateStencilID($t);no(rt,at,Tt,ge,qt,wn,es,!1,Kt)}}(rt,at,$t,qt,Kt):Tt.c8($t)?function(rt,at,Tt,$t,qt){if("translucent"!==rt.renderPass)return;if(0===Tt.paint.get("raster-opacity"))return;if(!$t.length)return;const{isRenderingToTexture:Kt}=qt,ge=at.getSource(),Hr=rt.style.projection.useSubdivision;if(ge instanceof K)co(rt,at,Tt,$t,null,!1,!1,ge.tileCoords,ge.flippedWindingOrder,Kt);else if(Hr){const[qt,ge,Hr]=rt.stencilConfigForOverlapTwoPass($t);co(rt,at,Tt,Hr,qt,!1,!0,$c,!1,Kt),co(rt,at,Tt,Hr,ge,!0,!0,$c,!1,Kt)}else{const[qt,ge]=rt.getStencilConfigForOverlapAndUpdateStencilID($t);co(rt,at,Tt,ge,qt,!1,!0,$c,!1,Kt)}}(rt,at,$t,qt,Kt):Tt.c9($t)?function(rt,at,Tt,$t,qt){const Kt=Tt.paint.get("background-color"),ge=Tt.paint.get("background-opacity");if(0===ge)return;const{isRenderingToTexture:Hr}=qt,wn=rt.context,es=wn.gl,ss=rt.style.projection,os=rt.transform,cs=os.tileSize,ds=Tt.paint.get("background-pattern");if(rt.isPatternMissing(ds))return;const Cs=!ds&&1===Kt.a&&1===ge&&rt.opaquePassEnabledForLayer()?"opaque":"translucent";if(rt.renderPass!==Cs)return;const Vs=Vt.disabled,Eo=rt.getDepthModeForSublayer(0,"opaque"===Cs?Ut.ReadWrite:Ut.ReadOnly),Do=rt.colorModeForRenderPass(),Ho=rt.useProgram(ds?"backgroundPattern":"background"),Ea=$t||xe(os,{tileSize:cs,terrain:rt.style.map.terrain});ds&&(wn.activeTexture.set(es.TEXTURE0),rt.imageManager.bind(rt.context));const La=Tt.getCrossfadeParameters();for(const at of Ea){const $t=os.getProjectionData({overscaledTileID:at,applyGlobeMatrix:!Hr,applyTerrainMatrix:!0}),qt=ds?er(ge,rt,ds,{tileID:at,tileSize:cs},La):Ji(ge,Kt),Cs=rt.style.map.terrain&&rt.style.map.terrain.getTerrainData(at),Ea=ss.getMeshFromTileID(wn,at.canonical,!1,!0,"raster");Ho.draw(wn,es.TRIANGLES,Eo,Vs,Do,Nt.backCCW,qt,Cs,$t,Tt.id,Ea.vertexBuffer,Ea.indexBuffer,Ea.segments)}}(rt,0,$t,qt,Kt):Tt.ca($t)&&function(rt,at,Tt,$t){const{isRenderingGlobe:qt}=$t,Kt=rt.context,ge=Tt.implementation,Hr=rt.style.projection,wn=rt.transform,es=wn.getProjectionDataForCustomLayer(qt),ss={farZ:wn.farZ,nearZ:wn.nearZ,fov:wn.fov*Math.PI/180,modelViewProjectionMatrix:wn.modelViewProjectionMatrix,projectionMatrix:wn.projectionMatrix,shaderData:{variantName:Hr.shaderVariantName,vertexShaderPrelude:`const float PI = 3.141592653589793;\nuniform mat4 u_projection_matrix;\n${Hr.shaderPreludeCode.vertexSource}`,define:Hr.shaderDefine},defaultProjectionData:es},os=ge.renderingMode?ge.renderingMode:"2d";if("offscreen"===rt.renderPass){const at=ge.prerender;at&&(rt.setCustomLayerDefaults(),Kt.setColorMode(rt.colorModeForRenderPass()),at.call(ge,Kt.gl,ss),Kt.setDirty(),rt.setBaseState())}else if("translucent"===rt.renderPass){rt.setCustomLayerDefaults(),Kt.setColorMode(rt.colorModeForRenderPass()),Kt.setStencilMode(Vt.disabled);const at="3d"===os?rt.getDepthModeFor3D():rt.getDepthModeForSublayer(0,Ut.ReadOnly);Kt.setDepthMode(at),ge.render(Kt.gl,ss),Kt.setDirty(),rt.setBaseState(),Kt.bindFramebuffer.set(null)}}(rt,0,$t,Kt))}saveTileTexture(rt){const at=this._tileTextures[rt.size[0]];at?at.push(rt):this._tileTextures[rt.size[0]]=[rt]}getTileTexture(rt){const at=this._tileTextures[rt];return at&&at.length>0?at.pop():null}isPatternMissing(rt){if(!rt)return!1;if(!rt.from||!rt.to)return!0;const at=this.imageManager.getPattern(rt.from.toString()),Tt=this.imageManager.getPattern(rt.to.toString());return!at||!Tt}useProgram(rt,at,Tt=!1){this.cache=this.cache||{};const $t=!!this.style.map.terrain,qt=this.style.projection,Kt=rt+(at?at.cacheKey:"")+`/${Tt?Yl:qt.shaderVariantName}`+(this._showOverdrawInspector?"/overdraw":"")+($t?"/terrain":"");return this.cache[Kt]||(this.cache[Kt]=new Mi(this.context,Hl[rt],at,kc[rt],this._showOverdrawInspector,$t,Tt?Hl.projectionMercator:qt.shaderPreludeCode,Tt?Kl:qt.shaderDefine)),this.cache[Kt]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const rt=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(rt.FUNC_ADD)}initDebugOverlayCanvas(){null==this.debugOverlayCanvas&&(this.debugOverlayCanvas=document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new v(this.context,this.debugOverlayCanvas,this.context.gl.RGBA))}destroy(){this.debugOverlayTexture&&this.debugOverlayTexture.destroy()}overLimit(){const{drawingBufferWidth:rt,drawingBufferHeight:at}=this.context.gl;return this.width!==rt||this.height!==at}}function Po(at,Tt){let $t,qt=!1,Kt=null,ge=null;const s=()=>{Kt=null,qt&&(at.apply(ge,$t),Kt=setTimeout(s,Tt),qt=!1)};return(...at)=>(qt=!0,ge=this||rt,$t=at,Kt||s(),Kt)}class Co{constructor(rt){this._getCurrentHash=()=>{const rt=window.location.hash.replace("#","");if(this._hashName){let at;return rt.split("&").map((rt=>rt.split("="))).forEach((rt=>{rt[0]===this._hashName&&(at=rt)})),(at&&at[1]||"").split("/")}return rt.split("/")},this._onHashChange=()=>{const rt=this._getCurrentHash();if(!this._isValidHash(rt))return!1;const at=this._map.dragRotate.isEnabled()&&this._map.touchZoomRotate.isEnabled()?+(rt[3]||0):this._map.getBearing();return this._map.jumpTo({center:[+rt[2],+rt[1]],zoom:+rt[0],bearing:at,pitch:+(rt[4]||0)}),!0},this._updateHashUnthrottled=()=>{const rt=window.location.href.replace(/(#.*)?$/,this.getHashString());window.history.replaceState(window.history.state,null,rt)},this._removeHash=()=>{const rt=this._getCurrentHash();if(0===rt.length)return;const at=rt.join("/");let Tt=at;Tt.split("&").length>0&&(Tt=Tt.split("&")[0]),this._hashName&&(Tt=`${this._hashName}=${at}`);let $t=window.location.hash.replace(Tt,"");$t.startsWith("#&")?$t=$t.slice(0,1)+$t.slice(2):"#"===$t&&($t="");let qt=window.location.href.replace(/(#.+)?$/,$t);qt=qt.replace("&&","&"),window.history.replaceState(window.history.state,null,qt)},this._updateHash=Po(this._updateHashUnthrottled,300),this._hashName=rt&&encodeURIComponent(rt)}addTo(rt){return this._map=rt,addEventListener("hashchange",this._onHashChange,!1),this._map.on("moveend",this._updateHash),this}remove(){return removeEventListener("hashchange",this._onHashChange,!1),this._map.off("moveend",this._updateHash),clearTimeout(this._updateHash()),this._removeHash(),delete this._map,this}getHashString(rt){const at=this._map.getCenter(),Tt=Math.round(100*this._map.getZoom())/100,$t=Math.ceil((Tt*Math.LN2+Math.log(512/360/.5))/Math.LN10),qt=Math.pow(10,$t),Kt=Math.round(at.lng*qt)/qt,ge=Math.round(at.lat*qt)/qt,Hr=this._map.getBearing(),wn=this._map.getPitch();let es="";if(es+=rt?`/${Kt}/${ge}/${Tt}`:`${Tt}/${ge}/${Kt}`,(Hr||wn)&&(es+="/"+Math.round(10*Hr)/10),wn&&(es+=`/${Math.round(wn)}`),this._hashName){const rt=this._hashName;let at=!1;const Tt=window.location.hash.slice(1).split("&").map((Tt=>{const $t=Tt.split("=")[0];return $t===rt?(at=!0,`${$t}=${es}`):Tt})).filter((rt=>rt));return at||Tt.push(`${rt}=${es}`),`#${Tt.join("&")}`}return`#${es}`}_isValidHash(rt){if(rt.length<3||rt.some(isNaN))return!1;try{new Tt.Q(+rt[2],+rt[1])}catch(rt){return!1}const at=+rt[0],$t=+(rt[3]||0),qt=+(rt[4]||0);return at>=this._map.getMinZoom()&&at<=this._map.getMaxZoom()&&$t>=-180&&$t<=180&&qt>=this._map.getMinPitch()&&qt<=this._map.getMaxPitch()}}const Ih={linearity:.3,easing:Tt.cb(0,0,.3,1)},Dh=Tt.e({deceleration:2500,maxSpeed:1400},Ih),Rh=Tt.e({deceleration:20,maxSpeed:1400},Ih),Oh=Tt.e({deceleration:1e3,maxSpeed:360},Ih),Xh=Tt.e({deceleration:1e3,maxSpeed:90},Ih),eu=Tt.e({deceleration:1e3,maxSpeed:360},Ih);class zo{constructor(rt){this._map=rt,this.clear()}clear(){this._inertiaBuffer=[]}record(rt){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:ge.now(),settings:rt})}_drainInertiaBuffer(){const rt=this._inertiaBuffer,at=ge.now();for(;rt.length>0&&at-rt[0].time>160;)rt.shift()}_onMoveEnd(rt){if(this._drainInertiaBuffer(),this._inertiaBuffer.length<2)return;const at={zoom:0,bearing:0,pitch:0,roll:0,pan:new Tt.P(0,0),pinchAround:void 0,around:void 0};for(const{settings:rt}of this._inertiaBuffer)at.zoom+=rt.zoomDelta||0,at.bearing+=rt.bearingDelta||0,at.pitch+=rt.pitchDelta||0,at.roll+=rt.rollDelta||0,rt.panDelta&&at.pan._add(rt.panDelta),rt.around&&(at.around=rt.around),rt.pinchAround&&(at.pinchAround=rt.pinchAround);const $t=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,qt={};if(at.pan.mag()){const Kt=Lo(at.pan.mag(),$t,Tt.e({},Dh,rt||{})),ge=at.pan.mult(Kt.amount/at.pan.mag()),Hr=this._map.cameraHelper.handlePanInertia(ge,this._map.transform);qt.center=Hr.easingCenter,qt.offset=Hr.easingOffset,Ao(qt,Kt)}if(at.zoom){const rt=Lo(at.zoom,$t,Rh);qt.zoom=this._map.transform.zoom+rt.amount,Ao(qt,rt)}if(at.bearing){const rt=Lo(at.bearing,$t,Oh);qt.bearing=this._map.transform.bearing+Tt.ae(rt.amount,-179,179),Ao(qt,rt)}if(at.pitch){const rt=Lo(at.pitch,$t,Xh);qt.pitch=this._map.transform.pitch+rt.amount,Ao(qt,rt)}if(at.roll){const rt=Lo(at.roll,$t,eu);qt.roll=this._map.transform.roll+Tt.ae(rt.amount,-179,179),Ao(qt,rt)}if(qt.zoom||qt.bearing){const rt=void 0===at.pinchAround?at.around:at.pinchAround;qt.around=rt?this._map.unproject(rt):this._map.getCenter()}return this.clear(),Tt.e(qt,{noMoveStart:!0})}}function Ao(rt,at){(!rt.duration||rt.duration<at.duration)&&(rt.duration=at.duration,rt.easing=at.easing)}function Lo(rt,at,$t){const{maxSpeed:qt,linearity:Kt,deceleration:ge}=$t,Hr=Tt.ae(rt*Kt/(at/1e3),-qt,qt),wn=Math.abs(Hr)/(ge*Kt);return{easing:$t.easing,duration:1e3*wn,amount:Hr*(wn/2)}}class ko extends Tt.l{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(rt,at,$t,qt={}){$t=$t instanceof MouseEvent?$t:new MouseEvent(rt,$t);const Kt=n.mousePos(at.getCanvas(),$t),ge=at.unproject(Kt);super(rt,Tt.e({point:Kt,lngLat:ge,originalEvent:$t},qt)),this._defaultPrevented=!1,this.target=at}}class Fo extends Tt.l{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(rt,at,$t){const qt="touchend"===rt?$t.changedTouches:$t.touches,Kt=n.touchPos(at.getCanvasContainer(),qt),ge=Kt.map((rt=>at.unproject(rt))),Hr=Kt.reduce(((rt,at,Tt,$t)=>rt.add(at.div($t.length))),new Tt.P(0,0));super(rt,{points:Kt,point:Hr,lngLats:ge,lngLat:at.unproject(Hr),originalEvent:$t}),this._defaultPrevented=!1}}class Bo extends Tt.l{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(rt,at,Tt){super(rt,{originalEvent:Tt}),this._defaultPrevented=!1}}class Oo{constructor(rt,at){this._map=rt,this._clickTolerance=at.clickTolerance}reset(){delete this._mousedownPos}wheel(rt){return this._firePreventable(new Bo(rt.type,this._map,rt))}mousedown(rt,at){return this._mousedownPos=at,this._firePreventable(new ko(rt.type,this._map,rt))}mouseup(rt){this._map.fire(new ko(rt.type,this._map,rt))}click(rt,at){this._mousedownPos&&this._mousedownPos.dist(at)>=this._clickTolerance||this._map.fire(new ko(rt.type,this._map,rt))}dblclick(rt){return this._firePreventable(new ko(rt.type,this._map,rt))}mouseover(rt){this._map.fire(new ko(rt.type,this._map,rt))}mouseout(rt){this._map.fire(new ko(rt.type,this._map,rt))}touchstart(rt){return this._firePreventable(new Fo(rt.type,this._map,rt))}touchmove(rt){this._map.fire(new Fo(rt.type,this._map,rt))}touchend(rt){this._map.fire(new Fo(rt.type,this._map,rt))}touchcancel(rt){this._map.fire(new Fo(rt.type,this._map,rt))}_firePreventable(rt){if(this._map.fire(rt),rt.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class jo{constructor(rt){this._map=rt}reset(){this._delayContextMenu=!1,this._ignoreContextMenu=!0,delete this._contextMenuEvent}mousemove(rt){this._map.fire(new ko(rt.type,this._map,rt))}mousedown(){this._delayContextMenu=!0,this._ignoreContextMenu=!1}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new ko("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(rt){this._delayContextMenu?this._contextMenuEvent=rt:this._ignoreContextMenu||this._map.fire(new ko(rt.type,this._map,rt)),this._map.listens("contextmenu")&&rt.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class Zo{constructor(rt){this._map=rt}get transform(){return this._map._requestedCameraState||this._map.transform}get center(){return{lng:this.transform.center.lng,lat:this.transform.center.lat}}get zoom(){return this.transform.zoom}get pitch(){return this.transform.pitch}get bearing(){return this.transform.bearing}unproject(rt){return this.transform.screenPointToLocation(Tt.P.convert(rt),this._map.terrain)}}class No{constructor(rt,at){this._map=rt,this._tr=new Zo(rt),this._el=rt.getCanvasContainer(),this._container=rt.getContainer(),this._clickTolerance=at.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(rt,at){this.isEnabled()&&rt.shiftKey&&0===rt.button&&(n.disableDrag(),this._startPos=this._lastPos=at,this._active=!0)}mousemoveWindow(rt,at){if(!this._active)return;const Tt=at;if(this._lastPos.equals(Tt)||!this._box&&Tt.dist(this._startPos)<this._clickTolerance)return;const $t=this._startPos;this._lastPos=Tt,this._box||(this._box=n.create("div","maplibregl-boxzoom",this._container),this._container.classList.add("maplibregl-crosshair"),this._fireEvent("boxzoomstart",rt));const qt=Math.min($t.x,Tt.x),Kt=Math.max($t.x,Tt.x),ge=Math.min($t.y,Tt.y),Hr=Math.max($t.y,Tt.y);n.setTransform(this._box,`translate(${qt}px,${ge}px)`),this._box.style.width=Kt-qt+"px",this._box.style.height=Hr-ge+"px"}mouseupWindow(rt,at){if(!this._active)return;if(0!==rt.button)return;const $t=this._startPos,qt=at;if(this.reset(),n.suppressClick(),$t.x!==qt.x||$t.y!==qt.y)return this._map.fire(new Tt.l("boxzoomend",{originalEvent:rt})),{cameraAnimation:rt=>rt.fitScreenCoordinates($t,qt,this._tr.bearing,{linear:!0})};this._fireEvent("boxzoomcancel",rt)}keydown(rt){this._active&&27===rt.keyCode&&(this.reset(),this._fireEvent("boxzoomcancel",rt))}reset(){this._active=!1,this._container.classList.remove("maplibregl-crosshair"),this._box&&(n.remove(this._box),this._box=null),n.enableDrag(),delete this._startPos,delete this._lastPos}_fireEvent(rt,at){return this._map.fire(new Tt.l(rt,{originalEvent:at}))}}function Uo(rt,at){if(rt.length!==at.length)throw new Error(`The number of touches and points are not equal - touches ${rt.length}, points ${at.length}`);const Tt={};for(let $t=0;$t<rt.length;$t++)Tt[rt[$t].identifier]=at[$t];return Tt}class Go{constructor(rt){this.reset(),this.numTouches=rt.numTouches}reset(){delete this.centroid,delete this.startTime,delete this.touches,this.aborted=!1}touchstart(rt,at,$t){(this.centroid||$t.length>this.numTouches)&&(this.aborted=!0),this.aborted||(void 0===this.startTime&&(this.startTime=rt.timeStamp),$t.length===this.numTouches&&(this.centroid=function(rt){const at=new Tt.P(0,0);for(const Tt of rt)at._add(Tt);return at.div(rt.length)}(at),this.touches=Uo($t,at)))}touchmove(rt,at,Tt){if(this.aborted||!this.centroid)return;const $t=Uo(Tt,at);for(const rt in this.touches){const at=$t[rt];(!at||at.dist(this.touches[rt])>30)&&(this.aborted=!0)}}touchend(rt,at,Tt){if((!this.centroid||rt.timeStamp-this.startTime>500)&&(this.aborted=!0),0===Tt.length){const rt=!this.aborted&&this.centroid;if(this.reset(),rt)return rt}}}class Vo{constructor(rt){this.singleTap=new Go(rt),this.numTaps=rt.numTaps,this.reset()}reset(){this.lastTime=1/0,delete this.lastTap,this.count=0,this.singleTap.reset()}touchstart(rt,at,Tt){this.singleTap.touchstart(rt,at,Tt)}touchmove(rt,at,Tt){this.singleTap.touchmove(rt,at,Tt)}touchend(rt,at,Tt){const $t=this.singleTap.touchend(rt,at,Tt);if($t){const at=rt.timeStamp-this.lastTime<500,Tt=!this.lastTap||this.lastTap.dist($t)<30;if(at&&Tt||this.reset(),this.count++,this.lastTime=rt.timeStamp,this.lastTap=$t,this.count===this.numTaps)return this.reset(),$t}}}class qo{constructor(rt){this._tr=new Zo(rt),this._zoomIn=new Vo({numTouches:1,numTaps:2}),this._zoomOut=new Vo({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(rt,at,Tt){this._zoomIn.touchstart(rt,at,Tt),this._zoomOut.touchstart(rt,at,Tt)}touchmove(rt,at,Tt){this._zoomIn.touchmove(rt,at,Tt),this._zoomOut.touchmove(rt,at,Tt)}touchend(rt,at,Tt){const $t=this._zoomIn.touchend(rt,at,Tt),qt=this._zoomOut.touchend(rt,at,Tt),Kt=this._tr;return $t?(this._active=!0,rt.preventDefault(),setTimeout((()=>this.reset()),0),{cameraAnimation:at=>at.easeTo({duration:300,zoom:Kt.zoom+1,around:Kt.unproject($t)},{originalEvent:rt})}):qt?(this._active=!0,rt.preventDefault(),setTimeout((()=>this.reset()),0),{cameraAnimation:at=>at.easeTo({duration:300,zoom:Kt.zoom-1,around:Kt.unproject(qt)},{originalEvent:rt})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Wo{constructor(rt){this._enabled=!!rt.enable,this._moveStateManager=rt.moveStateManager,this._clickTolerance=rt.clickTolerance||1,this._moveFunction=rt.move,this._activateOnStart=!!rt.activateOnStart,rt.assignEvents(this),this.reset()}reset(rt){this._active=!1,this._moved=!1,delete this._lastPoint,this._moveStateManager.endMove(rt)}_move(...rt){const at=this._moveFunction(...rt);if(at.bearingDelta||at.pitchDelta||at.rollDelta||at.around||at.panDelta)return this._active=!0,at}dragStart(rt,at){this.isEnabled()&&!this._lastPoint&&this._moveStateManager.isValidStartEvent(rt)&&(this._moveStateManager.startMove(rt),this._lastPoint=Array.isArray(at)?at[0]:at,this._activateOnStart&&this._lastPoint&&(this._active=!0))}dragMove(rt,at){if(!this.isEnabled())return;const Tt=this._lastPoint;if(!Tt)return;if(rt.preventDefault(),!this._moveStateManager.isValidMoveEvent(rt))return void this.reset(rt);const $t=Array.isArray(at)?at[0]:at;return!this._moved&&$t.dist(Tt)<this._clickTolerance?void 0:(this._moved=!0,this._lastPoint=$t,this._move(Tt,$t))}dragEnd(rt){this.isEnabled()&&this._lastPoint&&this._moveStateManager.isValidEndEvent(rt)&&(this._moved&&n.suppressClick(),this.reset(rt))}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}getClickTolerance(){return this._clickTolerance}}const ru={0:1,2:2};class $o{constructor(rt){this._correctEvent=rt.checkCorrectEvent}startMove(rt){const at=n.mouseButton(rt);this._eventButton=at}endMove(rt){delete this._eventButton}isValidStartEvent(rt){return this._correctEvent(rt)}isValidMoveEvent(rt){return!function(rt,at){const Tt=ru[at];return void 0===rt.buttons||(rt.buttons&Tt)!==Tt}(rt,this._eventButton)}isValidEndEvent(rt){return n.mouseButton(rt)===this._eventButton}}class Xo{constructor(){this._firstTouch=void 0}_isOneFingerTouch(rt){return 1===rt.targetTouches.length}_isSameTouchEvent(rt){return rt.targetTouches[0].identifier===this._firstTouch}startMove(rt){this._firstTouch=rt.targetTouches[0].identifier}endMove(rt){delete this._firstTouch}isValidStartEvent(rt){return this._isOneFingerTouch(rt)}isValidMoveEvent(rt){return this._isOneFingerTouch(rt)&&this._isSameTouchEvent(rt)}isValidEndEvent(rt){return this._isOneFingerTouch(rt)&&this._isSameTouchEvent(rt)}}class Ko{constructor(rt=new $o({checkCorrectEvent:()=>!0}),at=new Xo){this.mouseMoveStateManager=rt,this.oneFingerTouchMoveStateManager=at}_executeRelevantHandler(rt,at,Tt){return rt instanceof MouseEvent?at(rt):"undefined"!=typeof TouchEvent&&rt instanceof TouchEvent?Tt(rt):void 0}startMove(rt){this._executeRelevantHandler(rt,(rt=>this.mouseMoveStateManager.startMove(rt)),(rt=>this.oneFingerTouchMoveStateManager.startMove(rt)))}endMove(rt){this._executeRelevantHandler(rt,(rt=>this.mouseMoveStateManager.endMove(rt)),(rt=>this.oneFingerTouchMoveStateManager.endMove(rt)))}isValidStartEvent(rt){return this._executeRelevantHandler(rt,(rt=>this.mouseMoveStateManager.isValidStartEvent(rt)),(rt=>this.oneFingerTouchMoveStateManager.isValidStartEvent(rt)))}isValidMoveEvent(rt){return this._executeRelevantHandler(rt,(rt=>this.mouseMoveStateManager.isValidMoveEvent(rt)),(rt=>this.oneFingerTouchMoveStateManager.isValidMoveEvent(rt)))}isValidEndEvent(rt){return this._executeRelevantHandler(rt,(rt=>this.mouseMoveStateManager.isValidEndEvent(rt)),(rt=>this.oneFingerTouchMoveStateManager.isValidEndEvent(rt)))}}const Qo=rt=>{rt.mousedown=rt.dragStart,rt.mousemoveWindow=rt.dragMove,rt.mouseup=rt.dragEnd,rt.contextmenu=rt=>{rt.preventDefault()}};class Yo{constructor(rt,at){this._clickTolerance=rt.clickTolerance||1,this._map=at,this.reset()}reset(){this._active=!1,this._touches={},this._sum=new Tt.P(0,0)}_shouldBePrevented(rt){return rt<(this._map.cooperativeGestures.isEnabled()?2:1)}touchstart(rt,at,Tt){return this._calculateTransform(rt,at,Tt)}touchmove(rt,at,Tt){if(this._active){if(!this._shouldBePrevented(Tt.length))return rt.preventDefault(),this._calculateTransform(rt,at,Tt);this._map.cooperativeGestures.notifyGestureBlocked("touch_pan",rt)}}touchend(rt,at,Tt){this._calculateTransform(rt,at,Tt),this._active&&this._shouldBePrevented(Tt.length)&&this.reset()}touchcancel(){this.reset()}_calculateTransform(rt,at,$t){$t.length>0&&(this._active=!0);const qt=Uo($t,at),Kt=new Tt.P(0,0),ge=new Tt.P(0,0);let Hr=0;for(const rt in qt){const at=qt[rt],Tt=this._touches[rt];Tt&&(Kt._add(at),ge._add(at.sub(Tt)),Hr++,qt[rt]=at)}if(this._touches=qt,this._shouldBePrevented(Hr)||!ge.mag())return;const wn=ge.div(Hr);return this._sum._add(wn),this._sum.mag()<this._clickTolerance?void 0:{around:Kt.div(Hr),panDelta:wn}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Jo{constructor(){this.reset()}reset(){this._active=!1,delete this._firstTwoTouches}touchstart(rt,at,Tt){this._firstTwoTouches||Tt.length<2||(this._firstTwoTouches=[Tt[0].identifier,Tt[1].identifier],this._start([at[0],at[1]]))}touchmove(rt,at,Tt){if(!this._firstTwoTouches)return;rt.preventDefault();const[$t,qt]=this._firstTwoTouches,Kt=ea(Tt,at,$t),ge=ea(Tt,at,qt);if(!Kt||!ge)return;const Hr=this._aroundCenter?null:Kt.add(ge).div(2);return this._move([Kt,ge],Hr,rt)}touchend(rt,at,Tt){if(!this._firstTwoTouches)return;const[$t,qt]=this._firstTwoTouches,Kt=ea(Tt,at,$t),ge=ea(Tt,at,qt);Kt&&ge||(this._active&&n.suppressClick(),this.reset())}touchcancel(){this.reset()}enable(rt){this._enabled=!0,this._aroundCenter=!!rt&&"center"===rt.around}disable(){this._enabled=!1,this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}}function ea(rt,at,Tt){for(let $t=0;$t<rt.length;$t++)if(rt[$t].identifier===Tt)return at[$t]}function ta(rt,at){return Math.log(rt/at)/Math.LN2}class ia extends Jo{reset(){super.reset(),delete this._distance,delete this._startDistance}_start(rt){this._startDistance=this._distance=rt[0].dist(rt[1])}_move(rt,at){const Tt=this._distance;if(this._distance=rt[0].dist(rt[1]),this._active||!(Math.abs(ta(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:ta(this._distance,Tt),pinchAround:at}}}function ra(rt,at){return 180*rt.angleWith(at)/Math.PI}class oa extends Jo{reset(){super.reset(),delete this._minDiameter,delete this._startVector,delete this._vector}_start(rt){this._startVector=this._vector=rt[0].sub(rt[1]),this._minDiameter=rt[0].dist(rt[1])}_move(rt,at,Tt){const $t=this._vector;if(this._vector=rt[0].sub(rt[1]),this._active||!this._isBelowThreshold(this._vector))return this._active=!0,{bearingDelta:ra(this._vector,$t),pinchAround:at}}_isBelowThreshold(rt){this._minDiameter=Math.min(this._minDiameter,rt.mag());const at=25/(Math.PI*this._minDiameter)*360,Tt=ra(rt,this._startVector);return Math.abs(Tt)<at}}function aa(rt){return Math.abs(rt.y)>Math.abs(rt.x)}class sa extends Jo{constructor(rt){super(),this._currentTouchCount=0,this._map=rt}reset(){super.reset(),this._valid=void 0,delete this._firstMove,delete this._lastPoints}touchstart(rt,at,Tt){super.touchstart(rt,at,Tt),this._currentTouchCount=Tt.length}_start(rt){this._lastPoints=rt,aa(rt[0].sub(rt[1]))&&(this._valid=!1)}_move(rt,at,Tt){if(this._map.cooperativeGestures.isEnabled()&&this._currentTouchCount<3)return;const $t=rt[0].sub(this._lastPoints[0]),qt=rt[1].sub(this._lastPoints[1]);return this._valid=this.gestureBeginsVertically($t,qt,Tt.timeStamp),this._valid?(this._lastPoints=rt,this._active=!0,{pitchDelta:($t.y+qt.y)/2*-.5}):void 0}gestureBeginsVertically(rt,at,Tt){if(void 0!==this._valid)return this._valid;const $t=rt.mag()>=2,qt=at.mag()>=2;if(!$t&&!qt)return;if(!$t||!qt)return void 0===this._firstMove&&(this._firstMove=Tt),Tt-this._firstMove<100&&void 0;const Kt=rt.y>0==at.y>0;return aa(rt)&&aa(at)&&Kt}}const nu={panStep:100,bearingStep:15,pitchStep:10};class la{constructor(rt){this._tr=new Zo(rt);const at=nu;this._panStep=at.panStep,this._bearingStep=at.bearingStep,this._pitchStep=at.pitchStep,this._rotationDisabled=!1}reset(){this._active=!1}keydown(rt){if(rt.altKey||rt.ctrlKey||rt.metaKey)return;let at=0,Tt=0,$t=0,qt=0,Kt=0;switch(rt.keyCode){case 61:case 107:case 171:case 187:at=1;break;case 189:case 109:case 173:at=-1;break;case 37:rt.shiftKey?Tt=-1:(rt.preventDefault(),qt=-1);break;case 39:rt.shiftKey?Tt=1:(rt.preventDefault(),qt=1);break;case 38:rt.shiftKey?$t=1:(rt.preventDefault(),Kt=-1);break;case 40:rt.shiftKey?$t=-1:(rt.preventDefault(),Kt=1);break;default:return}return this._rotationDisabled&&(Tt=0,$t=0),{cameraAnimation:ge=>{const Hr=this._tr;ge.easeTo({duration:300,easeId:"keyboardHandler",easing:ca,zoom:at?Math.round(Hr.zoom)+at*(rt.shiftKey?2:1):Hr.zoom,bearing:Hr.bearing+Tt*this._bearingStep,pitch:Hr.pitch+$t*this._pitchStep,offset:[-qt*this._panStep,-Kt*this._panStep],center:Hr.center},{originalEvent:rt})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function ca(rt){return rt*(2-rt)}const cu=4.000244140625;class ua{constructor(rt,at){this._onTimeout=rt=>{this._type="wheel",this._delta-=this._lastValue,this._active||this._start(rt)},this._map=rt,this._tr=new Zo(rt),this._triggerRenderFrame=at,this._delta=0,this._defaultZoomRate=.01,this._wheelZoomRate=.0022222222222222222}setZoomRate(rt){this._defaultZoomRate=rt}setWheelZoomRate(rt){this._wheelZoomRate=rt}isEnabled(){return!!this._enabled}isActive(){return!!this._active||void 0!==this._finishTimeout}isZooming(){return!!this._zooming}enable(rt){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!rt&&"center"===rt.around)}disable(){this.isEnabled()&&(this._enabled=!1)}_shouldBePrevented(rt){return!!this._map.cooperativeGestures.isEnabled()&&!(rt.ctrlKey||this._map.cooperativeGestures.isBypassed(rt))}wheel(rt){if(!this.isEnabled())return;if(this._shouldBePrevented(rt))return void this._map.cooperativeGestures.notifyGestureBlocked("wheel_zoom",rt);let at=rt.deltaMode===WheelEvent.DOM_DELTA_LINE?40*rt.deltaY:rt.deltaY;const Tt=ge.now(),$t=Tt-(this._lastWheelEventTime||0);this._lastWheelEventTime=Tt,0!==at&&at%cu==0?this._type="wheel":0!==at&&Math.abs(at)<4?this._type="trackpad":$t>400?(this._type=null,this._lastValue=at,this._timeout=setTimeout(this._onTimeout,40,rt)):this._type||(this._type=Math.abs($t*at)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,at+=this._lastValue)),rt.shiftKey&&at&&(at/=4),this._type&&(this._lastWheelEvent=rt,this._delta-=at,this._active||this._start(rt)),rt.preventDefault()}_start(rt){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const at=n.mousePos(this._map.getCanvas(),rt),$t=this._tr;this._aroundPoint=this._aroundCenter?$t.transform.locationToScreenPoint(Tt.Q.convert($t.center)):at,this._frameId||(this._frameId=!0,this._triggerRenderFrame())}renderFrame(){if(!this._frameId)return;if(this._frameId=null,!this.isActive())return;const rt=this._tr.transform;if("number"==typeof this._lastExpectedZoom){const at=rt.zoom-this._lastExpectedZoom;"number"==typeof this._startZoom&&(this._startZoom+=at),"number"==typeof this._targetZoom&&(this._targetZoom+=at)}if(0!==this._delta){const at="wheel"===this._type&&Math.abs(this._delta)>cu?this._wheelZoomRate:this._defaultZoomRate;let $t=2/(1+Math.exp(-Math.abs(this._delta*at)));this._delta<0&&0!==$t&&($t=1/$t);const qt="number"!=typeof this._targetZoom?rt.scale:Tt.ac(this._targetZoom);this._targetZoom=Math.min(rt.maxZoom,Math.max(rt.minZoom,Tt.ah(qt*$t))),"wheel"===this._type&&(this._startZoom=rt.zoom,this._easing=this._smoothOutEasing(200)),this._delta=0}const at="number"!=typeof this._targetZoom?rt.zoom:this._targetZoom,$t=this._startZoom,qt=this._easing;let Kt,Hr=!1;if("wheel"===this._type&&$t&&qt){const rt=ge.now()-this._lastWheelEventTime,wn=Math.min((rt+5)/200,1),es=qt(wn);Kt=Tt.B.number($t,at,es),wn<1?this._frameId||(this._frameId=!0):Hr=!0}else Kt=at,Hr=!0;return this._active=!0,Hr&&(this._active=!1,this._finishTimeout=setTimeout((()=>{this._zooming=!1,this._triggerRenderFrame(),delete this._targetZoom,delete this._lastExpectedZoom,delete this._finishTimeout}),200)),this._lastExpectedZoom=Kt,{noInertia:!0,needsRenderFrame:!Hr,zoomDelta:Kt-rt.zoom,around:this._aroundPoint,originalEvent:this._lastWheelEvent}}_smoothOutEasing(rt){let at=Tt.cd;if(this._prevEase){const rt=this._prevEase,$t=(ge.now()-rt.start)/rt.duration,qt=rt.easing($t+.01)-rt.easing($t),Kt=.27/Math.sqrt(qt*qt+1e-4)*.01,Hr=Math.sqrt(.0729-Kt*Kt);at=Tt.cb(Kt,Hr,.25,1)}return this._prevEase={start:ge.now(),duration:rt,easing:at},at}reset(){this._active=!1,this._zooming=!1,delete this._targetZoom,delete this._lastExpectedZoom,this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout)}}class da{constructor(rt,at){this._clickZoom=rt,this._tapZoom=at}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class _a{constructor(rt){this._tr=new Zo(rt),this.reset()}reset(){this._active=!1}dblclick(rt,at){return rt.preventDefault(),{cameraAnimation:Tt=>{Tt.easeTo({duration:300,zoom:this._tr.zoom+(rt.shiftKey?-1:1),around:this._tr.unproject(at)},{originalEvent:rt})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class pa{constructor(){this._tap=new Vo({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,delete this._swipePoint,delete this._swipeTouch,delete this._tapTime,delete this._tapPoint,this._tap.reset()}touchstart(rt,at,Tt){if(!this._swipePoint)if(this._tapTime){const $t=at[0],qt=rt.timeStamp-this._tapTime<500,Kt=this._tapPoint.dist($t)<30;qt&&Kt?Tt.length>0&&(this._swipePoint=$t,this._swipeTouch=Tt[0].identifier):this.reset()}else this._tap.touchstart(rt,at,Tt)}touchmove(rt,at,Tt){if(this._tapTime){if(this._swipePoint){if(Tt[0].identifier!==this._swipeTouch)return;const $t=at[0],qt=$t.y-this._swipePoint.y;return this._swipePoint=$t,rt.preventDefault(),this._active=!0,{zoomDelta:qt/128}}}else this._tap.touchmove(rt,at,Tt)}touchend(rt,at,Tt){if(this._tapTime)this._swipePoint&&0===Tt.length&&this.reset();else{const $t=this._tap.touchend(rt,at,Tt);$t&&(this._tapTime=rt.timeStamp,this._tapPoint=$t)}}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class ma{constructor(rt,at,Tt){this._el=rt,this._mousePan=at,this._touchPan=Tt}enable(rt){this._inertiaOptions=rt||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("maplibregl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("maplibregl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class fa{constructor(rt,at,Tt,$t){this._pitchWithRotate=rt.pitchWithRotate,this._rollEnabled=rt.rollEnabled,this._mouseRotate=at,this._mousePitch=Tt,this._mouseRoll=$t}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable(),this._rollEnabled&&this._mouseRoll.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable(),this._mouseRoll.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())&&(!this._rollEnabled||this._mouseRoll.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()||this._mouseRoll.isActive()}}class ga{constructor(rt,at,Tt,$t){this._el=rt,this._touchZoom=at,this._touchRotate=Tt,this._tapDragZoom=$t,this._rotationDisabled=!1,this._enabled=!0}enable(rt){this._touchZoom.enable(rt),this._rotationDisabled||this._touchRotate.enable(rt),this._tapDragZoom.enable(),this._el.classList.add("maplibregl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("maplibregl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}class va{constructor(rt,at){this._bypassKey=-1!==navigator.userAgent.indexOf("Mac")?"metaKey":"ctrlKey",this._map=rt,this._options=at,this._enabled=!1}isActive(){return!1}reset(){}_setupUI(){if(this._container)return;const rt=this._map.getCanvasContainer();rt.classList.add("maplibregl-cooperative-gestures"),this._container=n.create("div","maplibregl-cooperative-gesture-screen",rt);let at=this._map._getUIString("CooperativeGesturesHandler.WindowsHelpText");"metaKey"===this._bypassKey&&(at=this._map._getUIString("CooperativeGesturesHandler.MacHelpText"));const Tt=this._map._getUIString("CooperativeGesturesHandler.MobileHelpText"),$t=document.createElement("div");$t.className="maplibregl-desktop-message",$t.textContent=at,this._container.appendChild($t);const qt=document.createElement("div");qt.className="maplibregl-mobile-message",qt.textContent=Tt,this._container.appendChild(qt),this._container.setAttribute("aria-hidden","true")}_destroyUI(){this._container&&(n.remove(this._container),this._map.getCanvasContainer().classList.remove("maplibregl-cooperative-gestures")),delete this._container}enable(){this._setupUI(),this._enabled=!0}disable(){this._enabled=!1,this._destroyUI()}isEnabled(){return this._enabled}isBypassed(rt){return rt[this._bypassKey]}notifyGestureBlocked(rt,at){this._enabled&&(this._map.fire(new Tt.l("cooperativegestureprevented",{gestureType:rt,originalEvent:at})),this._container.classList.add("maplibregl-show"),setTimeout((()=>{this._container.classList.remove("maplibregl-show")}),100))}}const xa=rt=>rt.zoom||rt.drag||rt.roll||rt.pitch||rt.rotate;class ba extends Tt.l{}function ya(rt){return rt.panDelta&&rt.panDelta.mag()||rt.zoomDelta||rt.bearingDelta||rt.pitchDelta||rt.rollDelta}class wa{constructor(rt,at){this.handleWindowEvent=rt=>{this.handleEvent(rt,`${rt.type}Window`)},this.handleEvent=(rt,at)=>{if("blur"===rt.type)return void this.stop(!0);this._updatingCamera=!0;const $t="renderFrame"===rt.type?void 0:rt,qt={needsRenderFrame:!1},Kt={},ge={};for(const{handlerName:Hr,handler:wn,allowed:es}of this._handlers){if(!wn.isEnabled())continue;let ss;if(this._blockedByActive(ge,es,Hr))wn.reset();else if(wn[at||rt.type]){if(Tt.ce(rt,at||rt.type)){const Tt=n.mousePos(this._map.getCanvas(),rt);ss=wn[at||rt.type](rt,Tt)}else if(Tt.cf(rt,at||rt.type)){const Tt=this._getMapTouches(rt.touches),$t=n.touchPos(this._map.getCanvas(),Tt);ss=wn[at||rt.type](rt,$t,Tt)}else Tt.cg(at||rt.type)||(ss=wn[at||rt.type](rt));this.mergeHandlerResult(qt,Kt,ss,Hr,$t),ss&&ss.needsRenderFrame&&this._triggerRenderFrame()}(ss||wn.isActive())&&(ge[Hr]=wn)}const Hr={};for(const rt in this._previousActiveHandlers)ge[rt]||(Hr[rt]=$t);this._previousActiveHandlers=ge,(Object.keys(Hr).length||ya(qt))&&(this._changes.push([qt,Kt,Hr]),this._triggerRenderFrame()),(Object.keys(ge).length||ya(qt))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:wn}=qt;wn&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],wn(this._map))},this._map=rt,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new zo(rt),this._bearingSnap=at.bearingSnap,this._previousActiveHandlers={},this._eventsInProgress={},this._addDefaultHandlers(at);const $t=this._el;this._listeners=[[$t,"touchstart",{passive:!0}],[$t,"touchmove",{passive:!1}],[$t,"touchend",void 0],[$t,"touchcancel",void 0],[$t,"mousedown",void 0],[$t,"mousemove",void 0],[$t,"mouseup",void 0],[document,"mousemove",{capture:!0}],[document,"mouseup",void 0],[$t,"mouseover",void 0],[$t,"mouseout",void 0],[$t,"dblclick",void 0],[$t,"click",void 0],[$t,"keydown",{capture:!1}],[$t,"keyup",void 0],[$t,"wheel",{passive:!1}],[$t,"contextmenu",void 0],[window,"blur",void 0]];for(const[rt,at,Tt]of this._listeners)n.addEventListener(rt,at,rt===document?this.handleWindowEvent:this.handleEvent,Tt)}destroy(){for(const[rt,at,Tt]of this._listeners)n.removeEventListener(rt,at,rt===document?this.handleWindowEvent:this.handleEvent,Tt)}_addDefaultHandlers(rt){const at=this._map,$t=at.getCanvasContainer();this._add("mapEvent",new Oo(at,rt));const qt=at.boxZoom=new No(at,rt);this._add("boxZoom",qt),rt.interactive&&rt.boxZoom&&qt.enable();const Kt=at.cooperativeGestures=new va(at,rt.cooperativeGestures);this._add("cooperativeGestures",Kt),rt.cooperativeGestures&&Kt.enable();const ge=new qo(at),Hr=new _a(at);at.doubleClickZoom=new da(Hr,ge),this._add("tapZoom",ge),this._add("clickZoom",Hr),rt.interactive&&rt.doubleClickZoom&&at.doubleClickZoom.enable();const wn=new pa;this._add("tapDragZoom",wn);const es=at.touchPitch=new sa(at);this._add("touchPitch",es),rt.interactive&&rt.touchPitch&&at.touchPitch.enable(rt.touchPitch);const u=()=>at.project(at.getCenter()),ss=function({enable:rt,clickTolerance:at,aroundCenter:$t=!0,minPixelCenterThreshold:qt=100,rotateDegreesPerPixelMoved:Kt=.8},ge){const Hr=new $o({checkCorrectEvent:rt=>0===n.mouseButton(rt)&&rt.ctrlKey||2===n.mouseButton(rt)&&!rt.ctrlKey});return new Wo({clickTolerance:at,move:(rt,at)=>{const Hr=ge();if($t&&Math.abs(Hr.y-rt.y)>qt)return{bearingDelta:Tt.cc(new Tt.P(rt.x,at.y),at,Hr)};let wn=(at.x-rt.x)*Kt;return $t&&at.y<Hr.y&&(wn=-wn),{bearingDelta:wn}},moveStateManager:Hr,enable:rt,assignEvents:Qo})}(rt,u),os=function({enable:rt,clickTolerance:at,pitchDegreesPerPixelMoved:Tt=-.5}){const $t=new $o({checkCorrectEvent:rt=>0===n.mouseButton(rt)&&rt.ctrlKey||2===n.mouseButton(rt)});return new Wo({clickTolerance:at,move:(rt,at)=>({pitchDelta:(at.y-rt.y)*Tt}),moveStateManager:$t,enable:rt,assignEvents:Qo})}(rt),cs=function({enable:rt,clickTolerance:at,rollDegreesPerPixelMoved:Tt=.3},$t){const qt=new $o({checkCorrectEvent:rt=>2===n.mouseButton(rt)&&rt.ctrlKey});return new Wo({clickTolerance:at,move:(rt,at)=>{const qt=$t();let Kt=(at.x-rt.x)*Tt;return at.y<qt.y&&(Kt=-Kt),{rollDelta:Kt}},moveStateManager:qt,enable:rt,assignEvents:Qo})}(rt,u);at.dragRotate=new fa(rt,ss,os,cs),this._add("mouseRotate",ss,["mousePitch"]),this._add("mousePitch",os,["mouseRotate","mouseRoll"]),this._add("mouseRoll",cs,["mousePitch"]),rt.interactive&&rt.dragRotate&&at.dragRotate.enable();const ds=function({enable:rt,clickTolerance:at}){const Tt=new $o({checkCorrectEvent:rt=>0===n.mouseButton(rt)&&!rt.ctrlKey});return new Wo({clickTolerance:at,move:(rt,at)=>({around:at,panDelta:at.sub(rt)}),activateOnStart:!0,moveStateManager:Tt,enable:rt,assignEvents:Qo})}(rt),Cs=new Yo(rt,at);at.dragPan=new ma($t,ds,Cs),this._add("mousePan",ds),this._add("touchPan",Cs,["touchZoom","touchRotate"]),rt.interactive&&rt.dragPan&&at.dragPan.enable(rt.dragPan);const Vs=new oa,Eo=new ia;at.touchZoomRotate=new ga($t,Eo,Vs,wn),this._add("touchRotate",Vs,["touchPan","touchZoom"]),this._add("touchZoom",Eo,["touchPan","touchRotate"]),rt.interactive&&rt.touchZoomRotate&&at.touchZoomRotate.enable(rt.touchZoomRotate);const Do=at.scrollZoom=new ua(at,(()=>this._triggerRenderFrame()));this._add("scrollZoom",Do,["mousePan"]),rt.interactive&&rt.scrollZoom&&at.scrollZoom.enable(rt.scrollZoom);const Ho=at.keyboard=new la(at);this._add("keyboard",Ho),rt.interactive&&rt.keyboard&&at.keyboard.enable(),this._add("blockableMapEvent",new jo(at))}_add(rt,at,Tt){this._handlers.push({handlerName:rt,handler:at,allowed:Tt}),this._handlersById[rt]=at}stop(rt){if(!this._updatingCamera){for(const{handler:rt}of this._handlers)rt.reset();this._inertia.clear(),this._fireEvents({},{},rt),this._changes=[]}}isActive(){for(const{handler:rt}of this._handlers)if(rt.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return Boolean(xa(this._eventsInProgress))||this.isZooming()}_blockedByActive(rt,at,Tt){for(const $t in rt)if($t!==Tt&&(!at||at.indexOf($t)<0))return!0;return!1}_getMapTouches(rt){const at=[];for(const Tt of rt)this._el.contains(Tt.target)&&at.push(Tt);return at}mergeHandlerResult(rt,at,$t,qt,Kt){if(!$t)return;Tt.e(rt,$t);const ge={handlerName:qt,originalEvent:$t.originalEvent||Kt};void 0!==$t.zoomDelta&&(at.zoom=ge),void 0!==$t.panDelta&&(at.drag=ge),void 0!==$t.rollDelta&&(at.roll=ge),void 0!==$t.pitchDelta&&(at.pitch=ge),void 0!==$t.bearingDelta&&(at.rotate=ge)}_applyChanges(){const rt={},at={},$t={};for(const[qt,Kt,ge]of this._changes)qt.panDelta&&(rt.panDelta=(rt.panDelta||new Tt.P(0,0))._add(qt.panDelta)),qt.zoomDelta&&(rt.zoomDelta=(rt.zoomDelta||0)+qt.zoomDelta),qt.bearingDelta&&(rt.bearingDelta=(rt.bearingDelta||0)+qt.bearingDelta),qt.pitchDelta&&(rt.pitchDelta=(rt.pitchDelta||0)+qt.pitchDelta),qt.rollDelta&&(rt.rollDelta=(rt.rollDelta||0)+qt.rollDelta),void 0!==qt.around&&(rt.around=qt.around),void 0!==qt.pinchAround&&(rt.pinchAround=qt.pinchAround),qt.noInertia&&(rt.noInertia=qt.noInertia),Tt.e(at,Kt),Tt.e($t,ge);this._updateMapTransform(rt,at,$t),this._changes=[]}_updateMapTransform(rt,at,Tt){const $t=this._map,qt=$t._getTransformForUpdate(),Kt=$t.terrain;if(!(ya(rt)||Kt&&this._terrainMovement))return this._fireEvents(at,Tt,!0);$t._stop(!0);let{panDelta:ge,zoomDelta:Hr,bearingDelta:wn,pitchDelta:es,rollDelta:ss,around:os,pinchAround:cs}=rt;void 0!==cs&&(os=cs),os=os||$t.transform.centerPoint,Kt&&!qt.isPointOnMapSurface(os)&&(os=qt.centerPoint);const ds={panDelta:ge,zoomDelta:Hr,rollDelta:ss,pitchDelta:es,bearingDelta:wn,around:os};this._map.cameraHelper.useGlobeControls&&!qt.isPointOnMapSurface(os)&&(os=qt.centerPoint);const Cs=os.distSqr(qt.centerPoint)<.01?qt.center:qt.screenPointToLocation(ge?os.sub(ge):os);Kt?(this._map.cameraHelper.handleMapControlsRollPitchBearingZoom(ds,qt),this._terrainMovement||!at.drag&&!at.zoom?at.drag&&this._terrainMovement?qt.setCenter(qt.screenPointToLocation(qt.centerPoint.sub(ge))):this._map.cameraHelper.handleMapControlsPan(ds,qt,Cs):(this._terrainMovement=!0,this._map._elevationFreeze=!0,this._map.cameraHelper.handleMapControlsPan(ds,qt,Cs))):(this._map.cameraHelper.handleMapControlsRollPitchBearingZoom(ds,qt),this._map.cameraHelper.handleMapControlsPan(ds,qt,Cs)),$t._applyUpdatedTransform(qt),this._map._update(),rt.noInertia||this._inertia.record(rt),this._fireEvents(at,Tt,!0)}_fireEvents(rt,at,$t){const qt=xa(this._eventsInProgress),Kt=xa(rt),Hr={};for(const at in rt){const{originalEvent:Tt}=rt[at];this._eventsInProgress[at]||(Hr[`${at}start`]=Tt),this._eventsInProgress[at]=rt[at]}!qt&&Kt&&this._fireEvent("movestart",Kt.originalEvent);for(const rt in Hr)this._fireEvent(rt,Hr[rt]);Kt&&this._fireEvent("move",Kt.originalEvent);for(const at in rt){const{originalEvent:Tt}=rt[at];this._fireEvent(at,Tt)}const wn={};let es;for(const rt in this._eventsInProgress){const{handlerName:Tt,originalEvent:$t}=this._eventsInProgress[rt];this._handlersById[Tt].isActive()||(delete this._eventsInProgress[rt],es=at[Tt]||$t,wn[`${rt}end`]=es)}for(const rt in wn)this._fireEvent(rt,wn[rt]);const ss=xa(this._eventsInProgress),os=(qt||Kt)&&!ss;if(os&&this._terrainMovement){this._map._elevationFreeze=!1,this._terrainMovement=!1;const rt=this._map._getTransformForUpdate();this._map.getCenterClampedToGround()&&rt.recalculateZoomAndCenter(this._map.terrain),this._map._applyUpdatedTransform(rt)}if($t&&os){this._updatingCamera=!0;const rt=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),i=rt=>0!==rt&&-this._bearingSnap<rt&&rt<this._bearingSnap;!rt||!rt.essential&&ge.prefersReducedMotion?(this._map.fire(new Tt.l("moveend",{originalEvent:es})),i(this._map.getBearing())&&this._map.resetNorth()):(i(rt.bearing||this._map.getBearing())&&(rt.bearing=0),rt.freezeElevation=!0,this._map.easeTo(rt,{originalEvent:es})),this._updatingCamera=!1}}_fireEvent(rt,at){this._map.fire(new Tt.l(rt,at?{originalEvent:at}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add((rt=>{delete this._frameId,this.handleEvent(new ba("renderFrame",{timeStamp:rt})),this._applyChanges()}))}_triggerRenderFrame(){void 0===this._frameId&&(this._frameId=this._requestFrame())}}class Ta extends Tt.E{constructor(rt,at,Tt){super(),this._renderFrameCallback=()=>{const rt=Math.min((ge.now()-this._easeStart)/this._easeOptions.duration,1);this._onEaseFrame(this._easeOptions.easing(rt)),rt<1&&this._easeFrameId?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()},this._moving=!1,this._zooming=!1,this.transform=rt,this._bearingSnap=Tt.bearingSnap,this.cameraHelper=at,this.on("moveend",(()=>{delete this._requestedCameraState}))}migrateProjection(rt,at){rt.apply(this.transform),this.transform=rt,this.cameraHelper=at}getCenter(){return new Tt.Q(this.transform.center.lng,this.transform.center.lat)}setCenter(rt,at){return this.jumpTo({center:rt},at)}getCenterElevation(){return this.transform.elevation}setCenterElevation(rt,at){return this.jumpTo({elevation:rt},at),this}getCenterClampedToGround(){return this._centerClampedToGround}setCenterClampedToGround(rt){this._centerClampedToGround=rt}panBy(rt,at,$t){return rt=Tt.P.convert(rt).mult(-1),this.panTo(this.transform.center,Tt.e({offset:rt},at),$t)}panTo(rt,at,$t){return this.easeTo(Tt.e({center:rt},at),$t)}getZoom(){return this.transform.zoom}setZoom(rt,at){return this.jumpTo({zoom:rt},at),this}zoomTo(rt,at,$t){return this.easeTo(Tt.e({zoom:rt},at),$t)}zoomIn(rt,at){return this.zoomTo(this.getZoom()+1,rt,at),this}zoomOut(rt,at){return this.zoomTo(this.getZoom()-1,rt,at),this}getVerticalFieldOfView(){return this.transform.fov}setVerticalFieldOfView(rt,at){return rt!=this.transform.fov&&(this.transform.setFov(rt),this.fire(new Tt.l("movestart",at)).fire(new Tt.l("move",at)).fire(new Tt.l("moveend",at))),this}getBearing(){return this.transform.bearing}setBearing(rt,at){return this.jumpTo({bearing:rt},at),this}getPadding(){return this.transform.padding}setPadding(rt,at){return this.jumpTo({padding:rt},at),this}rotateTo(rt,at,$t){return this.easeTo(Tt.e({bearing:rt},at),$t)}resetNorth(rt,at){return this.rotateTo(0,Tt.e({duration:1e3},rt),at),this}resetNorthPitch(rt,at){return this.easeTo(Tt.e({bearing:0,pitch:0,roll:0,duration:1e3},rt),at),this}snapToNorth(rt,at){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(rt,at):this}getPitch(){return this.transform.pitch}setPitch(rt,at){return this.jumpTo({pitch:rt},at),this}getRoll(){return this.transform.roll}setRoll(rt,at){return this.jumpTo({roll:rt},at),this}cameraForBounds(rt,at){rt=V.convert(rt).adjustAntiMeridian();const Tt=at&&at.bearing||0;return this._cameraForBoxAndBearing(rt.getNorthWest(),rt.getSouthEast(),Tt,at)}_cameraForBoxAndBearing(rt,at,$t,qt){const Kt={top:0,bottom:0,right:0,left:0};if("number"==typeof(qt=Tt.e({padding:Kt,offset:[0,0],maxZoom:this.transform.maxZoom},qt)).padding){const rt=qt.padding;qt.padding={top:rt,bottom:rt,right:rt,left:rt}}const ge=Tt.e(Kt,qt.padding);qt.padding=ge;const Hr=this.transform,wn=new V(rt,at);return this.cameraHelper.cameraForBoxAndBearing(qt,ge,wn,$t,Hr)}fitBounds(rt,at,Tt){return this._fitInternal(this.cameraForBounds(rt,at),at,Tt)}fitScreenCoordinates(rt,at,$t,qt,Kt){return this._fitInternal(this._cameraForBoxAndBearing(this.transform.screenPointToLocation(Tt.P.convert(rt)),this.transform.screenPointToLocation(Tt.P.convert(at)),$t,qt),qt,Kt)}_fitInternal(rt,at,$t){return rt?(delete(at=Tt.e(rt,at)).padding,at.linear?this.easeTo(at,$t):this.flyTo(at,$t)):this}jumpTo(rt,at){this.stop();const $t=this._getTransformForUpdate();let qt=!1,Kt=!1,ge=!1;const Hr=$t.zoom;this.cameraHelper.handleJumpToCenterZoom($t,rt);const wn=$t.zoom!==Hr;return"elevation"in rt&&$t.elevation!==+rt.elevation&&$t.setElevation(+rt.elevation),"bearing"in rt&&$t.bearing!==+rt.bearing&&(qt=!0,$t.setBearing(+rt.bearing)),"pitch"in rt&&$t.pitch!==+rt.pitch&&(Kt=!0,$t.setPitch(+rt.pitch)),"roll"in rt&&$t.roll!==+rt.roll&&(ge=!0,$t.setRoll(+rt.roll)),null==rt.padding||$t.isPaddingEqual(rt.padding)||$t.setPadding(rt.padding),this._applyUpdatedTransform($t),this.fire(new Tt.l("movestart",at)).fire(new Tt.l("move",at)),wn&&this.fire(new Tt.l("zoomstart",at)).fire(new Tt.l("zoom",at)).fire(new Tt.l("zoomend",at)),qt&&this.fire(new Tt.l("rotatestart",at)).fire(new Tt.l("rotate",at)).fire(new Tt.l("rotateend",at)),Kt&&this.fire(new Tt.l("pitchstart",at)).fire(new Tt.l("pitch",at)).fire(new Tt.l("pitchend",at)),ge&&this.fire(new Tt.l("rollstart",at)).fire(new Tt.l("roll",at)).fire(new Tt.l("rollend",at)),this.fire(new Tt.l("moveend",at))}calculateCameraOptionsFromTo(rt,at,$t,qt=0){const Kt=Tt.$.fromLngLat(rt,at),ge=Tt.$.fromLngLat($t,qt),Hr=ge.x-Kt.x,wn=ge.y-Kt.y,es=ge.z-Kt.z,ss=Math.hypot(Hr,wn,es);if(0===ss)throw new Error("Can't calculate camera options with same From and To");const os=Math.hypot(Hr,wn),cs=Tt.ah(this.transform.cameraToCenterDistance/ss/this.transform.tileSize),ds=180*Math.atan2(Hr,-wn)/Math.PI;let Cs=180*Math.acos(os/ss)/Math.PI;return Cs=es<0?90-Cs:90+Cs,{center:ge.toLngLat(),elevation:qt,zoom:cs,pitch:Cs,bearing:ds}}calculateCameraOptionsFromCameraLngLatAltRotation(rt,at,Tt,$t,qt){const Kt=this.transform.calculateCenterFromCameraLngLatAlt(rt,at,Tt,$t);return{center:Kt.center,elevation:Kt.elevation,zoom:Kt.zoom,bearing:Tt,pitch:$t,roll:qt}}easeTo(rt,at){this._stop(!1,rt.easeId),(!1===(rt=Tt.e({offset:[0,0],duration:500,easing:Tt.cd},rt)).animate||!rt.essential&&ge.prefersReducedMotion)&&(rt.duration=0);const $t=this._getTransformForUpdate(),qt=this.getBearing(),Kt=$t.pitch,Hr=$t.roll,wn="bearing"in rt?this._normalizeBearing(rt.bearing,qt):qt,es="pitch"in rt?+rt.pitch:Kt,ss="roll"in rt?this._normalizeBearing(rt.roll,Hr):Hr,os="padding"in rt?rt.padding:$t.padding,cs=Tt.P.convert(rt.offset);let ds,Cs;rt.around&&(ds=Tt.Q.convert(rt.around),Cs=$t.locationToScreenPoint(ds));const Vs={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching,rolling:this._rolling},Eo=this.cameraHelper.handleEaseTo($t,{bearing:wn,pitch:es,roll:ss,padding:os,around:ds,aroundPoint:Cs,offsetAsPoint:cs,offset:rt.offset,zoom:rt.zoom,center:rt.center});return this._rotating=this._rotating||qt!==wn,this._pitching=this._pitching||es!==Kt,this._rolling=this._rolling||ss!==Hr,this._padding=!$t.isPaddingEqual(os),this._zooming=this._zooming||Eo.isZooming,this._easeId=rt.easeId,this._prepareEase(at,rt.noMoveStart,Vs),this.terrain&&this._prepareElevation(Eo.elevationCenter),this._ease((Tt=>{Eo.easeFunc(Tt),this.terrain&&!rt.freezeElevation&&this._updateElevation(Tt),this._applyUpdatedTransform($t),this._fireMoveEvents(at)}),(Tt=>{this.terrain&&rt.freezeElevation&&this._finalizeElevation(),this._afterEase(at,Tt)}),rt),this}_prepareEase(rt,at,$t={}){this._moving=!0,at||$t.moving||this.fire(new Tt.l("movestart",rt)),this._zooming&&!$t.zooming&&this.fire(new Tt.l("zoomstart",rt)),this._rotating&&!$t.rotating&&this.fire(new Tt.l("rotatestart",rt)),this._pitching&&!$t.pitching&&this.fire(new Tt.l("pitchstart",rt)),this._rolling&&!$t.rolling&&this.fire(new Tt.l("rollstart",rt))}_prepareElevation(rt){this._elevationCenter=rt,this._elevationStart=this.transform.elevation,this._elevationTarget=this.terrain.getElevationForLngLatZoom(rt,this.transform.tileZoom),this._elevationFreeze=!0}_updateElevation(rt){this.transform.setMinElevationForCurrentTile(this.terrain.getMinTileElevationForLngLatZoom(this._elevationCenter,this.transform.tileZoom));const at=this.terrain.getElevationForLngLatZoom(this._elevationCenter,this.transform.tileZoom);if(rt<1&&at!==this._elevationTarget){const Tt=this._elevationTarget-this._elevationStart;this._elevationStart+=rt*(Tt-(at-(Tt*rt+this._elevationStart))/(1-rt)),this._elevationTarget=at}this.transform.setElevation(Tt.B.number(this._elevationStart,this._elevationTarget,rt))}_finalizeElevation(){this._elevationFreeze=!1,this.getCenterClampedToGround()&&this.transform.recalculateZoomAndCenter(this.terrain)}_getTransformForUpdate(){return this.transformCameraUpdate||this.terrain?(this._requestedCameraState||(this._requestedCameraState=this.transform.clone()),this._requestedCameraState):this.transform}_elevateCameraIfInsideTerrain(rt){if(!this.terrain&&rt.elevation>=0&&rt.pitch<=90)return{};const at=rt.getCameraLngLat(),Tt=rt.getCameraAltitude(),$t=this.terrain?this.terrain.getElevationForLngLatZoom(at,rt.zoom):0;if(Tt<$t){const Tt=this.calculateCameraOptionsFromTo(at,$t,rt.center,rt.elevation);return{pitch:Tt.pitch,zoom:Tt.zoom}}return{}}_applyUpdatedTransform(rt){const at=[];if(at.push((rt=>this._elevateCameraIfInsideTerrain(rt))),this.transformCameraUpdate&&at.push((rt=>this.transformCameraUpdate(rt))),!at.length)return;const Tt=rt.clone();for(const rt of at){const at=Tt.clone(),{center:$t,zoom:qt,roll:Kt,pitch:ge,bearing:Hr,elevation:wn}=rt(at);$t&&at.setCenter($t),void 0!==wn&&at.setElevation(wn),void 0!==qt&&at.setZoom(qt),void 0!==Kt&&at.setRoll(Kt),void 0!==ge&&at.setPitch(ge),void 0!==Hr&&at.setBearing(Hr),Tt.apply(at)}this.transform.apply(Tt)}_fireMoveEvents(rt){this.fire(new Tt.l("move",rt)),this._zooming&&this.fire(new Tt.l("zoom",rt)),this._rotating&&this.fire(new Tt.l("rotate",rt)),this._pitching&&this.fire(new Tt.l("pitch",rt)),this._rolling&&this.fire(new Tt.l("roll",rt))}_afterEase(rt,at){if(this._easeId&&at&&this._easeId===at)return;delete this._easeId;const $t=this._zooming,qt=this._rotating,Kt=this._pitching,ge=this._rolling;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._rolling=!1,this._padding=!1,$t&&this.fire(new Tt.l("zoomend",rt)),qt&&this.fire(new Tt.l("rotateend",rt)),Kt&&this.fire(new Tt.l("pitchend",rt)),ge&&this.fire(new Tt.l("rollend",rt)),this.fire(new Tt.l("moveend",rt))}flyTo(rt,at){if(!rt.essential&&ge.prefersReducedMotion){const $t=Tt.O(rt,["center","zoom","bearing","pitch","roll","elevation"]);return this.jumpTo($t,at)}this.stop(),rt=Tt.e({offset:[0,0],speed:1.2,curve:1.42,easing:Tt.cd},rt);const $t=this._getTransformForUpdate(),qt=$t.bearing,Kt=$t.pitch,Hr=$t.roll,wn=$t.padding,es="bearing"in rt?this._normalizeBearing(rt.bearing,qt):qt,ss="pitch"in rt?+rt.pitch:Kt,os="roll"in rt?this._normalizeBearing(rt.roll,Hr):Hr,cs="padding"in rt?rt.padding:$t.padding,ds=Tt.P.convert(rt.offset);let Cs=$t.centerPoint.add(ds);const Vs=$t.screenPointToLocation(Cs),Eo=this.cameraHelper.handleFlyTo($t,{bearing:es,pitch:ss,roll:os,padding:cs,locationAtOffset:Vs,offsetAsPoint:ds,center:rt.center,minZoom:rt.minZoom,zoom:rt.zoom});let Do=rt.curve;const Ho=Math.max($t.width,$t.height),Ea=Ho/Eo.scaleOfZoom,La=Eo.pixelPathLength;"number"==typeof Eo.scaleOfMinZoom&&(Do=Math.sqrt(Ho/Eo.scaleOfMinZoom/La*2));const ja=Do*Do;function w(rt){const at=(Ea*Ea-Ho*Ho+(rt?-1:1)*ja*ja*La*La)/(2*(rt?Ea:Ho)*ja*La);return Math.log(Math.sqrt(at*at+1)-at)}function T(rt){return(Math.exp(rt)-Math.exp(-rt))/2}function P(rt){return(Math.exp(rt)+Math.exp(-rt))/2}const Va=w(!1);let M=function(rt){return P(Va)/P(Va+Do*rt)},I=function(rt){return Ho*((P(Va)*(T(at=Va+Do*rt)/P(at))-T(Va))/ja)/La;var at},Na=(w(!0)-Va)/Do;if(Math.abs(La)<2e-6||!isFinite(Na)){if(Math.abs(Ho-Ea)<1e-6)return this.easeTo(rt,at);const Tt=Ea<Ho?-1:1;Na=Math.abs(Math.log(Ea/Ho))/Do,I=()=>0,M=rt=>Math.exp(Tt*Do*rt)}return rt.duration="duration"in rt?+rt.duration:1e3*Na/("screenSpeed"in rt?+rt.screenSpeed/Do:+rt.speed),rt.maxDuration&&rt.duration>rt.maxDuration&&(rt.duration=0),this._zooming=!0,this._rotating=qt!==es,this._pitching=ss!==Kt,this._rolling=os!==Hr,this._padding=!$t.isPaddingEqual(cs),this._prepareEase(at,!1),this.terrain&&this._prepareElevation(Eo.targetCenter),this._ease((ge=>{const Vs=ge*Na,Do=1/M(Vs),Ho=I(Vs);this._rotating&&$t.setBearing(Tt.B.number(qt,es,ge)),this._pitching&&$t.setPitch(Tt.B.number(Kt,ss,ge)),this._rolling&&$t.setRoll(Tt.B.number(Hr,os,ge)),this._padding&&($t.interpolatePadding(wn,cs,ge),Cs=$t.centerPoint.add(ds)),Eo.easeFunc(ge,Do,Ho,Cs),this.terrain&&!rt.freezeElevation&&this._updateElevation(ge),this._applyUpdatedTransform($t),this._fireMoveEvents(at)}),(()=>{this.terrain&&rt.freezeElevation&&this._finalizeElevation(),this._afterEase(at)}),rt),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_stop(rt,at){var Tt;if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),delete this._easeFrameId,delete this._onEaseFrame),this._onEaseEnd){const rt=this._onEaseEnd;delete this._onEaseEnd,rt.call(this,at)}return rt||null===(Tt=this.handlers)||void 0===Tt||Tt.stop(!1),this}_ease(rt,at,Tt){!1===Tt.animate||0===Tt.duration?(rt(1),at()):(this._easeStart=ge.now(),this._easeOptions=Tt,this._onEaseFrame=rt,this._onEaseEnd=at,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_normalizeBearing(rt,at){rt=Tt.aL(rt,-180,180);const $t=Math.abs(rt-at);return Math.abs(rt-360-at)<$t&&(rt-=360),Math.abs(rt+360-at)<$t&&(rt+=360),rt}queryTerrainElevation(rt){return this.terrain?this.terrain.getElevationForLngLatZoom(Tt.Q.convert(rt),this.transform.tileZoom):null}}const uu={compact:!0,customAttribution:'<a href="https://maplibre.org/" target="_blank">MapLibre</a>'};class Ca{constructor(rt=uu){this._toggleAttribution=()=>{this._container.classList.contains("maplibregl-compact")&&(this._container.classList.contains("maplibregl-compact-show")?(this._container.setAttribute("open",""),this._container.classList.remove("maplibregl-compact-show")):(this._container.classList.add("maplibregl-compact-show"),this._container.removeAttribute("open")))},this._updateData=rt=>{!rt||"metadata"!==rt.sourceDataType&&"visibility"!==rt.sourceDataType&&"style"!==rt.dataType&&"terrain"!==rt.type||this._updateAttributions()},this._updateCompact=()=>{this._map.getCanvasContainer().offsetWidth<=640||this._compact?!1===this._compact?this._container.setAttribute("open",""):this._container.classList.contains("maplibregl-compact")||this._container.classList.contains("maplibregl-attrib-empty")||(this._container.setAttribute("open",""),this._container.classList.add("maplibregl-compact","maplibregl-compact-show")):(this._container.setAttribute("open",""),this._container.classList.contains("maplibregl-compact")&&this._container.classList.remove("maplibregl-compact","maplibregl-compact-show"))},this._updateCompactMinimize=()=>{this._container.classList.contains("maplibregl-compact")&&this._container.classList.contains("maplibregl-compact-show")&&this._container.classList.remove("maplibregl-compact-show")},this.options=rt}getDefaultPosition(){return"bottom-right"}onAdd(rt){return this._map=rt,this._compact=this.options.compact,this._container=n.create("details","maplibregl-ctrl maplibregl-ctrl-attrib"),this._compactButton=n.create("summary","maplibregl-ctrl-attrib-button",this._container),this._compactButton.addEventListener("click",this._toggleAttribution),this._setElementTitle(this._compactButton,"ToggleAttribution"),this._innerContainer=n.create("div","maplibregl-ctrl-attrib-inner",this._container),this._updateAttributions(),this._updateCompact(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("terrain",this._updateData),this._map.on("resize",this._updateCompact),this._map.on("drag",this._updateCompactMinimize),this._container}onRemove(){n.remove(this._container),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("terrain",this._updateData),this._map.off("resize",this._updateCompact),this._map.off("drag",this._updateCompactMinimize),this._map=void 0,this._compact=void 0,this._attribHTML=void 0}_setElementTitle(rt,at){const Tt=this._map._getUIString(`AttributionControl.${at}`);rt.title=Tt,rt.setAttribute("aria-label",Tt)}_updateAttributions(){if(!this._map.style)return;let rt=[];if(this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?rt=rt.concat(this.options.customAttribution.map((rt=>"string"!=typeof rt?"":rt))):"string"==typeof this.options.customAttribution&&rt.push(this.options.customAttribution)),this._map.style.stylesheet){const rt=this._map.style.stylesheet;this.styleOwner=rt.owner,this.styleId=rt.id}const at=this._map.style.sourceCaches;for(const Tt in at){const $t=at[Tt];if($t.used||$t.usedForTerrain){const at=$t.getSource();at.attribution&&rt.indexOf(at.attribution)<0&&rt.push(at.attribution)}}rt=rt.filter((rt=>String(rt).trim())),rt.sort(((rt,at)=>rt.length-at.length)),rt=rt.filter(((at,Tt)=>{for(let $t=Tt+1;$t<rt.length;$t++)if(rt[$t].indexOf(at)>=0)return!1;return!0}));const Tt=rt.join(" | ");Tt!==this._attribHTML&&(this._attribHTML=Tt,rt.length?(this._innerContainer.innerHTML=n.sanitize(Tt),this._container.classList.remove("maplibregl-attrib-empty")):this._container.classList.add("maplibregl-attrib-empty"),this._updateCompact(),this._editLink=null)}}class Ma{constructor(rt={}){this._updateCompact=()=>{const rt=this._container.children;if(rt.length){const at=rt[0];this._map.getCanvasContainer().offsetWidth<=640||this._compact?!1!==this._compact&&at.classList.add("maplibregl-compact"):at.classList.remove("maplibregl-compact")}},this.options=rt}getDefaultPosition(){return"bottom-left"}onAdd(rt){this._map=rt,this._compact=this.options&&this.options.compact,this._container=n.create("div","maplibregl-ctrl");const at=n.create("a","maplibregl-ctrl-logo");return at.target="_blank",at.rel="noopener nofollow",at.href="https://maplibre.org/",at.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),at.setAttribute("rel","noopener nofollow"),this._container.appendChild(at),this._container.style.display="block",this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){n.remove(this._container),this._map.off("resize",this._updateCompact),this._map=void 0,this._compact=void 0}}class Ia{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(rt){const at=++this._id;return this._queue.push({callback:rt,id:at,cancelled:!1}),at}remove(rt){const at=this._currentlyRunning,Tt=at?this._queue.concat(at):this._queue;for(const at of Tt)if(at.id===rt)return void(at.cancelled=!0)}run(rt=0){if(this._currentlyRunning)throw new Error("Attempting to run(), but is already running.");const at=this._currentlyRunning=this._queue;this._queue=[];for(const Tt of at)if(!Tt.cancelled&&(Tt.callback(rt),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}var du=Tt.aG([{name:"a_pos3d",type:"Int16",components:3}]);class Sa extends Tt.E{constructor(rt){super(),this._lastTilesetChange=ge.now(),this.sourceCache=rt,this._tiles={},this._renderableTilesKeys=[],this._sourceTileCache={},this.minzoom=0,this.maxzoom=22,this.deltaZoom=1,this.tileSize=rt._source.tileSize*2**this.deltaZoom,rt.usedForTerrain=!0,rt.tileSize=this.tileSize}destruct(){this.sourceCache.usedForTerrain=!1,this.sourceCache.tileSize=null}update(rt,at){this.sourceCache.update(rt,at),this._renderableTilesKeys=[];const $t={};for(const qt of xe(rt,{tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,reparseOverscaled:!1,terrain:at,calculateTileZoom:this.sourceCache._source.calculateTileZoom}))$t[qt.key]=!0,this._renderableTilesKeys.push(qt.key),this._tiles[qt.key]||(qt.terrainRttPosMatrix32f=new Float64Array(16),Tt.bQ(qt.terrainRttPosMatrix32f,0,Tt.Z,Tt.Z,0,0,1),this._tiles[qt.key]=new ae(qt,this.tileSize),this._lastTilesetChange=ge.now());for(const rt in this._tiles)$t[rt]||delete this._tiles[rt]}freeRtt(rt){for(const at in this._tiles){const Tt=this._tiles[at];(!rt||Tt.tileID.equals(rt)||Tt.tileID.isChildOf(rt)||rt.isChildOf(Tt.tileID))&&(Tt.rtt=[])}}getRenderableTiles(){return this._renderableTilesKeys.map((rt=>this.getTileByID(rt)))}getTileByID(rt){return this._tiles[rt]}getTerrainCoords(rt,at){return at?this._getTerrainCoordsForTileRanges(rt,at):this._getTerrainCoordsForRegularTile(rt)}_getTerrainCoordsForRegularTile(rt){const at={};for(const $t of this._renderableTilesKeys){const qt=this._tiles[$t].tileID,Kt=rt.clone(),ge=Tt.b2();if(qt.canonical.equals(rt.canonical))Tt.bQ(ge,0,Tt.Z,Tt.Z,0,0,1);else if(qt.canonical.isChildOf(rt.canonical)){const at=qt.canonical.z-rt.canonical.z,$t=qt.canonical.x-(qt.canonical.x>>at<<at),Kt=qt.canonical.y-(qt.canonical.y>>at<<at),Hr=Tt.Z>>at;Tt.bQ(ge,0,Hr,Hr,0,0,1),Tt.L(ge,ge,[-$t*Hr,-Kt*Hr,0])}else{if(!rt.canonical.isChildOf(qt.canonical))continue;{const at=rt.canonical.z-qt.canonical.z,$t=rt.canonical.x-(rt.canonical.x>>at<<at),Kt=rt.canonical.y-(rt.canonical.y>>at<<at),Hr=Tt.Z>>at;Tt.bQ(ge,0,Tt.Z,Tt.Z,0,0,1),Tt.L(ge,ge,[$t*Hr,Kt*Hr,0]),Tt.M(ge,ge,[1/2**at,1/2**at,0])}}Kt.terrainRttPosMatrix32f=new Float32Array(ge),at[$t]=Kt}return at}_getTerrainCoordsForTileRanges(rt,at){const $t={};for(const qt of this._renderableTilesKeys){const Kt=this._tiles[qt].tileID;if(!this._isWithinTileRanges(Kt,at))continue;const ge=rt.clone(),Hr=Tt.b2();if(Kt.canonical.z===rt.canonical.z){const at=rt.canonical.x-Kt.canonical.x,$t=rt.canonical.y-Kt.canonical.y;Tt.bQ(Hr,0,Tt.Z,Tt.Z,0,0,1),Tt.L(Hr,Hr,[at*Tt.Z,$t*Tt.Z,0])}else if(Kt.canonical.z>rt.canonical.z){const at=Kt.canonical.z-rt.canonical.z,$t=Kt.canonical.x-(Kt.canonical.x>>at<<at),qt=Kt.canonical.y-(Kt.canonical.y>>at<<at),ge=rt.canonical.x-(Kt.canonical.x>>at),wn=rt.canonical.y-(Kt.canonical.y>>at),es=Tt.Z>>at;Tt.bQ(Hr,0,es,es,0,0,1),Tt.L(Hr,Hr,[-$t*es+ge*Tt.Z,-qt*es+wn*Tt.Z,0])}else{const at=rt.canonical.z-Kt.canonical.z,$t=rt.canonical.x-(rt.canonical.x>>at<<at),qt=rt.canonical.y-(rt.canonical.y>>at<<at),ge=(rt.canonical.x>>at)-Kt.canonical.x,wn=(rt.canonical.y>>at)-Kt.canonical.y,es=Tt.Z<<at;Tt.bQ(Hr,0,es,es,0,0,1),Tt.L(Hr,Hr,[$t*Tt.Z+ge*es,qt*Tt.Z+wn*es,0])}ge.terrainRttPosMatrix32f=new Float32Array(Hr),$t[qt]=ge}return $t}getSourceTile(rt,at){const Tt=this.sourceCache._source;let $t=rt.overscaledZ-this.deltaZoom;if($t>Tt.maxzoom&&($t=Tt.maxzoom),$t<Tt.minzoom)return null;this._sourceTileCache[rt.key]||(this._sourceTileCache[rt.key]=rt.scaledTo($t).key);let qt=this.sourceCache.getTileByID(this._sourceTileCache[rt.key]);if((!qt||!qt.dem)&&at)for(;$t>=Tt.minzoom&&(!qt||!qt.dem);)qt=this.sourceCache.getTileByID(rt.scaledTo($t--).key);return qt}anyTilesAfterTime(rt=Date.now()){return this._lastTilesetChange>=rt}_isWithinTileRanges(rt,at){return at[rt.canonical.z]&&rt.canonical.x>=at[rt.canonical.z].minTileX&&rt.canonical.x<=at[rt.canonical.z].maxTileX&&rt.canonical.y>=at[rt.canonical.z].minTileY&&rt.canonical.y<=at[rt.canonical.z].maxTileY}}class Ra{constructor(rt,at,Tt){this._meshCache={},this.painter=rt,this.sourceCache=new Sa(at),this.options=Tt,this.exaggeration="number"==typeof Tt.exaggeration?Tt.exaggeration:1,this.qualityFactor=2,this.meshSize=128,this._demMatrixCache={},this.coordsIndex=[],this._coordsTextureSize=1024}getDEMElevation(rt,at,$t,qt=Tt.Z){var Kt;if(!(at>=0&&at<qt&&$t>=0&&$t<qt))return 0;const ge=this.getTerrainData(rt),Hr=null===(Kt=ge.tile)||void 0===Kt?void 0:Kt.dem;if(!Hr)return 0;const wn=Tt.ch([],[at/qt*Tt.Z,$t/qt*Tt.Z],ge.u_terrain_matrix),es=[wn[0]*Hr.dim,wn[1]*Hr.dim],ss=Math.floor(es[0]),os=Math.floor(es[1]),cs=es[0]-ss,ds=es[1]-os;return Hr.get(ss,os)*(1-cs)*(1-ds)+Hr.get(ss+1,os)*cs*(1-ds)+Hr.get(ss,os+1)*(1-cs)*ds+Hr.get(ss+1,os+1)*cs*ds}getElevationForLngLatZoom(rt,at){if(!Tt.ci(at,rt.wrap()))return 0;const{tileID:$t,mercatorX:qt,mercatorY:Kt}=this._getOverscaledTileIDFromLngLatZoom(rt,at);return this.getElevation($t,qt%Tt.Z,Kt%Tt.Z,Tt.Z)}getElevation(rt,at,$t,qt=Tt.Z){return this.getDEMElevation(rt,at,$t,qt)*this.exaggeration}getTerrainData(rt){if(!this._emptyDemTexture){const rt=this.painter.context,at=new Tt.R({width:1,height:1},new Uint8Array(4));this._emptyDepthTexture=new v(rt,at,rt.gl.RGBA,{premultiply:!1}),this._emptyDemUnpack=[0,0,0,0],this._emptyDemTexture=new v(rt,new Tt.R({width:1,height:1}),rt.gl.RGBA,{premultiply:!1}),this._emptyDemTexture.bind(rt.gl.NEAREST,rt.gl.CLAMP_TO_EDGE),this._emptyDemMatrix=Tt.ad([])}const at=this.sourceCache.getSourceTile(rt,!0);if(at&&at.dem&&(!at.demTexture||at.needsTerrainPrepare)){const rt=this.painter.context;at.demTexture=this.painter.getTileTexture(at.dem.stride),at.demTexture?at.demTexture.update(at.dem.getPixels(),{premultiply:!1}):at.demTexture=new v(rt,at.dem.getPixels(),rt.gl.RGBA,{premultiply:!1}),at.demTexture.bind(rt.gl.NEAREST,rt.gl.CLAMP_TO_EDGE),at.needsTerrainPrepare=!1}const $t=at&&at+at.tileID.key+rt.key;if($t&&!this._demMatrixCache[$t]){const $t=this.sourceCache.sourceCache._source.maxzoom;let qt=rt.canonical.z-at.tileID.canonical.z;rt.overscaledZ>rt.canonical.z&&(rt.canonical.z>=$t?qt=rt.canonical.z-$t:Tt.w("cannot calculate elevation if elevation maxzoom > source.maxzoom"));const Kt=rt.canonical.x-(rt.canonical.x>>qt<<qt),ge=rt.canonical.y-(rt.canonical.y>>qt<<qt),Hr=Tt.cj(new Float64Array(16),[1/(Tt.Z<<qt),1/(Tt.Z<<qt),0]);Tt.L(Hr,Hr,[Kt*Tt.Z,ge*Tt.Z,0]),this._demMatrixCache[rt.key]={matrix:Hr,coord:rt}}return{u_depth:2,u_terrain:3,u_terrain_dim:at&&at.dem&&at.dem.dim||1,u_terrain_matrix:$t?this._demMatrixCache[rt.key].matrix:this._emptyDemMatrix,u_terrain_unpack:at&&at.dem&&at.dem.getUnpackVector()||this._emptyDemUnpack,u_terrain_exaggeration:this.exaggeration,texture:(at&&at.demTexture||this._emptyDemTexture).texture,depthTexture:(this._fboDepthTexture||this._emptyDepthTexture).texture,tile:at}}getFramebuffer(rt){const at=this.painter,Tt=at.width/devicePixelRatio,$t=at.height/devicePixelRatio;return!this._fbo||this._fbo.width===Tt&&this._fbo.height===$t||(this._fbo.destroy(),this._fboCoordsTexture.destroy(),this._fboDepthTexture.destroy(),delete this._fbo,delete this._fboDepthTexture,delete this._fboCoordsTexture),this._fboCoordsTexture||(this._fboCoordsTexture=new v(at.context,{width:Tt,height:$t,data:null},at.context.gl.RGBA,{premultiply:!1}),this._fboCoordsTexture.bind(at.context.gl.NEAREST,at.context.gl.CLAMP_TO_EDGE)),this._fboDepthTexture||(this._fboDepthTexture=new v(at.context,{width:Tt,height:$t,data:null},at.context.gl.RGBA,{premultiply:!1}),this._fboDepthTexture.bind(at.context.gl.NEAREST,at.context.gl.CLAMP_TO_EDGE)),this._fbo||(this._fbo=at.context.createFramebuffer(Tt,$t,!0,!1),this._fbo.depthAttachment.set(at.context.createRenderbuffer(at.context.gl.DEPTH_COMPONENT16,Tt,$t))),this._fbo.colorAttachment.set("coords"===rt?this._fboCoordsTexture.texture:this._fboDepthTexture.texture),this._fbo}getCoordsTexture(){const rt=this.painter.context;if(this._coordsTexture)return this._coordsTexture;const at=new Uint8Array(this._coordsTextureSize*this._coordsTextureSize*4);for(let rt=0,Tt=0;rt<this._coordsTextureSize;rt++)for(let $t=0;$t<this._coordsTextureSize;$t++,Tt+=4)at[Tt+0]=255&$t,at[Tt+1]=255&rt,at[Tt+2]=$t>>8<<4|rt>>8,at[Tt+3]=0;const $t=new Tt.R({width:this._coordsTextureSize,height:this._coordsTextureSize},new Uint8Array(at.buffer)),qt=new v(rt,$t,rt.gl.RGBA,{premultiply:!1});return qt.bind(rt.gl.NEAREST,rt.gl.CLAMP_TO_EDGE),this._coordsTexture=qt,qt}pointCoordinate(rt){this.painter.maybeDrawDepthAndCoords(!0);const at=new Uint8Array(4),$t=this.painter.context,qt=$t.gl,Kt=Math.round(rt.x*this.painter.pixelRatio/devicePixelRatio),ge=Math.round(rt.y*this.painter.pixelRatio/devicePixelRatio),Hr=Math.round(this.painter.height/devicePixelRatio);$t.bindFramebuffer.set(this.getFramebuffer("coords").framebuffer),qt.readPixels(Kt,Hr-ge-1,1,1,qt.RGBA,qt.UNSIGNED_BYTE,at),$t.bindFramebuffer.set(null);const wn=at[0]+(at[2]>>4<<8),es=at[1]+((15&at[2])<<8),ss=this.coordsIndex[255-at[3]],os=ss&&this.sourceCache.getTileByID(ss);if(!os)return null;const cs=this._coordsTextureSize,ds=(1<<os.tileID.canonical.z)*cs;return new Tt.$((os.tileID.canonical.x*cs+wn)/ds+os.tileID.wrap,(os.tileID.canonical.y*cs+es)/ds,this.getElevation(os.tileID,wn,es,cs))}depthAtPoint(rt){const at=new Uint8Array(4),Tt=this.painter.context,$t=Tt.gl;return Tt.bindFramebuffer.set(this.getFramebuffer("depth").framebuffer),$t.readPixels(rt.x,this.painter.height/devicePixelRatio-rt.y-1,1,1,$t.RGBA,$t.UNSIGNED_BYTE,at),Tt.bindFramebuffer.set(null),(at[0]/16777216+at[1]/65536+at[2]/256+at[3])/256}getTerrainMesh(rt){var at;const $t=(null===(at=this.painter.style.projection)||void 0===at?void 0:at.transitionState)>0,qt=$t&&0===rt.canonical.y,Kt=$t&&rt.canonical.y===(1<<rt.canonical.z)-1,ge=`m_${qt?"n":""}_${Kt?"s":""}`;if(this._meshCache[ge])return this._meshCache[ge];const Hr=this.painter.context,wn=new Tt.ck,es=new Tt.aK,ss=this.meshSize,os=Tt.Z/ss,cs=ss*ss;for(let rt=0;rt<=ss;rt++)for(let at=0;at<=ss;at++)wn.emplaceBack(at*os,rt*os,0);for(let rt=0;rt<cs;rt+=ss+1)for(let at=0;at<ss;at++)es.emplaceBack(at+rt,ss+at+rt+1,ss+at+rt+2),es.emplaceBack(at+rt,ss+at+rt+2,at+rt+1);const ds=wn.length,Cs=ds+(ss+1),Vs=(ss+1)*ss,Eo=qt?Tt.b9:0,Do=qt?0:1,Ho=Kt?Tt.ba:Tt.Z,Ea=Kt?0:1;for(let rt=0;rt<=ss;rt++)wn.emplaceBack(rt*os,Eo,Do);for(let rt=0;rt<=ss;rt++)wn.emplaceBack(rt*os,Ho,Ea);for(let rt=0;rt<ss;rt++)es.emplaceBack(Vs+rt,Cs+rt,Cs+rt+1),es.emplaceBack(Vs+rt,Cs+rt+1,Vs+rt+1),es.emplaceBack(0+rt,ds+rt+1,ds+rt),es.emplaceBack(0+rt,0+rt+1,ds+rt+1);const La=wn.length,ja=La+2*(ss+1);for(const rt of[0,1])for(let at=0;at<=ss;at++)for(const $t of[0,1])wn.emplaceBack(rt*Tt.Z,at*os,$t);for(let rt=0;rt<2*ss;rt+=2)es.emplaceBack(La+rt,La+rt+1,La+rt+3),es.emplaceBack(La+rt,La+rt+3,La+rt+2),es.emplaceBack(ja+rt,ja+rt+3,ja+rt+1),es.emplaceBack(ja+rt,ja+rt+2,ja+rt+3);const Va=new wt(Hr.createVertexBuffer(wn,du.members),Hr.createIndexBuffer(es),Tt.aJ.simpleSegment(0,0,wn.length,es.length));return this._meshCache[ge]=Va,Va}getMeshFrameDelta(rt){return 2*Math.PI*Tt.bu/Math.pow(2,Math.max(rt,0))/5}getMinTileElevationForLngLatZoom(rt,at){var Tt;const{tileID:$t}=this._getOverscaledTileIDFromLngLatZoom(rt,at);return null!==(Tt=this.getMinMaxElevation($t).minElevation)&&void 0!==Tt?Tt:0}getMinMaxElevation(rt){const at=this.getTerrainData(rt).tile,Tt={minElevation:null,maxElevation:null};return at&&at.dem&&(Tt.minElevation=at.dem.min*this.exaggeration,Tt.maxElevation=at.dem.max*this.exaggeration),Tt}_getOverscaledTileIDFromLngLatZoom(rt,at){const $t=Tt.$.fromLngLat(rt.wrap()),qt=(1<<at)*Tt.Z,Kt=$t.x*qt,ge=$t.y*qt,Hr=Math.floor(Kt/Tt.Z),wn=Math.floor(ge/Tt.Z);return{tileID:new Tt.Y(at,0,at,Hr,wn),mercatorX:Kt,mercatorY:ge}}}class Da{constructor(rt,at,Tt){this._context=rt,this._size=at,this._tileSize=Tt,this._objects=[],this._recentlyUsed=[],this._stamp=0}destruct(){for(const rt of this._objects)rt.texture.destroy(),rt.fbo.destroy()}_createObject(rt){const at=this._context.createFramebuffer(this._tileSize,this._tileSize,!0,!0),Tt=new v(this._context,{width:this._tileSize,height:this._tileSize,data:null},this._context.gl.RGBA);return Tt.bind(this._context.gl.LINEAR,this._context.gl.CLAMP_TO_EDGE),this._context.extTextureFilterAnisotropic&&this._context.gl.texParameterf(this._context.gl.TEXTURE_2D,this._context.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,this._context.extTextureFilterAnisotropicMax),at.depthAttachment.set(this._context.createRenderbuffer(this._context.gl.DEPTH_STENCIL,this._tileSize,this._tileSize)),at.colorAttachment.set(Tt.texture),{id:rt,fbo:at,texture:Tt,stamp:-1,inUse:!1}}getObjectForId(rt){return this._objects[rt]}useObject(rt){rt.inUse=!0,this._recentlyUsed=this._recentlyUsed.filter((at=>rt.id!==at)),this._recentlyUsed.push(rt.id)}stampObject(rt){rt.stamp=++this._stamp}getOrCreateFreeObject(){for(const rt of this._recentlyUsed)if(!this._objects[rt].inUse)return this._objects[rt];if(this._objects.length>=this._size)throw new Error("No free RenderPool available, call freeAllObjects() required!");const rt=this._createObject(this._objects.length);return this._objects.push(rt),rt}freeObject(rt){rt.inUse=!1}freeAllObjects(){for(const rt of this._objects)this.freeObject(rt)}isFull(){return!(this._objects.length<this._size)&&!1===this._objects.some((rt=>!rt.inUse))}}const mu={background:!0,fill:!0,line:!0,raster:!0,hillshade:!0};class Aa{constructor(rt,at){this.painter=rt,this.terrain=at,this.pool=new Da(rt.context,30,at.sourceCache.tileSize*at.qualityFactor)}destruct(){this.pool.destruct()}getTexture(rt){return this.pool.getObjectForId(rt.rtt[this._stacks.length-1].id).texture}prepareForRender(rt,at){this._stacks=[],this._prevType=null,this._rttTiles=[],this._renderableTiles=this.terrain.sourceCache.getRenderableTiles(),this._renderableLayerIds=rt._order.filter((Tt=>!rt._layers[Tt].isHidden(at))),this._coordsAscending={};for(const at in rt.sourceCaches){this._coordsAscending[at]={};const Tt=rt.sourceCaches[at].getVisibleCoordinates(),$t=rt.sourceCaches[at].getSource(),qt=$t instanceof K?$t.terrainTileRanges:null;for(const rt of Tt){const Tt=this.terrain.sourceCache.getTerrainCoords(rt,qt);for(const rt in Tt)this._coordsAscending[at][rt]||(this._coordsAscending[at][rt]=[]),this._coordsAscending[at][rt].push(Tt[rt])}}this._coordsAscendingStr={};for(const at of rt._order){const Tt=rt._layers[at],$t=Tt.source;if(mu[Tt.type]&&!this._coordsAscendingStr[$t]){this._coordsAscendingStr[$t]={};for(const rt in this._coordsAscending[$t])this._coordsAscendingStr[$t][rt]=this._coordsAscending[$t][rt].map((rt=>rt.key)).sort().join()}}for(const rt of this._renderableTiles)for(const at in this._coordsAscendingStr){const Tt=this._coordsAscendingStr[at][rt.tileID.key];Tt&&Tt!==rt.rttCoords[at]&&(rt.rtt=[])}}renderLayer(rt,at){if(rt.isHidden(this.painter.transform.zoom))return!1;const $t=Object.assign(Object.assign({},at),{isRenderingToTexture:!0}),qt=rt.type,Kt=this.painter,ge=this._renderableLayerIds[this._renderableLayerIds.length-1]===rt.id;if(mu[qt]&&(this._prevType&&mu[this._prevType]||this._stacks.push([]),this._prevType=qt,this._stacks[this._stacks.length-1].push(rt.id),!ge))return!0;if(mu[this._prevType]||mu[qt]&&ge){this._prevType=qt;const rt=this._stacks.length-1,at=this._stacks[rt]||[];for(const qt of this._renderableTiles){if(this.pool.isFull()&&(yo(this.painter,this.terrain,this._rttTiles,$t),this._rttTiles=[],this.pool.freeAllObjects()),this._rttTiles.push(qt),qt.rtt[rt]){const at=this.pool.getObjectForId(qt.rtt[rt].id);if(at.stamp===qt.rtt[rt].stamp){this.pool.useObject(at);continue}}const ge=this.pool.getOrCreateFreeObject();this.pool.useObject(ge),this.pool.stampObject(ge),qt.rtt[rt]={id:ge.id,stamp:ge.stamp},Kt.context.bindFramebuffer.set(ge.fbo.framebuffer),Kt.context.clear({color:Tt.b7.transparent,stencil:0}),Kt.currentStencilSource=void 0;for(let rt=0;rt<at.length;rt++){const Tt=Kt.style._layers[at[rt]],Hr=Tt.source?this._coordsAscending[Tt.source][qt.tileID.key]:[qt.tileID];Kt.context.viewport.set([0,0,ge.fbo.width,ge.fbo.height]),Kt._renderTileClippingMasks(Tt,Hr,!0),Kt.renderLayer(Kt,Kt.style.sourceCaches[Tt.source],Tt,Hr,$t),Tt.source&&(qt.rttCoords[Tt.source]=this._coordsAscendingStr[Tt.source][qt.tileID.key])}}return yo(this.painter,this.terrain,this._rttTiles,$t),this._rttTiles=[],this.pool.freeAllObjects(),mu[qt]}return!1}}const _u={"AttributionControl.ToggleAttribution":"Toggle attribution","AttributionControl.MapFeedback":"Map feedback","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"MapLibre logo","Map.Title":"Map","Marker.Title":"Map marker","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","Popup.Close":"Close popup","ScaleControl.Feet":"ft","ScaleControl.Meters":"m","ScaleControl.Kilometers":"km","ScaleControl.Miles":"mi","ScaleControl.NauticalMiles":"nm","GlobeControl.Enable":"Enable globe","GlobeControl.Disable":"Disable globe","TerrainControl.Enable":"Enable terrain","TerrainControl.Disable":"Disable terrain","CooperativeGesturesHandler.WindowsHelpText":"Use Ctrl + scroll to zoom the map","CooperativeGesturesHandler.MacHelpText":"Use  + scroll to zoom the map","CooperativeGesturesHandler.MobileHelpText":"Use two fingers to move the map"},gu=$t,yu={hash:!1,interactive:!0,bearingSnap:7,attributionControl:uu,maplibreLogo:!1,refreshExpiredTiles:!0,canvasContextAttributes:{antialias:!1,preserveDrawingBuffer:!1,powerPreference:"high-performance",failIfMajorPerformanceCaveat:!1,desynchronized:!1,contextType:void 0},scrollZoom:!0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:60,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,trackResize:!0,center:[0,0],elevation:0,zoom:0,bearing:0,pitch:0,roll:0,renderWorldCopies:!0,maxTileCacheSize:null,maxTileCacheZoomLevels:Tt.a.MAX_TILE_CACHE_ZOOM_LEVELS,transformRequest:null,transformCameraUpdate:null,fadeDuration:300,crossSourceCollisions:!0,clickTolerance:3,localIdeographFontFamily:"sans-serif",pitchWithRotate:!0,rollEnabled:!1,validateStyle:!0,maxCanvasSize:[4096,4096],cancelPendingTileRequestsWhileZooming:!0,centerClampedToGround:!0},xu={showCompass:!0,showZoom:!0,visualizePitch:!1,visualizeRoll:!0};class Oa{constructor(rt,at,$t=!1){this.mousedown=rt=>{this.startMove(rt,n.mousePos(this.element,rt)),n.addEventListener(window,"mousemove",this.mousemove),n.addEventListener(window,"mouseup",this.mouseup)},this.mousemove=rt=>{this.move(rt,n.mousePos(this.element,rt))},this.mouseup=rt=>{this._rotatePitchHanlder.dragEnd(rt),this.offTemp()},this.touchstart=rt=>{1!==rt.targetTouches.length?this.reset():(this._startPos=this._lastPos=n.touchPos(this.element,rt.targetTouches)[0],this.startMove(rt,this._startPos),n.addEventListener(window,"touchmove",this.touchmove,{passive:!1}),n.addEventListener(window,"touchend",this.touchend))},this.touchmove=rt=>{1!==rt.targetTouches.length?this.reset():(this._lastPos=n.touchPos(this.element,rt.targetTouches)[0],this.move(rt,this._lastPos))},this.touchend=rt=>{0===rt.targetTouches.length&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),delete this._startPos,delete this._lastPos,this.offTemp()},this.reset=()=>{this._rotatePitchHanlder.reset(),delete this._startPos,delete this._lastPos,this.offTemp()},this._clickTolerance=10,this.element=at;const qt=new Ko;this._rotatePitchHanlder=new Wo({clickTolerance:3,move:(rt,qt)=>{const Kt=at.getBoundingClientRect(),ge=new Tt.P((Kt.bottom-Kt.top)/2,(Kt.right-Kt.left)/2);return{bearingDelta:Tt.cc(new Tt.P(rt.x,qt.y),qt,ge),pitchDelta:$t?-.5*(qt.y-rt.y):void 0}},moveStateManager:qt,enable:!0,assignEvents:()=>{}}),this.map=rt,n.addEventListener(at,"mousedown",this.mousedown),n.addEventListener(at,"touchstart",this.touchstart,{passive:!1}),n.addEventListener(at,"touchcancel",this.reset)}startMove(rt,at){this._rotatePitchHanlder.dragStart(rt,at),n.disableDrag()}move(rt,at){const Tt=this.map,{bearingDelta:$t,pitchDelta:qt}=this._rotatePitchHanlder.dragMove(rt,at)||{};$t&&Tt.setBearing(Tt.getBearing()+$t),qt&&Tt.setPitch(Tt.getPitch()+qt)}off(){const rt=this.element;n.removeEventListener(rt,"mousedown",this.mousedown),n.removeEventListener(rt,"touchstart",this.touchstart,{passive:!1}),n.removeEventListener(window,"touchmove",this.touchmove,{passive:!1}),n.removeEventListener(window,"touchend",this.touchend),n.removeEventListener(rt,"touchcancel",this.reset),this.offTemp()}offTemp(){n.enableDrag(),n.removeEventListener(window,"mousemove",this.mousemove),n.removeEventListener(window,"mouseup",this.mouseup),n.removeEventListener(window,"touchmove",this.touchmove,{passive:!1}),n.removeEventListener(window,"touchend",this.touchend)}}let vu;function Za(rt,at,$t,qt=!1){if(qt||!$t.getCoveringTilesDetailsProvider().allowWorldCopies())return null==rt?void 0:rt.wrap();const Kt=new Tt.Q(rt.lng,rt.lat);if(rt=new Tt.Q(rt.lng,rt.lat),at){const qt=new Tt.Q(rt.lng-360,rt.lat),Kt=new Tt.Q(rt.lng+360,rt.lat),ge=$t.locationToScreenPoint(rt).distSqr(at);$t.locationToScreenPoint(qt).distSqr(at)<ge?rt=qt:$t.locationToScreenPoint(Kt).distSqr(at)<ge&&(rt=Kt)}for(;Math.abs(rt.lng-$t.center.lng)>180;){const at=$t.locationToScreenPoint(rt);if(at.x>=0&&at.y>=0&&at.x<=$t.width&&at.y<=$t.height)break;rt.lng>$t.center.lng?rt.lng-=360:rt.lng+=360}return rt.lng!==Kt.lng&&$t.isPointOnMapSurface($t.locationToScreenPoint(rt))?rt:Kt}const bu={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"};function Ua(rt,at,Tt){const $t=rt.classList;for(const rt in bu)$t.remove(`maplibregl-${Tt}-anchor-${rt}`);$t.add(`maplibregl-${Tt}-anchor-${at}`)}class Ga extends Tt.E{constructor(rt){if(super(),this._onKeyPress=rt=>{const at=rt.code,Tt=rt.charCode||rt.keyCode;"Space"!==at&&"Enter"!==at&&32!==Tt&&13!==Tt||this.togglePopup()},this._onMapClick=rt=>{const at=rt.originalEvent.target,Tt=this._element;this._popup&&(at===Tt||Tt.contains(at))&&this.togglePopup()},this._update=rt=>{if(!this._map)return;const at=this._map.loaded()&&!this._map.isMoving();("terrain"===(null==rt?void 0:rt.type)||"render"===(null==rt?void 0:rt.type)&&!at)&&this._map.once("render",this._update),this._lngLat=Za(this._lngLat,this._flatPos,this._map.transform),this._flatPos=this._pos=this._map.project(this._lngLat)._add(this._offset),this._map.terrain&&(this._flatPos=this._map.transform.locationToScreenPoint(this._lngLat)._add(this._offset));let Tt="";"viewport"===this._rotationAlignment||"auto"===this._rotationAlignment?Tt=`rotateZ(${this._rotation}deg)`:"map"===this._rotationAlignment&&(Tt=`rotateZ(${this._rotation-this._map.getBearing()}deg)`);let $t="";"viewport"===this._pitchAlignment||"auto"===this._pitchAlignment?$t="rotateX(0deg)":"map"===this._pitchAlignment&&($t=`rotateX(${this._map.getPitch()}deg)`),this._subpixelPositioning||rt&&"moveend"!==rt.type||(this._pos=this._pos.round()),n.setTransform(this._element,`${bu[this._anchor]} translate(${this._pos.x}px, ${this._pos.y}px) ${$t} ${Tt}`),ge.frameAsync(new AbortController).then((()=>{this._updateOpacity(rt&&"moveend"===rt.type)})).catch((()=>{}))},this._onMove=rt=>{if(!this._isDragging){const at=this._clickTolerance||this._map._clickTolerance;this._isDragging=rt.point.dist(this._pointerdownPos)>=at}this._isDragging&&(this._pos=rt.point.sub(this._positionDelta),this._lngLat=this._map.unproject(this._pos),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none","pending"===this._state&&(this._state="active",this.fire(new Tt.l("dragstart"))),this.fire(new Tt.l("drag")))},this._onUp=()=>{this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1,this._map.off("mousemove",this._onMove),this._map.off("touchmove",this._onMove),"active"===this._state&&this.fire(new Tt.l("dragend")),this._state="inactive"},this._addDragHandler=rt=>{this._element.contains(rt.originalEvent.target)&&(rt.preventDefault(),this._positionDelta=rt.point.sub(this._pos).add(this._offset),this._pointerdownPos=rt.point,this._state="pending",this._map.on("mousemove",this._onMove),this._map.on("touchmove",this._onMove),this._map.once("mouseup",this._onUp),this._map.once("touchend",this._onUp))},this._anchor=rt&&rt.anchor||"center",this._color=rt&&rt.color||"#3FB1CE",this._scale=rt&&rt.scale||1,this._draggable=rt&&rt.draggable||!1,this._clickTolerance=rt&&rt.clickTolerance||0,this._subpixelPositioning=rt&&rt.subpixelPositioning||!1,this._isDragging=!1,this._state="inactive",this._rotation=rt&&rt.rotation||0,this._rotationAlignment=rt&&rt.rotationAlignment||"auto",this._pitchAlignment=rt&&rt.pitchAlignment&&"auto"!==rt.pitchAlignment?rt.pitchAlignment:this._rotationAlignment,this.setOpacity(null==rt?void 0:rt.opacity,null==rt?void 0:rt.opacityWhenCovered),rt&&rt.element)this._element=rt.element,this._offset=Tt.P.convert(rt&&rt.offset||[0,0]);else{this._defaultMarker=!0,this._element=n.create("div");const at=n.createNS("http://www.w3.org/2000/svg","svg"),$t=41,qt=27;at.setAttributeNS(null,"display","block"),at.setAttributeNS(null,"height",`${$t}px`),at.setAttributeNS(null,"width",`${qt}px`),at.setAttributeNS(null,"viewBox",`0 0 ${qt} ${$t}`);const Kt=n.createNS("http://www.w3.org/2000/svg","g");Kt.setAttributeNS(null,"stroke","none"),Kt.setAttributeNS(null,"stroke-width","1"),Kt.setAttributeNS(null,"fill","none"),Kt.setAttributeNS(null,"fill-rule","evenodd");const ge=n.createNS("http://www.w3.org/2000/svg","g");ge.setAttributeNS(null,"fill-rule","nonzero");const Hr=n.createNS("http://www.w3.org/2000/svg","g");Hr.setAttributeNS(null,"transform","translate(3.0, 29.0)"),Hr.setAttributeNS(null,"fill","#000000");const wn=[{rx:"10.5",ry:"5.25002273"},{rx:"10.5",ry:"5.25002273"},{rx:"9.5",ry:"4.77275007"},{rx:"8.5",ry:"4.29549936"},{rx:"7.5",ry:"3.81822308"},{rx:"6.5",ry:"3.34094679"},{rx:"5.5",ry:"2.86367051"},{rx:"4.5",ry:"2.38636864"}];for(const rt of wn){const at=n.createNS("http://www.w3.org/2000/svg","ellipse");at.setAttributeNS(null,"opacity","0.04"),at.setAttributeNS(null,"cx","10.5"),at.setAttributeNS(null,"cy","5.80029008"),at.setAttributeNS(null,"rx",rt.rx),at.setAttributeNS(null,"ry",rt.ry),Hr.appendChild(at)}const es=n.createNS("http://www.w3.org/2000/svg","g");es.setAttributeNS(null,"fill",this._color);const ss=n.createNS("http://www.w3.org/2000/svg","path");ss.setAttributeNS(null,"d","M27,13.5 C27,19.074644 20.250001,27.000002 14.75,34.500002 C14.016665,35.500004 12.983335,35.500004 12.25,34.500002 C6.7499993,27.000002 0,19.222562 0,13.5 C0,6.0441559 6.0441559,0 13.5,0 C20.955844,0 27,6.0441559 27,13.5 Z"),es.appendChild(ss);const os=n.createNS("http://www.w3.org/2000/svg","g");os.setAttributeNS(null,"opacity","0.25"),os.setAttributeNS(null,"fill","#000000");const cs=n.createNS("http://www.w3.org/2000/svg","path");cs.setAttributeNS(null,"d","M13.5,0 C6.0441559,0 0,6.0441559 0,13.5 C0,19.222562 6.7499993,27 12.25,34.5 C13,35.522727 14.016664,35.500004 14.75,34.5 C20.250001,27 27,19.074644 27,13.5 C27,6.0441559 20.955844,0 13.5,0 Z M13.5,1 C20.415404,1 26,6.584596 26,13.5 C26,15.898657 24.495584,19.181431 22.220703,22.738281 C19.945823,26.295132 16.705119,30.142167 13.943359,33.908203 C13.743445,34.180814 13.612715,34.322738 13.5,34.441406 C13.387285,34.322738 13.256555,34.180814 13.056641,33.908203 C10.284481,30.127985 7.4148684,26.314159 5.015625,22.773438 C2.6163816,19.232715 1,15.953538 1,13.5 C1,6.584596 6.584596,1 13.5,1 Z"),os.appendChild(cs);const ds=n.createNS("http://www.w3.org/2000/svg","g");ds.setAttributeNS(null,"transform","translate(6.0, 7.0)"),ds.setAttributeNS(null,"fill","#FFFFFF");const Cs=n.createNS("http://www.w3.org/2000/svg","g");Cs.setAttributeNS(null,"transform","translate(8.0, 8.0)");const Vs=n.createNS("http://www.w3.org/2000/svg","circle");Vs.setAttributeNS(null,"fill","#000000"),Vs.setAttributeNS(null,"opacity","0.25"),Vs.setAttributeNS(null,"cx","5.5"),Vs.setAttributeNS(null,"cy","5.5"),Vs.setAttributeNS(null,"r","5.4999962");const Eo=n.createNS("http://www.w3.org/2000/svg","circle");Eo.setAttributeNS(null,"fill","#FFFFFF"),Eo.setAttributeNS(null,"cx","5.5"),Eo.setAttributeNS(null,"cy","5.5"),Eo.setAttributeNS(null,"r","5.4999962"),Cs.appendChild(Vs),Cs.appendChild(Eo),ge.appendChild(Hr),ge.appendChild(es),ge.appendChild(os),ge.appendChild(ds),ge.appendChild(Cs),at.appendChild(ge),at.setAttributeNS(null,"height",$t*this._scale+"px"),at.setAttributeNS(null,"width",qt*this._scale+"px"),this._element.appendChild(at),this._offset=Tt.P.convert(rt&&rt.offset||[0,-14])}if(this._element.classList.add("maplibregl-marker"),this._element.addEventListener("dragstart",(rt=>{rt.preventDefault()})),this._element.addEventListener("mousedown",(rt=>{rt.preventDefault()})),Ua(this._element,this._anchor,"marker"),rt&&rt.className)for(const at of rt.className.split(" "))this._element.classList.add(at);this._popup=null}addTo(rt){return this.remove(),this._map=rt,this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label",rt._getUIString("Marker.Title")),rt.getCanvasContainer().appendChild(this._element),rt.on("move",this._update),rt.on("moveend",this._update),rt.on("terrain",this._update),rt.on("projectiontransition",this._update),this.setDraggable(this._draggable),this._update(),this._map.on("click",this._onMapClick),this}remove(){return this._opacityTimeout&&(clearTimeout(this._opacityTimeout),delete this._opacityTimeout),this._map&&(this._map.off("click",this._onMapClick),this._map.off("move",this._update),this._map.off("moveend",this._update),this._map.off("terrain",this._update),this._map.off("projectiontransition",this._update),this._map.off("mousedown",this._addDragHandler),this._map.off("touchstart",this._addDragHandler),this._map.off("mouseup",this._onUp),this._map.off("touchend",this._onUp),this._map.off("mousemove",this._onMove),this._map.off("touchmove",this._onMove),delete this._map),n.remove(this._element),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(rt){return this._lngLat=Tt.Q.convert(rt),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(),this}getElement(){return this._element}setPopup(rt){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),rt){if(!("offset"in rt.options)){const at=38.1,Tt=13.5,$t=Math.abs(Tt)/Math.SQRT2;rt.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[$t,-1*(at-Tt+$t)],"bottom-right":[-$t,-1*(at-Tt+$t)],left:[Tt,-1*(at-Tt)],right:[-13.5,-1*(at-Tt)]}:this._offset}this._popup=rt,this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress)}return this}setSubpixelPositioning(rt){return this._subpixelPositioning=rt,this}getPopup(){return this._popup}togglePopup(){const rt=this._popup;return this._element.style.opacity===this._opacityWhenCovered?this:rt?(rt.isOpen()?rt.remove():(rt.setLngLat(this._lngLat),rt.addTo(this._map)),this):this}_updateOpacity(rt=!1){var at,$t;if(!(null===(at=this._map)||void 0===at?void 0:at.terrain)){const rt=this._map.transform.isLocationOccluded(this._lngLat)?this._opacityWhenCovered:this._opacity;return void(this._element.style.opacity!==rt&&(this._element.style.opacity=rt))}if(rt)this._opacityTimeout=null;else{if(this._opacityTimeout)return;this._opacityTimeout=setTimeout((()=>{this._opacityTimeout=null}),100)}const qt=this._map,Kt=qt.terrain.depthAtPoint(this._pos),ge=qt.terrain.getElevationForLngLatZoom(this._lngLat,qt.transform.tileZoom);if(qt.transform.lngLatToCameraDepth(this._lngLat,ge)-Kt<.006)return void(this._element.style.opacity=this._opacity);const Hr=-this._offset.y/qt.transform.pixelsPerMeter,wn=Math.sin(qt.getPitch()*Math.PI/180)*Hr,es=qt.terrain.depthAtPoint(new Tt.P(this._pos.x,this._pos.y-this._offset.y)),ss=qt.transform.lngLatToCameraDepth(this._lngLat,ge+wn)-es>.006;(null===($t=this._popup)||void 0===$t?void 0:$t.isOpen())&&ss&&this._popup.remove(),this._element.style.opacity=ss?this._opacityWhenCovered:this._opacity}getOffset(){return this._offset}setOffset(rt){return this._offset=Tt.P.convert(rt),this._update(),this}addClassName(rt){this._element.classList.add(rt)}removeClassName(rt){this._element.classList.remove(rt)}toggleClassName(rt){return this._element.classList.toggle(rt)}setDraggable(rt){return this._draggable=!!rt,this._map&&(rt?(this._map.on("mousedown",this._addDragHandler),this._map.on("touchstart",this._addDragHandler)):(this._map.off("mousedown",this._addDragHandler),this._map.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(rt){return this._rotation=rt||0,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(rt){return this._rotationAlignment=rt||"auto",this._update(),this}getRotationAlignment(){return this._rotationAlignment}setPitchAlignment(rt){return this._pitchAlignment=rt&&"auto"!==rt?rt:this._rotationAlignment,this._update(),this}getPitchAlignment(){return this._pitchAlignment}setOpacity(rt,at){return(void 0===this._opacity||void 0===rt&&void 0===at)&&(this._opacity="1",this._opacityWhenCovered="0.2"),void 0!==rt&&(this._opacity=rt),void 0!==at&&(this._opacityWhenCovered=at),this._map&&this._updateOpacity(!0),this}}const Pu={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0};let Mu=0,Su=!1;const Cu={maxWidth:100,unit:"metric"};function $a(rt,at,Tt){const $t=Tt&&Tt.maxWidth||100,qt=rt._container.clientHeight/2,Kt=rt._container.clientWidth/2,ge=rt.unproject([Kt-$t/2,qt]),Hr=rt.unproject([Kt+$t/2,qt]),wn=Math.round(rt.project(Hr).x-rt.project(ge).x),es=Math.min($t,wn,rt._container.clientWidth),ss=ge.distanceTo(Hr);if(Tt&&"imperial"===Tt.unit){const Tt=3.2808*ss;Tt>5280?Xa(at,es,Tt/5280,rt._getUIString("ScaleControl.Miles")):Xa(at,es,Tt,rt._getUIString("ScaleControl.Feet"))}else Tt&&"nautical"===Tt.unit?Xa(at,es,ss/1852,rt._getUIString("ScaleControl.NauticalMiles")):ss>=1e3?Xa(at,es,ss/1e3,rt._getUIString("ScaleControl.Kilometers")):Xa(at,es,ss,rt._getUIString("ScaleControl.Meters"))}function Xa(rt,at,Tt,$t){const qt=function(rt){const at=Math.pow(10,`${Math.floor(rt)}`.length-1);let Tt=rt/at;return Tt=Tt>=10?10:Tt>=5?5:Tt>=3?3:Tt>=2?2:Tt>=1?1:function(rt){const at=Math.pow(10,Math.ceil(-Math.log(rt)/Math.LN10));return Math.round(rt*at)/at}(Tt),at*Tt}(Tt);rt.style.width=at*(qt/Tt)+"px",rt.innerHTML=`${qt}&nbsp;${$t}`}const Au={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px",subpixelPositioning:!1,locationOccludedOpacity:void 0},Eu=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function Ya(rt){if(rt){if("number"==typeof rt){const at=Math.round(Math.abs(rt)/Math.SQRT2);return{center:new Tt.P(0,0),top:new Tt.P(0,rt),"top-left":new Tt.P(at,at),"top-right":new Tt.P(-at,at),bottom:new Tt.P(0,-rt),"bottom-left":new Tt.P(at,-at),"bottom-right":new Tt.P(-at,-at),left:new Tt.P(rt,0),right:new Tt.P(-rt,0)}}if(rt instanceof Tt.P||Array.isArray(rt)){const at=Tt.P.convert(rt);return{center:at,top:at,"top-left":at,"top-right":at,bottom:at,"bottom-left":at,"bottom-right":at,left:at,right:at}}return{center:Tt.P.convert(rt.center||[0,0]),top:Tt.P.convert(rt.top||[0,0]),"top-left":Tt.P.convert(rt["top-left"]||[0,0]),"top-right":Tt.P.convert(rt["top-right"]||[0,0]),bottom:Tt.P.convert(rt.bottom||[0,0]),"bottom-left":Tt.P.convert(rt["bottom-left"]||[0,0]),"bottom-right":Tt.P.convert(rt["bottom-right"]||[0,0]),left:Tt.P.convert(rt.left||[0,0]),right:Tt.P.convert(rt.right||[0,0])}}return Ya(new Tt.P(0,0))}const Du=$t;at.AJAXError=Tt.co,at.Event=Tt.l,at.Evented=Tt.E,at.LngLat=Tt.Q,at.MercatorCoordinate=Tt.$,at.Point=Tt.P,at.addProtocol=Tt.cp,at.config=Tt.a,at.removeProtocol=Tt.cq,at.AttributionControl=Ca,at.BoxZoomHandler=No,at.CanvasSource=Y,at.CooperativeGesturesHandler=va,at.DoubleClickZoomHandler=da,at.DragPanHandler=ma,at.DragRotateHandler=fa,at.EdgeInsets=It,at.FullscreenControl=class extends Tt.E{constructor(rt={}){super(),this._onFullscreenChange=()=>{var rt;let at=window.document.fullscreenElement||window.document.mozFullScreenElement||window.document.webkitFullscreenElement||window.document.msFullscreenElement;for(;null===(rt=null==at?void 0:at.shadowRoot)||void 0===rt?void 0:rt.fullscreenElement;)at=at.shadowRoot.fullscreenElement;at===this._container!==this._fullscreen&&this._handleFullscreenChange()},this._onClickFullscreen=()=>{this._isFullscreen()?this._exitFullscreen():this._requestFullscreen()},this._fullscreen=!1,rt&&rt.container&&(rt.container instanceof HTMLElement?this._container=rt.container:Tt.w("Full screen control 'container' must be a DOM element.")),"onfullscreenchange"in document?this._fullscreenchange="fullscreenchange":"onmozfullscreenchange"in document?this._fullscreenchange="mozfullscreenchange":"onwebkitfullscreenchange"in document?this._fullscreenchange="webkitfullscreenchange":"onmsfullscreenchange"in document&&(this._fullscreenchange="MSFullscreenChange")}onAdd(rt){return this._map=rt,this._container||(this._container=this._map.getContainer()),this._controlContainer=n.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._setupUI(),this._controlContainer}onRemove(){n.remove(this._controlContainer),this._map=null,window.document.removeEventListener(this._fullscreenchange,this._onFullscreenChange)}_setupUI(){const rt=this._fullscreenButton=n.create("button","maplibregl-ctrl-fullscreen",this._controlContainer);n.create("span","maplibregl-ctrl-icon",rt).setAttribute("aria-hidden","true"),rt.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),window.document.addEventListener(this._fullscreenchange,this._onFullscreenChange)}_updateTitle(){const rt=this._getTitle();this._fullscreenButton.setAttribute("aria-label",rt),this._fullscreenButton.title=rt}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_handleFullscreenChange(){this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("maplibregl-ctrl-shrink"),this._fullscreenButton.classList.toggle("maplibregl-ctrl-fullscreen"),this._updateTitle(),this._fullscreen?(this.fire(new Tt.l("fullscreenstart")),this._prevCooperativeGesturesEnabled=this._map.cooperativeGestures.isEnabled(),this._map.cooperativeGestures.disable()):(this.fire(new Tt.l("fullscreenend")),this._prevCooperativeGesturesEnabled&&this._map.cooperativeGestures.enable())}_exitFullscreen(){window.document.exitFullscreen?window.document.exitFullscreen():window.document.mozCancelFullScreen?window.document.mozCancelFullScreen():window.document.msExitFullscreen?window.document.msExitFullscreen():window.document.webkitCancelFullScreen?window.document.webkitCancelFullScreen():this._togglePseudoFullScreen()}_requestFullscreen(){this._container.requestFullscreen?this._container.requestFullscreen():this._container.mozRequestFullScreen?this._container.mozRequestFullScreen():this._container.msRequestFullscreen?this._container.msRequestFullscreen():this._container.webkitRequestFullscreen?this._container.webkitRequestFullscreen():this._togglePseudoFullScreen()}_togglePseudoFullScreen(){this._container.classList.toggle("maplibregl-pseudo-fullscreen"),this._handleFullscreenChange(),this._map.resize()}},at.GeoJSONSource=X,at.GeolocateControl=class extends Tt.E{constructor(rt){super(),this._onSuccess=rt=>{if(this._map){if(this._isOutOfMapMaxBounds(rt))return this._setErrorState(),this.fire(new Tt.l("outofmaxbounds",rt)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=rt,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background");break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}this.options.showUserLocation&&"OFF"!==this._watchState&&this._updateMarker(rt),this.options.trackUserLocation&&"ACTIVE_LOCK"!==this._watchState||this._updateCamera(rt),this.options.showUserLocation&&this._dotElement.classList.remove("maplibregl-user-location-dot-stale"),this.fire(new Tt.l("geolocate",rt)),this._finish()}},this._updateCamera=rt=>{const at=new Tt.Q(rt.coords.longitude,rt.coords.latitude),$t=rt.coords.accuracy,qt=this._map.getBearing(),Kt=Tt.e({bearing:qt},this.options.fitBoundsOptions),ge=V.fromLngLat(at,$t);this._map.fitBounds(ge,Kt,{geolocateSource:!0})},this._updateMarker=rt=>{if(rt){const at=new Tt.Q(rt.coords.longitude,rt.coords.latitude);this._accuracyCircleMarker.setLngLat(at).addTo(this._map),this._userLocationDotMarker.setLngLat(at).addTo(this._map),this._accuracy=rt.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()},this._onZoom=()=>{this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()},this._onError=rt=>{if(this._map){if(this.options.trackUserLocation)if(1===rt.code){this._watchState="OFF",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const rt=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.title=rt,this._geolocateButton.setAttribute("aria-label",rt),void 0!==this._geolocationWatchID&&this._clearWatch()}else{if(3===rt.code&&Su)return;this._setErrorState()}"OFF"!==this._watchState&&this.options.showUserLocation&&this._dotElement.classList.add("maplibregl-user-location-dot-stale"),this.fire(new Tt.l("error",rt)),this._finish()}},this._finish=()=>{this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0},this._setupUI=()=>{this._map&&(this._container.addEventListener("contextmenu",(rt=>rt.preventDefault())),this._geolocateButton=n.create("button","maplibregl-ctrl-geolocate",this._container),n.create("span","maplibregl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",this._geolocateButton.disabled=!0)},this._finishSetupUI=rt=>{if(this._map){if(!1===rt){Tt.w("Geolocation support is not available so the GeolocateControl will be disabled.");const rt=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.title=rt,this._geolocateButton.setAttribute("aria-label",rt)}else{const rt=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.disabled=!1,this._geolocateButton.title=rt,this._geolocateButton.setAttribute("aria-label",rt)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=n.create("div","maplibregl-user-location-dot"),this._userLocationDotMarker=new Ga({element:this._dotElement}),this._circleElement=n.create("div","maplibregl-user-location-accuracy-circle"),this._accuracyCircleMarker=new Ga({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",(()=>this.trigger())),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",(rt=>{rt.geolocateSource||"ACTIVE_LOCK"!==this._watchState||rt.originalEvent&&"resize"===rt.originalEvent.type||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this.fire(new Tt.l("trackuserlocationend")),this.fire(new Tt.l("userlocationlostfocus")))}))}},this.options=Tt.e({},Pu,rt)}onAdd(rt){return this._map=rt,this._container=n.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._setupUI(),function(){return Tt._(this,arguments,void 0,(function*(rt=!1){if(void 0!==vu&&!rt)return vu;if(void 0===window.navigator.permissions)return vu=!!window.navigator.geolocation,vu;try{const rt=yield window.navigator.permissions.query({name:"geolocation"});vu="denied"!==rt.state}catch(rt){vu=!!window.navigator.geolocation}return vu}))}().then((rt=>this._finishSetupUI(rt))),this._container}onRemove(){void 0!==this._geolocationWatchID&&(window.navigator.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),n.remove(this._container),this._map.off("zoom",this._onZoom),this._map=void 0,Mu=0,Su=!1}_isOutOfMapMaxBounds(rt){const at=this._map.getMaxBounds(),Tt=rt.coords;return at&&(Tt.longitude<at.getWest()||Tt.longitude>at.getEast()||Tt.latitude<at.getSouth()||Tt.latitude>at.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting");break;case"ACTIVE_ERROR":break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}}_updateCircleRadius(){const rt=this._map.getBounds(),at=rt.getSouthEast(),Tt=rt.getNorthEast(),$t=at.distanceTo(Tt),qt=Math.ceil(this._accuracy/($t/this._map._container.clientHeight)*2);this._circleElement.style.width=`${qt}px`,this._circleElement.style.height=`${qt}px`}trigger(){if(!this._setup)return Tt.w("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new Tt.l("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":Mu--,Su=!1,this._watchState="OFF",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background-error"),this.fire(new Tt.l("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new Tt.l("trackuserlocationstart")),this.fire(new Tt.l("userlocationfocus"));break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-active");break;case"OFF":break;default:throw new Error(`Unexpected watchState ${this._watchState}`)}if("OFF"===this._watchState&&void 0!==this._geolocationWatchID)this._clearWatch();else if(void 0===this._geolocationWatchID){let rt;this._geolocateButton.classList.add("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),Mu++,Mu>1?(rt={maximumAge:6e5,timeout:0},Su=!0):(rt=this.options.positionOptions,Su=!1),this._geolocationWatchID=window.navigator.geolocation.watchPosition(this._onSuccess,this._onError,rt)}}else window.navigator.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=setTimeout(this._finish,1e4);return!0}_clearWatch(){window.navigator.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("maplibregl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},at.GlobeControl=class{constructor(){this._toggleProjection=()=>{var rt;const at=null===(rt=this._map.getProjection())||void 0===rt?void 0:rt.type;this._map.setProjection("mercator"!==at&&at?{type:"mercator"}:{type:"globe"}),this._updateGlobeIcon()},this._updateGlobeIcon=()=>{var rt;this._globeButton.classList.remove("maplibregl-ctrl-globe"),this._globeButton.classList.remove("maplibregl-ctrl-globe-enabled"),"globe"===(null===(rt=this._map.getProjection())||void 0===rt?void 0:rt.type)?(this._globeButton.classList.add("maplibregl-ctrl-globe-enabled"),this._globeButton.title=this._map._getUIString("GlobeControl.Disable")):(this._globeButton.classList.add("maplibregl-ctrl-globe"),this._globeButton.title=this._map._getUIString("GlobeControl.Enable"))}}onAdd(rt){return this._map=rt,this._container=n.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._globeButton=n.create("button","maplibregl-ctrl-globe",this._container),n.create("span","maplibregl-ctrl-icon",this._globeButton).setAttribute("aria-hidden","true"),this._globeButton.type="button",this._globeButton.addEventListener("click",this._toggleProjection),this._updateGlobeIcon(),this._map.on("styledata",this._updateGlobeIcon),this._container}onRemove(){n.remove(this._container),this._map.off("styledata",this._updateGlobeIcon),this._globeButton.removeEventListener("click",this._toggleProjection),this._map=void 0}},at.Hash=Co,at.ImageSource=K,at.KeyboardHandler=la,at.LngLatBounds=V,at.LogoControl=Ma,at.Map=class extends Ta{constructor(rt){var at,$t;Tt.cl.mark(Tt.cm.create);const qt=Object.assign(Object.assign(Object.assign({},yu),rt),{canvasContextAttributes:Object.assign(Object.assign({},yu.canvasContextAttributes),rt.canvasContextAttributes)});if(null!=qt.minZoom&&null!=qt.maxZoom&&qt.minZoom>qt.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(null!=qt.minPitch&&null!=qt.maxPitch&&qt.minPitch>qt.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(null!=qt.minPitch&&qt.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(null!=qt.maxPitch&&qt.maxPitch>180)throw new Error("maxPitch must be less than or equal to 180");const Kt=new Lt,ge=new Ot;if(void 0!==qt.minZoom&&Kt.setMinZoom(qt.minZoom),void 0!==qt.maxZoom&&Kt.setMaxZoom(qt.maxZoom),void 0!==qt.minPitch&&Kt.setMinPitch(qt.minPitch),void 0!==qt.maxPitch&&Kt.setMaxPitch(qt.maxPitch),void 0!==qt.renderWorldCopies&&Kt.setRenderWorldCopies(qt.renderWorldCopies),super(Kt,ge,{bearingSnap:qt.bearingSnap}),this._idleTriggered=!1,this._crossFadingFactor=1,this._renderTaskQueue=new Ia,this._controls=[],this._mapId=Tt.a4(),this._contextLost=rt=>{rt.preventDefault(),this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this.fire(new Tt.l("webglcontextlost",{originalEvent:rt}))},this._contextRestored=rt=>{this._setupPainter(),this.resize(),this._update(),this.fire(new Tt.l("webglcontextrestored",{originalEvent:rt}))},this._onMapScroll=rt=>{if(rt.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1},this._onWindowOnline=()=>{this._update()},this._interactive=qt.interactive,this._maxTileCacheSize=qt.maxTileCacheSize,this._maxTileCacheZoomLevels=qt.maxTileCacheZoomLevels,this._canvasContextAttributes=Object.assign({},qt.canvasContextAttributes),this._trackResize=!0===qt.trackResize,this._bearingSnap=qt.bearingSnap,this._centerClampedToGround=qt.centerClampedToGround,this._refreshExpiredTiles=!0===qt.refreshExpiredTiles,this._fadeDuration=qt.fadeDuration,this._crossSourceCollisions=!0===qt.crossSourceCollisions,this._collectResourceTiming=!0===qt.collectResourceTiming,this._locale=Object.assign(Object.assign({},_u),qt.locale),this._clickTolerance=qt.clickTolerance,this._overridePixelRatio=qt.pixelRatio,this._maxCanvasSize=qt.maxCanvasSize,this.transformCameraUpdate=qt.transformCameraUpdate,this.cancelPendingTileRequestsWhileZooming=!0===qt.cancelPendingTileRequestsWhileZooming,this._imageQueueHandle=cs.addThrottleControl((()=>this.isMoving())),this._requestManager=new m(qt.transformRequest),"string"==typeof qt.container){if(this._container=document.getElementById(qt.container),!this._container)throw new Error(`Container '${qt.container}' not found.`)}else{if(!(qt.container instanceof HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=qt.container}if(qt.maxBounds&&this.setMaxBounds(qt.maxBounds),this._setupContainer(),this._setupPainter(),this.on("move",(()=>this._update(!1))),this.on("moveend",(()=>this._update(!1))),this.on("zoom",(()=>this._update(!0))),this.on("terrain",(()=>{this.painter.terrainFacilitator.dirty=!0,this._update(!0)})),this.once("idle",(()=>{this._idleTriggered=!0})),"undefined"!=typeof window){addEventListener("online",this._onWindowOnline,!1);let rt=!1;const at=Po((rt=>{this._trackResize&&!this._removed&&(this.resize(rt),this.redraw())}),50);this._resizeObserver=new ResizeObserver((Tt=>{rt?at(Tt):rt=!0})),this._resizeObserver.observe(this._container)}this.handlers=new wa(this,qt),this._hash=qt.hash&&new Co("string"==typeof qt.hash&&qt.hash||void 0).addTo(this),this._hash&&this._hash._onHashChange()||(this.jumpTo({center:qt.center,elevation:qt.elevation,zoom:qt.zoom,bearing:qt.bearing,pitch:qt.pitch,roll:qt.roll}),qt.bounds&&(this.resize(),this.fitBounds(qt.bounds,Tt.e({},qt.fitBoundsOptions,{duration:0}))));const Hr="string"==typeof qt.style||!("globe"===(null===($t=null===(at=qt.style)||void 0===at?void 0:at.projection)||void 0===$t?void 0:$t.type));this.resize(null,Hr),this._localIdeographFontFamily=qt.localIdeographFontFamily,this._validateStyle=qt.validateStyle,qt.style&&this.setStyle(qt.style,{localIdeographFontFamily:qt.localIdeographFontFamily}),qt.attributionControl&&this.addControl(new Ca("boolean"==typeof qt.attributionControl?void 0:qt.attributionControl)),qt.maplibreLogo&&this.addControl(new Ma,qt.logoPosition),this.on("style.load",(()=>{if(Hr||this._resizeTransform(),this.transform.unmodified){const rt=Tt.O(this.style.stylesheet,["center","zoom","bearing","pitch","roll"]);this.jumpTo(rt)}})),this.on("data",(rt=>{this._update("style"===rt.dataType),this.fire(new Tt.l(`${rt.dataType}data`,rt))})),this.on("dataloading",(rt=>{this.fire(new Tt.l(`${rt.dataType}dataloading`,rt))})),this.on("dataabort",(rt=>{this.fire(new Tt.l("sourcedataabort",rt))}))}_getMapId(){return this._mapId}addControl(rt,at){if(void 0===at&&(at=rt.getDefaultPosition?rt.getDefaultPosition():"top-right"),!rt||!rt.onAdd)return this.fire(new Tt.k(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const $t=rt.onAdd(this);this._controls.push(rt);const qt=this._controlPositions[at];return-1!==at.indexOf("bottom")?qt.insertBefore($t,qt.firstChild):qt.appendChild($t),this}removeControl(rt){if(!rt||!rt.onRemove)return this.fire(new Tt.k(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const at=this._controls.indexOf(rt);return at>-1&&this._controls.splice(at,1),rt.onRemove(this),this}hasControl(rt){return this._controls.indexOf(rt)>-1}calculateCameraOptionsFromTo(rt,at,Tt,$t){return null==$t&&this.terrain&&($t=this.terrain.getElevationForLngLatZoom(Tt,this.transform.tileZoom)),super.calculateCameraOptionsFromTo(rt,at,Tt,$t)}resize(rt,at=!0){const[$t,qt]=this._containerDimensions(),Kt=this._getClampedPixelRatio($t,qt);if(this._resizeCanvas($t,qt,Kt),this.painter.resize($t,qt,Kt),this.painter.overLimit()){const rt=this.painter.context.gl;this._maxCanvasSize=[rt.drawingBufferWidth,rt.drawingBufferHeight];const at=this._getClampedPixelRatio($t,qt);this._resizeCanvas($t,qt,at),this.painter.resize($t,qt,at)}this._resizeTransform(at);const ge=!this._moving;return ge&&(this.stop(),this.fire(new Tt.l("movestart",rt)).fire(new Tt.l("move",rt))),this.fire(new Tt.l("resize",rt)),ge&&this.fire(new Tt.l("moveend",rt)),this}_resizeTransform(rt=!0){var at;const[Tt,$t]=this._containerDimensions();this.transform.resize(Tt,$t,rt),null===(at=this._requestedCameraState)||void 0===at||at.resize(Tt,$t,rt)}_getClampedPixelRatio(rt,at){const{0:Tt,1:$t}=this._maxCanvasSize,qt=this.getPixelRatio(),Kt=rt*qt,ge=at*qt;return Math.min(Kt>Tt?Tt/Kt:1,ge>$t?$t/ge:1)*qt}getPixelRatio(){var rt;return null!==(rt=this._overridePixelRatio)&&void 0!==rt?rt:devicePixelRatio}setPixelRatio(rt){this._overridePixelRatio=rt,this.resize()}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()}setMaxBounds(rt){return this.transform.setMaxBounds(V.convert(rt)),this._update()}setMinZoom(rt){if((rt=null==rt?-2:rt)>=-2&&rt<=this.transform.maxZoom)return this.transform.setMinZoom(rt),this._update(),this.getZoom()<rt&&this.setZoom(rt),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(rt){if((rt=null==rt?22:rt)>=this.transform.minZoom)return this.transform.setMaxZoom(rt),this._update(),this.getZoom()>rt&&this.setZoom(rt),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(rt){if((rt=null==rt?0:rt)<0)throw new Error("minPitch must be greater than or equal to 0");if(rt>=0&&rt<=this.transform.maxPitch)return this.transform.setMinPitch(rt),this._update(),this.getPitch()<rt&&this.setPitch(rt),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(rt){if((rt=null==rt?60:rt)>180)throw new Error("maxPitch must be less than or equal to 180");if(rt>=this.transform.minPitch)return this.transform.setMaxPitch(rt),this._update(),this.getPitch()>rt&&this.setPitch(rt),this;throw new Error("maxPitch must be greater than the current minPitch")}getMaxPitch(){return this.transform.maxPitch}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(rt){return this.transform.setRenderWorldCopies(rt),this._update()}project(rt){return this.transform.locationToScreenPoint(Tt.Q.convert(rt),this.style&&this.terrain)}unproject(rt){return this.transform.screenPointToLocation(Tt.P.convert(rt),this.terrain)}isMoving(){var rt;return this._moving||(null===(rt=this.handlers)||void 0===rt?void 0:rt.isMoving())}isZooming(){var rt;return this._zooming||(null===(rt=this.handlers)||void 0===rt?void 0:rt.isZooming())}isRotating(){var rt;return this._rotating||(null===(rt=this.handlers)||void 0===rt?void 0:rt.isRotating())}_createDelegatedListener(rt,at,Tt){if("mouseenter"===rt||"mouseover"===rt){let $t=!1;const o=qt=>{const Kt=at.filter((rt=>this.getLayer(rt))),ge=0!==Kt.length?this.queryRenderedFeatures(qt.point,{layers:Kt}):[];ge.length?$t||($t=!0,Tt.call(this,new ko(rt,this,qt.originalEvent,{features:ge}))):$t=!1};return{layers:at,listener:Tt,delegates:{mousemove:o,mouseout:()=>{$t=!1}}}}if("mouseleave"===rt||"mouseout"===rt){let $t=!1;const o=qt=>{const Kt=at.filter((rt=>this.getLayer(rt)));(0!==Kt.length?this.queryRenderedFeatures(qt.point,{layers:Kt}):[]).length?$t=!0:$t&&($t=!1,Tt.call(this,new ko(rt,this,qt.originalEvent)))},a=at=>{$t&&($t=!1,Tt.call(this,new ko(rt,this,at.originalEvent)))};return{layers:at,listener:Tt,delegates:{mousemove:o,mouseout:a}}}{const r=rt=>{const $t=at.filter((rt=>this.getLayer(rt))),qt=0!==$t.length?this.queryRenderedFeatures(rt.point,{layers:$t}):[];qt.length&&(rt.features=qt,Tt.call(this,rt),delete rt.features)};return{layers:at,listener:Tt,delegates:{[rt]:r}}}}_saveDelegatedListener(rt,at){this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[rt]=this._delegatedListeners[rt]||[],this._delegatedListeners[rt].push(at)}_removeDelegatedListener(rt,at,Tt){if(!this._delegatedListeners||!this._delegatedListeners[rt])return;const $t=this._delegatedListeners[rt];for(let rt=0;rt<$t.length;rt++){const qt=$t[rt];if(qt.listener===Tt&&qt.layers.length===at.length&&qt.layers.every((rt=>at.includes(rt)))){for(const rt in qt.delegates)this.off(rt,qt.delegates[rt]);return void $t.splice(rt,1)}}}on(rt,at,Tt){if(void 0===Tt)return super.on(rt,at);const $t="string"==typeof at?[at]:at,qt=this._createDelegatedListener(rt,$t,Tt);this._saveDelegatedListener(rt,qt);for(const rt in qt.delegates)this.on(rt,qt.delegates[rt]);return{unsubscribe:()=>{this._removeDelegatedListener(rt,$t,Tt)}}}once(rt,at,Tt){if(void 0===Tt)return super.once(rt,at);const $t="string"==typeof at?[at]:at,qt=this._createDelegatedListener(rt,$t,Tt);for(const at in qt.delegates){const Kt=qt.delegates[at];qt.delegates[at]=(...at)=>{this._removeDelegatedListener(rt,$t,Tt),Kt(...at)}}this._saveDelegatedListener(rt,qt);for(const rt in qt.delegates)this.once(rt,qt.delegates[rt]);return this}off(rt,at,Tt){return void 0===Tt?super.off(rt,at):(this._removeDelegatedListener(rt,"string"==typeof at?[at]:at,Tt),this)}queryRenderedFeatures(rt,at){if(!this.style)return[];let $t;const qt=rt instanceof Tt.P||Array.isArray(rt),Kt=qt?rt:[[0,0],[this.transform.width,this.transform.height]];if(at=at||(qt?{}:rt)||{},Kt instanceof Tt.P||"number"==typeof Kt[0])$t=[Tt.P.convert(Kt)];else{const rt=Tt.P.convert(Kt[0]),at=Tt.P.convert(Kt[1]);$t=[rt,new Tt.P(at.x,rt.y),at,new Tt.P(rt.x,at.y),rt]}return this.style.queryRenderedFeatures($t,at,this.transform)}querySourceFeatures(rt,at){return this.style.querySourceFeatures(rt,at)}setStyle(rt,at){return!1!==(at=Tt.e({},{localIdeographFontFamily:this._localIdeographFontFamily,validate:this._validateStyle},at)).diff&&at.localIdeographFontFamily===this._localIdeographFontFamily&&this.style&&rt?(this._diffStyle(rt,at),this):(this._localIdeographFontFamily=at.localIdeographFontFamily,this._updateStyle(rt,at))}setTransformRequest(rt){return this._requestManager.setTransformRequest(rt),this}_getUIString(rt){const at=this._locale[rt];if(null==at)throw new Error(`Missing UI string '${rt}'`);return at}_updateStyle(rt,at){var Tt,$t;if(at.transformStyle&&this.style&&!this.style._loaded)return void this.style.once("style.load",(()=>this._updateStyle(rt,at)));const qt=this.style&&at.transformStyle?this.style.serialize():void 0;return this.style&&(this.style.setEventedParent(null),this.style._remove(!rt)),rt?(this.style=new bi(this,at||{}),this.style.setEventedParent(this,{style:this.style}),"string"==typeof rt?this.style.loadURL(rt,at,qt):this.style.loadJSON(rt,at,qt),this):(null===($t=null===(Tt=this.style)||void 0===Tt?void 0:Tt.projection)||void 0===$t||$t.destroy(),delete this.style,this)}_lazyInitEmptyStyle(){this.style||(this.style=new bi(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}_diffStyle(rt,at){if("string"==typeof rt){const $t=this._requestManager.transformRequest(rt,"Style");Tt.j($t,new AbortController).then((rt=>{this._updateDiff(rt.data,at)})).catch((rt=>{rt&&this.fire(new Tt.k(rt))}))}else"object"==typeof rt&&this._updateDiff(rt,at)}_updateDiff(rt,at){try{this.style.setState(rt,at)&&this._update(!0)}catch($t){Tt.w(`Unable to perform style diff: ${$t.message||$t.error||$t}.  Rebuilding the style from scratch.`),this._updateStyle(rt,at)}}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():Tt.w("There is no style added to the map.")}addSource(rt,at){return this._lazyInitEmptyStyle(),this.style.addSource(rt,at),this._update(!0)}isSourceLoaded(rt){const at=this.style&&this.style.sourceCaches[rt];if(void 0!==at)return at.loaded();this.fire(new Tt.k(new Error(`There is no source with ID '${rt}'`)))}setTerrain(rt){if(this.style._checkLoaded(),this._terrainDataCallback&&this.style.off("data",this._terrainDataCallback),rt){const at=this.style.sourceCaches[rt.source];if(!at)throw new Error(`cannot load terrain, because there exists no source with ID: ${rt.source}`);null===this.terrain&&at.reload();for(const at in this.style._layers){const $t=this.style._layers[at];"hillshade"===$t.type&&$t.source===rt.source&&Tt.w("You are using the same source for a hillshade layer and for 3D terrain. Please consider using two separate sources to improve rendering quality.")}this.terrain=new Ra(this.painter,at,rt),this.painter.renderToTexture=new Aa(this.painter,this.terrain),this.transform.setMinElevationForCurrentTile(this.terrain.getMinTileElevationForLngLatZoom(this.transform.center,this.transform.tileZoom)),this.transform.setElevation(this.terrain.getElevationForLngLatZoom(this.transform.center,this.transform.tileZoom)),this._terrainDataCallback=at=>{var Tt;"style"===at.dataType?this.terrain.sourceCache.freeRtt():"source"===at.dataType&&at.tile&&(at.sourceId!==rt.source||this._elevationFreeze||(this.transform.setMinElevationForCurrentTile(this.terrain.getMinTileElevationForLngLatZoom(this.transform.center,this.transform.tileZoom)),this._centerClampedToGround&&this.transform.setElevation(this.terrain.getElevationForLngLatZoom(this.transform.center,this.transform.tileZoom))),"image"===(null===(Tt=at.source)||void 0===Tt?void 0:Tt.type)?this.terrain.sourceCache.freeRtt():this.terrain.sourceCache.freeRtt(at.tile.tileID))},this.style.on("data",this._terrainDataCallback)}else this.terrain&&this.terrain.sourceCache.destruct(),this.terrain=null,this.painter.renderToTexture&&this.painter.renderToTexture.destruct(),this.painter.renderToTexture=null,this.transform.setMinElevationForCurrentTile(0),this._centerClampedToGround&&this.transform.setElevation(0);return this.fire(new Tt.l("terrain",{terrain:rt})),this}getTerrain(){var rt,at;return null!==(at=null===(rt=this.terrain)||void 0===rt?void 0:rt.options)&&void 0!==at?at:null}areTilesLoaded(){const rt=this.style&&this.style.sourceCaches;for(const at in rt){const Tt=rt[at]._tiles;for(const rt in Tt){const at=Tt[rt];if("loaded"!==at.state&&"errored"!==at.state)return!1}}return!0}removeSource(rt){return this.style.removeSource(rt),this._update(!0)}getSource(rt){return this.style.getSource(rt)}setSourceTileLodParams(rt,at,Tt){if(Tt){const $t=this.getSource(Tt);if(!$t)throw new Error(`There is no source with ID "${Tt}", cannot set LOD parameters`);$t.calculateTileZoom=fe(Math.max(1,rt),Math.max(1,at))}else for(const Tt in this.style.sourceCaches)this.style.sourceCaches[Tt].getSource().calculateTileZoom=fe(Math.max(1,rt),Math.max(1,at));return this._update(!0),this}addImage(rt,at,$t={}){const{pixelRatio:qt=1,sdf:Kt=!1,stretchX:Hr,stretchY:wn,content:es,textFitWidth:ss,textFitHeight:os}=$t;if(this._lazyInitEmptyStyle(),!(at instanceof HTMLImageElement||Tt.b(at))){if(void 0===at.width||void 0===at.height)return this.fire(new Tt.k(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));{const{width:$t,height:ge,data:cs}=at,ds=at;return this.style.addImage(rt,{data:new Tt.R({width:$t,height:ge},new Uint8Array(cs)),pixelRatio:qt,stretchX:Hr,stretchY:wn,content:es,textFitWidth:ss,textFitHeight:os,sdf:Kt,version:0,userImage:ds}),ds.onAdd&&ds.onAdd(this,rt),this}}{const{width:$t,height:cs,data:ds}=ge.getImageData(at);this.style.addImage(rt,{data:new Tt.R({width:$t,height:cs},ds),pixelRatio:qt,stretchX:Hr,stretchY:wn,content:es,textFitWidth:ss,textFitHeight:os,sdf:Kt,version:0})}}updateImage(rt,at){const $t=this.style.getImage(rt);if(!$t)return this.fire(new Tt.k(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const qt=at instanceof HTMLImageElement||Tt.b(at)?ge.getImageData(at):at,{width:Kt,height:Hr,data:wn}=qt;if(void 0===Kt||void 0===Hr)return this.fire(new Tt.k(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));if(Kt!==$t.data.width||Hr!==$t.data.height)return this.fire(new Tt.k(new Error("The width and height of the updated image must be that same as the previous version of the image")));const es=!(at instanceof HTMLImageElement||Tt.b(at));return $t.data.replace(wn,es),this.style.updateImage(rt,$t),this}getImage(rt){return this.style.getImage(rt)}hasImage(rt){return rt?!!this.style.getImage(rt):(this.fire(new Tt.k(new Error("Missing required image id"))),!1)}removeImage(rt){this.style.removeImage(rt)}loadImage(rt){return cs.getImage(this._requestManager.transformRequest(rt,"Image"),new AbortController)}listImages(){return this.style.listImages()}addLayer(rt,at){return this._lazyInitEmptyStyle(),this.style.addLayer(rt,at),this._update(!0)}moveLayer(rt,at){return this.style.moveLayer(rt,at),this._update(!0)}removeLayer(rt){return this.style.removeLayer(rt),this._update(!0)}getLayer(rt){return this.style.getLayer(rt)}getLayersOrder(){return this.style.getLayersOrder()}setLayerZoomRange(rt,at,Tt){return this.style.setLayerZoomRange(rt,at,Tt),this._update(!0)}setFilter(rt,at,Tt={}){return this.style.setFilter(rt,at,Tt),this._update(!0)}getFilter(rt){return this.style.getFilter(rt)}setPaintProperty(rt,at,Tt,$t={}){return this.style.setPaintProperty(rt,at,Tt,$t),this._update(!0)}getPaintProperty(rt,at){return this.style.getPaintProperty(rt,at)}setLayoutProperty(rt,at,Tt,$t={}){return this.style.setLayoutProperty(rt,at,Tt,$t),this._update(!0)}getLayoutProperty(rt,at){return this.style.getLayoutProperty(rt,at)}setGlyphs(rt,at={}){return this._lazyInitEmptyStyle(),this.style.setGlyphs(rt,at),this._update(!0)}getGlyphs(){return this.style.getGlyphsUrl()}addSprite(rt,at,Tt={}){return this._lazyInitEmptyStyle(),this.style.addSprite(rt,at,Tt,(rt=>{rt||this._update(!0)})),this}removeSprite(rt){return this._lazyInitEmptyStyle(),this.style.removeSprite(rt),this._update(!0)}getSprite(){return this.style.getSprite()}setSprite(rt,at={}){return this._lazyInitEmptyStyle(),this.style.setSprite(rt,at,(rt=>{rt||this._update(!0)})),this}setLight(rt,at={}){return this._lazyInitEmptyStyle(),this.style.setLight(rt,at),this._update(!0)}getLight(){return this.style.getLight()}setSky(rt,at={}){return this._lazyInitEmptyStyle(),this.style.setSky(rt,at),this._update(!0)}getSky(){return this.style.getSky()}setFeatureState(rt,at){return this.style.setFeatureState(rt,at),this._update()}removeFeatureState(rt,at){return this.style.removeFeatureState(rt,at),this._update()}getFeatureState(rt){return this.style.getFeatureState(rt)}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}_containerDimensions(){let rt=0,at=0;return this._container&&(rt=this._container.clientWidth||400,at=this._container.clientHeight||300),[rt,at]}_setupContainer(){const rt=this._container;rt.classList.add("maplibregl-map");const at=this._canvasContainer=n.create("div","maplibregl-canvas-container",rt);this._interactive&&at.classList.add("maplibregl-interactive"),this._canvas=n.create("canvas","maplibregl-canvas",at),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("tabindex",this._interactive?"0":"-1"),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region");const Tt=this._containerDimensions(),$t=this._getClampedPixelRatio(Tt[0],Tt[1]);this._resizeCanvas(Tt[0],Tt[1],$t);const qt=this._controlContainer=n.create("div","maplibregl-control-container",rt),Kt=this._controlPositions={};["top-left","top-right","bottom-left","bottom-right"].forEach((rt=>{Kt[rt]=n.create("div",`maplibregl-ctrl-${rt} `,qt)})),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(rt,at,Tt){this._canvas.width=Math.floor(Tt*rt),this._canvas.height=Math.floor(Tt*at),this._canvas.style.width=`${rt}px`,this._canvas.style.height=`${at}px`}_setupPainter(){const rt=Object.assign(Object.assign({},this._canvasContextAttributes),{alpha:!0,depth:!0,stencil:!0,premultipliedAlpha:!0});let at=null;this._canvas.addEventListener("webglcontextcreationerror",(Tt=>{at={requestedAttributes:rt},Tt&&(at.statusMessage=Tt.statusMessage,at.type=Tt.type)}),{once:!0});let Tt=null;if(Tt=this._canvasContextAttributes.contextType?this._canvas.getContext(this._canvasContextAttributes.contextType,rt):this._canvas.getContext("webgl2",rt)||this._canvas.getContext("webgl",rt),!Tt){const rt="Failed to initialize WebGL";throw at?(at.message=rt,new Error(JSON.stringify(at))):new Error(rt)}this.painter=new To(Tt,this.transform),Hr.testSupport(Tt)}migrateProjection(rt,at){super.migrateProjection(rt,at),this.painter.transform=rt,this.fire(new Tt.l("projectiontransition",{newProjection:this.style.projection.name}))}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}_update(rt){return this.style&&this.style._loaded?(this._styleDirty=this._styleDirty||rt,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(rt){return this._update(),this._renderTaskQueue.add(rt)}_cancelRenderFrame(rt){this._renderTaskQueue.remove(rt)}_render(rt){var at,$t,qt,Kt,Hr;const wn=this._idleTriggered?this._fadeDuration:0,es=(null===(at=this.style.projection)||void 0===at?void 0:at.transitionState)>0;if(this.painter.context.setDirty(),this.painter.setBaseState(),this._renderTaskQueue.run(rt),this._removed)return;let ss=!1;if(this.style&&this._styleDirty){this._styleDirty=!1;const rt=this.transform.zoom,at=ge.now();this.style.zoomHistory.update(rt,at);const $t=new Tt.C(rt,{now:at,fadeDuration:wn,zoomHistory:this.style.zoomHistory,transition:this.style.getTransition()}),qt=$t.crossFadingFactor();1===qt&&qt===this._crossFadingFactor||(ss=!0,this._crossFadingFactor=qt),this.style.update($t)}const os=(null===($t=this.style.projection)||void 0===$t?void 0:$t.transitionState)>0!==es;null===(qt=this.style.projection)||void 0===qt||qt.setErrorQueryLatitudeDegrees(this.transform.center.lat),this.transform.setTransitionState(null===(Kt=this.style.projection)||void 0===Kt?void 0:Kt.transitionState,null===(Hr=this.style.projection)||void 0===Hr?void 0:Hr.latitudeErrorCorrectionRadians),this.style&&(this._sourcesDirty||os)&&(this._sourcesDirty=!1,this.style._updateSources(this.transform)),this.terrain?(this.terrain.sourceCache.update(this.transform,this.terrain),this.transform.setMinElevationForCurrentTile(this.terrain.getMinTileElevationForLngLatZoom(this.transform.center,this.transform.tileZoom)),!this._elevationFreeze&&this._centerClampedToGround&&this.transform.setElevation(this.terrain.getElevationForLngLatZoom(this.transform.center,this.transform.tileZoom))):(this.transform.setMinElevationForCurrentTile(0),this._centerClampedToGround&&this.transform.setElevation(0)),this._placementDirty=this.style&&this.style._updatePlacement(this.transform,this.showCollisionBoxes,wn,this._crossSourceCollisions,os),this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showOverdrawInspector:this._showOverdrawInspector,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:wn,showPadding:this.showPadding}),this.fire(new Tt.l("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,Tt.cl.mark(Tt.cm.load),this.fire(new Tt.l("load"))),this.style&&(this.style.hasTransitions()||ss)&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles();const cs=this._sourcesDirty||this._styleDirty||this._placementDirty;return cs||this._repaint?this.triggerRepaint():!this.isMoving()&&this.loaded()&&this.fire(new Tt.l("idle")),!this._loaded||this._fullyLoaded||cs||(this._fullyLoaded=!0,Tt.cl.mark(Tt.cm.fullLoad)),this}redraw(){return this.style&&(this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this._render(0)),this}remove(){var rt;this._hash&&this._hash.remove();for(const rt of this._controls)rt.onRemove(this);this._controls=[],this._frameRequest&&(this._frameRequest.abort(),this._frameRequest=null),this._renderTaskQueue.clear(),this.painter.destroy(),this.handlers.destroy(),delete this.handlers,this.setStyle(null),"undefined"!=typeof window&&removeEventListener("online",this._onWindowOnline,!1),cs.removeThrottleControl(this._imageQueueHandle),null===(rt=this._resizeObserver)||void 0===rt||rt.disconnect();const at=this.painter.context.gl.getExtension("WEBGL_lose_context");(null==at?void 0:at.loseContext)&&at.loseContext(),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),n.remove(this._canvasContainer),n.remove(this._controlContainer),this._container.removeEventListener("scroll",this._onMapScroll,!1),this._container.classList.remove("maplibregl-map"),Tt.cl.clearMetrics(),this._removed=!0,this.fire(new Tt.l("remove"))}triggerRepaint(){this.style&&!this._frameRequest&&(this._frameRequest=new AbortController,ge.frame(this._frameRequest,(rt=>{Tt.cl.frame(rt),this._frameRequest=null;try{this._render(rt)}catch(rt){if(!Tt.cn(rt)&&!function(rt){return rt.message===Oc}(rt))throw rt}}),(()=>{})))}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(rt){this._showTileBoundaries!==rt&&(this._showTileBoundaries=rt,this._update())}get showPadding(){return!!this._showPadding}set showPadding(rt){this._showPadding!==rt&&(this._showPadding=rt,this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(rt){this._showCollisionBoxes!==rt&&(this._showCollisionBoxes=rt,rt?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(rt){this._showOverdrawInspector!==rt&&(this._showOverdrawInspector=rt,this._update())}get repaint(){return!!this._repaint}set repaint(rt){this._repaint!==rt&&(this._repaint=rt,this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(rt){this._vertices=rt,this._update()}get version(){return gu}getCameraTargetElevation(){return this.transform.elevation}getProjection(){return this.style.getProjection()}setProjection(rt){return this._lazyInitEmptyStyle(),this.style.setProjection(rt),this._update(!0)}},at.MapMouseEvent=ko,at.MapTouchEvent=Fo,at.MapWheelEvent=Bo,at.Marker=Ga,at.NavigationControl=class{constructor(rt){this._updateZoomButtons=()=>{const rt=this._map.getZoom(),at=rt===this._map.getMaxZoom(),Tt=rt===this._map.getMinZoom();this._zoomInButton.disabled=at,this._zoomOutButton.disabled=Tt,this._zoomInButton.setAttribute("aria-disabled",at.toString()),this._zoomOutButton.setAttribute("aria-disabled",Tt.toString())},this._rotateCompassArrow=()=>{this._compassIcon.style.transform=this.options.visualizePitch&&this.options.visualizeRoll?`scale(${1/Math.pow(Math.cos(this._map.transform.pitchInRadians),.5)}) rotateZ(${-this._map.transform.roll}deg) rotateX(${this._map.transform.pitch}deg) rotateZ(${-this._map.transform.bearing}deg)`:this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(this._map.transform.pitchInRadians),.5)}) rotateX(${this._map.transform.pitch}deg) rotateZ(${-this._map.transform.bearing}deg)`:this.options.visualizeRoll?`rotate(${-this._map.transform.bearing-this._map.transform.roll}deg)`:`rotate(${-this._map.transform.bearing}deg)`},this._setButtonTitle=(rt,at)=>{const Tt=this._map._getUIString(`NavigationControl.${at}`);rt.title=Tt,rt.setAttribute("aria-label",Tt)},this.options=Tt.e({},xu,rt),this._container=n.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._container.addEventListener("contextmenu",(rt=>rt.preventDefault())),this.options.showZoom&&(this._zoomInButton=this._createButton("maplibregl-ctrl-zoom-in",(rt=>this._map.zoomIn({},{originalEvent:rt}))),n.create("span","maplibregl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("maplibregl-ctrl-zoom-out",(rt=>this._map.zoomOut({},{originalEvent:rt}))),n.create("span","maplibregl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(this._compass=this._createButton("maplibregl-ctrl-compass",(rt=>{this.options.visualizePitch?this._map.resetNorthPitch({},{originalEvent:rt}):this._map.resetNorth({},{originalEvent:rt})})),this._compassIcon=n.create("span","maplibregl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}onAdd(rt){return this._map=rt,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),this._map.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&this._map.on("pitch",this._rotateCompassArrow),this.options.visualizeRoll&&this._map.on("roll",this._rotateCompassArrow),this._map.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new Oa(this._map,this._compass,this.options.visualizePitch)),this._container}onRemove(){n.remove(this._container),this.options.showZoom&&this._map.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&this._map.off("pitch",this._rotateCompassArrow),this.options.visualizeRoll&&this._map.off("roll",this._rotateCompassArrow),this._map.off("rotate",this._rotateCompassArrow),this._handler.off(),delete this._handler),delete this._map}_createButton(rt,at){const Tt=n.create("button",rt,this._container);return Tt.type="button",Tt.addEventListener("click",at),Tt}},at.Popup=class extends Tt.E{constructor(rt){super(),this._updateOpacity=()=>{void 0!==this.options.locationOccludedOpacity&&(this._container.style.opacity=this._map.transform.isLocationOccluded(this.getLngLat())?`${this.options.locationOccludedOpacity}`:void 0)},this.remove=()=>(this._content&&n.remove(this._content),this._container&&(n.remove(this._container),delete this._container),this._map&&(this._map.off("move",this._update),this._map.off("move",this._onClose),this._map.off("click",this._onClose),this._map.off("remove",this.remove),this._map.off("mousemove",this._onMouseMove),this._map.off("mouseup",this._onMouseUp),this._map.off("drag",this._onDrag),this._map._canvasContainer.classList.remove("maplibregl-track-pointer"),delete this._map,this.fire(new Tt.l("close"))),this),this._onMouseUp=rt=>{this._update(rt.point)},this._onMouseMove=rt=>{this._update(rt.point)},this._onDrag=rt=>{this._update(rt.point)},this._update=rt=>{if(!this._map||!this._lngLat&&!this._trackPointer||!this._content)return;if(!this._container){if(this._container=n.create("div","maplibregl-popup",this._map.getContainer()),this._tip=n.create("div","maplibregl-popup-tip",this._container),this._container.appendChild(this._content),this.options.className)for(const rt of this.options.className.split(" "))this._container.classList.add(rt);this._closeButton&&this._closeButton.setAttribute("aria-label",this._map._getUIString("Popup.Close")),this._trackPointer&&this._container.classList.add("maplibregl-popup-track-pointer")}if(this.options.maxWidth&&this._container.style.maxWidth!==this.options.maxWidth&&(this._container.style.maxWidth=this.options.maxWidth),this._lngLat=Za(this._lngLat,this._flatPos,this._map.transform,this._trackPointer),this._trackPointer&&!rt)return;const at=this._flatPos=this._pos=this._trackPointer&&rt?rt:this._map.project(this._lngLat);this._map.terrain&&(this._flatPos=this._trackPointer&&rt?rt:this._map.transform.locationToScreenPoint(this._lngLat));let Tt=this.options.anchor;const $t=Ya(this.options.offset);if(!Tt){const rt=this._container.offsetWidth,qt=this._container.offsetHeight;let Kt;Kt=at.y+$t.bottom.y<qt?["top"]:at.y>this._map.transform.height-qt?["bottom"]:[],at.x<rt/2?Kt.push("left"):at.x>this._map.transform.width-rt/2&&Kt.push("right"),Tt=0===Kt.length?"bottom":Kt.join("-")}let qt=at.add($t[Tt]);this.options.subpixelPositioning||(qt=qt.round()),n.setTransform(this._container,`${bu[Tt]} translate(${qt.x}px,${qt.y}px)`),Ua(this._container,Tt,"popup"),this._updateOpacity()},this._onClose=()=>{this.remove()},this.options=Tt.e(Object.create(Au),rt)}addTo(rt){return this._map&&this.remove(),this._map=rt,this.options.closeOnClick&&this._map.on("click",this._onClose),this.options.closeOnMove&&this._map.on("move",this._onClose),this._map.on("remove",this.remove),this._update(),this._focusFirstElement(),this._trackPointer?(this._map.on("mousemove",this._onMouseMove),this._map.on("mouseup",this._onMouseUp),this._container&&this._container.classList.add("maplibregl-popup-track-pointer"),this._map._canvasContainer.classList.add("maplibregl-track-pointer")):this._map.on("move",this._update),this.fire(new Tt.l("open")),this}isOpen(){return!!this._map}getLngLat(){return this._lngLat}setLngLat(rt){return this._lngLat=Tt.Q.convert(rt),this._pos=null,this._flatPos=null,this._trackPointer=!1,this._update(),this._map&&(this._map.on("move",this._update),this._map.off("mousemove",this._onMouseMove),this._container&&this._container.classList.remove("maplibregl-popup-track-pointer"),this._map._canvasContainer.classList.remove("maplibregl-track-pointer")),this}trackPointer(){return this._trackPointer=!0,this._pos=null,this._flatPos=null,this._update(),this._map&&(this._map.off("move",this._update),this._map.on("mousemove",this._onMouseMove),this._map.on("drag",this._onDrag),this._container&&this._container.classList.add("maplibregl-popup-track-pointer"),this._map._canvasContainer.classList.add("maplibregl-track-pointer")),this}getElement(){return this._container}setText(rt){return this.setDOMContent(document.createTextNode(rt))}setHTML(rt){const at=document.createDocumentFragment(),Tt=document.createElement("body");let $t;for(Tt.innerHTML=rt;$t=Tt.firstChild,$t;)at.appendChild($t);return this.setDOMContent(at)}getMaxWidth(){var rt;return null===(rt=this._container)||void 0===rt?void 0:rt.style.maxWidth}setMaxWidth(rt){return this.options.maxWidth=rt,this._update(),this}setDOMContent(rt){if(this._content)for(;this._content.hasChildNodes();)this._content.firstChild&&this._content.removeChild(this._content.firstChild);else this._content=n.create("div","maplibregl-popup-content",this._container);return this._content.appendChild(rt),this._createCloseButton(),this._update(),this._focusFirstElement(),this}addClassName(rt){return this._container&&this._container.classList.add(rt),this}removeClassName(rt){return this._container&&this._container.classList.remove(rt),this}setOffset(rt){return this.options.offset=rt,this._update(),this}toggleClassName(rt){if(this._container)return this._container.classList.toggle(rt)}setSubpixelPositioning(rt){this.options.subpixelPositioning=rt}_createCloseButton(){this.options.closeButton&&(this._closeButton=n.create("button","maplibregl-popup-close-button",this._content),this._closeButton.type="button",this._closeButton.innerHTML="&#215;",this._closeButton.addEventListener("click",this._onClose))}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const rt=this._container.querySelector(Eu);rt&&rt.focus()}},at.RasterDEMTileSource=$,at.RasterTileSource=H,at.ScaleControl=class{constructor(rt){this._onMove=()=>{$a(this._map,this._container,this.options)},this.setUnit=rt=>{this.options.unit=rt,$a(this._map,this._container,this.options)},this.options=Object.assign(Object.assign({},Cu),rt)}getDefaultPosition(){return"bottom-left"}onAdd(rt){return this._map=rt,this._container=n.create("div","maplibregl-ctrl maplibregl-ctrl-scale",rt.getContainer()),this._map.on("move",this._onMove),this._onMove(),this._container}onRemove(){n.remove(this._container),this._map.off("move",this._onMove),this._map=void 0}},at.ScrollZoomHandler=ua,at.Style=bi,at.TerrainControl=class{constructor(rt){this._toggleTerrain=()=>{this._map.getTerrain()?this._map.setTerrain(null):this._map.setTerrain(this.options),this._updateTerrainIcon()},this._updateTerrainIcon=()=>{this._terrainButton.classList.remove("maplibregl-ctrl-terrain"),this._terrainButton.classList.remove("maplibregl-ctrl-terrain-enabled"),this._map.terrain?(this._terrainButton.classList.add("maplibregl-ctrl-terrain-enabled"),this._terrainButton.title=this._map._getUIString("TerrainControl.Disable")):(this._terrainButton.classList.add("maplibregl-ctrl-terrain"),this._terrainButton.title=this._map._getUIString("TerrainControl.Enable"))},this.options=rt}onAdd(rt){return this._map=rt,this._container=n.create("div","maplibregl-ctrl maplibregl-ctrl-group"),this._terrainButton=n.create("button","maplibregl-ctrl-terrain",this._container),n.create("span","maplibregl-ctrl-icon",this._terrainButton).setAttribute("aria-hidden","true"),this._terrainButton.type="button",this._terrainButton.addEventListener("click",this._toggleTerrain),this._updateTerrainIcon(),this._map.on("terrain",this._updateTerrainIcon),this._container}onRemove(){n.remove(this._container),this._map.off("terrain",this._updateTerrainIcon),this._map=void 0}},at.TwoFingersTouchPitchHandler=sa,at.TwoFingersTouchRotateHandler=oa,at.TwoFingersTouchZoomHandler=ia,at.TwoFingersTouchZoomRotateHandler=ga,at.VectorTileSource=W,at.VideoSource=Q,at.addSourceType=(rt,at)=>Tt._(void 0,void 0,void 0,(function*(){if(ee(rt))throw new Error(`A source type called "${rt}" already exists.`);((rt,at)=>{La[rt]=at})(rt,at)})),at.clearPrewarmedResources=function(){const rt=Ho;rt&&(rt.isPreloaded()&&1===rt.numActive()?(rt.release(Eo),Ho=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},at.createTileMesh=Xt,at.getMaxParallelImageRequests=function(){return Tt.a.MAX_PARALLEL_IMAGE_REQUESTS},at.getRTLTextPluginStatus=function(){return oe().getRTLTextPluginStatus()},at.getVersion=function(){return Du},at.getWorkerCount=function(){return z.workerCount},at.getWorkerUrl=function(){return Tt.a.WORKER_URL},at.importScriptInWorkers=function(rt){return O().broadcast("IS",rt)},at.prewarm=function(){F().acquire(Eo)},at.setMaxParallelImageRequests=function(rt){Tt.a.MAX_PARALLEL_IMAGE_REQUESTS=rt},at.setRTLTextPlugin=function(rt,at){return oe().setRTLTextPlugin(rt,at)},at.setWorkerCount=function(rt){z.workerCount=rt},at.setWorkerUrl=function(rt){Tt.a.WORKER_URL=rt}}));var $t=at;return $t}));var Tt=at;export{Tt as default};

